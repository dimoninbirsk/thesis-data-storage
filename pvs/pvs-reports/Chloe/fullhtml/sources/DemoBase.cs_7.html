<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>DemoBase.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">﻿using Chloe;</a>
<a name="ln2">using System;</a>
<a name="ln3">using System.Collections.Generic;</a>
<a name="ln4">using System.Diagnostics;</a>
<a name="ln5">using System.Linq;</a>
<a name="ln6">using System.Threading.Tasks;</a>
<a name="ln7"> </a>
<a name="ln8">namespace ChloeDemo</a>
<a name="ln9">{</a>
<a name="ln10">    abstract class DemoBase : IDisposable</a>
<a name="ln11">    {</a>
<a name="ln12">        object _result;</a>
<a name="ln13">        public DemoBase()</a>
<a name="ln14">        {</a>
<a name="ln15">            this.DbContext = this.CreateDbContext();</a>
<a name="ln16"> </a>
<a name="ln17">            /* context filter，仅对当前 DbContext 对象有效 */</a>
<a name="ln18">            this.DbContext.HasQueryFilter&lt;Person&gt;(a =&gt; a.Id &gt; -100);</a>
<a name="ln19">        }</a>
<a name="ln20"> </a>
<a name="ln21">        /* WARNING: DbContext 是非线程安全的，不能设置为 static，并且用完务必要调用 Dispose 方法销毁对象 */</a>
<a name="ln22">        public IDbContext DbContext { get; private set; }</a>
<a name="ln23"> </a>
<a name="ln24">        protected abstract IDbContext CreateDbContext();</a>
<a name="ln25"> </a>
<a name="ln26">        public virtual void Dispose()</a>
<a name="ln27">        {</a>
<a name="ln28">            this.DbContext.Dispose();</a>
<a name="ln29">        }</a>
<a name="ln30"> </a>
<a name="ln31">        public virtual void Run()</a>
<a name="ln32">        {</a>
<a name="ln33">            this.InitDatabase();</a>
<a name="ln34">            this.InitData();</a>
<a name="ln35"> </a>
<a name="ln36">            this.Crud();</a>
<a name="ln37">            this.CrudAsync().GetAwaiter().GetResult();</a>
<a name="ln38"> </a>
<a name="ln39">            this.BasicQuery();</a>
<a name="ln40">            this.JoinQuery();</a>
<a name="ln41">            this.ExcludeFieldQuery();</a>
<a name="ln42">            this.AggregateQuery();</a>
<a name="ln43">            this.GroupQuery();</a>
<a name="ln44">            this.ComplexQuery();</a>
<a name="ln45">            this.QueryWithNavigation();</a>
<a name="ln46">            this.SplitQuery();</a>
<a name="ln47">            this.Insert();</a>
<a name="ln48">            this.Update();</a>
<a name="ln49">            this.Delete();</a>
<a name="ln50">            this.Method();</a>
<a name="ln51">            this.ExecuteCommandText();</a>
<a name="ln52">            this.DoWithTransaction();</a>
<a name="ln53">            this.OtherTest();</a>
<a name="ln54"> </a>
<a name="ln55">            ConsoleHelper.WriteLineAndReadKey(&quot;Run over...&quot;);</a>
<a name="ln56">        }</a>
<a name="ln57"> </a>
<a name="ln58">        public virtual void InitDatabase()</a>
<a name="ln59">        {</a>
<a name="ln60"> </a>
<a name="ln61">        }</a>
<a name="ln62"> </a>
<a name="ln63">        public virtual void InitData()</a>
<a name="ln64">        {</a>
<a name="ln65">            this.DbContext.Delete&lt;Province&gt;(a =&gt; true);</a>
<a name="ln66">            this.DbContext.Delete&lt;City&gt;(a =&gt; true);</a>
<a name="ln67">            this.DbContext.Delete&lt;Person&gt;(a =&gt; true);</a>
<a name="ln68">            this.DbContext.Delete&lt;PersonProfile&gt;(a =&gt; true);</a>
<a name="ln69">            this.DbContext.Delete&lt;ProfileAnnex&gt;(a =&gt; true);</a>
<a name="ln70"> </a>
<a name="ln71">            List&lt;Province&gt; provinces = TestData.GetMockProvinces();</a>
<a name="ln72">            foreach (var province in provinces)</a>
<a name="ln73">            {</a>
<a name="ln74">                this.DbContext.Save(province);</a>
<a name="ln75">            }</a>
<a name="ln76"> </a>
<a name="ln77">            provinces = this.DbContext.Query&lt;Province&gt;().IncludeAll().ToList();</a>
<a name="ln78"> </a>
<a name="ln79">            //清空旧数据</a>
<a name="ln80">            this.DbContext.Delete&lt;TestEntity&gt;(a =&gt; true);</a>
<a name="ln81"> </a>
<a name="ln82">            List&lt;TestEntity&gt; testEntities = new List&lt;TestEntity&gt;();</a>
<a name="ln83">            for (int i = 0; i &lt; 1.2 * 10000; i++)</a>
<a name="ln84">            {</a>
<a name="ln85">                TestEntity testEntity = new TestEntity()</a>
<a name="ln86">                {</a>
<a name="ln87">                    F_Byte = (byte)(i % 10),</a>
<a name="ln88">                    F_Int16 = (Int16)(16 + i),</a>
<a name="ln89">                    F_Int32 = 32 + i,</a>
<a name="ln90">                    F_Int64 = 64 + i,</a>
<a name="ln91">                    F_Double = 100.01 + i,</a>
<a name="ln92">                    F_Float = 10.01f + i,</a>
<a name="ln93">                    F_Decimal = 1000.01M + i,</a>
<a name="ln94">                    F_Bool = (i % 2) == 0,</a>
<a name="ln95">                    F_DateTime = DateTime.Now.AddMinutes(i),</a>
<a name="ln96">                    F_Guid = Guid.NewGuid(),</a>
<a name="ln97">                    F_String = &quot;Chloe.ORM-&quot; + i,</a>
<a name="ln98">                    F_Enum = Gender.Male</a>
<a name="ln99">                };</a>
<a name="ln100"> </a>
<a name="ln101">                testEntities.Add(testEntity);</a>
<a name="ln102">            }</a>
<a name="ln103"> </a>
<a name="ln104">            this.DbContext.InsertRange(testEntities);</a>
<a name="ln105"> </a>
<a name="ln106">            testEntities = this.DbContext.Query&lt;TestEntity&gt;().ToList();</a>
<a name="ln107"> </a>
<a name="ln108">            ConsoleHelper.WriteLineAndReadKey(&quot;InitData over...&quot;);</a>
<a name="ln109">        }</a>
<a name="ln110"> </a>
<a name="ln111"> </a>
<a name="ln112">        public virtual void Crud()</a>
<a name="ln113">        {</a>
<a name="ln114">            Province province = TestData.CreateProvince(&quot;北京&quot;, &quot;朝阳区&quot;, &quot;海淀区&quot;);</a>
<a name="ln115">            //保存数据到数据库，会将导航属性一起保存</a>
<a name="ln116">            this.DbContext.Save(province);</a>
<a name="ln117"> </a>
<a name="ln118">            //查询数据并包含关联的导航属性一并查出</a>
<a name="ln119">            province = this.DbContext.Query&lt;Province&gt;().IncludeAll().Where(a =&gt; a.Id == province.Id).First();</a>
<a name="ln120"> </a>
<a name="ln121">            Person person = null;</a>
<a name="ln122">            var q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln123"> </a>
<a name="ln124">            this._result = q.Where(a =&gt; a.Id &gt; 0).ToList();</a>
<a name="ln125">            this._result = q.Count();</a>
<a name="ln126">            this._result = q.LongCount();</a>
<a name="ln127">            this._result = q.Max(a =&gt; a.Id);</a>
<a name="ln128">            this._result = q.Min(a =&gt; a.Id);</a>
<a name="ln129">            this._result = q.Sum(a =&gt; a.Id);</a>
<a name="ln130">            this._result = q.Average(a =&gt; a.Age);</a>
<a name="ln131"> </a>
<a name="ln132">            person = new Person() { Name = &quot;chloe&quot;, Age = 18, Gender = Gender.Female, CityId = 1, CreateTime = DateTime.Now };</a>
<a name="ln133">            person.Profile = new PersonProfile() { IdNumber = Guid.NewGuid().ToString(), BirthDay = DateTime.Now };</a>
<a name="ln134"> </a>
<a name="ln135">            //插入</a>
<a name="ln136">            person = this.DbContext.Insert(person);</a>
<a name="ln137">            person.Profile.Id = person.Id;</a>
<a name="ln138">            this.DbContext.Insert(person.Profile);</a>
<a name="ln139"> </a>
<a name="ln140">            //lambda 表达式更新</a>
<a name="ln141">            this._result = this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == person.Id, a =&gt; new Person() { Age = a.Age + 1, EditTime = DateTime.Now });</a>
<a name="ln142"> </a>
<a name="ln143">            //查询</a>
<a name="ln144">            person = this.DbContext.QueryByKey&lt;Person&gt;(person.Id);</a>
<a name="ln145">            person.Age = person.Age + 1;</a>
<a name="ln146">            person.EditTime = DateTime.Now;</a>
<a name="ln147"> </a>
<a name="ln148">            //更新</a>
<a name="ln149">            this._result = this.DbContext.Update(person);</a>
<a name="ln150"> </a>
<a name="ln151">            //删除</a>
<a name="ln152">            this._result = this.DbContext.Delete&lt;Person&gt;(person);</a>
<a name="ln153"> </a>
<a name="ln154">            //lambda 表达式插入，返回主键</a>
<a name="ln155">            var insertedId = this.DbContext.Insert(() =&gt; new Person() { Name = &quot;chloe&quot;, Age = 18, Gender = Gender.Female, CityId = 1, CreateTime = DateTime.Now, RowVersion = 0 });</a>
<a name="ln156"> </a>
<a name="ln157">            //根据主键删除</a>
<a name="ln158">            this._result = this.DbContext.DeleteByKey&lt;Person&gt;(insertedId);</a>
<a name="ln159"> </a>
<a name="ln160">            ConsoleHelper.WriteLineAndReadKey(&quot;Crud over...&quot;);</a>
<a name="ln161">        }</a>
<a name="ln162">        public virtual async Task CrudAsync()</a>
<a name="ln163">        {</a>
<a name="ln164">            Province province = TestData.CreateProvince(&quot;上海&quot;, &quot;黄浦区&quot;, &quot;徐汇区&quot;);</a>
<a name="ln165">            //保存数据到数据库，会将导航属性一起保存</a>
<a name="ln166">            await this.DbContext.SaveAsync(province);</a>
<a name="ln167"> </a>
<a name="ln168">            //查询数据并包含关联的导航属性一并查出</a>
<a name="ln169">            province = await this.DbContext.Query&lt;Province&gt;().IncludeAll().Where(a =&gt; a.Id == province.Id).FirstAsync();</a>
<a name="ln170"> </a>
<a name="ln171">            Person person = null;</a>
<a name="ln172">            var q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln173"> </a>
<a name="ln174">            this._result = await q.Where(a =&gt; a.Id &gt; 0).ToListAsync();</a>
<a name="ln175">            this._result = await q.CountAsync();</a>
<a name="ln176">            this._result = await q.LongCountAsync();</a>
<a name="ln177">            this._result = await q.MaxAsync(a =&gt; a.Id);</a>
<a name="ln178">            this._result = await q.MinAsync(a =&gt; a.Id);</a>
<a name="ln179">            this._result = await q.SumAsync(a =&gt; a.Id);</a>
<a name="ln180">            this._result = await q.AverageAsync(a =&gt; a.Age);</a>
<a name="ln181"> </a>
<a name="ln182">            person = new Person() { Name = &quot;Chloe&quot;, Age = 18, Gender = Gender.Female, CityId = 1, CreateTime = DateTime.Now };</a>
<a name="ln183">            person.Profile = new PersonProfile() { IdNumber = Guid.NewGuid().ToString(), BirthDay = DateTime.Now };</a>
<a name="ln184"> </a>
<a name="ln185">            //插入</a>
<a name="ln186">            person = await this.DbContext.InsertAsync(person);</a>
<a name="ln187">            person.Profile.Id = person.Id;</a>
<a name="ln188">            this.DbContext.Insert(person.Profile);</a>
<a name="ln189"> </a>
<a name="ln190">            //lambda 表达式更新</a>
<a name="ln191">            this._result = await this.DbContext.UpdateAsync&lt;Person&gt;(a =&gt; a.Id == person.Id, a =&gt; new Person() { Age = a.Age + 1, EditTime = DateTime.Now });</a>
<a name="ln192"> </a>
<a name="ln193">            //查询</a>
<a name="ln194">            person = await this.DbContext.QueryByKeyAsync&lt;Person&gt;(person.Id);</a>
<a name="ln195">            person.Age = person.Age + 1;</a>
<a name="ln196">            person.EditTime = DateTime.Now;</a>
<a name="ln197"> </a>
<a name="ln198">            //更新</a>
<a name="ln199">            this._result = await this.DbContext.UpdateAsync(person);</a>
<a name="ln200"> </a>
<a name="ln201">            //删除</a>
<a name="ln202">            this._result = await this.DbContext.DeleteAsync&lt;Person&gt;(person);</a>
<a name="ln203"> </a>
<a name="ln204">            //lambda 表达式插入，返回主键</a>
<a name="ln205">            var insertedId = await this.DbContext.InsertAsync(() =&gt; new Person() { Name = &quot;Chloe&quot;, Age = 18, Gender = Gender.Female, CityId = 1, CreateTime = DateTime.Now, RowVersion = 0 });</a>
<a name="ln206"> </a>
<a name="ln207">            //根据主键删除</a>
<a name="ln208">            this._result = await this.DbContext.DeleteByKeyAsync&lt;Person&gt;(insertedId);</a>
<a name="ln209"> </a>
<a name="ln210">            ConsoleHelper.WriteLineAndReadKey(&quot;CrudAsync over...&quot;);</a>
<a name="ln211">        }</a>
<a name="ln212"> </a>
<a name="ln213">        /// &lt;summary&gt;</a>
<a name="ln214">        /// 基础查询</a>
<a name="ln215">        /// &lt;/summary&gt;</a>
<a name="ln216">        public virtual void BasicQuery()</a>
<a name="ln217">        {</a>
<a name="ln218">            IQuery&lt;Person&gt; q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln219"> </a>
<a name="ln220">            Person person = q.First();</a>
<a name="ln221"> </a>
<a name="ln222">            string name = &quot;Chloe&quot;;</a>
<a name="ln223">            this._result = q.Where(a =&gt; a.Name == name).ToList();</a>
<a name="ln224"> </a>
<a name="ln225">            this._result = q.Where(a =&gt; a.Id == person.Id).FirstOrDefault();</a>
<a name="ln226">            /*</a>
<a name="ln227">             * SELECT [Person].[Id] AS [Id],[Person].[Name] AS [Name],[Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime]</a>
<a name="ln228">             * FROM [Person] AS [Person] WHERE [Person].[Id] = @P_0 LIMIT 1 OFFSET 0</a>
<a name="ln229">             */</a>
<a name="ln230"> </a>
<a name="ln231"> </a>
<a name="ln232">            //可以选取指定的字段</a>
<a name="ln233">            this._result = q.Where(a =&gt; a.Id == person.Id).Select(a =&gt; new { a.Id, a.Name }).FirstOrDefault();</a>
<a name="ln234">            /*</a>
<a name="ln235">             * SELECT [Person].[Id] AS [Id],[Person].[Name] AS [Name] FROM [Person] AS [Person] WHERE [Person].[Id] = @P_0 LIMIT 1 OFFSET 0</a>
<a name="ln236">             */</a>
<a name="ln237"> </a>
<a name="ln238"> </a>
<a name="ln239">            //分页</a>
<a name="ln240">            this._result = q.Where(a =&gt; a.Id &gt; 0).OrderBy(a =&gt; a.Age).Skip(20).Take(10).ToList();</a>
<a name="ln241">            /*</a>
<a name="ln242">             * SELECT [Person].[Id] AS [Id],[Person].[Name] AS [Name],[Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime] FROM [Person] AS [Person] WHERE [Person].[Id] &gt; 0 ORDER BY [Person].[Age] ASC LIMIT 10 OFFSET 20</a>
<a name="ln243">             */</a>
<a name="ln244"> </a>
<a name="ln245"> </a>
<a name="ln246">            /* like 查询 */</a>
<a name="ln247">            this._result = q.Where(a =&gt; a.Name.Contains(&quot;Chloe&quot;) || a.Name.StartsWith(&quot;C&quot;) || a.Name.EndsWith(&quot;o&quot;)).ToList();</a>
<a name="ln248">            /*</a>
<a name="ln249">             * SELECT </a>
<a name="ln250">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name] </a>
<a name="ln251">             * FROM [Person] AS [Person] </a>
<a name="ln252">             * WHERE ([Person].[Name] LIKE '%' || 'Chloe' || '%' OR [Person].[Name] LIKE 'C' || '%' OR [Person].[Name] LIKE '%' || 'o')</a>
<a name="ln253">             */</a>
<a name="ln254"> </a>
<a name="ln255"> </a>
<a name="ln256">            /* in 一个数组 */</a>
<a name="ln257">            List&lt;Person&gt; persons = null;</a>
<a name="ln258">            List&lt;int&gt; personIds = new List&lt;int&gt;() { 1, 2, 3 };</a>
<a name="ln259">            persons = q.Where(a =&gt; personIds.Contains(a.Id)).ToList(); /* list.Contains() 方法组合就会生成 in一个数组 sql 语句 */</a>
<a name="ln260">            /*</a>
<a name="ln261">             * SELECT </a>
<a name="ln262">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name]</a>
<a name="ln263">             * FROM [Person] AS [Person] </a>
<a name="ln264">             * WHERE [Person].[Id] IN (1,2,3)</a>
<a name="ln265">             */</a>
<a name="ln266"> </a>
<a name="ln267"> </a>
<a name="ln268">            /* in 子查询 */</a>
<a name="ln269">            persons = q.Where(a =&gt; this.DbContext.Query&lt;City&gt;().Select(c =&gt; c.Id).ToList().Contains((int)a.CityId)).ToList(); /* IQuery&lt;T&gt;.ToList().Contains() 方法组合就会生成 in 子查询 sql 语句 */</a>
<a name="ln270">            /*</a>
<a name="ln271">             * SELECT </a>
<a name="ln272">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name]</a>
<a name="ln273">             * FROM [Person] AS [Person] </a>
<a name="ln274">             * WHERE [Person].[CityId] IN (SELECT [City].[Id] AS [C] FROM [City] AS [City])</a>
<a name="ln275">             */</a>
<a name="ln276"> </a>
<a name="ln277"> </a>
<a name="ln278">            /* distinct 查询 */</a>
<a name="ln279">            q.Select(a =&gt; new { a.Name }).Distinct().ToList();</a>
<a name="ln280">            /*</a>
<a name="ln281">             * SELECT DISTINCT [Person].[Name] AS [Name] FROM [Person] AS [Person]</a>
<a name="ln282">             */</a>
<a name="ln283"> </a>
<a name="ln284">            ConsoleHelper.WriteLineAndReadKey(&quot;BasicQuery over...&quot;);</a>
<a name="ln285">        }</a>
<a name="ln286"> </a>
<a name="ln287">        /// &lt;summary&gt;</a>
<a name="ln288">        /// 连接查询</a>
<a name="ln289">        /// &lt;/summary&gt;</a>
<a name="ln290">        public virtual void JoinQuery()</a>
<a name="ln291">        {</a>
<a name="ln292">            var person_city_province = this.DbContext.Query&lt;Person&gt;()</a>
<a name="ln293">                                     .InnerJoin&lt;City&gt;((person, city) =&gt; person.CityId == city.Id)</a>
<a name="ln294">                                     .InnerJoin&lt;Province&gt;((person, city, province) =&gt; city.ProvinceId == province.Id);</a>
<a name="ln295"> </a>
<a name="ln296">            //查出一个用户及其隶属的城市和省份的所有信息</a>
<a name="ln297">            var view = person_city_province.Select((person, city, province) =&gt; new { Person = person, City = city, Province = province }).Where(a =&gt; a.Person.Id &gt; 1).ToList();</a>
<a name="ln298">            /*</a>
<a name="ln299">             * SELECT [Person].[Id] AS [Id],[Person].[Name] AS [Name],[Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[City].[Id] AS [Id0],[City].[Name] AS [Name0],[City].[ProvinceId] AS [ProvinceId],[Province].[Id] AS [Id1],[Province].[Name] AS [Name1] FROM [Person] AS [Person] INNER JOIN [City] AS [City] ON [Person].[CityId] = [City].[Id] INNER JOIN [Province] AS [Province] ON [City].[ProvinceId] = [Province].[Id] WHERE [Person].[Id] &gt; 1</a>
<a name="ln300">             */</a>
<a name="ln301"> </a>
<a name="ln302">            //也可以只获取指定的字段信息：PersonId,PersonName,CityName,ProvinceName</a>
<a name="ln303">            person_city_province.Select((person, city, province) =&gt; new { PersonId = person.Id, PersonName = person.Name, CityName = city.Name, ProvinceName = province.Name }).Where(a =&gt; a.PersonId &gt; 1).ToList();</a>
<a name="ln304">            /*</a>
<a name="ln305">             * SELECT [Person].[Id] AS [PersonId],[Person].[Name] AS [PersonName],[City].[Name] AS [CityName],[Province].[Name] AS [ProvinceName] FROM [Person] AS [Person] INNER JOIN [City] AS [City] ON [Person].[CityId] = [City].[Id] INNER JOIN [Province] AS [Province] ON [City].[ProvinceId] = [Province].[Id] WHERE [Person].[Id] &gt; 1</a>
<a name="ln306">             */</a>
<a name="ln307"> </a>
<a name="ln308"> </a>
<a name="ln309">            /* quick join and paging. */</a>
<a name="ln310">            this.DbContext.JoinQuery&lt;Person, City&gt;((person, city) =&gt; new object[]</a>
<a name="ln311">            {</a>
<a name="ln312">                JoinType.LeftJoin, person.CityId == city.Id</a>
<a name="ln313">            })</a>
<a name="ln314">            .Select((person, city) =&gt; new { Person = person, City = city })</a>
<a name="ln315">            .Where(a =&gt; a.Person.Id &gt; -1)</a>
<a name="ln316">            .OrderByDesc(a =&gt; a.Person.Age)</a>
<a name="ln317">            .TakePage(1, 20)</a>
<a name="ln318">            .ToList();</a>
<a name="ln319"> </a>
<a name="ln320">            this.DbContext.JoinQuery&lt;Person, City, Province&gt;((person, city, province) =&gt; new object[]</a>
<a name="ln321">            {</a>
<a name="ln322">                JoinType.LeftJoin, person.CityId == city.Id,          /* 表 Person 和 City 进行Left连接 */</a>
<a name="ln323">                JoinType.LeftJoin, city.ProvinceId == province.Id   /* 表 City 和 Province 进行Left连接 */</a>
<a name="ln324">            })</a>
<a name="ln325">            .Select((person, city, province) =&gt; new { Person = person, City = city, Province = province })   /* 投影成匿名对象 */</a>
<a name="ln326">            .Where(a =&gt; a.Person.Id &gt; -1)     /* 进行条件过滤 */</a>
<a name="ln327">            .OrderByDesc(a =&gt; a.Person.Age)   /* 排序 */</a>
<a name="ln328">            .TakePage(1, 20)                /* 分页 */</a>
<a name="ln329">            .ToList();</a>
<a name="ln330"> </a>
<a name="ln331">            ConsoleHelper.WriteLineAndReadKey(&quot;JoinQuery over...&quot;);</a>
<a name="ln332">        }</a>
<a name="ln333"> </a>
<a name="ln334">        /// &lt;summary&gt;</a>
<a name="ln335">        /// 排除字段查询</a>
<a name="ln336">        /// &lt;/summary&gt;</a>
<a name="ln337">        public virtual void ExcludeFieldQuery()</a>
<a name="ln338">        {</a>
<a name="ln339">            IQuery&lt;Person&gt; q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln340"> </a>
<a name="ln341">            //排除指定的字段</a>
<a name="ln342">            List&lt;Person&gt; persons = q.Exclude(a =&gt; a.Name).ToList();</a>
<a name="ln343">            /*</a>
<a name="ln344">             * 生成的 sql 语句中不包含 Name 字段</a>
<a name="ln345">             * SELECT [Person].[Gender],[Person].[Age],[Person].[CityId],[Person].[CreateTime],[Person].[EditTime],[Person].[Id]</a>
<a name="ln346">               FROM [Person] AS [Person] WHERE ([Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1)</a>
<a name="ln347">             */</a>
<a name="ln348"> </a>
<a name="ln349">            foreach (var person in persons)</a>
<a name="ln350">            {</a>
<a name="ln351">                Debug.Assert(person.Name == default(string));</a>
<a name="ln352">            }</a>
<a name="ln353"> </a>
<a name="ln354"> </a>
<a name="ln355">            //使用匿名类形式排除多个字段</a>
<a name="ln356">            persons = q.Exclude(a =&gt; new { a.Name, a.Age, a.EditTime, a.CityId, a.CreateTime }).ToList();</a>
<a name="ln357">            /*</a>
<a name="ln358">             * SELECT [Person].[Gender],[Person].[Id] FROM [Person] AS [Person] WHERE ([Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1)</a>
<a name="ln359">             */</a>
<a name="ln360">            foreach (var person in persons)</a>
<a name="ln361">            {</a>
<a name="ln362">                Debug.Assert(person.Name == default(string));</a>
<a name="ln363">                Debug.Assert(person.Age == default(int?));</a>
<a name="ln364">                Debug.Assert(person.EditTime == default(DateTime?));</a>
<a name="ln365">                Debug.Assert(person.CityId == default(int));</a>
<a name="ln366">                Debug.Assert(person.CreateTime == default(DateTime));</a>
<a name="ln367">            }</a>
<a name="ln368"> </a>
<a name="ln369"> </a>
<a name="ln370">            //使用 new object[] 形式排除多个字段</a>
<a name="ln371">            persons = q.Exclude(a =&gt; new object[] { a.Name, a.Age, a.EditTime, a.CityId, a.CreateTime }).ToList();</a>
<a name="ln372">            /*</a>
<a name="ln373">             * SELECT [Person].[Gender],[Person].[Id] FROM [Person] AS [Person] WHERE ([Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1)</a>
<a name="ln374">             */</a>
<a name="ln375"> </a>
<a name="ln376">            foreach (var person in persons)</a>
<a name="ln377">            {</a>
<a name="ln378">                Debug.Assert(person.Name == default(string));</a>
<a name="ln379">                Debug.Assert(person.Age == default(int?));</a>
<a name="ln380">                Debug.Assert(person.EditTime == default(DateTime?));</a>
<a name="ln381">                Debug.Assert(person.CityId == default(int));</a>
<a name="ln382">                Debug.Assert(person.CreateTime == default(DateTime));</a>
<a name="ln383">            }</a>
<a name="ln384"> </a>
<a name="ln385"> </a>
<a name="ln386">            //在多表连接中排除指定的字段</a>
<a name="ln387">            var joinResults = q.LeftJoin&lt;City&gt;((person, city) =&gt; person.CityId == city.Id).Select((person, city) =&gt; new { Person = person, City = city })</a>
<a name="ln388">                .Exclude(a =&gt; new Object[] { a.Person.Name, a.City.Name }).ToList();</a>
<a name="ln389">            /*</a>
<a name="ln390">             * SELECT [Person].[Gender],[Person].[Age],[Person].[CityId],[Person].[CreateTime],[Person].[EditTime],[Person].[Id],[City].[ProvinceId],[City].[Id] AS [Id0] </a>
<a name="ln391">               FROM [Person] AS [Person] LEFT JOIN [City] AS [City] ON ([Person].[CityId] = [City].[Id] AND [City].[Id] &gt; -2) </a>
<a name="ln392">               WHERE ([Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1)</a>
<a name="ln393">             */</a>
<a name="ln394"> </a>
<a name="ln395">            foreach (var joinResult in joinResults)</a>
<a name="ln396">            {</a>
<a name="ln397">                Debug.Assert(joinResult.Person.Name == default(string));</a>
<a name="ln398">                Debug.Assert(joinResult.City.Name == default(string));</a>
<a name="ln399">            }</a>
<a name="ln400"> </a>
<a name="ln401"> </a>
<a name="ln402">            //在导航属性中排除指定的字段</a>
<a name="ln403">            persons = q.Exclude(a =&gt; a.Name)</a>
<a name="ln404">                .Include(a =&gt; a.City).ExcludeField(a =&gt; a.Name)</a>
<a name="ln405">                .ThenInclude(a =&gt; a.Province).ExcludeField(a =&gt; a.Name)</a>
<a name="ln406">                .ToList();</a>
<a name="ln407">            /*</a>
<a name="ln408">             * 生成的 sql 语句中不包含 Name 字段</a>
<a name="ln409">             * SELECT [Person].[Gender],[Person].[Age],[Person].[CityId],[Person].[CreateTime],[Person].[EditTime],[Person].[Id],[City].[ProvinceId],[City].[Id] AS [Id0],[Province].[Id] AS [Id1] </a>
<a name="ln410">               FROM [Person] AS [Person] </a>
<a name="ln411">               INNER JOIN [City] AS [City] ON ([Person].[CityId] = [City].[Id] AND [City].[Id] &gt; -2) </a>
<a name="ln412">               INNER JOIN [Province] AS [Province] ON ([City].[ProvinceId] = [Province].[Id] AND [Province].[Id] &gt; -3) </a>
<a name="ln413">               WHERE ([Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1)</a>
<a name="ln414">             */</a>
<a name="ln415"> </a>
<a name="ln416">            foreach (var person in persons)</a>
<a name="ln417">            {</a>
<a name="ln418">                Debug.Assert(person.Name == default(string));</a>
<a name="ln419">                Debug.Assert(person.City.Name == default(string));</a>
<a name="ln420">                Debug.Assert(person.City.Province.Name == default(string));</a>
<a name="ln421">            }</a>
<a name="ln422"> </a>
<a name="ln423"> </a>
<a name="ln424">            var cities = this.DbContext.Query&lt;City&gt;().Exclude(a =&gt; a.Name)</a>
<a name="ln425">                  .IncludeMany(a =&gt; a.Persons).ExcludeField(a =&gt; a.Name)</a>
<a name="ln426">                  .Include(a =&gt; a.Province).ExcludeField(a =&gt; a.Name)</a>
<a name="ln427">                  .ToList();</a>
<a name="ln428">            /*</a>
<a name="ln429">             * 生成的 sql 语句中不包含 Name 字段</a>
<a name="ln430">             * SELECT [City].[ProvinceId],[City].[Id],[Province].[Id] AS [Id0],[Person].[Gender],[Person].[Age],[Person].[CityId],[Person].[CreateTime],[Person].[EditTime],[Person].[Id] AS [Id1] </a>
<a name="ln431">               FROM [City] AS [City] </a>
<a name="ln432">               INNER JOIN [Province] AS [Province] ON ([City].[ProvinceId] = [Province].[Id] AND [Province].[Id] &gt; -3) </a>
<a name="ln433">               LEFT JOIN [Person] AS [Person] ON ([City].[Id] = [Person].[CityId] AND [Person].[Id] &gt; -100 AND [Person].[Id] &gt; -1) </a>
<a name="ln434">               WHERE [City].[Id] &gt; -2 ORDER BY [City].[Id] ASC</a>
<a name="ln435">             */</a>
<a name="ln436"> </a>
<a name="ln437">            foreach (var city in cities)</a>
<a name="ln438">            {</a>
<a name="ln439">                Debug.Assert(city.Name == default(string));</a>
<a name="ln440">                Debug.Assert(city.Province.Name == default(string));</a>
<a name="ln441"> </a>
<a name="ln442">                foreach (var person in city.Persons)</a>
<a name="ln443">                {</a>
<a name="ln444">                    Debug.Assert(person.Name == default(string));</a>
<a name="ln445">                }</a>
<a name="ln446">            }</a>
<a name="ln447"> </a>
<a name="ln448">            ConsoleHelper.WriteLineAndReadKey(&quot;ExcludeFieldQuery over...&quot;);</a>
<a name="ln449">        }</a>
<a name="ln450"> </a>
<a name="ln451">        /// &lt;summary&gt;</a>
<a name="ln452">        /// 聚合查询</a>
<a name="ln453">        /// &lt;/summary&gt;</a>
<a name="ln454">        public virtual void AggregateQuery()</a>
<a name="ln455">        {</a>
<a name="ln456">            IQuery&lt;Person&gt; q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln457"> </a>
<a name="ln458">            //注：一定要 ToList()</a>
<a name="ln459">            q.Select(a =&gt; Sql.Count()).ToList().First();</a>
<a name="ln460">            /*</a>
<a name="ln461">             * SELECT COUNT(1) AS [C] FROM [Person] AS [Person]</a>
<a name="ln462">             */</a>
<a name="ln463"> </a>
<a name="ln464">            q.Select(a =&gt; new { Count = Sql.Count(), LongCount = Sql.LongCount(), Sum = Sql.Sum(a.Age), Max = Sql.Max(a.Age), Min = Sql.Min(a.Age), Average = Sql.Average(a.Age) }).ToList().First();</a>
<a name="ln465">            /*</a>
<a name="ln466">             * SELECT COUNT(1) AS [Count],COUNT(1) AS [LongCount],CAST(SUM([Person].[Age]) AS INTEGER) AS [Sum],MAX([Person].[Age]) AS [Max],MIN([Person].[Age]) AS [Min],CAST(AVG([Person].[Age]) AS REAL) AS [Average] FROM [Person] AS [Person]</a>
<a name="ln467">             */</a>
<a name="ln468"> </a>
<a name="ln469">            var count = q.Count();</a>
<a name="ln470">            /*</a>
<a name="ln471">             * SELECT COUNT(1) AS [C] FROM [Person] AS [Person]</a>
<a name="ln472">             */</a>
<a name="ln473"> </a>
<a name="ln474">            var longCount = q.LongCount();</a>
<a name="ln475">            /*</a>
<a name="ln476">             * SELECT COUNT(1) AS [C] FROM [Person] AS [Person]</a>
<a name="ln477">             */</a>
<a name="ln478"> </a>
<a name="ln479">            var sum = q.Sum(a =&gt; a.Age);</a>
<a name="ln480">            /*</a>
<a name="ln481">             * SELECT CAST(SUM([Person].[Age]) AS INTEGER) AS [C] FROM [Person] AS [Person]</a>
<a name="ln482">             */</a>
<a name="ln483"> </a>
<a name="ln484">            var max = q.Max(a =&gt; a.Age);</a>
<a name="ln485">            /*</a>
<a name="ln486">             * SELECT MAX([Person].[Age]) AS [C] FROM [Person] AS [Person]</a>
<a name="ln487">             */</a>
<a name="ln488"> </a>
<a name="ln489">            var min = q.Min(a =&gt; a.Age);</a>
<a name="ln490">            /*</a>
<a name="ln491">             * SELECT MIN([Person].[Age]) AS [C] FROM [Person] AS [Person]</a>
<a name="ln492">             */</a>
<a name="ln493"> </a>
<a name="ln494">            var avg = q.Average(a =&gt; a.Age);</a>
<a name="ln495">            /*</a>
<a name="ln496">             * SELECT CAST(AVG([Person].[Age]) AS REAL) AS [C] FROM [Person] AS [Person]</a>
<a name="ln497">             */</a>
<a name="ln498"> </a>
<a name="ln499">            ConsoleHelper.WriteLineAndReadKey(&quot;AggregateQuery over...&quot;);</a>
<a name="ln500">        }</a>
<a name="ln501"> </a>
<a name="ln502">        /// &lt;summary&gt;</a>
<a name="ln503">        /// 分组查询</a>
<a name="ln504">        /// &lt;/summary&gt;</a>
<a name="ln505">        public virtual void GroupQuery()</a>
<a name="ln506">        {</a>
<a name="ln507">            IQuery&lt;Person&gt; q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln508"> </a>
<a name="ln509">            //用法1</a>
<a name="ln510">            IGroupingQuery&lt;Person&gt; g = q.Where(a =&gt; a.Id &gt; 0).GroupBy(a =&gt; a.Age);</a>
<a name="ln511">            // g = g.AndBy(a =&gt; a.Id);  //多个字段分组</a>
<a name="ln512"> </a>
<a name="ln513">            g = g.Having(a =&gt; a.Age &gt; 1 &amp;&amp; Sql.Count() &gt; 0);</a>
<a name="ln514"> </a>
<a name="ln515">            g.Select(a =&gt; new { a.Age, Count = Sql.Count(), Sum = Sql.Sum(a.Age), Max = Sql.Max(a.Age), Min = Sql.Min(a.Age), Avg = Sql.Average(a.Age) }).ToList();</a>
<a name="ln516">            /*</a>
<a name="ln517">             * SELECT [Person].[Age] AS [Age],COUNT(1) AS [Count],CAST(SUM([Person].[Age]) AS INTEGER) AS [Sum],CAST(MAX([Person].[Age]) AS INTEGER) AS [Max],CAST(MIN([Person].[Age]) AS INTEGER) AS [Min],CAST(AVG([Person].[Age]) AS REAL) AS [Avg] </a>
<a name="ln518">             * FROM [Person] AS [Person] WHERE [Person].[Id] &gt; 0 </a>
<a name="ln519">             * GROUP BY [Person].[Age] HAVING ([Person].[Age] &gt; 1 AND COUNT(1) &gt; 0)</a>
<a name="ln520">             */</a>
<a name="ln521"> </a>
<a name="ln522"> </a>
<a name="ln523">            //用法2</a>
<a name="ln524">            g = q.Where(a =&gt; a.Id &gt; 0).GroupBy(a =&gt; new { a.Age, a.Id });</a>
<a name="ln525">            g = g.Having(a =&gt; a.Age &gt; 1 &amp;&amp; Sql.Count() &gt; 0);</a>
<a name="ln526">            g.Select(a =&gt; new { a.Age, Count = Sql.Count(), Sum = Sql.Sum(a.Age), Max = Sql.Max(a.Age), Min = Sql.Min(a.Age), Avg = Sql.Average(a.Age) }).ToList();</a>
<a name="ln527">            /*</a>
<a name="ln528">             * SELECT [Person].[Age] AS [Age],COUNT(1) AS [Count],CAST(SUM([Person].[Age]) AS INTEGER) AS [Sum],MAX([Person].[Age]) AS [Max],MIN([Person].[Age]) AS [Min],CAST(AVG([Person].[Age]) AS REAL) AS [Avg] </a>
<a name="ln529">             * FROM [Person] AS [Person] WHERE [Person].[Id] &gt; 0</a>
<a name="ln530">             * GROUP BY [Person].[Age],[Person].[Id] HAVING ([Person].[Age] &gt; 1 AND COUNT(1) &gt; 0)</a>
<a name="ln531">             */</a>
<a name="ln532"> </a>
<a name="ln533">            ConsoleHelper.WriteLineAndReadKey(&quot;GroupQuery over...&quot;);</a>
<a name="ln534">        }</a>
<a name="ln535"> </a>
<a name="ln536">        /// &lt;summary&gt;</a>
<a name="ln537">        /// 复杂查询</a>
<a name="ln538">        /// &lt;/summary&gt;</a>
<a name="ln539">        public virtual void ComplexQuery()</a>
<a name="ln540">        {</a>
<a name="ln541">            /*</a>
<a name="ln542">             * 支持 select * from Person where CityId in (1,2,3)    --in一个数组</a>
<a name="ln543">             * 支持 select * from Person where CityId in (select Id from City)    --in子查询</a>
<a name="ln544">             * 支持 select * from Person exists (select 1 from City where City.Id=Person.CityId)    --exists查询</a>
<a name="ln545">             * 支持 select (select top 1 CityName from City where Person.CityId==City.Id) as CityName, Person.Id, Person.Name from Person    --select子查询</a>
<a name="ln546">             * 支持 select </a>
<a name="ln547">             *            (select count(*) from Person where Person.CityId=City.Id) as PersonCount,     --总数</a>
<a name="ln548">             *            (select max(Person.Age) from Person where Person.CityId=City.Id) as MaxAge,  --最大年龄</a>
<a name="ln549">             *            (select avg(Person.Age) from Person where Person.CityId=City.Id) as AvgAge   --平均年龄</a>
<a name="ln550">             *      from City</a>
<a name="ln551">             *      --统计查询</a>
<a name="ln552">             */</a>
<a name="ln553"> </a>
<a name="ln554">            IQuery&lt;Person&gt; personQuery = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln555">            IQuery&lt;City&gt; cityQuery = this.DbContext.Query&lt;City&gt;();</a>
<a name="ln556"> </a>
<a name="ln557">            List&lt;Person&gt; persons = null;</a>
<a name="ln558"> </a>
<a name="ln559">            /* in 一个数组 */</a>
<a name="ln560">            List&lt;int&gt; personIds = new List&lt;int&gt;() { 1, 2, 3 };</a>
<a name="ln561">            persons = personQuery.Where(a =&gt; personIds.Contains(a.Id)).ToList();  /* list.Contains() 方法组合就会生成 in一个数组 sql 语句 */</a>
<a name="ln562">            /*</a>
<a name="ln563">             * SELECT </a>
<a name="ln564">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name] </a>
<a name="ln565">             * FROM [Person] AS [Person] </a>
<a name="ln566">             * WHERE [Person].[Id] IN (1,2,3)</a>
<a name="ln567">             */</a>
<a name="ln568"> </a>
<a name="ln569"> </a>
<a name="ln570">            /* in 子查询 */</a>
<a name="ln571">            persons = personQuery.Where(a =&gt; cityQuery.Select(c =&gt; c.Id).ToList().Contains((int)a.CityId)).ToList();  /* IQuery&lt;T&gt;.ToList().Contains() 方法组合就会生成 in 子查询 sql 语句 */</a>
<a name="ln572">            /*</a>
<a name="ln573">             * SELECT </a>
<a name="ln574">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name] </a>
<a name="ln575">             * FROM [Person] AS [Person] </a>
<a name="ln576">             * WHERE [Person].[CityId] IN (SELECT [City].[Id] AS [C] FROM [City] AS [City])</a>
<a name="ln577">             */</a>
<a name="ln578"> </a>
<a name="ln579"> </a>
<a name="ln580">            /* IQuery&lt;T&gt;.Any() 方法组合就会生成 exists 子查询 sql 语句 */</a>
<a name="ln581">            persons = personQuery.Where(a =&gt; cityQuery.Where(c =&gt; c.Id == a.CityId).Any()).ToList();</a>
<a name="ln582">            /*</a>
<a name="ln583">             * SELECT </a>
<a name="ln584">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name] </a>
<a name="ln585">             * FROM [Person] AS [Person] </a>
<a name="ln586">             * WHERE Exists (SELECT '1' AS [C] FROM [City] AS [City] WHERE [City].[Id] = [Person].[CityId])</a>
<a name="ln587">             */</a>
<a name="ln588"> </a>
<a name="ln589"> </a>
<a name="ln590">            /* select 子查询 */</a>
<a name="ln591">            var result = personQuery.Select(a =&gt; new</a>
<a name="ln592">            {</a>
<a name="ln593">                CityName = cityQuery.Where(c =&gt; c.Id == a.CityId).First().Name,</a>
<a name="ln594">                Person = a</a>
<a name="ln595">            }).ToList();</a>
<a name="ln596">            /*</a>
<a name="ln597">             * SELECT </a>
<a name="ln598">             *      (SELECT [City].[Name] AS [C] FROM [City] AS [City] WHERE [City].[Id] = [Person].[CityId] LIMIT 1 OFFSET 0) AS [CityName],</a>
<a name="ln599">             *      [Person].[Gender] AS [Gender],[Person].[Age] AS [Age],[Person].[CityId] AS [CityId],[Person].[EditTime] AS [EditTime],[Person].[Id] AS [Id],[Person].[Name] AS [Name] </a>
<a name="ln600">             * FROM [Person] AS [Person]</a>
<a name="ln601">             */</a>
<a name="ln602"> </a>
<a name="ln603"> </a>
<a name="ln604">            /* 统计 */</a>
<a name="ln605">            var statisticsResult = cityQuery.Select(a =&gt; new</a>
<a name="ln606">            {</a>
<a name="ln607">                PersonCount = personQuery.Where(u =&gt; u.CityId == a.Id).Count(),</a>
<a name="ln608">                MaxAge = personQuery.Where(u =&gt; u.CityId == a.Id).Max(c =&gt; c.Age),</a>
<a name="ln609">                AvgAge = personQuery.Where(u =&gt; u.CityId == a.Id).Average(c =&gt; c.Age),</a>
<a name="ln610">            }).ToList();</a>
<a name="ln611">            /*</a>
<a name="ln612">             * SELECT </a>
<a name="ln613">             *      (SELECT COUNT(1) AS [C] FROM [Person] AS [Person] WHERE [Person].[CityId] = [City].[Id]) AS [PersonCount],</a>
<a name="ln614">             *      (SELECT MAX([Person].[Age]) AS [C] FROM [Person] AS [Person] WHERE [Person].[CityId] = [City].[Id]) AS [MaxAge],</a>
<a name="ln615">             *      (SELECT CAST(AVG([Person].[Age]) AS REAL) AS [C] FROM [Person] AS [Person] WHERE [Person].[CityId] = [City].[Id]) AS [AvgAge] </a>
<a name="ln616">             * FROM [City] AS [City]</a>
<a name="ln617">             */</a>
<a name="ln618"> </a>
<a name="ln619">            ConsoleHelper.WriteLineAndReadKey(&quot;ComplexQuery over...&quot;);</a>
<a name="ln620">        }</a>
<a name="ln621"> </a>
<a name="ln622">        /// &lt;summary&gt;</a>
<a name="ln623">        /// 导航属性查询</a>
<a name="ln624">        /// &lt;/summary&gt;</a>
<a name="ln625">        public virtual void QueryWithNavigation()</a>
<a name="ln626">        {</a>
<a name="ln627">            object result = null;</a>
<a name="ln628">            result = this.DbContext.Query&lt;Person&gt;().Include(a =&gt; a.City).ThenInclude(a =&gt; a.Province).ToList();</a>
<a name="ln629"> </a>
<a name="ln630">            //忽略所有过滤器</a>
<a name="ln631">            result = this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters().Include(a =&gt; a.City).ThenInclude(a =&gt; a.Province).ToList();</a>
<a name="ln632"> </a>
<a name="ln633">            List&lt;City&gt; cities = this.DbContext.Query&lt;City&gt;().Include(a =&gt; a.Province).IncludeMany(a =&gt; a.Persons).Filter(a =&gt; a.Age &gt;= 18).ToList();</a>
<a name="ln634"> </a>
<a name="ln635">            cities.ForEach(city =&gt;</a>
<a name="ln636">            {</a>
<a name="ln637">                city.Persons.ForEach(person =&gt;</a>
<a name="ln638">                {</a>
<a name="ln639">                    Debug.Assert(person.Age &gt;= 18);</a>
<a name="ln640">                    Debug.Assert(person.City == null);</a>
<a name="ln641">                });</a>
<a name="ln642">            });</a>
<a name="ln643"> </a>
<a name="ln644">            List&lt;Province&gt; provinces = this.DbContext.Query&lt;Province&gt;().IncludeMany(a =&gt; a.Cities).ThenIncludeMany(a =&gt; a.Persons).ToList();</a>
<a name="ln645"> </a>
<a name="ln646">            provinces.ForEach(province =&gt;</a>
<a name="ln647">            {</a>
<a name="ln648">                province.Cities.ForEach(city =&gt;</a>
<a name="ln649">                {</a>
<a name="ln650">                    Debug.Assert(city.Province == null);</a>
<a name="ln651"> </a>
<a name="ln652">                    city.Persons.ForEach(person =&gt;</a>
<a name="ln653">                    {</a>
<a name="ln654">                        Debug.Assert(person.City == null);</a>
<a name="ln655">                    });</a>
<a name="ln656">                });</a>
<a name="ln657">            });</a>
<a name="ln658"> </a>
<a name="ln659">            provinces = this.DbContext.Query&lt;Province&gt;().IncludeMany(a =&gt; a.Cities).ThenIncludeMany(a =&gt; a.Persons).BindTwoWay().ToList(); //调用 BindTwoWay() 方法，子对象会将父对象设置到子对象对应的属性上</a>
<a name="ln660"> </a>
<a name="ln661">            provinces.ForEach(province =&gt;</a>
<a name="ln662">            {</a>
<a name="ln663">                province.Cities.ForEach(city =&gt;</a>
<a name="ln664">                {</a>
<a name="ln665">                    Debug.Assert(city.Province != null);</a>
<a name="ln666"> </a>
<a name="ln667">                    city.Persons.ForEach(person =&gt;</a>
<a name="ln668">                    {</a>
<a name="ln669">                        Debug.Assert(person.City != null);</a>
<a name="ln670">                    });</a>
<a name="ln671">                });</a>
<a name="ln672">            });</a>
<a name="ln673"> </a>
<a name="ln674">            //分页</a>
<a name="ln675">            result = this.DbContext.Query&lt;Province&gt;().IncludeMany(a =&gt; a.Cities).ThenIncludeMany(a =&gt; a.Persons).Where(a =&gt; a.Id &gt; 0).TakePage(1, 20).ToList();</a>
<a name="ln676"> </a>
<a name="ln677">            result = this.DbContext.Query&lt;City&gt;().IncludeMany(a =&gt; a.Persons).Filter(a =&gt; a.Age &gt; 18).ToList();</a>
<a name="ln678"> </a>
<a name="ln679">            //未 Include a.City，但依然可以在表达式树中使用 a.City 相关的属性</a>
<a name="ln680">            List&lt;Person&gt; persons = this.DbContext.Query&lt;Person&gt;().Where(a =&gt; a.City.Name == &quot;广州&quot;).ToList();</a>
<a name="ln681">            /*生成的 sql 中自动加上相关的 join 子句</a>
<a name="ln682">             SELECT `T`.`Name`,`T`.`Gender`,`T`.`Age`,`T`.`CityId`,`T`.`CreateTime`,`T`.`EditTime`,`T`.`RowVersion`,`T`.`Id` FROM `Person` AS `T` INNER JOIN `City` AS `T0` ON `T`.`CityId` = `T0`.`Id` WHERE `T0`.`Name` = N'广州'</a>
<a name="ln683">             */</a>
<a name="ln684"> </a>
<a name="ln685">            foreach (Person person in persons)</a>
<a name="ln686">            {</a>
<a name="ln687">                Debug.Assert(person.City == null);</a>
<a name="ln688">            }</a>
<a name="ln689"> </a>
<a name="ln690">            ConsoleHelper.WriteLineAndReadKey(&quot;QueryWithNavigation over...&quot;);</a>
<a name="ln691">        }</a>
<a name="ln692"> </a>
<a name="ln693">        /// &lt;summary&gt;</a>
<a name="ln694">        /// 导航属性+拆分查询</a>
<a name="ln695">        /// &lt;/summary&gt;</a>
<a name="ln696">        public virtual void SplitQuery()</a>
<a name="ln697">        {</a>
<a name="ln698">            IDbContext dbContext = this.DbContext;</a>
<a name="ln699"> </a>
<a name="ln700">            List&lt;int&gt; ids = new List&lt;int&gt;() { 1, 2 };</a>
<a name="ln701"> </a>
<a name="ln702">            var personQuery = dbContext.Query&lt;Person&gt;();</a>
<a name="ln703">            var cityQuery = dbContext.Query&lt;City&gt;();</a>
<a name="ln704">            var provinceQuery = dbContext.Query&lt;Province&gt;();</a>
<a name="ln705"> </a>
<a name="ln706">            //只会生成一条包含多个 left join 的 sql 语句</a>
<a name="ln707">            List&lt;Province&gt; provinces1 = provinceQuery.IncludeAll().OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln708">            /*</a>
<a name="ln709">            SELECT `T`.`Id`,`T`.`Name`,`T0`.`Id` AS `Id0`,`T0`.`Name` AS `Name0`,`T0`.`ProvinceId`,`T1`.`Name` AS `Name1`,`T1`.`Gender`,`T1`.`Age`,`T1`.`CityId`,`T1`.`CreateTime`,`T1`.`EditTime`,`T1`.`RowVersion`,`T1`.`Id` AS `Id1`,`T2`.`Id` AS `Id2`,`T2`.`IdNumber`,`T2`.`BirthDay`,`T3`.`Id` AS `Id3`,`T3`.`ProfileId`,`T3`.`FilePath` </a>
<a name="ln710">            FROM `Province` AS `T` </a>
<a name="ln711">            LEFT JOIN `City` AS `T0` ON (`T`.`Id` = `T0`.`ProvinceId` AND `T0`.`Id` &gt; -2) </a>
<a name="ln712">            LEFT JOIN `Person` AS `T1` ON (`T0`.`Id` = `T1`.`CityId` AND `T1`.`Id` &gt; -100 AND `T1`.`Id` &gt; -1) </a>
<a name="ln713">            INNER JOIN `PersonProfile` AS `T2` ON (`T1`.`Id` = `T2`.`Id` AND `T2`.`Id` &gt; -1) </a>
<a name="ln714">            LEFT JOIN `ProfileAnnex` AS `T3` ON `T2`.`Id` = `T3`.`ProfileId` </a>
<a name="ln715">            WHERE `T`.`Id` &gt; -3 ORDER BY `T`.`Id` ASC,`T0`.`Id` ASC,`T2`.`Id` ASC</a>
<a name="ln716">            */</a>
<a name="ln717"> </a>
<a name="ln718">            //调用 SplitQuery 后会拆分成多条 sql 语句查询</a>
<a name="ln719">            List&lt;Province&gt; provinces2 = provinceQuery.IncludeAll().SplitQuery().OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln720">            /*少量数据则会使用 in 查询</a>
<a name="ln721">            SELECT `T`.`Id`,`T`.`Name` FROM `Province` AS `T` WHERE `T`.`Id` &gt; -3 ORDER BY `T`.`Id` ASC;</a>
<a name="ln722"> </a>
<a name="ln723">            SELECT `T`.`Id`,`T`.`Name`,`T`.`ProvinceId` FROM `City` AS `T` WHERE (`T`.`ProvinceId` IN (1,2,3,4,5) AND `T`.`Id` &gt; -2);</a>
<a name="ln724"> </a>
<a name="ln725">            SELECT `T`.`Name`,`T`.`Gender`,`T`.`Age`,`T`.`CityId`,`T`.`CreateTime`,`T`.`EditTime`,`T`.`RowVersion`,`T`.`Id`,`T0`.`Id` AS `Id0`,`T0`.`IdNumber`,`T0`.`BirthDay` </a>
<a name="ln726">            FROM `Person` AS `T` </a>
<a name="ln727">            INNER JOIN `PersonProfile` AS `T0` ON (`T`.`Id` = `T0`.`Id` AND `T0`.`Id` &gt; -1) </a>
<a name="ln728">            WHERE (`T`.`CityId` IN (1,2,3,4,5,6,7,8,9,10,11,12,13,14) AND `T`.`Id` &gt; -1);</a>
<a name="ln729"> </a>
<a name="ln730">            SELECT `T`.`Id`,`T`.`ProfileId`,`T`.`FilePath` FROM `ProfileAnnex` AS `T` WHERE `T`.`ProfileId` IN (1,2,3,4,5,6,7,8,9,10,...);</a>
<a name="ln731">            */</a>
<a name="ln732"> </a>
<a name="ln733">            /*如果查询的数据数量过多，会生成多表 inner join 查询，如下：</a>
<a name="ln734">            SELECT `T`.`Id`,`T`.`Name` FROM `Province` AS `T` WHERE `T`.`Id` &gt; -3 ORDER BY `T`.`Id` ASC;</a>
<a name="ln735"> </a>
<a name="ln736">            SELECT `T0`.`Id`,`T0`.`Name`,`T0`.`ProvinceId` FROM `Province` AS `T` INNER JOIN `City` AS `T0` ON (`T`.`Id` = `T0`.`ProvinceId` AND `T0`.`Id` &gt; -2) WHERE `T`.`Id` &gt; -3;</a>
<a name="ln737"> </a>
<a name="ln738">            SELECT `T1`.`Name`,`T1`.`Gender`,`T1`.`Age`,`T1`.`CityId`,`T1`.`CreateTime`,`T1`.`EditTime`,`T1`.`RowVersion`,`T1`.`Id`,`T2`.`Id` AS `Id0`,`T2`.`IdNumber`,`T2`.`BirthDay` </a>
<a name="ln739">            FROM `Province` AS `T` </a>
<a name="ln740">            INNER JOIN `City` AS `T0` ON (`T`.`Id` = `T0`.`ProvinceId` AND `T0`.`Id` &gt; -2) </a>
<a name="ln741">            INNER JOIN `Person` AS `T1` ON (`T0`.`Id` = `T1`.`CityId` AND `T1`.`Id` &gt; -100 AND `T1`.`Id` &gt; -1) </a>
<a name="ln742">            INNER JOIN `PersonProfile` AS `T2` ON (`T1`.`Id` = `T2`.`Id` AND `T2`.`Id` &gt; -1) </a>
<a name="ln743">            WHERE `T`.`Id` &gt; -3;</a>
<a name="ln744"> </a>
<a name="ln745">            SELECT `T3`.`Id`,`T3`.`ProfileId`,`T3`.`FilePath` </a>
<a name="ln746">            FROM `Province` AS `T` </a>
<a name="ln747">            INNER JOIN `City` AS `T0` ON (`T`.`Id` = `T0`.`ProvinceId` AND `T0`.`Id` &gt; -2) </a>
<a name="ln748">            INNER JOIN `Person` AS `T1` ON (`T0`.`Id` = `T1`.`CityId` AND `T1`.`Id` &gt; -100 AND `T1`.`Id` &gt; -1) </a>
<a name="ln749">            INNER JOIN `PersonProfile` AS `T2` ON (`T1`.`Id` = `T2`.`Id` AND `T2`.`Id` &gt; -1) </a>
<a name="ln750">            INNER JOIN `ProfileAnnex` AS `T3` ON `T2`.`Id` = `T3`.`ProfileId` </a>
<a name="ln751">            WHERE `T`.`Id` &gt; -3;</a>
<a name="ln752">            */</a>
<a name="ln753"> </a>
<a name="ln754">            Debug.Assert(provinces2.Count == provinces1.Count);</a>
<a name="ln755"> </a>
<a name="ln756">            for (int i = 0; i &lt; provinces2.Count; i++)</a>
<a name="ln757">            {</a>
<a name="ln758">                var province2 = provinces2[i];</a>
<a name="ln759">                var province1 = provinces1[i];</a>
<a name="ln760"> </a>
<a name="ln761">                Debug.Assert(province2.Id == province1.Id);</a>
<a name="ln762"> </a>
<a name="ln763">                province2.Cities = province2.Cities.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln764">                province1.Cities = province1.Cities.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln765"> </a>
<a name="ln766">                Debug.Assert(province2.Cities.Count == province1.Cities.Count);</a>
<a name="ln767"> </a>
<a name="ln768">                for (int j = 0; j &lt; province2.Cities.Count; j++)</a>
<a name="ln769">                {</a>
<a name="ln770">                    var city2 = province2.Cities[j];</a>
<a name="ln771">                    var city1 = province1.Cities[j];</a>
<a name="ln772"> </a>
<a name="ln773">                    Debug.Assert(city2.Id == city1.Id);</a>
<a name="ln774"> </a>
<a name="ln775">                    city2.Persons = city2.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln776">                    city1.Persons = city1.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln777"> </a>
<a name="ln778">                    Debug.Assert(city2.Persons.Count == city1.Persons.Count);</a>
<a name="ln779"> </a>
<a name="ln780">                    for (int k = 0; k &lt; city2.Persons.Count; k++)</a>
<a name="ln781">                    {</a>
<a name="ln782">                        var person2 = city2.Persons[k];</a>
<a name="ln783">                        var person1 = city1.Persons[k];</a>
<a name="ln784"> </a>
<a name="ln785">                        Debug.Assert(person2.Id == person1.Id);</a>
<a name="ln786">                        Debug.Assert(person2.Profile.Id == person1.Profile.Id);</a>
<a name="ln787"> </a>
<a name="ln788">                        Debug.Assert(person2.Profile.Annexes.Count == person1.Profile.Annexes.Count);</a>
<a name="ln789"> </a>
<a name="ln790">                        person2.Profile.Annexes = person2.Profile.Annexes.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln791">                        person1.Profile.Annexes = person2.Profile.Annexes.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln792"> </a>
<a name="ln793">                        for (int i1 = 0; i1 &lt; person2.Profile.Annexes.Count; i1++)</a>
<a name="ln794">                        {</a>
<a name="ln795">                            Debug.Assert(person2.Profile.Annexes[i1].Id == person1.Profile.Annexes[i1].Id);</a>
<a name="ln796">                        }</a>
<a name="ln797">                    }</a>
<a name="ln798">                }</a>
<a name="ln799">            }</a>
<a name="ln800">            //city.Province, city.Persons</a>
<a name="ln801">            var cityQuery1 = cityQuery.Include(a =&gt; a.Province).IncludeMany(a =&gt; a.Persons).OrderBy(a =&gt; a.Id);</a>
<a name="ln802"> </a>
<a name="ln803">            List&lt;City&gt; cities1 = cityQuery1.ToList();</a>
<a name="ln804">            List&lt;City&gt; cities2 = cityQuery1.SplitQuery().BindTwoWay().ToList();</a>
<a name="ln805">            List&lt;City&gt; cities3 = cityQuery1.SplitQuery().BindTwoWay().IgnoreAllFilters().AsTracking().ToList();</a>
<a name="ln806"> </a>
<a name="ln807">            for (int i = 0; i &lt; cities1.Count; i++)</a>
<a name="ln808">            {</a>
<a name="ln809">                var city1 = cities1[i];</a>
<a name="ln810">                var city2 = cities2[i];</a>
<a name="ln811">                var city3 = cities3[i];</a>
<a name="ln812"> </a>
<a name="ln813">                city1.Persons = city1.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln814">                city2.Persons = city2.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln815">                city3.Persons = city3.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln816"> </a>
<a name="ln817">                Debug.Assert(city1.Id == city2.Id);</a>
<a name="ln818">                Debug.Assert(city1.Id == city2.Id);</a>
<a name="ln819"> </a>
<a name="ln820">                Debug.Assert(city1.Province.Id == city2.Province.Id);</a>
<a name="ln821">                Debug.Assert(city1.Province.Id == city3.Province.Id);</a>
<a name="ln822"> </a>
<a name="ln823">                Debug.Assert(city1.Persons.Count == city2.Persons.Count);</a>
<a name="ln824">                Debug.Assert(city1.Persons.Count == city3.Persons.Count);</a>
<a name="ln825"> </a>
<a name="ln826">                for (int j = 0; j &lt; city1.Persons.Count; j++)</a>
<a name="ln827">                {</a>
<a name="ln828">                    Person person1 = city1.Persons[j];</a>
<a name="ln829">                    Person person2 = city2.Persons[j];</a>
<a name="ln830">                    Person person3 = city3.Persons[j];</a>
<a name="ln831"> </a>
<a name="ln832">                    Debug.Assert(person1.Id == person2.Id);</a>
<a name="ln833">                    Debug.Assert(person1.Id == person3.Id);</a>
<a name="ln834"> </a>
<a name="ln835">                    Debug.Assert(person1.City == null);</a>
<a name="ln836">                    Debug.Assert(person2.City != null);  //因为 person2 和 person3 查询使用了 BindTwoWay()，所以会反向赋值</a>
<a name="ln837">                    Debug.Assert(person3.City != null);</a>
<a name="ln838"> </a>
<a name="ln839">                    Debug.Assert(person2.City.Id == person3.City.Id);</a>
<a name="ln840">                }</a>
<a name="ln841">            }</a>
<a name="ln842"> </a>
<a name="ln843">            //1:1:1</a>
<a name="ln844">            var personQuery1 = personQuery.Include(a =&gt; a.City).ThenInclude(a =&gt; a.Province).OrderBy(a =&gt; a.Id);</a>
<a name="ln845">            List&lt;Person&gt; persons1 = personQuery1.ToList();</a>
<a name="ln846">            List&lt;Person&gt; persons2 = personQuery1.SplitQuery().ToList();</a>
<a name="ln847">            List&lt;Person&gt; persons3 = personQuery1.SplitQuery().IgnoreAllFilters().AsTracking().ToList();</a>
<a name="ln848"> </a>
<a name="ln849">            Debug.Assert(persons1.Count == persons2.Count);</a>
<a name="ln850">            Debug.Assert(persons1.Count == persons3.Count);</a>
<a name="ln851"> </a>
<a name="ln852">            for (int i = 0; i &lt; persons1.Count; i++)</a>
<a name="ln853">            {</a>
<a name="ln854">                Person person1 = persons1[i];</a>
<a name="ln855">                Person person2 = persons2[i];</a>
<a name="ln856">                Person person3 = persons3[i];</a>
<a name="ln857"> </a>
<a name="ln858">                Debug.Assert(person1.Id == person2.Id);</a>
<a name="ln859">                Debug.Assert(person1.Id == person3.Id);</a>
<a name="ln860"> </a>
<a name="ln861">                Debug.Assert(person1.City.Id == person2.City.Id);</a>
<a name="ln862">                Debug.Assert(person1.City.Id == person3.City.Id);</a>
<a name="ln863"> </a>
<a name="ln864">                Debug.Assert(person1.City.Province.Id == person2.City.Province.Id);</a>
<a name="ln865">                Debug.Assert(person1.City.Province.Id == person3.City.Province.Id);</a>
<a name="ln866">            }</a>
<a name="ln867"> </a>
<a name="ln868">            //排除字段测试</a>
<a name="ln869">            var cityQueryWithExcludeField = cityQuery.Exclude(a =&gt; a.Name)</a>
<a name="ln870">                .Include(a =&gt; a.Province).ExcludeField(a =&gt; a.Name)</a>
<a name="ln871">                .IncludeMany(a =&gt; a.Persons).ExcludeField(a =&gt; new { a.Age, a.Name })</a>
<a name="ln872">                .OrderBy(a =&gt; a.Id).SplitQuery();</a>
<a name="ln873"> </a>
<a name="ln874">            var cities4 = cityQueryWithExcludeField.ToList();</a>
<a name="ln875">            for (int i = 0; i &lt; cities4.Count; i++)</a>
<a name="ln876">            {</a>
<a name="ln877">                var city = cities4[i];</a>
<a name="ln878">                Debug.Assert(city.Name == null);</a>
<a name="ln879">                Debug.Assert(city.Province.Name == null);</a>
<a name="ln880">                Debug.Assert(city.Persons.Count &gt; 0);</a>
<a name="ln881">                foreach (var person in city.Persons)</a>
<a name="ln882">                {</a>
<a name="ln883">                    Debug.Assert(person.Age == null);</a>
<a name="ln884">                    Debug.Assert(person.Name == null);</a>
<a name="ln885">                }</a>
<a name="ln886">            }</a>
<a name="ln887"> </a>
<a name="ln888">            //分页+拆分查询测试</a>
<a name="ln889"> </a>
<a name="ln890">            var pageQuery = cityQuery.IncludeAll().Where(a =&gt; a.Id &gt; -9999).OrderBy(a =&gt; a.Id).TakePage(1, 2);</a>
<a name="ln891"> </a>
<a name="ln892">            //未使用拆分查询的查询结果</a>
<a name="ln893">            var citiesWithoutSplitQuery = pageQuery.ToList();</a>
<a name="ln894"> </a>
<a name="ln895">            //使用拆分查询的查询结果</a>
<a name="ln896">            var cityCount = pageQuery.SplitQuery().Count();</a>
<a name="ln897">            var citiesWithSplitQuery = pageQuery.SplitQuery().ToList();</a>
<a name="ln898"> </a>
<a name="ln899">            Debug.Assert(citiesWithSplitQuery.Count &gt; 0);</a>
<a name="ln900">            Debug.Assert(citiesWithSplitQuery.Count == citiesWithoutSplitQuery.Count);</a>
<a name="ln901">            Debug.Assert(cityCount == citiesWithSplitQuery.Count);</a>
<a name="ln902"> </a>
<a name="ln903">            for (int i = 0; i &lt; citiesWithSplitQuery.Count; i++)</a>
<a name="ln904">            {</a>
<a name="ln905">                var city1 = citiesWithSplitQuery[i];</a>
<a name="ln906">                var city2 = citiesWithoutSplitQuery[i];</a>
<a name="ln907">                city1.Persons = city1.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln908">                city2.Persons = city2.Persons.OrderBy(a =&gt; a.Id).ToList();</a>
<a name="ln909"> </a>
<a name="ln910">                Debug.Assert(city1.Id == city2.Id);</a>
<a name="ln911">                Debug.Assert(city1.Id == city2.Id);</a>
<a name="ln912"> </a>
<a name="ln913">                Debug.Assert(city1.Province.Id == city2.Province.Id);</a>
<a name="ln914"> </a>
<a name="ln915">                Debug.Assert(city1.Persons.Count == city2.Persons.Count);</a>
<a name="ln916"> </a>
<a name="ln917">                for (int j = 0; j &lt; city1.Persons.Count; j++)</a>
<a name="ln918">                {</a>
<a name="ln919">                    Person person1 = city1.Persons[j];</a>
<a name="ln920">                    Person person2 = city2.Persons[j];</a>
<a name="ln921"> </a>
<a name="ln922">                    Debug.Assert(person1.Id == person2.Id);</a>
<a name="ln923">                }</a>
<a name="ln924">            }</a>
<a name="ln925"> </a>
<a name="ln926">            ConsoleHelper.WriteLineAndReadKey(&quot;SplitQuery over...&quot;);</a>
<a name="ln927">        }</a>
<a name="ln928"> </a>
<a name="ln929">        public virtual void Insert()</a>
<a name="ln930">        {</a>
<a name="ln931">            //lambda 插入</a>
<a name="ln932">            //返回主键 Id</a>
<a name="ln933">            int id = (int)this.DbContext.Insert&lt;Person&gt;(() =&gt; new Person() { Name = &quot;Chloe&quot;, Age = 18, Gender = Gender.Female, CityId = 1, CreateTime = DateTime.Now, RowVersion = 0 });</a>
<a name="ln934">            /*</a>
<a name="ln935">             * INSERT INTO [Person]([Name],[Age],[Gender],[CityId],[CreateTime]) VALUES('Chloe',18,2,1,DATETIME('NOW','LOCALTIME'));SELECT LAST_INSERT_ROWID()</a>
<a name="ln936">             */</a>
<a name="ln937"> </a>
<a name="ln938">            string idNumber = Guid.NewGuid().ToString();</a>
<a name="ln939">            this.DbContext.Insert&lt;PersonProfile&gt;(() =&gt; new PersonProfile() { Id = id, IdNumber = idNumber, BirthDay = DateTime.Now });</a>
<a name="ln940"> </a>
<a name="ln941">            //实体插入</a>
<a name="ln942">            Person person = new Person();</a>
<a name="ln943">            person.Name = &quot;Chloe&quot;;</a>
<a name="ln944">            person.Age = 18;</a>
<a name="ln945">            person.Gender = Gender.Female;</a>
<a name="ln946">            person.CityId = 1;</a>
<a name="ln947">            person.CreateTime = DateTime.Now;</a>
<a name="ln948">            person.Profile = new PersonProfile() { IdNumber = Guid.NewGuid().ToString(), BirthDay = DateTime.Now };</a>
<a name="ln949"> </a>
<a name="ln950">            //会自动将自增 Id 设置到 person 的 Id 属性上</a>
<a name="ln951">            person = this.DbContext.Insert(person);</a>
<a name="ln952">            person.Profile.Id = person.Id;</a>
<a name="ln953">            this.DbContext.Insert(person.Profile);</a>
<a name="ln954">            /*</a>
<a name="ln955">             * String @P_0 = 'Chloe';</a>
<a name="ln956">               Gender @P_1 = Female;</a>
<a name="ln957">               Int32 @P_2 = 18;</a>
<a name="ln958">               Int32 @P_3 = 1;</a>
<a name="ln959">               DateTime @P_4 = '2016/8/6 22:03:42';</a>
<a name="ln960">               INSERT INTO [Person]([Name],[Gender],[Age],[CityId],[CreateTime]) VALUES(@P_0,@P_1,@P_2,@P_3,@P_4);SELECT LAST_INSERT_ROWID()</a>
<a name="ln961">             */</a>
<a name="ln962"> </a>
<a name="ln963"> </a>
<a name="ln964">            //实体插入</a>
<a name="ln965">            person = new Person();</a>
<a name="ln966">            person.Name = &quot;&quot;;</a>
<a name="ln967">            person.Age = 18;</a>
<a name="ln968">            person.Gender = Gender.Female;</a>
<a name="ln969">            person.CityId = 1;</a>
<a name="ln970">            person.CreateTime = DateTime.Now;</a>
<a name="ln971">            person.EditTime = null;</a>
<a name="ln972">            person.Profile = new PersonProfile() { IdNumber = Guid.NewGuid().ToString(), BirthDay = DateTime.Now };</a>
<a name="ln973"> </a>
<a name="ln974">            //设置属性值为 null 和字符串空值不参与插入</a>
<a name="ln975">            (this.DbContext as DbContext).Options.InsertStrategy = InsertStrategy.IgnoreNull | InsertStrategy.IgnoreEmptyString;</a>
<a name="ln976"> </a>
<a name="ln977">            //插入时 Name 和 EditTime 属性不会生成到 sql 语句中</a>
<a name="ln978">            person = this.DbContext.Insert(person);</a>
<a name="ln979">            person.Profile.Id = person.Id;</a>
<a name="ln980">            this.DbContext.Insert(person.Profile);</a>
<a name="ln981">            /*</a>
<a name="ln982">             * Input Int32 @P_0 = 2;</a>
<a name="ln983">               Input Int32 @P_1 = 18;</a>
<a name="ln984">               Input Int32 @P_2 = 1;</a>
<a name="ln985">               Input DateTime @P_3 = '2023/12/7 1:09:08';</a>
<a name="ln986">               Input Int32 @P_4 = 0;</a>
<a name="ln987">               INSERT INTO [Person]([Gender],[Age],[CityId],[CreateTime],[RowVersion]) VALUES(@P_0,@P_1,@P_2,@P_3,@P_4);SELECT LAST_INSERT_ROWID()</a>
<a name="ln988">             */</a>
<a name="ln989"> </a>
<a name="ln990">            person = this.DbContext.Query&lt;Person&gt;().Where(a =&gt; a.Id == person.Id).First();</a>
<a name="ln991">            Debug.Assert(person.Name == null &amp;&amp; person.EditTime == null);</a>
<a name="ln992"> </a>
<a name="ln993">            ConsoleHelper.WriteLineAndReadKey(&quot;Insert over...&quot;);</a>
<a name="ln994">        }</a>
<a name="ln995">        public virtual void Update()</a>
<a name="ln996">        {</a>
<a name="ln997">            Person person = this.DbContext.Query&lt;Person&gt;().First();</a>
<a name="ln998"> </a>
<a name="ln999">            //lambda 更新</a>
<a name="ln1000">            this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == person.Id, a =&gt; new Person() { Name = a.Name, Age = a.Age + 1, Gender = Gender.Female, EditTime = DateTime.Now });</a>
<a name="ln1001">            /*</a>
<a name="ln1002">             * UPDATE [Person] SET [Name]=[Person].[Name],[Age]=([Person].[Age] + 1),[Gender]=1,[EditTime]=DATETIME('NOW','LOCALTIME') WHERE [Person].[Id] = 1</a>
<a name="ln1003">             */</a>
<a name="ln1004"> </a>
<a name="ln1005">            //批量更新</a>
<a name="ln1006">            //给所有女性年轻 1 岁</a>
<a name="ln1007">            this.DbContext.Update&lt;Person&gt;(a =&gt; a.Gender == Gender.Female, a =&gt; new Person() { Age = a.Age - 1, EditTime = DateTime.Now });</a>
<a name="ln1008">            /*</a>
<a name="ln1009">             * UPDATE [Person] SET [Age]=([Person].[Age] - 1),[EditTime]=DATETIME('NOW','LOCALTIME') WHERE [Person].[Gender] = 2</a>
<a name="ln1010">             */</a>
<a name="ln1011"> </a>
<a name="ln1012">            //复杂条件以及复杂 set 更新</a>
<a name="ln1013">            this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == person.Id &amp;&amp; a.Id == this.DbContext.Query&lt;City&gt;().IgnoreAllFilters().Where(city =&gt; city.Id == a.Id).First().Id, a =&gt; new Person()</a>
<a name="ln1014">            {</a>
<a name="ln1015">                Name = this.DbContext.Query&lt;City&gt;().IgnoreAllFilters().Where(city =&gt; city.Id == a.Id).First().Name</a>
<a name="ln1016">            });</a>
<a name="ln1017">            /*</a>
<a name="ln1018">             * UPDATE [Person] </a>
<a name="ln1019">               SET [Name]=(SELECT [City].[Name] AS [C] FROM [City] AS [City] WHERE [City].[Id] = [Person].[Id] LIMIT 1 OFFSET 0) </a>
<a name="ln1020">               WHERE ([Person].[Id] = 1 AND [Person].[Id] = (SELECT [City].[Id] AS [C] FROM [City] AS [City] WHERE [City].[Id] = [Person].[Id] LIMIT 1 OFFSET 0))</a>
<a name="ln1021">             */</a>
<a name="ln1022"> </a>
<a name="ln1023">            //实体更新</a>
<a name="ln1024">            person = this.DbContext.Query&lt;Person&gt;().First();</a>
<a name="ln1025">            person.Name = &quot;Chloe&quot;;</a>
<a name="ln1026">            person.Age = 28;</a>
<a name="ln1027">            person.Gender = Gender.Female;</a>
<a name="ln1028">            person.EditTime = DateTime.Now;</a>
<a name="ln1029"> </a>
<a name="ln1030">            this.DbContext.Update(person); //会更新所有映射的字段</a>
<a name="ln1031">            /*</a>
<a name="ln1032">             * Input String @P_0 = 'Chloe';</a>
<a name="ln1033">               Input Int32 @P_1 = 2;</a>
<a name="ln1034">               Input Int32 @P_2 = 28;</a>
<a name="ln1035">               Input Int32 @P_3 = 1;</a>
<a name="ln1036">               Input DateTime @P_4 = '2023/11/10 23:27:48';</a>
<a name="ln1037">               Input Int32 @P_5 = 0;</a>
<a name="ln1038">               UPDATE [Person] SET [Name]=@P_0,[Gender]=@P_1,[Age]=@P_2,[CityId]=@P_3,[EditTime]=@P_4,[RowVersion]=@P_3 WHERE ([Person].[Id] = @P_3 AND [Person].[RowVersion] = @P_5)</a>
<a name="ln1039">             */</a>
<a name="ln1040"> </a>
<a name="ln1041"> </a>
<a name="ln1042">            /*</a>
<a name="ln1043">             * 支持只更新属性值已变的属性</a>
<a name="ln1044">             */</a>
<a name="ln1045"> </a>
<a name="ln1046">            this.DbContext.TrackEntity(person);//在上下文中跟踪实体</a>
<a name="ln1047">            person.Name = person.Name + &quot;1&quot;;</a>
<a name="ln1048">            this.DbContext.Update(person);//这时只会更新被修改的字段</a>
<a name="ln1049">            /*</a>
<a name="ln1050">             * Input String @P_0 = 'Chloe1';</a>
<a name="ln1051">               Input Int32 @P_1 = 2;</a>
<a name="ln1052">               Input Int32 @P_2 = 1;</a>
<a name="ln1053">               UPDATE [Person] SET [Name]=@P_0,[RowVersion]=@P_1 WHERE ([Person].[Id] = @P_2 AND [Person].[RowVersion] = @P_2)</a>
<a name="ln1054">             */</a>
<a name="ln1055"> </a>
<a name="ln1056">            ConsoleHelper.WriteLineAndReadKey(&quot;Update over...&quot;);</a>
<a name="ln1057">        }</a>
<a name="ln1058">        public virtual void Delete()</a>
<a name="ln1059">        {</a>
<a name="ln1060">            Person person = this.DbContext.Query&lt;Person&gt;().First();</a>
<a name="ln1061"> </a>
<a name="ln1062">            this.DbContext.Delete&lt;Person&gt;(a =&gt; a.Id == person.Id);</a>
<a name="ln1063">            /*</a>
<a name="ln1064">             * DELETE FROM [Person] WHERE [Person].[Id] = 1</a>
<a name="ln1065">             */</a>
<a name="ln1066"> </a>
<a name="ln1067">            //批量删除</a>
<a name="ln1068">            //根据条件删除</a>
<a name="ln1069">            this.DbContext.Delete&lt;Person&gt;(a =&gt; a.Id &lt; 0);</a>
<a name="ln1070">            /*</a>
<a name="ln1071">             * DELETE FROM [Person] WHERE [Person].[Id] &lt; 0</a>
<a name="ln1072">             */</a>
<a name="ln1073"> </a>
<a name="ln1074"> </a>
<a name="ln1075">            //复杂条件删除</a>
<a name="ln1076">            this.DbContext.Delete&lt;Person&gt;(a =&gt; !this.DbContext.Query&lt;City&gt;().IgnoreAllFilters().Select(a =&gt; a.Id).ToList().Contains((int)a.CityId));</a>
<a name="ln1077">            /*</a>
<a name="ln1078">             * DELETE FROM [Person] WHERE NOT ([Person].[CityId] IN (SELECT [City].[Id] AS [C] FROM [City] AS [City]))</a>
<a name="ln1079">             */</a>
<a name="ln1080"> </a>
<a name="ln1081">            //实体删除</a>
<a name="ln1082">            person = this.DbContext.Query&lt;Person&gt;().First();</a>
<a name="ln1083">            this.DbContext.Delete(person);</a>
<a name="ln1084">            /*</a>
<a name="ln1085">             * Input Int32 @P_0 = 2;</a>
<a name="ln1086">               Input Int32 @P_1 = 0;</a>
<a name="ln1087">               DELETE FROM [Person] WHERE ([Person].[Id] = @P_0 AND [Person].[RowVersion] = @P_1)</a>
<a name="ln1088">             */</a>
<a name="ln1089"> </a>
<a name="ln1090">            ConsoleHelper.WriteLineAndReadKey(&quot;Delete over...&quot;);</a>
<a name="ln1091">        }</a>
<a name="ln1092"> </a>
<a name="ln1093">        /// &lt;summary&gt;</a>
<a name="ln1094">        /// 常用方法使用</a>
<a name="ln1095">        /// &lt;/summary&gt;</a>
<a name="ln1096">        public virtual void Method()</a>
<a name="ln1097">        {</a>
<a name="ln1098">            IQuery&lt;Person&gt; q = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln1099"> </a>
<a name="ln1100">            var space = new char[] { ' ' };</a>
<a name="ln1101"> </a>
<a name="ln1102">            DateTime startTime = DateTime.Now;</a>
<a name="ln1103">            DateTime endTime = DateTime.Now.AddDays(1);</a>
<a name="ln1104"> </a>
<a name="ln1105">            var ret = q.Select(a =&gt; new</a>
<a name="ln1106">            {</a>
<a name="ln1107">                Id = a.Id,</a>
<a name="ln1108"> </a>
<a name="ln1109">                String_Length = (int?)a.Name.Length,//LENGTH([Person].[Name])</a>
<a name="ln1110">                Substring = a.Name.Substring(0),//SUBSTR([Person].[Name],0 + 1)</a>
<a name="ln1111">                Substring1 = a.Name.Substring(1),//SUBSTR([Person].[Name],1 + 1)</a>
<a name="ln1112">                Substring1_2 = a.Name.Substring(1, 2),//SUBSTR([Person].[Name],1 + 1,2)</a>
<a name="ln1113">                ToLower = a.Name.ToLower(),//LOWER([Person].[Name])</a>
<a name="ln1114">                ToUpper = a.Name.ToUpper(),//UPPER([Person].[Name])</a>
<a name="ln1115">                IsNullOrEmpty = string.IsNullOrEmpty(a.Name),//CASE WHEN ([Person].[Name] IS NULL OR [Person].[Name] = '') THEN 1 ELSE 0 END = 1</a>
<a name="ln1116">                Contains = (bool?)a.Name.Contains(&quot;s&quot;),//[Person].[Name] LIKE '%' || 's' || '%'</a>
<a name="ln1117">                StartsWith = (bool?)a.Name.StartsWith(&quot;s&quot;),//[Person].[Name] LIKE 's' || '%'</a>
<a name="ln1118">                EndsWith = (bool?)a.Name.EndsWith(&quot;s&quot;),//[Person].[Name] LIKE '%' || 's'</a>
<a name="ln1119">                Trim = a.Name.Trim(),//TRIM([Person].[Name])</a>
<a name="ln1120">                TrimStart = a.Name.TrimStart(space),//LTRIM([Person].[Name])</a>
<a name="ln1121">                TrimEnd = a.Name.TrimEnd(space),//RTRIM([Person].[Name])</a>
<a name="ln1122">                Replace = a.Name.Replace(&quot;l&quot;, &quot;L&quot;),</a>
<a name="ln1123"> </a>
<a name="ln1124">                DiffYears = Sql.DiffYears(startTime, endTime),//(CAST(STRFTIME('%Y',@P_0) AS INTEGER) - CAST(STRFTIME('%Y',@P_1) AS INTEGER))</a>
<a name="ln1125">                DiffMonths = Sql.DiffMonths(startTime, endTime),//((CAST(STRFTIME('%Y',@P_0) AS INTEGER) - CAST(STRFTIME('%Y',@P_1) AS INTEGER)) * 12 + (CAST(STRFTIME('%m',@P_0) AS INTEGER) - CAST(STRFTIME('%m',@P_1) AS INTEGER)))</a>
<a name="ln1126">                DiffDays = Sql.DiffDays(startTime, endTime),//CAST((JULIANDAY(@P_0) - JULIANDAY(@P_1)) AS INTEGER)</a>
<a name="ln1127">                DiffHours = Sql.DiffHours(startTime, endTime),//CAST((JULIANDAY(@P_0) - JULIANDAY(@P_1)) * 24 AS INTEGER)</a>
<a name="ln1128">                DiffMinutes = Sql.DiffMinutes(startTime, endTime),//CAST((JULIANDAY(@P_0) - JULIANDAY(@P_1)) * 1440 AS INTEGER)</a>
<a name="ln1129">                DiffSeconds = Sql.DiffSeconds(startTime, endTime),//CAST((JULIANDAY(@P_0) - JULIANDAY(@P_1)) * 86400 AS INTEGER)</a>
<a name="ln1130">                                                                  //DiffMilliseconds = Sql.DiffMilliseconds(startTime, endTime),//不支持 Millisecond</a>
<a name="ln1131">                                                                  //DiffMicroseconds = Sql.DiffMicroseconds(startTime, endTime),//不支持 Microseconds</a>
<a name="ln1132"> </a>
<a name="ln1133">                AddYears = startTime.AddYears(1),//DATETIME(@P_0,'+' || 1 || ' years')</a>
<a name="ln1134">                AddMonths = startTime.AddMonths(1),//DATETIME(@P_0,'+' || 1 || ' months')</a>
<a name="ln1135">                AddDays = startTime.AddDays(1),//DATETIME(@P_0,'+' || 1 || ' days')</a>
<a name="ln1136">                AddHours = startTime.AddHours(1),//DATETIME(@P_0,'+' || 1 || ' hours')</a>
<a name="ln1137">                AddMinutes = startTime.AddMinutes(2),//DATETIME(@P_0,'+' || 2 || ' minutes')</a>
<a name="ln1138">                AddSeconds = startTime.AddSeconds(120),//DATETIME(@P_0,'+' || 120 || ' seconds')</a>
<a name="ln1139">                                                       //AddMilliseconds = startTime.AddMilliseconds(2000),//不支持</a>
<a name="ln1140"> </a>
<a name="ln1141">                Now = DateTime.Now,//DATETIME('NOW','LOCALTIME')</a>
<a name="ln1142">                UtcNow = DateTime.UtcNow,//DATETIME()</a>
<a name="ln1143">                Today = DateTime.Today,//DATE('NOW','LOCALTIME')</a>
<a name="ln1144">                Date = DateTime.Now.Date,//DATE('NOW','LOCALTIME')</a>
<a name="ln1145">                Year = DateTime.Now.Year,//CAST(STRFTIME('%Y',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1146">                Month = DateTime.Now.Month,//CAST(STRFTIME('%m',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1147">                Day = DateTime.Now.Day,//CAST(STRFTIME('%d',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1148">                Hour = DateTime.Now.Hour,//CAST(STRFTIME('%H',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1149">                Minute = DateTime.Now.Minute,//CAST(STRFTIME('%M',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1150">                Second = DateTime.Now.Second,//CAST(STRFTIME('%S',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1151">                Millisecond = DateTime.Now.Millisecond,//@P_2 直接计算 DateTime.Now.Millisecond 的值 </a>
<a name="ln1152">                DayOfWeek = DateTime.Now.DayOfWeek,//CAST(STRFTIME('%w',DATETIME('NOW','LOCALTIME')) AS INTEGER)</a>
<a name="ln1153"> </a>
<a name="ln1154">                Byte_Parse = byte.Parse(&quot;1&quot;),//CAST('1' AS INTEGER)</a>
<a name="ln1155">                Int_Parse = int.Parse(&quot;1&quot;),//CAST('1' AS INTEGER)</a>
<a name="ln1156">                Int16_Parse = Int16.Parse(&quot;11&quot;),//CAST('11' AS INTEGER)</a>
<a name="ln1157">                Long_Parse = long.Parse(&quot;2&quot;),//CAST('2' AS INTEGER)</a>
<a name="ln1158">                Double_Parse = double.Parse(&quot;3.1&quot;),//CAST('3.1' AS REAL)</a>
<a name="ln1159">                Float_Parse = float.Parse(&quot;4.1&quot;),//CAST('4.1' AS REAL)</a>
<a name="ln1160">                                                 //Decimal_Parse = decimal.Parse(&quot;5&quot;),//不支持</a>
<a name="ln1161">                                                 //Guid_Parse = Guid.Parse(&quot;D544BC4C-739E-4CD3-A3D3-7BF803FCE179&quot;),//不支持 'D544BC4C-739E-4CD3-A3D3-7BF803FCE179'</a>
<a name="ln1162"> </a>
<a name="ln1163">                Bool_Parse = bool.Parse(&quot;1&quot;),//CAST('1' AS INTEGER)</a>
<a name="ln1164">                DateTime_Parse = DateTime.Parse(&quot;2014-01-01&quot;),//DATETIME('2014-01-01')</a>
<a name="ln1165">                CaseWhen = Case.When(a.Id &gt; 100).Then(1).Else(0) //case when</a>
<a name="ln1166">            }).ToList();</a>
<a name="ln1167"> </a>
<a name="ln1168">            ConsoleHelper.WriteLineAndReadKey(&quot;Method over...&quot;);</a>
<a name="ln1169">        }</a>
<a name="ln1170"> </a>
<a name="ln1171">        /// &lt;summary&gt;</a>
<a name="ln1172">        /// 执行原生sql</a>
<a name="ln1173">        /// &lt;/summary&gt;</a>
<a name="ln1174">        public virtual void ExecuteCommandText()</a>
<a name="ln1175">        {</a>
<a name="ln1176">            List&lt;Person&gt; persons = this.DbContext.SqlQuery&lt;Person&gt;(&quot;select * from Person where Age &gt; @age&quot;, DbParam.Create(&quot;@age&quot;, 1)).ToList();</a>
<a name="ln1177"> </a>
<a name="ln1178">            int rowsAffected = this.DbContext.Session.ExecuteNonQuery(&quot;update Person set name=@name where Id = 1&quot;, DbParam.Create(&quot;@name&quot;, &quot;Chloe&quot;));</a>
<a name="ln1179"> </a>
<a name="ln1180">            /* </a>
<a name="ln1181">             * 执行存储过程:</a>
<a name="ln1182">             * Person person = this.DbContext.SqlQuery&lt;Person&gt;(&quot;Proc_GetPerson&quot;, CommandType.StoredProcedure, DbParam.Create(&quot;@id&quot;, 1)).FirstOrDefault();</a>
<a name="ln1183">             * rowsAffected = this.DbContext.Session.ExecuteNonQuery(&quot;Proc_UpdatePersonName&quot;, CommandType.StoredProcedure, DbParam.Create(&quot;@name&quot;, &quot;Chloe&quot;));</a>
<a name="ln1184">             */</a>
<a name="ln1185"> </a>
<a name="ln1186">            ConsoleHelper.WriteLineAndReadKey(&quot;ExecuteCommandText over...&quot;);</a>
<a name="ln1187">        }</a>
<a name="ln1188"> </a>
<a name="ln1189">        /// &lt;summary&gt;</a>
<a name="ln1190">        /// 事务</a>
<a name="ln1191">        /// &lt;/summary&gt;</a>
<a name="ln1192">        public virtual void DoWithTransaction()</a>
<a name="ln1193">        {</a>
<a name="ln1194">            /*--------------1--------------*/</a>
<a name="ln1195">            using (ITransientTransaction tran = this.DbContext.BeginTransaction())</a>
<a name="ln1196">            {</a>
<a name="ln1197">                /* do some things here */</a>
<a name="ln1198">                this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == 1, a =&gt; new Person() { Name = a.Name, Age = a.Age + 1, Gender = Gender.Male, EditTime = DateTime.Now });</a>
<a name="ln1199">                this.DbContext.Delete&lt;Person&gt;(a =&gt; a.Id == 1024);</a>
<a name="ln1200"> </a>
<a name="ln1201">                tran.Commit();</a>
<a name="ln1202">            }</a>
<a name="ln1203"> </a>
<a name="ln1204"> </a>
<a name="ln1205">            /*--------------2--------------*/</a>
<a name="ln1206">            this.DbContext.UseTransaction(() =&gt;</a>
<a name="ln1207">            {</a>
<a name="ln1208">                this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == 1, a =&gt; new Person() { Name = a.Name, Age = a.Age + 1, Gender = Gender.Male, EditTime = DateTime.Now });</a>
<a name="ln1209">                this.DbContext.Delete&lt;Person&gt;(a =&gt; a.Id == 1024);</a>
<a name="ln1210">            });</a>
<a name="ln1211"> </a>
<a name="ln1212"> </a>
<a name="ln1213">            /*--------------3--------------*/</a>
<a name="ln1214">            this.DbContext.Session.BeginTransaction();</a>
<a name="ln1215">            try</a>
<a name="ln1216">            {</a>
<a name="ln1217">                /* do some things here */</a>
<a name="ln1218">                this.DbContext.Update&lt;Person&gt;(a =&gt; a.Id == 1, a =&gt; new Person() { Name = a.Name, Age = a.Age + 1, Gender = Gender.Male, EditTime = DateTime.Now });</a>
<a name="ln1219">                this.DbContext.Delete&lt;Person&gt;(a =&gt; a.Id == 1024);</a>
<a name="ln1220"> </a>
<a name="ln1221">                this.DbContext.Session.CommitTransaction();</a>
<a name="ln1222">            }</a>
<a name="ln1223">            catch</a>
<a name="ln1224">            {</a>
<a name="ln1225">                if (this.DbContext.Session.IsInTransaction)</a>
<a name="ln1226">                    this.DbContext.Session.RollbackTransaction();</a>
<a name="ln1227">                throw;</a>
<a name="ln1228">            }</a>
<a name="ln1229"> </a>
<a name="ln1230">            ConsoleHelper.WriteLineAndReadKey(&quot;DoWithTransaction over...&quot;);</a>
<a name="ln1231">        }</a>
<a name="ln1232"> </a>
<a name="ln1233"> </a>
<a name="ln1234">        /// &lt;summary&gt;</a>
<a name="ln1235">        /// 其它测试</a>
<a name="ln1236">        /// &lt;/summary&gt;</a>
<a name="ln1237">        public virtual void OtherTest()</a>
<a name="ln1238">        {</a>
<a name="ln1239">            var personQuery = this.DbContext.Query&lt;Person&gt;();</a>
<a name="ln1240">            var cityQuery = this.DbContext.Query&lt;City&gt;();</a>
<a name="ln1241"> </a>
<a name="ln1242"> </a>
<a name="ln1243">            personQuery.OrderBy(a =&gt; a.Id).Select(a =&gt; a.CityId).Distinct().Count();</a>
<a name="ln1244">            /*</a>
<a name="ln1245">             * SELECT COUNT(1) AS `C` FROM (SELECT DISTINCT `T`.`CityId` AS `C` FROM `Person` AS `T`) AS `T0`</a>
<a name="ln1246">             * 生成的 sql 语句中的子句不包含排序字段</a>
<a name="ln1247">             */</a>
<a name="ln1248"> </a>
<a name="ln1249">            personQuery.OrderBy(a =&gt; a.Id).Select(a =&gt; new { a.Id, a.CityId }).Distinct().Count();</a>
<a name="ln1250">            /*</a>
<a name="ln1251">             * SELECT COUNT(1) AS `C` FROM (SELECT DISTINCT `T`.`Id`,`T`.`CityId` FROM `Person` AS `T` WHERE ORDER BY `T`.`Id` ASC) AS `T0`</a>
<a name="ln1252">             * 生成的 sql 语句中的子句包含排序字段</a>
<a name="ln1253">             */</a>
<a name="ln1254"> </a>
<a name="ln1255"> </a>
<a name="ln1256">            //参数在左边测试</a>
<a name="ln1257">            int cityId = cityQuery.First().Id;</a>
<a name="ln1258">            var city1 = cityQuery.Where(a =&gt; cityId == a.Id).First();</a>
<a name="ln1259">            var city2 = cityQuery.Where(a =&gt; a.Id == cityId).First();</a>
<a name="ln1260">            Debug.Assert(city1.Id == cityId);</a>
<a name="ln1261">            Debug.Assert(city1.Id == city2.Id);</a>
<a name="ln1262"> </a>
<a name="ln1263">            int? cityId1 = null;</a>
<a name="ln1264"> </a>
<a name="ln1265">            //三元表达式测试</a>
<a name="ln1266">            var result1 = personQuery.Where(a =&gt; a.CityId == (cityId1 == null ? cityId : cityId1.Value)).Select(a =&gt; new { Id = a.Id, CityId = a.CityId, Age = a.Age, B = a.Age == null ? false : a.Age &gt; 1 }).ToList();</a>
<a name="ln1267">            for (int i = 0; i &lt; result1.Count; i++)</a>
<a name="ln1268">            {</a>
<a name="ln1269">                Debug.Assert(result1[i].CityId == (cityId1 == null ? cityId : cityId1.Value));</a>
<a name="ln1270">                Debug.Assert(result1[i].B == (result1[i].Age == null ? false : result1[i].Age &gt; 1));</a>
<a name="ln1271">            }</a>
<a name="ln1272"> </a>
<a name="ln1273"> </a>
<a name="ln1274">            //二元表达式测试</a>
<a name="ln1275">            var result2 = personQuery.Where(a =&gt; a.CityId == (cityId1 ?? cityId)).Select(a =&gt; new { Id = a.Id, CityId = (cityId1 ?? cityId) }).ToList();</a>
<a name="ln1276">            var result3 = personQuery.Where(a =&gt; a.CityId == cityId).Select(a =&gt; new { Id = a.Id, CityId = cityId }).ToList();</a>
<a name="ln1277">            for (int i = 0; i &lt; result2.Count; i++)</a>
<a name="ln1278">            {</a>
<a name="ln1279">                Debug.Assert(result2[i].CityId == cityId);</a>
<a name="ln1280">                Debug.Assert(result2[i].CityId == result3[i].CityId);</a>
<a name="ln1281">                Debug.Assert(result2[i].Id == result3[i].Id);</a>
<a name="ln1282">            }</a>
<a name="ln1283"> </a>
<a name="ln1284"> </a>
<a name="ln1285">            //表达式中多层嵌套 IQuery 对象测试</a>
<a name="ln1286">            //多层嵌套中使用 First()</a>
<a name="ln1287">            this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters()</a>
<a name="ln1288">            .Where(a =&gt; this.DbContext</a>
<a name="ln1289">                        .Query&lt;City&gt;().IgnoreAllFilters()</a>
<a name="ln1290">                        .Where(c =&gt; this.DbContext</a>
<a name="ln1291">                                    .Query&lt;Province&gt;().IgnoreAllFilters()</a>
<a name="ln1292">                                    .Select(p =&gt; p.Id)</a>
<a name="ln1293">                                    .First() == c.ProvinceId</a>
<a name="ln1294">                              )</a>
<a name="ln1295">                        .Select(c =&gt; c.Id)</a>
<a name="ln1296">                        .First() == a.CityId</a>
<a name="ln1297">                  ).ToList();</a>
<a name="ln1298">            /*</a>
<a name="ln1299">             * SELECT [T].[Name],[T].[Gender],[T].[Age],[T].[CityId],[T].[CreateTime],[T].[EditTime],[T].[RowVersion],[T].[Id] </a>
<a name="ln1300">             * FROM [Person] AS [T] </a>
<a name="ln1301">             * WHERE </a>
<a name="ln1302">             * (</a>
<a name="ln1303">             *   SELECT [T0].[Id] AS [C] </a>
<a name="ln1304">             *   FROM [City] AS [T0] WHERE </a>
<a name="ln1305">             *   (</a>
<a name="ln1306">             *     SELECT [T1].[Id] AS [C] FROM [Province] AS [T1] LIMIT 1 OFFSET 0</a>
<a name="ln1307">             *   ) = [T0].[ProvinceId] LIMIT 1 OFFSET 0</a>
<a name="ln1308">             * ) = [T].[CityId]</a>
<a name="ln1309">             */</a>
<a name="ln1310"> </a>
<a name="ln1311"> </a>
<a name="ln1312">            //多层嵌套中使用 ToList().Contains() 组合</a>
<a name="ln1313">            this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters()</a>
<a name="ln1314">            .Where(a =&gt; this.DbContext</a>
<a name="ln1315">                        .Query&lt;City&gt;().IgnoreAllFilters()</a>
<a name="ln1316">                        .Where(c =&gt; this.DbContext</a>
<a name="ln1317">                                    .Query&lt;Province&gt;().IgnoreAllFilters()</a>
<a name="ln1318">                                    .Select(p =&gt; p.Id)</a>
<a name="ln1319">                                    .ToList().Contains(c.ProvinceId)</a>
<a name="ln1320">                              )</a>
<a name="ln1321">                        .Select(c =&gt; c.Id)</a>
<a name="ln1322">                        .ToList().Contains(a.CityId)</a>
<a name="ln1323">                  ).ToList();</a>
<a name="ln1324">            /*</a>
<a name="ln1325">             * SELECT [T].[Name],[T].[Gender],[T].[Age],[T].[CityId],[T].[CreateTime],[T].[EditTime],[T].[RowVersion],[T].[Id] </a>
<a name="ln1326">             * FROM [Person] AS [T] </a>
<a name="ln1327">             * WHERE [T].[CityId] IN </a>
<a name="ln1328">             * (</a>
<a name="ln1329">             *   SELECT [T0].[Id] AS [C] </a>
<a name="ln1330">             *   FROM [City] AS [T0] </a>
<a name="ln1331">             *   WHERE [T0].[ProvinceId] IN </a>
<a name="ln1332">             *   (</a>
<a name="ln1333">             *     SELECT [T1].[Id] AS [C] FROM [Province] AS [T1]</a>
<a name="ln1334">             *   )</a>
<a name="ln1335">             * )</a>
<a name="ln1336">             */</a>
<a name="ln1337"> </a>
<a name="ln1338"> </a>
<a name="ln1339">            //多层嵌套中使用 Any</a>
<a name="ln1340">            this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters()</a>
<a name="ln1341">            .Where(a =&gt; this.DbContext.Query&lt;City&gt;().IgnoreAllFilters()</a>
<a name="ln1342">                        .Where(</a>
<a name="ln1343">                                  c =&gt; c.Name == a.Name &amp;&amp; this.DbContext.Query&lt;Province&gt;().IgnoreAllFilters().Where(p =&gt; c.ProvinceId == p.Id).Any()</a>
<a name="ln1344">                              )</a>
<a name="ln1345">                        .Any()</a>
<a name="ln1346">                  ).ToList();</a>
<a name="ln1347">            /*</a>
<a name="ln1348">             * Input String @P_0 = '1';</a>
<a name="ln1349">             * SELECT [T].[Name],[T].[Gender],[T].[Age],[T].[CityId],[T].[CreateTime],[T].[EditTime],[T].[RowVersion],[T].[Id] </a>
<a name="ln1350">             * FROM [Person] AS [T] </a>
<a name="ln1351">             * WHERE Exists </a>
<a name="ln1352">             * (</a>
<a name="ln1353">             *   SELECT @P_0 AS [C] </a>
<a name="ln1354">             *   FROM [City] AS [T0] </a>
<a name="ln1355">             *   WHERE </a>
<a name="ln1356">             *   (</a>
<a name="ln1357">             *     (</a>
<a name="ln1358">             *       [T0].[Name] = [T].[Name] OR ([T0].[Name] IS NULL AND [T].[Name] IS NULL)</a>
<a name="ln1359">             *     ) </a>
<a name="ln1360">             *     AND Exists </a>
<a name="ln1361">             *     (</a>
<a name="ln1362">             *       SELECT @P_0 AS [C] FROM [Province] AS [T1] WHERE [T0].[ProvinceId] = [T1].[Id]</a>
<a name="ln1363">             *     )</a>
<a name="ln1364">             *   )</a>
<a name="ln1365">             * )</a>
<a name="ln1366">             */</a>
<a name="ln1367"> </a>
<a name="ln1368"> </a>
<a name="ln1369">            //表达式树中使用变量的形式传入 IQuery 对象【暂未支持】</a>
<a name="ln1370">            //var qq = this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters().Where(a =&gt; this.DbContext.Query&lt;Person&gt;().Where(b =&gt; b.Name == &quot;1&quot;).IgnoreAllFilters().Any());</a>
<a name="ln1371">            //this.DbContext.Query&lt;Person&gt;().Where(c =&gt; qq.Any()).IgnoreAllFilters().Count();</a>
<a name="ln1372">            /*</a>
<a name="ln1373">             * Input String ?P_0 = '1';</a>
<a name="ln1374">             * SELECT COUNT(1) AS `C` FROM `Person` AS `T` </a>
<a name="ln1375">             * WHERE Exists </a>
<a name="ln1376">             * (</a>
<a name="ln1377">             *   SELECT ?P_0 AS `C` FROM `Person` AS `T0` </a>
<a name="ln1378">             *   WHERE Exists </a>
<a name="ln1379">             *   (</a>
<a name="ln1380">             *     SELECT ?P_0 AS `C` FROM `Person` AS `T1` WHERE `T1`.`Name` = N'1'</a>
<a name="ln1381">             *   )</a>
<a name="ln1382">             * )</a>
<a name="ln1383">             */</a>
<a name="ln1384"> </a>
<a name="ln1385"> </a>
<a name="ln1386">            //表达式树中使用变量的形式将 lambda 传入表达式树中，如下中的 mm 变量</a>
<a name="ln1387">            System.Linq.Expressions.Expression&lt;Func&lt;Person, bool&gt;&gt; mm = a =&gt; this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters().Where(b =&gt; b.Name == &quot;1&quot;).Any();</a>
<a name="ln1388">            this.DbContext.Query&lt;Person&gt;().Where(c =&gt; this.DbContext.Query&lt;Person&gt;().IgnoreAllFilters().Where(mm).Any()).IgnoreAllFilters().Count();</a>
<a name="ln1389">            /*</a>
<a name="ln1390">             * Input String ?P_0 = '1';</a>
<a name="ln1391">             * SELECT COUNT(1) AS `C` FROM `Person` AS `T` </a>
<a name="ln1392">             * WHERE Exists </a>
<a name="ln1393">             * (</a>
<a name="ln1394">             *   SELECT ?P_0 AS `C` FROM `Person` AS `T0` </a>
<a name="ln1395">             *   WHERE Exists </a>
<a name="ln1396">             *   (</a>
<a name="ln1397">             *     SELECT ?P_0 AS `C` FROM `Person` AS `T1` WHERE `T1`.`Name` = N'1'</a>
<a name="ln1398">             *   )</a>
<a name="ln1399">             * )</a>
<a name="ln1400">             */</a>
<a name="ln1401"> </a>
<a name="ln1402">            ConsoleHelper.WriteLineAndReadKey(&quot;OtherTest over...&quot;);</a>
<a name="ln1403">        }</a>
<a name="ln1404">    }</a>
<a name="ln1405">}</a>
</code></pre>
<div class="balloon" rel="269"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3008/" target="_blank">V3008</a> The 'persons' variable is assigned values twice successively. Perhaps this is a mistake. Check lines: 269, 259.</p></div>
<div class="balloon" rel="15"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3068/" target="_blank">V3068</a> Calling overrideable class member 'CreateDbContext' from constructor is dangerous.</p></div>
<div class="balloon" rel="1114"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The 'a.Name' object was used before it was verified against null. Check lines: 1114, 1115.</p></div>
<div class="balloon" rel="791"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3127/" target="_blank">V3127</a> Two similar code fragments were found. Perhaps, this is a typo and 'person1' variable should be used instead of 'person2'</p></div>
<div class="balloon" rel="77"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3137/" target="_blank">V3137</a> The 'provinces' variable is assigned but is not used by the end of the function.</p></div>
<div class="balloon" rel="106"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3137/" target="_blank">V3137</a> The 'testEntities' variable is assigned but is not used by the end of the function.</p></div>
<div class="balloon" rel="581"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3137/" target="_blank">V3137</a> The 'persons' variable is assigned but is not used by the end of the function.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>