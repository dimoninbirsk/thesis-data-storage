<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>ComplexObjectModel.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">﻿using Chloe.DbExpressions;</a>
<a name="ln2">using Chloe.Descriptors;</a>
<a name="ln3">using Chloe.Exceptions;</a>
<a name="ln4">using Chloe.Extensions;</a>
<a name="ln5">using Chloe.Infrastructure;</a>
<a name="ln6">using Chloe.Query.Mapping;</a>
<a name="ln7">using Chloe.QueryExpressions;</a>
<a name="ln8">using Chloe.Reflection;</a>
<a name="ln9">using Chloe.Utility;</a>
<a name="ln10">using System.Linq.Expressions;</a>
<a name="ln11">using System.Reflection;</a>
<a name="ln12">using Chloe.Visitors;</a>
<a name="ln13"> </a>
<a name="ln14">namespace Chloe.Query</a>
<a name="ln15">{</a>
<a name="ln16">    public class ComplexObjectModel : IObjectModel</a>
<a name="ln17">    {</a>
<a name="ln18">        QueryContext _queryContext;</a>
<a name="ln19">        HashSet&lt;MemberInfo&gt; _excludedFields = null;</a>
<a name="ln20"> </a>
<a name="ln21">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, Type objectType) : this(queryContext, queryOptions, GetDefaultConstructor(objectType), 0)</a>
<a name="ln22">        {</a>
<a name="ln23">        }</a>
<a name="ln24"> </a>
<a name="ln25">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, Type objectType, int primitiveMemberCount) : this(queryContext, queryOptions, GetDefaultConstructor(objectType), primitiveMemberCount)</a>
<a name="ln26">        {</a>
<a name="ln27">        }</a>
<a name="ln28"> </a>
<a name="ln29">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, ConstructorInfo constructor) : this(queryContext, queryOptions, ConstructorDescriptor.GetInstance(constructor), 0)</a>
<a name="ln30">        {</a>
<a name="ln31">        }</a>
<a name="ln32"> </a>
<a name="ln33">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, ConstructorInfo constructor, int primitiveMemberCount) : this(queryContext, queryOptions, ConstructorDescriptor.GetInstance(constructor), primitiveMemberCount)</a>
<a name="ln34">        {</a>
<a name="ln35">        }</a>
<a name="ln36"> </a>
<a name="ln37">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, ConstructorDescriptor constructorDescriptor) : this(queryContext, queryOptions, constructorDescriptor, 0)</a>
<a name="ln38">        {</a>
<a name="ln39"> </a>
<a name="ln40">        }</a>
<a name="ln41"> </a>
<a name="ln42">        public ComplexObjectModel(QueryContext queryContext, QueryOptions queryOptions, ConstructorDescriptor constructorDescriptor, int primitiveMemberCount)</a>
<a name="ln43">        {</a>
<a name="ln44">            this._queryContext = queryContext;</a>
<a name="ln45">            this.QueryOptions = queryOptions;</a>
<a name="ln46"> </a>
<a name="ln47">            this.ObjectType = constructorDescriptor.ConstructorInfo.DeclaringType;</a>
<a name="ln48">            this.ConstructorDescriptor = constructorDescriptor;</a>
<a name="ln49">            this.PrimitiveConstructorParameters = new Dictionary&lt;ParameterInfo, DbExpression&gt;();</a>
<a name="ln50">            this.ComplexConstructorParameters = new Dictionary&lt;ParameterInfo, ComplexObjectModel&gt;();</a>
<a name="ln51">            this.PrimitiveMembers = new Dictionary&lt;MemberInfo, DbExpression&gt;(primitiveMemberCount);</a>
<a name="ln52">            this.ComplexMembers = new Dictionary&lt;MemberInfo, ComplexObjectModel&gt;();</a>
<a name="ln53">            this.CollectionMembers = new Dictionary&lt;MemberInfo, CollectionObjectModel&gt;();</a>
<a name="ln54">        }</a>
<a name="ln55"> </a>
<a name="ln56">        static ConstructorInfo GetDefaultConstructor(Type type)</a>
<a name="ln57">        {</a>
<a name="ln58">            var ret = type.GetDefaultConstructor();</a>
<a name="ln59">            if (ret == null)</a>
<a name="ln60">            {</a>
<a name="ln61">                throw new ArgumentException(string.Format(&quot;The type of '{0}' does't define a none parameter constructor.&quot;, type.FullName));</a>
<a name="ln62">            }</a>
<a name="ln63"> </a>
<a name="ln64">            return ret;</a>
<a name="ln65">        }</a>
<a name="ln66"> </a>
<a name="ln67">        public QueryOptions QueryOptions { get; private set; }</a>
<a name="ln68">        public Type ObjectType { get; private set; }</a>
<a name="ln69">        public TypeKind TypeKind { get { return TypeKind.Complex; } }</a>
<a name="ln70">        public DbExpression PrimaryKey { get; set; }</a>
<a name="ln71">        public DbExpression NullChecking { get; set; }</a>
<a name="ln72"> </a>
<a name="ln73">        /// &lt;summary&gt;</a>
<a name="ln74">        /// 当前 model 相关的 table</a>
<a name="ln75">        /// &lt;/summary&gt;</a>
<a name="ln76">        public DbMainTableExpression AssociatedTable { get; set; }</a>
<a name="ln77">        /// &lt;summary&gt;</a>
<a name="ln78">        /// 导航集合属性</a>
<a name="ln79">        /// &lt;/summary&gt;</a>
<a name="ln80">        public List&lt;NavigationNode&gt; IncludeCollections { get; set; } = new List&lt;NavigationNode&gt;();</a>
<a name="ln81">        public List&lt;DbExpression&gt; Filters { get; set; } = new List&lt;DbExpression&gt;();</a>
<a name="ln82"> </a>
<a name="ln83">        /// &lt;summary&gt;</a>
<a name="ln84">        /// 返回类型</a>
<a name="ln85">        /// &lt;/summary&gt;</a>
<a name="ln86">        public ConstructorDescriptor ConstructorDescriptor { get; private set; }</a>
<a name="ln87">        public Dictionary&lt;ParameterInfo, DbExpression&gt; PrimitiveConstructorParameters { get; private set; }</a>
<a name="ln88">        public Dictionary&lt;ParameterInfo, ComplexObjectModel&gt; ComplexConstructorParameters { get; private set; }</a>
<a name="ln89">        public Dictionary&lt;MemberInfo, DbExpression&gt; PrimitiveMembers { get; protected set; }</a>
<a name="ln90">        public Dictionary&lt;MemberInfo, ComplexObjectModel&gt; ComplexMembers { get; protected set; }</a>
<a name="ln91">        public Dictionary&lt;MemberInfo, CollectionObjectModel&gt; CollectionMembers { get; protected set; }</a>
<a name="ln92"> </a>
<a name="ln93">        /// &lt;summary&gt;</a>
<a name="ln94">        /// 在表达式树中引用到但没有 Include 的导航属性，如：query.Where(a =&gt; a.City.Name == &quot;BeiJing&quot;)，其中 City 属性没有被 Include</a>
<a name="ln95">        /// &lt;/summary&gt;</a>
<a name="ln96">        public Dictionary&lt;MemberInfo, ComplexObjectModel&gt; TouchedComplexMembers { get; protected set; } = new Dictionary&lt;MemberInfo, ComplexObjectModel&gt;();</a>
<a name="ln97"> </a>
<a name="ln98">        public void AddConstructorParameter(ParameterInfo p, DbExpression primitiveExp)</a>
<a name="ln99">        {</a>
<a name="ln100">            this.PrimitiveConstructorParameters.Add(p, primitiveExp);</a>
<a name="ln101">        }</a>
<a name="ln102">        public void AddConstructorParameter(ParameterInfo p, ComplexObjectModel complexModel)</a>
<a name="ln103">        {</a>
<a name="ln104">            this.ComplexConstructorParameters.Add(p, complexModel);</a>
<a name="ln105">        }</a>
<a name="ln106">        public void AddPrimitiveMember(MemberInfo memberInfo, DbExpression exp)</a>
<a name="ln107">        {</a>
<a name="ln108">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln109">            this.PrimitiveMembers.Add(memberInfo, exp);</a>
<a name="ln110">        }</a>
<a name="ln111"> </a>
<a name="ln112">        /// &lt;summary&gt;</a>
<a name="ln113">        /// 考虑匿名函数构造函数参数和其只读属性的对应</a>
<a name="ln114">        /// &lt;/summary&gt;</a>
<a name="ln115">        /// &lt;param name=&quot;memberInfo&quot;&gt;&lt;/param&gt;</a>
<a name="ln116">        /// &lt;returns&gt;&lt;/returns&gt;</a>
<a name="ln117">        public DbExpression GetPrimitiveMember(MemberInfo memberInfo)</a>
<a name="ln118">        {</a>
<a name="ln119">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln120">            DbExpression ret = null;</a>
<a name="ln121">            if (!this.PrimitiveMembers.TryGetValue(memberInfo, out ret))</a>
<a name="ln122">            {</a>
<a name="ln123">                ParameterInfo p = null;</a>
<a name="ln124">                if (!this.ConstructorDescriptor.MemberParameterMap.TryGetValue(memberInfo, out p))</a>
<a name="ln125">                {</a>
<a name="ln126">                    return null;</a>
<a name="ln127">                }</a>
<a name="ln128"> </a>
<a name="ln129">                if (!this.PrimitiveConstructorParameters.TryGetValue(p, out ret))</a>
<a name="ln130">                {</a>
<a name="ln131">                    return null;</a>
<a name="ln132">                }</a>
<a name="ln133">            }</a>
<a name="ln134"> </a>
<a name="ln135">            return ret;</a>
<a name="ln136">        }</a>
<a name="ln137"> </a>
<a name="ln138">        public void AddComplexMember(MemberInfo memberInfo, ComplexObjectModel model)</a>
<a name="ln139">        {</a>
<a name="ln140">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln141">            this.ComplexMembers.Add(memberInfo, model);</a>
<a name="ln142">        }</a>
<a name="ln143">        public ComplexObjectModel GetComplexMember(MemberInfo memberInfo)</a>
<a name="ln144">        {</a>
<a name="ln145">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln146">            ComplexObjectModel ret = null;</a>
<a name="ln147">            if (!this.ComplexMembers.TryGetValue(memberInfo, out ret))</a>
<a name="ln148">            {</a>
<a name="ln149">                //从构造函数中查</a>
<a name="ln150">                ParameterInfo p = null;</a>
<a name="ln151">                if (!this.ConstructorDescriptor.MemberParameterMap.TryGetValue(memberInfo, out p))</a>
<a name="ln152">                {</a>
<a name="ln153">                    return null;</a>
<a name="ln154">                }</a>
<a name="ln155"> </a>
<a name="ln156">                if (!this.ComplexConstructorParameters.TryGetValue(p, out ret))</a>
<a name="ln157">                {</a>
<a name="ln158">                    return null;</a>
<a name="ln159">                }</a>
<a name="ln160">            }</a>
<a name="ln161"> </a>
<a name="ln162">            return ret as ComplexObjectModel;</a>
<a name="ln163">        }</a>
<a name="ln164"> </a>
<a name="ln165">        public void AddCollectionMember(MemberInfo memberInfo, CollectionObjectModel model)</a>
<a name="ln166">        {</a>
<a name="ln167">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln168">            this.CollectionMembers.Add(memberInfo, model);</a>
<a name="ln169">        }</a>
<a name="ln170">        public CollectionObjectModel GetCollectionMember(MemberInfo memberInfo)</a>
<a name="ln171">        {</a>
<a name="ln172">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln173">            CollectionObjectModel ret = this.CollectionMembers.FindValue(memberInfo);</a>
<a name="ln174"> </a>
<a name="ln175">            return ret;</a>
<a name="ln176">        }</a>
<a name="ln177"> </a>
<a name="ln178">        public DbExpression GetDbExpression(MemberExpression memberExpressionDeriveFromParameter, QueryModel? queryModel)</a>
<a name="ln179">        {</a>
<a name="ln180">            Stack&lt;MemberExpression&gt; memberExpressions = ExpressionExtension.Reverse(memberExpressionDeriveFromParameter);</a>
<a name="ln181"> </a>
<a name="ln182">            DbExpression ret = null;</a>
<a name="ln183">            IObjectModel model = this;</a>
<a name="ln184">            foreach (MemberExpression memberExpression in memberExpressions)</a>
<a name="ln185">            {</a>
<a name="ln186">                MemberInfo accessedMember = memberExpression.Member;</a>
<a name="ln187"> </a>
<a name="ln188">                if (model == null &amp;&amp; ret != null)</a>
<a name="ln189">                {</a>
<a name="ln190">                    /* a.F_DateTime.Value.Date */</a>
<a name="ln191">                    ret = new DbMemberAccessExpression(accessedMember, ret);</a>
<a name="ln192">                    continue;</a>
<a name="ln193">                }</a>
<a name="ln194"> </a>
<a name="ln195">                /* **.accessedMember */</a>
<a name="ln196">                DbExpression e = model.GetPrimitiveMember(accessedMember);</a>
<a name="ln197">                if (e == null)</a>
<a name="ln198">                {</a>
<a name="ln199">                    /* Indicate current accessed member is not mapping member, then try get complex member like 'a.Order' */</a>
<a name="ln200">                    var objectModel = model.GetComplexMember(accessedMember);</a>
<a name="ln201"> </a>
<a name="ln202">                    if (objectModel != null)</a>
<a name="ln203">                    {</a>
<a name="ln204">                        model = objectModel;</a>
<a name="ln205">                        continue;</a>
<a name="ln206">                    }</a>
<a name="ln207"> </a>
<a name="ln208">                    if (ret != null)</a>
<a name="ln209">                    {</a>
<a name="ln210">                        /* Non mapping member is not found also, then convert linq MemberExpression to DbMemberExpression */</a>
<a name="ln211">                        ret = new DbMemberAccessExpression(accessedMember, ret);</a>
<a name="ln212">                        continue;</a>
<a name="ln213">                    }</a>
<a name="ln214"> </a>
<a name="ln215">                    if (model is ComplexObjectModel complexObjectModel)</a>
<a name="ln216">                    {</a>
<a name="ln217">                        //try touch</a>
<a name="ln218">                        objectModel = complexObjectModel.TryTouchComplexProperty(accessedMember, queryModel);</a>
<a name="ln219">                        if (objectModel != null)</a>
<a name="ln220">                        {</a>
<a name="ln221">                            model = objectModel;</a>
<a name="ln222">                            continue;</a>
<a name="ln223">                        }</a>
<a name="ln224">                    }</a>
<a name="ln225"> </a>
<a name="ln226">                    /*</a>
<a name="ln227">                     * If run here,the member access expression must be like 'a.xx',</a>
<a name="ln228">                     * and member 'xx' is neither mapping member nor complex member,in this case,we not supported.</a>
<a name="ln229">                     */</a>
<a name="ln230">                    throw new InvalidOperationException(memberExpressionDeriveFromParameter.ToString());</a>
<a name="ln231">                }</a>
<a name="ln232">                else</a>
<a name="ln233">                {</a>
<a name="ln234">                    if (ret != null)//Case: #110</a>
<a name="ln235">                        throw new InvalidOperationException(memberExpressionDeriveFromParameter.ToString());</a>
<a name="ln236"> </a>
<a name="ln237">                    ret = e;</a>
<a name="ln238">                    model = null;</a>
<a name="ln239">                }</a>
<a name="ln240">            }</a>
<a name="ln241"> </a>
<a name="ln242">            if (ret == null)</a>
<a name="ln243">            {</a>
<a name="ln244">                /*</a>
<a name="ln245">                 * If run here,the input argument 'memberExpressionDeriveFromParameter' expression must be like 'a.xx','a.**.xx','a.**.**.xx' ...and so on,</a>
<a name="ln246">                 * and the last accessed member 'xx' is not mapping member, in this case, we not supported too.</a>
<a name="ln247">                 */</a>
<a name="ln248">                throw new InvalidOperationException(memberExpressionDeriveFromParameter.ToString());</a>
<a name="ln249">            }</a>
<a name="ln250"> </a>
<a name="ln251">            return ret;</a>
<a name="ln252">        }</a>
<a name="ln253">        public IObjectModel GetComplexMember(MemberExpression memberExpressionDeriveParameter)</a>
<a name="ln254">        {</a>
<a name="ln255">            Stack&lt;MemberExpression&gt; memberExpressions = ExpressionExtension.Reverse(memberExpressionDeriveParameter);</a>
<a name="ln256"> </a>
<a name="ln257">            if (memberExpressions.Count == 0)</a>
<a name="ln258">                throw new Exception();</a>
<a name="ln259"> </a>
<a name="ln260">            IObjectModel ret = this;</a>
<a name="ln261">            foreach (MemberExpression memberExpression in memberExpressions)</a>
<a name="ln262">            {</a>
<a name="ln263">                MemberInfo member = memberExpression.Member;</a>
<a name="ln264"> </a>
<a name="ln265">                ret = ret.GetComplexMember(member);</a>
<a name="ln266">                if (ret == null)</a>
<a name="ln267">                {</a>
<a name="ln268">                    throw new NotSupportedException(memberExpressionDeriveParameter.ToString());</a>
<a name="ln269">                }</a>
<a name="ln270">            }</a>
<a name="ln271"> </a>
<a name="ln272">            return ret;</a>
<a name="ln273">        }</a>
<a name="ln274">        public IObjectActivatorCreator GenarateObjectActivatorCreator(List&lt;DbColumnSegment&gt; columns, HashSet&lt;string&gt; aliasSet)</a>
<a name="ln275">        {</a>
<a name="ln276">            ComplexObjectActivatorCreator activatorCreator = new ComplexObjectActivatorCreator(this.ConstructorDescriptor);</a>
<a name="ln277"> </a>
<a name="ln278">            foreach (var kv in this.PrimitiveConstructorParameters)</a>
<a name="ln279">            {</a>
<a name="ln280">                ParameterInfo pi = kv.Key;</a>
<a name="ln281">                DbExpression exp = kv.Value;</a>
<a name="ln282"> </a>
<a name="ln283">                if (this.IsExcludedMember(pi))</a>
<a name="ln284">                {</a>
<a name="ln285">                    continue;</a>
<a name="ln286">                }</a>
<a name="ln287"> </a>
<a name="ln288">                int ordinal = ObjectModelHelper.AddColumn(columns, aliasSet, exp, pi.Name);</a>
<a name="ln289"> </a>
<a name="ln290">                if (exp == this.NullChecking)</a>
<a name="ln291">                    activatorCreator.CheckNullOrdinal = ordinal;</a>
<a name="ln292"> </a>
<a name="ln293">                activatorCreator.ConstructorParameters.Add(pi, ordinal);</a>
<a name="ln294">            }</a>
<a name="ln295"> </a>
<a name="ln296">            foreach (var kv in this.ComplexConstructorParameters)</a>
<a name="ln297">            {</a>
<a name="ln298">                ParameterInfo pi = kv.Key;</a>
<a name="ln299">                IObjectModel val = kv.Value;</a>
<a name="ln300"> </a>
<a name="ln301">                IObjectActivatorCreator complexMappingMember = val.GenarateObjectActivatorCreator(columns, aliasSet);</a>
<a name="ln302">                activatorCreator.ConstructorComplexParameters.Add(pi, complexMappingMember);</a>
<a name="ln303">            }</a>
<a name="ln304"> </a>
<a name="ln305">            foreach (var kv in this.PrimitiveMembers)</a>
<a name="ln306">            {</a>
<a name="ln307">                MemberInfo member = kv.Key;</a>
<a name="ln308">                DbExpression exp = kv.Value;</a>
<a name="ln309"> </a>
<a name="ln310">                if (this.IsExcludedMember(member))</a>
<a name="ln311">                {</a>
<a name="ln312">                    continue;</a>
<a name="ln313">                }</a>
<a name="ln314"> </a>
<a name="ln315">                int ordinal = ObjectModelHelper.AddColumn(columns, aliasSet, exp, member.Name);</a>
<a name="ln316"> </a>
<a name="ln317">                if (exp == this.NullChecking)</a>
<a name="ln318">                    activatorCreator.CheckNullOrdinal = ordinal;</a>
<a name="ln319"> </a>
<a name="ln320">                activatorCreator.PrimitiveMembers.Add(member, ordinal);</a>
<a name="ln321">            }</a>
<a name="ln322"> </a>
<a name="ln323">            foreach (var kv in this.ComplexMembers)</a>
<a name="ln324">            {</a>
<a name="ln325">                IObjectActivatorCreator complexMemberActivatorCreator = kv.Value.GenarateObjectActivatorCreator(columns, aliasSet);</a>
<a name="ln326">                activatorCreator.ComplexMembers.Add(kv.Key, complexMemberActivatorCreator);</a>
<a name="ln327">            }</a>
<a name="ln328"> </a>
<a name="ln329">            foreach (var kv in this.CollectionMembers)</a>
<a name="ln330">            {</a>
<a name="ln331">                IObjectActivatorCreator collectionMemberActivatorCreator = kv.Value.GenarateObjectActivatorCreator(columns, aliasSet);</a>
<a name="ln332">                activatorCreator.CollectionMembers.Add(kv.Key, collectionMemberActivatorCreator);</a>
<a name="ln333">            }</a>
<a name="ln334"> </a>
<a name="ln335">            if (this.NullChecking != null &amp;&amp; activatorCreator.CheckNullOrdinal == null)</a>
<a name="ln336">                activatorCreator.CheckNullOrdinal = ObjectModelHelper.AddColumn(columns, aliasSet, this.NullChecking);</a>
<a name="ln337"> </a>
<a name="ln338">            return activatorCreator;</a>
<a name="ln339">        }</a>
<a name="ln340"> </a>
<a name="ln341">        public IObjectModel ToNewObjectModel(List&lt;DbColumnSegment&gt; columns, HashSet&lt;string&gt; aliasSet, DbTable table, DbMainTableExpression dependentTable)</a>
<a name="ln342">        {</a>
<a name="ln343">            ComplexObjectModel newModel = new ComplexObjectModel(this._queryContext, this.QueryOptions, this.ConstructorDescriptor, this.PrimitiveMembers.Count);</a>
<a name="ln344">            newModel.AssociatedTable = dependentTable;</a>
<a name="ln345">            newModel.IncludeCollections.AppendRange(this.IncludeCollections);</a>
<a name="ln346"> </a>
<a name="ln347">            if (!this.QueryOptions.IgnoreFilters)</a>
<a name="ln348">            {</a>
<a name="ln349">                this.SetupFilters();</a>
<a name="ln350">            }</a>
<a name="ln351"> </a>
<a name="ln352">            foreach (var kv in this.PrimitiveConstructorParameters)</a>
<a name="ln353">            {</a>
<a name="ln354">                ParameterInfo pi = kv.Key;</a>
<a name="ln355">                DbExpression exp = kv.Value;</a>
<a name="ln356"> </a>
<a name="ln357">                if (this.IsExcludedMember(pi))</a>
<a name="ln358">                {</a>
<a name="ln359">                    continue;</a>
<a name="ln360">                }</a>
<a name="ln361"> </a>
<a name="ln362">                DbColumnAccessExpression cae = null;</a>
<a name="ln363">                cae = ObjectModelHelper.ParseColumnAccessExpression(columns, aliasSet, table, exp, pi.Name);</a>
<a name="ln364"> </a>
<a name="ln365">                newModel.AddConstructorParameter(pi, cae);</a>
<a name="ln366">            }</a>
<a name="ln367"> </a>
<a name="ln368">            foreach (var kv in this.ComplexConstructorParameters)</a>
<a name="ln369">            {</a>
<a name="ln370">                ParameterInfo pi = kv.Key;</a>
<a name="ln371">                IObjectModel val = kv.Value;</a>
<a name="ln372"> </a>
<a name="ln373">                ComplexObjectModel complexMemberModel = val.ToNewObjectModel(columns, aliasSet, table, dependentTable) as ComplexObjectModel;</a>
<a name="ln374">                newModel.AddConstructorParameter(pi, complexMemberModel);</a>
<a name="ln375">            }</a>
<a name="ln376"> </a>
<a name="ln377">            foreach (var kv in this.PrimitiveMembers)</a>
<a name="ln378">            {</a>
<a name="ln379">                MemberInfo member = kv.Key;</a>
<a name="ln380">                DbExpression exp = kv.Value;</a>
<a name="ln381"> </a>
<a name="ln382">                if (this.IsExcludedMember(member))</a>
<a name="ln383">                {</a>
<a name="ln384">                    continue;</a>
<a name="ln385">                }</a>
<a name="ln386"> </a>
<a name="ln387">                DbColumnAccessExpression cae = ObjectModelHelper.ParseColumnAccessExpression(columns, aliasSet, table, exp, member.Name);</a>
<a name="ln388"> </a>
<a name="ln389">                newModel.AddPrimitiveMember(member, cae);</a>
<a name="ln390"> </a>
<a name="ln391">                if (exp == this.PrimaryKey)</a>
<a name="ln392">                {</a>
<a name="ln393">                    newModel.PrimaryKey = cae;</a>
<a name="ln394">                    if (this.NullChecking == this.PrimaryKey)</a>
<a name="ln395">                        newModel.NullChecking = cae;</a>
<a name="ln396">                }</a>
<a name="ln397">            }</a>
<a name="ln398"> </a>
<a name="ln399">            foreach (var kv in this.ComplexMembers)</a>
<a name="ln400">            {</a>
<a name="ln401">                MemberInfo member = kv.Key;</a>
<a name="ln402">                IObjectModel val = kv.Value;</a>
<a name="ln403"> </a>
<a name="ln404">                ComplexObjectModel complexMemberModel = val.ToNewObjectModel(columns, aliasSet, table, dependentTable) as ComplexObjectModel;</a>
<a name="ln405">                newModel.AddComplexMember(member, complexMemberModel);</a>
<a name="ln406">            }</a>
<a name="ln407"> </a>
<a name="ln408">            if (this.NullChecking != null &amp;&amp; newModel.NullChecking == null)</a>
<a name="ln409">                newModel.NullChecking = ObjectModelHelper.AddNullCheckingColumn(columns, aliasSet, table, this.NullChecking);</a>
<a name="ln410"> </a>
<a name="ln411">            return newModel;</a>
<a name="ln412">        }</a>
<a name="ln413"> </a>
<a name="ln414">        public void Include(NavigationNode navigationNode, QueryModel queryModel, bool handleCollection)</a>
<a name="ln415">        {</a>
<a name="ln416">            TypeDescriptor descriptor = EntityTypeContainer.GetDescriptor(this.ObjectType);</a>
<a name="ln417">            PropertyDescriptor navigationDescriptor = descriptor.GetPropertyDescriptor(navigationNode.Property);</a>
<a name="ln418"> </a>
<a name="ln419">            if (navigationDescriptor.Definition.Kind == TypeKind.Primitive)</a>
<a name="ln420">            {</a>
<a name="ln421">                throw new NotSupportedException($&quot;'{navigationNode.Property.Name}' is not navigation property.&quot;);</a>
<a name="ln422">            }</a>
<a name="ln423"> </a>
<a name="ln424">            ComplexObjectModel objectModel = null;</a>
<a name="ln425">            if (navigationDescriptor.Definition.Kind == TypeKind.Complex)</a>
<a name="ln426">            {</a>
<a name="ln427">                objectModel = this.GetComplexMember(navigationNode.Property);</a>
<a name="ln428"> </a>
<a name="ln429">                if (objectModel == null)</a>
<a name="ln430">                {</a>
<a name="ln431">                    //从 Touched 集合里拿</a>
<a name="ln432">                    objectModel = this.TouchedComplexMembers.FindValue(navigationNode.Property);</a>
<a name="ln433"> </a>
<a name="ln434">                    if (objectModel == null)</a>
<a name="ln435">                    {</a>
<a name="ln436">                        objectModel = this.GenComplexObjectModel(navigationDescriptor as ComplexPropertyDescriptor, navigationNode, queryModel);</a>
<a name="ln437">                    }</a>
<a name="ln438">                    else</a>
<a name="ln439">                    {</a>
<a name="ln440">                        //如果在先 touched 后 Include 导航属性会运行到这里，如：query.Where(a =&gt; a.City.Name == &quot;BeiJing&quot;).Include(a =&gt; a.City)</a>
<a name="ln441">                        //替换 touched 解析的 filters。因为计算 QueryPlan 时计算键 hash 时是没有包含 touched 时候的解析的源 ContextFilters 和 GlobalFilters，防止 ContextFilters 和 GlobalFilters 有动态修改导致缓存的 QueryPlan 与实际运行结果不一致</a>
<a name="ln442">                        objectModel.Filters.Clear();</a>
<a name="ln443">                        objectModel.Filters.AddRange(navigationNode.ContextFilters.Concat(navigationNode.GlobalFilters).Select(a =&gt; this.ParseCondition(a, objectModel, queryModel.ScopeTables, queryModel)));</a>
<a name="ln444">                        this.TouchedComplexMembers.Remove(navigationNode.Property);</a>
<a name="ln445">                        queryModel.TouchedTables.Remove(objectModel.AssociatedTable); // 此时 touched table 已经被 include 了，不是 touched table，需要从 TouchedTables 中移除</a>
<a name="ln446">                    }</a>
<a name="ln447"> </a>
<a name="ln448">                    this.AddComplexMember(navigationNode.Property, objectModel);</a>
<a name="ln449">                }</a>
<a name="ln450">            }</a>
<a name="ln451">            else</a>
<a name="ln452">            {</a>
<a name="ln453">                if (!handleCollection)</a>
<a name="ln454">                {</a>
<a name="ln455">                    this.IncludeCollections.Add(navigationNode);</a>
<a name="ln456">                    return;</a>
<a name="ln457">                }</a>
<a name="ln458"> </a>
<a name="ln459">                CollectionObjectModel collectionModel = this.GetCollectionMember(navigationNode.Property);</a>
<a name="ln460">                if (collectionModel == null)</a>
<a name="ln461">                {</a>
<a name="ln462">                    Type collectionType = navigationDescriptor.PropertyType;</a>
<a name="ln463">                    TypeDescriptor elementTypeDescriptor = EntityTypeContainer.GetDescriptor(collectionType.GetGenericArguments()[0]);</a>
<a name="ln464">                    ComplexObjectModel elementModel = this.GenCollectionElementObjectModel(elementTypeDescriptor, navigationNode, queryModel);</a>
<a name="ln465">                    collectionModel = new CollectionObjectModel(this.QueryOptions, this.ObjectType, navigationNode.Property, elementModel);</a>
<a name="ln466">                    this.AddCollectionMember(navigationNode.Property, collectionModel);</a>
<a name="ln467">                }</a>
<a name="ln468">                else</a>
<a name="ln469">                {</a>
<a name="ln470">                    DbExpression condition = this.ParseCondition(navigationNode.Condition, collectionModel.ElementModel, queryModel.ScopeTables, queryModel);</a>
<a name="ln471"> </a>
<a name="ln472">                    var joinTable = collectionModel.ElementModel.AssociatedTable as DbJoinTableExpression;</a>
<a name="ln473">                    joinTable.AppendCondition(condition);</a>
<a name="ln474">                }</a>
<a name="ln475"> </a>
<a name="ln476">                objectModel = collectionModel.ElementModel;</a>
<a name="ln477">            }</a>
<a name="ln478"> </a>
<a name="ln479">            for (int i = 0; i &lt; navigationNode.ExcludedFields.Count; i++)</a>
<a name="ln480">            {</a>
<a name="ln481">                List&lt;LinkedNode&lt;MemberInfo&gt;&gt; fields = ExcludeFieldExtractor.Extract(navigationNode.ExcludedFields[i]);</a>
<a name="ln482">                objectModel.ExcludePrimitiveMembers(fields);</a>
<a name="ln483">            }</a>
<a name="ln484"> </a>
<a name="ln485">            if (navigationNode.Next != null)</a>
<a name="ln486">            {</a>
<a name="ln487">                objectModel.Include(navigationNode.Next, queryModel, handleCollection);</a>
<a name="ln488">            }</a>
<a name="ln489">        }</a>
<a name="ln490">        public void SetupCollection(QueryModel queryModel)</a>
<a name="ln491">        {</a>
<a name="ln492">            for (int i = 0; i &lt; this.IncludeCollections.Count; i++)</a>
<a name="ln493">            {</a>
<a name="ln494">                NavigationNode navigationNode = this.IncludeCollections[i];</a>
<a name="ln495">                this.Include(navigationNode, queryModel, true);</a>
<a name="ln496">            }</a>
<a name="ln497"> </a>
<a name="ln498">            foreach (var kv in this.ComplexMembers)</a>
<a name="ln499">            {</a>
<a name="ln500">                var memberObjectModel = kv.Value as ComplexObjectModel;</a>
<a name="ln501">                memberObjectModel.SetupCollection(queryModel);</a>
<a name="ln502">            }</a>
<a name="ln503">        }</a>
<a name="ln504">        public void SetupFilters(bool ignoreFilters)</a>
<a name="ln505">        {</a>
<a name="ln506">            if (ignoreFilters)</a>
<a name="ln507">                return;</a>
<a name="ln508"> </a>
<a name="ln509">            this.SetupFilters();</a>
<a name="ln510"> </a>
<a name="ln511">            foreach (var kv in this.ComplexConstructorParameters)</a>
<a name="ln512">            {</a>
<a name="ln513">                kv.Value.SetupFilters(ignoreFilters);</a>
<a name="ln514">            }</a>
<a name="ln515"> </a>
<a name="ln516">            foreach (var kv in this.ComplexMembers)</a>
<a name="ln517">            {</a>
<a name="ln518">                kv.Value.SetupFilters(ignoreFilters);</a>
<a name="ln519">            }</a>
<a name="ln520"> </a>
<a name="ln521">            foreach (var kv in this.CollectionMembers)</a>
<a name="ln522">            {</a>
<a name="ln523">                kv.Value.ElementModel.SetupFilters(ignoreFilters);</a>
<a name="ln524">            }</a>
<a name="ln525"> </a>
<a name="ln526">            foreach (var kv in this.TouchedComplexMembers)</a>
<a name="ln527">            {</a>
<a name="ln528">                kv.Value.SetupFilters(ignoreFilters);</a>
<a name="ln529">            }</a>
<a name="ln530">        }</a>
<a name="ln531"> </a>
<a name="ln532">        public bool HasMany()</a>
<a name="ln533">        {</a>
<a name="ln534">            if (this.IncludeCollections.Count &gt; 0)</a>
<a name="ln535">                return true;</a>
<a name="ln536"> </a>
<a name="ln537">            foreach (var kv in this.ComplexMembers)</a>
<a name="ln538">            {</a>
<a name="ln539">                var memberObjectModel = kv.Value as ComplexObjectModel;</a>
<a name="ln540">                if (memberObjectModel.HasMany())</a>
<a name="ln541">                {</a>
<a name="ln542">                    return true;</a>
<a name="ln543">                }</a>
<a name="ln544">            }</a>
<a name="ln545"> </a>
<a name="ln546">            return false;</a>
<a name="ln547">        }</a>
<a name="ln548"> </a>
<a name="ln549">        public void ExcludePrimitiveMember(LinkedNode&lt;MemberInfo&gt; memberLink)</a>
<a name="ln550">        {</a>
<a name="ln551">            MemberInfo memberInfo = memberLink.Value;</a>
<a name="ln552">            memberInfo = memberInfo.AsReflectedMemberOf(this.ObjectType);</a>
<a name="ln553"> </a>
<a name="ln554">            if (this.GetPrimitiveMember(memberInfo) != null)</a>
<a name="ln555">            {</a>
<a name="ln556">                if (memberLink.Next != null)</a>
<a name="ln557">                {</a>
<a name="ln558">                    //a.Name.Length, a.Age.Value ....</a>
<a name="ln559">                    throw new NotSupportedException($&quot;Not support exclude field '{memberLink.Value.Name}.{memberLink.Next.Value.Name}'.&quot;);</a>
<a name="ln560">                }</a>
<a name="ln561"> </a>
<a name="ln562">                if (this._excludedFields == null)</a>
<a name="ln563">                    this._excludedFields = new HashSet&lt;MemberInfo&gt;();</a>
<a name="ln564"> </a>
<a name="ln565">                this._excludedFields.Add(memberInfo);</a>
<a name="ln566">                return;</a>
<a name="ln567">            }</a>
<a name="ln568"> </a>
<a name="ln569">            if (memberLink.Next == null)</a>
<a name="ln570">            {</a>
<a name="ln571">                throw new NotSupportedException($&quot;Not support exclude field '{memberLink.Value.Name}'.&quot;);</a>
<a name="ln572">            }</a>
<a name="ln573"> </a>
<a name="ln574">            ComplexObjectModel complexMemberObjectModel = this.ComplexMembers.FindValue(memberInfo);</a>
<a name="ln575">            if (complexMemberObjectModel != null)</a>
<a name="ln576">            {</a>
<a name="ln577">                //a.City.Name</a>
<a name="ln578">                complexMemberObjectModel.ExcludePrimitiveMember(memberLink.Next);</a>
<a name="ln579">                return;</a>
<a name="ln580">            }</a>
<a name="ln581"> </a>
<a name="ln582">            if (memberInfo.DeclaringType == this.ObjectType &amp;&amp; this.ObjectType.IsAnonymousType())</a>
<a name="ln583">            {</a>
<a name="ln584">                //(person, city) =&gt; new { Person = person, City = city }</a>
<a name="ln585">                ComplexObjectModel complexConstructorParameterObjectModel = this.ComplexConstructorParameters.Where(a =&gt; a.Key.Name == memberInfo.Name).Select(a =&gt; a.Value).FirstOrDefault();</a>
<a name="ln586">                if (complexConstructorParameterObjectModel != null)</a>
<a name="ln587">                {</a>
<a name="ln588">                    //a.Person.Name</a>
<a name="ln589">                    complexConstructorParameterObjectModel.ExcludePrimitiveMember(memberLink.Next);</a>
<a name="ln590">                    return;</a>
<a name="ln591">                }</a>
<a name="ln592">            }</a>
<a name="ln593"> </a>
<a name="ln594">            throw new NotSupportedException($&quot;Not support exclude field '{memberLink.Value.Name}'.&quot;);</a>
<a name="ln595">        }</a>
<a name="ln596">        public void ExcludePrimitiveMembers(IEnumerable&lt;LinkedNode&lt;MemberInfo&gt;&gt; memberLinks)</a>
<a name="ln597">        {</a>
<a name="ln598">            foreach (var memberLink in memberLinks)</a>
<a name="ln599">            {</a>
<a name="ln600">                this.ExcludePrimitiveMember(memberLink);</a>
<a name="ln601">            }</a>
<a name="ln602">        }</a>
<a name="ln603">        bool IsExcludedMember(MemberInfo memberInfo)</a>
<a name="ln604">        {</a>
<a name="ln605">            if (this._excludedFields == null)</a>
<a name="ln606">                return false;</a>
<a name="ln607"> </a>
<a name="ln608">            return this._excludedFields.Contains(memberInfo);</a>
<a name="ln609">        }</a>
<a name="ln610">        bool IsExcludedMember(ParameterInfo parameterInfo)</a>
<a name="ln611">        {</a>
<a name="ln612">            foreach (var map in this.ConstructorDescriptor.MemberParameterMap)</a>
<a name="ln613">            {</a>
<a name="ln614">                if (map.Value != parameterInfo) continue;</a>
<a name="ln615">                return IsExcludedMember(map.Key);</a>
<a name="ln616">            }</a>
<a name="ln617">            return false;</a>
<a name="ln618">        }</a>
<a name="ln619"> </a>
<a name="ln620">        public ComplexObjectModel TryTouchComplexProperty(MemberInfo property, QueryModel queryModel)</a>
<a name="ln621">        {</a>
<a name="ln622">            //从 Touched 集合里拿</a>
<a name="ln623">            ComplexObjectModel objectModel = this.TouchedComplexMembers.FindValue(property);</a>
<a name="ln624"> </a>
<a name="ln625">            if (objectModel != null)</a>
<a name="ln626">                return objectModel;</a>
<a name="ln627"> </a>
<a name="ln628">            if (queryModel == null)</a>
<a name="ln629">                return null;</a>
<a name="ln630"> </a>
<a name="ln631">            //创建并放到 TouchedComplexMembers 集合中</a>
<a name="ln632">            TypeDescriptor descriptor = EntityTypeContainer.GetDescriptor(this.ObjectType);</a>
<a name="ln633">            PropertyDescriptor navigationDescriptor = descriptor.GetPropertyDescriptor(property);</a>
<a name="ln634">            if (navigationDescriptor.Definition.Kind != TypeKind.Complex)</a>
<a name="ln635">            {</a>
<a name="ln636">                return null;</a>
<a name="ln637">            }</a>
<a name="ln638"> </a>
<a name="ln639">            //注：这里获取的 filters 未参与 QueryPlan 的存储键计算，所以，如果存在 Touched 的情况，不能缓存生成的 QueryPlan</a>
<a name="ln640">            List&lt;LambdaExpression&gt; globalFilters = EntityTypeContainer.GetDescriptor(navigationDescriptor.PropertyType).Definition.Filters.ToList();</a>
<a name="ln641">            List&lt;LambdaExpression&gt; contextFilters = this._queryContext.DbContextProvider.GetQueryFilters(navigationDescriptor.PropertyType);</a>
<a name="ln642"> </a>
<a name="ln643">            objectModel = this.GenComplexObjectModel(navigationDescriptor as ComplexPropertyDescriptor, globalFilters, contextFilters, queryModel);</a>
<a name="ln644">            queryModel.TouchedTables.Add(objectModel.AssociatedTable); //将 touched table 记录</a>
<a name="ln645">            this.TouchedComplexMembers.Add(property, objectModel);</a>
<a name="ln646">            return objectModel;</a>
<a name="ln647">        }</a>
<a name="ln648">        ComplexObjectModel GenComplexObjectModel(ComplexPropertyDescriptor navigationDescriptor, NavigationNode navigationNode, QueryModel queryModel)</a>
<a name="ln649">        {</a>
<a name="ln650">            return this.GenComplexObjectModel(navigationDescriptor, navigationNode.GlobalFilters, navigationNode.ContextFilters, queryModel);</a>
<a name="ln651">        }</a>
<a name="ln652">        ComplexObjectModel GenComplexObjectModel(ComplexPropertyDescriptor navigationDescriptor, List&lt;LambdaExpression&gt; globalFilters, List&lt;LambdaExpression&gt; contextFilters, QueryModel queryModel)</a>
<a name="ln653">        {</a>
<a name="ln654">            TypeDescriptor navigationTypeDescriptor = EntityTypeContainer.GetDescriptor(navigationDescriptor.PropertyType);</a>
<a name="ln655"> </a>
<a name="ln656">            DbTable dbTable = navigationTypeDescriptor.Table;</a>
<a name="ln657">            DbTableExpression tableExp = new DbTableExpression(dbTable);</a>
<a name="ln658">            string alias = queryModel.GenerateUniqueTableAlias();</a>
<a name="ln659">            DbTableSegment joinTableSeg = new DbTableSegment(tableExp, alias, queryModel.FromTable.Table.Lock);</a>
<a name="ln660"> </a>
<a name="ln661">            ComplexObjectModel navigationObjectModel = navigationTypeDescriptor.GenObjectModel(alias, this._queryContext, queryModel.Options);</a>
<a name="ln662">            navigationObjectModel.NullChecking = navigationObjectModel.PrimaryKey;</a>
<a name="ln663"> </a>
<a name="ln664">            PrimitivePropertyDescriptor foreignKeyPropertyDescriptor = navigationDescriptor.ForeignKeyProperty;</a>
<a name="ln665">            DbExpression foreignKeyColumn = this.GetPrimitiveMember(foreignKeyPropertyDescriptor.Property);</a>
<a name="ln666">            DbExpression joinCondition = new DbEqualExpression(foreignKeyColumn, navigationObjectModel.PrimaryKey);</a>
<a name="ln667"> </a>
<a name="ln668">            DbJoinType joinType = DbJoinType.LeftJoin;</a>
<a name="ln669">            if (!foreignKeyPropertyDescriptor.IsNullable)</a>
<a name="ln670">            {</a>
<a name="ln671">                //如果外键是不可空类型，在满足一定条件下使用 InnerJoin 连接</a>
<a name="ln672">                if (this.AssociatedTable is DbFromTableExpression)</a>
<a name="ln673">                {</a>
<a name="ln674">                    joinType = DbJoinType.InnerJoin;</a>
<a name="ln675">                }</a>
<a name="ln676">                else</a>
<a name="ln677">                {</a>
<a name="ln678">                    DbJoinTableExpression prevJoinTable = (DbJoinTableExpression)this.AssociatedTable;</a>
<a name="ln679">                    //前一个表是 inner join，才能用 inner join，否则有可能查不出数据</a>
<a name="ln680">                    if (prevJoinTable.JoinType == DbJoinType.InnerJoin)</a>
<a name="ln681">                    {</a>
<a name="ln682">                        joinType = DbJoinType.InnerJoin;</a>
<a name="ln683">                    }</a>
<a name="ln684">                }</a>
<a name="ln685">            }</a>
<a name="ln686"> </a>
<a name="ln687">            DbJoinTableExpression joinTableExp = new DbJoinTableExpression(joinType, joinTableSeg, joinCondition);</a>
<a name="ln688">            joinTableExp.AppendTo(this.AssociatedTable);</a>
<a name="ln689"> </a>
<a name="ln690">            navigationObjectModel.AssociatedTable = joinTableExp;</a>
<a name="ln691"> </a>
<a name="ln692">            navigationObjectModel.Filters.AddRange(contextFilters.Concat(globalFilters).Select(a =&gt; this.ParseCondition(a, navigationObjectModel, queryModel.ScopeTables, queryModel)));</a>
<a name="ln693"> </a>
<a name="ln694">            return navigationObjectModel;</a>
<a name="ln695">        }</a>
<a name="ln696">        ComplexObjectModel GenCollectionElementObjectModel(TypeDescriptor elementTypeDescriptor, NavigationNode navigationNode, QueryModel queryModel)</a>
<a name="ln697">        {</a>
<a name="ln698">            DbTable dbTable = elementTypeDescriptor.Table;</a>
<a name="ln699">            DbTableExpression tableExp = new DbTableExpression(dbTable);</a>
<a name="ln700">            string alias = queryModel.GenerateUniqueTableAlias();</a>
<a name="ln701">            DbTableSegment joinTableSeg = new DbTableSegment(tableExp, alias, queryModel.FromTable.Table.Lock);</a>
<a name="ln702"> </a>
<a name="ln703">            ComplexObjectModel elementObjectModel = elementTypeDescriptor.GenObjectModel(alias, this._queryContext, queryModel.Options);</a>
<a name="ln704">            elementObjectModel.NullChecking = elementObjectModel.PrimaryKey;</a>
<a name="ln705"> </a>
<a name="ln706">            ComplexPropertyDescriptor navigationDescriptor = elementTypeDescriptor.ComplexPropertyDescriptors.Where(a =&gt; a.PropertyType == this.ObjectType).FirstOrDefault();</a>
<a name="ln707"> </a>
<a name="ln708">            if (navigationDescriptor == null)</a>
<a name="ln709">            {</a>
<a name="ln710">                throw new ChloeException($&quot;You have to define a navigation property which type is '{this.ObjectType.FullName}' on class '{elementTypeDescriptor.Definition.Type.FullName}'.&quot;);</a>
<a name="ln711">            }</a>
<a name="ln712"> </a>
<a name="ln713">            DbExpression elementForeignKeyColumn = elementObjectModel.GetPrimitiveMember(navigationDescriptor.ForeignKeyProperty.Property);</a>
<a name="ln714">            DbExpression joinCondition = new DbEqualExpression(this.PrimaryKey, elementForeignKeyColumn);</a>
<a name="ln715">            DbJoinTableExpression joinTableExp = new DbJoinTableExpression(DbJoinType.LeftJoin, joinTableSeg, joinCondition);</a>
<a name="ln716">            joinTableExp.AppendTo(this.AssociatedTable);</a>
<a name="ln717"> </a>
<a name="ln718">            elementObjectModel.AssociatedTable = joinTableExp;</a>
<a name="ln719">            var condition = this.ParseCondition(navigationNode.Condition, elementObjectModel, queryModel.ScopeTables, queryModel);</a>
<a name="ln720">            //Filter 的条件放到 join 条件里去</a>
<a name="ln721">            joinTableExp.AppendCondition(condition);</a>
<a name="ln722"> </a>
<a name="ln723">            elementObjectModel.Filters.AddRange(navigationNode.ContextFilters.Concat(navigationNode.GlobalFilters).Select(a =&gt; this.ParseCondition(a, elementObjectModel, queryModel.ScopeTables, queryModel)));</a>
<a name="ln724"> </a>
<a name="ln725">            bool orderByPrimaryKeyExists = queryModel.Orderings.Where(a =&gt; a.Expression == this.PrimaryKey).Any();</a>
<a name="ln726">            if (!orderByPrimaryKeyExists)</a>
<a name="ln727">            {</a>
<a name="ln728">                //结果集分组</a>
<a name="ln729">                DbOrdering ordering = new DbOrdering(this.PrimaryKey, DbOrderType.Asc);</a>
<a name="ln730">                queryModel.Orderings.Add(ordering);</a>
<a name="ln731">            }</a>
<a name="ln732"> </a>
<a name="ln733">            return elementObjectModel;</a>
<a name="ln734">        }</a>
<a name="ln735"> </a>
<a name="ln736">        public void SetNullChecking(DbExpression exp)</a>
<a name="ln737">        {</a>
<a name="ln738">            if (this.NullChecking == null)</a>
<a name="ln739">            {</a>
<a name="ln740">                if (this.PrimaryKey != null)</a>
<a name="ln741">                    this.NullChecking = this.PrimaryKey;</a>
<a name="ln742">                else</a>
<a name="ln743">                    this.NullChecking = exp;</a>
<a name="ln744">            }</a>
<a name="ln745"> </a>
<a name="ln746">            foreach (var item in this.ComplexConstructorParameters.Values)</a>
<a name="ln747">            {</a>
<a name="ln748">                item.SetNullChecking(exp);</a>
<a name="ln749">            }</a>
<a name="ln750"> </a>
<a name="ln751">            foreach (var item in this.ComplexMembers.Values)</a>
<a name="ln752">            {</a>
<a name="ln753">                item.SetNullChecking(exp);</a>
<a name="ln754">            }</a>
<a name="ln755">        }</a>
<a name="ln756"> </a>
<a name="ln757">        DbExpression ParseCondition(LambdaExpression condition, ComplexObjectModel objectModel, StringSet scopeTables, QueryModel? queryModel)</a>
<a name="ln758">        {</a>
<a name="ln759">            if (condition == null)</a>
<a name="ln760">                return null;</a>
<a name="ln761"> </a>
<a name="ln762">            return FilterPredicateParser.Parse(this._queryContext, condition, new ScopeParameterDictionary(1) { { condition.Parameters[0], objectModel } }, scopeTables, queryModel);</a>
<a name="ln763">        }</a>
<a name="ln764">        void SetupFilters()</a>
<a name="ln765">        {</a>
<a name="ln766">            DbJoinTableExpression joinTableExpression = this.AssociatedTable as DbJoinTableExpression;</a>
<a name="ln767">            if (joinTableExpression != null)</a>
<a name="ln768">            {</a>
<a name="ln769">                this.Filters.ForEach(a =&gt;</a>
<a name="ln770">                {</a>
<a name="ln771">                    joinTableExpression.Condition = joinTableExpression.Condition.And(a);</a>
<a name="ln772">                });</a>
<a name="ln773">            }</a>
<a name="ln774">        }</a>
<a name="ln775">    }</a>
<a name="ln776">}</a>
</code></pre>
<div class="balloon" rel="162"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3051/" target="_blank">V3051</a> An excessive type cast. The object is already of the 'ComplexObjectModel' type.</p></div>
<div class="balloon" rel="500"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3051/" target="_blank">V3051</a> An excessive type cast. The object is already of the 'ComplexObjectModel' type.</p></div>
<div class="balloon" rel="539"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3051/" target="_blank">V3051</a> An excessive type cast. The object is already of the 'ComplexObjectModel' type.</p></div>
<div class="balloon" rel="196"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3125/" target="_blank">V3125</a> The 'model' object was used after it was verified against null. Check lines: 196, 188.</p></div>
<div class="balloon" rel="436"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3149/" target="_blank">V3149</a> Dereferencing the result of 'as' operator inside method can lead to NullReferenceException. Consider inspecting 1st argument.</p></div>
<div class="balloon" rel="473"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3149/" target="_blank">V3149</a> Dereferencing the result of 'as' operator can lead to NullReferenceException. Consider inspecting 'joinTable'.</p></div>
<div class="balloon" rel="643"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3149/" target="_blank">V3149</a> Dereferencing the result of 'as' operator inside method can lead to NullReferenceException. Consider inspecting 1st argument.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>