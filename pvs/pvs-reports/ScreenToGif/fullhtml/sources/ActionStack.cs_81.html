<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>ActionStack.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Collections.Generic;</a>
<a name="ln3">using System.IO;</a>
<a name="ln4">using System.Linq;</a>
<a name="ln5">using ScreenToGif.Model;</a>
<a name="ln6">using ScreenToGif.Util.Settings;</a>
<a name="ln7"> </a>
<a name="ln8">namespace ScreenToGif.Util;</a>
<a name="ln9"> </a>
<a name="ln10">/// &lt;summary&gt;</a>
<a name="ln11">/// Do, Undo, Redo stack.</a>
<a name="ln12">/// &lt;/summary&gt;</a>
<a name="ln13">public static class ActionStack</a>
<a name="ln14">{</a>
<a name="ln15">    #region Variables</a>
<a name="ln16"> </a>
<a name="ln17">    public static ProjectInfo Project { get; set; }</a>
<a name="ln18"> </a>
<a name="ln19">    private static readonly ExtendedStack&lt;StateChange&gt; UndoStack = new();</a>
<a name="ln20">    private static readonly ExtendedStack&lt;StateChange&gt; RedoStack = new();</a>
<a name="ln21"> </a>
<a name="ln22">    #endregion</a>
<a name="ln23"> </a>
<a name="ln24">    public enum EditAction</a>
<a name="ln25">    {</a>
<a name="ln26">        Remove,</a>
<a name="ln27">        ImageAndProperties,</a>
<a name="ln28">        Properties,</a>
<a name="ln29">        Add,</a>
<a name="ln30">        Reorder,</a>
<a name="ln31">        RemoveAndAlter,</a>
<a name="ln32">        AddAndAlter,</a>
<a name="ln33">    }</a>
<a name="ln34"> </a>
<a name="ln35">    public class StateChange</a>
<a name="ln36">    {</a>
<a name="ln37">        public EditAction Cause { get; set; }</a>
<a name="ln38">        public List&lt;FrameInfo&gt; Frames { get; set; }</a>
<a name="ln39">        public string CurrentFolder { get; set; }</a>
<a name="ln40"> </a>
<a name="ln41">        public List&lt;int&gt; Indexes { get; set; }</a>
<a name="ln42">        public List&lt;int&gt; Indexes2 { get; set; }</a>
<a name="ln43"> </a>
<a name="ln44">        /// &lt;summary&gt;</a>
<a name="ln45">        /// Signals that this state should not be available.</a>
<a name="ln46">        /// &lt;/summary&gt;</a>
<a name="ln47">        public bool IgnoreWhenReset { get; set; }</a>
<a name="ln48">    }</a>
<a name="ln49"> </a>
<a name="ln50">    #region Save State</a>
<a name="ln51"> </a>
<a name="ln52">    public static void SaveState(EditAction action, List&lt;FrameInfo&gt; frames, List&lt;int&gt; positions)</a>
<a name="ln53">    {</a>
<a name="ln54">        if (!ShouldSaveState())</a>
<a name="ln55">            return;</a>
<a name="ln56"> </a>
<a name="ln57">        var orderedPositions = positions.OrderBy(x =&gt; x).ToList();</a>
<a name="ln58">        var savedFrames = new List&lt;FrameInfo&gt;();</a>
<a name="ln59">        var currentFolder = CreateCurrent(true);</a>
<a name="ln60"> </a>
<a name="ln61">        switch (action)</a>
<a name="ln62">        {</a>
<a name="ln63">            case EditAction.Remove:</a>
<a name="ln64"> </a>
<a name="ln65">                //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln66">                foreach (var position in orderedPositions)</a>
<a name="ln67">                {</a>
<a name="ln68">                    var frame = frames[position];</a>
<a name="ln69">                    var savedFrame = Path.Combine(currentFolder, Path.GetFileName(frame.Path)); // position + &quot;.png&quot;);</a>
<a name="ln70"> </a>
<a name="ln71">                    //Copy to a folder.</a>
<a name="ln72">                    File.Copy(frame.Path, savedFrame);</a>
<a name="ln73"> </a>
<a name="ln74">                    savedFrames.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln75">                }</a>
<a name="ln76"> </a>
<a name="ln77">                //Create a StageChange object with the saved frames and push to the undo stack.</a>
<a name="ln78">                UndoStack.Push(new StateChange</a>
<a name="ln79">                {</a>
<a name="ln80">                    Cause = action,</a>
<a name="ln81">                    Frames = savedFrames,</a>
<a name="ln82">                    CurrentFolder = currentFolder,</a>
<a name="ln83">                    Indexes = orderedPositions</a>
<a name="ln84">                });</a>
<a name="ln85"> </a>
<a name="ln86">                break;</a>
<a name="ln87">            case EditAction.ImageAndProperties:</a>
<a name="ln88"> </a>
<a name="ln89">                //Saves the frames that will be altered (using the given list of positions).</a>
<a name="ln90">                foreach (var position in orderedPositions)</a>
<a name="ln91">                {</a>
<a name="ln92">                    var frame = frames[position];</a>
<a name="ln93">                    var savedFrame = Path.Combine(currentFolder, Path.GetFileName(frame.Path)); // position + &quot;.png&quot;);</a>
<a name="ln94"> </a>
<a name="ln95">                    //Copy to a folder.</a>
<a name="ln96">                    File.Copy(frame.Path, savedFrame);</a>
<a name="ln97"> </a>
<a name="ln98">                    savedFrames.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln99">                }</a>
<a name="ln100"> </a>
<a name="ln101">                //Create a StageChange object with the saved frames and push to the undo stack.</a>
<a name="ln102">                UndoStack.Push(new StateChange</a>
<a name="ln103">                {</a>
<a name="ln104">                    Cause = action,</a>
<a name="ln105">                    Frames = savedFrames,</a>
<a name="ln106">                    CurrentFolder = currentFolder,</a>
<a name="ln107">                    Indexes = orderedPositions</a>
<a name="ln108">                });</a>
<a name="ln109"> </a>
<a name="ln110">                break;</a>
<a name="ln111">            case EditAction.Properties:</a>
<a name="ln112"> </a>
<a name="ln113">                //Saves the frames that will be altered, without copying the images (using the given list of positions).</a>
<a name="ln114">                foreach (var position in orderedPositions)</a>
<a name="ln115">                {</a>
<a name="ln116">                    var frame = frames[position];</a>
<a name="ln117"> </a>
<a name="ln118">                    savedFrames.Add(new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln119">                }</a>
<a name="ln120"> </a>
<a name="ln121">                //Create a StageChange object with the saved frames and push to the undo stack.</a>
<a name="ln122">                UndoStack.Push(new StateChange</a>
<a name="ln123">                {</a>
<a name="ln124">                    Cause = action,</a>
<a name="ln125">                    Frames = savedFrames,</a>
<a name="ln126">                    Indexes = orderedPositions</a>
<a name="ln127">                });</a>
<a name="ln128"> </a>
<a name="ln129">                break;</a>
<a name="ln130">            default:</a>
<a name="ln131">                throw new ArgumentOutOfRangeException(nameof(action), action, null);</a>
<a name="ln132">        }</a>
<a name="ln133"> </a>
<a name="ln134">        ClearRedo();</a>
<a name="ln135">        TrimUndo();</a>
<a name="ln136">    }</a>
<a name="ln137"> </a>
<a name="ln138">    public static void SaveState(EditAction action, List&lt;FrameInfo&gt; frames, List&lt;int&gt; removeList, List&lt;int&gt; alterList)</a>
<a name="ln139">    {</a>
<a name="ln140">        if (action != EditAction.RemoveAndAlter)</a>
<a name="ln141">            throw new ArgumentException(&quot;Parameters different than RemoveAndAlter are not supported.&quot;, nameof(action));</a>
<a name="ln142"> </a>
<a name="ln143">        if (!ShouldSaveState())</a>
<a name="ln144">            return;</a>
<a name="ln145"> </a>
<a name="ln146">        var savedFrames = new List&lt;FrameInfo&gt;();</a>
<a name="ln147">        var currentFolder = CreateCurrent(true);</a>
<a name="ln148"> </a>
<a name="ln149">        #region Removed</a>
<a name="ln150"> </a>
<a name="ln151">        //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln152">        foreach (var position in removeList)</a>
<a name="ln153">        {</a>
<a name="ln154">            var frame = frames[position];</a>
<a name="ln155">            var savedFrame = Path.Combine(currentFolder, Path.GetFileName(frame.Path));</a>
<a name="ln156"> </a>
<a name="ln157">            //Copy to a folder.</a>
<a name="ln158">            File.Copy(frame.Path, savedFrame);</a>
<a name="ln159"> </a>
<a name="ln160">            savedFrames.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln161">        }</a>
<a name="ln162"> </a>
<a name="ln163">        #endregion</a>
<a name="ln164"> </a>
<a name="ln165">        #region Altered</a>
<a name="ln166"> </a>
<a name="ln167">        //Saves the frames that will be altered, without copying the images (using the given list of positions).</a>
<a name="ln168">        foreach (var position in alterList)</a>
<a name="ln169">        {</a>
<a name="ln170">            var frame = frames[position];</a>
<a name="ln171"> </a>
<a name="ln172">            savedFrames.Add(new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln173">        }</a>
<a name="ln174"> </a>
<a name="ln175">        #endregion</a>
<a name="ln176"> </a>
<a name="ln177">        UndoStack.Push(new StateChange</a>
<a name="ln178">        {</a>
<a name="ln179">            Cause = action,</a>
<a name="ln180">            Frames = savedFrames,</a>
<a name="ln181">            CurrentFolder = currentFolder, //Ignore this property when frame is set as &quot;Altered&quot;.</a>
<a name="ln182">            Indexes = removeList,</a>
<a name="ln183">            Indexes2 = alterList,</a>
<a name="ln184">        });</a>
<a name="ln185"> </a>
<a name="ln186">        ClearRedo();</a>
<a name="ln187">        TrimUndo();</a>
<a name="ln188">    }</a>
<a name="ln189"> </a>
<a name="ln190">    /// &lt;summary&gt;</a>
<a name="ln191">    /// Save the state of the list of frames. This overload is used by the EditAction.Add.</a>
<a name="ln192">    /// &lt;/summary&gt;</a>
<a name="ln193">    /// &lt;param name=&quot;action&quot;&gt;The action, currently just the Add.&lt;/param&gt;</a>
<a name="ln194">    /// &lt;param name=&quot;position&quot;&gt;The position where the frames will be inserted.&lt;/param&gt;</a>
<a name="ln195">    /// &lt;param name=&quot;quantity&quot;&gt;The quantity of inserted frames.&lt;/param&gt;</a>
<a name="ln196">    public static void SaveState(EditAction action, int position, int quantity)</a>
<a name="ln197">    {</a>
<a name="ln198">        if (action != EditAction.Add)</a>
<a name="ln199">            throw new ArgumentException(&quot;Parameters different than Add are not supported.&quot;, nameof(action));</a>
<a name="ln200"> </a>
<a name="ln201">        if (!ShouldSaveState())</a>
<a name="ln202">            return;</a>
<a name="ln203"> </a>
<a name="ln204">        //Saves the position where the new frames will be inserted.</a>
<a name="ln205">        UndoStack.Push(new StateChange</a>
<a name="ln206">        {</a>
<a name="ln207">            Cause = action,</a>
<a name="ln208">            Indexes = Util.Other.ListOfIndexes(position, quantity)</a>
<a name="ln209">        });</a>
<a name="ln210"> </a>
<a name="ln211">        ClearRedo();</a>
<a name="ln212">        TrimUndo();</a>
<a name="ln213">    }</a>
<a name="ln214"> </a>
<a name="ln215">    /// &lt;summary&gt;</a>
<a name="ln216">    /// Save the state of the list of frames. This overload is used by the EditAction.Reorder.</a>
<a name="ln217">    /// &lt;/summary&gt;</a>
<a name="ln218">    /// &lt;param name=&quot;action&quot;&gt;The action, currently just the Reorder.&lt;/param&gt;</a>
<a name="ln219">    /// &lt;param name=&quot;frames&quot;&gt;The old (current) list of frames.&lt;/param&gt;</a>
<a name="ln220">    public static void SaveState(EditAction action, List&lt;FrameInfo&gt; frames)</a>
<a name="ln221">    {</a>
<a name="ln222">        if (action != EditAction.Reorder)</a>
<a name="ln223">            throw new ArgumentException(&quot;Parameters different than Reorder are not supported.&quot;, nameof(action));</a>
<a name="ln224"> </a>
<a name="ln225">        if (!ShouldSaveState())</a>
<a name="ln226">            return;</a>
<a name="ln227"> </a>
<a name="ln228">        //Saves the frames before the reordering.</a>
<a name="ln229">        UndoStack.Push(new StateChange</a>
<a name="ln230">        {</a>
<a name="ln231">            Cause = action,</a>
<a name="ln232">            Frames = frames,</a>
<a name="ln233">        });</a>
<a name="ln234"> </a>
<a name="ln235">        ClearRedo();</a>
<a name="ln236">        TrimUndo();</a>
<a name="ln237">    }</a>
<a name="ln238"> </a>
<a name="ln239">    #endregion</a>
<a name="ln240"> </a>
<a name="ln241">    #region Actions</a>
<a name="ln242"> </a>
<a name="ln243">    public static List&lt;FrameInfo&gt; Undo(List&lt;FrameInfo&gt; current, bool pushToRedo = true)</a>
<a name="ln244">    {</a>
<a name="ln245">        //Pop from Undo stack.</a>
<a name="ln246">        var latestUndo = UndoStack.Pop();</a>
<a name="ln247"> </a>
<a name="ln248">        #region Push into Redo stack</a>
<a name="ln249"> </a>
<a name="ln250">        if (pushToRedo)</a>
<a name="ln251">        {</a>
<a name="ln252">            var redoStateChange = new StateChange();</a>
<a name="ln253"> </a>
<a name="ln254">            //To redo the action, it should be saved as the inverse of the current undo.</a>
<a name="ln255">            switch (latestUndo.Cause)</a>
<a name="ln256">            {</a>
<a name="ln257">                case EditAction.Remove:</a>
<a name="ln258"> </a>
<a name="ln259">                    #region Add (Inverse)</a>
<a name="ln260"> </a>
<a name="ln261">                    redoStateChange.Cause = EditAction.Add;</a>
<a name="ln262">                    redoStateChange.Indexes = new List&lt;int&gt;(latestUndo.Indexes);</a>
<a name="ln263"> </a>
<a name="ln264">                    #endregion</a>
<a name="ln265"> </a>
<a name="ln266">                    break;</a>
<a name="ln267">                case EditAction.Add:</a>
<a name="ln268"> </a>
<a name="ln269">                    #region Remove (Inverse)</a>
<a name="ln270"> </a>
<a name="ln271">                    var savedFrames = new List&lt;FrameInfo&gt;();</a>
<a name="ln272">                    var redoFolder = CreateCurrent(false);</a>
<a name="ln273"> </a>
<a name="ln274">                    redoStateChange.Cause = EditAction.Remove;</a>
<a name="ln275">                    redoStateChange.Indexes = new List&lt;int&gt;(latestUndo.Indexes);</a>
<a name="ln276"> </a>
<a name="ln277">                    //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln278">                    foreach (var position in latestUndo.Indexes)</a>
<a name="ln279">                    {</a>
<a name="ln280">                        var frame = current[position];</a>
<a name="ln281">                        var savedFrame = Path.Combine(redoFolder, Path.GetFileName(frame.Path));</a>
<a name="ln282"> </a>
<a name="ln283">                        //Copy to a folder.</a>
<a name="ln284">                        File.Copy(frame.Path, savedFrame);</a>
<a name="ln285"> </a>
<a name="ln286">                        savedFrames.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln287">                    }</a>
<a name="ln288"> </a>
<a name="ln289">                    redoStateChange.Frames = savedFrames;</a>
<a name="ln290"> </a>
<a name="ln291">                    #endregion</a>
<a name="ln292"> </a>
<a name="ln293">                    break;</a>
<a name="ln294">                case EditAction.ImageAndProperties:</a>
<a name="ln295"> </a>
<a name="ln296">                    #region Alter the images and properties (Inverse)</a>
<a name="ln297"> </a>
<a name="ln298">                    var savedFrames2 = new List&lt;FrameInfo&gt;();</a>
<a name="ln299">                    var redoFolder2 = CreateCurrent(false);</a>
<a name="ln300"> </a>
<a name="ln301">                    redoStateChange.Cause = EditAction.ImageAndProperties;</a>
<a name="ln302">                    redoStateChange.Indexes = latestUndo.Indexes;</a>
<a name="ln303"> </a>
<a name="ln304">                    //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln305">                    foreach (var position in latestUndo.Indexes)</a>
<a name="ln306">                    {</a>
<a name="ln307">                        var frame = current[position];</a>
<a name="ln308">                        var savedFrame = Path.Combine(redoFolder2, Path.GetFileName(frame.Path));</a>
<a name="ln309"> </a>
<a name="ln310">                        //Copy to a folder.</a>
<a name="ln311">                        File.Copy(frame.Path, savedFrame);</a>
<a name="ln312"> </a>
<a name="ln313">                        savedFrames2.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln314">                    }</a>
<a name="ln315"> </a>
<a name="ln316">                    redoStateChange.Frames = savedFrames2;</a>
<a name="ln317"> </a>
<a name="ln318">                    #endregion</a>
<a name="ln319"> </a>
<a name="ln320">                    break;</a>
<a name="ln321">                case EditAction.Properties:</a>
<a name="ln322"> </a>
<a name="ln323">                    #region Alter the properties (Inverse)</a>
<a name="ln324"> </a>
<a name="ln325">                    redoStateChange.Cause = EditAction.Properties;</a>
<a name="ln326">                    redoStateChange.Frames = new List&lt;FrameInfo&gt;(latestUndo.Frames);</a>
<a name="ln327">                    redoStateChange.Indexes = new List&lt;int&gt;(latestUndo.Indexes);</a>
<a name="ln328"> </a>
<a name="ln329">                    #endregion</a>
<a name="ln330"> </a>
<a name="ln331">                    break;</a>
<a name="ln332">                case EditAction.Reorder:</a>
<a name="ln333"> </a>
<a name="ln334">                    #region Reorder (Inverse)</a>
<a name="ln335"> </a>
<a name="ln336">                    redoStateChange.Cause = EditAction.Reorder;</a>
<a name="ln337">                    redoStateChange.Frames = current.CopyList();</a>
<a name="ln338"> </a>
<a name="ln339">                    #endregion</a>
<a name="ln340"> </a>
<a name="ln341">                    break;</a>
<a name="ln342">                case EditAction.RemoveAndAlter:</a>
<a name="ln343"> </a>
<a name="ln344">                    #region Add and alter the properties (Inverse)</a>
<a name="ln345"> </a>
<a name="ln346">                    redoStateChange.Cause = EditAction.AddAndAlter;</a>
<a name="ln347">                    //Save only the altered frames.</a>
<a name="ln348">                    redoStateChange.Frames = new List&lt;FrameInfo&gt;(latestUndo.Frames).Skip(latestUndo.Indexes.Count).Take(latestUndo.Indexes2.Count).ToList();</a>
<a name="ln349">                    redoStateChange.Indexes = new List&lt;int&gt;(latestUndo.Indexes);</a>
<a name="ln350">                    redoStateChange.Indexes2 = new List&lt;int&gt;(latestUndo.Indexes2);</a>
<a name="ln351"> </a>
<a name="ln352">                    #endregion</a>
<a name="ln353"> </a>
<a name="ln354">                    break;</a>
<a name="ln355"> </a>
<a name="ln356">                case EditAction.AddAndAlter: //Check.</a>
<a name="ln357"> </a>
<a name="ln358">                    #region Remove and alter the properties (Inverse)</a>
<a name="ln359"> </a>
<a name="ln360">                    var savedFrames3 = new List&lt;FrameInfo&gt;();</a>
<a name="ln361">                    var redoFolder3 = CreateCurrent(false);</a>
<a name="ln362"> </a>
<a name="ln363">                    redoStateChange.Cause = EditAction.RemoveAndAlter;</a>
<a name="ln364">                    redoStateChange.Indexes = new List&lt;int&gt;(latestUndo.Indexes);</a>
<a name="ln365">                    redoStateChange.Indexes2 = new List&lt;int&gt;(latestUndo.Indexes2);</a>
<a name="ln366"> </a>
<a name="ln367">                    //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln368">                    foreach (var position in latestUndo.Indexes)</a>
<a name="ln369">                    {</a>
<a name="ln370">                        var frame = current[position];</a>
<a name="ln371">                        var savedFrame = Path.Combine(redoFolder3, Path.GetFileName(frame.Path));</a>
<a name="ln372"> </a>
<a name="ln373">                        //Copy to a folder.</a>
<a name="ln374">                        File.Copy(frame.Path, savedFrame);</a>
<a name="ln375"> </a>
<a name="ln376">                        savedFrames3.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln377">                    }</a>
<a name="ln378"> </a>
<a name="ln379">                    //Saves the altered frames, without saving the images.</a>
<a name="ln380">                    foreach (var position in latestUndo.Indexes2)</a>
<a name="ln381">                    {</a>
<a name="ln382">                        var frame = current[position];</a>
<a name="ln383">                        savedFrames3.Add(new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln384">                    }</a>
<a name="ln385"> </a>
<a name="ln386">                    redoStateChange.Frames = savedFrames3;</a>
<a name="ln387"> </a>
<a name="ln388">                    #endregion</a>
<a name="ln389"> </a>
<a name="ln390">                    break;</a>
<a name="ln391">            }</a>
<a name="ln392"> </a>
<a name="ln393">            RedoStack.Push(redoStateChange);</a>
<a name="ln394">        }</a>
<a name="ln395"> </a>
<a name="ln396">        #endregion</a>
<a name="ln397"> </a>
<a name="ln398">        #region Undo</a>
<a name="ln399"> </a>
<a name="ln400">        switch (latestUndo.Cause)</a>
<a name="ln401">        {</a>
<a name="ln402">            case EditAction.Remove:</a>
<a name="ln403"> </a>
<a name="ln404">                #region Insert again the frames</a>
<a name="ln405"> </a>
<a name="ln406">                if (latestUndo.Frames == null || latestUndo.Frames.Count == 0)</a>
<a name="ln407">                    throw new Exception(&quot;No frames to undo.&quot;);</a>
<a name="ln408"> </a>
<a name="ln409">                var folder = Path.GetDirectoryName(current[0].Path);</a>
<a name="ln410"> </a>
<a name="ln411">                var currentIndex = 0;</a>
<a name="ln412">                foreach (var index in latestUndo.Indexes)</a>
<a name="ln413">                {</a>
<a name="ln414">                    var frame = latestUndo.Frames[currentIndex];</a>
<a name="ln415">                    var file = Path.Combine(folder, Path.GetFileName(frame.Path));</a>
<a name="ln416"> </a>
<a name="ln417">                    //Copy file to folder.</a>
<a name="ln418">                    File.Copy(frame.Path, file);</a>
<a name="ln419"> </a>
<a name="ln420">                    //Add to list.</a>
<a name="ln421">                    current.Insert(index, new FrameInfo(file, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln422"> </a>
<a name="ln423">                    currentIndex++;</a>
<a name="ln424">                }</a>
<a name="ln425"> </a>
<a name="ln426">                //Erase the undo folder.</a>
<a name="ln427">                Directory.Delete(Path.GetDirectoryName(latestUndo.Frames[0].Path), true);</a>
<a name="ln428"> </a>
<a name="ln429">                #endregion</a>
<a name="ln430"> </a>
<a name="ln431">                break;</a>
<a name="ln432">            case EditAction.ImageAndProperties:</a>
<a name="ln433"> </a>
<a name="ln434">                #region Alter the image and properties</a>
<a name="ln435"> </a>
<a name="ln436">                if (latestUndo.Frames == null || latestUndo.Frames.Count == 0)</a>
<a name="ln437">                    throw new Exception(&quot;No frames to redo.&quot;);</a>
<a name="ln438"> </a>
<a name="ln439">                var alteredIndex2 = 0;</a>
<a name="ln440">                foreach (var frame in latestUndo.Frames)</a>
<a name="ln441">                {</a>
<a name="ln442">                    //Get the current frame before or after returning the properties values?</a>
<a name="ln443">                    var currentFrame = current[latestUndo.Indexes[alteredIndex2]];</a>
<a name="ln444"> </a>
<a name="ln445">                    current[latestUndo.Indexes[alteredIndex2]] = new FrameInfo(currentFrame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index); //Image location stays the same.</a>
<a name="ln446"> </a>
<a name="ln447">                    //Copy file to folder.</a>
<a name="ln448">                    File.Copy(frame.Path, currentFrame.Path, true);</a>
<a name="ln449"> </a>
<a name="ln450">                    alteredIndex2++;</a>
<a name="ln451">                }</a>
<a name="ln452"> </a>
<a name="ln453">                //Erase the undo folder.</a>
<a name="ln454">                Directory.Delete(Path.GetDirectoryName(latestUndo.Frames[0].Path), true);</a>
<a name="ln455"> </a>
<a name="ln456">                #endregion</a>
<a name="ln457"> </a>
<a name="ln458">                break;</a>
<a name="ln459">            case EditAction.Properties:</a>
<a name="ln460"> </a>
<a name="ln461">                #region Alter the properties</a>
<a name="ln462"> </a>
<a name="ln463">                if (latestUndo.Frames == null || latestUndo.Frames.Count == 0)</a>
<a name="ln464">                    throw new Exception(&quot;No frames to undo.&quot;);</a>
<a name="ln465"> </a>
<a name="ln466">                var alteredIndex = 0;</a>
<a name="ln467">                foreach (var frame in latestUndo.Frames)</a>
<a name="ln468">                {</a>
<a name="ln469">                    current[latestUndo.Indexes[alteredIndex]] = new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index);</a>
<a name="ln470"> </a>
<a name="ln471">                    alteredIndex++;</a>
<a name="ln472">                }</a>
<a name="ln473"> </a>
<a name="ln474">                #endregion</a>
<a name="ln475"> </a>
<a name="ln476">                break;</a>
<a name="ln477">            case EditAction.Add:</a>
<a name="ln478"> </a>
<a name="ln479">                #region Remove the added frames</a>
<a name="ln480"> </a>
<a name="ln481">                foreach (var index in latestUndo.Indexes.OrderByDescending(x =&gt; x))</a>
<a name="ln482">                {</a>
<a name="ln483">                    File.Delete(current[index].Path);</a>
<a name="ln484"> </a>
<a name="ln485">                    current.RemoveAt(index);</a>
<a name="ln486">                }</a>
<a name="ln487"> </a>
<a name="ln488">                #endregion</a>
<a name="ln489"> </a>
<a name="ln490">                break;</a>
<a name="ln491">            case EditAction.Reorder:</a>
<a name="ln492"> </a>
<a name="ln493">                #region Reorder the frames to a previous order</a>
<a name="ln494"> </a>
<a name="ln495">                current = latestUndo.Frames.CopyList();</a>
<a name="ln496"> </a>
<a name="ln497">                #endregion</a>
<a name="ln498"> </a>
<a name="ln499">                break;</a>
<a name="ln500">            case EditAction.AddAndAlter: //Check.</a>
<a name="ln501"> </a>
<a name="ln502">                #region Remove the added frames and alter the properties</a>
<a name="ln503"> </a>
<a name="ln504">                for (var i = latestUndo.Indexes.Count -1; i &gt;= 0; i--)</a>
<a name="ln505">                {</a>
<a name="ln506">                    var removeIndex = latestUndo.Indexes[i];</a>
<a name="ln507"> </a>
<a name="ln508">                    //Alter the properties.</a>
<a name="ln509">                    if (removeIndex &gt; 0)</a>
<a name="ln510">                        current[removeIndex - 1].Delay = current[removeIndex].Delay;</a>
<a name="ln511"> </a>
<a name="ln512">                    //Remove the file.</a>
<a name="ln513">                    File.Delete(current[removeIndex].Path);</a>
<a name="ln514">                    current.RemoveAt(removeIndex);</a>
<a name="ln515">                }</a>
<a name="ln516"> </a>
<a name="ln517">                #endregion</a>
<a name="ln518"> </a>
<a name="ln519">                break;</a>
<a name="ln520">            case EditAction.RemoveAndAlter:</a>
<a name="ln521"> </a>
<a name="ln522">                #region Insert again the frames</a>
<a name="ln523"> </a>
<a name="ln524">                if (latestUndo.Frames == null || latestUndo.Frames.Count == 0)</a>
<a name="ln525">                    throw new Exception(&quot;No frames to undo.&quot;);</a>
<a name="ln526"> </a>
<a name="ln527">                var folder2 = Path.GetDirectoryName(current[0].Path);</a>
<a name="ln528"> </a>
<a name="ln529">                var currentIndex2 = 0;</a>
<a name="ln530">                foreach (var index in latestUndo.Indexes)</a>
<a name="ln531">                {</a>
<a name="ln532">                    var frame = latestUndo.Frames[currentIndex2];</a>
<a name="ln533">                    var file = Path.Combine(folder2, Path.GetFileName(frame.Path));</a>
<a name="ln534"> </a>
<a name="ln535">                    //Copy file to folder.</a>
<a name="ln536">                    File.Copy(frame.Path, file);</a>
<a name="ln537"> </a>
<a name="ln538">                    //Add to list.</a>
<a name="ln539">                    current.Insert(index, new FrameInfo(file, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln540"> </a>
<a name="ln541">                    currentIndex2++;</a>
<a name="ln542">                }</a>
<a name="ln543"> </a>
<a name="ln544">                //Erase the undo folder.</a>
<a name="ln545">                Directory.Delete(Path.GetDirectoryName(latestUndo.Frames[0].Path), true);</a>
<a name="ln546"> </a>
<a name="ln547">                #endregion</a>
<a name="ln548"> </a>
<a name="ln549">                #region Alter the properties</a>
<a name="ln550"> </a>
<a name="ln551">                var alteredIndex3 = 0;</a>
<a name="ln552">                foreach (var frame in latestUndo.Frames.Skip(latestUndo.Indexes.Count))</a>
<a name="ln553">                {</a>
<a name="ln554">                    current[latestUndo.Indexes2[alteredIndex3]] = new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index);</a>
<a name="ln555"> </a>
<a name="ln556">                    alteredIndex3++;</a>
<a name="ln557">                }</a>
<a name="ln558"> </a>
<a name="ln559">                #endregion</a>
<a name="ln560"> </a>
<a name="ln561">                break;</a>
<a name="ln562">            default:</a>
<a name="ln563">                throw new ArgumentOutOfRangeException();</a>
<a name="ln564">        }</a>
<a name="ln565"> </a>
<a name="ln566">        #endregion</a>
<a name="ln567"> </a>
<a name="ln568">        GC.Collect();</a>
<a name="ln569"> </a>
<a name="ln570">        return current;</a>
<a name="ln571">    }</a>
<a name="ln572"> </a>
<a name="ln573">    public static List&lt;FrameInfo&gt; Redo(List&lt;FrameInfo&gt; current)</a>
<a name="ln574">    {</a>
<a name="ln575">        //Pop from Redo stack.</a>
<a name="ln576">        var latestRedo = RedoStack.Pop();</a>
<a name="ln577"> </a>
<a name="ln578">        #region Push into Undo stack</a>
<a name="ln579"> </a>
<a name="ln580">        var undoStateChange = new StateChange();</a>
<a name="ln581"> </a>
<a name="ln582">        switch (latestRedo.Cause)</a>
<a name="ln583">        {</a>
<a name="ln584">            case EditAction.Remove:</a>
<a name="ln585"> </a>
<a name="ln586">                #region Add (Inverse)</a>
<a name="ln587"> </a>
<a name="ln588">                undoStateChange.Cause = EditAction.Add;</a>
<a name="ln589">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln590"> </a>
<a name="ln591">                #endregion</a>
<a name="ln592"> </a>
<a name="ln593">                break;</a>
<a name="ln594">            case EditAction.Add:</a>
<a name="ln595"> </a>
<a name="ln596">                #region Remove (Inverse)</a>
<a name="ln597"> </a>
<a name="ln598">                var savedFrames = new List&lt;FrameInfo&gt;();</a>
<a name="ln599">                var redoFolder = CreateCurrent(true);</a>
<a name="ln600"> </a>
<a name="ln601">                undoStateChange.Cause = EditAction.Remove;</a>
<a name="ln602">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln603"> </a>
<a name="ln604">                //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln605">                foreach (var position in latestRedo.Indexes)</a>
<a name="ln606">                {</a>
<a name="ln607">                    var frame = current[position];</a>
<a name="ln608">                    var savedFrame = Path.Combine(redoFolder, Path.GetFileName(frame.Path));</a>
<a name="ln609"> </a>
<a name="ln610">                    //Copy to a folder.</a>
<a name="ln611">                    File.Copy(frame.Path, savedFrame);</a>
<a name="ln612"> </a>
<a name="ln613">                    savedFrames.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln614">                }</a>
<a name="ln615"> </a>
<a name="ln616">                undoStateChange.Frames = savedFrames;</a>
<a name="ln617"> </a>
<a name="ln618">                #endregion</a>
<a name="ln619"> </a>
<a name="ln620">                break;</a>
<a name="ln621">            case EditAction.ImageAndProperties:</a>
<a name="ln622"> </a>
<a name="ln623">                #region Alter the images and properties (Inverse)</a>
<a name="ln624"> </a>
<a name="ln625">                var savedFrames2 = new List&lt;FrameInfo&gt;();</a>
<a name="ln626">                var redoFolder2 = CreateCurrent(false);</a>
<a name="ln627"> </a>
<a name="ln628">                undoStateChange.Cause = EditAction.ImageAndProperties;</a>
<a name="ln629">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln630"> </a>
<a name="ln631">                //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln632">                foreach (var position in latestRedo.Indexes)</a>
<a name="ln633">                {</a>
<a name="ln634">                    var frame = current[position];</a>
<a name="ln635">                    var savedFrame = Path.Combine(redoFolder2, Path.GetFileName(frame.Path));</a>
<a name="ln636"> </a>
<a name="ln637">                    //Copy to a folder.</a>
<a name="ln638">                    File.Copy(frame.Path, savedFrame);</a>
<a name="ln639"> </a>
<a name="ln640">                    savedFrames2.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln641">                }</a>
<a name="ln642"> </a>
<a name="ln643">                undoStateChange.Frames = savedFrames2;</a>
<a name="ln644"> </a>
<a name="ln645">                #endregion</a>
<a name="ln646"> </a>
<a name="ln647">                break;</a>
<a name="ln648">            case EditAction.Properties:</a>
<a name="ln649"> </a>
<a name="ln650">                #region Alter the properties (Inverse)</a>
<a name="ln651"> </a>
<a name="ln652">                undoStateChange.Cause = EditAction.Properties;</a>
<a name="ln653">                undoStateChange.Frames = new List&lt;FrameInfo&gt;(latestRedo.Frames);</a>
<a name="ln654">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln655"> </a>
<a name="ln656">                #endregion</a>
<a name="ln657"> </a>
<a name="ln658">                break;</a>
<a name="ln659"> </a>
<a name="ln660">            case EditAction.Reorder:</a>
<a name="ln661"> </a>
<a name="ln662">                #region Reorder (Inverse)</a>
<a name="ln663"> </a>
<a name="ln664">                undoStateChange.Cause = EditAction.Reorder;</a>
<a name="ln665">                undoStateChange.Frames = current.CopyList();</a>
<a name="ln666"> </a>
<a name="ln667">                #endregion</a>
<a name="ln668"> </a>
<a name="ln669">                break;</a>
<a name="ln670"> </a>
<a name="ln671">            case EditAction.RemoveAndAlter:</a>
<a name="ln672"> </a>
<a name="ln673">                #region Add and alter the properties (Inverse)</a>
<a name="ln674"> </a>
<a name="ln675">                undoStateChange.Cause = EditAction.AddAndAlter;</a>
<a name="ln676">                //Save only the altered frames.</a>
<a name="ln677">                undoStateChange.Frames = new List&lt;FrameInfo&gt;(latestRedo.Frames).Skip(latestRedo.Indexes.Count).Take(latestRedo.Indexes2.Count).ToList();</a>
<a name="ln678">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln679">                undoStateChange.Indexes2 = new List&lt;int&gt;(latestRedo.Indexes2);</a>
<a name="ln680"> </a>
<a name="ln681">                #endregion</a>
<a name="ln682"> </a>
<a name="ln683">                break;</a>
<a name="ln684"> </a>
<a name="ln685">            case EditAction.AddAndAlter: //Check.</a>
<a name="ln686"> </a>
<a name="ln687">                #region Remove and alter the properties (Inverse)</a>
<a name="ln688"> </a>
<a name="ln689">                var savedFrames3 = new List&lt;FrameInfo&gt;();</a>
<a name="ln690">                var redoFolder3 = CreateCurrent(false);</a>
<a name="ln691"> </a>
<a name="ln692">                undoStateChange.Cause = EditAction.RemoveAndAlter;</a>
<a name="ln693">                undoStateChange.Indexes = new List&lt;int&gt;(latestRedo.Indexes);</a>
<a name="ln694">                undoStateChange.Indexes2 = new List&lt;int&gt;(latestRedo.Indexes2);</a>
<a name="ln695"> </a>
<a name="ln696">                //Saves the frames that will be deleted (using the given list of positions).</a>
<a name="ln697">                foreach (var position in latestRedo.Indexes)</a>
<a name="ln698">                {</a>
<a name="ln699">                    var frame = current[position];</a>
<a name="ln700">                    var savedFrame = Path.Combine(redoFolder3, Path.GetFileName(frame.Path));</a>
<a name="ln701"> </a>
<a name="ln702">                    //Copy to a folder.</a>
<a name="ln703">                    File.Copy(frame.Path, savedFrame);</a>
<a name="ln704"> </a>
<a name="ln705">                    savedFrames3.Add(new FrameInfo(savedFrame, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln706">                }</a>
<a name="ln707"> </a>
<a name="ln708">                //Saves the altered frames, without saving the images.</a>
<a name="ln709">                foreach (var position in latestRedo.Indexes2)</a>
<a name="ln710">                {</a>
<a name="ln711">                    var frame = current[position];</a>
<a name="ln712">                    savedFrames3.Add(new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln713">                }</a>
<a name="ln714"> </a>
<a name="ln715">                undoStateChange.Frames = savedFrames3;</a>
<a name="ln716"> </a>
<a name="ln717">                #endregion</a>
<a name="ln718"> </a>
<a name="ln719">                break;</a>
<a name="ln720">        }</a>
<a name="ln721"> </a>
<a name="ln722">        UndoStack.Push(undoStateChange);</a>
<a name="ln723"> </a>
<a name="ln724">        #endregion</a>
<a name="ln725"> </a>
<a name="ln726">        #region Redo</a>
<a name="ln727"> </a>
<a name="ln728">        switch (latestRedo.Cause)</a>
<a name="ln729">        {</a>
<a name="ln730">            case EditAction.Remove:</a>
<a name="ln731"> </a>
<a name="ln732">                #region Insert again the frames</a>
<a name="ln733"> </a>
<a name="ln734">                if (latestRedo.Frames == null || latestRedo.Frames.Count == 0)</a>
<a name="ln735">                    throw new Exception(&quot;No frames to redo.&quot;);</a>
<a name="ln736"> </a>
<a name="ln737">                var folder = Path.GetDirectoryName(current[0].Path);</a>
<a name="ln738"> </a>
<a name="ln739">                var currentIndex = 0;</a>
<a name="ln740">                foreach (var index in latestRedo.Indexes)</a>
<a name="ln741">                {</a>
<a name="ln742">                    var frame = latestRedo.Frames[currentIndex];</a>
<a name="ln743">                    var file = Path.Combine(folder, Path.GetFileName(frame.Path));</a>
<a name="ln744"> </a>
<a name="ln745">                    //Copy file to folder.</a>
<a name="ln746">                    File.Copy(frame.Path, file);</a>
<a name="ln747"> </a>
<a name="ln748">                    //Add to list.</a>
<a name="ln749">                    current.Insert(index, new FrameInfo(file, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln750"> </a>
<a name="ln751">                    currentIndex++;</a>
<a name="ln752">                }</a>
<a name="ln753"> </a>
<a name="ln754">                //Erase the redo folder.</a>
<a name="ln755">                Directory.Delete(Path.GetDirectoryName(latestRedo.Frames[0].Path), true);</a>
<a name="ln756"> </a>
<a name="ln757">                #endregion</a>
<a name="ln758"> </a>
<a name="ln759">                break;</a>
<a name="ln760">            case EditAction.ImageAndProperties:</a>
<a name="ln761"> </a>
<a name="ln762">                #region Alter the image</a>
<a name="ln763"> </a>
<a name="ln764">                if (latestRedo.Frames == null || latestRedo.Frames.Count == 0)</a>
<a name="ln765">                    throw new Exception(&quot;No frames to redo.&quot;);</a>
<a name="ln766"> </a>
<a name="ln767">                var folder2 = Path.GetDirectoryName(current[0].Path);</a>
<a name="ln768"> </a>
<a name="ln769">                foreach (var frame in latestRedo.Frames)</a>
<a name="ln770">                {</a>
<a name="ln771">                    var file = Path.Combine(folder2, Path.GetFileName(frame.Path));</a>
<a name="ln772"> </a>
<a name="ln773">                    //Copy file to folder.</a>
<a name="ln774">                    File.Copy(frame.Path, file, true);</a>
<a name="ln775">                }</a>
<a name="ln776"> </a>
<a name="ln777">                //Erase the undo folder.</a>
<a name="ln778">                Directory.Delete(Path.GetDirectoryName(latestRedo.Frames[0].Path), true);</a>
<a name="ln779"> </a>
<a name="ln780">                #endregion</a>
<a name="ln781"> </a>
<a name="ln782">                break;</a>
<a name="ln783">            case EditAction.Properties:</a>
<a name="ln784"> </a>
<a name="ln785">                #region Alter the properties</a>
<a name="ln786"> </a>
<a name="ln787">                if (latestRedo.Frames == null || latestRedo.Frames.Count == 0)</a>
<a name="ln788">                    throw new Exception(&quot;No frames to redo.&quot;);</a>
<a name="ln789"> </a>
<a name="ln790">                var alteredIndex = 0;</a>
<a name="ln791">                foreach (var frame in latestRedo.Frames)</a>
<a name="ln792">                {</a>
<a name="ln793">                    current[latestRedo.Indexes[alteredIndex]] = new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index);</a>
<a name="ln794"> </a>
<a name="ln795">                    alteredIndex++;</a>
<a name="ln796">                }</a>
<a name="ln797"> </a>
<a name="ln798">                #endregion</a>
<a name="ln799"> </a>
<a name="ln800">                break;</a>
<a name="ln801">            case EditAction.Add:</a>
<a name="ln802"> </a>
<a name="ln803">                #region Remove the added frames</a>
<a name="ln804"> </a>
<a name="ln805">                foreach (var index in latestRedo.Indexes.OrderByDescending(x =&gt; x))</a>
<a name="ln806">                {</a>
<a name="ln807">                    File.Delete(current[index].Path);</a>
<a name="ln808"> </a>
<a name="ln809">                    current.RemoveAt(index);</a>
<a name="ln810">                }</a>
<a name="ln811"> </a>
<a name="ln812">                #endregion</a>
<a name="ln813"> </a>
<a name="ln814">                break;</a>
<a name="ln815">            case EditAction.Reorder:</a>
<a name="ln816"> </a>
<a name="ln817">                #region Reorder the frames to a previous order</a>
<a name="ln818"> </a>
<a name="ln819">                current = latestRedo.Frames.CopyList();</a>
<a name="ln820"> </a>
<a name="ln821">                #endregion</a>
<a name="ln822"> </a>
<a name="ln823">                break;</a>
<a name="ln824"> </a>
<a name="ln825">            case EditAction.AddAndAlter: //Check.</a>
<a name="ln826"> </a>
<a name="ln827">                #region Remove the added frames and alter the properties</a>
<a name="ln828"> </a>
<a name="ln829">                for (var i = latestRedo.Indexes.Count - 1; i &gt;= 0; i--)</a>
<a name="ln830">                {</a>
<a name="ln831">                    var removeIndex = latestRedo.Indexes[i];</a>
<a name="ln832"> </a>
<a name="ln833">                    //Alter the properties.</a>
<a name="ln834">                    if (removeIndex &gt; 0)</a>
<a name="ln835">                        current[removeIndex - 1].Delay += current[removeIndex].Delay;</a>
<a name="ln836"> </a>
<a name="ln837">                    //Remove the file.</a>
<a name="ln838">                    File.Delete(current[removeIndex].Path);</a>
<a name="ln839">                    current.RemoveAt(removeIndex);</a>
<a name="ln840">                }</a>
<a name="ln841"> </a>
<a name="ln842">                #endregion</a>
<a name="ln843"> </a>
<a name="ln844">                break;</a>
<a name="ln845">            case EditAction.RemoveAndAlter:</a>
<a name="ln846"> </a>
<a name="ln847">                #region Insert again the frames</a>
<a name="ln848"> </a>
<a name="ln849">                if (latestRedo.Frames == null || latestRedo.Frames.Count == 0)</a>
<a name="ln850">                    throw new Exception(&quot;No frames to redo.&quot;);</a>
<a name="ln851"> </a>
<a name="ln852">                var folder3 = Path.GetDirectoryName(current[0].Path);</a>
<a name="ln853"> </a>
<a name="ln854">                var currentIndex2 = 0;</a>
<a name="ln855">                foreach (var index in latestRedo.Indexes)</a>
<a name="ln856">                {</a>
<a name="ln857">                    var frame = latestRedo.Frames[currentIndex2];</a>
<a name="ln858">                    var file = Path.Combine(folder3, Path.GetFileName(frame.Path));</a>
<a name="ln859"> </a>
<a name="ln860">                    //Copy file to folder.</a>
<a name="ln861">                    File.Copy(frame.Path, file);</a>
<a name="ln862"> </a>
<a name="ln863">                    //Add to list.</a>
<a name="ln864">                    current.Insert(index, new FrameInfo(file, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index));</a>
<a name="ln865"> </a>
<a name="ln866">                    currentIndex2++;</a>
<a name="ln867">                }</a>
<a name="ln868"> </a>
<a name="ln869">                //Erase the undo folder.</a>
<a name="ln870">                Directory.Delete(Path.GetDirectoryName(latestRedo.Frames[0].Path), true);</a>
<a name="ln871"> </a>
<a name="ln872">                #endregion</a>
<a name="ln873"> </a>
<a name="ln874">                #region Alter the properties</a>
<a name="ln875"> </a>
<a name="ln876">                var alteredIndex3 = 0;</a>
<a name="ln877">                foreach (var frame in latestRedo.Frames.Skip(latestRedo.Indexes.Count))</a>
<a name="ln878">                {</a>
<a name="ln879">                    current[latestRedo.Indexes2[alteredIndex3]] = new FrameInfo(frame.Path, frame.Delay, frame.CursorX, frame.CursorY, frame.ButtonClicked, frame.KeyList, frame.Index);</a>
<a name="ln880"> </a>
<a name="ln881">                    alteredIndex3++;</a>
<a name="ln882">                }</a>
<a name="ln883"> </a>
<a name="ln884">                #endregion</a>
<a name="ln885"> </a>
<a name="ln886">                break;</a>
<a name="ln887">        }</a>
<a name="ln888"> </a>
<a name="ln889">        #endregion</a>
<a name="ln890"> </a>
<a name="ln891">        GC.Collect();</a>
<a name="ln892"> </a>
<a name="ln893">        return current;</a>
<a name="ln894">    }</a>
<a name="ln895"> </a>
<a name="ln896">    public static List&lt;FrameInfo&gt; Reset(List&lt;FrameInfo&gt; current)</a>
<a name="ln897">    {</a>
<a name="ln898">        //TODO: Save the current state before resetting all.</a>
<a name="ln899">        //Signal that it was reset.</a>
<a name="ln900"> </a>
<a name="ln901">        var count = UndoStack.Count;</a>
<a name="ln902"> </a>
<a name="ln903">        //Pop all iteration from Undo stack</a>
<a name="ln904">        for (var i = 0; i &lt; count; i++)</a>
<a name="ln905">            current = Undo(current, false);</a>
<a name="ln906"> </a>
<a name="ln907">        ClearUndo();</a>
<a name="ln908">        ClearRedo();</a>
<a name="ln909"> </a>
<a name="ln910">        return current;</a>
<a name="ln911">    }</a>
<a name="ln912"> </a>
<a name="ln913">    #endregion</a>
<a name="ln914"> </a>
<a name="ln915">    #region Auxiliary</a>
<a name="ln916"> </a>
<a name="ln917">    /// &lt;summary&gt;</a>
<a name="ln918">    ///Creates the destination folder where the frames will be stored.</a>
<a name="ln919">    /// &lt;/summary&gt;</a>
<a name="ln920">    private static string CreateCurrent(bool isUndo)</a>
<a name="ln921">    {</a>
<a name="ln922">        var folder = Path.Combine(isUndo ? Project.UndoStackPath : Project.RedoStackPath, DateTime.Now.ToString(&quot;yy-MM-dd hh-mm-ss fff&quot;));</a>
<a name="ln923"> </a>
<a name="ln924">        if (!Directory.Exists(folder))</a>
<a name="ln925">            Directory.CreateDirectory(folder);</a>
<a name="ln926"> </a>
<a name="ln927">        return folder;</a>
<a name="ln928">    }</a>
<a name="ln929"> </a>
<a name="ln930"> </a>
<a name="ln931">    /// &lt;summary&gt;</a>
<a name="ln932">    /// Clear the Action Stack.</a>
<a name="ln933">    /// &lt;/summary&gt;</a>
<a name="ln934">    public static void Clear()</a>
<a name="ln935">    {</a>
<a name="ln936">        ClearUndo();</a>
<a name="ln937">        ClearRedo();</a>
<a name="ln938">    }</a>
<a name="ln939"> </a>
<a name="ln940">    private static void ClearUndo()</a>
<a name="ln941">    {</a>
<a name="ln942">        try</a>
<a name="ln943">        {</a>
<a name="ln944">            foreach (var frame in UndoStack.Where(x =&gt; x.Frames != null)</a>
<a name="ln945">                         .SelectMany(list =&gt; list.Frames.Where(frame =&gt; frame.Path != null &amp;&amp; File.Exists(frame.Path) &amp;&amp; frame.Path.Contains(&quot;ActionStack&quot; + Path.DirectorySeparatorChar + &quot;Undo&quot;))))</a>
<a name="ln946">            {</a>
<a name="ln947">                File.Delete(frame.Path);</a>
<a name="ln948">            }</a>
<a name="ln949">        }</a>
<a name="ln950">        finally</a>
<a name="ln951">        {</a>
<a name="ln952">            UndoStack.Clear();</a>
<a name="ln953">        }</a>
<a name="ln954">    }</a>
<a name="ln955"> </a>
<a name="ln956">    private static void ClearRedo()</a>
<a name="ln957">    {</a>
<a name="ln958">        try</a>
<a name="ln959">        {</a>
<a name="ln960">            foreach (var frame in RedoStack.Where(x =&gt; x.Frames != null)</a>
<a name="ln961">                         .SelectMany(list =&gt; list.Frames.Where(frame =&gt; frame.Path != null &amp;&amp; File.Exists(frame.Path) &amp;&amp; frame.Path.Contains(&quot;ActionStack&quot; + Path.DirectorySeparatorChar + &quot;Redo&quot;))))</a>
<a name="ln962">            {</a>
<a name="ln963">                File.Delete(frame.Path);</a>
<a name="ln964">            }</a>
<a name="ln965">        }</a>
<a name="ln966">        finally</a>
<a name="ln967">        {</a>
<a name="ln968">            RedoStack.Clear();</a>
<a name="ln969">        }</a>
<a name="ln970">    }</a>
<a name="ln971"> </a>
<a name="ln972">    private static void TrimUndo()</a>
<a name="ln973">    {</a>
<a name="ln974">        if (!UserSettings.All.SetHistoryLimit)</a>
<a name="ln975">            return;</a>
<a name="ln976"> </a>
<a name="ln977">        if (UndoStack.Count &lt;= UserSettings.All.HistoryLimit)</a>
<a name="ln978">            return;</a>
<a name="ln979"> </a>
<a name="ln980">        try</a>
<a name="ln981">        {</a>
<a name="ln982">            for (var i = UserSettings.All.HistoryLimit; i &lt; UndoStack.Count; i++)</a>
<a name="ln983">            {</a>
<a name="ln984">                var last = UndoStack.PopBottom();</a>
<a name="ln985"> </a>
<a name="ln986">                if (last?.Frames == null)</a>
<a name="ln987">                    continue;</a>
<a name="ln988"> </a>
<a name="ln989">                foreach (var frame in last.Frames.Where(frame =&gt; frame.Path != null &amp;&amp; File.Exists(frame.Path) &amp;&amp; frame.Path.Contains(&quot;ActionStack&quot; + Path.DirectorySeparatorChar + &quot;Undo&quot;)))</a>
<a name="ln990">                    File.Delete(frame.Path);</a>
<a name="ln991">            }</a>
<a name="ln992">        }</a>
<a name="ln993">        catch (Exception e)</a>
<a name="ln994">        {</a>
<a name="ln995">            LogWriter.Log(e, &quot;Impossible to trim the undo stack.&quot;);</a>
<a name="ln996">        }</a>
<a name="ln997">    }</a>
<a name="ln998"> </a>
<a name="ln999"> </a>
<a name="ln1000">    public static bool ShouldSaveState()</a>
<a name="ln1001">    {</a>
<a name="ln1002">        return !UserSettings.All.SetHistoryLimit || UserSettings.All.HistoryLimit &gt; 0;</a>
<a name="ln1003">    }</a>
<a name="ln1004"> </a>
<a name="ln1005">    /// &lt;summary&gt;</a>
<a name="ln1006">    /// Verifies if the Undo stack has elements and nothing else is happening.</a>
<a name="ln1007">    /// &lt;/summary&gt;</a>
<a name="ln1008">    /// &lt;returns&gt;True if able to Undo.&lt;/returns&gt;</a>
<a name="ln1009">    public static bool CanUndo()</a>
<a name="ln1010">    {</a>
<a name="ln1011">        return UndoStack.Count &gt; 0;</a>
<a name="ln1012">    }</a>
<a name="ln1013"> </a>
<a name="ln1014">    /// &lt;summary&gt;</a>
<a name="ln1015">    /// Verifies if the Redo stack has elements and nothing else is happening.</a>
<a name="ln1016">    /// &lt;/summary&gt;</a>
<a name="ln1017">    /// &lt;returns&gt;True if able to Redo.&lt;/returns&gt;</a>
<a name="ln1018">    public static bool CanRedo()</a>
<a name="ln1019">    {</a>
<a name="ln1020">        return RedoStack.Count &gt; 0;</a>
<a name="ln1021">    }</a>
<a name="ln1022"> </a>
<a name="ln1023">    /// &lt;summary&gt;</a>
<a name="ln1024">    /// Verifies if it's possible to reset.</a>
<a name="ln1025">    /// &lt;/summary&gt;</a>
<a name="ln1026">    /// &lt;returns&gt;True if able to Reset.&lt;/returns&gt;</a>
<a name="ln1027">    public static bool CanReset()</a>
<a name="ln1028">    {</a>
<a name="ln1029">        //Can only reset if there's one or more state changes that won't be ignored.</a>
<a name="ln1030">        return UndoStack.Count &gt; 0 || (UndoStack.Count == 1 &amp;&amp; UndoStack.All(x =&gt; !x.IgnoreWhenReset));</a>
<a name="ln1031">    }</a>
<a name="ln1032"> </a>
<a name="ln1033">    #endregion</a>
<a name="ln1034">}</a>
</code></pre>
<div class="balloon" rel="68"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3139/" target="_blank">V3139</a> Two or more case-branches perform the same actions.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>