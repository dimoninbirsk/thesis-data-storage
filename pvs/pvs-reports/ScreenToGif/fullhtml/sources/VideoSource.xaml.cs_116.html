<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>VideoSource.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using ScreenToGif.Domain.Enums;</a>
<a name="ln2">using System;</a>
<a name="ln3">using System.Collections.Generic;</a>
<a name="ln4">using System.Diagnostics;</a>
<a name="ln5">using System.Globalization;</a>
<a name="ln6">using System.IO;</a>
<a name="ln7">using System.Linq;</a>
<a name="ln8">using System.Text.RegularExpressions;</a>
<a name="ln9">using System.Threading.Tasks;</a>
<a name="ln10">using System.Windows;</a>
<a name="ln11">using System.Windows.Input;</a>
<a name="ln12">using System.Windows.Media;</a>
<a name="ln13">using System.Windows.Media.Imaging;</a>
<a name="ln14">using ScreenToGif.Model;</a>
<a name="ln15">using ScreenToGif.Util;</a>
<a name="ln16">using ScreenToGif.Util.Settings;</a>
<a name="ln17"> </a>
<a name="ln18">namespace ScreenToGif.Windows.Other;</a>
<a name="ln19"> </a>
<a name="ln20">public partial class VideoSource</a>
<a name="ln21">{</a>
<a name="ln22">    #region Variables</a>
<a name="ln23"> </a>
<a name="ln24">    private readonly object _lock = new();</a>
<a name="ln25">    private bool _cancelled;</a>
<a name="ln26">    private bool _isDisplayingError;</a>
<a name="ln27">    private int _previewerReady = 0;</a>
<a name="ln28">    private bool _wasPreviewChangedRegistered;</a>
<a name="ln29">    private bool _wasCaptureChangedRegistered;</a>
<a name="ln30">    private MediaPlayer _lowerPlayer = new() { Volume = 0, ScrubbingEnabled = true };</a>
<a name="ln31">    private MediaPlayer _upperPlayer = new() { Volume = 0, ScrubbingEnabled = true };</a>
<a name="ln32">    private RenderTargetBitmap _lowerRenderTargetBitmap;</a>
<a name="ln33">    private RenderTargetBitmap _upperRenderTargetBitmap;</a>
<a name="ln34">    private readonly Queue&lt;TimeSpan&gt; _positions = new();</a>
<a name="ln35">    private Process _process;</a>
<a name="ln36"> </a>
<a name="ln37">    /// &lt;summary&gt;</a>
<a name="ln38">    /// The path of the video file to be imported.</a>
<a name="ln39">    /// &lt;/summary&gt;</a>
<a name="ln40">    public string VideoPath { get; set; }</a>
<a name="ln41"> </a>
<a name="ln42">    /// &lt;summary&gt;</a>
<a name="ln43">    /// The path of the project where the imported frames will be stored after importing.</a>
<a name="ln44">    /// &lt;/summary&gt;</a>
<a name="ln45">    public string RootFolder { get; set; }</a>
<a name="ln46"> </a>
<a name="ln47">    /// &lt;summary&gt;</a>
<a name="ln48">    /// The width of the video, detected by this video importer.</a>
<a name="ln49">    /// &lt;/summary&gt;</a>
<a name="ln50">    public int VideoWidth { get; private set; }</a>
<a name="ln51"> </a>
<a name="ln52">    /// &lt;summary&gt;</a>
<a name="ln53">    /// The height of the video, detected by this video importer.</a>
<a name="ln54">    /// &lt;/summary&gt;</a>
<a name="ln55">    public int VideoHeight { get; private set; }</a>
<a name="ln56"> </a>
<a name="ln57">    /// &lt;summary&gt;</a>
<a name="ln58">    /// The duration of the video, detected by this video importer.</a>
<a name="ln59">    /// &lt;/summary&gt;</a>
<a name="ln60">    public TimeSpan Duration { get; set; }</a>
<a name="ln61"> </a>
<a name="ln62">    /// &lt;summary&gt;</a>
<a name="ln63">    /// The imported frame list.</a>
<a name="ln64">    /// &lt;/summary&gt;</a>
<a name="ln65">    public List&lt;FrameInfo&gt; Frames { get; set; }</a>
<a name="ln66"> </a>
<a name="ln67">    /// &lt;summary&gt;</a>
<a name="ln68">    /// The delay of each frame.</a>
<a name="ln69">    /// &lt;/summary&gt;</a>
<a name="ln70">    public int Delay { get; set; }</a>
<a name="ln71"> </a>
<a name="ln72">    /// &lt;summary&gt;</a>
<a name="ln73">    /// The scale of the frame.</a>
<a name="ln74">    /// &lt;/summary&gt;</a>
<a name="ln75">    private double Scale { get; set; }</a>
<a name="ln76"> </a>
<a name="ln77">    #endregion</a>
<a name="ln78"> </a>
<a name="ln79">    public VideoSource()</a>
<a name="ln80">    {</a>
<a name="ln81">        InitializeComponent();</a>
<a name="ln82">    }</a>
<a name="ln83"> </a>
<a name="ln84">    #region Events</a>
<a name="ln85"> </a>
<a name="ln86">    private async void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln87">    {</a>
<a name="ln88">        await LoadPreview();</a>
<a name="ln89">    }</a>
<a name="ln90"> </a>
<a name="ln91">    private async void ImporterComboBox_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)</a>
<a name="ln92">    {</a>
<a name="ln93">        if (!IsLoaded)</a>
<a name="ln94">            return;</a>
<a name="ln95"> </a>
<a name="ln96">        //Load the previewers using the selected importer.</a>
<a name="ln97">        await LoadPreview();</a>
<a name="ln98">    }</a>
<a name="ln99"> </a>
<a name="ln100">    private async void MediaPlayer_MediaOpened(object sender, EventArgs e)</a>
<a name="ln101">    {</a>
<a name="ln102">        await WhenBothLoaded();</a>
<a name="ln103">    }</a>
<a name="ln104"> </a>
<a name="ln105">    private void MediaPlayer_MediaFailed(object sender, ExceptionEventArgs e)</a>
<a name="ln106">    {</a>
<a name="ln107">        FaultLoading(e.ErrorException);</a>
<a name="ln108">    }</a>
<a name="ln109"> </a>
<a name="ln110">    private void SelectionSlider_LowerValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln111">    {</a>
<a name="ln112">        StartIntegerUpDown.Value = Convert.ToInt32(SelectionSlider.LowerValue);</a>
<a name="ln113"> </a>
<a name="ln114">        MeasureDuration();</a>
<a name="ln115">        FrameCountTextBlock.Text = CountFrames().ToString();</a>
<a name="ln116">    }</a>
<a name="ln117"> </a>
<a name="ln118">    private void SelectionSlider_UpperValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln119">    {</a>
<a name="ln120">        EndIntegerUpDown.Value = Convert.ToInt32(SelectionSlider.UpperValue);</a>
<a name="ln121"> </a>
<a name="ln122">        MeasureDuration();</a>
<a name="ln123">        FrameCountTextBlock.Text = CountFrames().ToString();</a>
<a name="ln124">    }</a>
<a name="ln125"> </a>
<a name="ln126">    private async void StartIntegerUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln127">    {</a>
<a name="ln128">        if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln129">        {</a>
<a name="ln130">            _lowerPlayer.Position = TimeSpan.FromMilliseconds(SelectionSlider.LowerValue);</a>
<a name="ln131">            return;</a>
<a name="ln132">        }</a>
<a name="ln133"> </a>
<a name="ln134">        if (SelectionSlider.IsMouseCaptureWithin)</a>
<a name="ln135">            return;</a>
<a name="ln136"> </a>
<a name="ln137">        Cursor = Cursors.AppStarting;</a>
<a name="ln138">        await RenderPreview();</a>
<a name="ln139">        Cursor = Cursors.Arrow;</a>
<a name="ln140">    }</a>
<a name="ln141"> </a>
<a name="ln142">    private async void EndIntegerUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln143">    {</a>
<a name="ln144">        if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln145">        {</a>
<a name="ln146">            _upperPlayer.Position = TimeSpan.FromMilliseconds(SelectionSlider.UpperValue);</a>
<a name="ln147">            return;</a>
<a name="ln148">        }</a>
<a name="ln149"> </a>
<a name="ln150">        if (SelectionSlider.IsMouseCaptureWithin)</a>
<a name="ln151">            return;</a>
<a name="ln152"> </a>
<a name="ln153">        Cursor = Cursors.AppStarting;</a>
<a name="ln154">        await RenderPreview(false);</a>
<a name="ln155">        Cursor = Cursors.Arrow;</a>
<a name="ln156">    }</a>
<a name="ln157"> </a>
<a name="ln158">    private async void SelectionSlider_PreviewMouseUp(object sender, MouseButtonEventArgs e)</a>
<a name="ln159">    {</a>
<a name="ln160">        Cursor = Cursors.AppStarting;</a>
<a name="ln161">        await RenderPreview();</a>
<a name="ln162">        await RenderPreview(false);</a>
<a name="ln163">        Cursor = Cursors.Arrow;</a>
<a name="ln164">    }</a>
<a name="ln165"> </a>
<a name="ln166">    private void ScaleNumericUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln167">    {</a>
<a name="ln168">        var height = Convert.ToInt32(VideoHeight * (ScaleIntegerUpDown.Value / 100D));</a>
<a name="ln169">        var width = Convert.ToInt32(VideoWidth * (ScaleIntegerUpDown.Value / 100D));</a>
<a name="ln170"> </a>
<a name="ln171">        HeightTextBlock.Text = height.ToString(&quot;d&quot;, CultureInfo.CurrentUICulture);</a>
<a name="ln172">        WidthTextBlock.Text = width.ToString(&quot;d&quot;, CultureInfo.CurrentUICulture);</a>
<a name="ln173">    }</a>
<a name="ln174"> </a>
<a name="ln175">    private void FpsIntegerUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln176">    {</a>
<a name="ln177">        FrameCountTextBlock.Text = CountFrames().ToString();</a>
<a name="ln178">    }</a>
<a name="ln179"> </a>
<a name="ln180">    private async void LowerPlayer_Changed(object sender, EventArgs e)</a>
<a name="ln181">    {</a>
<a name="ln182">        if (!IsLoaded)</a>
<a name="ln183">            return;</a>
<a name="ln184"> </a>
<a name="ln185">        Cursor = Cursors.AppStarting;</a>
<a name="ln186">        await RenderPreview();</a>
<a name="ln187">        Cursor = Cursors.Arrow;</a>
<a name="ln188">    }</a>
<a name="ln189"> </a>
<a name="ln190">    private async void UpperPlayer_Changed(object sender, EventArgs e)</a>
<a name="ln191">    {</a>
<a name="ln192">        if (!IsLoaded)</a>
<a name="ln193">            return;</a>
<a name="ln194"> </a>
<a name="ln195">        Cursor = Cursors.AppStarting;</a>
<a name="ln196">        await RenderPreview(false);</a>
<a name="ln197">        Cursor = Cursors.Arrow;</a>
<a name="ln198">    }</a>
<a name="ln199"> </a>
<a name="ln200">    private void CapturePlayer_Changed(object sender, EventArgs e)</a>
<a name="ln201">    {</a>
<a name="ln202">        Dispatcher?.Invoke(ImportAndSeek);</a>
<a name="ln203">    }</a>
<a name="ln204"> </a>
<a name="ln205">    private async void OkButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln206">    {</a>
<a name="ln207">        if (CountFrames() == 0)</a>
<a name="ln208">        {</a>
<a name="ln209">            StatusBand.Warning(LocalizationHelper.Get(&quot;S.ImportVideo.Nothing&quot;));</a>
<a name="ln210">            return;</a>
<a name="ln211">        }</a>
<a name="ln212"> </a>
<a name="ln213">        Scale = ScaleIntegerUpDown.Value * 0.01f;</a>
<a name="ln214">        Delay = 1000 / FpsIntegerUpDown.Value;</a>
<a name="ln215">        VideoWidth = (int)Math.Round(VideoWidth * Scale);</a>
<a name="ln216">        VideoHeight = (int)Math.Round(VideoHeight * Scale);</a>
<a name="ln217">        Frames = new List&lt;FrameInfo&gt;();</a>
<a name="ln218"> </a>
<a name="ln219">        Splitter.Visibility = Visibility.Collapsed;</a>
<a name="ln220">        DetailsGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln221">        SelectionSlider.IsEnabled = false;</a>
<a name="ln222">        OkButton.IsEnabled = false;</a>
<a name="ln223">        StatusLabel.Visibility = Visibility.Visible;</a>
<a name="ln224">        CaptureProgressBar.Visibility = Visibility.Visible;</a>
<a name="ln225">        MinHeight = Height;</a>
<a name="ln226">        SizeToContent = SizeToContent.Manual;</a>
<a name="ln227"> </a>
<a name="ln228">        GC.Collect();</a>
<a name="ln229"> </a>
<a name="ln230">        if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln231">        {</a>
<a name="ln232">            //Calculate all positions.</a>
<a name="ln233">            for (var span = SelectionSlider.LowerValue + Delay; span &lt;= SelectionSlider.UpperValue; span += Delay)</a>
<a name="ln234">                _positions.Enqueue(TimeSpan.FromMilliseconds(span));</a>
<a name="ln235"> </a>
<a name="ln236">            CaptureProgressBar.Value = 0;</a>
<a name="ln237">            CaptureProgressBar.Maximum = _positions.Count;</a>
<a name="ln238"> </a>
<a name="ln239">            if (_wasPreviewChangedRegistered)</a>
<a name="ln240">            {</a>
<a name="ln241">                _lowerPlayer.Changed -= LowerPlayer_Changed;</a>
<a name="ln242">                _upperPlayer.Changed -= UpperPlayer_Changed;</a>
<a name="ln243">                _wasPreviewChangedRegistered = false;</a>
<a name="ln244">            }</a>
<a name="ln245"> </a>
<a name="ln246">            if (!_wasCaptureChangedRegistered)</a>
<a name="ln247">            {</a>
<a name="ln248">                _lowerPlayer.Changed += CapturePlayer_Changed;</a>
<a name="ln249">                _wasCaptureChangedRegistered = true;</a>
<a name="ln250">            }</a>
<a name="ln251"> </a>
<a name="ln252">            //Resize the rendering to fit in the selected scale. With this code, the preview stops working.</a>
<a name="ln253">            _lowerRenderTargetBitmap = new RenderTargetBitmap(VideoWidth, VideoHeight, 96, 96, PixelFormats.Pbgra32);</a>
<a name="ln254"> </a>
<a name="ln255">            ImportAndSeek();</a>
<a name="ln256">        }</a>
<a name="ln257">        else</a>
<a name="ln258">        {</a>
<a name="ln259">            //Import via ffmpeg.</a>
<a name="ln260">            await GetMultipleScreencaps();</a>
<a name="ln261">        }</a>
<a name="ln262">    }</a>
<a name="ln263"> </a>
<a name="ln264">    private void CancelButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln265">    {</a>
<a name="ln266">        _cancelled = true;</a>
<a name="ln267"> </a>
<a name="ln268">        #region Erase data</a>
<a name="ln269"> </a>
<a name="ln270">        try</a>
<a name="ln271">        {</a>
<a name="ln272">            if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln273">            {</a>
<a name="ln274">                if (Frames != null)</a>
<a name="ln275">                    foreach (var frame in Frames.Where(frame =&gt; File.Exists(frame.Path)))</a>
<a name="ln276">                        File.Delete(frame.Path);</a>
<a name="ln277">            }</a>
<a name="ln278">            else</a>
<a name="ln279">            {</a>
<a name="ln280">                _process?.Kill();</a>
<a name="ln281"> </a>
<a name="ln282">                ClearImportFolder(Path.Combine(RootFolder, &quot;Import&quot;));</a>
<a name="ln283">            }</a>
<a name="ln284">        }</a>
<a name="ln285">        catch (Exception ex)</a>
<a name="ln286">        {</a>
<a name="ln287">            LogWriter.Log(ex, &quot;Impossible to delete imported frames when canceling the import.&quot;);</a>
<a name="ln288">        }</a>
<a name="ln289"> </a>
<a name="ln290">        #endregion</a>
<a name="ln291"> </a>
<a name="ln292">        Frames?.Clear();</a>
<a name="ln293">        GC.Collect();</a>
<a name="ln294"> </a>
<a name="ln295">        DialogResult = false;</a>
<a name="ln296">    }</a>
<a name="ln297"> </a>
<a name="ln298">    private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)</a>
<a name="ln299">    {</a>
<a name="ln300">        _lowerPlayer?.Close();</a>
<a name="ln301">        _upperPlayer?.Close();</a>
<a name="ln302">        _process?.Dispose();</a>
<a name="ln303"> </a>
<a name="ln304">        _lowerPlayer = null;</a>
<a name="ln305">        _upperPlayer = null;</a>
<a name="ln306">        _process = null;</a>
<a name="ln307"> </a>
<a name="ln308">        GC.Collect();</a>
<a name="ln309">    }</a>
<a name="ln310"> </a>
<a name="ln311">    #endregion</a>
<a name="ln312"> </a>
<a name="ln313">    #region Methods</a>
<a name="ln314"> </a>
<a name="ln315">    private async Task LoadPreview()</a>
<a name="ln316">    {</a>
<a name="ln317">        StatusBand.Hide();</a>
<a name="ln318"> </a>
<a name="ln319">        //Disable the UI when loading.</a>
<a name="ln320">        Cursor = Cursors.AppStarting;</a>
<a name="ln321">        ImporterComboBox.IsEnabled = false;</a>
<a name="ln322">        DetailsGrid.IsEnabled = false;</a>
<a name="ln323">        SelectionSlider.IsEnabled = false;</a>
<a name="ln324">        OkButton.IsEnabled = false;</a>
<a name="ln325">        PreviewerGrid.Opacity = 0;</a>
<a name="ln326">        LoadingLabel.Visibility = Visibility.Visible;</a>
<a name="ln327">        DetailsGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln328"> </a>
<a name="ln329">        LowerSelectionImage.Source = null;</a>
<a name="ln330">        UpperSelectionImage.Source = null;</a>
<a name="ln331">        VideoWidth = 0;</a>
<a name="ln332">        VideoHeight = 0;</a>
<a name="ln333">        Duration = TimeSpan.Zero;</a>
<a name="ln334">        _previewerReady = 0;</a>
<a name="ln335"> </a>
<a name="ln336">        //If trying to use FFmpeg, check if it's possible.</a>
<a name="ln337">        if (UserSettings.All.VideoImporter == 1)</a>
<a name="ln338">        {</a>
<a name="ln339">            if (!Util.Other.IsFfmpegPresent())</a>
<a name="ln340">            {</a>
<a name="ln341">                StatusBand.Warning(LocalizationHelper.Get(&quot;S.Editor.Warning.Ffmpeg&quot;), () =&gt; App.MainViewModel.OpenOptions.Execute(Options.ExtrasIndex));</a>
<a name="ln342">                FaultLoading();</a>
<a name="ln343">                return;</a>
<a name="ln344">            }</a>
<a name="ln345">        }</a>
<a name="ln346"> </a>
<a name="ln347">        var log = &quot;&quot;;</a>
<a name="ln348"> </a>
<a name="ln349">        try</a>
<a name="ln350">        {</a>
<a name="ln351">            if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln352">            {</a>
<a name="ln353">                log += &quot;Video path: &quot; + VideoPath;</a>
<a name="ln354"> </a>
<a name="ln355">                //Unregister all events.</a>
<a name="ln356">                _upperPlayer.MediaOpened -= MediaPlayer_MediaOpened;</a>
<a name="ln357">                _upperPlayer.MediaFailed -= MediaPlayer_MediaFailed;</a>
<a name="ln358">                _lowerPlayer.MediaOpened -= MediaPlayer_MediaOpened;</a>
<a name="ln359">                _lowerPlayer.MediaFailed -= MediaPlayer_MediaFailed;</a>
<a name="ln360"> </a>
<a name="ln361">                if (_wasPreviewChangedRegistered)</a>
<a name="ln362">                {</a>
<a name="ln363">                    _lowerPlayer.Changed -= LowerPlayer_Changed;</a>
<a name="ln364">                    _upperPlayer.Changed -= UpperPlayer_Changed;</a>
<a name="ln365">                    _wasPreviewChangedRegistered = false;</a>
<a name="ln366">                }</a>
<a name="ln367"> </a>
<a name="ln368">                if (_wasCaptureChangedRegistered)</a>
<a name="ln369">                {</a>
<a name="ln370">                    _lowerPlayer.Changed -= CapturePlayer_Changed;</a>
<a name="ln371">                    _wasCaptureChangedRegistered = false;</a>
<a name="ln372">                }</a>
<a name="ln373"> </a>
<a name="ln374">                var previous = _upperPlayer.Source?.AbsoluteUri;</a>
<a name="ln375"> </a>
<a name="ln376">                _upperPlayer.MediaOpened += MediaPlayer_MediaOpened;</a>
<a name="ln377">                _upperPlayer.MediaFailed += MediaPlayer_MediaFailed;</a>
<a name="ln378">                _lowerPlayer.MediaOpened += MediaPlayer_MediaOpened;</a>
<a name="ln379">                _lowerPlayer.MediaFailed += MediaPlayer_MediaFailed;</a>
<a name="ln380"> </a>
<a name="ln381">                if (!string.IsNullOrWhiteSpace(previous) &amp;&amp; previous == new Uri(VideoPath).AbsoluteUri)</a>
<a name="ln382">                {</a>
<a name="ln383">                    //Same video as before.</a>
<a name="ln384">                    _previewerReady = 2;</a>
<a name="ln385">                    await WhenBothLoaded();</a>
<a name="ln386">                }</a>
<a name="ln387">                else</a>
<a name="ln388">                {</a>
<a name="ln389">                    //Open the same video file in both players.</a>
<a name="ln390">                    _upperPlayer.Open(new Uri(VideoPath));</a>
<a name="ln391">                    _upperPlayer.Pause();</a>
<a name="ln392">                    _lowerPlayer.Open(new Uri(VideoPath));</a>
<a name="ln393">                    _lowerPlayer.Pause();</a>
<a name="ln394">                }</a>
<a name="ln395">            }</a>
<a name="ln396">            else</a>
<a name="ln397">            {</a>
<a name="ln398">                await GetVideoDetails();</a>
<a name="ln399">                await SuccessLoading();</a>
<a name="ln400">            }</a>
<a name="ln401">        }</a>
<a name="ln402">        catch (Exception ex)</a>
<a name="ln403">        {</a>
<a name="ln404">            LogWriter.Log(ex, &quot;Impossible to load the previewers&quot;, log);</a>
<a name="ln405"> </a>
<a name="ln406">            FaultLoading(ex);</a>
<a name="ln407">        }</a>
<a name="ln408">    }</a>
<a name="ln409"> </a>
<a name="ln410">    private async Task GetVideoDetails()</a>
<a name="ln411">    {</a>
<a name="ln412">        var process = new ProcessStartInfo(UserSettings.All.FfmpegLocation)</a>
<a name="ln413">        {</a>
<a name="ln414">            Arguments = $&quot; -i \&quot;{VideoPath}\&quot; -hide_banner&quot;,</a>
<a name="ln415">            CreateNoWindow = true,</a>
<a name="ln416">            ErrorDialog = false,</a>
<a name="ln417">            UseShellExecute = false,</a>
<a name="ln418">            RedirectStandardError = true,</a>
<a name="ln419">            RedirectStandardOutput = true</a>
<a name="ln420">        };</a>
<a name="ln421"> </a>
<a name="ln422">        var log = &quot;Arguments: &quot; + process.Arguments + Environment.NewLine;</a>
<a name="ln423"> </a>
<a name="ln424">        string response;</a>
<a name="ln425">        using (var pro = await Task.Run(() =&gt; Process.Start(process)))</a>
<a name="ln426">        {</a>
<a name="ln427">            if (pro == null)</a>
<a name="ln428">                throw new Exception(&quot;It was not possible to start the FFmpeg process.&quot; + log);</a>
<a name="ln429"> </a>
<a name="ln430">            //Read all output data.</a>
<a name="ln431">            response = await pro.StandardError.ReadToEndAsync();</a>
<a name="ln432">        }</a>
<a name="ln433"> </a>
<a name="ln434">        /*</a>
<a name="ln435">           Input #0, mov,mp4,m4a,3gp,3g2,mj2, from 'C:\Users\user\Desktop\example.mp4':</a>
<a name="ln436">           Metadata:</a>
<a name="ln437">           major_brand     : mp42</a>
<a name="ln438">           minor_version   : 0</a>
<a name="ln439">           compatible_brands: isomavc1mp42</a>
<a name="ln440">           creation_time   : 2010-03-15T22:51:17.000000Z</a>
<a name="ln441">           Duration: 00:01:02.58, start: 0.000000, bitrate: 589 kb/s</a>
<a name="ln442">           Stream #0:0(und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, stereo, fltp, 104 kb/s (default)</a>
<a name="ln443">           Metadata:</a>
<a name="ln444">           creation_time   : 2010-03-15T22:51:17.000000Z</a>
<a name="ln445">           handler_name    : (C) 2007 Google Inc. v08.13.2007.</a>
<a name="ln446">           Stream #0:1(und): Video: h264 (Constrained Baseline) (avc1 / 0x31637661), yuv420p, 480x360 [SAR 1:1 DAR 4:3], 487 kb/s, 15 fps, 15 tbr, 15002 tbn, 30 tbc (default)</a>
<a name="ln447">           Metadata:</a>
<a name="ln448">           creation_time   : 2010-03-15T22:51:17.000000Z</a>
<a name="ln449">           handler_name    : (C) 2007 Google Inc. v08.13.2007.</a>
<a name="ln450">           At least one output file must be specified</a>
<a name="ln451">         */</a>
<a name="ln452"> </a>
<a name="ln453">        /*</a>
<a name="ln454">            Arguments:  -i &quot;C:\Users\user\Desktop\example.mp4&quot; -hide_banner</a>
<a name="ln455">            Response: Input #0, mov,mp4,m4a,3gp,3g2,mj2, from 'C:\Users\nicke\Desktop\RPReplay_Final1600052642.MP4':</a>
<a name="ln456">              Metadata:</a>
<a name="ln457">                major_brand     : mp42</a>
<a name="ln458">                minor_version   : 1</a>
<a name="ln459">                compatible_brands: isommp41mp42</a>
<a name="ln460">                creation_time   : 2020-09-14T03:04:02.000000Z</a>
<a name="ln461">              Duration: 00:00:09.30, start: 0.000000, bitrate: 18391 kb/s</a>
<a name="ln462">                Stream #0:0(und): Audio: aac (LC) (mp4a / 0x6134706D), 44100 Hz, stereo, fltp, 2 kb/s (default)</a>
<a name="ln463">                Metadata:</a>
<a name="ln464">                  creation_time   : 2020-09-14T03:04:02.000000Z</a>
<a name="ln465">                  handler_name    : Core Media Audio</a>
<a name="ln466">                Stream #0:1(und): Video: h264 (High) (avc1 / 0x31637661), yuvj420p(pc, bt709/bt709/unknown), 1440x1920, 18383 kb/s, 59.14 fps, 60 tbr, 600 tbn, 1200 tbc (default)</a>
<a name="ln467">                Metadata:</a>
<a name="ln468">                  rotate          : 270</a>
<a name="ln469">                  creation_time   : 2020-09-14T03:04:02.000000Z</a>
<a name="ln470">                  handler_name    : Core Media Video</a>
<a name="ln471">                Side data:</a>
<a name="ln472">                  displaymatrix: rotation of 90.00 degrees</a>
<a name="ln473">            At least one output file must be specified</a>
<a name="ln474">        */</a>
<a name="ln475"> </a>
<a name="ln476">        log += &quot;Response: &quot; + response + Environment.NewLine;</a>
<a name="ln477"> </a>
<a name="ln478">        //Tries to find the line which shows the video stream details. TODO: What happens if there's more than 1 video stream?</a>
<a name="ln479">        var lineRegex = new Regex(&quot;.*(Stream.\\#).*(Video\\:).*&quot;, RegexOptions.IgnoreCase | RegexOptions.Compiled);</a>
<a name="ln480">        var linesFound = lineRegex.Matches(response);</a>
<a name="ln481"> </a>
<a name="ln482">        if (linesFound.Count == 0)</a>
<a name="ln483">            throw new Exception(&quot;No video stream found.&quot; + log);</a>
<a name="ln484"> </a>
<a name="ln485">        //Tries to find the part which tells the resolution.</a>
<a name="ln486">        var resolutionRegex = new Regex(&quot;[0-9]{2,4}x[0-9]{2,4}\\w+&quot;, RegexOptions.IgnoreCase | RegexOptions.Compiled);</a>
<a name="ln487">        var resolutionsFound = resolutionRegex.Matches(linesFound[0].Value);</a>
<a name="ln488"> </a>
<a name="ln489">        if (resolutionsFound.Count == 0)</a>
<a name="ln490">            throw new Exception(&quot;No video resolution found.&quot; + log);</a>
<a name="ln491"> </a>
<a name="ln492">        //Tries to find the line which shows the video rotation.</a>
<a name="ln493">        var rotationRegex = new Regex(&quot;.*(rotate          : ).*&quot;, RegexOptions.IgnoreCase | RegexOptions.Compiled);</a>
<a name="ln494">        var linesFound2 = rotationRegex.Matches(response);</a>
<a name="ln495">        var isRotated = linesFound2.Count &gt; 0 &amp;&amp; (linesFound2[0].Value.Contains(&quot;90&quot;) || linesFound2[0].Value.Contains(&quot;270&quot;));</a>
<a name="ln496"> </a>
<a name="ln497">        //Tries to find the line which shows the video stream details.</a>
<a name="ln498">        var durationRegex = new Regex(&quot;.*(Duration: ).*&quot;, RegexOptions.IgnoreCase | RegexOptions.Compiled);</a>
<a name="ln499">        var linesFound3 = durationRegex.Matches(response);</a>
<a name="ln500"> </a>
<a name="ln501">        if (linesFound3.Count == 0)</a>
<a name="ln502">            throw new Exception(&quot;No video duration found.&quot; + log);</a>
<a name="ln503"> </a>
<a name="ln504">        //Tried to find the total time of the video.</a>
<a name="ln505">        var timingRegex = new Regex(&quot;[0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2}(\\.[0-9]{1,2})?&quot;, RegexOptions.IgnoreCase | RegexOptions.Compiled);</a>
<a name="ln506">        var timingsFound = timingRegex.Matches(linesFound3[0].Value);</a>
<a name="ln507"> </a>
<a name="ln508">        if (timingsFound.Count == 0)</a>
<a name="ln509">            throw new Exception(&quot;No video timing found.&quot; + log);</a>
<a name="ln510"> </a>
<a name="ln511">        var size = resolutionsFound[0].Value.Split('x');</a>
<a name="ln512"> </a>
<a name="ln513">        VideoWidth = Convert.ToInt32(size[isRotated ? 1 : 0]);</a>
<a name="ln514">        VideoHeight = Convert.ToInt32(size[isRotated ? 0 : 1]);</a>
<a name="ln515">        Duration = TimeSpan.ParseExact(timingsFound[0].Value, &quot;hh\\:mm\\:ss\\.ff&quot;, CultureInfo.InvariantCulture);</a>
<a name="ln516"> </a>
<a name="ln517">        //Trim the video a bit, just to make sure that we'll get the frame at the end.</a>
<a name="ln518">        if (Duration &gt; TimeSpan.Zero &amp;&amp; Duration.TotalMilliseconds &gt; 1000)</a>
<a name="ln519">            Duration = Duration.Subtract(TimeSpan.FromMilliseconds(100));</a>
<a name="ln520">    }</a>
<a name="ln521"> </a>
<a name="ln522">    private async Task WhenBothLoaded()</a>
<a name="ln523">    {</a>
<a name="ln524">        lock (_lock)</a>
<a name="ln525">        {</a>
<a name="ln526">            //Wait for both media players to load, ensuring that only one at time can enter this code block.</a>
<a name="ln527">            _previewerReady++;</a>
<a name="ln528"> </a>
<a name="ln529">            if (_previewerReady &lt;= 1)</a>
<a name="ln530">                return;</a>
<a name="ln531">        }</a>
<a name="ln532"> </a>
<a name="ln533">        //Get video details.</a>
<a name="ln534">        if (_lowerPlayer.NaturalVideoWidth &gt; 0 &amp;&amp; _lowerPlayer.NaturalVideoHeight &gt; 0)</a>
<a name="ln535">        {</a>
<a name="ln536">            VideoWidth = _lowerPlayer.NaturalVideoWidth;</a>
<a name="ln537">            VideoHeight = _lowerPlayer.NaturalVideoHeight;</a>
<a name="ln538">        }</a>
<a name="ln539"> </a>
<a name="ln540">        Duration = _lowerPlayer.NaturalDuration.HasTimeSpan ? _lowerPlayer.NaturalDuration.TimeSpan : TimeSpan.Zero;</a>
<a name="ln541"> </a>
<a name="ln542">        //If it was not possible to load the video, warn the user.</a>
<a name="ln543">        if (VideoWidth &lt;= 10 || VideoHeight &lt;= 10 || Duration.TotalMilliseconds &lt;= 10)</a>
<a name="ln544">        {</a>
<a name="ln545">            FaultLoading();</a>
<a name="ln546">            return;</a>
<a name="ln547">        }</a>
<a name="ln548"> </a>
<a name="ln549">        //Events used to show the actual frames.</a>
<a name="ln550">        _lowerPlayer.Changed += LowerPlayer_Changed;</a>
<a name="ln551">        _upperPlayer.Changed += UpperPlayer_Changed;</a>
<a name="ln552">        _wasPreviewChangedRegistered = true;</a>
<a name="ln553"> </a>
<a name="ln554">        //If the video was loaded successfully.</a>
<a name="ln555">        await SuccessLoading();</a>
<a name="ln556">    }</a>
<a name="ln557"> </a>
<a name="ln558">    /// &lt;summary&gt;</a>
<a name="ln559">    /// If the previewers loading went okay.</a>
<a name="ln560">    /// &lt;/summary&gt;</a>
<a name="ln561">    private async Task SuccessLoading()</a>
<a name="ln562">    {</a>
<a name="ln563">        //Size Labels</a>
<a name="ln564">        WidthTextBlock.Text = VideoWidth.ToString(&quot;d&quot;, CultureInfo.CurrentUICulture);</a>
<a name="ln565">        HeightTextBlock.Text = VideoHeight.ToString(&quot;d&quot;, CultureInfo.CurrentUICulture);</a>
<a name="ln566"> </a>
<a name="ln567">        LowerSelectionImage.Source = _lowerRenderTargetBitmap = new RenderTargetBitmap(VideoWidth, VideoHeight, 96, 96, PixelFormats.Pbgra32);</a>
<a name="ln568">        UpperSelectionImage.Source = _upperRenderTargetBitmap = new RenderTargetBitmap(VideoWidth, VideoHeight, 96, 96, PixelFormats.Pbgra32);</a>
<a name="ln569"> </a>
<a name="ln570">        SelectionSlider.Maximum = Duration.TotalMilliseconds;</a>
<a name="ln571">        SelectionSlider.LowerValue = 0;</a>
<a name="ln572">        SelectionSlider.UpperValue = SelectionSlider.Maximum;</a>
<a name="ln573"> </a>
<a name="ln574">        //Refresh the first previewer manually, since it initially stays at the first frame.</a>
<a name="ln575">        await RenderPreview();</a>
<a name="ln576"> </a>
<a name="ln577">        if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln578">            await RenderPreview(false);</a>
<a name="ln579"> </a>
<a name="ln580">        //Update the UI.</a>
<a name="ln581">        Cursor = Cursors.Arrow;</a>
<a name="ln582">        ImporterComboBox.IsEnabled = true;</a>
<a name="ln583">        DetailsGrid.IsEnabled = true;</a>
<a name="ln584">        SelectionSlider.IsEnabled = true;</a>
<a name="ln585">        OkButton.IsEnabled = true;</a>
<a name="ln586">        PreviewerGrid.Opacity = 1;</a>
<a name="ln587">        LoadingLabel.Visibility = Visibility.Collapsed;</a>
<a name="ln588">        DetailsGrid.Visibility = Visibility.Visible;</a>
<a name="ln589"> </a>
<a name="ln590">        MinWidth = Width;</a>
<a name="ln591">    }</a>
<a name="ln592"> </a>
<a name="ln593">    /// &lt;summary&gt;</a>
<a name="ln594">    /// If the previewers loading went wrong.</a>
<a name="ln595">    /// &lt;/summary&gt;</a>
<a name="ln596">    private void FaultLoading(Exception ex = null)</a>
<a name="ln597">    {</a>
<a name="ln598">        Cursor = Cursors.Arrow;</a>
<a name="ln599">        ImporterComboBox.IsEnabled = true;</a>
<a name="ln600">        LoadingLabel.Visibility = Visibility.Collapsed;</a>
<a name="ln601"> </a>
<a name="ln602">        if (ex != null &amp;&amp; !_isDisplayingError)</a>
<a name="ln603">        {</a>
<a name="ln604">            _isDisplayingError = true;</a>
<a name="ln605">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.ImportVideo.Error&quot;), LocalizationHelper.Get(&quot;S.ImportVideo.Error.Detail&quot;), ex);</a>
<a name="ln606">            _isDisplayingError = false;</a>
<a name="ln607">        }</a>
<a name="ln608">    }</a>
<a name="ln609"> </a>
<a name="ln610">    private async Task RenderPreview(bool lower = true)</a>
<a name="ln611">    {</a>
<a name="ln612">        try</a>
<a name="ln613">        {</a>
<a name="ln614">            StatusBand.Hide();</a>
<a name="ln615"> </a>
<a name="ln616">            var drawingVisual = new DrawingVisual();</a>
<a name="ln617"> </a>
<a name="ln618">            if (lower)</a>
<a name="ln619">            {</a>
<a name="ln620">                using (var dc = drawingVisual.RenderOpen())</a>
<a name="ln621">                {</a>
<a name="ln622">                    if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln623">                        dc.DrawVideo(_lowerPlayer, new Rect(0, 0, _lowerPlayer.NaturalVideoWidth, _lowerPlayer.NaturalVideoHeight));</a>
<a name="ln624">                    else</a>
<a name="ln625">                    {</a>
<a name="ln626">                        //Capture image from FFmpeg.</a>
<a name="ln627">                        var image = await GetScreencap();</a>
<a name="ln628"> </a>
<a name="ln629">                        //Render image in target.</a>
<a name="ln630">                        if (image != null)</a>
<a name="ln631">                            dc.DrawImage(image, new Rect(0, 0, VideoWidth, VideoHeight));</a>
<a name="ln632">                    }</a>
<a name="ln633">                }</a>
<a name="ln634"> </a>
<a name="ln635">                lock (_lock)</a>
<a name="ln636">                    _lowerRenderTargetBitmap.Render(drawingVisual);</a>
<a name="ln637">                return;</a>
<a name="ln638">            }</a>
<a name="ln639"> </a>
<a name="ln640">            using (var dc = drawingVisual.RenderOpen())</a>
<a name="ln641">            {</a>
<a name="ln642">                if (UserSettings.All.VideoImporter == 0)</a>
<a name="ln643">                    dc.DrawVideo(_upperPlayer, new Rect(0, 0, _upperPlayer.NaturalVideoWidth, _upperPlayer.NaturalVideoHeight));</a>
<a name="ln644">                else</a>
<a name="ln645">                {</a>
<a name="ln646">                    //Capture image from FFmpeg.</a>
<a name="ln647">                    var image = await GetScreencap(false);</a>
<a name="ln648"> </a>
<a name="ln649">                    //Render image in target.</a>
<a name="ln650">                    if (image != null)</a>
<a name="ln651">                        dc.DrawImage(image, new Rect(0, 0, VideoWidth, VideoHeight));</a>
<a name="ln652">                }</a>
<a name="ln653">            }</a>
<a name="ln654"> </a>
<a name="ln655">            lock (_lock)</a>
<a name="ln656">                _upperRenderTargetBitmap.Render(drawingVisual);</a>
<a name="ln657">        }</a>
<a name="ln658">        catch (TimeoutException t)</a>
<a name="ln659">        {</a>
<a name="ln660">            LogWriter.Log(t, &quot;Impossible to get the preview of the video.&quot;);</a>
<a name="ln661">            StatusBand.Warning(LocalizationHelper.Get(&quot;S.ImportVideo.Timeout&quot;));</a>
<a name="ln662">        }</a>
<a name="ln663">        catch (Exception e)</a>
<a name="ln664">        {</a>
<a name="ln665">            LogWriter.Log(e, &quot;Impossible to get the preview of the video.&quot;);</a>
<a name="ln666">            StatusBand.Error(LocalizationHelper.Get(&quot;S.ImportVideo.Error&quot;));</a>
<a name="ln667">        }</a>
<a name="ln668">    }</a>
<a name="ln669"> </a>
<a name="ln670">    private async Task&lt;BitmapSource&gt; GetScreencap(bool lower = true, int trial = 0)</a>
<a name="ln671">    {</a>
<a name="ln672">        var time = TimeSpan.FromMilliseconds(lower ? SelectionSlider.LowerValue : SelectionSlider.UpperValue); //01:23:45</a>
<a name="ln673"> </a>
<a name="ln674">        var process = new ProcessStartInfo(UserSettings.All.FfmpegLocation)</a>
<a name="ln675">        {</a>
<a name="ln676">            Arguments = $&quot; -ss {time:hh\\:mm\\:ss\\.fff} -i \&quot;{VideoPath}\&quot; -vframes 1 -hide_banner -c:v png -f image2pipe -&quot;,</a>
<a name="ln677">            CreateNoWindow = true,</a>
<a name="ln678">            ErrorDialog = false,</a>
<a name="ln679">            UseShellExecute = false,</a>
<a name="ln680">            RedirectStandardError = true,</a>
<a name="ln681">            RedirectStandardOutput = true</a>
<a name="ln682">        };</a>
<a name="ln683"> </a>
<a name="ln684">        using (var pro = Process.Start(process))</a>
<a name="ln685">        {</a>
<a name="ln686">            if (pro == null)</a>
<a name="ln687">                throw new Exception(&quot;It was not possible to start the FFmpeg process.&quot;) { HelpLink = process.Arguments };</a>
<a name="ln688"> </a>
<a name="ln689">            var bitmap = new BitmapImage();</a>
<a name="ln690">            bitmap.BeginInit();</a>
<a name="ln691">            bitmap.StreamSource = pro.StandardOutput.BaseStream;</a>
<a name="ln692">            bitmap.CacheOption = BitmapCacheOption.OnLoad;</a>
<a name="ln693">            bitmap.EndInit();</a>
<a name="ln694"> </a>
<a name="ln695">            await Task.Factory.StartNew(() =&gt; pro.WaitForExit(5000));</a>
<a name="ln696"> </a>
<a name="ln697">            if (bitmap.Height &lt; 2 || bitmap.Width &lt; 2)</a>
<a name="ln698">            {</a>
<a name="ln699">                var error = pro.StandardError.EndOfStream ? &quot;&quot; : pro.StandardError.ReadToEnd();</a>
<a name="ln700"> </a>
<a name="ln701">                await Task.Delay(500);</a>
<a name="ln702"> </a>
<a name="ln703">                if (trial &gt; 7)</a>
<a name="ln704">                    throw new TimeoutException(&quot;Too many attempts in getting the frame preview. &quot; + error);</a>
<a name="ln705"> </a>
<a name="ln706">                return await GetScreencap(lower, trial + 1);</a>
<a name="ln707">            }</a>
<a name="ln708"> </a>
<a name="ln709">            return bitmap;</a>
<a name="ln710">        }</a>
<a name="ln711">    }</a>
<a name="ln712"> </a>
<a name="ln713">    private void MeasureDuration()</a>
<a name="ln714">    {</a>
<a name="ln715">        DurationTextBlock.Text = TimeSpan.FromMilliseconds(SelectionSlider.UpperValue - SelectionSlider.LowerValue).ToString(&quot;hh\\:mm\\:ss\\.fff&quot;, CultureInfo.CurrentUICulture);</a>
<a name="ln716">    }</a>
<a name="ln717"> </a>
<a name="ln718">    private int CountFrames()</a>
<a name="ln719">    {</a>
<a name="ln720">        var delay = 1000 / FpsIntegerUpDown.Value;</a>
<a name="ln721">        var timespan = SelectionSlider.UpperValue - SelectionSlider.LowerValue;</a>
<a name="ln722"> </a>
<a name="ln723">        return Convert.ToInt32(timespan / delay);</a>
<a name="ln724">    }</a>
<a name="ln725"> </a>
<a name="ln726">    private void UpdateProgressBar(int valueLeft)</a>
<a name="ln727">    {</a>
<a name="ln728">        CaptureProgressBar.Value = CaptureProgressBar.Maximum - valueLeft;</a>
<a name="ln729">    }</a>
<a name="ln730"> </a>
<a name="ln731">    private void ImportAndSeek()</a>
<a name="ln732">    {</a>
<a name="ln733">        if (_cancelled)</a>
<a name="ln734">            return;</a>
<a name="ln735"> </a>
<a name="ln736">        lock (_lock)</a>
<a name="ln737">        {</a>
<a name="ln738">            var drawingVisual = new DrawingVisual();</a>
<a name="ln739"> </a>
<a name="ln740">            using (var dc = drawingVisual.RenderOpen())</a>
<a name="ln741">                dc.DrawVideo(_lowerPlayer, new Rect(0, 0, VideoWidth, VideoHeight));</a>
<a name="ln742"> </a>
<a name="ln743">            _lowerRenderTargetBitmap.Render(drawingVisual);</a>
<a name="ln744"> </a>
<a name="ln745">            //Create an unique file name.</a>
<a name="ln746">            string fileName;</a>
<a name="ln747">            do</a>
<a name="ln748">                fileName = $&quot;{Frames.Count} {DateTime.Now:yyMMdd-hhmmssffff}.png&quot;;</a>
<a name="ln749">            while (File.Exists(Path.Combine(RootFolder, fileName)));</a>
<a name="ln750"> </a>
<a name="ln751">            //Save the file to disk.</a>
<a name="ln752">            using (var fileStream = new FileStream(Path.Combine(RootFolder, fileName), FileMode.Create))</a>
<a name="ln753">            {</a>
<a name="ln754">                var encoder = new PngBitmapEncoder();</a>
<a name="ln755">                encoder.Frames.Add(BitmapFrame.Create(_lowerRenderTargetBitmap));</a>
<a name="ln756">                encoder.Save(fileStream);</a>
<a name="ln757">            }</a>
<a name="ln758"> </a>
<a name="ln759">            Frames.Add(new FrameInfo</a>
<a name="ln760">            {</a>
<a name="ln761">                Delay = Delay,</a>
<a name="ln762">                Path = Path.Combine(RootFolder, fileName)</a>
<a name="ln763">            });</a>
<a name="ln764">        }</a>
<a name="ln765"> </a>
<a name="ln766">        GC.Collect();</a>
<a name="ln767"> </a>
<a name="ln768">        if (!_cancelled)</a>
<a name="ln769">            SeekNextFrame();</a>
<a name="ln770">    }</a>
<a name="ln771"> </a>
<a name="ln772">    private void SeekNextFrame()</a>
<a name="ln773">    {</a>
<a name="ln774">        //If more frames remain to capture...</a>
<a name="ln775">        if (_positions.Count &gt; 0)</a>
<a name="ln776">        {</a>
<a name="ln777">            //Seek to next position.</a>
<a name="ln778">            //_lowerPlayer.Position = _positions.Dequeue();</a>
<a name="ln779">            Dispatcher?.Invoke(() =&gt;</a>
<a name="ln780">            {</a>
<a name="ln781">                //_lowerPlayer.Changed -= CapturePlayer_Changed;</a>
<a name="ln782">                //_lowerPlayer.Position = TimeSpan.Zero;</a>
<a name="ln783">                //_lowerPlayer.Changed += CapturePlayer_Changed;</a>
<a name="ln784">                _lowerPlayer.Position = _positions.Dequeue();</a>
<a name="ln785">            });</a>
<a name="ln786"> </a>
<a name="ln787">            UpdateProgressBar(_positions.Count);</a>
<a name="ln788">            return;</a>
<a name="ln789">        }</a>
<a name="ln790"> </a>
<a name="ln791">        _lowerPlayer.Changed -= CapturePlayer_Changed;</a>
<a name="ln792">        _lowerPlayer.Close();</a>
<a name="ln793"> </a>
<a name="ln794">        GC.Collect();</a>
<a name="ln795"> </a>
<a name="ln796">        DialogResult = true;</a>
<a name="ln797">    }</a>
<a name="ln798"> </a>
<a name="ln799">    private async Task GetMultipleScreencaps()</a>
<a name="ln800">    {</a>
<a name="ln801">        var start = TimeSpan.FromMilliseconds(SelectionSlider.LowerValue);</a>
<a name="ln802">        var end = TimeSpan.FromMilliseconds(SelectionSlider.UpperValue);</a>
<a name="ln803">        var fps = FpsIntegerUpDown.Value;</a>
<a name="ln804">        var count = CountFrames();</a>
<a name="ln805">        var folder = Path.Combine(RootFolder, &quot;Import&quot;);</a>
<a name="ln806">        var path = Path.Combine(folder, $&quot;%0{count.ToString().Length + 1}d.png&quot;);</a>
<a name="ln807"> </a>
<a name="ln808">        try</a>
<a name="ln809">        {</a>
<a name="ln810">            //Create temporary folder.</a>
<a name="ln811">            if (Directory.Exists(folder))</a>
<a name="ln812">                Directory.Delete(folder, true);</a>
<a name="ln813"> </a>
<a name="ln814">            Directory.CreateDirectory(folder);</a>
<a name="ln815"> </a>
<a name="ln816">            CaptureProgressBar.Value = 0;</a>
<a name="ln817">            CaptureProgressBar.Maximum = count;</a>
<a name="ln818"> </a>
<a name="ln819">            var info = new ProcessStartInfo(UserSettings.All.FfmpegLocation)</a>
<a name="ln820">            {</a>
<a name="ln821">                Arguments = $&quot; -i \&quot;{VideoPath}\&quot; -progress pipe:1 -vf scale={VideoWidth}:{VideoHeight} -ss {start:hh\\:mm\\:ss\\.fff} -to {end:hh\\:mm\\:ss\\.fff} -hide_banner -c:v png -r {fps} -vframes {count} \&quot;{path}\&quot;&quot;,</a>
<a name="ln822">                CreateNoWindow = true,</a>
<a name="ln823">                ErrorDialog = false,</a>
<a name="ln824">                UseShellExecute = false,</a>
<a name="ln825">                RedirectStandardOutput = true,</a>
<a name="ln826">                RedirectStandardError = true</a>
<a name="ln827">            };</a>
<a name="ln828"> </a>
<a name="ln829">            _process = new Process();</a>
<a name="ln830">            _process.OutputDataReceived += (sender, e) =&gt;</a>
<a name="ln831">            {</a>
<a name="ln832">                if (string.IsNullOrEmpty(e.Data))</a>
<a name="ln833">                    return;</a>
<a name="ln834"> </a>
<a name="ln835">                var parsed = e.Data.Split('=');</a>
<a name="ln836"> </a>
<a name="ln837">                switch (parsed[0])</a>
<a name="ln838">                {</a>
<a name="ln839">                    case &quot;frame&quot;:</a>
<a name="ln840">                        Dispatcher?.Invoke(() =&gt; { CaptureProgressBar.Value = Convert.ToDouble(parsed[1]); });</a>
<a name="ln841">                        break;</a>
<a name="ln842"> </a>
<a name="ln843">                    case &quot;progress&quot;:</a>
<a name="ln844">                        if (parsed[1] == &quot;end&quot;)</a>
<a name="ln845">                            GetFiles(folder);</a>
<a name="ln846">                        break;</a>
<a name="ln847">                }</a>
<a name="ln848">            };</a>
<a name="ln849">            </a>
<a name="ln850">            _process.StartInfo = info;</a>
<a name="ln851">            _process.Start();</a>
<a name="ln852">            _process.BeginOutputReadLine();</a>
<a name="ln853">            </a>
<a name="ln854">            await _process.WaitForExitAsync();</a>
<a name="ln855"> </a>
<a name="ln856">            if (_process == null)</a>
<a name="ln857">                return;</a>
<a name="ln858"> </a>
<a name="ln859">            var error = await _process?.StandardError?.ReadToEndAsync();</a>
<a name="ln860"> </a>
<a name="ln861">            if (!string.IsNullOrWhiteSpace(error))</a>
<a name="ln862">                throw new Exception(&quot;Error while capturing frames with FFmpeg.&quot;) { HelpLink = $&quot;Command:\n\r{info.Arguments}\n\rResult:\n\r{error}&quot; };</a>
<a name="ln863"> </a>
<a name="ln864">        }</a>
<a name="ln865">        catch (Exception e)</a>
<a name="ln866">        {</a>
<a name="ln867">            LogWriter.Log(e, &quot;Error importing frames with FFmpeg&quot;);</a>
<a name="ln868">            ClearImportFolder(folder);</a>
<a name="ln869"> </a>
<a name="ln870">            Splitter.Visibility = Visibility.Visible;</a>
<a name="ln871">            DetailsGrid.Visibility = Visibility.Visible;</a>
<a name="ln872">            SelectionSlider.IsEnabled = true;</a>
<a name="ln873">            OkButton.IsEnabled = true;</a>
<a name="ln874">            StatusLabel.Visibility = Visibility.Collapsed;</a>
<a name="ln875">            CaptureProgressBar.Visibility = Visibility.Collapsed;</a>
<a name="ln876"> </a>
<a name="ln877">            StatusBand.Error(LocalizationHelper.Get(&quot;S.ImportVideo.Error&quot;) + Environment.NewLine + e.Message + Environment.NewLine + e.HelpLink);</a>
<a name="ln878">        }</a>
<a name="ln879">    }</a>
<a name="ln880"> </a>
<a name="ln881">    private void GetFiles(string folder)</a>
<a name="ln882">    {</a>
<a name="ln883">        if (Dispatcher?.Invoke&lt;bool&gt;(() =&gt; !IsLoaded) ?? false)</a>
<a name="ln884">            return;</a>
<a name="ln885"> </a>
<a name="ln886">        foreach (var file in Directory.GetFiles(folder, &quot;*.png&quot;))</a>
<a name="ln887">        {</a>
<a name="ln888">            //Create an unique file name.</a>
<a name="ln889">            string newName;</a>
<a name="ln890">            do</a>
<a name="ln891">                newName = Path.Combine(RootFolder, $&quot;{Frames.Count} {DateTime.Now:yyMMdd-hhmmssffff}.png&quot;);</a>
<a name="ln892">            while (File.Exists(newName));</a>
<a name="ln893"> </a>
<a name="ln894">            File.Copy(file, newName);</a>
<a name="ln895"> </a>
<a name="ln896">            Frames.Add(new FrameInfo</a>
<a name="ln897">            {</a>
<a name="ln898">                Delay = Delay,</a>
<a name="ln899">                Path = newName</a>
<a name="ln900">            });</a>
<a name="ln901">        }</a>
<a name="ln902"> </a>
<a name="ln903">        ClearImportFolder(folder);</a>
<a name="ln904"> </a>
<a name="ln905">        Dispatcher?.Invoke(() =&gt; { DialogResult = true; });</a>
<a name="ln906">    }</a>
<a name="ln907"> </a>
<a name="ln908">    private void ClearImportFolder(string folder)</a>
<a name="ln909">    {</a>
<a name="ln910">        if (!string.IsNullOrWhiteSpace(folder) &amp;&amp; Directory.Exists(folder))</a>
<a name="ln911">            Directory.Delete(folder, true);</a>
<a name="ln912">    }</a>
<a name="ln913"> </a>
<a name="ln914">    #endregion</a>
<a name="ln915">}</a>
</code></pre>
<div class="balloon" rel="854"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The '_process' object was used before it was verified against null. Check lines: 854, 856.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>