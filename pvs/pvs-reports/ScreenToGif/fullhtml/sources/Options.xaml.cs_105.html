<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Options.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Collections;</a>
<a name="ln3">using System.Collections.Generic;</a>
<a name="ln4">using System.Collections.ObjectModel;</a>
<a name="ln5">using System.Diagnostics;</a>
<a name="ln6">using System.IO;</a>
<a name="ln7">using System.IO.Compression;</a>
<a name="ln8">using System.Linq;</a>
<a name="ln9">using System.Net;</a>
<a name="ln10">using System.Threading.Tasks;</a>
<a name="ln11">using System.Windows;</a>
<a name="ln12">using System.Windows.Controls;</a>
<a name="ln13">using System.Windows.Input;</a>
<a name="ln14">using System.Windows.Interop;</a>
<a name="ln15">using System.Windows.Media;</a>
<a name="ln16">using System.Windows.Navigation;</a>
<a name="ln17">using System.Windows.Threading;</a>
<a name="ln18">using Microsoft.Win32;</a>
<a name="ln19">using ScreenToGif.Controls;</a>
<a name="ln20">using ScreenToGif.Domain.Enums;</a>
<a name="ln21">using ScreenToGif.Native.Helpers;</a>
<a name="ln22">using ScreenToGif.Util;</a>
<a name="ln23">using ScreenToGif.Util.InterProcessChannel;</a>
<a name="ln24">using ScreenToGif.Util.Settings;</a>
<a name="ln25">using ScreenToGif.ViewModel.ExportPresets;</a>
<a name="ln26">using ScreenToGif.ViewModel.Tasks;</a>
<a name="ln27">using ScreenToGif.ViewModel.UploadPresets;</a>
<a name="ln28">using ScreenToGif.Windows.Other;</a>
<a name="ln29">using Localization = ScreenToGif.Windows.Other.Localization;</a>
<a name="ln30">using OpenFileDialog = Microsoft.Win32.OpenFileDialog;</a>
<a name="ln31">using Path = System.IO.Path;</a>
<a name="ln32">using SaveFileDialog = Microsoft.Win32.SaveFileDialog;</a>
<a name="ln33"> </a>
<a name="ln34">namespace ScreenToGif.Windows;</a>
<a name="ln35"> </a>
<a name="ln36">public partial class Options : INotification</a>
<a name="ln37">{</a>
<a name="ln38">    #region Constants and variables</a>
<a name="ln39"> </a>
<a name="ln40">    internal const int ApplicationIndex = 0;</a>
<a name="ln41">    internal const int RecorderIndex = 1;</a>
<a name="ln42">    internal const int InterfaceIndex = 2;</a>
<a name="ln43">    internal const int AutomatedTasksIndex = 3;</a>
<a name="ln44">    internal const int ShortcutsIndex = 4;</a>
<a name="ln45">    internal const int LanguageIndex = 5;</a>
<a name="ln46">    internal const int TempFilesIndex = 6;</a>
<a name="ln47">    internal const int UploadIndex = 7;</a>
<a name="ln48">    internal const int ExtrasIndex = 8;</a>
<a name="ln49">    internal const int DonateIndex = 9;</a>
<a name="ln50">    internal const int AboutIndex = 10;</a>
<a name="ln51"> </a>
<a name="ln52">    /// &lt;summary&gt;</a>
<a name="ln53">    /// Used to decide if a size check is necessary, when a new path is detected.</a>
<a name="ln54">    /// &lt;/summary&gt;</a>
<a name="ln55">    private string _previousPath = &quot;&quot;;</a>
<a name="ln56"> </a>
<a name="ln57">    /// &lt;summary&gt;</a>
<a name="ln58">    /// True when the cache folder is being checked.</a>
<a name="ln59">    /// &lt;/summary&gt;</a>
<a name="ln60">    private bool _isBusy = false;</a>
<a name="ln61"> </a>
<a name="ln62">    /// &lt;summary&gt;</a>
<a name="ln63">    /// The Path of the cache folder.</a>
<a name="ln64">    /// &lt;/summary&gt;</a>
<a name="ln65">    private List&lt;DirectoryInfo&gt; _folderList = new();</a>
<a name="ln66"> </a>
<a name="ln67">    /// &lt;summary&gt;</a>
<a name="ln68">    /// The file count of the cache folder.</a>
<a name="ln69">    /// &lt;/summary&gt;</a>
<a name="ln70">    private int _fileCount;</a>
<a name="ln71"> </a>
<a name="ln72">    /// &lt;summary&gt;</a>
<a name="ln73">    /// The size in bytes of the cache folder.</a>
<a name="ln74">    /// &lt;/summary&gt;</a>
<a name="ln75">    private long _cacheSize;</a>
<a name="ln76"> </a>
<a name="ln77">    /// &lt;summary&gt;</a>
<a name="ln78">    /// List of tasks.</a>
<a name="ln79">    /// &lt;/summary&gt;</a>
<a name="ln80">    private ObservableCollection&lt;BaseTaskViewModel&gt; _effectList;</a>
<a name="ln81"> </a>
<a name="ln82">    /// &lt;summary&gt;</a>
<a name="ln83">    /// List of upload presets.</a>
<a name="ln84">    /// &lt;/summary&gt;</a>
<a name="ln85">    private ObservableCollection&lt;UploadPreset&gt; _uploadList;</a>
<a name="ln86"> </a>
<a name="ln87">    /// &lt;summary&gt;</a>
<a name="ln88">    /// The latest size of the grid before being altered.</a>
<a name="ln89">    /// &lt;/summary&gt;</a>
<a name="ln90">    private Rect _latestGridSize = Rect.Empty;</a>
<a name="ln91"> </a>
<a name="ln92">    /// &lt;summary&gt;</a>
<a name="ln93">    /// Flag used to avoid multiple calls on the startup mode change.</a>
<a name="ln94">    /// &lt;/summary&gt;</a>
<a name="ln95">    private bool _ignoreStartup;</a>
<a name="ln96"> </a>
<a name="ln97">    #endregion</a>
<a name="ln98"> </a>
<a name="ln99">    public Options()</a>
<a name="ln100">    {</a>
<a name="ln101">        InitializeComponent();</a>
<a name="ln102"> </a>
<a name="ln103">#if FULL_MULTI_MSIX_STORE</a>
<a name="ln104">        UpdatesCheckBox.Visibility = Visibility.Collapsed;</a>
<a name="ln105">        CheckForUpdatesLabel.Visibility = Visibility.Collapsed;</a>
<a name="ln106">        StoreTextBlock.Visibility = Visibility.Visible;</a>
<a name="ln107">        DownloadWithMeteredNetworkCheckBox.Visibility = Visibility.Collapsed;</a>
<a name="ln108">#elif FULL_MULTI_MSIX</a>
<a name="ln109">        PortableUpdateCheckBox.Visibility = Visibility.Collapsed;</a>
<a name="ln110">        AdminUpdateCheckBox.Visibility = Visibility.Collapsed;</a>
<a name="ln111">#endif</a>
<a name="ln112">    }</a>
<a name="ln113"> </a>
<a name="ln114">    public Options(int index) : this()</a>
<a name="ln115">    {</a>
<a name="ln116">        SelectTab(index);</a>
<a name="ln117">    }</a>
<a name="ln118"> </a>
<a name="ln119">    #region App Settings</a>
<a name="ln120"> </a>
<a name="ln121">    private void ApplicationPanel_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln122">    {</a>
<a name="ln123">        try</a>
<a name="ln124">        {</a>
<a name="ln125">            StartupModeGrid.IsEnabled = false;</a>
<a name="ln126">            Cursor = Cursors.AppStarting;</a>
<a name="ln127">            _ignoreStartup = true;</a>
<a name="ln128"> </a>
<a name="ln129">            //Detect if this app is set to start with windows.</a>
<a name="ln130">            var sub = Registry.CurrentUser.OpenSubKey(&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run&quot;, false);</a>
<a name="ln131">            var key = sub?.GetValue(&quot;ScreenToGif&quot;);</a>
<a name="ln132">            var name = ProcessHelper.GetEntryAssemblyPath();</a>
<a name="ln133"> </a>
<a name="ln134">            if (key == null || key as string != name)</a>
<a name="ln135">            {</a>
<a name="ln136">                //If the key does not exists or its content does not point to the same executable, it means that this app will not run when the user logins.</a>
<a name="ln137">                StartManuallyCheckBox.IsChecked = true;</a>
<a name="ln138">            }</a>
<a name="ln139">            else</a>
<a name="ln140">            {</a>
<a name="ln141">                //If the key exists and its content point to the same executable, it means that this app will run when the user logins.</a>
<a name="ln142">                StartAutomaticallyCheckBox.IsChecked = true;</a>
<a name="ln143">            }</a>
<a name="ln144"> </a>
<a name="ln145">            //Detect other version of this app?</a>
<a name="ln146"> </a>
<a name="ln147">            StartupModeGrid.IsEnabled = true;</a>
<a name="ln148">        }</a>
<a name="ln149">        catch (Exception ex)</a>
<a name="ln150">        {</a>
<a name="ln151">            LogWriter.Log(ex, &quot;Impossible to detect if the app is starting when the user logins&quot;);</a>
<a name="ln152">            StartupModeGrid.IsEnabled = false;</a>
<a name="ln153">        }</a>
<a name="ln154">        finally</a>
<a name="ln155">        {</a>
<a name="ln156">            _ignoreStartup = false;</a>
<a name="ln157">            Cursor = Cursors.Arrow;</a>
<a name="ln158">        }</a>
<a name="ln159">    }</a>
<a name="ln160"> </a>
<a name="ln161">    private void Instance_Checked(object sender, RoutedEventArgs e)</a>
<a name="ln162">    {</a>
<a name="ln163">        if (!IsLoaded)</a>
<a name="ln164">            return;</a>
<a name="ln165"> </a>
<a name="ln166">        //With this inter process server, this instance can listen to arguments sent by other instances.</a>
<a name="ln167">        if (UserSettings.All.SingleInstance)</a>
<a name="ln168">            InstanceSwitcherChannel.RegisterServer(App.InstanceSwitch_Received);</a>
<a name="ln169">        else</a>
<a name="ln170">            InstanceSwitcherChannel.UnregisterServer();</a>
<a name="ln171">    }</a>
<a name="ln172"> </a>
<a name="ln173">    private void AppThemeComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln174">    {</a>
<a name="ln175">        if (!IsLoaded)</a>
<a name="ln176">            return;</a>
<a name="ln177"> </a>
<a name="ln178">        try</a>
<a name="ln179">        {</a>
<a name="ln180">            if (AppThemeComboBox.SelectedValue is not AppThemes selected)</a>
<a name="ln181">                throw new Exception(&quot;No theme was selected.&quot;);</a>
<a name="ln182"> </a>
<a name="ln183">            ThemeHelper.SelectTheme(selected);</a>
<a name="ln184"> </a>
<a name="ln185">            App.NotifyIcon?.RefreshVisual();</a>
<a name="ln186">        }</a>
<a name="ln187">        catch (Exception ex)</a>
<a name="ln188">        {</a>
<a name="ln189">            LogWriter.Log(ex, &quot;Error while selecting the app's theme.&quot;);</a>
<a name="ln190">            ExceptionDialog.Ok(ex, Title, &quot;Error while selecting the app's theme&quot;, ex.Message);</a>
<a name="ln191">        }</a>
<a name="ln192">    }</a>
<a name="ln193"> </a>
<a name="ln194">    private void StartAutomaticallyCheckBox_Checked(object sender, RoutedEventArgs e)</a>
<a name="ln195">    {</a>
<a name="ln196">        try</a>
<a name="ln197">        {</a>
<a name="ln198">            if (_ignoreStartup)</a>
<a name="ln199">                return;</a>
<a name="ln200"> </a>
<a name="ln201">            Cursor = Cursors.AppStarting;</a>
<a name="ln202">            _ignoreStartup = true;</a>
<a name="ln203"> </a>
<a name="ln204">            var sub = Registry.CurrentUser.OpenSubKey(&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run&quot;, true);</a>
<a name="ln205">            var name = ProcessHelper.GetEntryAssemblyPath();</a>
<a name="ln206"> </a>
<a name="ln207">            if (string.IsNullOrWhiteSpace(name) || sub == null)</a>
<a name="ln208">            {</a>
<a name="ln209">                StatusBand.Error(LocalizationHelper.Get(&quot;S.Options.App.Startup.Mode.Warning&quot;));</a>
<a name="ln210">                throw new Exception(&quot;Impossible to set the app to run on startup. &quot; + name + (sub == null ? &quot;, null&quot; : &quot;&quot;));</a>
<a name="ln211">            }</a>
<a name="ln212"> </a>
<a name="ln213">            //Add the value in the registry so that the application runs at startup.</a>
<a name="ln214">            sub.SetValue(&quot;ScreenToGif&quot;, name);</a>
<a name="ln215">        }</a>
<a name="ln216">        catch (Exception ex)</a>
<a name="ln217">        {</a>
<a name="ln218">            LogWriter.Log(ex, &quot;Impossible to set the app to run on startup.&quot;);</a>
<a name="ln219">        }</a>
<a name="ln220">        finally</a>
<a name="ln221">        {</a>
<a name="ln222">            _ignoreStartup = false;</a>
<a name="ln223">            Cursor = Cursors.Arrow;</a>
<a name="ln224">        }</a>
<a name="ln225">    }</a>
<a name="ln226"> </a>
<a name="ln227">    private void StartAutomaticallyCheckBox_Unchecked(object sender, RoutedEventArgs e)</a>
<a name="ln228">    {</a>
<a name="ln229">        try</a>
<a name="ln230">        {</a>
<a name="ln231">            if (_ignoreStartup)</a>
<a name="ln232">                return;</a>
<a name="ln233"> </a>
<a name="ln234">            Cursor = Cursors.AppStarting;</a>
<a name="ln235">            _ignoreStartup = true;</a>
<a name="ln236"> </a>
<a name="ln237">            var sub = Registry.CurrentUser.OpenSubKey(&quot;SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run&quot;, true);</a>
<a name="ln238">            var name = ProcessHelper.GetEntryAssemblyPath();</a>
<a name="ln239"> </a>
<a name="ln240">            if (string.IsNullOrWhiteSpace(name) || sub == null)</a>
<a name="ln241">            {</a>
<a name="ln242">                StatusBand.Error(LocalizationHelper.Get(&quot;S.Options.App.Startup.Mode.Warning&quot;));</a>
<a name="ln243">                throw new Exception(&quot;Impossible to set the app to not run on startup. &quot; + name + (sub == null ? &quot;, null&quot; : &quot;&quot;));</a>
<a name="ln244">            }</a>
<a name="ln245"> </a>
<a name="ln246">            //Remove the value from the registry so that the application doesn't start automatically.</a>
<a name="ln247">            sub.DeleteValue(&quot;ScreenToGif&quot;, false);</a>
<a name="ln248">        }</a>
<a name="ln249">        catch (Exception ex)</a>
<a name="ln250">        {</a>
<a name="ln251">            LogWriter.Log(ex, &quot;Impossible to set the app to not run on startup.&quot;);</a>
<a name="ln252">        }</a>
<a name="ln253">        finally</a>
<a name="ln254">        {</a>
<a name="ln255">            _ignoreStartup = false;</a>
<a name="ln256">            Cursor = Cursors.Arrow;</a>
<a name="ln257">        }</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    private void StartCheckBox_Checked(object sender, RoutedEventArgs e)</a>
<a name="ln261">    {</a>
<a name="ln262">        UserSettings.All.ShowNotificationIcon = true;</a>
<a name="ln263">    }</a>
<a name="ln264"> </a>
<a name="ln265">    private void NotificationIconCheckBox_CheckedChanged(object sender, RoutedEventArgs e)</a>
<a name="ln266">    {</a>
<a name="ln267">        //Can't have a minimized startup, if the icon is not present on the notification area.</a>
<a name="ln268">        if (!UserSettings.All.ShowNotificationIcon)</a>
<a name="ln269">            UserSettings.All.StartMinimized = false;</a>
<a name="ln270"> </a>
<a name="ln271">        if (App.NotifyIcon != null)</a>
<a name="ln272">            App.NotifyIcon.Visibility = UserSettings.All.ShowNotificationIcon ? Visibility.Visible : Visibility.Collapsed;</a>
<a name="ln273">    }</a>
<a name="ln274"> </a>
<a name="ln275">    #endregion</a>
<a name="ln276"> </a>
<a name="ln277">    #region Editor</a>
<a name="ln278"> </a>
<a name="ln279">    private void EditorPanel_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln280">    {</a>
<a name="ln281">        //Editor.</a>
<a name="ln282">        CheckScheme(false);</a>
<a name="ln283">        CheckSize(false);</a>
<a name="ln284">    }</a>
<a name="ln285"> </a>
<a name="ln286">    private void ColorSchemesComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln287">    {</a>
<a name="ln288">        CheckScheme();</a>
<a name="ln289">    }</a>
<a name="ln290"> </a>
<a name="ln291">    private void ColorBox_ColorChanged(object sender, RoutedEventArgs e)</a>
<a name="ln292">    {</a>
<a name="ln293">        if (!IsLoaded)</a>
<a name="ln294">            return;</a>
<a name="ln295"> </a>
<a name="ln296">        CheckScheme(false);</a>
<a name="ln297">    }</a>
<a name="ln298"> </a>
<a name="ln299">    private void CheckScheme(bool schemePicked = true)</a>
<a name="ln300">    {</a>
<a name="ln301">        try</a>
<a name="ln302">        {</a>
<a name="ln303">            EvenColorBox.IgnoreEvent = true;</a>
<a name="ln304">            OddColorBox.IgnoreEvent = true;</a>
<a name="ln305"> </a>
<a name="ln306">            if (schemePicked)</a>
<a name="ln307">            {</a>
<a name="ln308">                #region If ComboBox Selected</a>
<a name="ln309"> </a>
<a name="ln310">                switch (ColorSchemesComboBox.SelectedIndex)</a>
<a name="ln311">                {</a>
<a name="ln312">                    case 0:</a>
<a name="ln313">                        UserSettings.All.GridColorsFollowSystem = false;</a>
<a name="ln314">                        UserSettings.All.GridColor1 = Constants.VeryLightEven;</a>
<a name="ln315">                        UserSettings.All.GridColor2 = Constants.VeryLightOdd;</a>
<a name="ln316">                        break;</a>
<a name="ln317">                    case 1:</a>
<a name="ln318">                        UserSettings.All.GridColorsFollowSystem = false;</a>
<a name="ln319">                        UserSettings.All.GridColor1 = Constants.LightEven;</a>
<a name="ln320">                        UserSettings.All.GridColor2 = Constants.LightOdd;</a>
<a name="ln321">                        break;</a>
<a name="ln322">                    case 2:</a>
<a name="ln323">                        UserSettings.All.GridColorsFollowSystem = false;</a>
<a name="ln324">                        UserSettings.All.GridColor1 = Constants.MediumEven;</a>
<a name="ln325">                        UserSettings.All.GridColor2 = Constants.MediumOdd;</a>
<a name="ln326">                        break;</a>
<a name="ln327">                    case 3:</a>
<a name="ln328">                        UserSettings.All.GridColorsFollowSystem = false;</a>
<a name="ln329">                        UserSettings.All.GridColor1 = Constants.DarkEven;</a>
<a name="ln330">                        UserSettings.All.GridColor2 = Constants.DarkOdd;</a>
<a name="ln331">                        break;</a>
<a name="ln332">                    case 4:</a>
<a name="ln333">                        UserSettings.All.GridColorsFollowSystem = true;</a>
<a name="ln334">                        var isSystemUsingDark = ThemeHelper.IsSystemUsingDarkTheme();</a>
<a name="ln335">                        UserSettings.All.GridColor1 = isSystemUsingDark ? Constants.DarkEven : Constants.VeryLightEven;</a>
<a name="ln336">                        UserSettings.All.GridColor2 = isSystemUsingDark ? Constants.DarkOdd : Constants.VeryLightOdd;</a>
<a name="ln337">                        break;</a>
<a name="ln338">                }</a>
<a name="ln339"> </a>
<a name="ln340">                return;</a>
<a name="ln341"> </a>
<a name="ln342">                #endregion</a>
<a name="ln343">            }</a>
<a name="ln344"> </a>
<a name="ln345">            #region If Color Picked</a>
<a name="ln346"> </a>
<a name="ln347">            if (UserSettings.All.GridColor1.Equals(Constants.VeryLightEven) &amp;&amp; UserSettings.All.GridColor2.Equals(Constants.VeryLightOdd) &amp;&amp; !UserSettings.All.GridColorsFollowSystem)</a>
<a name="ln348">                ColorSchemesComboBox.SelectedIndex = 0;</a>
<a name="ln349">            else if (UserSettings.All.GridColor1.Equals(Constants.LightEven) &amp;&amp; UserSettings.All.GridColor2.Equals(Constants.LightOdd))</a>
<a name="ln350">                ColorSchemesComboBox.SelectedIndex = 1;</a>
<a name="ln351">            else if (UserSettings.All.GridColor1.Equals(Constants.MediumEven) &amp;&amp; UserSettings.All.GridColor2.Equals(Constants.MediumOdd))</a>
<a name="ln352">                ColorSchemesComboBox.SelectedIndex = 2;</a>
<a name="ln353">            else if (UserSettings.All.GridColor1.Equals(Constants.DarkEven) &amp;&amp; UserSettings.All.GridColor2.Equals(Constants.DarkOdd) &amp;&amp; !UserSettings.All.GridColorsFollowSystem)</a>
<a name="ln354">                ColorSchemesComboBox.SelectedIndex = 3;</a>
<a name="ln355">            else if (UserSettings.All.GridColorsFollowSystem &amp;&amp;</a>
<a name="ln356">                     (UserSettings.All.GridColor1.Equals(Constants.VeryLightEven) || UserSettings.All.GridColor1.Equals(Constants.DarkEven)) &amp;&amp;</a>
<a name="ln357">                     (UserSettings.All.GridColor2.Equals(Constants.VeryLightOdd) || UserSettings.All.GridColor2.Equals(Constants.DarkOdd)))</a>
<a name="ln358">                ColorSchemesComboBox.SelectedIndex = 4;</a>
<a name="ln359">            else</a>
<a name="ln360">            {</a>
<a name="ln361">                UserSettings.All.GridColorsFollowSystem = false;</a>
<a name="ln362">                ColorSchemesComboBox.SelectedIndex = 6;</a>
<a name="ln363">            }</a>
<a name="ln364"> </a>
<a name="ln365">            #endregion</a>
<a name="ln366">        }</a>
<a name="ln367">        finally</a>
<a name="ln368">        {</a>
<a name="ln369">            EvenColorBox.IgnoreEvent = false;</a>
<a name="ln370">            OddColorBox.IgnoreEvent = false;</a>
<a name="ln371">        }</a>
<a name="ln372">    }</a>
<a name="ln373"> </a>
<a name="ln374">    #region Grid Size</a>
<a name="ln375"> </a>
<a name="ln376">    private void GridSizeComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln377">    {</a>
<a name="ln378">        CheckSize();</a>
<a name="ln379">    }</a>
<a name="ln380"> </a>
<a name="ln381">    private void GridSizeBorder_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln382">    {</a>
<a name="ln383">        GridWidthIntegerUpDown.ValueChanged -= GridSizeIntegerUpDown_ValueChanged;</a>
<a name="ln384">        GridHeightIntegerUpDown.ValueChanged -= GridSizeIntegerUpDown_ValueChanged;</a>
<a name="ln385"> </a>
<a name="ln386">        GridWidthIntegerUpDown.Value = (int)UserSettings.All.GridSize.Width;</a>
<a name="ln387">        GridHeightIntegerUpDown.Value = (int)UserSettings.All.GridSize.Height;</a>
<a name="ln388">        GridSizeGrid.Visibility = Visibility.Visible;</a>
<a name="ln389">        _latestGridSize = UserSettings.All.GridSize;</a>
<a name="ln390"> </a>
<a name="ln391">        Dispatcher.Invoke(DispatcherPriority.Background, new Action(() =&gt; GridHeightIntegerUpDown.Focus()));</a>
<a name="ln392"> </a>
<a name="ln393">        GridWidthIntegerUpDown.ValueChanged += GridSizeIntegerUpDown_ValueChanged;</a>
<a name="ln394">        GridHeightIntegerUpDown.ValueChanged += GridSizeIntegerUpDown_ValueChanged;</a>
<a name="ln395">    }</a>
<a name="ln396"> </a>
<a name="ln397">    private void GridSizeIntegerUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln398">    {</a>
<a name="ln399">        if (!IsLoaded)</a>
<a name="ln400">            return;</a>
<a name="ln401"> </a>
<a name="ln402">        try</a>
<a name="ln403">        {</a>
<a name="ln404">            UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(GridWidthIntegerUpDown.Value, GridHeightIntegerUpDown.Value));</a>
<a name="ln405"> </a>
<a name="ln406">            CheckSize(false);</a>
<a name="ln407">        }</a>
<a name="ln408">        catch (Exception ex)</a>
<a name="ln409">        {</a>
<a name="ln410">            LogWriter.Log(ex, &quot;Adjusting the Grid Size&quot;);</a>
<a name="ln411">        }</a>
<a name="ln412">    }</a>
<a name="ln413"> </a>
<a name="ln414">    private void ApplySizeButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln415">    {</a>
<a name="ln416">        Dispatcher.Invoke(DispatcherPriority.Background, new Action(() =&gt; GridSizeBorder.Focus()));</a>
<a name="ln417">        GridSizeGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln418"> </a>
<a name="ln419">        GridSizeIntegerUpDown_ValueChanged(sender, e);</a>
<a name="ln420">    }</a>
<a name="ln421"> </a>
<a name="ln422">    private void CancelSizeButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln423">    {</a>
<a name="ln424">        Dispatcher.Invoke(DispatcherPriority.Background, new Action(() =&gt; GridSizeBorder.Focus()));</a>
<a name="ln425">        GridSizeGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln426">        UserSettings.All.GridSize = _latestGridSize;</a>
<a name="ln427"> </a>
<a name="ln428">        CheckSize(false);</a>
<a name="ln429">    }</a>
<a name="ln430"> </a>
<a name="ln431">    private void CheckSize(bool sizePicked = true)</a>
<a name="ln432">    {</a>
<a name="ln433">        try</a>
<a name="ln434">        {</a>
<a name="ln435">            GridSizeComboBox.SelectionChanged -= GridSizeComboBox_SelectionChanged;</a>
<a name="ln436"> </a>
<a name="ln437">            if (sizePicked)</a>
<a name="ln438">            {</a>
<a name="ln439">                #region If ComboBox Selected</a>
<a name="ln440"> </a>
<a name="ln441">                switch (GridSizeComboBox.SelectedIndex)</a>
<a name="ln442">                {</a>
<a name="ln443">                    case 0:</a>
<a name="ln444">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(10, 10));</a>
<a name="ln445">                        break;</a>
<a name="ln446">                    case 1:</a>
<a name="ln447">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(15, 15));</a>
<a name="ln448">                        break;</a>
<a name="ln449">                    case 2:</a>
<a name="ln450">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(20, 20));</a>
<a name="ln451">                        break;</a>
<a name="ln452">                    case 3:</a>
<a name="ln453">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(25, 25));</a>
<a name="ln454">                        break;</a>
<a name="ln455">                    case 4:</a>
<a name="ln456">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(30, 30));</a>
<a name="ln457">                        break;</a>
<a name="ln458">                    case 5:</a>
<a name="ln459">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(50, 50));</a>
<a name="ln460">                        break;</a>
<a name="ln461">                    case 6:</a>
<a name="ln462">                        UserSettings.All.GridSize = new Rect(new Point(0, 0), new Point(100, 100));</a>
<a name="ln463">                        break;</a>
<a name="ln464">                }</a>
<a name="ln465"> </a>
<a name="ln466">                return;</a>
<a name="ln467"> </a>
<a name="ln468">                #endregion</a>
<a name="ln469">            }</a>
<a name="ln470"> </a>
<a name="ln471">            #region If Settings Loaded</a>
<a name="ln472"> </a>
<a name="ln473">            var sizeW = UserSettings.All.GridSize.Width;</a>
<a name="ln474">            var sizeH = UserSettings.All.GridSize.Height;</a>
<a name="ln475"> </a>
<a name="ln476">            if (sizeW != sizeH)</a>
<a name="ln477">            {</a>
<a name="ln478">                GridSizeComboBox.SelectedIndex = 8;</a>
<a name="ln479">                return;</a>
<a name="ln480">            }</a>
<a name="ln481"> </a>
<a name="ln482">            if (sizeW == 10)</a>
<a name="ln483">                GridSizeComboBox.SelectedIndex = 0;</a>
<a name="ln484">            else if (sizeW == 15)</a>
<a name="ln485">                GridSizeComboBox.SelectedIndex = 1;</a>
<a name="ln486">            else if (sizeW == 20)</a>
<a name="ln487">                GridSizeComboBox.SelectedIndex = 2;</a>
<a name="ln488">            else if (sizeW == 25)</a>
<a name="ln489">                GridSizeComboBox.SelectedIndex = 3;</a>
<a name="ln490">            else if (sizeW == 30)</a>
<a name="ln491">                GridSizeComboBox.SelectedIndex = 4;</a>
<a name="ln492">            else if (sizeW == 50)</a>
<a name="ln493">                GridSizeComboBox.SelectedIndex = 5;</a>
<a name="ln494">            else if (sizeW == 100)</a>
<a name="ln495">                GridSizeComboBox.SelectedIndex = 6;</a>
<a name="ln496">            else</a>
<a name="ln497">                GridSizeComboBox.SelectedIndex = 8;</a>
<a name="ln498"> </a>
<a name="ln499">            #endregion</a>
<a name="ln500">        }</a>
<a name="ln501">        finally</a>
<a name="ln502">        {</a>
<a name="ln503">            GridSizeComboBox.SelectionChanged += GridSizeComboBox_SelectionChanged;</a>
<a name="ln504">        }</a>
<a name="ln505">    }</a>
<a name="ln506"> </a>
<a name="ln507">    #endregion</a>
<a name="ln508"> </a>
<a name="ln509">    #endregion</a>
<a name="ln510"> </a>
<a name="ln511">    #region Automated Tasks</a>
<a name="ln512"> </a>
<a name="ln513">    private void TasksPanel_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln514">    {</a>
<a name="ln515">        var list = UserSettings.All.AutomatedTasksList?.Cast&lt;BaseTaskViewModel&gt;().ToList() ?? new List&lt;BaseTaskViewModel&gt;();</a>
<a name="ln516"> </a>
<a name="ln517">        TasksDataGrid.ItemsSource = _effectList = new ObservableCollection&lt;BaseTaskViewModel&gt;(list);</a>
<a name="ln518">    }</a>
<a name="ln519"> </a>
<a name="ln520">    private void MoveUp_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln521">    {</a>
<a name="ln522">        e.CanExecute = TasksPanel.IsVisible &amp;&amp; TasksDataGrid.SelectedIndex &gt; 0;</a>
<a name="ln523">    }</a>
<a name="ln524"> </a>
<a name="ln525">    private void MoveDown_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln526">    {</a>
<a name="ln527">        e.CanExecute = TasksPanel.IsVisible &amp;&amp; TasksDataGrid.SelectedIndex &gt; -1 &amp;&amp; TasksDataGrid.SelectedIndex &lt; TasksDataGrid.Items.Count - 1;</a>
<a name="ln528">    }</a>
<a name="ln529"> </a>
<a name="ln530">    private void Remove_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln531">    {</a>
<a name="ln532">        e.CanExecute = TasksPanel.IsVisible &amp;&amp; TasksDataGrid.SelectedIndex != -1;</a>
<a name="ln533">    }</a>
<a name="ln534"> </a>
<a name="ln535">    private void Add_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln536">    {</a>
<a name="ln537">        e.CanExecute = TasksPanel.IsVisible;</a>
<a name="ln538">    }</a>
<a name="ln539"> </a>
<a name="ln540">    private void MoveUp_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln541">    {</a>
<a name="ln542">        var selectedIndex = TasksDataGrid.SelectedIndex;</a>
<a name="ln543">        var selected = _effectList[selectedIndex];</a>
<a name="ln544"> </a>
<a name="ln545">        _effectList.RemoveAt(selectedIndex);</a>
<a name="ln546">        _effectList.Insert(selectedIndex - 1, selected);</a>
<a name="ln547">        TasksDataGrid.SelectedItem = selected;</a>
<a name="ln548"> </a>
<a name="ln549">        UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln550">    }</a>
<a name="ln551"> </a>
<a name="ln552">    private void MoveDown_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln553">    {</a>
<a name="ln554">        var selectedIndex = TasksDataGrid.SelectedIndex;</a>
<a name="ln555">        var selected = _effectList[selectedIndex];</a>
<a name="ln556"> </a>
<a name="ln557">        _effectList.RemoveAt(selectedIndex);</a>
<a name="ln558">        _effectList.Insert(selectedIndex + 1, selected);</a>
<a name="ln559">        TasksDataGrid.SelectedItem = selected;</a>
<a name="ln560"> </a>
<a name="ln561">        UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln562">    }</a>
<a name="ln563"> </a>
<a name="ln564">    private void Add_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln565">    {</a>
<a name="ln566">        var eff = new AutomatedTask();</a>
<a name="ln567">        var result = eff.ShowDialog();</a>
<a name="ln568"> </a>
<a name="ln569">        if (result != true)</a>
<a name="ln570">            return;</a>
<a name="ln571"> </a>
<a name="ln572">        _effectList.Add(eff.CurrentTask);</a>
<a name="ln573">        UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln574">    }</a>
<a name="ln575"> </a>
<a name="ln576">    private void Edit_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln577">    {</a>
<a name="ln578">        var index = TasksDataGrid.SelectedIndex;</a>
<a name="ln579">        var selected = _effectList[TasksDataGrid.SelectedIndex].ShallowCopy();</a>
<a name="ln580"> </a>
<a name="ln581">        var eff = new AutomatedTask { CurrentTask = selected, IsEditing = true };</a>
<a name="ln582">        var result = eff.ShowDialog();</a>
<a name="ln583"> </a>
<a name="ln584">        if (result != true)</a>
<a name="ln585">            return;</a>
<a name="ln586"> </a>
<a name="ln587">        _effectList[TasksDataGrid.SelectedIndex] = eff.CurrentTask;</a>
<a name="ln588">        TasksDataGrid.Items.Refresh();</a>
<a name="ln589">        TasksDataGrid.SelectedIndex = index;</a>
<a name="ln590"> </a>
<a name="ln591">        UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln592">    }</a>
<a name="ln593"> </a>
<a name="ln594">    private void Remove_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln595">    {</a>
<a name="ln596">        var index = TasksDataGrid.SelectedIndex;</a>
<a name="ln597">        _effectList.RemoveAt(TasksDataGrid.SelectedIndex);</a>
<a name="ln598"> </a>
<a name="ln599">        //Automatically selects the closest item from the position of the one that was removed.</a>
<a name="ln600">        TasksDataGrid.SelectedIndex = _effectList.Count == 0 ? -1 : _effectList.Count &lt;= index ? _effectList.Count - 1 : index;</a>
<a name="ln601"> </a>
<a name="ln602">        UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln603">    }</a>
<a name="ln604"> </a>
<a name="ln605">    private void TasksDataGrid_MouseDoubleClick(object sender, MouseButtonEventArgs e)</a>
<a name="ln606">    {</a>
<a name="ln607">        if (EditCommandBinding.Command.CanExecute(sender))</a>
<a name="ln608">            EditCommandBinding.Command.Execute(sender);</a>
<a name="ln609">    }</a>
<a name="ln610"> </a>
<a name="ln611">    private void TasksDataGrid_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln612">    {</a>
<a name="ln613">        if (e.Key == Key.Enter &amp;&amp; EditCommandBinding.Command.CanExecute(sender))</a>
<a name="ln614">        {</a>
<a name="ln615">            EditCommandBinding.Command.Execute(sender);</a>
<a name="ln616">            e.Handled = true;</a>
<a name="ln617">        }</a>
<a name="ln618"> </a>
<a name="ln619">        if (e.Key == Key.Space)</a>
<a name="ln620">        {</a>
<a name="ln621">            if (TasksDataGrid.SelectedItem is not BaseTaskViewModel selected)</a>
<a name="ln622">                return;</a>
<a name="ln623"> </a>
<a name="ln624">            selected.IsEnabled = !selected.IsEnabled;</a>
<a name="ln625">            e.Handled = true;</a>
<a name="ln626"> </a>
<a name="ln627">            //UserSettings.All.AutomatedTasksList = new ArrayList(_effectList.ToArray());</a>
<a name="ln628">        }</a>
<a name="ln629">    }</a>
<a name="ln630"> </a>
<a name="ln631">    #endregion</a>
<a name="ln632"> </a>
<a name="ln633">    #region Shortcuts</a>
<a name="ln634"> </a>
<a name="ln635">    private void ShortcutsPanel_IsVisibleChanged(object sender, DependencyPropertyChangedEventArgs e)</a>
<a name="ln636">    {</a>
<a name="ln637">        Global.IgnoreHotKeys = ShortcutsPanel.IsVisible;</a>
<a name="ln638">    }</a>
<a name="ln639"> </a>
<a name="ln640">    private void Globals_OnKeyChanged(object sender, KeyChangedEventArgs e)</a>
<a name="ln641">    {</a>
<a name="ln642">        Recorders_OnKeyChanged(sender, e);</a>
<a name="ln643"> </a>
<a name="ln644">        if (e.Cancel)</a>
<a name="ln645">            return;</a>
<a name="ln646"> </a>
<a name="ln647">        //Unregister old shortcut.</a>
<a name="ln648">        HotKeyCollection.Default.Remove(e.PreviousModifiers, e.PreviousKey);</a>
<a name="ln649"> </a>
<a name="ln650">        //Registers all shortcuts and updates the input gesture text.</a>
<a name="ln651">        App.RegisterShortcuts();</a>
<a name="ln652">    }</a>
<a name="ln653"> </a>
<a name="ln654">    private void Recorders_OnKeyChanged(object sender, KeyChangedEventArgs e)</a>
<a name="ln655">    {</a>
<a name="ln656">        if (sender is not KeyBox box)</a>
<a name="ln657">            return;</a>
<a name="ln658"> </a>
<a name="ln659">        var list = new List&lt;Tuple&lt;Key, ModifierKeys&gt;&gt;</a>
<a name="ln660">        {</a>
<a name="ln661">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.RecorderShortcut, UserSettings.All.RecorderModifiers),</a>
<a name="ln662">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.BoardRecorderShortcut, UserSettings.All.BoardRecorderModifiers),</a>
<a name="ln663">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.WebcamRecorderShortcut, UserSettings.All.WebcamRecorderModifiers),</a>
<a name="ln664">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.EditorShortcut, UserSettings.All.EditorModifiers),</a>
<a name="ln665">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.OptionsShortcut, UserSettings.All.OptionsModifiers),</a>
<a name="ln666">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.ExitShortcut, UserSettings.All.ExitModifiers),</a>
<a name="ln667">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.StartPauseShortcut, UserSettings.All.StartPauseModifiers),</a>
<a name="ln668">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.StopShortcut, UserSettings.All.StopModifiers),</a>
<a name="ln669">            new Tuple&lt;Key, ModifierKeys&gt;(UserSettings.All.DiscardShortcut, UserSettings.All.DiscardModifiers)</a>
<a name="ln670">        };</a>
<a name="ln671"> </a>
<a name="ln672">        //If this new shortcut is already in use.</a>
<a name="ln673">        if (box.MainKey != Key.None &amp;&amp; list.Count(c =&gt; c.Item1 == box.MainKey &amp;&amp; c.Item2 == box.ModifierKeys) &gt; 1)</a>
<a name="ln674">        {</a>
<a name="ln675">            box.MainKey = e.PreviousKey;</a>
<a name="ln676">            box.ModifierKeys = e.PreviousModifiers;</a>
<a name="ln677">            e.Cancel = true;</a>
<a name="ln678">        }</a>
<a name="ln679">    }</a>
<a name="ln680"> </a>
<a name="ln681">    #endregion</a>
<a name="ln682"> </a>
<a name="ln683">    #region Language</a>
<a name="ln684"> </a>
<a name="ln685">    private void LanguagePanel_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln686">    {</a>
<a name="ln687">        //To avoid being called during startup of the window and to avoid being called twice after selection changes.</a>
<a name="ln688">        if (!IsLoaded || e.AddedItems.Count == 0)</a>
<a name="ln689">            return;</a>
<a name="ln690"> </a>
<a name="ln691">        try</a>
<a name="ln692">        {</a>
<a name="ln693">            LocalizationHelper.SelectCulture(UserSettings.All.LanguageCode);</a>
<a name="ln694"> </a>
<a name="ln695">            ForceUpdateSystemTray();</a>
<a name="ln696">        }</a>
<a name="ln697">        catch (Exception ex)</a>
<a name="ln698">        {</a>
<a name="ln699">            ErrorDialog.Ok(LocalizationHelper.Get(&quot;S.Options.Title&quot;), &quot;Error while stopping&quot;, ex.Message, ex);</a>
<a name="ln700">            LogWriter.Log(ex, &quot;Error while trying to set the language.&quot;);</a>
<a name="ln701">        }</a>
<a name="ln702">    }</a>
<a name="ln703"> </a>
<a name="ln704">    private void TranslateHyperlink_OnClick(object sender, RoutedEventArgs e)</a>
<a name="ln705">    {</a>
<a name="ln706">        try</a>
<a name="ln707">        {</a>
<a name="ln708">            ProcessHelper.StartWithShell(&quot;https://github.com/NickeManarin/ScreenToGif/wiki/Localization&quot;);</a>
<a name="ln709">        }</a>
<a name="ln710">        catch (Exception ex)</a>
<a name="ln711">        {</a>
<a name="ln712">            LogWriter.Log(ex, &quot;Open the latest resource available&quot;);</a>
<a name="ln713">        }</a>
<a name="ln714">    }</a>
<a name="ln715"> </a>
<a name="ln716">    private void TranslateOfflineHyperlink_OnClick(object sender, RoutedEventArgs e)</a>
<a name="ln717">    {</a>
<a name="ln718">        var sfd = new SaveFileDialog</a>
<a name="ln719">        {</a>
<a name="ln720">            AddExtension = true,</a>
<a name="ln721">            Filter = &quot;Resource Dictionary (*.xaml)|*.xaml&quot;,</a>
<a name="ln722">            Title = &quot;Save Resource Dictionary&quot;,</a>
<a name="ln723">            FileName = &quot;StringResources.en&quot;</a>
<a name="ln724">        };</a>
<a name="ln725"> </a>
<a name="ln726">        var result = sfd.ShowDialog();</a>
<a name="ln727"> </a>
<a name="ln728">        if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln729">        {</a>
<a name="ln730">            try</a>
<a name="ln731">            {</a>
<a name="ln732">                LocalizationHelper.SaveDefaultResource(sfd.FileName);</a>
<a name="ln733">            }</a>
<a name="ln734">            catch (Exception ex)</a>
<a name="ln735">            {</a>
<a name="ln736">                Dialog.Ok(&quot;Impossible to Save&quot;, &quot;Impossible to save the Xaml file&quot;, ex.Message, Icons.Warning);</a>
<a name="ln737">            }</a>
<a name="ln738">        }</a>
<a name="ln739">    }</a>
<a name="ln740"> </a>
<a name="ln741">    private void ImportHyperlink_OnClick(object sender, RoutedEventArgs e)</a>
<a name="ln742">    {</a>
<a name="ln743">        var local = new Localization { Owner = this };</a>
<a name="ln744">        local.ShowDialog();</a>
<a name="ln745">    }</a>
<a name="ln746"> </a>
<a name="ln747">    private void EmailHyperlink_OnClick(object sender, RoutedEventArgs e)</a>
<a name="ln748">    {</a>
<a name="ln749">        try</a>
<a name="ln750">        {</a>
<a name="ln751">            ProcessHelper.StartWithShell(&quot;mailto:nicke@outlook.com.br&quot;);</a>
<a name="ln752">        }</a>
<a name="ln753">        catch (Exception ex)</a>
<a name="ln754">        {</a>
<a name="ln755">            LogWriter.Log(ex, &quot;Open MailTo&quot;);</a>
<a name="ln756">        }</a>
<a name="ln757">    }</a>
<a name="ln758"> </a>
<a name="ln759">    private void ForceUpdateSystemTray()</a>
<a name="ln760">    {</a>
<a name="ln761">        if (App.NotifyIcon == null || App.NotifyIcon.ContextMenu == null)</a>
<a name="ln762">            return;</a>
<a name="ln763"> </a>
<a name="ln764">        var items = App.NotifyIcon.ContextMenu.Items.OfType&lt;ExtendedMenuItem&gt;();</a>
<a name="ln765"> </a>
<a name="ln766">        foreach (var item in items)</a>
<a name="ln767">            item.Header = LocalizationHelper.Get((string)item.Tag);</a>
<a name="ln768">    }</a>
<a name="ln769"> </a>
<a name="ln770">    #endregion</a>
<a name="ln771"> </a>
<a name="ln772">    #region Storage</a>
<a name="ln773"> </a>
<a name="ln774">    private void TempPanel_IsVisibleChanged(object sender, DependencyPropertyChangedEventArgs e)</a>
<a name="ln775">    {</a>
<a name="ln776">        if (TempPanel.Visibility != Visibility.Visible)</a>
<a name="ln777">            return;</a>
<a name="ln778"> </a>
<a name="ln779">        _previousPath = UserSettings.All.TemporaryFolderResolved;</a>
<a name="ln780"> </a>
<a name="ln781">        CheckSpace();</a>
<a name="ln782"> </a>
<a name="ln783">        #region Settings</a>
<a name="ln784"> </a>
<a name="ln785">        //Paths.</a>
<a name="ln786">        AppDataPathTextBlock.Text = Path.Combine(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), &quot;ScreenToGif&quot;), &quot;Settings.xaml&quot;);</a>
<a name="ln787">        LocalPathTextBlock.Text = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, &quot;Settings.xaml&quot;);</a>
<a name="ln788"> </a>
<a name="ln789">        //Remove all text decorations (Strikethrough).</a>
<a name="ln790">        AppDataPathTextBlock.TextDecorations.Clear();</a>
<a name="ln791">        LocalPathTextBlock.TextDecorations.Clear();</a>
<a name="ln792"> </a>
<a name="ln793">        //Clear the tooltips.</a>
<a name="ln794">        AppDataPathTextBlock.ClearValue(ToolTipProperty);</a>
<a name="ln795">        LocalPathTextBlock.ClearValue(ToolTipProperty);</a>
<a name="ln796"> </a>
<a name="ln797">        //AppData.</a>
<a name="ln798">        if (!File.Exists(AppDataPathTextBlock.Text))</a>
<a name="ln799">        {</a>
<a name="ln800">            AppDataPathTextBlock.TextDecorations.Add(new TextDecoration(TextDecorationLocation.Strikethrough, new Pen(Brushes.DarkSlateGray, 1),</a>
<a name="ln801">                0, TextDecorationUnit.FontRecommended, TextDecorationUnit.FontRecommended));</a>
<a name="ln802"> </a>
<a name="ln803">            AppDataPathTextBlock.SetResourceReference(ToolTipProperty, &quot;S.Options.Storage.NotExists&quot;);</a>
<a name="ln804">        }</a>
<a name="ln805"> </a>
<a name="ln806">        //Local.</a>
<a name="ln807">        if (!File.Exists(LocalPathTextBlock.Text))</a>
<a name="ln808">        {</a>
<a name="ln809">            LocalPathTextBlock.TextDecorations.Add(new TextDecoration(TextDecorationLocation.Strikethrough, new Pen(Brushes.DarkSlateGray, 1),</a>
<a name="ln810">                0, TextDecorationUnit.FontRecommended, TextDecorationUnit.FontRecommended));</a>
<a name="ln811"> </a>
<a name="ln812">            LocalPathTextBlock.SetResourceReference(ToolTipProperty, &quot;S.Options.Storage.NotExists&quot;);</a>
<a name="ln813">        }</a>
<a name="ln814"> </a>
<a name="ln815">        #endregion</a>
<a name="ln816">    }</a>
<a name="ln817"> </a>
<a name="ln818"> </a>
<a name="ln819">    private void Cache_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln820">    {</a>
<a name="ln821">        e.CanExecute = IsLoaded &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.TemporaryFolder) &amp;&amp; !_isBusy;</a>
<a name="ln822">    }</a>
<a name="ln823"> </a>
<a name="ln824">    private void BrowseCache_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln825">    {</a>
<a name="ln826">        e.CanExecute = IsLoaded &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.TemporaryFolder) &amp;&amp; Directory.Exists(UserSettings.All.TemporaryFolderResolved) &amp;&amp; !_isBusy;</a>
<a name="ln827">    }</a>
<a name="ln828"> </a>
<a name="ln829">    private void BrowseLogs_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln830">    {</a>
<a name="ln831">        e.CanExecute = IsLoaded &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.LogsFolder) &amp;&amp; Directory.Exists(UserSettings.All.LogsFolder);</a>
<a name="ln832">    }</a>
<a name="ln833"> </a>
<a name="ln834">    private void CreateLocalSettings_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln835">    {</a>
<a name="ln836">        e.CanExecute = IsLoaded &amp;&amp; !File.Exists(LocalPathTextBlock.Text);</a>
<a name="ln837">    }</a>
<a name="ln838"> </a>
<a name="ln839">    private void RemoveLocalSettings_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln840">    {</a>
<a name="ln841">        e.CanExecute = IsLoaded &amp;&amp; File.Exists(LocalPathTextBlock.Text);</a>
<a name="ln842">    }</a>
<a name="ln843"> </a>
<a name="ln844">    private void RemoveAppDataSettings_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln845">    {</a>
<a name="ln846">        e.CanExecute = IsLoaded &amp;&amp; File.Exists(AppDataPathTextBlock.Text);</a>
<a name="ln847">    }</a>
<a name="ln848"> </a>
<a name="ln849"> </a>
<a name="ln850">    private void CheckCache_Execute(object sender, RoutedEventArgs e)</a>
<a name="ln851">    {</a>
<a name="ln852">        CheckSpace();</a>
<a name="ln853">    }</a>
<a name="ln854"> </a>
<a name="ln855">    private async void ClearCache_Execute(object sender, RoutedEventArgs e)</a>
<a name="ln856">    {</a>
<a name="ln857">        _isBusy = true;</a>
<a name="ln858">        StatusProgressBar.State = ExtendedProgressBar.ProgressState.Primary;</a>
<a name="ln859">        StatusProgressBar.IsIndeterminate = true;</a>
<a name="ln860">        FilesTextBlock.Visibility = Visibility.Collapsed;</a>
<a name="ln861"> </a>
<a name="ln862">        try</a>
<a name="ln863">        {</a>
<a name="ln864">            var parent = Util.Other.AdjustPath(UserSettings.All.TemporaryFolderResolved);</a>
<a name="ln865">            var path = Path.Combine(parent, &quot;ScreenToGif&quot;, &quot;Recording&quot;);</a>
<a name="ln866"> </a>
<a name="ln867">            if (!Directory.Exists(path))</a>
<a name="ln868">                return;</a>
<a name="ln869"> </a>
<a name="ln870">            //Force to be 1 day or more.</a>
<a name="ln871">            UserSettings.All.AutomaticCleanUpDays = UserSettings.All.AutomaticCleanUpDays &gt; 0 ? UserSettings.All.AutomaticCleanUpDays : 5;</a>
<a name="ln872"> </a>
<a name="ln873">            //Asks if the user wants to remove all files or just the old ones.</a>
<a name="ln874">            if (!CacheDialog.Ask(true, out bool ignoreRecent))</a>
<a name="ln875">                return;</a>
<a name="ln876"> </a>
<a name="ln877">            _folderList = await Task.Factory.StartNew(() =&gt; Directory.GetDirectories(path, &quot;*&quot;, SearchOption.TopDirectoryOnly).Select(x =&gt; new DirectoryInfo(x)).ToList());</a>
<a name="ln878"> </a>
<a name="ln879">            if (ignoreRecent)</a>
<a name="ln880">                _folderList = await Task.Factory.StartNew(() =&gt; _folderList.Where(w =&gt; (DateTime.Now - w.CreationTime).Days &gt; UserSettings.All.AutomaticCleanUpDays).ToList());</a>
<a name="ln881"> </a>
<a name="ln882">            foreach (var folder in _folderList.Where(folder =&gt; !MutexList.IsInUse(folder.Name)))</a>
<a name="ln883">                Directory.Delete(folder.FullName, true);</a>
<a name="ln884">        }</a>
<a name="ln885">        catch (Exception ex)</a>
<a name="ln886">        {</a>
<a name="ln887">            LogWriter.Log(ex, &quot;Error while cleaning the cache folder.&quot;);</a>
<a name="ln888">        }</a>
<a name="ln889">        finally</a>
<a name="ln890">        {</a>
<a name="ln891">            App.MainViewModel.CheckDiskSpace();</a>
<a name="ln892">            CheckSpace(true);</a>
<a name="ln893">        }</a>
<a name="ln894">    }</a>
<a name="ln895"> </a>
<a name="ln896">    private void ChooseCachePath_Click(object sender, RoutedEventArgs e)</a>
<a name="ln897">    {</a>
<a name="ln898">        var path = UserSettings.All.TemporaryFolderResolved;</a>
<a name="ln899"> </a>
<a name="ln900">        if (UserSettings.All.TemporaryFolderResolved.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln901">            path = &quot;&quot;;</a>
<a name="ln902"> </a>
<a name="ln903">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln904">        var isRelative = !string.IsNullOrWhiteSpace(path) &amp;&amp; !Path.IsPathRooted(path);</a>
<a name="ln905">        var notAlt = !string.IsNullOrWhiteSpace(path) &amp;&amp; UserSettings.All.TemporaryFolderResolved.Contains(Path.DirectorySeparatorChar);</a>
<a name="ln906"> </a>
<a name="ln907">        path = Util.Other.AdjustPath(path);</a>
<a name="ln908"> </a>
<a name="ln909">        var initial = Directory.Exists(path) ? path : Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</a>
<a name="ln910"> </a>
<a name="ln911">        var folderDialog = new FolderSelector();</a>
<a name="ln912"> </a>
<a name="ln913">        if (!string.IsNullOrWhiteSpace(initial))</a>
<a name="ln914">            folderDialog.SelectedPath = initial;</a>
<a name="ln915"> </a>
<a name="ln916">        if (!folderDialog.ShowDialog())</a>
<a name="ln917">            return;</a>
<a name="ln918"> </a>
<a name="ln919">        //Converts to a relative path again.</a>
<a name="ln920">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(folderDialog.SelectedPath))</a>
<a name="ln921">        {</a>
<a name="ln922">            var selected = new Uri(folderDialog.SelectedPath);</a>
<a name="ln923">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln924">            var relativeFolder = selected.AbsolutePath.TrimEnd(Path.DirectorySeparatorChar).TrimEnd(Path.AltDirectorySeparatorChar) == baseFolder.AbsolutePath.TrimEnd(Path.DirectorySeparatorChar).TrimEnd(Path.AltDirectorySeparatorChar) ?</a>
<a name="ln925">                &quot;.&quot; : Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln926"> </a>
<a name="ln927">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln928">            UserSettings.All.TemporaryFolder = notAlt ? relativeFolder.Replace(Path.AltDirectorySeparatorChar, Path.DirectorySeparatorChar) :</a>
<a name="ln929">                relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln930">        }</a>
<a name="ln931">        else</a>
<a name="ln932">        {</a>
<a name="ln933">            UserSettings.All.TemporaryFolder = folderDialog.SelectedPath;</a>
<a name="ln934">        }</a>
<a name="ln935"> </a>
<a name="ln936">        _previousPath = UserSettings.All.TemporaryFolderResolved;</a>
<a name="ln937">        CheckSpace();</a>
<a name="ln938">    }</a>
<a name="ln939"> </a>
<a name="ln940">    private void CacheTextBox_LostFocus(object sender, RoutedEventArgs e)</a>
<a name="ln941">    {</a>
<a name="ln942">        if (_previousPath == UserSettings.All.TemporaryFolderResolved)</a>
<a name="ln943">            return;</a>
<a name="ln944"> </a>
<a name="ln945">        _previousPath = UserSettings.All.TemporaryFolderResolved;</a>
<a name="ln946">        CheckSpace();</a>
<a name="ln947">    }</a>
<a name="ln948"> </a>
<a name="ln949">    private void BrowseCache_Execute(object sender, RoutedEventArgs e)</a>
<a name="ln950">    {</a>
<a name="ln951">        try</a>
<a name="ln952">        {</a>
<a name="ln953">            ProcessHelper.StartWithShell(UserSettings.All.TemporaryFolderResolved);</a>
<a name="ln954">        }</a>
<a name="ln955">        catch (Exception ex)</a>
<a name="ln956">        {</a>
<a name="ln957">            LogWriter.Log(ex, &quot;Error while trying to browse the cache folder.&quot;);</a>
<a name="ln958">        }</a>
<a name="ln959">    }</a>
<a name="ln960"> </a>
<a name="ln961">    private void ChooseLogsPath_Click(object sender, RoutedEventArgs e)</a>
<a name="ln962">    {</a>
<a name="ln963">        var path = UserSettings.All.LogsFolder;</a>
<a name="ln964"> </a>
<a name="ln965">        if (UserSettings.All.LogsFolder.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln966">            path = &quot;&quot;;</a>
<a name="ln967"> </a>
<a name="ln968">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln969">        var isRelative = !string.IsNullOrWhiteSpace(path) &amp;&amp; !Path.IsPathRooted(path);</a>
<a name="ln970">        var notAlt = !string.IsNullOrWhiteSpace(path) &amp;&amp; UserSettings.All.LogsFolder.Contains(Path.DirectorySeparatorChar);</a>
<a name="ln971"> </a>
<a name="ln972">        path = Util.Other.AdjustPath(path);</a>
<a name="ln973"> </a>
<a name="ln974">        var initial = Directory.Exists(path) ? path : Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</a>
<a name="ln975"> </a>
<a name="ln976">        var folderDialog = new FolderSelector();</a>
<a name="ln977"> </a>
<a name="ln978">        if (!string.IsNullOrWhiteSpace(initial))</a>
<a name="ln979">            folderDialog.SelectedPath = initial;</a>
<a name="ln980"> </a>
<a name="ln981">        if (!folderDialog.ShowDialog())</a>
<a name="ln982">            return;</a>
<a name="ln983"> </a>
<a name="ln984">        //Converts to a relative path again.</a>
<a name="ln985">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(folderDialog.SelectedPath))</a>
<a name="ln986">        {</a>
<a name="ln987">            var selected = new Uri(folderDialog.SelectedPath);</a>
<a name="ln988">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln989">            var relativeFolder = selected.AbsolutePath.TrimEnd(Path.DirectorySeparatorChar).TrimEnd(Path.AltDirectorySeparatorChar) == baseFolder.AbsolutePath.TrimEnd(Path.DirectorySeparatorChar).TrimEnd(Path.AltDirectorySeparatorChar) ?</a>
<a name="ln990">                &quot;.&quot; : Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln991"> </a>
<a name="ln992">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln993">            UserSettings.All.LogsFolder = notAlt ? relativeFolder.Replace(Path.AltDirectorySeparatorChar, Path.DirectorySeparatorChar) :</a>
<a name="ln994">                relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln995">        }</a>
<a name="ln996">        else</a>
<a name="ln997">        {</a>
<a name="ln998">            UserSettings.All.LogsFolder = folderDialog.SelectedPath;</a>
<a name="ln999">        }</a>
<a name="ln1000">    }</a>
<a name="ln1001"> </a>
<a name="ln1002">    private void BrowseLogs_Execute(object sender, RoutedEventArgs e)</a>
<a name="ln1003">    {</a>
<a name="ln1004">        try</a>
<a name="ln1005">        {</a>
<a name="ln1006">            ProcessHelper.StartWithShell(UserSettings.All.LogsFolder);</a>
<a name="ln1007">        }</a>
<a name="ln1008">        catch (Exception ex)</a>
<a name="ln1009">        {</a>
<a name="ln1010">            LogWriter.Log(ex, &quot;Error while trying to browse the logs folder.&quot;);</a>
<a name="ln1011">        }</a>
<a name="ln1012">    }</a>
<a name="ln1013"> </a>
<a name="ln1014"> </a>
<a name="ln1015">    private void OpenAppDataSettings_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1016">    {</a>
<a name="ln1017">        try</a>
<a name="ln1018">        {</a>
<a name="ln1019">            if (Keyboard.Modifiers == ModifierKeys.Control)</a>
<a name="ln1020">                ProcessHelper.StartWithShell(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), &quot;ScreenToGif&quot;, &quot;Settings.xaml&quot;));</a>
<a name="ln1021">            else</a>
<a name="ln1022">                Process.Start(&quot;explorer.exe&quot;, $&quot;/select,\&quot;{Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), &quot;ScreenToGif&quot;, &quot;Settings.xaml&quot;)}\&quot;&quot;);</a>
<a name="ln1023">        }</a>
<a name="ln1024">        catch (Exception ex)</a>
<a name="ln1025">        {</a>
<a name="ln1026">            Dialog.Ok(&quot;Open AppData Settings Folder&quot;, &quot;Impossible to open where the AppData settings is located&quot;, ex.Message);</a>
<a name="ln1027">        }</a>
<a name="ln1028">    }</a>
<a name="ln1029"> </a>
<a name="ln1030">    private void RemoveAppDataSettings_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1031">    {</a>
<a name="ln1032">        try</a>
<a name="ln1033">        {</a>
<a name="ln1034">            UserSettings.RemoveAppDataSettings();</a>
<a name="ln1035"> </a>
<a name="ln1036">            AppDataPathTextBlock.TextDecorations.Add(new TextDecoration(TextDecorationLocation.Strikethrough,</a>
<a name="ln1037">                new Pen(Brushes.DarkSlateGray, 1), 0, TextDecorationUnit.FontRecommended, TextDecorationUnit.FontRecommended));</a>
<a name="ln1038"> </a>
<a name="ln1039">            AppDataPathTextBlock.SetResourceReference(ToolTipProperty, &quot;S.Options.Storage.NotExists&quot;);</a>
<a name="ln1040">        }</a>
<a name="ln1041">        catch (Exception ex)</a>
<a name="ln1042">        {</a>
<a name="ln1043">            Dialog.Ok(&quot;Remove AppData Settings&quot;, &quot;Impossible to remove AppData settings&quot;, ex.Message);</a>
<a name="ln1044">        }</a>
<a name="ln1045">    }</a>
<a name="ln1046"> </a>
<a name="ln1047">    private void CreateLocalSettings_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1048">    {</a>
<a name="ln1049">        try</a>
<a name="ln1050">        {</a>
<a name="ln1051">            UserSettings.CreateLocalSettings();</a>
<a name="ln1052"> </a>
<a name="ln1053">            LocalPathTextBlock.TextDecorations.Clear();</a>
<a name="ln1054">            LocalPathTextBlock.ClearValue(ToolTipProperty);</a>
<a name="ln1055">        }</a>
<a name="ln1056">        catch (Exception ex)</a>
<a name="ln1057">        {</a>
<a name="ln1058">            Dialog.Ok(&quot;Create Local Settings&quot;, &quot;Impossible to create local settings&quot;, ex.Message);</a>
<a name="ln1059">        }</a>
<a name="ln1060">    }</a>
<a name="ln1061"> </a>
<a name="ln1062">    private void OpenLocalSettings_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1063">    {</a>
<a name="ln1064">        try</a>
<a name="ln1065">        {</a>
<a name="ln1066">            if (Keyboard.Modifiers == ModifierKeys.Control)</a>
<a name="ln1067">                ProcessHelper.StartWithShell(Path.Combine(AppDomain.CurrentDomain.BaseDirectory, &quot;Settings.xaml&quot;));</a>
<a name="ln1068">            else</a>
<a name="ln1069">                Process.Start(&quot;explorer.exe&quot;, $&quot;/select,\&quot;{Path.Combine(AppDomain.CurrentDomain.BaseDirectory, &quot;Settings.xaml&quot;)}\&quot;&quot;);</a>
<a name="ln1070">        }</a>
<a name="ln1071">        catch (Exception ex)</a>
<a name="ln1072">        {</a>
<a name="ln1073">            Dialog.Ok(&quot;Open AppData Local Folder&quot;, &quot;Impossible to open where the Local settings file is located&quot;, ex.Message);</a>
<a name="ln1074">        }</a>
<a name="ln1075">    }</a>
<a name="ln1076"> </a>
<a name="ln1077">    private void RemoveLocalSettings_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1078">    {</a>
<a name="ln1079">        try</a>
<a name="ln1080">        {</a>
<a name="ln1081">            UserSettings.RemoveLocalSettings();</a>
<a name="ln1082"> </a>
<a name="ln1083">            LocalPathTextBlock.TextDecorations.Add(new TextDecoration(TextDecorationLocation.Strikethrough,</a>
<a name="ln1084">                new Pen(Brushes.DarkSlateGray, 1), 0, TextDecorationUnit.FontRecommended, TextDecorationUnit.FontRecommended));</a>
<a name="ln1085"> </a>
<a name="ln1086">            LocalPathTextBlock.SetResourceReference(ToolTipProperty, &quot;S.Options.Storage.NotExists&quot;);</a>
<a name="ln1087">        }</a>
<a name="ln1088">        catch (Exception ex)</a>
<a name="ln1089">        {</a>
<a name="ln1090">            Dialog.Ok(&quot;Remove Local Settings&quot;, &quot;Impossible to remove local settings&quot;, ex.Message);</a>
<a name="ln1091">        }</a>
<a name="ln1092">    }</a>
<a name="ln1093"> </a>
<a name="ln1094"> </a>
<a name="ln1095">    private async void CheckSpace(bool force = false)</a>
<a name="ln1096">    {</a>
<a name="ln1097">        if (_isBusy &amp;&amp; !force)</a>
<a name="ln1098">            return;</a>
<a name="ln1099"> </a>
<a name="ln1100">        _isBusy = true;</a>
<a name="ln1101">        StatusProgressBar.State = ExtendedProgressBar.ProgressState.Primary;</a>
<a name="ln1102">        StatusProgressBar.IsIndeterminate = true;</a>
<a name="ln1103">        FilesTextBlock.Visibility = Visibility.Collapsed;</a>
<a name="ln1104"> </a>
<a name="ln1105">        #region Status</a>
<a name="ln1106"> </a>
<a name="ln1107">        var path = Util.Other.AdjustPath(UserSettings.All.TemporaryFolderResolved);</a>
<a name="ln1108">        var drive = DriveInfo.GetDrives().FirstOrDefault(w =&gt; w.RootDirectory.FullName == Path.GetPathRoot(path));</a>
<a name="ln1109"> </a>
<a name="ln1110">        if (drive != null)</a>
<a name="ln1111">        {</a>
<a name="ln1112">            VolumeTextBlock.Text = $&quot;{drive.VolumeLabel} ({drive.Name.TrimEnd(Path.DirectorySeparatorChar).TrimEnd(Path.AltDirectorySeparatorChar)})&quot;.TrimStart();</a>
<a name="ln1113">            FreeSpaceTextBlock.Text = LocalizationHelper.GetWithFormat(&quot;S.Options.Storage.Status.FreeSpace&quot;, &quot;{0} free of {1}&quot;, Humanizer.BytesToString(drive.TotalFreeSpace), Humanizer.BytesToString(drive.TotalSize));</a>
<a name="ln1114">            StatusProgressBar.Value = 100 - ((double)drive.AvailableFreeSpace / drive.TotalSize * 100);</a>
<a name="ln1115">            StatusProgressBar.State = StatusProgressBar.Value &lt; 90 ? ExtendedProgressBar.ProgressState.Info : ExtendedProgressBar.ProgressState.Danger;</a>
<a name="ln1116">            LowSpaceTextBlock.Visibility = drive.AvailableFreeSpace &gt; 2_000_000_000 ? Visibility.Collapsed : Visibility.Visible; //2 GB.</a>
<a name="ln1117">        }</a>
<a name="ln1118">        else</a>
<a name="ln1119">        {</a>
<a name="ln1120">            VolumeTextBlock.Text = Path.GetPathRoot(path);</a>
<a name="ln1121">            FreeSpaceTextBlock.Text = LocalizationHelper.Get(&quot;S.Options.Storage.Status.Error&quot;);</a>
<a name="ln1122">            StatusProgressBar.Value = 0;</a>
<a name="ln1123">            LowSpaceTextBlock.Visibility = Visibility.Collapsed;</a>
<a name="ln1124">        }</a>
<a name="ln1125"> </a>
<a name="ln1126">        #endregion</a>
<a name="ln1127"> </a>
<a name="ln1128">        //Calculates the quantity of files and folders.</a>
<a name="ln1129">        await Task.Run(CheckDrive);</a>
<a name="ln1130"> </a>
<a name="ln1131">        try</a>
<a name="ln1132">        {</a>
<a name="ln1133">            App.MainViewModel.CheckDiskSpace();</a>
<a name="ln1134"> </a>
<a name="ln1135">            FilesRun.Text = _fileCount == 0 ? LocalizationHelper.Get(&quot;S.Options.Storage.Status.Files.None&quot;) :</a>
<a name="ln1136">                LocalizationHelper.GetWithFormat(&quot;S.Options.Storage.Status.Files.&quot; + (_fileCount &gt; 1 ? &quot;Plural&quot; : &quot;Singular&quot;), &quot;{0} files&quot;, _fileCount);</a>
<a name="ln1137">            FoldersRun.Text = _folderList.Count == 0 ? LocalizationHelper.Get(&quot;S.Options.Storage.Status.Folders.None&quot;) :</a>
<a name="ln1138">                LocalizationHelper.GetWithFormat(&quot;S.Options.Storage.Status.Folders.&quot; + (_folderList.Count &gt; 1 ? &quot;Plural&quot; : &quot;Singular&quot;), &quot;{0} folders&quot;, _folderList.Count);</a>
<a name="ln1139">            UsedSpaceRun.Text = LocalizationHelper.GetWithFormat(&quot;S.Options.Storage.Status.InUse&quot;, &quot;{0} in use&quot;, Humanizer.BytesToString(_cacheSize));</a>
<a name="ln1140">            FilesTextBlock.Visibility = Visibility.Visible;</a>
<a name="ln1141">            StatusProgressBar.IsIndeterminate = false;</a>
<a name="ln1142">        }</a>
<a name="ln1143">        catch (Exception)</a>
<a name="ln1144">        { }</a>
<a name="ln1145">        finally</a>
<a name="ln1146">        {</a>
<a name="ln1147">            _isBusy = false;</a>
<a name="ln1148">        }</a>
<a name="ln1149">    }</a>
<a name="ln1150"> </a>
<a name="ln1151">    private void CheckDrive()</a>
<a name="ln1152">    {</a>
<a name="ln1153">        _folderList = new List&lt;DirectoryInfo&gt;();</a>
<a name="ln1154"> </a>
<a name="ln1155">        var path = Util.Other.AdjustPath(UserSettings.All.TemporaryFolderResolved);</a>
<a name="ln1156">        var cache = Path.Combine(path, &quot;ScreenToGif&quot;, &quot;Recording&quot;);</a>
<a name="ln1157"> </a>
<a name="ln1158">        if (!Directory.Exists(cache))</a>
<a name="ln1159">        {</a>
<a name="ln1160">            _folderList = new List&lt;DirectoryInfo&gt;();</a>
<a name="ln1161">            _fileCount = 0;</a>
<a name="ln1162">            _cacheSize = 0;</a>
<a name="ln1163">            return;</a>
<a name="ln1164">        }</a>
<a name="ln1165"> </a>
<a name="ln1166">        _folderList = Directory.GetDirectories(cache).Select(x =&gt; new DirectoryInfo(x)).ToList();</a>
<a name="ln1167">        _fileCount = _folderList.Sum(folder =&gt; Directory.EnumerateFiles(folder.FullName).Count());</a>
<a name="ln1168">        _cacheSize = _folderList.Sum(s =&gt; s.EnumerateFiles(&quot;*.*&quot;, SearchOption.AllDirectories).Sum(fi =&gt; fi.Length));</a>
<a name="ln1169">    }</a>
<a name="ln1170"> </a>
<a name="ln1171">    #endregion</a>
<a name="ln1172"> </a>
<a name="ln1173">    #region Cloud Services</a>
<a name="ln1174"> </a>
<a name="ln1175">    private void CloudGrid_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln1176">    {</a>
<a name="ln1177">        var list = UserSettings.All.UploadPresets?.Cast&lt;UploadPreset&gt;().ToList() ?? new List&lt;UploadPreset&gt;();</a>
<a name="ln1178"> </a>
<a name="ln1179">        UploadDataGrid.ItemsSource = _uploadList = new ObservableCollection&lt;UploadPreset&gt;(list);</a>
<a name="ln1180">    }</a>
<a name="ln1181"> </a>
<a name="ln1182">    private void AddUpload_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1183">    {</a>
<a name="ln1184">        e.CanExecute = CloudGrid.IsVisible;</a>
<a name="ln1185">    }</a>
<a name="ln1186"> </a>
<a name="ln1187">    private void Upload_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1188">    {</a>
<a name="ln1189">        e.CanExecute = CloudGrid.IsVisible &amp;&amp; UploadDataGrid.SelectedIndex != -1;</a>
<a name="ln1190">    }</a>
<a name="ln1191"> </a>
<a name="ln1192">    private void AddUpload_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1193">    {</a>
<a name="ln1194">        var upload = new Upload();</a>
<a name="ln1195">        var result = upload.ShowDialog();</a>
<a name="ln1196"> </a>
<a name="ln1197">        if (result != true)</a>
<a name="ln1198">            return;</a>
<a name="ln1199"> </a>
<a name="ln1200">        _uploadList.Add(upload.CurrentPreset);</a>
<a name="ln1201"> </a>
<a name="ln1202">        UserSettings.All.UploadPresets = new ArrayList(_uploadList.ToArray());</a>
<a name="ln1203">    }</a>
<a name="ln1204"> </a>
<a name="ln1205">    private void EditUpload_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1206">    {</a>
<a name="ln1207">        var index = UploadDataGrid.SelectedIndex;</a>
<a name="ln1208">        var current = _uploadList[UploadDataGrid.SelectedIndex];</a>
<a name="ln1209">        var selected = current.ShallowCopy();</a>
<a name="ln1210"> </a>
<a name="ln1211">        var preset = new Upload { CurrentPreset = selected, IsEditing = true };</a>
<a name="ln1212">        var result = preset.ShowDialog();</a>
<a name="ln1213"> </a>
<a name="ln1214">        if (result != true)</a>
<a name="ln1215">            return;</a>
<a name="ln1216"> </a>
<a name="ln1217">        _uploadList[UploadDataGrid.SelectedIndex] = preset.CurrentPreset;</a>
<a name="ln1218">        UploadDataGrid.Items.Refresh();</a>
<a name="ln1219">        UploadDataGrid.SelectedIndex = index;</a>
<a name="ln1220"> </a>
<a name="ln1221">        //Update the upload preset in all export presets.</a>
<a name="ln1222">        if (current.Title != preset.CurrentPreset.Title)</a>
<a name="ln1223">        {</a>
<a name="ln1224">            foreach (var exportPreset in UserSettings.All.ExportPresets.OfType&lt;ExportPreset&gt;().Where(w =&gt; w.UploadService == current.Title))</a>
<a name="ln1225">                exportPreset.UploadService = preset.CurrentPreset.Title;</a>
<a name="ln1226">        }</a>
<a name="ln1227"> </a>
<a name="ln1228">        UserSettings.All.UploadPresets = new ArrayList(_uploadList.ToArray());</a>
<a name="ln1229">    }</a>
<a name="ln1230"> </a>
<a name="ln1231">    private void RemoveUpload_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1232">    {</a>
<a name="ln1233">        var index = UploadDataGrid.SelectedIndex;</a>
<a name="ln1234"> </a>
<a name="ln1235">        //Ask if the user really wants to remove the preset.</a>
<a name="ln1236">        if (index &lt; 0 || !Dialog.Ask(LocalizationHelper.Get(&quot;S.SaveAs.Upload.Ask.Delete.Title&quot;), LocalizationHelper.Get(&quot;S.SaveAs.Upload.Ask.Delete.Instruction&quot;),</a>
<a name="ln1237">                LocalizationHelper.Get(&quot;S.SaveAs.Upload.Ask.Delete.Message&quot;)))</a>
<a name="ln1238">            return;</a>
<a name="ln1239"> </a>
<a name="ln1240">        var selected = _uploadList[UploadDataGrid.SelectedIndex];</a>
<a name="ln1241">        _uploadList.RemoveAt(UploadDataGrid.SelectedIndex);</a>
<a name="ln1242"> </a>
<a name="ln1243">        //Automatically selects the closest item from the position of the one that was removed.</a>
<a name="ln1244">        UploadDataGrid.SelectedIndex = _uploadList.Count == 0 ? -1 : _uploadList.Count &lt;= index ? _uploadList.Count - 1 : index;</a>
<a name="ln1245"> </a>
<a name="ln1246">        UserSettings.All.UploadPresets = new ArrayList(_uploadList.ToArray());</a>
<a name="ln1247"> </a>
<a name="ln1248">        //Remove the upload preset from all export presets.</a>
<a name="ln1249">        foreach (var exportPreset in UserSettings.All.ExportPresets.OfType&lt;ExportPreset&gt;().Where(w =&gt; w.UploadService == selected.Title))</a>
<a name="ln1250">            exportPreset.UploadService = null;</a>
<a name="ln1251">    }</a>
<a name="ln1252"> </a>
<a name="ln1253">    private void HistoryUpload_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1254">    {</a>
<a name="ln1255">        var history = new UploadHistory</a>
<a name="ln1256">        {</a>
<a name="ln1257">            CurrentPreset = _uploadList[UploadDataGrid.SelectedIndex]</a>
<a name="ln1258">        };</a>
<a name="ln1259">        history.ShowDialog();</a>
<a name="ln1260">    }</a>
<a name="ln1261"> </a>
<a name="ln1262">    private void UploadDataGrid_MouseDoubleClick(object sender, MouseButtonEventArgs e)</a>
<a name="ln1263">    {</a>
<a name="ln1264">        if (EditUploadCommandBinding.Command.CanExecute(sender))</a>
<a name="ln1265">            EditUploadCommandBinding.Command.Execute(sender);</a>
<a name="ln1266">    }</a>
<a name="ln1267"> </a>
<a name="ln1268">    private void UploadDataGrid_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln1269">    {</a>
<a name="ln1270">        if (e.Key == Key.Enter &amp;&amp; EditUploadCommandBinding.Command.CanExecute(sender))</a>
<a name="ln1271">        {</a>
<a name="ln1272">            EditUploadCommandBinding.Command.Execute(sender);</a>
<a name="ln1273">            e.Handled = true;</a>
<a name="ln1274">        }</a>
<a name="ln1275"> </a>
<a name="ln1276">        if (e.Key == Key.Space)</a>
<a name="ln1277">        {</a>
<a name="ln1278">            if (UploadDataGrid.SelectedItem is not UploadPreset selected)</a>
<a name="ln1279">                return;</a>
<a name="ln1280"> </a>
<a name="ln1281">            selected.IsEnabled = !selected.IsEnabled;</a>
<a name="ln1282">            e.Handled = true;</a>
<a name="ln1283">        }</a>
<a name="ln1284">    }</a>
<a name="ln1285"> </a>
<a name="ln1286">    #endregion</a>
<a name="ln1287"> </a>
<a name="ln1288">    #region Extras</a>
<a name="ln1289"> </a>
<a name="ln1290">    private void ExtrasGrid_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln1291">    {</a>
<a name="ln1292">        CheckTools();</a>
<a name="ln1293"> </a>
<a name="ln1294">        //Gifski is only supported in x64.</a>
<a name="ln1295">        GifskiImageCard.IsEnabled = Environment.Is64BitProcess;</a>
<a name="ln1296">    }</a>
<a name="ln1297"> </a>
<a name="ln1298">    private async void FfmpegImageCard_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1299">    {</a>
<a name="ln1300">        CheckTools(true, false);</a>
<a name="ln1301"> </a>
<a name="ln1302">        var adjusted = Util.Other.AdjustPath(UserSettings.All.FfmpegLocation);</a>
<a name="ln1303"> </a>
<a name="ln1304">        if (!string.IsNullOrWhiteSpace(adjusted) &amp;&amp; File.Exists(adjusted))</a>
<a name="ln1305">        {</a>
<a name="ln1306">            Native.Helpers.Other.ShowFileProperties(Path.GetFullPath(adjusted));</a>
<a name="ln1307">            return;</a>
<a name="ln1308">        }</a>
<a name="ln1309"> </a>
<a name="ln1310">        var url = Environment.Is64BitProcess ? &quot;https://www.screentogif.com/downloads/FFmpeg-4.4.1-x64.zip&quot; :</a>
<a name="ln1311">            &quot;https://www.screentogif.com/downloads/FFmpeg-4.3.1-x86.zip&quot;;</a>
<a name="ln1312"> </a>
<a name="ln1313">#if FULL_MULTI_MSIX_STORE</a>
<a name="ln1314">            StatusBand.Warning(LocalizationHelper.Get(&quot;S.Options.Extras.DownloadRestriction&quot;));</a>
<a name="ln1315">            ProcessHelper.StartWithShell(url);            </a>
<a name="ln1316">            return;</a>
<a name="ln1317">#else</a>
<a name="ln1318">        #region Save as</a>
<a name="ln1319"> </a>
<a name="ln1320">        var output = UserSettings.All.FfmpegLocation ?? &quot;&quot;;</a>
<a name="ln1321"> </a>
<a name="ln1322">        if (output.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln1323">            output = &quot;&quot;;</a>
<a name="ln1324"> </a>
<a name="ln1325">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln1326">        var isRelative = !string.IsNullOrWhiteSpace(output) &amp;&amp; !Path.IsPathRooted(output);</a>
<a name="ln1327">        var notAlt = !string.IsNullOrWhiteSpace(output) &amp;&amp; output.Contains(Path.DirectorySeparatorChar);</a>
<a name="ln1328"> </a>
<a name="ln1329">        var name = Path.GetFileNameWithoutExtension(output) ?? &quot;&quot;;</a>
<a name="ln1330">        var directory = !string.IsNullOrWhiteSpace(output) ? Path.GetDirectoryName(output) : &quot;&quot;;</a>
<a name="ln1331">        var initial = Directory.Exists(directory) ? directory : Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</a>
<a name="ln1332"> </a>
<a name="ln1333">        var sfd = new SaveFileDialog</a>
<a name="ln1334">        {</a>
<a name="ln1335">            FileName = string.IsNullOrWhiteSpace(name) ? &quot;ffmpeg&quot; : name,</a>
<a name="ln1336">            InitialDirectory = isRelative ? Path.GetFullPath(initial) : initial,</a>
<a name="ln1337">            Filter = $&quot;{LocalizationHelper.Get(&quot;S.Options.Extras.FfmpegLocation.File&quot;)} (.exe)|*.exe&quot;,</a>
<a name="ln1338">            DefaultExt = &quot;.exe&quot;</a>
<a name="ln1339">        };</a>
<a name="ln1340"> </a>
<a name="ln1341">        var result = sfd.ShowDialog();</a>
<a name="ln1342"> </a>
<a name="ln1343">        if (!result.HasValue || !result.Value) return;</a>
<a name="ln1344"> </a>
<a name="ln1345">        UserSettings.All.FfmpegLocation = sfd.FileName;</a>
<a name="ln1346"> </a>
<a name="ln1347">        //Converts to a relative path again.</a>
<a name="ln1348">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.FfmpegLocation))</a>
<a name="ln1349">        {</a>
<a name="ln1350">            var selected = new Uri(UserSettings.All.FfmpegLocation);</a>
<a name="ln1351">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln1352">            var relativeFolder = Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln1353"> </a>
<a name="ln1354">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln1355">            UserSettings.All.FfmpegLocation = notAlt ? relativeFolder : relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln1356">        }</a>
<a name="ln1357"> </a>
<a name="ln1358">        #endregion</a>
<a name="ln1359"> </a>
<a name="ln1360">        #region Download</a>
<a name="ln1361"> </a>
<a name="ln1362">        ExtrasGrid.IsEnabled = false;</a>
<a name="ln1363">        Cursor = Cursors.AppStarting;</a>
<a name="ln1364">        FfmpegImageCard.Status = ExtrasStatus.Processing;</a>
<a name="ln1365">        FfmpegImageCard.Description = LocalizationHelper.Get(&quot;S.Options.Extras.Downloading&quot;);</a>
<a name="ln1366"> </a>
<a name="ln1367">        try</a>
<a name="ln1368">        {</a>
<a name="ln1369">            //Save to a temp folder.</a>
<a name="ln1370">            var temp = Path.Combine(Path.GetTempPath(), Path.GetTempFileName());</a>
<a name="ln1371"> </a>
<a name="ln1372">            using (var client = new WebClient { Proxy = WebHelper.GetProxy() })</a>
<a name="ln1373">                await client.DownloadFileTaskAsync(new Uri(url), temp);</a>
<a name="ln1374"> </a>
<a name="ln1375">            using (var zip = ZipFile.Open(temp, ZipArchiveMode.Read))</a>
<a name="ln1376">            {</a>
<a name="ln1377">                var entry = zip.Entries.FirstOrDefault(x =&gt; x.Name.Contains(&quot;ffmpeg.exe&quot;));</a>
<a name="ln1378"> </a>
<a name="ln1379">                if (File.Exists(UserSettings.All.FfmpegLocation))</a>
<a name="ln1380">                    File.Delete(UserSettings.All.FfmpegLocation);</a>
<a name="ln1381"> </a>
<a name="ln1382">                entry?.ExtractToFile(UserSettings.All.FfmpegLocation, true);</a>
<a name="ln1383">            }</a>
<a name="ln1384">        }</a>
<a name="ln1385">        catch (Exception ex)</a>
<a name="ln1386">        {</a>
<a name="ln1387">            LogWriter.Log(ex, &quot;Error while downloading FFmpeg&quot;);</a>
<a name="ln1388">            ExceptionDialog.Ok(ex, &quot;Downloading FFmpeg&quot;, &quot;It was not possible to download FFmpeg&quot;, ex.Message);</a>
<a name="ln1389">        }</a>
<a name="ln1390">        finally</a>
<a name="ln1391">        {</a>
<a name="ln1392">            ExtrasGrid.IsEnabled = true;</a>
<a name="ln1393">            Cursor = Cursors.Arrow;</a>
<a name="ln1394">            CheckTools();</a>
<a name="ln1395">        }</a>
<a name="ln1396"> </a>
<a name="ln1397">        #endregion</a>
<a name="ln1398">#endif</a>
<a name="ln1399">    }</a>
<a name="ln1400"> </a>
<a name="ln1401">    private async void GifskiImageCard_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1402">    {</a>
<a name="ln1403">        CheckTools(false, true);</a>
<a name="ln1404"> </a>
<a name="ln1405">        var adjusted = Util.Other.AdjustPath(UserSettings.All.GifskiLocation);</a>
<a name="ln1406"> </a>
<a name="ln1407">        if (!string.IsNullOrWhiteSpace(adjusted) &amp;&amp; File.Exists(adjusted))</a>
<a name="ln1408">        {</a>
<a name="ln1409">            Native.Helpers.Other.ShowFileProperties(Path.GetFullPath(adjusted));</a>
<a name="ln1410">            return;</a>
<a name="ln1411">        }</a>
<a name="ln1412"> </a>
<a name="ln1413">#if FULL_MULTI_MSIX_STORE</a>
<a name="ln1414">            StatusBand.Warning(LocalizationHelper.Get(&quot;S.Options.Extras.DownloadRestriction&quot;));</a>
<a name="ln1415">            return;</a>
<a name="ln1416">#else</a>
<a name="ln1417">        #region Save as</a>
<a name="ln1418"> </a>
<a name="ln1419">        var output = UserSettings.All.GifskiLocation ?? &quot;&quot;;</a>
<a name="ln1420"> </a>
<a name="ln1421">        if (output.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln1422">            output = &quot;&quot;;</a>
<a name="ln1423"> </a>
<a name="ln1424">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln1425">        var isRelative = !string.IsNullOrWhiteSpace(output) &amp;&amp; !Path.IsPathRooted(output);</a>
<a name="ln1426">        var notAlt = !string.IsNullOrWhiteSpace(output) &amp;&amp; output.Contains(Path.DirectorySeparatorChar);</a>
<a name="ln1427"> </a>
<a name="ln1428">        var name = Path.GetFileNameWithoutExtension(output) ?? &quot;&quot;;</a>
<a name="ln1429">        var directory = !string.IsNullOrWhiteSpace(output) ? Path.GetDirectoryName(output) : &quot;&quot;;</a>
<a name="ln1430">        var initial = Directory.Exists(directory) ? directory : AppDomain.CurrentDomain.BaseDirectory;</a>
<a name="ln1431"> </a>
<a name="ln1432">        var sfd = new SaveFileDialog</a>
<a name="ln1433">        {</a>
<a name="ln1434">            FileName = string.IsNullOrWhiteSpace(name) ? &quot;gifski&quot; : name,</a>
<a name="ln1435">            InitialDirectory = isRelative ? Path.GetFullPath(initial) : initial,</a>
<a name="ln1436">            Filter = $&quot;{LocalizationHelper.Get(&quot;S.Options.Extras.GifskiLocation.File&quot;)} (.dll)|*.dll&quot;,</a>
<a name="ln1437">            DefaultExt = &quot;.dll&quot;</a>
<a name="ln1438">        };</a>
<a name="ln1439"> </a>
<a name="ln1440">        var result = sfd.ShowDialog();</a>
<a name="ln1441"> </a>
<a name="ln1442">        if (!result.HasValue || !result.Value) return;</a>
<a name="ln1443"> </a>
<a name="ln1444">        UserSettings.All.GifskiLocation = sfd.FileName;</a>
<a name="ln1445"> </a>
<a name="ln1446">        //Converts to a relative path again.</a>
<a name="ln1447">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.GifskiLocation))</a>
<a name="ln1448">        {</a>
<a name="ln1449">            var selected = new Uri(UserSettings.All.GifskiLocation);</a>
<a name="ln1450">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln1451">            var relativeFolder = Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln1452"> </a>
<a name="ln1453">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln1454">            UserSettings.All.GifskiLocation = notAlt ? relativeFolder : relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln1455">        }</a>
<a name="ln1456"> </a>
<a name="ln1457">        #endregion</a>
<a name="ln1458"> </a>
<a name="ln1459">        #region Download</a>
<a name="ln1460"> </a>
<a name="ln1461">        ExtrasGrid.IsEnabled = false;</a>
<a name="ln1462">        Cursor = Cursors.AppStarting;</a>
<a name="ln1463">        GifskiImageCard.Status = ExtrasStatus.Processing;</a>
<a name="ln1464">        GifskiImageCard.Description = LocalizationHelper.Get(&quot;S.Options.Extras.Downloading&quot;);</a>
<a name="ln1465"> </a>
<a name="ln1466">        try</a>
<a name="ln1467">        {</a>
<a name="ln1468">            //Save to a temp folder.</a>
<a name="ln1469">            var temp = Path.Combine(Path.GetTempPath(), Path.GetTempFileName());</a>
<a name="ln1470"> </a>
<a name="ln1471">            using (var client = new WebClient { Proxy = WebHelper.GetProxy() })</a>
<a name="ln1472">                await client.DownloadFileTaskAsync(new Uri(&quot;https://www.screentogif.com/downloads/Gifski.zip&quot;, UriKind.Absolute), temp);</a>
<a name="ln1473"> </a>
<a name="ln1474">            using (var zip = ZipFile.Open(temp, ZipArchiveMode.Read))</a>
<a name="ln1475">            {</a>
<a name="ln1476">                var entry = zip.Entries.FirstOrDefault(x =&gt; x.Name.Contains(&quot;gifski.dll&quot;));</a>
<a name="ln1477"> </a>
<a name="ln1478">                if (File.Exists(UserSettings.All.GifskiLocation))</a>
<a name="ln1479">                    File.Delete(UserSettings.All.GifskiLocation);</a>
<a name="ln1480"> </a>
<a name="ln1481">                entry?.ExtractToFile(UserSettings.All.GifskiLocation, true);</a>
<a name="ln1482">            }</a>
<a name="ln1483">        }</a>
<a name="ln1484">        catch (Exception ex)</a>
<a name="ln1485">        {</a>
<a name="ln1486">            LogWriter.Log(ex, &quot;Error while downloading Gifski&quot;);</a>
<a name="ln1487">            ErrorDialog.Ok(&quot;Downloading Gifski&quot;, &quot;It was not possible to download Gifski&quot;, ex.Message, ex);</a>
<a name="ln1488">        }</a>
<a name="ln1489">        finally</a>
<a name="ln1490">        {</a>
<a name="ln1491">            ExtrasGrid.IsEnabled = true;</a>
<a name="ln1492">            Cursor = Cursors.Arrow;</a>
<a name="ln1493">            CheckTools();</a>
<a name="ln1494">        }</a>
<a name="ln1495"> </a>
<a name="ln1496">        #endregion</a>
<a name="ln1497">#endif</a>
<a name="ln1498">    }</a>
<a name="ln1499"> </a>
<a name="ln1500">    private void LocationTextBox_LostKeyboardFocus(object sender, KeyboardFocusChangedEventArgs e)</a>
<a name="ln1501">    {</a>
<a name="ln1502">        var box = sender as TextBox;</a>
<a name="ln1503"> </a>
<a name="ln1504">        CheckTools(box?.Tag?.Equals(&quot;FFmpeg&quot;) ?? false, box?.Tag?.Equals(&quot;Gifski&quot;) ?? false);</a>
<a name="ln1505">    }</a>
<a name="ln1506"> </a>
<a name="ln1507"> </a>
<a name="ln1508">    private void SelectFfmpeg_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1509">    {</a>
<a name="ln1510">        var output = UserSettings.All.FfmpegLocation ?? &quot;&quot;;</a>
<a name="ln1511"> </a>
<a name="ln1512">        if (output.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln1513">            output = &quot;&quot;;</a>
<a name="ln1514"> </a>
<a name="ln1515">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln1516">        var isRelative = !string.IsNullOrWhiteSpace(output) &amp;&amp; !Path.IsPathRooted(output);</a>
<a name="ln1517">        var notAlt = !string.IsNullOrWhiteSpace(output) &amp;&amp; (UserSettings.All.FfmpegLocation ?? &quot;&quot;).Contains(Path.DirectorySeparatorChar);</a>
<a name="ln1518"> </a>
<a name="ln1519">        //Gets the current directory folder, where the file is located. If empty, it means that the path is relative.</a>
<a name="ln1520">        var directory = !string.IsNullOrWhiteSpace(output) ? Path.GetDirectoryName(output) : &quot;&quot;;</a>
<a name="ln1521"> </a>
<a name="ln1522">        if (!string.IsNullOrWhiteSpace(output) &amp;&amp; string.IsNullOrWhiteSpace(directory))</a>
<a name="ln1523">            directory = AppDomain.CurrentDomain.BaseDirectory;</a>
<a name="ln1524"> </a>
<a name="ln1525">        var initial = Directory.Exists(directory) ? directory : Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</a>
<a name="ln1526"> </a>
<a name="ln1527">        var ofd = new OpenFileDialog</a>
<a name="ln1528">        {</a>
<a name="ln1529">            FileName = &quot;ffmpeg&quot;,</a>
<a name="ln1530">            Filter = $&quot;{LocalizationHelper.Get(&quot;S.Options.Extras.FfmpegLocation.File&quot;)} (*.exe)|*.exe&quot;, //TODO: Localize.</a>
<a name="ln1531">            Title = LocalizationHelper.Get(&quot;S.Options.Extras.FfmpegLocation.Select&quot;),</a>
<a name="ln1532">            InitialDirectory = isRelative ? Path.GetFullPath(initial) : initial,</a>
<a name="ln1533">            DefaultExt = &quot;.exe&quot;</a>
<a name="ln1534">        };</a>
<a name="ln1535"> </a>
<a name="ln1536">        var result = ofd.ShowDialog();</a>
<a name="ln1537"> </a>
<a name="ln1538">        if (!result.HasValue || !result.Value)</a>
<a name="ln1539">            return;</a>
<a name="ln1540"> </a>
<a name="ln1541">        UserSettings.All.FfmpegLocation = ofd.FileName;</a>
<a name="ln1542"> </a>
<a name="ln1543">        //Converts to a relative path again.</a>
<a name="ln1544">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.FfmpegLocation))</a>
<a name="ln1545">        {</a>
<a name="ln1546">            var selected = new Uri(UserSettings.All.FfmpegLocation);</a>
<a name="ln1547">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln1548">            var relativeFolder = Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln1549"> </a>
<a name="ln1550">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln1551">            UserSettings.All.FfmpegLocation = notAlt ? relativeFolder : relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln1552">        }</a>
<a name="ln1553"> </a>
<a name="ln1554">        CheckTools(true, false);</a>
<a name="ln1555">    }</a>
<a name="ln1556"> </a>
<a name="ln1557">    private void SelectGifski_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1558">    {</a>
<a name="ln1559">        var output = UserSettings.All.GifskiLocation ?? &quot;&quot;;</a>
<a name="ln1560"> </a>
<a name="ln1561">        if (output.ToCharArray().Any(x =&gt; Path.GetInvalidPathChars().Contains(x)))</a>
<a name="ln1562">            output = &quot;&quot;;</a>
<a name="ln1563"> </a>
<a name="ln1564">        //It's only a relative path if not null/empty and there's no root folder declared.</a>
<a name="ln1565">        var isRelative = !string.IsNullOrWhiteSpace(output) &amp;&amp; !Path.IsPathRooted(output);</a>
<a name="ln1566">        var notAlt = !string.IsNullOrWhiteSpace(output) &amp;&amp; (UserSettings.All.GifskiLocation ?? &quot;&quot;).Contains(Path.DirectorySeparatorChar);</a>
<a name="ln1567"> </a>
<a name="ln1568">        //Gets the current directory folder, where the file is located. If empty, it means that the path is relative.</a>
<a name="ln1569">        var directory = !string.IsNullOrWhiteSpace(output) ? Path.GetDirectoryName(output) : &quot;&quot;;</a>
<a name="ln1570"> </a>
<a name="ln1571">        if (!string.IsNullOrWhiteSpace(output) &amp;&amp; string.IsNullOrWhiteSpace(directory))</a>
<a name="ln1572">            directory = AppDomain.CurrentDomain.BaseDirectory;</a>
<a name="ln1573"> </a>
<a name="ln1574">        var initial = Directory.Exists(directory) ? directory : Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</a>
<a name="ln1575"> </a>
<a name="ln1576">        var ofd = new OpenFileDialog</a>
<a name="ln1577">        {</a>
<a name="ln1578">            FileName = &quot;gifski&quot;,</a>
<a name="ln1579">            Filter = $&quot;{LocalizationHelper.Get(&quot;S.Options.Extras.GifskiLocation.File&quot;)} (*.dll)|*.dll&quot;, //TODO: Localize.</a>
<a name="ln1580">            Title = LocalizationHelper.Get(&quot;S.Options.Extras.GifskiLocation.Select&quot;),</a>
<a name="ln1581">            InitialDirectory = isRelative ? Path.GetFullPath(initial) : initial,</a>
<a name="ln1582">            DefaultExt = &quot;.dll&quot;</a>
<a name="ln1583">        };</a>
<a name="ln1584"> </a>
<a name="ln1585">        var result = ofd.ShowDialog();</a>
<a name="ln1586"> </a>
<a name="ln1587">        if (!result.HasValue || !result.Value)</a>
<a name="ln1588">            return;</a>
<a name="ln1589"> </a>
<a name="ln1590">        UserSettings.All.GifskiLocation = ofd.FileName;</a>
<a name="ln1591"> </a>
<a name="ln1592">        //Converts to a relative path again.</a>
<a name="ln1593">        if (isRelative &amp;&amp; !string.IsNullOrWhiteSpace(UserSettings.All.GifskiLocation))</a>
<a name="ln1594">        {</a>
<a name="ln1595">            var selected = new Uri(UserSettings.All.GifskiLocation);</a>
<a name="ln1596">            var baseFolder = new Uri(AppDomain.CurrentDomain.BaseDirectory);</a>
<a name="ln1597">            var relativeFolder = Uri.UnescapeDataString(baseFolder.MakeRelativeUri(selected).ToString());</a>
<a name="ln1598"> </a>
<a name="ln1599">            //This app even returns you the correct slashes/backslashes.</a>
<a name="ln1600">            UserSettings.All.GifskiLocation = notAlt ? relativeFolder : relativeFolder.Replace(Path.DirectorySeparatorChar, Path.AltDirectorySeparatorChar);</a>
<a name="ln1601">        }</a>
<a name="ln1602"> </a>
<a name="ln1603">        CheckTools(false, true);</a>
<a name="ln1604">    }</a>
<a name="ln1605"> </a>
<a name="ln1606"> </a>
<a name="ln1607">    private void BrowseFfmpeg_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1608">    {</a>
<a name="ln1609">        e.CanExecute = IsLoaded &amp;&amp; FfmpegImageCard.Status == ExtrasStatus.Ready;</a>
<a name="ln1610">    }</a>
<a name="ln1611"> </a>
<a name="ln1612">    private void BrowseGifski_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1613">    {</a>
<a name="ln1614">        e.CanExecute = IsLoaded &amp;&amp; GifskiImageCard.Status == ExtrasStatus.Ready;</a>
<a name="ln1615">    }</a>
<a name="ln1616"> </a>
<a name="ln1617">    private void BrowseFfmpeg_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1618">    {</a>
<a name="ln1619">        try</a>
<a name="ln1620">        {</a>
<a name="ln1621">            var path = Util.Other.AdjustPath(UserSettings.All.FfmpegLocation);</a>
<a name="ln1622"> </a>
<a name="ln1623">            if (string.IsNullOrWhiteSpace(path))</a>
<a name="ln1624">                return;</a>
<a name="ln1625"> </a>
<a name="ln1626">            var folder = Path.GetDirectoryName(path);</a>
<a name="ln1627"> </a>
<a name="ln1628">            if (string.IsNullOrWhiteSpace(folder))</a>
<a name="ln1629">                return;</a>
<a name="ln1630"> </a>
<a name="ln1631">            ProcessHelper.StartWithShell(folder);</a>
<a name="ln1632">        }</a>
<a name="ln1633">        catch (Exception ex)</a>
<a name="ln1634">        {</a>
<a name="ln1635">            LogWriter.Log(ex, &quot;Error while trying to browse the FFmpeg folder.&quot;);</a>
<a name="ln1636">        }</a>
<a name="ln1637">    }</a>
<a name="ln1638"> </a>
<a name="ln1639">    private void BrowseGifski_Execute(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1640">    {</a>
<a name="ln1641">        try</a>
<a name="ln1642">        {</a>
<a name="ln1643">            var path = Util.Other.AdjustPath(UserSettings.All.GifskiLocation);</a>
<a name="ln1644"> </a>
<a name="ln1645">            if (string.IsNullOrWhiteSpace(path))</a>
<a name="ln1646">                return;</a>
<a name="ln1647"> </a>
<a name="ln1648">            var folder = Path.GetDirectoryName(path);</a>
<a name="ln1649"> </a>
<a name="ln1650">            if (string.IsNullOrWhiteSpace(folder))</a>
<a name="ln1651">                return;</a>
<a name="ln1652"> </a>
<a name="ln1653">            ProcessHelper.StartWithShell(folder);</a>
<a name="ln1654">        }</a>
<a name="ln1655">        catch (Exception ex)</a>
<a name="ln1656">        {</a>
<a name="ln1657">            LogWriter.Log(ex, &quot;Error while trying to browse the Gifski folder.&quot;);</a>
<a name="ln1658">        }</a>
<a name="ln1659">    }</a>
<a name="ln1660"> </a>
<a name="ln1661"> </a>
<a name="ln1662">    private void ExtrasHyperlink_OnRequestNavigate(object sender, RequestNavigateEventArgs e)</a>
<a name="ln1663">    {</a>
<a name="ln1664">        try</a>
<a name="ln1665">        {</a>
<a name="ln1666">            ProcessHelper.StartWithShell(e.Uri.AbsoluteUri);</a>
<a name="ln1667">        }</a>
<a name="ln1668">        catch (Exception ex)</a>
<a name="ln1669">        {</a>
<a name="ln1670">            LogWriter.Log(ex, &quot;Error while trying to navigate to the license website.&quot;);</a>
<a name="ln1671">        }</a>
<a name="ln1672">    }</a>
<a name="ln1673"> </a>
<a name="ln1674">    private void CheckTools(bool ffmpeg = true, bool gifski = true)</a>
<a name="ln1675">    {</a>
<a name="ln1676">        if (!IsLoaded)</a>
<a name="ln1677">            return;</a>
<a name="ln1678"> </a>
<a name="ln1679">        try</a>
<a name="ln1680">        {</a>
<a name="ln1681">            if (ffmpeg)</a>
<a name="ln1682">            {</a>
<a name="ln1683">                #region FFmpeg</a>
<a name="ln1684"> </a>
<a name="ln1685">                if (Util.Other.IsFfmpegPresent(true, false))</a>
<a name="ln1686">                {</a>
<a name="ln1687">                    var info = new FileInfo(Util.Other.AdjustPath(UserSettings.All.FfmpegLocation));</a>
<a name="ln1688">                    info.Refresh();</a>
<a name="ln1689"> </a>
<a name="ln1690">                    FfmpegImageCard.Status = ExtrasStatus.Ready;</a>
<a name="ln1691">                    FfmpegImageCard.Description = string.Format(LocalizationHelper.Get(&quot;S.Options.Extras.Ready&quot;, &quot;{0}&quot;), Humanizer.BytesToString(info.Length));</a>
<a name="ln1692">                }</a>
<a name="ln1693">                else</a>
<a name="ln1694">                {</a>
<a name="ln1695">                    FfmpegImageCard.Status = ExtrasStatus.Available;</a>
<a name="ln1696">                    FfmpegImageCard.Description = string.Format(LocalizationHelper.Get(&quot;S.Options.Extras.Download&quot;, &quot;{0}&quot;), Environment.Is64BitProcess ? &quot;~ 43 MB&quot; : &quot;~ 24,6 MB&quot;);</a>
<a name="ln1697">                }</a>
<a name="ln1698"> </a>
<a name="ln1699">                #endregion</a>
<a name="ln1700">            }</a>
<a name="ln1701"> </a>
<a name="ln1702">            if (gifski)</a>
<a name="ln1703">            {</a>
<a name="ln1704">                #region Gifski</a>
<a name="ln1705"> </a>
<a name="ln1706">                if (Util.Other.IsGifskiPresent(true, false))</a>
<a name="ln1707">                {</a>
<a name="ln1708">                    var info = new FileInfo(Util.Other.AdjustPath(UserSettings.All.GifskiLocation));</a>
<a name="ln1709">                    info.Refresh();</a>
<a name="ln1710"> </a>
<a name="ln1711">                    GifskiImageCard.Status = ExtrasStatus.Ready;</a>
<a name="ln1712">                    GifskiImageCard.Description = string.Format(LocalizationHelper.Get(&quot;S.Options.Extras.Ready&quot;, &quot;{0}&quot;), Humanizer.BytesToString(info.Length));</a>
<a name="ln1713">                }</a>
<a name="ln1714">                else</a>
<a name="ln1715">                {</a>
<a name="ln1716">                    GifskiImageCard.Status = ExtrasStatus.Available;</a>
<a name="ln1717">                    GifskiImageCard.Description = string.Format(LocalizationHelper.Get(&quot;S.Options.Extras.Download&quot;, &quot;{0}&quot;), &quot;~ 512 KB&quot;);</a>
<a name="ln1718">                }</a>
<a name="ln1719"> </a>
<a name="ln1720">                #endregion</a>
<a name="ln1721">            }</a>
<a name="ln1722">        }</a>
<a name="ln1723">        catch (Exception ex)</a>
<a name="ln1724">        {</a>
<a name="ln1725">            LogWriter.Log(ex, &quot;Checking the existence of external tools.&quot;);</a>
<a name="ln1726">            StatusBand.Error(&quot;It was not possible to check the existence of the external tools.&quot;);</a>
<a name="ln1727">        }</a>
<a name="ln1728">    }</a>
<a name="ln1729"> </a>
<a name="ln1730">    #endregion</a>
<a name="ln1731"> </a>
<a name="ln1732">    #region Donate</a>
<a name="ln1733"> </a>
<a name="ln1734">    private void DonateButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1735">    {</a>
<a name="ln1736">        try</a>
<a name="ln1737">        {</a>
<a name="ln1738">            ProcessHelper.StartWithShell(&quot;https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=JCY2BGLULSWVJ&amp;lc=US&amp;item_name=ScreenToGif&amp;item_number=screentogif&amp;currency_code=USD&amp;bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted&quot;);</a>
<a name="ln1739">        }</a>
<a name="ln1740">        catch (Exception ex)</a>
<a name="ln1741">        {</a>
<a name="ln1742">            LogWriter.Log(ex, &quot;Error • Opening the Donation website&quot;);</a>
<a name="ln1743">            ErrorDialog.Ok(Title, &quot;Error opening the donation website&quot;, ex.Message, ex);</a>
<a name="ln1744">        }</a>
<a name="ln1745">    }</a>
<a name="ln1746"> </a>
<a name="ln1747">    private void DonateEuroButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1748">    {</a>
<a name="ln1749">        try</a>
<a name="ln1750">        {</a>
<a name="ln1751">            ProcessHelper.StartWithShell(&quot;https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=JCY2BGLULSWVJ&amp;lc=US&amp;item_name=ScreenToGif&amp;item_number=screentogif&amp;currency_code=EUR&amp;bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted&quot;);</a>
<a name="ln1752">        }</a>
<a name="ln1753">        catch (Exception ex)</a>
<a name="ln1754">        {</a>
<a name="ln1755">            LogWriter.Log(ex, &quot;Error • Opening the Donation website&quot;);</a>
<a name="ln1756"> </a>
<a name="ln1757">            ErrorDialog.Ok(Title, &quot;Error opening the donation website&quot;, ex.Message, ex);</a>
<a name="ln1758">        }</a>
<a name="ln1759">    }</a>
<a name="ln1760"> </a>
<a name="ln1761">    private void DonateOtherButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1762">    {</a>
<a name="ln1763">        try</a>
<a name="ln1764">        {</a>
<a name="ln1765">            var currency = CurrencyComboBox.Text.Substring(0, 3);</a>
<a name="ln1766"> </a>
<a name="ln1767">            ProcessHelper.StartWithShell($&quot;https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=JCY2BGLULSWVJ&amp;lc=US&amp;item_name=ScreenToGif&amp;item_number=screentogif&amp;currency_code={currency}&amp;bn=PP%2dDonationsBF%3abtn_donateCC_LG%2egif%3aNonHosted&quot;);</a>
<a name="ln1768">        }</a>
<a name="ln1769">        catch (Exception ex)</a>
<a name="ln1770">        {</a>
<a name="ln1771">            LogWriter.Log(ex, &quot;Error • Opening the Donation website&quot;);</a>
<a name="ln1772"> </a>
<a name="ln1773">            ErrorDialog.Ok(LocalizationHelper.Get(&quot;S.Options.Title&quot;), &quot;Error opening the donation website&quot;, ex.Message, ex);</a>
<a name="ln1774">        }</a>
<a name="ln1775">    }</a>
<a name="ln1776"> </a>
<a name="ln1777">    private void PatreonButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1778">    {</a>
<a name="ln1779">        try</a>
<a name="ln1780">        {</a>
<a name="ln1781">            ProcessHelper.StartWithShell(&quot;https://www.patreon.com/nicke&quot;);</a>
<a name="ln1782">        }</a>
<a name="ln1783">        catch (Exception ex)</a>
<a name="ln1784">        {</a>
<a name="ln1785">            LogWriter.Log(ex, &quot;Error • Opening the Patreon website&quot;);</a>
<a name="ln1786">            ErrorDialog.Ok(Title, &quot;Error opening the Patreon website&quot;, ex.Message, ex);</a>
<a name="ln1787">        }</a>
<a name="ln1788">    }</a>
<a name="ln1789"> </a>
<a name="ln1790">    private void StripeButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1791">    {</a>
<a name="ln1792">        try</a>
<a name="ln1793">        {</a>
<a name="ln1794">            ProcessHelper.StartWithShell(&quot;https://donate.stripe.com/cN23dfaz9dJW1wc000&quot;);</a>
<a name="ln1795">        }</a>
<a name="ln1796">        catch (Exception ex)</a>
<a name="ln1797">        {</a>
<a name="ln1798">            LogWriter.Log(ex, &quot;Error • Opening the Stripe website&quot;);</a>
<a name="ln1799"> </a>
<a name="ln1800">            ErrorDialog.Ok(LocalizationHelper.Get(&quot;S.Options.Title&quot;), &quot;Error opening the Stripe website&quot;, ex.Message, ex);</a>
<a name="ln1801">        }</a>
<a name="ln1802">    }</a>
<a name="ln1803"> </a>
<a name="ln1804">    private void SteamButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1805">    {</a>
<a name="ln1806">        try</a>
<a name="ln1807">        {</a>
<a name="ln1808">            ProcessHelper.StartWithShell(&quot;https://steamcommunity.com/id/nickesm/wishlist&quot;);</a>
<a name="ln1809">        }</a>
<a name="ln1810">        catch (Exception ex)</a>
<a name="ln1811">        {</a>
<a name="ln1812">            LogWriter.Log(ex, &quot;Error • Opening the Steam website&quot;);</a>
<a name="ln1813">            ErrorDialog.Ok(Title, &quot;Error opening the Steam website&quot;, ex.Message, ex);</a>
<a name="ln1814">        }</a>
<a name="ln1815">    }</a>
<a name="ln1816"> </a>
<a name="ln1817">    private void GogButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1818">    {</a>
<a name="ln1819">        try</a>
<a name="ln1820">        {</a>
<a name="ln1821">            ProcessHelper.StartWithShell(&quot;https://www.gog.com/u/Nickesm/wishlist&quot;);</a>
<a name="ln1822">        }</a>
<a name="ln1823">        catch (Exception ex)</a>
<a name="ln1824">        {</a>
<a name="ln1825">            LogWriter.Log(ex, &quot;Error • Opening the GOG website&quot;);</a>
<a name="ln1826">            ErrorDialog.Ok(Title, &quot;Error opening the GOG website&quot;, ex.Message, ex);</a>
<a name="ln1827">        }</a>
<a name="ln1828">    }</a>
<a name="ln1829"> </a>
<a name="ln1830">    private void KofiButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1831">    {</a>
<a name="ln1832">        try</a>
<a name="ln1833">        {</a>
<a name="ln1834">            ProcessHelper.StartWithShell(&quot;https://ko-fi.com/nickemanarin&quot;);</a>
<a name="ln1835">        }</a>
<a name="ln1836">        catch (Exception ex)</a>
<a name="ln1837">        {</a>
<a name="ln1838">            LogWriter.Log(ex, &quot;Error • Opening the Ko-fi website&quot;);</a>
<a name="ln1839">            ErrorDialog.Ok(Title, &quot;Error opening the Ko-fi website&quot;, ex.Message, ex);</a>
<a name="ln1840">        }</a>
<a name="ln1841">    }</a>
<a name="ln1842"> </a>
<a name="ln1843">    private void BitcoinCashCopy_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1844">    {</a>
<a name="ln1845">        System.Windows.Clipboard.SetText(&quot;1HN81cAwDo16tRtiYfkzvzFqikQUimM3S8&quot;);</a>
<a name="ln1846">    }</a>
<a name="ln1847"> </a>
<a name="ln1848">    private void MoneroHyperlink_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1849">    {</a>
<a name="ln1850">        System.Windows.Clipboard.SetText(&quot;44yC9CkwHVfKPsKxg5RcA67GZEqiQH6QoBYtRKwkhDaE3tvRpiw1E5i6GShZYNsDq9eCtHnq49SrKjF4DG7NwjqWMoMueD4&quot;);</a>
<a name="ln1851">    }</a>
<a name="ln1852"> </a>
<a name="ln1853">    private void SupportButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1854">    {</a>
<a name="ln1855">        try</a>
<a name="ln1856">        {</a>
<a name="ln1857">            ProcessHelper.StartWithShell(&quot;https://www.screentogif.com/donate&quot;);</a>
<a name="ln1858">        }</a>
<a name="ln1859">        catch (Exception ex)</a>
<a name="ln1860">        {</a>
<a name="ln1861">            LogWriter.Log(ex, &quot;Error • Opening the donation website&quot;);</a>
<a name="ln1862">            ErrorDialog.Ok(Title, &quot;Error opening the donation website&quot;, ex.Message, ex);</a>
<a name="ln1863">        }</a>
<a name="ln1864">    }</a>
<a name="ln1865"> </a>
<a name="ln1866">    #endregion</a>
<a name="ln1867"> </a>
<a name="ln1868">    #region About</a>
<a name="ln1869"> </a>
<a name="ln1870">    private void Hyperlink_OnRequestNavigate(object sender, RequestNavigateEventArgs e)</a>
<a name="ln1871">    {</a>
<a name="ln1872">        try</a>
<a name="ln1873">        {</a>
<a name="ln1874">            ProcessHelper.StartWithShell(e.Uri.AbsoluteUri);</a>
<a name="ln1875">        }</a>
<a name="ln1876">        catch (Exception ex)</a>
<a name="ln1877">        {</a>
<a name="ln1878">            LogWriter.Log(ex, &quot;Open Hyperlink&quot;);</a>
<a name="ln1879">        }</a>
<a name="ln1880">    }</a>
<a name="ln1881"> </a>
<a name="ln1882">    private async void CheckForUpdatesLabel_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1883">    {</a>
<a name="ln1884">        try</a>
<a name="ln1885">        {</a>
<a name="ln1886">            CheckForUpdatesLabel.IsEnabled = false;</a>
<a name="ln1887"> </a>
<a name="ln1888">            await App.MainViewModel.CheckForUpdates(true);</a>
<a name="ln1889"> </a>
<a name="ln1890">            if (Global.UpdateAvailable != null)</a>
<a name="ln1891">            {</a>
<a name="ln1892">                App.MainViewModel.PromptUpdate.Execute(null);</a>
<a name="ln1893">                return;</a>
<a name="ln1894">            }</a>
<a name="ln1895"> </a>
<a name="ln1896">            StatusBand.Info(LocalizationHelper.Get(&quot;S.Options.About.UpdateCheck.Nothing&quot;));</a>
<a name="ln1897">        }</a>
<a name="ln1898">        finally</a>
<a name="ln1899">        {</a>
<a name="ln1900">            CheckForUpdatesLabel.IsEnabled = true;</a>
<a name="ln1901">        }</a>
<a name="ln1902">    }</a>
<a name="ln1903"> </a>
<a name="ln1904">    #endregion</a>
<a name="ln1905"> </a>
<a name="ln1906">    #region Other</a>
<a name="ln1907"> </a>
<a name="ln1908">    private void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln1909">    {</a>
<a name="ln1910">        SizeToContent = SizeToContent.Manual;</a>
<a name="ln1911"> </a>
<a name="ln1912">        try</a>
<a name="ln1913">        {</a>
<a name="ln1914">            if (!string.IsNullOrWhiteSpace(UserSettings.All.ProxyPassword))</a>
<a name="ln1915">                ProxyPasswordBox.Password = WebHelper.Unprotect(UserSettings.All.ProxyPassword);</a>
<a name="ln1916">        }</a>
<a name="ln1917">        catch (Exception ex)</a>
<a name="ln1918">        {</a>
<a name="ln1919">            StatusBand.Warning(&quot;It was not possible to correctly load your proxy password. This usually happens when sharing the app settings with different computers.&quot;);</a>
<a name="ln1920">            LogWriter.Log(ex, &quot;Unprotect data&quot;);</a>
<a name="ln1921">        }</a>
<a name="ln1922">    }</a>
<a name="ln1923"> </a>
<a name="ln1924">    private void OkButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1925">    {</a>
<a name="ln1926">        Close();</a>
<a name="ln1927">    }</a>
<a name="ln1928"> </a>
<a name="ln1929">    private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)</a>
<a name="ln1930">    {</a>
<a name="ln1931">        #region Validation</a>
<a name="ln1932"> </a>
<a name="ln1933">        if (UserSettings.All.CursorFollowing &amp;&amp; UserSettings.All.FollowShortcut == Key.None)</a>
<a name="ln1934">        {</a>
<a name="ln1935">            Dialog.Ok(LocalizationHelper.Get(&quot;S.Options.Title&quot;), LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Header&quot;),</a>
<a name="ln1936">                LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Message&quot;), Icons.Warning);</a>
<a name="ln1937"> </a>
<a name="ln1938">            ShortcutsRadio.IsChecked = true;</a>
<a name="ln1939">            FollowKeyBox.Focus();</a>
<a name="ln1940"> </a>
<a name="ln1941">            e.Cancel = true;</a>
<a name="ln1942">            return;</a>
<a name="ln1943">        }</a>
<a name="ln1944"> </a>
<a name="ln1945">        #endregion</a>
<a name="ln1946"> </a>
<a name="ln1947">        Global.IgnoreHotKeys = false;</a>
<a name="ln1948"> </a>
<a name="ln1949">        BaseCompatibilityPreferences.HandleDispatcherRequestProcessingFailure = UserSettings.All.WorkaroundQuota ? BaseCompatibilityPreferences.HandleDispatcherRequestProcessingFailureOptions.Reset : BaseCompatibilityPreferences.HandleDispatcherRequestProcessingFailureOptions.Continue;</a>
<a name="ln1950">        RenderOptions.ProcessRenderMode = UserSettings.All.DisableHardwareAcceleration ? RenderMode.SoftwareOnly : RenderMode.Default;</a>
<a name="ln1951"> </a>
<a name="ln1952">        if (!string.IsNullOrWhiteSpace(ProxyPasswordBox.Password))</a>
<a name="ln1953">            UserSettings.All.ProxyPassword = WebHelper.Protect(ProxyPasswordBox.Password);</a>
<a name="ln1954"> </a>
<a name="ln1955">        UserSettings.Save();</a>
<a name="ln1956">    }</a>
<a name="ln1957"> </a>
<a name="ln1958">    #endregion</a>
<a name="ln1959"> </a>
<a name="ln1960"> </a>
<a name="ln1961">    public void NotificationUpdated()</a>
<a name="ln1962">    {</a>
<a name="ln1963">        LowSpaceTextBlock.Visibility = Global.AvailableDiskSpace &gt; 2_000_000_000 ? Visibility.Collapsed : Visibility.Visible; //2 GB.</a>
<a name="ln1964">    }</a>
<a name="ln1965"> </a>
<a name="ln1966">    internal void SelectTab(int index)</a>
<a name="ln1967">    {</a>
<a name="ln1968">        if (index &lt;= -1 || index &gt;= OptionsStackPanel.Children.Count - 1)</a>
<a name="ln1969">            return;</a>
<a name="ln1970"> </a>
<a name="ln1971">        if (OptionsStackPanel.Children[index] is RadioButton radio)</a>
<a name="ln1972">            radio.IsChecked = true;</a>
<a name="ln1973">    }</a>
<a name="ln1974">}</a>
</code></pre>
<div class="balloon" rel="476"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW != sizeH. Consider using a comparison with defined precision: Math.Abs(A - B) &gt; Epsilon.</p></div>
<div class="balloon" rel="482"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 10. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="484"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 15. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="486"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 20. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="488"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 25. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="490"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 30. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="492"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 50. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="494"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison: sizeW == 100. Consider using a comparison with defined precision: Math.Abs(A - B) &lt; Epsilon.</p></div>
<div class="balloon" rel="1143"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>