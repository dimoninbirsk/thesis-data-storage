<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>NewRecorder.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Drawing;</a>
<a name="ln3">using System.IO;</a>
<a name="ln4">using System.Linq;</a>
<a name="ln5">using System.Threading.Tasks;</a>
<a name="ln6">using System.Windows;</a>
<a name="ln7">using System.Windows.Controls;</a>
<a name="ln8">using System.Windows.Forms;</a>
<a name="ln9">using System.Windows.Input;</a>
<a name="ln10">using System.Windows.Media;</a>
<a name="ln11">using Microsoft.Win32;</a>
<a name="ln12">using ScreenToGif.Capture;</a>
<a name="ln13">using ScreenToGif.Domain.Enums;</a>
<a name="ln14">using ScreenToGif.Domain.Events;</a>
<a name="ln15">using ScreenToGif.Domain.Exceptions;</a>
<a name="ln16">using ScreenToGif.Domain.Models;</a>
<a name="ln17">using ScreenToGif.Domain.Models.Native;</a>
<a name="ln18">using ScreenToGif.Model;</a>
<a name="ln19">using ScreenToGif.Native.External;</a>
<a name="ln20">using ScreenToGif.Native.Helpers;</a>
<a name="ln21">using ScreenToGif.Util;</a>
<a name="ln22">using ScreenToGif.Util.Extensions;</a>
<a name="ln23">using ScreenToGif.Util.Settings;</a>
<a name="ln24">using ScreenToGif.ViewModel;</a>
<a name="ln25">using ScreenToGif.Windows.Other;</a>
<a name="ln26">using Cursors = System.Windows.Input.Cursors;</a>
<a name="ln27">using KeyEventArgs = System.Windows.Input.KeyEventArgs;</a>
<a name="ln28">using MouseButtons = ScreenToGif.Domain.Enums.MouseButtons;</a>
<a name="ln29">using Point = System.Windows.Point;</a>
<a name="ln30">using Size = System.Windows.Size;</a>
<a name="ln31"> </a>
<a name="ln32">namespace ScreenToGif.Windows;</a>
<a name="ln33"> </a>
<a name="ln34">public partial class NewRecorder</a>
<a name="ln35">{</a>
<a name="ln36">    #region Variables</a>
<a name="ln37"> </a>
<a name="ln38">    private static readonly object Lock = new object();</a>
<a name="ln39"> </a>
<a name="ln40">    /// &lt;summary&gt;</a>
<a name="ln41">    /// The view model of the recorder.</a>
<a name="ln42">    /// &lt;/summary&gt;</a>
<a name="ln43">    private readonly ScreenRecorderViewModel _viewModel;</a>
<a name="ln44"> </a>
<a name="ln45">    /// &lt;summary&gt;</a>
<a name="ln46">    /// Keyboard and mouse hooks helper.</a>
<a name="ln47">    /// &lt;/summary&gt;</a>
<a name="ln48">    private readonly InputHook _actHook;</a>
<a name="ln49"> </a>
<a name="ln50">    /// &lt;summary&gt;</a>
<a name="ln51">    /// This is the helper class which brings the screen area selection.</a>
<a name="ln52">    /// &lt;/summary&gt;</a>
<a name="ln53">    private readonly RegionSelection _regionSelection = new RegionSelection();</a>
<a name="ln54"> </a>
<a name="ln55">    /// &lt;summary&gt;</a>
<a name="ln56">    /// The amount of seconds of the pre start delay, plus 1 (1+1=2);</a>
<a name="ln57">    /// &lt;/summary&gt;</a>
<a name="ln58">    private int _preStartCount = 1;</a>
<a name="ln59"> </a>
<a name="ln60">    private readonly Timer _preStartTimer = new Timer();</a>
<a name="ln61">    private readonly Timer _followTimer = new Timer();</a>
<a name="ln62">    private readonly Timer _showBorderTimer = new Timer();</a>
<a name="ln63">    private readonly Timer _limitTimer = new Timer();</a>
<a name="ln64"> </a>
<a name="ln65">    #region Mouse cursor follow up</a>
<a name="ln66"> </a>
<a name="ln67">    /// &lt;summary&gt;</a>
<a name="ln68">    /// The previous position of the cursor in the X axis.</a>
<a name="ln69">    /// &lt;/summary&gt;</a>
<a name="ln70">    private int _prevPosX = 0;</a>
<a name="ln71"> </a>
<a name="ln72">    /// &lt;summary&gt;</a>
<a name="ln73">    /// The previous position of the cursor in the Y axis.</a>
<a name="ln74">    /// &lt;/summary&gt;</a>
<a name="ln75">    private int _prevPosY = 0;</a>
<a name="ln76"> </a>
<a name="ln77">    /// &lt;summary&gt;</a>
<a name="ln78">    /// The latest position of the cursor in the X axis.</a>
<a name="ln79">    /// &lt;/summary&gt;</a>
<a name="ln80">    private int _posX = 0;</a>
<a name="ln81"> </a>
<a name="ln82">    /// &lt;summary&gt;</a>
<a name="ln83">    /// The latest position of the cursor in the Y axis.</a>
<a name="ln84">    /// &lt;/summary&gt;</a>
<a name="ln85">    private int _posY = 0;</a>
<a name="ln86"> </a>
<a name="ln87">    /// &lt;summary&gt;</a>
<a name="ln88">    /// The offset in pixels. Used for moving the recorder around the X axis.</a>
<a name="ln89">    /// &lt;/summary&gt;</a>
<a name="ln90">    private double _offsetX = 0;</a>
<a name="ln91"> </a>
<a name="ln92">    /// &lt;summary&gt;</a>
<a name="ln93">    /// The offset in pixels. Used for moving the recorder around the Y axis.</a>
<a name="ln94">    /// &lt;/summary&gt;</a>
<a name="ln95">    private double _offsetY = 0;</a>
<a name="ln96"> </a>
<a name="ln97">    #endregion</a>
<a name="ln98"> </a>
<a name="ln99">    #endregion</a>
<a name="ln100"> </a>
<a name="ln101">    #region Dependency Properties</a>
<a name="ln102"> </a>
<a name="ln103">    public static readonly DependencyProperty IsRecordingProperty = DependencyProperty.Register(nameof(IsRecording), typeof(bool), typeof(NewRecorder), new PropertyMetadata(false));</a>
<a name="ln104">    public static readonly DependencyProperty IsFollowingProperty = DependencyProperty.Register(nameof(IsFollowing), typeof(bool), typeof(NewRecorder), new PropertyMetadata(false, IsFollowing_PropertyChanged));</a>
<a name="ln105"> </a>
<a name="ln106">    #endregion</a>
<a name="ln107"> </a>
<a name="ln108">    #region Properties</a>
<a name="ln109"> </a>
<a name="ln110">    public bool IsRecording</a>
<a name="ln111">    {</a>
<a name="ln112">        get =&gt; (bool)GetValue(IsRecordingProperty);</a>
<a name="ln113">        set =&gt; SetValue(IsRecordingProperty, value);</a>
<a name="ln114">    }</a>
<a name="ln115"> </a>
<a name="ln116">    public bool IsFollowing</a>
<a name="ln117">    {</a>
<a name="ln118">        get =&gt; (bool)GetValue(IsFollowingProperty);</a>
<a name="ln119">        set =&gt; SetValue(IsFollowingProperty, value);</a>
<a name="ln120">    }</a>
<a name="ln121"> </a>
<a name="ln122">    /// &lt;summary&gt;</a>
<a name="ln123">    /// Get the selected region in screen coordinates.</a>
<a name="ln124">    /// Scales the region selection to the DPI/Scale of the screen where the capture selection is located.</a>
<a name="ln125">    /// Also, takes into account the 1px border of the selection rectangle.</a>
<a name="ln126">    /// &lt;/summary&gt;</a>
<a name="ln127">    public Rect CaptureRegion =&gt; _viewModel != null &amp;&amp; _viewModel.Region.IsEmpty != true ? _viewModel.Region.Scale(_regionSelection.Scale).Offset(MathExtensions.RoundUpValue(_regionSelection.Scale)) : Rect.Empty;</a>
<a name="ln128">    //public Rect CaptureRegion =&gt; _viewModel != null &amp;&amp; _viewModel.Region.IsEmpty != true ? _viewModel.Region.Offset(1).Scale(_regionSelection.Scale) : Rect.Empty;</a>
<a name="ln129"> </a>
<a name="ln130">    #endregion</a>
<a name="ln131"> </a>
<a name="ln132"> </a>
<a name="ln133">    public NewRecorder()</a>
<a name="ln134">    {</a>
<a name="ln135">        InitializeComponent();</a>
<a name="ln136"> </a>
<a name="ln137">        _preStartTimer.Tick += PreStart_Elapsed;</a>
<a name="ln138">        _preStartTimer.Interval = 1000;</a>
<a name="ln139"> </a>
<a name="ln140">        #region Global hook</a>
<a name="ln141"> </a>
<a name="ln142">        try</a>
<a name="ln143">        {</a>
<a name="ln144">            _actHook = new InputHook(true, true); //true for the mouse, true for the keyboard.</a>
<a name="ln145">            _actHook.KeyDown += KeyHookTarget;</a>
<a name="ln146">            _actHook.OnMouseActivity += MouseHookTarget;</a>
<a name="ln147">        }</a>
<a name="ln148">        catch (Exception e)</a>
<a name="ln149">        {</a>
<a name="ln150">            LogWriter.Log(e, &quot;Impossible to initialize the user activity hook.&quot;);</a>
<a name="ln151">        }</a>
<a name="ln152"> </a>
<a name="ln153">        #endregion</a>
<a name="ln154"> </a>
<a name="ln155">        #region Model and commands</a>
<a name="ln156"> </a>
<a name="ln157">        DataContext = _viewModel = new ScreenRecorderViewModel();</a>
<a name="ln158"> </a>
<a name="ln159">        RegisterCommands();</a>
<a name="ln160"> </a>
<a name="ln161">        #endregion</a>
<a name="ln162"> </a>
<a name="ln163">        #region Focus scope explanation</a>
<a name="ln164"> </a>
<a name="ln165">        //Since I'm using Commands inside a ContextMenu, I need to set logical focus in order for it to work.</a>
<a name="ln166">        //FocusManager.FocusedElement=&quot;{Binding RelativeSource={x:Static RelativeSource.Self}, Mode=OneTime}&quot;</a>
<a name="ln167">        //https://www.wpftutorial.net/RoutedCommandsInContextMenu.html</a>
<a name="ln168"> </a>
<a name="ln169">        #endregion</a>
<a name="ln170"> </a>
<a name="ln171">        _regionSelection.PositionChanged += RegionSelection_PositionChanged;</a>
<a name="ln172">        _regionSelection.DragStarted += RegionSelection_DragStarted;</a>
<a name="ln173">        _regionSelection.DragEnded += RegionSelection_DragEnded;</a>
<a name="ln174"> </a>
<a name="ln175">        SystemEvents.PowerModeChanged += System_PowerModeChanged;</a>
<a name="ln176">        SystemEvents.DisplaySettingsChanged += SystemEvents_DisplaySettingsChanged;</a>
<a name="ln177">    }</a>
<a name="ln178"> </a>
<a name="ln179"> </a>
<a name="ln180">    private async void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln181">    {</a>
<a name="ln182">        #region Timers</a>
<a name="ln183"> </a>
<a name="ln184">        _showBorderTimer.Interval = 500;</a>
<a name="ln185">        _showBorderTimer.Tick += ShowBorderTimer_Tick;</a>
<a name="ln186"> </a>
<a name="ln187">        _followTimer.Tick += FollowTimer_Tick;</a>
<a name="ln188"> </a>
<a name="ln189">        #endregion</a>
<a name="ln190"> </a>
<a name="ln191">        DetectCaptureFrequency();</a>
<a name="ln192"> </a>
<a name="ln193">        _viewModel.IsDirectMode = UserSettings.All.UseDesktopDuplication;</a>
<a name="ln194">        _viewModel.Monitors = MonitorHelper.AllMonitorsGranular();</a>
<a name="ln195"> </a>
<a name="ln196">        await UpdatePositioning(true);</a>
<a name="ln197"> </a>
<a name="ln198">        if (UserSettings.All.CursorFollowing)</a>
<a name="ln199">            Follow();</a>
<a name="ln200">        else</a>
<a name="ln201">        {</a>
<a name="ln202">            await Task.Delay(TimeSpan.FromMilliseconds(500));</a>
<a name="ln203"> </a>
<a name="ln204">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln205">            MoveCommandPanel();</a>
<a name="ln206">        }</a>
<a name="ln207"> </a>
<a name="ln208">        //Automation arguments were passed by command line.</a>
<a name="ln209">        if (Arguments.Open)</a>
<a name="ln210">        {</a>
<a name="ln211">            if (Arguments.FrequencyType.HasValue)</a>
<a name="ln212">            {</a>
<a name="ln213">                UserSettings.All.CaptureFrequency = Arguments.FrequencyType.Value;</a>
<a name="ln214">                UserSettings.All.LatestFps = Arguments.Frequency;</a>
<a name="ln215">                DetectCaptureFrequency();</a>
<a name="ln216"> </a>
<a name="ln217">                Arguments.FrequencyType = null;</a>
<a name="ln218">            }</a>
<a name="ln219"> </a>
<a name="ln220">            if (Arguments.StartCapture &amp;&amp; UserSettings.All.CaptureFrequency &gt;= CaptureFrequencies.PerSecond)</a>
<a name="ln221">            {</a>
<a name="ln222">                if (Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln223">                {</a>
<a name="ln224">                    _limitTimer.Tick += Limit_Elapsed;</a>
<a name="ln225">                    _limitTimer.Interval = (int) Math.Min(int.MaxValue, Arguments.Limit.TotalMilliseconds);</a>
<a name="ln226">                }</a>
<a name="ln227"> </a>
<a name="ln228">                await Record();</a>
<a name="ln229">            }</a>
<a name="ln230">            else</a>
<a name="ln231">            {</a>
<a name="ln232">                Arguments.ClearAutomationArgs();</a>
<a name="ln233">            }</a>
<a name="ln234">        }</a>
<a name="ln235">    }</a>
<a name="ln236"> </a>
<a name="ln237">    private void Window_Activated(object sender, EventArgs e)</a>
<a name="ln238">    {</a>
<a name="ln239">        lock (Lock)</a>
<a name="ln240">        {</a>
<a name="ln241">            if (_regionSelection.IsEnabled &amp;&amp; _regionSelection.WindowState == WindowState.Minimized)</a>
<a name="ln242">                _regionSelection.WindowState = WindowState.Normal;</a>
<a name="ln243"> </a>
<a name="ln244">            IsFollowing = UserSettings.All.CursorFollowing;</a>
<a name="ln245"> </a>
<a name="ln246">            if (!IsFollowing || UserSettings.All.FollowShortcut != Key.None)</a>
<a name="ln247">                return;</a>
<a name="ln248"> </a>
<a name="ln249">            UserSettings.All.CursorFollowing = IsFollowing = false;</a>
<a name="ln250"> </a>
<a name="ln251">            Dialog.Ok(LocalizationHelper.Get(&quot;S.StartUp.Recorder&quot;), LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Header&quot;),</a>
<a name="ln252">                LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Message&quot;), Icons.Warning);</a>
<a name="ln253">        }</a>
<a name="ln254">    }</a>
<a name="ln255"> </a>
<a name="ln256">    private void Window_KeyDown(object sender, KeyEventArgs e)</a>
<a name="ln257">    {</a>
<a name="ln258">        var step = (Keyboard.Modifiers &amp; ModifierKeys.Alt) != 0 ? 5 : 1;</a>
<a name="ln259">        var key = e.Key == Key.System ? e.SystemKey : e.Key;</a>
<a name="ln260"> </a>
<a name="ln261">        //TODO: Remove.</a>
<a name="ln262">        if (key == Key.Tab)</a>
<a name="ln263">        {</a>
<a name="ln264">            Console.WriteLine($&quot;Current Element: {(Keyboard.FocusedElement as FrameworkElement)?.Name}, {Keyboard.FocusedElement}&quot;);</a>
<a name="ln265">        }</a>
<a name="ln266"> </a>
<a name="ln267">        if (Stage == RecorderStages.Stopped)</a>
<a name="ln268">        {</a>
<a name="ln269">            //Control + Shift: Expand both ways.</a>
<a name="ln270">            if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0 &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln271">            {</a>
<a name="ln272">                switch (key)</a>
<a name="ln273">                {</a>
<a name="ln274">                    case Key.Up:</a>
<a name="ln275">                        ResizeWindow(0, -step, 0, step);</a>
<a name="ln276">                        e.Handled = true;</a>
<a name="ln277">                        break;</a>
<a name="ln278">                    case Key.Down:</a>
<a name="ln279">                        ResizeWindow(0, step, 0, -step);</a>
<a name="ln280">                        e.Handled = true;</a>
<a name="ln281">                        break;</a>
<a name="ln282">                    case Key.Left:</a>
<a name="ln283">                        ResizeWindow(step, 0, -step, 0);</a>
<a name="ln284">                        e.Handled = true;</a>
<a name="ln285">                        break;</a>
<a name="ln286">                    case Key.Right:</a>
<a name="ln287">                        ResizeWindow(-step, 0, step, 0);</a>
<a name="ln288">                        e.Handled = true;</a>
<a name="ln289">                        break;</a>
<a name="ln290">                }</a>
<a name="ln291"> </a>
<a name="ln292">                return;</a>
<a name="ln293">            }</a>
<a name="ln294"> </a>
<a name="ln295">            //If the Shift key is pressed, the sizing mode is enabled (bottom right).</a>
<a name="ln296">            if ((Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln297">            {</a>
<a name="ln298">                switch (key)</a>
<a name="ln299">                {</a>
<a name="ln300">                    case Key.Left:</a>
<a name="ln301">                        ResizeWindow(0, 0, -step, 0);</a>
<a name="ln302">                        e.Handled = true;</a>
<a name="ln303">                        break;</a>
<a name="ln304">                    case Key.Up:</a>
<a name="ln305">                        ResizeWindow(0, 0, 0, -step);</a>
<a name="ln306">                        e.Handled = true;</a>
<a name="ln307">                        break;</a>
<a name="ln308">                    case Key.Right:</a>
<a name="ln309">                        ResizeWindow(0, 0, step, 0);</a>
<a name="ln310">                        e.Handled = true;</a>
<a name="ln311">                        break;</a>
<a name="ln312">                    case Key.Down:</a>
<a name="ln313">                        ResizeWindow(0, 0, 0, step);</a>
<a name="ln314">                        e.Handled = true;</a>
<a name="ln315">                        break;</a>
<a name="ln316">                }</a>
<a name="ln317"> </a>
<a name="ln318">                return;</a>
<a name="ln319">            }</a>
<a name="ln320"> </a>
<a name="ln321">            //If the Control key is pressed, the sizing mode is enabled (top left).</a>
<a name="ln322">            if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0)</a>
<a name="ln323">            {</a>
<a name="ln324">                switch (key)</a>
<a name="ln325">                {</a>
<a name="ln326">                    case Key.Left:</a>
<a name="ln327">                        ResizeWindow(-step, 0, 0, 0);</a>
<a name="ln328">                        e.Handled = true;</a>
<a name="ln329">                        break;</a>
<a name="ln330">                    case Key.Up:</a>
<a name="ln331">                        ResizeWindow(0, -step, 0, 0);</a>
<a name="ln332">                        e.Handled = true;</a>
<a name="ln333">                        break;</a>
<a name="ln334">                    case Key.Right:</a>
<a name="ln335">                        ResizeWindow(step, 0, 0, 0);</a>
<a name="ln336">                        e.Handled = true;</a>
<a name="ln337">                        break;</a>
<a name="ln338">                    case Key.Down:</a>
<a name="ln339">                        ResizeWindow(0, step, 0, 0);</a>
<a name="ln340">                        e.Handled = true;</a>
<a name="ln341">                        break;</a>
<a name="ln342">                }</a>
<a name="ln343"> </a>
<a name="ln344">                return;</a>
<a name="ln345">            }</a>
<a name="ln346">        }</a>
<a name="ln347"> </a>
<a name="ln348">        //If no other key is pressed, move the region.</a>
<a name="ln349">        switch (key)</a>
<a name="ln350">        {</a>
<a name="ln351">            case Key.Left:</a>
<a name="ln352">                MoveWindow(step, 0, 0, 0);</a>
<a name="ln353">                e.Handled = true;</a>
<a name="ln354">                break;</a>
<a name="ln355">            case Key.Up:</a>
<a name="ln356">                MoveWindow(0, step, 0, 0);</a>
<a name="ln357">                e.Handled = true;</a>
<a name="ln358">                break;</a>
<a name="ln359">            case Key.Right:</a>
<a name="ln360">                MoveWindow(0, 0, step, 0);</a>
<a name="ln361">                e.Handled = true;</a>
<a name="ln362">                break;</a>
<a name="ln363">            case Key.Down:</a>
<a name="ln364">                MoveWindow(0, 0, 0, step);</a>
<a name="ln365">                e.Handled = true;</a>
<a name="ln366">                break;</a>
<a name="ln367">        }</a>
<a name="ln368">    }</a>
<a name="ln369"> </a>
<a name="ln370">    private void Window_StateChanged(object sender, EventArgs e)</a>
<a name="ln371">    {</a>
<a name="ln372">        if (WindowState == WindowState.Minimized)</a>
<a name="ln373">            return;</a>
<a name="ln374"> </a>
<a name="ln375">        if (Stage == RecorderStages.Recording &amp;&amp; IsRegionIntersected())</a>
<a name="ln376">        {</a>
<a name="ln377">            Pause();</a>
<a name="ln378"> </a>
<a name="ln379">            Topmost = true;</a>
<a name="ln380">        }</a>
<a name="ln381"> </a>
<a name="ln382">        DisplaySelection();</a>
<a name="ln383">        ForceUpdate();</a>
<a name="ln384">    }</a>
<a name="ln385"> </a>
<a name="ln386">    private void HeaderGrid_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln387">    {</a>
<a name="ln388">        if (Mouse.LeftButton == MouseButtonState.Pressed)</a>
<a name="ln389">            DragMove();</a>
<a name="ln390">    }</a>
<a name="ln391"> </a>
<a name="ln392">    private void RegionSelection_PositionChanged(object sender, RoutedEventArgs e)</a>
<a name="ln393">    {</a>
<a name="ln394">        DetectMonitorChanges();</a>
<a name="ln395"> </a>
<a name="ln396">        WidthIntegerBox.IgnoreValueChanged = true;</a>
<a name="ln397">        HeightIntegerBox.IgnoreValueChanged = true;</a>
<a name="ln398"> </a>
<a name="ln399">        UserSettings.All.SelectedRegionScale = _regionSelection.Scale;</a>
<a name="ln400">        UserSettings.All.SelectedRegion = _viewModel.Region = _regionSelection.Rect;</a>
<a name="ln401"> </a>
<a name="ln402">        WidthIntegerBox.IgnoreValueChanged = false;</a>
<a name="ln403">        HeightIntegerBox.IgnoreValueChanged = false;</a>
<a name="ln404"> </a>
<a name="ln405">        WidthIntegerBox.Scale = _regionSelection.Scale;</a>
<a name="ln406">        HeightIntegerBox.Scale = _regionSelection.Scale;</a>
<a name="ln407"> </a>
<a name="ln408">        if (Capture != null)</a>
<a name="ln409">        {</a>
<a name="ln410">            Capture.Left = (int)CaptureRegion.Left;</a>
<a name="ln411">            Capture.Top = (int)CaptureRegion.Top;</a>
<a name="ln412">        }</a>
<a name="ln413">    }</a>
<a name="ln414"> </a>
<a name="ln415">    private void RegionSelection_DragStarted(object sender, RoutedEventArgs e)</a>
<a name="ln416">    {</a>
<a name="ln417">        Hide();</a>
<a name="ln418">    }</a>
<a name="ln419"> </a>
<a name="ln420">    private void RegionSelection_DragEnded(object sender, RoutedEventArgs e)</a>
<a name="ln421">    {</a>
<a name="ln422">        DetectMonitorChanges();</a>
<a name="ln423">        MoveCommandPanel();</a>
<a name="ln424">        Show();</a>
<a name="ln425">    }</a>
<a name="ln426"> </a>
<a name="ln427">    private void System_PowerModeChanged(object sender, PowerModeChangedEventArgs e)</a>
<a name="ln428">    {</a>
<a name="ln429">        if (e.Mode == PowerModes.Suspend)</a>
<a name="ln430">        {</a>
<a name="ln431">            if (Stage == RecorderStages.Recording)</a>
<a name="ln432">                _viewModel.PauseCommand.Execute(sender, null);</a>
<a name="ln433">            else if (Stage == RecorderStages.PreStarting)</a>
<a name="ln434">                _viewModel.StopCommand.Execute(sender, null);</a>
<a name="ln435"> </a>
<a name="ln436">            GC.Collect();</a>
<a name="ln437">        }</a>
<a name="ln438">    }</a>
<a name="ln439"> </a>
<a name="ln440">    private async void SystemEvents_DisplaySettingsChanged(object sender, EventArgs eventArgs)</a>
<a name="ln441">    {</a>
<a name="ln442">        if (_viewModel != null)</a>
<a name="ln443">            _viewModel.Monitors = MonitorHelper.AllMonitorsGranular();</a>
<a name="ln444"> </a>
<a name="ln445">        await UpdatePositioning();</a>
<a name="ln446"> </a>
<a name="ln447">        if (WindowState == WindowState.Minimized &amp;&amp; _regionSelection != null)</a>
<a name="ln448">            _regionSelection.WindowState = WindowState.Minimized;</a>
<a name="ln449">    }</a>
<a name="ln450"> </a>
<a name="ln451">    private void SizeIntegerBox_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln452">    {</a>
<a name="ln453">        if (!IsLoaded)</a>
<a name="ln454">            return;</a>
<a name="ln455"> </a>
<a name="ln456">        MoveCommandPanel();</a>
<a name="ln457">        DisplaySelection();</a>
<a name="ln458">    }</a>
<a name="ln459"> </a>
<a name="ln460">    private void SizeIntegerBox_MouseWheel(object sender, MouseWheelEventArgs e)</a>
<a name="ln461">    {</a>
<a name="ln462">        var relativePoint = e.GetPosition(WidthIntegerBox);</a>
<a name="ln463">        var screenPoint = WidthIntegerBox.PointToScreen(new Point(0, 0));</a>
<a name="ln464">        var scale = this.Scale();</a>
<a name="ln465"> </a>
<a name="ln466">        User32.SetCursorPos((int)(screenPoint.X + relativePoint.X * scale), (int)(screenPoint.Y + relativePoint.Y * scale));</a>
<a name="ln467">    }</a>
<a name="ln468"> </a>
<a name="ln469">    private static void IsFollowing_PropertyChanged(DependencyObject d, DependencyPropertyChangedEventArgs e)</a>
<a name="ln470">    {</a>
<a name="ln471">        if (d is not NewRecorder rec)</a>
<a name="ln472">            return;</a>
<a name="ln473"> </a>
<a name="ln474">        rec.Follow();</a>
<a name="ln475">    }</a>
<a name="ln476"> </a>
<a name="ln477">    private void MinimizeButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln478">    {</a>
<a name="ln479">        _regionSelection.Hide();</a>
<a name="ln480"> </a>
<a name="ln481">        WindowState = WindowState.Minimized;</a>
<a name="ln482">    }</a>
<a name="ln483"> </a>
<a name="ln484">    private async void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)</a>
<a name="ln485">    {</a>
<a name="ln486">        //Close the selecting rectangle.</a>
<a name="ln487">        _regionSelection.Close();</a>
<a name="ln488"> </a>
<a name="ln489">        //Save Settings</a>
<a name="ln490">        UserSettings.All.SelectedRegion = _viewModel?.Region ?? UserSettings.All.SelectedRegion;</a>
<a name="ln491">        UserSettings.All.SelectedRegionScale = _viewModel?.CurrentMonitor?.Scale ?? UserSettings.All.SelectedRegionScale;</a>
<a name="ln492">        UserSettings.Save();</a>
<a name="ln493"> </a>
<a name="ln494">        #region Remove Hooks</a>
<a name="ln495"> </a>
<a name="ln496">        try</a>
<a name="ln497">        {</a>
<a name="ln498">            if (_actHook != null)</a>
<a name="ln499">            {</a>
<a name="ln500">                _actHook.OnMouseActivity -= MouseHookTarget;</a>
<a name="ln501">                _actHook.KeyDown -= KeyHookTarget;</a>
<a name="ln502">                _actHook.Stop(); //Stop the user activity watcher.</a>
<a name="ln503">            }</a>
<a name="ln504">        }</a>
<a name="ln505">        catch (Exception) { }</a>
<a name="ln506"> </a>
<a name="ln507">        #endregion</a>
<a name="ln508"> </a>
<a name="ln509">        SystemEvents.PowerModeChanged -= System_PowerModeChanged;</a>
<a name="ln510">        SystemEvents.DisplaySettingsChanged -= SystemEvents_DisplaySettingsChanged;</a>
<a name="ln511"> </a>
<a name="ln512">        #region Stops the timers</a>
<a name="ln513"> </a>
<a name="ln514">        if (Stage != RecorderStages.Stopped)</a>
<a name="ln515">        {</a>
<a name="ln516">            _preStartTimer.Stop();</a>
<a name="ln517">            _preStartTimer.Dispose();</a>
<a name="ln518"> </a>
<a name="ln519">            await StopCapture();</a>
<a name="ln520">        }</a>
<a name="ln521"> </a>
<a name="ln522">        GarbageTimer?.Stop();</a>
<a name="ln523">        _followTimer?.Stop();</a>
<a name="ln524">        _limitTimer?.Stop();</a>
<a name="ln525"> </a>
<a name="ln526">        #endregion</a>
<a name="ln527"> </a>
<a name="ln528">        //Clean all capture resources.</a>
<a name="ln529">        if (Capture != null)</a>
<a name="ln530">            await Capture.DisposeAsync();</a>
<a name="ln531"> </a>
<a name="ln532">        GC.Collect();</a>
<a name="ln533">    }</a>
<a name="ln534"> </a>
<a name="ln535"> </a>
<a name="ln536">    private async void RegionButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln537">    {</a>
<a name="ln538">        await PickRegion(ModeType.Region);</a>
<a name="ln539">    }</a>
<a name="ln540"> </a>
<a name="ln541">    private async void WindowButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln542">    {</a>
<a name="ln543">        await PickRegion(ModeType.Window);</a>
<a name="ln544">    }</a>
<a name="ln545"> </a>
<a name="ln546">    private async void FullScreenButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln547">    {</a>
<a name="ln548">        await PickRegion(ModeType.Fullscreen);</a>
<a name="ln549">    }</a>
<a name="ln550"> </a>
<a name="ln551"> </a>
<a name="ln552">    /// &lt;summary&gt;</a>
<a name="ln553">    /// KeyHook event method. This fires when the user press a key.</a>
<a name="ln554">    /// When using commands when the current window has no focus, pass an IInputElement as the target to make it work.</a>
<a name="ln555">    /// &lt;/summary&gt;</a>
<a name="ln556">    private async void KeyHookTarget(object sender, CustomKeyEventArgs e)</a>
<a name="ln557">    {</a>
<a name="ln558">        if (RegionSelectHelper.IsSelecting || Stage == RecorderStages.Discarding)</a>
<a name="ln559">            return;</a>
<a name="ln560"> </a>
<a name="ln561">        //Capture when an user interactions happens.</a>
<a name="ln562">        if (Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction &amp;&amp; !IsKeyboardFocusWithin)</a>
<a name="ln563">            await Snap();</a>
<a name="ln564"> </a>
<a name="ln565">        //Record/snap or pause.</a>
<a name="ln566">        if (Keyboard.Modifiers.HasFlag(UserSettings.All.StartPauseModifiers) &amp;&amp; e.Key == UserSettings.All.StartPauseShortcut)</a>
<a name="ln567">        {</a>
<a name="ln568">            if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual)</a>
<a name="ln569">            {</a>
<a name="ln570">                _viewModel.SnapCommand.Execute(null, this);</a>
<a name="ln571">                return;</a>
<a name="ln572">            }</a>
<a name="ln573"> </a>
<a name="ln574">            if (Stage == RecorderStages.Recording)</a>
<a name="ln575">                _viewModel.PauseCommand.Execute(null, this);</a>
<a name="ln576">            else</a>
<a name="ln577">            {</a>
<a name="ln578">                if (_viewModel.Region.IsEmpty &amp;&amp; WindowState == WindowState.Minimized)</a>
<a name="ln579">                    WindowState = WindowState.Normal;</a>
<a name="ln580"> </a>
<a name="ln581">                _viewModel.RecordCommand.Execute(null, this);</a>
<a name="ln582">            }</a>
<a name="ln583"> </a>
<a name="ln584">            return;</a>
<a name="ln585">        }</a>
<a name="ln586"> </a>
<a name="ln587">        if (Keyboard.Modifiers.HasFlag(UserSettings.All.StopModifiers) &amp;&amp; e.Key == UserSettings.All.StopShortcut &amp;&amp; (Stage == RecorderStages.Recording || Stage == RecorderStages.Paused || Stage == RecorderStages.PreStarting))</a>
<a name="ln588">            await Stop();</a>
<a name="ln589">        else if (Keyboard.Modifiers.HasFlag(UserSettings.All.DiscardModifiers) &amp;&amp; e.Key == UserSettings.All.DiscardShortcut)</a>
<a name="ln590">            _viewModel.DiscardCommand.Execute(null, this);</a>
<a name="ln591">        else if (Keyboard.Modifiers.HasFlag(UserSettings.All.FollowModifiers) &amp;&amp; e.Key == UserSettings.All.FollowShortcut)</a>
<a name="ln592">            UserSettings.All.CursorFollowing = IsFollowing = !IsFollowing;</a>
<a name="ln593">        else</a>
<a name="ln594">            KeyList.Add(new SimpleKeyGesture(e.Key, Keyboard.Modifiers, e.IsUppercase, e.IsInjected));</a>
<a name="ln595">    }</a>
<a name="ln596"> </a>
<a name="ln597">    /// &lt;summary&gt;</a>
<a name="ln598">    /// MouseHook event method, detects the mouse clicks.</a>
<a name="ln599">    /// &lt;/summary&gt;</a>
<a name="ln600">    private async void MouseHookTarget(object sender, SimpleMouseGesture args)</a>
<a name="ln601">    {</a>
<a name="ln602">        try</a>
<a name="ln603">        {</a>
<a name="ln604">            if (RegionSelectHelper.IsSelecting || Stage == RecorderStages.Discarding)</a>
<a name="ln605">                return;</a>
<a name="ln606"> </a>
<a name="ln607">            //In the future, store each mouse event, with a timestamp, independently of the capture.</a>
<a name="ln608">            if (args.LeftButton == MouseButtonState.Pressed)</a>
<a name="ln609">                RecordClicked = MouseButtons.Left;</a>
<a name="ln610">            else if (args.RightButton == MouseButtonState.Pressed)</a>
<a name="ln611">                RecordClicked = MouseButtons.Right;</a>
<a name="ln612">            else if (args.MiddleButton == MouseButtonState.Pressed)</a>
<a name="ln613">                RecordClicked = MouseButtons.Middle;</a>
<a name="ln614">            else if (args.FirstExtraButton == MouseButtonState.Pressed)</a>
<a name="ln615">                RecordClicked = MouseButtons.FirstExtra;</a>
<a name="ln616">            else if (args.SecondExtraButton == MouseButtonState.Pressed)</a>
<a name="ln617">                RecordClicked = MouseButtons.SecondExtra;</a>
<a name="ln618">            else</a>
<a name="ln619">                RecordClicked = MouseButtons.None;</a>
<a name="ln620"> </a>
<a name="ln621">            _posX = (int)Math.Round(args.PosX / _regionSelection.Scale, MidpointRounding.AwayFromZero);</a>
<a name="ln622">            _posY = (int)Math.Round(args.PosY / _regionSelection.Scale, MidpointRounding.AwayFromZero);</a>
<a name="ln623"> </a>
<a name="ln624">            if (Stage == RecorderStages.Recording &amp;&amp; args.IsInteraction &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln625">            {</a>
<a name="ln626">                var controlHit = VisualTreeHelper.HitTest(this, Mouse.GetPosition(this));</a>
<a name="ln627">                var selectionHit = _regionSelection.IsVisible &amp;&amp; _regionSelection.Opacity &gt; 0 ? VisualTreeHelper.HitTest(_regionSelection, Mouse.GetPosition(_regionSelection)) : null;</a>
<a name="ln628"> </a>
<a name="ln629">                if (controlHit == null &amp;&amp; selectionHit == null)</a>
<a name="ln630">                    await Snap();</a>
<a name="ln631">            }</a>
<a name="ln632">        }</a>
<a name="ln633">        catch (Exception e)</a>
<a name="ln634">        {</a>
<a name="ln635">            LogWriter.Log(e, &quot;Error in mouse hook target.&quot;);</a>
<a name="ln636">        }</a>
<a name="ln637">    }</a>
<a name="ln638"> </a>
<a name="ln639"> </a>
<a name="ln640">    #region Timers</a>
<a name="ln641"> </a>
<a name="ln642">    private void PreStart_Elapsed(object sender, EventArgs e)</a>
<a name="ln643">    {</a>
<a name="ln644">        if (_preStartCount &gt;= 1)</a>
<a name="ln645">        {</a>
<a name="ln646">            Title = &quot;ScreenToGif - &quot; + LocalizationHelper.Get(&quot;S.Recorder.PreStarting&quot;);</a>
<a name="ln647">            DisplayTimer.SetElapsed(-_preStartCount);</a>
<a name="ln648">            Splash.SetTime(-_preStartCount);</a>
<a name="ln649">            _preStartCount--;</a>
<a name="ln650">            return;</a>
<a name="ln651">        }</a>
<a name="ln652"> </a>
<a name="ln653">        _preStartTimer.Stop();</a>
<a name="ln654"> </a>
<a name="ln655">        if (Splash.IsBeingDisplayed())</a>
<a name="ln656">            Splash.Dismiss();</a>
<a name="ln657"> </a>
<a name="ln658">        if (IsRegionIntersected())</a>
<a name="ln659">            WindowState = WindowState.Minimized;</a>
<a name="ln660"> </a>
<a name="ln661">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln662">        IsRecording = true;</a>
<a name="ln663"> </a>
<a name="ln664">        StartCapture();</a>
<a name="ln665"> </a>
<a name="ln666">        if (Arguments.StartCapture &amp;&amp; Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln667">            _limitTimer.Start();</a>
<a name="ln668"> </a>
<a name="ln669">        Stage = RecorderStages.Recording;</a>
<a name="ln670">    }</a>
<a name="ln671"> </a>
<a name="ln672">    private void FollowTimer_Tick(object sender, EventArgs e)</a>
<a name="ln673">    {</a>
<a name="ln674">        if (_viewModel.Region.IsEmpty || _prevPosX == _posX &amp;&amp; _prevPosY == _posY || Stage == RecorderStages.Paused || Stage == RecorderStages.Stopped || Stage == RecorderStages.Discarding ||</a>
<a name="ln675">            (Keyboard.Modifiers != ModifierKeys.None &amp;&amp; Keyboard.Modifiers == UserSettings.All.DisableFollowModifiers))</a>
<a name="ln676">            return;</a>
<a name="ln677"> </a>
<a name="ln678">        _prevPosX = _posX;</a>
<a name="ln679">        _prevPosY = _posY;</a>
<a name="ln680"> </a>
<a name="ln681">        //Only move to the left if 'Mouse.X &lt; Rect.L' and only move to the right if 'Mouse.X &gt; Rect.R'</a>
<a name="ln682">        _offsetX = _posX - UserSettings.All.FollowBuffer &lt; _viewModel.Region.X ? _posX - _viewModel.Region.X - UserSettings.All.FollowBuffer :</a>
<a name="ln683">            _posX + UserSettings.All.FollowBuffer &gt; _viewModel.Region.Right ? _posX - _viewModel.Region.Right + UserSettings.All.FollowBuffer : 0;</a>
<a name="ln684"> </a>
<a name="ln685">        _offsetY = _posY - UserSettings.All.FollowBuffer &lt; _viewModel.Region.Y ? _posY - _viewModel.Region.Y - UserSettings.All.FollowBuffer :</a>
<a name="ln686">            _posY + UserSettings.All.FollowBuffer &gt; _viewModel.Region.Bottom ? _posY - _viewModel.Region.Bottom + UserSettings.All.FollowBuffer : 0;</a>
<a name="ln687"> </a>
<a name="ln688">        //Hide the UI when moving.</a>
<a name="ln689">        if (_posX - UserSettings.All.FollowBuffer - UserSettings.All.FollowBufferInvisible &lt; _viewModel.Region.X || _posX + UserSettings.All.FollowBuffer + UserSettings.All.FollowBufferInvisible &gt; _viewModel.Region.Right ||</a>
<a name="ln690">            _posY - UserSettings.All.FollowBuffer - UserSettings.All.FollowBufferInvisible &lt; _viewModel.Region.Y || _posY + UserSettings.All.FollowBuffer + UserSettings.All.FollowBufferInvisible &gt; _viewModel.Region.Bottom)</a>
<a name="ln691">        {</a>
<a name="ln692">            _showBorderTimer.Stop();</a>
<a name="ln693"> </a>
<a name="ln694">            Visibility = Visibility.Hidden;</a>
<a name="ln695">            _regionSelection.Hide();</a>
<a name="ln696"> </a>
<a name="ln697">            _showBorderTimer.Start();</a>
<a name="ln698">        }</a>
<a name="ln699"> </a>
<a name="ln700">        //Limit to the current screen (only if in DirectX mode).</a>
<a name="ln701">        //_viewModel.Region = new Rect(new Point((_viewModel.Region.X + _offsetX).Clamp(_viewModel.MaximumBounds.Left - 1, _viewModel.MaximumBounds.Width - _viewModel.Region.Width + 1),</a>
<a name="ln702">        //    (_viewModel.Region.Y + _offsetY).Clamp(_viewModel.MaximumBounds.Top - 1, _viewModel.MaximumBounds.Height - _viewModel.Region.Height + 1)), _viewModel.Region.Size);</a>
<a name="ln703"> </a>
<a name="ln704">        //Limit to the current screen.</a>
<a name="ln705">        _viewModel.Region = new Rect(new Point((_viewModel.Region.X + _offsetX).Clamp(_viewModel.CurrentMonitor.Bounds.Left - 1, _viewModel.CurrentMonitor.Bounds.Width - _viewModel.Region.Width + 1),</a>
<a name="ln706">            (_viewModel.Region.Y + _offsetY).Clamp(_viewModel.CurrentMonitor.Bounds.Top - 1, _viewModel.CurrentMonitor.Bounds.Height - _viewModel.Region.Height + 1)), _viewModel.Region.Size);</a>
<a name="ln707"> </a>
<a name="ln708">        //Tell the capture helper that the position changed.</a>
<a name="ln709">        if (Capture == null)</a>
<a name="ln710">            return;</a>
<a name="ln711"> </a>
<a name="ln712">        Capture.Left = (int)CaptureRegion.Left;</a>
<a name="ln713">        Capture.Top = (int)CaptureRegion.Top;</a>
<a name="ln714">    }</a>
<a name="ln715"> </a>
<a name="ln716">    private void ShowBorderTimer_Tick(object sender, EventArgs e)</a>
<a name="ln717">    {</a>
<a name="ln718">        _showBorderTimer.Stop();</a>
<a name="ln719"> </a>
<a name="ln720">        DetectMonitorChanges();</a>
<a name="ln721">        DisplaySelection();</a>
<a name="ln722">        MoveCommandPanel();</a>
<a name="ln723"> </a>
<a name="ln724">        Visibility = Visibility.Visible;</a>
<a name="ln725">    }</a>
<a name="ln726"> </a>
<a name="ln727">    private async void Limit_Elapsed(object sender, EventArgs e)</a>
<a name="ln728">    {</a>
<a name="ln729">        _limitTimer.Stop();</a>
<a name="ln730"> </a>
<a name="ln731">        if (!IsLoaded || (Stage != RecorderStages.Recording &amp;&amp; Stage == RecorderStages.PreStarting))</a>
<a name="ln732">            return;</a>
<a name="ln733"> </a>
<a name="ln734">        await Stop();</a>
<a name="ln735">    }</a>
<a name="ln736"> </a>
<a name="ln737">    #endregion</a>
<a name="ln738"> </a>
<a name="ln739">    #region Methods</a>
<a name="ln740"> </a>
<a name="ln741">    internal void MoveToMainScreen()</a>
<a name="ln742">    {</a>
<a name="ln743">        var main = _viewModel.Monitors.FirstOrDefault(f =&gt; f.IsPrimary) ?? _viewModel.Monitors.FirstOrDefault();</a>
<a name="ln744"> </a>
<a name="ln745">        if (main == null)</a>
<a name="ln746">            return;</a>
<a name="ln747"> </a>
<a name="ln748">        //If there's no selection, simply move the command panel to the main screen.</a>
<a name="ln749">        if (_viewModel.Region.IsEmpty)</a>
<a name="ln750">        {</a>
<a name="ln751">            MovePanelTo(main, main.WorkingArea.Left + main.WorkingArea.Width / 2 - RecorderWindow.ActualWidth / 2, main.WorkingArea.Top + main.WorkingArea.Height / 2 - RecorderWindow.ActualHeight / 2);</a>
<a name="ln752">            return;</a>
<a name="ln753">        }</a>
<a name="ln754"> </a>
<a name="ln755">        //This code it's kind of broken. It's not taking into consideration the relative position of the window on the secondary monitor.</a>
<a name="ln756">        //It will move the window to the primary monitor, but it won't keep the same axis.</a>
<a name="ln757"> </a>
<a name="ln758">        var diff = _regionSelection.Scale / main.Scale;</a>
<a name="ln759">        var left = _viewModel.Region.Left / diff;</a>
<a name="ln760">        var top = _viewModel.Region.Top / diff;</a>
<a name="ln761"> </a>
<a name="ln762">        if (main.Bounds.Top &gt; top)</a>
<a name="ln763">            top = main.Bounds.Top;</a>
<a name="ln764"> </a>
<a name="ln765">        if (main.Bounds.Left &gt; left)</a>
<a name="ln766">            left = main.Bounds.Left;</a>
<a name="ln767"> </a>
<a name="ln768">        if (main.Bounds.Bottom &lt; top + _viewModel.Region.Height * diff)</a>
<a name="ln769">            top = main.Bounds.Bottom - _viewModel.Region.Height * diff;</a>
<a name="ln770"> </a>
<a name="ln771">        if (main.Bounds.Right &lt; left + _viewModel.Region.Width * diff)</a>
<a name="ln772">            left = main.Bounds.Right - _viewModel.Region.Width * diff;</a>
<a name="ln773"> </a>
<a name="ln774">        UserSettings.All.SelectedRegion = _viewModel.Region = new Rect(new Point(left, top), _viewModel.Region.Size);</a>
<a name="ln775">        UserSettings.All.SelectedRegionScale = main.Scale;</a>
<a name="ln776"> </a>
<a name="ln777">        DisplaySelection(_regionSelection.Mode, main);</a>
<a name="ln778">        MoveCommandPanel();</a>
<a name="ln779">    }</a>
<a name="ln780"> </a>
<a name="ln781">    private async Task UpdatePositioning(bool startup = false)</a>
<a name="ln782">    {</a>
<a name="ln783">        if (!startup)</a>
<a name="ln784">        {</a>
<a name="ln785">            #region When the recorder was already opened</a>
<a name="ln786"> </a>
<a name="ln787">            //When in selection mode, cancel selection.</a>
<a name="ln788">            if (RegionSelectHelper.IsSelecting)</a>
<a name="ln789">                RegionSelectHelper.Abort();</a>
<a name="ln790"> </a>
<a name="ln791">            switch (Stage)</a>
<a name="ln792">            {</a>
<a name="ln793">                case RecorderStages.PreStarting:</a>
<a name="ln794">                {</a>
<a name="ln795">                    await Stop();</a>
<a name="ln796">                    break;</a>
<a name="ln797">                }</a>
<a name="ln798">                case RecorderStages.Recording:</a>
<a name="ln799">                {</a>
<a name="ln800">                    if (UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual)</a>
<a name="ln801">                        Pause();</a>
<a name="ln802"> </a>
<a name="ln803">                    break;</a>
<a name="ln804">                }</a>
<a name="ln805">            }</a>
<a name="ln806"> </a>
<a name="ln807">            //Move region to the closest available screen.</a>
<a name="ln808">            MoveToClosestScreen();</a>
<a name="ln809"> </a>
<a name="ln810">            #endregion</a>
<a name="ln811">        }</a>
<a name="ln812">        else</a>
<a name="ln813">        {</a>
<a name="ln814">            #region The user can opt out of the using the previous position and size</a>
<a name="ln815"> </a>
<a name="ln816">            if (!UserSettings.All.RecorderRememberPosition &amp;&amp; !UserSettings.All.SelectedRegion.IsEmpty)</a>
<a name="ln817">            {</a>
<a name="ln818">                if (!UserSettings.All.RecorderRememberSize)</a>
<a name="ln819">                {</a>
<a name="ln820">                    UserSettings.All.SelectedRegion = Rect.Empty;</a>
<a name="ln821">                }</a>
<a name="ln822">                else</a>
<a name="ln823">                {</a>
<a name="ln824">                    var main = _viewModel.Monitors.FirstOrDefault(f =&gt; f.IsPrimary) ?? _viewModel.Monitors.FirstOrDefault();</a>
<a name="ln825"> </a>
<a name="ln826">                    if (main != null)</a>
<a name="ln827">                    {</a>
<a name="ln828">                        //Center the selection on the main screen.</a>
<a name="ln829">                        var left = main.Bounds.Left + main.Bounds.Width / 2d - UserSettings.All.SelectedRegion.Width / 2d;</a>
<a name="ln830">                        var top = main.Bounds.Top + main.Bounds.Height / 2d - UserSettings.All.SelectedRegion.Height / 2d;</a>
<a name="ln831"> </a>
<a name="ln832">                        UserSettings.All.SelectedRegion = new Rect(new Point(left, top), UserSettings.All.SelectedRegion.Size);</a>
<a name="ln833">                        UserSettings.All.SelectedRegionScale = main.Scale;</a>
<a name="ln834">                    }</a>
<a name="ln835">                    else</a>
<a name="ln836">                    {</a>
<a name="ln837">                        //If it was not possible to detect the primary screen, simply clear the selection.</a>
<a name="ln838">                        UserSettings.All.SelectedRegion = Rect.Empty;</a>
<a name="ln839">                        UserSettings.All.SelectedRegionScale = 1;</a>
<a name="ln840">                    }</a>
<a name="ln841">                }</a>
<a name="ln842">            }</a>
<a name="ln843"> </a>
<a name="ln844">            #endregion</a>
<a name="ln845"> </a>
<a name="ln846">            //Command line arguments were sent.</a>
<a name="ln847">            if (Arguments.Region != Rect.Empty)</a>
<a name="ln848">            {</a>
<a name="ln849">                UserSettings.All.SelectedRegion = Arguments.Region;</a>
<a name="ln850">                Arguments.Region = Rect.Empty;</a>
<a name="ln851">            }</a>
<a name="ln852"> </a>
<a name="ln853">            #region Previously selected region</a>
<a name="ln854"> </a>
<a name="ln855">            //If a region was previously selected.</a>
<a name="ln856">            if (!UserSettings.All.SelectedRegion.IsEmpty)</a>
<a name="ln857">            {</a>
<a name="ln858">                //Check if the previous selection can be positioned inside a screen.</a>
<a name="ln859">                var monitor = _viewModel.Monitors.FirstOrDefault(f =&gt; f.NativeBounds.Contains(UserSettings.All.SelectedRegion.Scale(UserSettings.All.SelectedRegionScale)));</a>
<a name="ln860"> </a>
<a name="ln861">                if (monitor != null)</a>
<a name="ln862">                {</a>
<a name="ln863">                    _viewModel.CurrentMonitor = monitor;</a>
<a name="ln864">                    _viewModel.Region = UserSettings.All.SelectedRegion;</a>
<a name="ln865">                    UserSettings.All.SelectedRegionScale = monitor.Scale;</a>
<a name="ln866">                }</a>
<a name="ln867">                else</a>
<a name="ln868">                {</a>
<a name="ln869">                    //Fullscreen selection.</a>
<a name="ln870">                    monitor = _viewModel.Monitors.FirstOrDefault(f =&gt; f.Bounds == UserSettings.All.SelectedRegion.Offset(1));</a>
<a name="ln871"> </a>
<a name="ln872">                    if (monitor != null)</a>
<a name="ln873">                    {</a>
<a name="ln874">                        _viewModel.CurrentMonitor = monitor;</a>
<a name="ln875">                        _viewModel.Region = UserSettings.All.SelectedRegion;</a>
<a name="ln876">                        UserSettings.All.SelectedRegionScale = monitor.Scale;</a>
<a name="ln877">                    }</a>
<a name="ln878">                }</a>
<a name="ln879">            }</a>
<a name="ln880"> </a>
<a name="ln881">            #endregion</a>
<a name="ln882">        }</a>
<a name="ln883"> </a>
<a name="ln884">        //Change the scale of the sizing controls.</a>
<a name="ln885">        WidthIntegerBox.Scale = UserSettings.All.SelectedRegionScale;</a>
<a name="ln886">        HeightIntegerBox.Scale = UserSettings.All.SelectedRegionScale;</a>
<a name="ln887"> </a>
<a name="ln888">        #region Adjust the position of the main controls</a>
<a name="ln889"> </a>
<a name="ln890">        if (_viewModel.Region.IsEmpty)</a>
<a name="ln891">        {</a>
<a name="ln892">            #region Center on screen</a>
<a name="ln893"> </a>
<a name="ln894">            var screen = _viewModel.Monitors.FirstOrDefault(x =&gt; x.Bounds.Contains(Native.Helpers.Other.GetMousePosition(1, Left, Top))) ?? _viewModel.Monitors.FirstOrDefault(x =&gt; x.IsPrimary) ?? _viewModel.Monitors.FirstOrDefault();</a>
<a name="ln895"> </a>
<a name="ln896">            if (screen == null)</a>
<a name="ln897">                throw new Exception(&quot;It was not possible to get a list of known screens.&quot;);</a>
<a name="ln898"> </a>
<a name="ln899">            MovePanelTo(screen, screen.WorkingArea.Left + screen.WorkingArea.Width / 2 - RecorderWindow.ActualWidth / 2, screen.WorkingArea.Top + screen.WorkingArea.Height / 2 - RecorderWindow.ActualHeight / 2);</a>
<a name="ln900"> </a>
<a name="ln901">            #endregion</a>
<a name="ln902">        }</a>
<a name="ln903">        else</a>
<a name="ln904">        {</a>
<a name="ln905">            MoveCommandPanel();</a>
<a name="ln906">            DisplaySelection((ModeType) UserSettings.All.RecorderModeIndex);</a>
<a name="ln907">        }</a>
<a name="ln908"> </a>
<a name="ln909">        #endregion</a>
<a name="ln910">    }</a>
<a name="ln911"> </a>
<a name="ln912">    private void ForceUpdate()</a>
<a name="ln913">    {</a>
<a name="ln914">        InvalidateMeasure();</a>
<a name="ln915">        InvalidateArrange();</a>
<a name="ln916">        Measure(new Size(double.PositiveInfinity, double.PositiveInfinity));</a>
<a name="ln917">        Arrange(new Rect(DesiredSize));</a>
<a name="ln918">    }</a>
<a name="ln919"> </a>
<a name="ln920">    private void RegisterCommands()</a>
<a name="ln921">    {</a>
<a name="ln922">        CommandBindings.Clear();</a>
<a name="ln923">        CommandBindings.AddRange(new CommandBindingCollection</a>
<a name="ln924">        {</a>
<a name="ln925">            new CommandBinding(_viewModel.CloseCommand, (_, _) =&gt; Close(),</a>
<a name="ln926">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Stopped || (UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction &amp;&amp; (Project == null || !Project.Any))),</a>
<a name="ln927"> </a>
<a name="ln928">            new CommandBinding(_viewModel.OptionsCommand, ShowOptions,</a>
<a name="ln929">                (_, args) =&gt; args.CanExecute = (Stage != RecorderStages.Recording || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction) &amp;&amp; Stage != RecorderStages.PreStarting),</a>
<a name="ln930"> </a>
<a name="ln931">            new CommandBinding(_viewModel.SwitchFrequencyCommand, SwitchFrequency,</a>
<a name="ln932">                (_, args) =&gt;</a>
<a name="ln933">                {</a>
<a name="ln934">                    if (args.Parameter != null &amp;&amp; !args.Parameter.Equals(&quot;Switch&quot;))</a>
<a name="ln935">                    {</a>
<a name="ln936">                        args.CanExecute = true;</a>
<a name="ln937">                        return;</a>
<a name="ln938">                    }</a>
<a name="ln939"> </a>
<a name="ln940">                    args.CanExecute = ((Stage != RecorderStages.Recording || Project == null) || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction) &amp;&amp; Stage != RecorderStages.PreStarting;</a>
<a name="ln941">                }),</a>
<a name="ln942"> </a>
<a name="ln943">            new CommandBinding(_viewModel.RecordCommand, async (_, _) =&gt; await Record(),</a>
<a name="ln944">                (_, args) =&gt; args.CanExecute = Stage is RecorderStages.Stopped or RecorderStages.Paused &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual),</a>
<a name="ln945"> </a>
<a name="ln946">            new CommandBinding(_viewModel.PauseCommand, (_, _) =&gt; Pause(),</a>
<a name="ln947">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual),</a>
<a name="ln948"> </a>
<a name="ln949">            new CommandBinding(_viewModel.SnapCommand, async (_, _) =&gt; await Snap(),</a>
<a name="ln950">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual),</a>
<a name="ln951"> </a>
<a name="ln952">            new CommandBinding(_viewModel.StopLargeCommand, async (_, _) =&gt; await Stop(),</a>
<a name="ln953">                (_, args) =&gt; args.CanExecute = (Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Interaction &amp;&amp;</a>
<a name="ln954">                    !UserSettings.All.RecorderDisplayDiscard) || Stage == RecorderStages.PreStarting),</a>
<a name="ln955"> </a>
<a name="ln956">            new CommandBinding(_viewModel.StopCommand, async (_, _) =&gt; await Stop(),</a>
<a name="ln957">                (_, args) =&gt;</a>
<a name="ln958">                {</a>
<a name="ln959">                    if (UserSettings.All.RecorderCompactMode)</a>
<a name="ln960">                    {</a>
<a name="ln961">                        args.CanExecute = Stage == RecorderStages.Recording &amp;&amp; ((UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Interaction &amp;&amp;</a>
<a name="ln962">                            !UserSettings.All.RecorderDisplayDiscard) || FrameCount &gt; 0) || Stage is RecorderStages.Paused or RecorderStages.PreStarting;</a>
<a name="ln963">                        return;</a>
<a name="ln964">                    }</a>
<a name="ln965"> </a>
<a name="ln966">                    args.CanExecute = (Stage == RecorderStages.Recording &amp;&amp; (UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction || UserSettings.All.RecorderDisplayDiscard) &amp;&amp; FrameCount &gt; 0) ||</a>
<a name="ln967">                        (Stage == RecorderStages.Paused &amp;&amp; FrameCount &gt; 0);</a>
<a name="ln968">                }),</a>
<a name="ln969"> </a>
<a name="ln970">            new CommandBinding(_viewModel.DiscardCommand, async (_, _) =&gt; await Discard(),</a>
<a name="ln971">                (_, args) =&gt; args.CanExecute = (Stage == RecorderStages.Paused &amp;&amp; FrameCount &gt; 0) || (Stage == RecorderStages.Recording &amp;&amp; (UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction ||</a>
<a name="ln972">                    UserSettings.All.RecorderDisplayDiscard) &amp;&amp; FrameCount &gt; 0))});</a>
<a name="ln973"> </a>
<a name="ln974">        _viewModel.RefreshKeyGestures();</a>
<a name="ln975">    }</a>
<a name="ln976"> </a>
<a name="ln977">    private void ShowOptions(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln978">    {</a>
<a name="ln979">        Topmost = false;</a>
<a name="ln980">        _regionSelection.Topmost = false;</a>
<a name="ln981"> </a>
<a name="ln982">        var options = new Options(Options.RecorderIndex);</a>
<a name="ln983">        options.ShowDialog();</a>
<a name="ln984"> </a>
<a name="ln985">        DetectCaptureFrequency();</a>
<a name="ln986">        RegisterCommands();</a>
<a name="ln987">        DisplaySelection();</a>
<a name="ln988">        MoveCommandPanel();</a>
<a name="ln989"> </a>
<a name="ln990">        //If not recording (or recording in manual/interactive mode, but with no frames captured yet), adjust the maximum bounds for the recorder.</a>
<a name="ln991">        if (Stage == RecorderStages.Stopped || ((UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual || UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction) &amp;&amp; Stage == RecorderStages.Recording &amp;&amp; FrameCount == 0))</a>
<a name="ln992">            _viewModel.IsDirectMode = UserSettings.All.UseDesktopDuplication;</a>
<a name="ln993"> </a>
<a name="ln994">        Topmost = true;</a>
<a name="ln995">        _regionSelection.Topmost = true;</a>
<a name="ln996">    }</a>
<a name="ln997"> </a>
<a name="ln998">    internal async Task Record()</a>
<a name="ln999">    {</a>
<a name="ln1000">        try</a>
<a name="ln1001">        {</a>
<a name="ln1002">            switch (Stage)</a>
<a name="ln1003">            {</a>
<a name="ln1004">                case RecorderStages.Stopped:</a>
<a name="ln1005">                {</a>
<a name="ln1006">                    #region If region not yet selected</a>
<a name="ln1007"> </a>
<a name="ln1008">                    if (_viewModel.Region.IsEmpty)</a>
<a name="ln1009">                    {</a>
<a name="ln1010">                        await PickRegion((ModeType) ReselectSplitButton.SelectedIndex, true);</a>
<a name="ln1011"> </a>
<a name="ln1012">                        if (_viewModel.Region.IsEmpty)</a>
<a name="ln1013">                            return;</a>
<a name="ln1014">                    }</a>
<a name="ln1015"> </a>
<a name="ln1016">                    #endregion</a>
<a name="ln1017"> </a>
<a name="ln1018">                    #region If interaction mode</a>
<a name="ln1019"> </a>
<a name="ln1020">                    if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln1021">                    {</a>
<a name="ln1022">                        Stage = RecorderStages.Recording;</a>
<a name="ln1023">                        SetTaskbarButtonOverlay();</a>
<a name="ln1024">                        Hide();</a>
<a name="ln1025">                        return;</a>
<a name="ln1026">                    }</a>
<a name="ln1027"> </a>
<a name="ln1028">                    #endregion</a>
<a name="ln1029"> </a>
<a name="ln1030">                    #region To record</a>
<a name="ln1031"> </a>
<a name="ln1032">                    Project = new ProjectInfo().CreateProjectFolder(ProjectByType.ScreenRecorder);</a>
<a name="ln1033"> </a>
<a name="ln1034">                    KeyList.Clear();</a>
<a name="ln1035">                    FrameCount = 0;</a>
<a name="ln1036"> </a>
<a name="ln1037">                    await PrepareCapture();</a>
<a name="ln1038"> </a>
<a name="ln1039">                    FrequencyIntegerUpDown.IsEnabled = false;</a>
<a name="ln1040"> </a>
<a name="ln1041">                    _regionSelection.HideGuidelines();</a>
<a name="ln1042">                    IsRecording = true;</a>
<a name="ln1043">                    Topmost = true;</a>
<a name="ln1044"> </a>
<a name="ln1045">                    //Tries to move the command panel away from the recording area.</a>
<a name="ln1046">                    MoveCommandPanel(true);</a>
<a name="ln1047"> </a>
<a name="ln1048">                    //Detects a possible intersection of capture region and capture controls.</a>
<a name="ln1049">                    var isIntersecting = IsRegionIntersected();</a>
<a name="ln1050"> </a>
<a name="ln1051">                    if (isIntersecting)</a>
<a name="ln1052">                    {</a>
<a name="ln1053">                        Topmost = false;</a>
<a name="ln1054">                        Splash.Display(LocalizationHelper.GetWithFormat(&quot;S.Recorder.Splash.Title&quot;, &quot;Press {0} to stop the recording&quot;, Native.Helpers.Other.GetSelectKeyText(UserSettings.All.StopShortcut, UserSettings.All.StopModifiers)),</a>
<a name="ln1055">                            LocalizationHelper.GetWithFormat(&quot;S.Recorder.Splash.Subtitle&quot;, &quot;The recorder window will be minimized,&amp;#10;restore it or press {0} to pause the capture&quot;, Native.Helpers.Other.GetSelectKeyText(UserSettings.All.StartPauseShortcut, UserSettings.All.StartPauseModifiers)));</a>
<a name="ln1056">                        Splash.SetTime(-UserSettings.All.PreStartValue);</a>
<a name="ln1057">                    }</a>
<a name="ln1058"> </a>
<a name="ln1059">                    #region Start</a>
<a name="ln1060"> </a>
<a name="ln1061">                    if (isIntersecting || UserSettings.All.UsePreStart)</a>
<a name="ln1062">                    {</a>
<a name="ln1063">                        Stage = RecorderStages.PreStarting;</a>
<a name="ln1064"> </a>
<a name="ln1065">                        Title = &quot;ScreenToGif - &quot; + LocalizationHelper.Get(&quot;S.Recorder.PreStarting&quot;);</a>
<a name="ln1066">                        DisplayTimer.SetElapsed(-UserSettings.All.PreStartValue);</a>
<a name="ln1067"> </a>
<a name="ln1068">                        _preStartCount = UserSettings.All.PreStartValue - 1;</a>
<a name="ln1069">                        _preStartTimer.Start();</a>
<a name="ln1070">                        return;</a>
<a name="ln1071">                    }</a>
<a name="ln1072"> </a>
<a name="ln1073">                    Hide();</a>
<a name="ln1074">                    StartCapture();</a>
<a name="ln1075"> </a>
<a name="ln1076">                    Stage = RecorderStages.Recording;</a>
<a name="ln1077">                    SetTaskbarButtonOverlay();</a>
<a name="ln1078"> </a>
<a name="ln1079">                    if (Arguments.StartCapture &amp;&amp; Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln1080">                        _limitTimer.Start();</a>
<a name="ln1081"> </a>
<a name="ln1082">                    #endregion</a>
<a name="ln1083"> </a>
<a name="ln1084">                    #endregion</a>
<a name="ln1085"> </a>
<a name="ln1086">                    break;</a>
<a name="ln1087">                }</a>
<a name="ln1088"> </a>
<a name="ln1089">                case RecorderStages.Paused:</a>
<a name="ln1090">                {</a>
<a name="ln1091">                    #region To record again</a>
<a name="ln1092"> </a>
<a name="ln1093">                    Stage = RecorderStages.Recording;</a>
<a name="ln1094">                    Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1095">                    _regionSelection.HideGuidelines();</a>
<a name="ln1096">                    SetTaskbarButtonOverlay();</a>
<a name="ln1097"> </a>
<a name="ln1098">                    //Tries to move the command panel away from the recording area.</a>
<a name="ln1099">                    MoveCommandPanel(true);</a>
<a name="ln1100"> </a>
<a name="ln1101">                    //If it's interaction mode, the capture is done via Snap().</a>
<a name="ln1102">                    if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln1103">                        return;</a>
<a name="ln1104"> </a>
<a name="ln1105">                    await PrepareCapture(false);</a>
<a name="ln1106"> </a>
<a name="ln1107">                    //Detects a possible intersection of capture region and capture controls.</a>
<a name="ln1108">                    if (IsRegionIntersected())</a>
<a name="ln1109">                        WindowState = WindowState.Minimized;</a>
<a name="ln1110"> </a>
<a name="ln1111">                    FrequencyIntegerUpDown.IsEnabled = false;</a>
<a name="ln1112"> </a>
<a name="ln1113">                    StartCapture();</a>
<a name="ln1114"> </a>
<a name="ln1115">                    #endregion</a>
<a name="ln1116"> </a>
<a name="ln1117">                    break;</a>
<a name="ln1118">                }</a>
<a name="ln1119">            }</a>
<a name="ln1120">        }</a>
<a name="ln1121">        catch (GraphicsConfigurationException g)</a>
<a name="ln1122">        {</a>
<a name="ln1123">            LogWriter.Log(g, &quot;Impossible to start the recording due to wrong graphics adapter.&quot;);</a>
<a name="ln1124">            GraphicsConfigurationDialog.Ok(g, _viewModel.CurrentMonitor);</a>
<a name="ln1125">        }</a>
<a name="ln1126">        catch (Exception e)</a>
<a name="ln1127">        {</a>
<a name="ln1128">            LogWriter.Log(e, &quot;Impossible to start the recording.&quot;);</a>
<a name="ln1129">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.StartPauseNotPossible&quot;), e.Message, e);</a>
<a name="ln1130">        }</a>
<a name="ln1131">        finally</a>
<a name="ln1132">        {</a>
<a name="ln1133">            Arguments.ClearAutomationArgs();</a>
<a name="ln1134"> </a>
<a name="ln1135">            //Wait a bit, then refresh the commands. Some of the commands are dependent of the FrameCount property.</a>
<a name="ln1136">            await Task.Delay(TimeSpan.FromMilliseconds(200));</a>
<a name="ln1137"> </a>
<a name="ln1138">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1139">            AdjustForWidthChange();</a>
<a name="ln1140">        }</a>
<a name="ln1141">    }</a>
<a name="ln1142"> </a>
<a name="ln1143">    private async Task Snap()</a>
<a name="ln1144">    {</a>
<a name="ln1145">        var snapTriggerDelay = GetTriggerDelay();</a>
<a name="ln1146"> </a>
<a name="ln1147">        if (snapTriggerDelay != 0)</a>
<a name="ln1148">            await Task.Delay(snapTriggerDelay);</a>
<a name="ln1149"> </a>
<a name="ln1150">        #region If region not yet selected</a>
<a name="ln1151"> </a>
<a name="ln1152">        if (_viewModel.Region.IsEmpty)</a>
<a name="ln1153">        {</a>
<a name="ln1154">            await PickRegion((ModeType)ReselectSplitButton.SelectedIndex, true);</a>
<a name="ln1155"> </a>
<a name="ln1156">            if (_viewModel.Region.IsEmpty)</a>
<a name="ln1157">                return;</a>
<a name="ln1158">        }</a>
<a name="ln1159"> </a>
<a name="ln1160">        #endregion</a>
<a name="ln1161"> </a>
<a name="ln1162">        _regionSelection.HideGuidelines();</a>
<a name="ln1163"> </a>
<a name="ln1164">        if (Project == null || Project.Frames.Count == 0)</a>
<a name="ln1165">        {</a>
<a name="ln1166">            try</a>
<a name="ln1167">            {</a>
<a name="ln1168">                Project = new ProjectInfo().CreateProjectFolder(ProjectByType.ScreenRecorder);</a>
<a name="ln1169"> </a>
<a name="ln1170">                await PrepareCapture();</a>
<a name="ln1171"> </a>
<a name="ln1172">                KeyList.Clear();</a>
<a name="ln1173">                IsRecording = true;</a>
<a name="ln1174">            }</a>
<a name="ln1175">            catch (Exception ex)</a>
<a name="ln1176">            {</a>
<a name="ln1177">                LogWriter.Log(ex, &quot;Impossible to start the screencasting.&quot;);</a>
<a name="ln1178">                ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), ex.Message, ex);</a>
<a name="ln1179">                return;</a>
<a name="ln1180">            }</a>
<a name="ln1181">        }</a>
<a name="ln1182"> </a>
<a name="ln1183">        #region Take the screenshot</a>
<a name="ln1184"> </a>
<a name="ln1185">        try</a>
<a name="ln1186">        {</a>
<a name="ln1187">            var limit = 0;</a>
<a name="ln1188">            do</a>
<a name="ln1189">            {</a>
<a name="ln1190">                FrameCount = await Capture.ManualCaptureAsync(new FrameInfo(RecordClicked, KeyList), UserSettings.All.ShowCursor);</a>
<a name="ln1191"> </a>
<a name="ln1192">                if (limit &gt; 5)</a>
<a name="ln1193">                    throw new Exception(&quot;Impossible to capture the manual screenshot.&quot;);</a>
<a name="ln1194"> </a>
<a name="ln1195">                limit++;</a>
<a name="ln1196">            }</a>
<a name="ln1197">            while (FrameCount == 0);</a>
<a name="ln1198"> </a>
<a name="ln1199">            KeyList.Clear();</a>
<a name="ln1200"> </a>
<a name="ln1201">            //Displays that a frame was manually captured.</a>
<a name="ln1202">            DisplayTimer.ManuallyCapturedCount++;</a>
<a name="ln1203">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1204">        }</a>
<a name="ln1205">        catch (GraphicsConfigurationException g)</a>
<a name="ln1206">        {</a>
<a name="ln1207">            IsRecording = false;</a>
<a name="ln1208"> </a>
<a name="ln1209">            LogWriter.Log(g, &quot;Impossible to take a snap due to wrong graphics adapter.&quot;);</a>
<a name="ln1210">            GraphicsConfigurationDialog.Ok(g, _viewModel.CurrentMonitor);</a>
<a name="ln1211">        }</a>
<a name="ln1212">        catch (Exception e)</a>
<a name="ln1213">        {</a>
<a name="ln1214">            IsRecording = false;</a>
<a name="ln1215"> </a>
<a name="ln1216">            LogWriter.Log(e, &quot;Impossible to capture the manual screenshot.&quot;);</a>
<a name="ln1217">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible.Info&quot;), e);</a>
<a name="ln1218">        }</a>
<a name="ln1219"> </a>
<a name="ln1220">        #endregion</a>
<a name="ln1221">    }</a>
<a name="ln1222"> </a>
<a name="ln1223">    internal void Pause()</a>
<a name="ln1224">    {</a>
<a name="ln1225">        try</a>
<a name="ln1226">        {</a>
<a name="ln1227">            if (Stage != RecorderStages.Recording || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction)</a>
<a name="ln1228">                return;</a>
<a name="ln1229"> </a>
<a name="ln1230">            Stage = RecorderStages.Paused;</a>
<a name="ln1231">            Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1232"> </a>
<a name="ln1233">            _limitTimer.Stop();</a>
<a name="ln1234">            PauseCapture();</a>
<a name="ln1235"> </a>
<a name="ln1236">            FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1237">            _regionSelection.DisplayGuidelines();</a>
<a name="ln1238">            SetTaskbarButtonOverlay();</a>
<a name="ln1239">        }</a>
<a name="ln1240">        catch (Exception e)</a>
<a name="ln1241">        {</a>
<a name="ln1242">            LogWriter.Log(e, &quot;Impossible to pause the recording.&quot;);</a>
<a name="ln1243">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.StartPauseNotPossible&quot;), e.Message, e);</a>
<a name="ln1244">        }</a>
<a name="ln1245">    }</a>
<a name="ln1246"> </a>
<a name="ln1247">    private async Task Stop()</a>
<a name="ln1248">    {</a>
<a name="ln1249">        try</a>
<a name="ln1250">        {</a>
<a name="ln1251">            RecordControlsGrid.IsEnabled = false;</a>
<a name="ln1252">            Title = &quot;ScreenToGif - &quot; + LocalizationHelper.Get(&quot;S.Recorder.Stopping&quot;);</a>
<a name="ln1253">            Cursor = Cursors.AppStarting;</a>
<a name="ln1254"> </a>
<a name="ln1255">            _limitTimer.Stop();</a>
<a name="ln1256">            await StopCapture();</a>
<a name="ln1257"> </a>
<a name="ln1258">            if (Stage is RecorderStages.Recording or RecorderStages.Paused &amp;&amp; Project?.Any == true)</a>
<a name="ln1259">            {</a>
<a name="ln1260">                #region Finishes if it's recording and it has any frames</a>
<a name="ln1261"> </a>
<a name="ln1262">                await Task.Delay(100);</a>
<a name="ln1263"> </a>
<a name="ln1264">                Close();</a>
<a name="ln1265">                return;</a>
<a name="ln1266"> </a>
<a name="ln1267">                #endregion</a>
<a name="ln1268">            }</a>
<a name="ln1269"> </a>
<a name="ln1270">            #region Stops if it is not recording, or has no frames</a>
<a name="ln1271"> </a>
<a name="ln1272">            //Stop the pre-start timer to kill pre-start warming up.</a>
<a name="ln1273">            if (Stage == RecorderStages.PreStarting)</a>
<a name="ln1274">                _preStartTimer.Stop();</a>
<a name="ln1275"> </a>
<a name="ln1276">            Splash.Dismiss();</a>
<a name="ln1277">            Stage = RecorderStages.Stopped;</a>
<a name="ln1278"> </a>
<a name="ln1279">            //Enables the controls that are disabled while recording;</a>
<a name="ln1280">            FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1281">            IsRecording = false;</a>
<a name="ln1282">            Topmost = true;</a>
<a name="ln1283"> </a>
<a name="ln1284">            _regionSelection.DisplayGuidelines();</a>
<a name="ln1285">            SetTaskbarButtonOverlay();</a>
<a name="ln1286"> </a>
<a name="ln1287">            #endregion</a>
<a name="ln1288">        }</a>
<a name="ln1289">        catch (NullReferenceException nll)</a>
<a name="ln1290">        {</a>
<a name="ln1291">            LogWriter.Log(nll, &quot;NullPointer on the Stop function&quot;);</a>
<a name="ln1292"> </a>
<a name="ln1293">            ErrorDialog.Ok(&quot;ScreenToGif&quot;, &quot;Error while stopping&quot;, nll.Message, nll);</a>
<a name="ln1294">        }</a>
<a name="ln1295">        catch (Exception ex)</a>
<a name="ln1296">        {</a>
<a name="ln1297">            LogWriter.Log(ex, &quot;Error on the Stop function&quot;);</a>
<a name="ln1298"> </a>
<a name="ln1299">            ErrorDialog.Ok(&quot;ScreenToGif&quot;, &quot;Error while stopping&quot;, ex.Message, ex);</a>
<a name="ln1300">        }</a>
<a name="ln1301">        finally</a>
<a name="ln1302">        {</a>
<a name="ln1303">            if (IsLoaded)</a>
<a name="ln1304">            {</a>
<a name="ln1305">                Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1306">                Cursor = Cursors.Arrow;</a>
<a name="ln1307">                RecordControlsGrid.IsEnabled = true;</a>
<a name="ln1308"> </a>
<a name="ln1309">                //Wait a bit, then refresh the commands.</a>
<a name="ln1310">                await Task.Delay(TimeSpan.FromMilliseconds(200));</a>
<a name="ln1311"> </a>
<a name="ln1312">                CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1313">                MoveCommandPanel(true);</a>
<a name="ln1314">            }</a>
<a name="ln1315">        }</a>
<a name="ln1316">    }</a>
<a name="ln1317"> </a>
<a name="ln1318">    private async Task Discard()</a>
<a name="ln1319">    {</a>
<a name="ln1320">        Pause();</a>
<a name="ln1321"> </a>
<a name="ln1322">        if (UserSettings.All.NotifyRecordingDiscard &amp;&amp; !Dialog.Ask(LocalizationHelper.Get(&quot;S.Recorder.Discard.Title&quot;),</a>
<a name="ln1323">                LocalizationHelper.Get(&quot;S.Recorder.Discard.Instruction&quot;), LocalizationHelper.Get(&quot;S.Recorder.Discard.Message&quot;), false))</a>
<a name="ln1324">            return;</a>
<a name="ln1325"> </a>
<a name="ln1326">        await StopCapture();</a>
<a name="ln1327"> </a>
<a name="ln1328">        FrameCount = 0;</a>
<a name="ln1329">        Stage = RecorderStages.Discarding;</a>
<a name="ln1330">        RecordControlsGrid.IsEnabled = false;</a>
<a name="ln1331">        Cursor = Cursors.AppStarting;</a>
<a name="ln1332">        SetTaskbarButtonOverlay();</a>
<a name="ln1333"> </a>
<a name="ln1334">        await Task.Run(() =&gt;</a>
<a name="ln1335">        {</a>
<a name="ln1336">            try</a>
<a name="ln1337">            {</a>
<a name="ln1338">                #region Remove all the files</a>
<a name="ln1339"> </a>
<a name="ln1340">                //Not sure if needed.</a>
<a name="ln1341">                foreach (var frame in Project.Frames)</a>
<a name="ln1342">                {</a>
<a name="ln1343">                    try</a>
<a name="ln1344">                    {</a>
<a name="ln1345">                        if (File.Exists(frame.Path))</a>
<a name="ln1346">                            File.Delete(frame.Path);</a>
<a name="ln1347">                    }</a>
<a name="ln1348">                    catch (Exception)</a>
<a name="ln1349">                    { }</a>
<a name="ln1350">                }</a>
<a name="ln1351"> </a>
<a name="ln1352">                try</a>
<a name="ln1353">                {</a>
<a name="ln1354">                    Directory.Delete(Project.FullPath, true);</a>
<a name="ln1355">                }</a>
<a name="ln1356">                catch (Exception ex)</a>
<a name="ln1357">                {</a>
<a name="ln1358">                    LogWriter.Log(ex, &quot;Delete temp path&quot;);</a>
<a name="ln1359">                }</a>
<a name="ln1360"> </a>
<a name="ln1361">                #endregion</a>
<a name="ln1362"> </a>
<a name="ln1363">                Project.Frames.Clear();</a>
<a name="ln1364">            }</a>
<a name="ln1365">            catch (IOException io)</a>
<a name="ln1366">            {</a>
<a name="ln1367">                LogWriter.Log(io, &quot;Error while trying to discard the recording&quot;);</a>
<a name="ln1368">            }</a>
<a name="ln1369">            catch (Exception ex)</a>
<a name="ln1370">            {</a>
<a name="ln1371">                Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Discard Error&quot;, &quot;Error while trying to discard the recording&quot;, ex.Message));</a>
<a name="ln1372">                LogWriter.Log(ex, &quot;Error while trying to discard the recording&quot;);</a>
<a name="ln1373">            }</a>
<a name="ln1374">        });</a>
<a name="ln1375"> </a>
<a name="ln1376">        //Enables the controls that are disabled while recording;</a>
<a name="ln1377">        FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1378">        RecordControlsGrid.IsEnabled = true;</a>
<a name="ln1379"> </a>
<a name="ln1380">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1381">        Cursor = Cursors.Arrow;</a>
<a name="ln1382">        IsRecording = false;</a>
<a name="ln1383"> </a>
<a name="ln1384">        DetectCaptureFrequency();</a>
<a name="ln1385">        SetTaskbarButtonOverlay();</a>
<a name="ln1386"> </a>
<a name="ln1387">        //Wait a bit, then refresh the commands.</a>
<a name="ln1388">        await Task.Delay(TimeSpan.FromMilliseconds(200));</a>
<a name="ln1389"> </a>
<a name="ln1390">        CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1391">        MoveCommandPanel(true);</a>
<a name="ln1392">    }</a>
<a name="ln1393"> </a>
<a name="ln1394">    private async Task PrepareCapture(bool isNew = true)</a>
<a name="ln1395">    {</a>
<a name="ln1396">        if (isNew &amp;&amp; Capture != null)</a>
<a name="ln1397">        {</a>
<a name="ln1398">            await Capture.DisposeAsync();</a>
<a name="ln1399">            Capture = null;</a>
<a name="ln1400">        }</a>
<a name="ln1401"> </a>
<a name="ln1402">        //If the capture helper was initialized already, ignore this.</a>
<a name="ln1403">        if (Capture != null)</a>
<a name="ln1404">            return;</a>
<a name="ln1405"> </a>
<a name="ln1406">        if (UserSettings.All.UseDesktopDuplication)</a>
<a name="ln1407">        {</a>
<a name="ln1408">            //Check if Windows 8 or newer.</a>
<a name="ln1409">            if (!OperationalSystemHelper.IsWin8OrHigher())</a>
<a name="ln1410">                throw new Exception(LocalizationHelper.Get(&quot;S.Recorder.Warning.Windows8&quot;));</a>
<a name="ln1411"> </a>
<a name="ln1412">            Capture = GetDirectCapture();</a>
<a name="ln1413">            Capture.DeviceName = _viewModel.CurrentMonitor.Name;</a>
<a name="ln1414">            _viewModel.IsDirectMode = true;</a>
<a name="ln1415">        }</a>
<a name="ln1416">        else</a>
<a name="ln1417">        {</a>
<a name="ln1418">            //Capture with BitBlt.</a>
<a name="ln1419">            Capture = UserSettings.All.UseMemoryCache ? new CachedCapture() : new ImageCapture();</a>
<a name="ln1420"> </a>
<a name="ln1421">            _viewModel.IsDirectMode = false;</a>
<a name="ln1422">        }</a>
<a name="ln1423"> </a>
<a name="ln1424">        Capture.OnError += exception =&gt;</a>
<a name="ln1425">        {</a>
<a name="ln1426">            //Pause the recording and show the error.</a>
<a name="ln1427">            _viewModel.PauseCommand.Execute(null, null);</a>
<a name="ln1428"> </a>
<a name="ln1429">            if (exception is GraphicsConfigurationException)</a>
<a name="ln1430">                GraphicsConfigurationDialog.Ok(exception, _viewModel.CurrentMonitor);</a>
<a name="ln1431">            else</a>
<a name="ln1432">                ErrorDialog.Ok(&quot;ScreenToGif&quot;, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), exception.Message, exception);</a>
<a name="ln1433"> </a>
<a name="ln1434">            Capture.Dispose();</a>
<a name="ln1435">            Capture = null;</a>
<a name="ln1436">        };</a>
<a name="ln1437"> </a>
<a name="ln1438">        Capture.Start(GetCaptureInterval(), (int)CaptureRegion.X, (int)CaptureRegion.Y, (int)CaptureRegion.Width, (int)CaptureRegion.Height, _regionSelection.Scale, Project);</a>
<a name="ln1439">    }</a>
<a name="ln1440"> </a>
<a name="ln1441">    private async Task PickRegion(ModeType mode, bool quickSelection = false)</a>
<a name="ln1442">    {</a>
<a name="ln1443">        _regionSelection.Hide();</a>
<a name="ln1444">        Hide();</a>
<a name="ln1445"> </a>
<a name="ln1446">        var previousMode = UserSettings.All.RecorderModeIndex;</a>
<a name="ln1447"> </a>
<a name="ln1448">        var selection = await RegionSelectHelper.Select(mode, _viewModel.Region, _regionSelection.Monitor, quickSelection);</a>
<a name="ln1449"> </a>
<a name="ln1450">        ForceUpdate();</a>
<a name="ln1451"> </a>
<a name="ln1452">        if (selection.Region != Rect.Empty)</a>
<a name="ln1453">        {</a>
<a name="ln1454">            WidthIntegerBox.IgnoreValueChanged = true;</a>
<a name="ln1455">            HeightIntegerBox.IgnoreValueChanged = true;</a>
<a name="ln1456"> </a>
<a name="ln1457">            UserSettings.All.SelectedRegionScale = selection.Monitor.Scale;</a>
<a name="ln1458">            UserSettings.All.SelectedRegion = _viewModel.Region = selection.Region;</a>
<a name="ln1459"> </a>
<a name="ln1460">            WidthIntegerBox.IgnoreValueChanged = false;</a>
<a name="ln1461">            HeightIntegerBox.IgnoreValueChanged = false;</a>
<a name="ln1462"> </a>
<a name="ln1463">            DisplaySelection(mode, selection.Monitor);</a>
<a name="ln1464">            MoveCommandPanel();</a>
<a name="ln1465">        }</a>
<a name="ln1466">        else</a>
<a name="ln1467">        {</a>
<a name="ln1468">            UserSettings.All.RecorderModeIndex = previousMode;</a>
<a name="ln1469">            DisplaySelection();</a>
<a name="ln1470">        }</a>
<a name="ln1471"> </a>
<a name="ln1472">        Show();</a>
<a name="ln1473">    }</a>
<a name="ln1474"> </a>
<a name="ln1475">    private void DisplaySelection(ModeType? mode = null, Monitor display = null)</a>
<a name="ln1476">    {</a>
<a name="ln1477">        if (_viewModel.Region.IsEmpty)</a>
<a name="ln1478">        {</a>
<a name="ln1479">            if (_regionSelection.IsVisible)</a>
<a name="ln1480">                _regionSelection.Hide();</a>
<a name="ln1481">        }</a>
<a name="ln1482">        else</a>
<a name="ln1483">        {</a>
<a name="ln1484">            if (display != null)</a>
<a name="ln1485">                _viewModel.CurrentMonitor = display;</a>
<a name="ln1486"> </a>
<a name="ln1487">            _regionSelection.Select(mode, _viewModel.Region, display ?? _viewModel.CurrentMonitor);</a>
<a name="ln1488">        }</a>
<a name="ln1489"> </a>
<a name="ln1490">        DisplaySize();</a>
<a name="ln1491">        DetectMonitorChanges();</a>
<a name="ln1492">    }</a>
<a name="ln1493"> </a>
<a name="ln1494">    private void DisplaySize()</a>
<a name="ln1495">    {</a>
<a name="ln1496">        switch (UserSettings.All.RecorderModeIndex)</a>
<a name="ln1497">        {</a>
<a name="ln1498">            case (int)ModeType.Window:</a>
<a name="ln1499">            {</a>
<a name="ln1500">                SizeTextBlock.ToolTip = null;</a>
<a name="ln1501"> </a>
<a name="ln1502">                if (_viewModel.Region.IsEmpty)</a>
<a name="ln1503">                {</a>
<a name="ln1504">                    SizeTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Window.Select&quot;);</a>
<a name="ln1505"> </a>
<a name="ln1506">                    SizeGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln1507">                    SizeTextBlock.Visibility = Visibility.Visible;</a>
<a name="ln1508">                    return;</a>
<a name="ln1509">                }</a>
<a name="ln1510"> </a>
<a name="ln1511">                SizeGrid.Visibility = Visibility.Visible;</a>
<a name="ln1512">                SizeTextBlock.Visibility = Visibility.Collapsed;</a>
<a name="ln1513">                return;</a>
<a name="ln1514">            }</a>
<a name="ln1515">            case (int)ModeType.Fullscreen:</a>
<a name="ln1516">            {</a>
<a name="ln1517">                SizeGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln1518">                SizeTextBlock.Visibility = Visibility.Visible;</a>
<a name="ln1519"> </a>
<a name="ln1520">                if (_viewModel.CurrentMonitor == null)</a>
<a name="ln1521">                {</a>
<a name="ln1522">                    SizeTextBlock.ToolTip = null;</a>
<a name="ln1523">                    SizeTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Screen.Select&quot;);</a>
<a name="ln1524">                    return;</a>
<a name="ln1525">                }</a>
<a name="ln1526"> </a>
<a name="ln1527">                SizeTextBlock.Text = _viewModel.CurrentMonitor.FriendlyName;</a>
<a name="ln1528">                SizeTextBlock.ToolTip =</a>
<a name="ln1529">                    LocalizationHelper.GetWithFormat(&quot;S.Recorder.Screen.Name.Info1&quot;, &quot;Graphics adapter: {0}&quot;, _viewModel.CurrentMonitor.AdapterName) +</a>
<a name="ln1530">                    Environment.NewLine +</a>
<a name="ln1531">                    LocalizationHelper.GetWithFormat(&quot;S.Recorder.Screen.Name.Info2&quot;, &quot;Resolution: {0} x {1}&quot;, _viewModel.CurrentMonitor.Bounds.Width, _viewModel.CurrentMonitor.Bounds.Height) +</a>
<a name="ln1532">                    (Math.Abs(_viewModel.CurrentMonitor.Scale - 1) &gt; 0.001 ? Environment.NewLine + LocalizationHelper.GetWithFormat(&quot;S.Recorder.Screen.Name.Info3&quot;, &quot;Native resolution: {0} x {1}&quot;, _viewModel.CurrentMonitor.NativeBounds.Width, _viewModel.CurrentMonitor.NativeBounds.Height) : &quot;&quot;)  +</a>
<a name="ln1533">                    Environment.NewLine +</a>
<a name="ln1534">                    LocalizationHelper.GetWithFormat(&quot;S.Recorder.Screen.Name.Info4&quot;, &quot;DPI: {0} ({1:0.##}%)&quot;, _viewModel.CurrentMonitor.Dpi, _viewModel.CurrentMonitor.Scale * 100d);</a>
<a name="ln1535"> </a>
<a name="ln1536">                return;</a>
<a name="ln1537">            }</a>
<a name="ln1538">            default:</a>
<a name="ln1539">            {</a>
<a name="ln1540">                SizeTextBlock.ToolTip = null;</a>
<a name="ln1541"> </a>
<a name="ln1542">                if (_viewModel.Region.IsEmpty)</a>
<a name="ln1543">                {</a>
<a name="ln1544">                    SizeTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Area.Select&quot;);</a>
<a name="ln1545"> </a>
<a name="ln1546">                    SizeGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln1547">                    SizeTextBlock.Visibility = Visibility.Visible;</a>
<a name="ln1548">                    return;</a>
<a name="ln1549">                }</a>
<a name="ln1550"> </a>
<a name="ln1551">                SizeGrid.Visibility = Visibility.Visible;</a>
<a name="ln1552">                SizeTextBlock.Visibility = Visibility.Collapsed;</a>
<a name="ln1553">                return;</a>
<a name="ln1554">            }</a>
<a name="ln1555">        }</a>
<a name="ln1556">    }</a>
<a name="ln1557"> </a>
<a name="ln1558">    /// &lt;summary&gt;</a>
<a name="ln1559">    /// Repositions the capture controls near the selected region, in order to stay away from the capture. If no space available on the nearest screen, try others.</a>
<a name="ln1560">    /// &lt;param name=&quot;ignoreCenter&quot;&gt;If there's no space left, don't move the panel to the middle.&lt;/param&gt;</a>
<a name="ln1561">    /// &lt;/summary&gt;</a>
<a name="ln1562">    private void MoveCommandPanel(bool ignoreCenter = false)</a>
<a name="ln1563">    {</a>
<a name="ln1564">        if (_viewModel.Region.Width &lt; 25 || _viewModel.Region.Height &lt; 25)</a>
<a name="ln1565">            return;</a>
<a name="ln1566"> </a>
<a name="ln1567">        #region Calculate the available spaces for all four sides</a>
<a name="ln1568"> </a>
<a name="ln1569">        //If the selected region is passing the bottom edge of the display, it means that there are no space available on the bottom.</a>
<a name="ln1570">        //If the selected region is inside (bottom is below the top most part), it means that there are space available.</a>
<a name="ln1571">        //If none above, it means that the region is not located inside the screen.</a>
<a name="ln1572"> </a>
<a name="ln1573">        var bottomSpace = _viewModel.Region.Bottom &gt; _viewModel.CurrentMonitor.Bounds.Bottom ? 0 :</a>
<a name="ln1574">            _viewModel.Region.Bottom &gt; _viewModel.CurrentMonitor.Bounds.Top ? _viewModel.CurrentMonitor.Bounds.Bottom - _viewModel.Region.Bottom :</a>
<a name="ln1575">            _viewModel.CurrentMonitor.Bounds.Height;</a>
<a name="ln1576"> </a>
<a name="ln1577">        var topSpace = _viewModel.Region.Top &lt; _viewModel.CurrentMonitor.Bounds.Top ? 0 :</a>
<a name="ln1578">            _viewModel.Region.Top &lt; _viewModel.CurrentMonitor.Bounds.Bottom ? _viewModel.Region.Top - _viewModel.CurrentMonitor.Bounds.Top :</a>
<a name="ln1579">            _viewModel.CurrentMonitor.Bounds.Height;</a>
<a name="ln1580"> </a>
<a name="ln1581">        var leftSpace = _viewModel.Region.Left &lt; _viewModel.CurrentMonitor.Bounds.Left ? 0 :</a>
<a name="ln1582">            _viewModel.Region.Left &lt; _viewModel.CurrentMonitor.Bounds.Right ? _viewModel.Region.Left - _viewModel.CurrentMonitor.Bounds.Left :</a>
<a name="ln1583">            _viewModel.CurrentMonitor.Bounds.Width;</a>
<a name="ln1584"> </a>
<a name="ln1585">        var rightSpace = _viewModel.Region.Right &gt; _viewModel.CurrentMonitor.Bounds.Right ? 0 :</a>
<a name="ln1586">            _viewModel.Region.Right &gt; _viewModel.CurrentMonitor.Bounds.Left ? _viewModel.CurrentMonitor.Bounds.Right - _viewModel.Region.Right :</a>
<a name="ln1587">            _viewModel.CurrentMonitor.Bounds.Width;</a>
<a name="ln1588"> </a>
<a name="ln1589">        #endregion</a>
<a name="ln1590"> </a>
<a name="ln1591">        //Bottom.</a>
<a name="ln1592">        if (bottomSpace &gt; (ActualHeight + 20))</a>
<a name="ln1593">        {</a>
<a name="ln1594">            MovePanelTo(_viewModel.CurrentMonitor, (_viewModel.Region.Left + _viewModel.Region.Width / 2 - (ActualWidth / 2))</a>
<a name="ln1595">                .Clamp(_viewModel.CurrentMonitor.Bounds.Left, _viewModel.CurrentMonitor.Bounds.Right - ActualWidth), _viewModel.Region.Bottom + 10);</a>
<a name="ln1596">            return;</a>
<a name="ln1597">        }</a>
<a name="ln1598"> </a>
<a name="ln1599">        //Top.</a>
<a name="ln1600">        if (topSpace &gt; ActualHeight + 20)</a>
<a name="ln1601">        {</a>
<a name="ln1602">            MovePanelTo(_viewModel.CurrentMonitor, (_viewModel.Region.Left + _viewModel.Region.Width / 2 - ActualWidth / 2)</a>
<a name="ln1603">                .Clamp(_viewModel.CurrentMonitor.Bounds.Left, _viewModel.CurrentMonitor.Bounds.Right - ActualWidth), _viewModel.Region.Top - ActualHeight - 10);</a>
<a name="ln1604">            return;</a>
<a name="ln1605">        }</a>
<a name="ln1606"> </a>
<a name="ln1607">        //Left.</a>
<a name="ln1608">        if (leftSpace &gt; ActualWidth + 20)</a>
<a name="ln1609">        {</a>
<a name="ln1610">            MovePanelTo(_viewModel.CurrentMonitor, _viewModel.Region.Left - ActualWidth - 10, _viewModel.Region.Top + _viewModel.Region.Height / 2 - ActualHeight / 2);</a>
<a name="ln1611">            return;</a>
<a name="ln1612">        }</a>
<a name="ln1613"> </a>
<a name="ln1614">        //Right.</a>
<a name="ln1615">        if (rightSpace &gt; ActualWidth + 20)</a>
<a name="ln1616">        {</a>
<a name="ln1617">            MovePanelTo(_viewModel.CurrentMonitor, _viewModel.Region.Right + 10, _viewModel.Region.Top + _viewModel.Region.Height / 2 - ActualHeight / 2);</a>
<a name="ln1618">            return;</a>
<a name="ln1619">        }</a>
<a name="ln1620"> </a>
<a name="ln1621">        if (ignoreCenter)</a>
<a name="ln1622">        {</a>
<a name="ln1623">            //If no space left, move the control more to the left (if there's more space available to the left).</a>
<a name="ln1624">            //This is useful when the command panel is to the left of the recording, but there's no enough space.</a>
<a name="ln1625">            if (leftSpace &gt; rightSpace &amp;&amp; leftSpace &gt; (ActualWidth * 0.6))</a>
<a name="ln1626">                MovePanelTo(_viewModel.CurrentMonitor, _viewModel.Region.Left - ActualWidth - 10, _viewModel.Region.Top + _viewModel.Region.Height / 2 - ActualHeight / 2);</a>
<a name="ln1627"> </a>
<a name="ln1628">            return;</a>
<a name="ln1629">        }</a>
<a name="ln1630"> </a>
<a name="ln1631">        //No space available, simply center on the selected region.</a>
<a name="ln1632">        MovePanelTo(_viewModel.CurrentMonitor, _viewModel.Region.Left + _viewModel.Region.Width / 2 - ActualWidth / 2, _viewModel.Region.Top + _viewModel.Region.Height / 2 - ActualHeight / 2);</a>
<a name="ln1633">    }</a>
<a name="ln1634"> </a>
<a name="ln1635">    private void MovePanelTo(Monitor monitor, double left, double top)</a>
<a name="ln1636">    {</a>
<a name="ln1637">        if (_viewModel.CurrentControlMonitor?.Handle != monitor.Handle || _viewModel.CurrentControlMonitor?.Scale != monitor.Scale)</a>
<a name="ln1638">        {</a>
<a name="ln1639">            //First move the command window to the final monitor, so that the UI scale can be adjusted.</a>
<a name="ln1640">            this.MoveToScreen(monitor);</a>
<a name="ln1641"> </a>
<a name="ln1642">            _viewModel.CurrentControlMonitor = monitor;</a>
<a name="ln1643">        }</a>
<a name="ln1644"> </a>
<a name="ln1645">        //Move the command window to the final place.</a>
<a name="ln1646">        Left = left / (this.Scale() / monitor.Scale);</a>
<a name="ln1647">        Top = top / (this.Scale() / monitor.Scale);</a>
<a name="ln1648">    }</a>
<a name="ln1649"> </a>
<a name="ln1650">    /// &lt;summary&gt;</a>
<a name="ln1651">    /// Move the selection region to the closest screen when outside of any.</a>
<a name="ln1652">    /// &lt;/summary&gt;</a>
<a name="ln1653">    private void MoveToClosestScreen()</a>
<a name="ln1654">    {</a>
<a name="ln1655">        //If the position was never set.</a>
<a name="ln1656">        if (_viewModel.Region.IsEmpty)</a>
<a name="ln1657">            return;</a>
<a name="ln1658"> </a>
<a name="ln1659">        var top = _viewModel.Region.Top;</a>
<a name="ln1660">        var left = _viewModel.Region.Left;</a>
<a name="ln1661"> </a>
<a name="ln1662">        var screen = Screen.FromRectangle(new Rectangle((int)_viewModel.Region.Left, (int)_viewModel.Region.Top, (int)_viewModel.Region.Width, (int)_viewModel.Region.Height));</a>
<a name="ln1663">        var closest = _viewModel.Monitors.FirstOrDefault(f =&gt; f.Name == screen.DeviceName) ?? _viewModel.Monitors.FirstOrDefault();</a>
<a name="ln1664">        //var closest = monitors.FirstOrDefault(x =&gt; x.Bounds.Contains(new System.Windows.Point((int)left, (int)top))) ?? monitors.FirstOrDefault(x =&gt; x.IsPrimary) ?? monitors.FirstOrDefault();</a>
<a name="ln1665"> </a>
<a name="ln1666">        if (closest == null)</a>
<a name="ln1667">            throw new Exception(&quot;It was not possible to move the current selected region to the closest monitor.&quot;);</a>
<a name="ln1668"> </a>
<a name="ln1669">        //To much to the Left.</a>
<a name="ln1670">        if (closest.Bounds.Left &gt; _viewModel.Region.Left - 1)</a>
<a name="ln1671">            left = closest.Bounds.Left;</a>
<a name="ln1672"> </a>
<a name="ln1673">        //Too much to the top.</a>
<a name="ln1674">        if (closest.Bounds.Top &gt; _viewModel.Region.Top - 1)</a>
<a name="ln1675">            top = closest.Bounds.Top;</a>
<a name="ln1676"> </a>
<a name="ln1677">        //Too much to the right.</a>
<a name="ln1678">        if (closest.Bounds.Right &lt; _viewModel.Region.Left + _viewModel.Region.Width)</a>
<a name="ln1679">            left = closest.Bounds.Right - _viewModel.Region.Width;</a>
<a name="ln1680"> </a>
<a name="ln1681">        //Too much to the bottom.</a>
<a name="ln1682">        if (closest.Bounds.Bottom &lt; _viewModel.Region.Top + _viewModel.Region.Height)</a>
<a name="ln1683">            top = closest.Bounds.Bottom - _viewModel.Region.Height;</a>
<a name="ln1684"> </a>
<a name="ln1685">        UserSettings.All.SelectedRegionScale = closest.Scale;</a>
<a name="ln1686">        _viewModel.CurrentMonitor = closest;</a>
<a name="ln1687">        _viewModel.Region = UserSettings.All.SelectedRegion = new Rect(left, top, _viewModel.Region.Width, _viewModel.Region.Height);</a>
<a name="ln1688">    }</a>
<a name="ln1689"> </a>
<a name="ln1690">    /// &lt;summary&gt;</a>
<a name="ln1691">    /// True if the capture controls are intersecting with the capture region.</a>
<a name="ln1692">    /// &lt;/summary&gt;</a>
<a name="ln1693">    /// &lt;returns&gt;&lt;/returns&gt;</a>
<a name="ln1694">    private bool IsRegionIntersected()</a>
<a name="ln1695">    {</a>
<a name="ln1696">        return IsVisible &amp;&amp; CaptureRegion.IntersectsWith(new Rect(Left, Top, Width, Height).Scale(_regionSelection.Scale));</a>
<a name="ln1697">    }</a>
<a name="ln1698"> </a>
<a name="ln1699">    private void Follow()</a>
<a name="ln1700">    {</a>
<a name="ln1701">        if (IsFollowing &amp;&amp; UserSettings.All.FollowShortcut != Key.None)</a>
<a name="ln1702">        {</a>
<a name="ln1703">            _followTimer.Interval = (1000 / UserSettings.All.LatestFps) / 2;</a>
<a name="ln1704">            _followTimer.Start();</a>
<a name="ln1705">            return;</a>
<a name="ln1706">        }</a>
<a name="ln1707"> </a>
<a name="ln1708">        _followTimer.Stop();</a>
<a name="ln1709">    }</a>
<a name="ln1710"> </a>
<a name="ln1711">    private void SwitchFrequency(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1712">    {</a>
<a name="ln1713">        //When this event is fired from clicking on the switch button.</a>
<a name="ln1714">        if (e.Parameter?.Equals(&quot;Switch&quot;) == true)</a>
<a name="ln1715">        {</a>
<a name="ln1716">            switch (UserSettings.All.CaptureFrequency)</a>
<a name="ln1717">            {</a>
<a name="ln1718">                case CaptureFrequencies.Manual:</a>
<a name="ln1719">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.Interaction;</a>
<a name="ln1720">                    break;</a>
<a name="ln1721"> </a>
<a name="ln1722">                case CaptureFrequencies.Interaction:</a>
<a name="ln1723">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerSecond;</a>
<a name="ln1724">                    break;</a>
<a name="ln1725"> </a>
<a name="ln1726">                case CaptureFrequencies.PerSecond:</a>
<a name="ln1727">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerMinute;</a>
<a name="ln1728">                    break;</a>
<a name="ln1729"> </a>
<a name="ln1730">                case CaptureFrequencies.PerMinute:</a>
<a name="ln1731">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerHour;</a>
<a name="ln1732">                    break;</a>
<a name="ln1733"> </a>
<a name="ln1734">                default: //PerHour.</a>
<a name="ln1735">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.Manual;</a>
<a name="ln1736">                    break;</a>
<a name="ln1737">            }</a>
<a name="ln1738">        }</a>
<a name="ln1739"> </a>
<a name="ln1740">        //When event is fired when the frequency is picked from the context menu, just switch the labels.</a>
<a name="ln1741">        DetectCaptureFrequency();</a>
<a name="ln1742">    }</a>
<a name="ln1743"> </a>
<a name="ln1744">    private void DetectCaptureFrequency()</a>
<a name="ln1745">    {</a>
<a name="ln1746">        switch (UserSettings.All.CaptureFrequency)</a>
<a name="ln1747">        {</a>
<a name="ln1748">            case CaptureFrequencies.Manual:</a>
<a name="ln1749">                FrequencyTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Manual.Short&quot;);</a>
<a name="ln1750">                FrequencyIntegerUpDown.Visibility = Visibility.Collapsed;</a>
<a name="ln1751">                FrequencyViewbox.Visibility = Visibility.Collapsed;</a>
<a name="ln1752">                AdjustToManual();</a>
<a name="ln1753">                break;</a>
<a name="ln1754">            case CaptureFrequencies.Interaction:</a>
<a name="ln1755">                FrequencyTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Interaction.Short&quot;);</a>
<a name="ln1756">                FrequencyIntegerUpDown.Visibility = Visibility.Collapsed;</a>
<a name="ln1757">                FrequencyViewbox.Visibility = Visibility.Collapsed;</a>
<a name="ln1758">                AdjustToInteraction();</a>
<a name="ln1759">                break;</a>
<a name="ln1760">            case CaptureFrequencies.PerSecond:</a>
<a name="ln1761">                FrequencyTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Fps.Short&quot;);</a>
<a name="ln1762">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fps&quot;);</a>
<a name="ln1763">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fps.Range&quot;);</a>
<a name="ln1764">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1765">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1766">                AdjustToAutomatic();</a>
<a name="ln1767">                break;</a>
<a name="ln1768"> </a>
<a name="ln1769">            case CaptureFrequencies.PerMinute:</a>
<a name="ln1770">                FrequencyTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Fpm.Short&quot;);</a>
<a name="ln1771">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fpm&quot;);</a>
<a name="ln1772">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fpm.Range&quot;);</a>
<a name="ln1773">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1774">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1775">                AdjustToAutomatic();</a>
<a name="ln1776">                break;</a>
<a name="ln1777"> </a>
<a name="ln1778">            default: //PerHour.</a>
<a name="ln1779">                FrequencyTextBlock.SetResourceReference(TextBlock.TextProperty, &quot;S.Recorder.Fph.Short&quot;);</a>
<a name="ln1780">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fph&quot;);</a>
<a name="ln1781">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fph.Range&quot;);</a>
<a name="ln1782">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1783">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1784">                AdjustToAutomatic();</a>
<a name="ln1785">                break;</a>
<a name="ln1786">        }</a>
<a name="ln1787"> </a>
<a name="ln1788">        CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1789">    }</a>
<a name="ln1790"> </a>
<a name="ln1791">    private void AdjustToManual()</a>
<a name="ln1792">    {</a>
<a name="ln1793">        Stage = RecorderStages.Recording;</a>
<a name="ln1794">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1795">        FrameRate.Start(HasFixedDelay(), GetFixedDelay());</a>
<a name="ln1796"> </a>
<a name="ln1797">        _regionSelection.DisplayGuidelines();</a>
<a name="ln1798">    }</a>
<a name="ln1799"> </a>
<a name="ln1800">    private void AdjustToInteraction()</a>
<a name="ln1801">    {</a>
<a name="ln1802">        Stage = Project?.Frames?.Count &gt; 0 ? RecorderStages.Paused : RecorderStages.Stopped;</a>
<a name="ln1803">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1804">        FrameRate.Start(HasFixedDelay(), GetFixedDelay());</a>
<a name="ln1805"> </a>
<a name="ln1806">        _regionSelection.DisplayGuidelines();</a>
<a name="ln1807">    }</a>
<a name="ln1808"> </a>
<a name="ln1809">    private void AdjustToAutomatic()</a>
<a name="ln1810">    {</a>
<a name="ln1811">        Stage = Project?.Frames?.Count &gt; 0 ? RecorderStages.Paused : RecorderStages.Stopped;</a>
<a name="ln1812">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1813">        FrameRate.Stop();</a>
<a name="ln1814"> </a>
<a name="ln1815">        _regionSelection.DisplayGuidelines();</a>
<a name="ln1816">    }</a>
<a name="ln1817"> </a>
<a name="ln1818">    internal override void StartCapture()</a>
<a name="ln1819">    {</a>
<a name="ln1820">        DisplayTimer.Start();</a>
<a name="ln1821"> </a>
<a name="ln1822">        base.StartCapture();</a>
<a name="ln1823">    }</a>
<a name="ln1824"> </a>
<a name="ln1825">    internal override void PauseCapture()</a>
<a name="ln1826">    {</a>
<a name="ln1827">        DisplayTimer.Pause();</a>
<a name="ln1828"> </a>
<a name="ln1829">        base.PauseCapture();</a>
<a name="ln1830">    }</a>
<a name="ln1831"> </a>
<a name="ln1832">    internal override async Task StopCapture()</a>
<a name="ln1833">    {</a>
<a name="ln1834">        DisplayTimer.Stop();</a>
<a name="ln1835"> </a>
<a name="ln1836">        await base.StopCapture();</a>
<a name="ln1837">    }</a>
<a name="ln1838"> </a>
<a name="ln1839">    private async void DetectMonitorChanges(bool detectCurrent = false)</a>
<a name="ln1840">    {</a>
<a name="ln1841">        if (detectCurrent)</a>
<a name="ln1842">        {</a>
<a name="ln1843">            var interop = new System.Windows.Interop.WindowInteropHelper(_regionSelection);</a>
<a name="ln1844">            var current = Screen.FromHandle(interop.Handle);</a>
<a name="ln1845"> </a>
<a name="ln1846">            _viewModel.CurrentMonitor = _viewModel.Monitors.FirstOrDefault(f =&gt; f.Name == current.DeviceName);</a>
<a name="ln1847">            //_viewModel.CurrentMonitor = Monitor.MostIntersected(_viewModel.Monitors, _viewModel.Region.Scale(_viewModel.CurrentMonitor.Scale)) ?? _viewModel.CurrentMonitor;</a>
<a name="ln1848">        }</a>
<a name="ln1849"> </a>
<a name="ln1850">        if (_viewModel.CurrentMonitor != null &amp;&amp; _viewModel.CurrentMonitor.Handle != _viewModel.PreviousMonitor?.Handle)</a>
<a name="ln1851">        {</a>
<a name="ln1852">            if (_viewModel.PreviousMonitor != null &amp;&amp; Stage == RecorderStages.Recording &amp;&amp; Project?.Any == true)</a>
<a name="ln1853">            {</a>
<a name="ln1854">                Pause();</a>
<a name="ln1855"> </a>
<a name="ln1856">                Capture.DeviceName = _viewModel.CurrentMonitor.Name;</a>
<a name="ln1857">                Capture?.ResetConfiguration();</a>
<a name="ln1858"> </a>
<a name="ln1859">                await Record();</a>
<a name="ln1860">            }</a>
<a name="ln1861"> </a>
<a name="ln1862">            _viewModel.PreviousMonitor = _viewModel.CurrentMonitor;</a>
<a name="ln1863">        }</a>
<a name="ln1864">    }</a>
<a name="ln1865"> </a>
<a name="ln1866">    private void MoveWindow(int left, int top, int right, int bottom)</a>
<a name="ln1867">    {</a>
<a name="ln1868">        //Limit to this screen in directX capture mode.</a>
<a name="ln1869">        var x = left &gt; 0 ? Math.Max(_viewModel.Region.Left - left, _viewModel.MaximumBounds.Left - 1) : right &gt; 0 ? Math.Min(_viewModel.Region.Left + right, _viewModel.MaximumBounds.Right - _viewModel.Region.Width + 1) : _viewModel.Region.Left;</a>
<a name="ln1870">        var y = top &gt; 0 ? Math.Max(_viewModel.Region.Top - top, _viewModel.MaximumBounds.Top - 1) : bottom &gt; 0 ? Math.Min(_viewModel.Region.Top + bottom, _viewModel.MaximumBounds.Bottom - _viewModel.Region.Height + 1) : _viewModel.Region.Top;</a>
<a name="ln1871"> </a>
<a name="ln1872">        _viewModel.Region = new Rect(x, y, _viewModel.RegionWidth, _viewModel.RegionHeight);</a>
<a name="ln1873"> </a>
<a name="ln1874">        DetectMonitorChanges();</a>
<a name="ln1875">        DisplaySelection();</a>
<a name="ln1876">        MoveCommandPanel();</a>
<a name="ln1877">    }</a>
<a name="ln1878"> </a>
<a name="ln1879">    private void ResizeWindow(int left, int top, int right, int bottom)</a>
<a name="ln1880">    {</a>
<a name="ln1881">        //Resize to top left increases height/width when reaching the limit.</a>
<a name="ln1882"> </a>
<a name="ln1883">        var newLeft = left &lt; 0 ? Math.Max(_viewModel.Region.Left + left, _viewModel.MaximumBounds.Left - 1) : left &gt; 0 ? _viewModel.Region.Left + left : _viewModel.Region.Left;</a>
<a name="ln1884">        var newTop = top &lt; 0 ? Math.Max(_viewModel.Region.Top + top, _viewModel.MaximumBounds.Top - 1) : top &gt; 0 ? _viewModel.Region.Top + top : _viewModel.Region.Top;</a>
<a name="ln1885">        var width = (right &gt; 0 ? Math.Min(_viewModel.Region.Width + right, _viewModel.MaximumBounds.Right - _viewModel.Region.Left + 1) - left : right &lt; 0 ? _viewModel.Region.Width + right + (left &gt; 0 ? -left : 0) : _viewModel.Region.Width - left);</a>
<a name="ln1886">        var height = (bottom &gt; 0 ? Math.Min(_viewModel.Region.Height + bottom, _viewModel.MaximumBounds.Bottom - _viewModel.Region.Top + 1) - top : bottom &lt; 0 ? _viewModel.Region.Height + bottom + (top &gt; 0 ? -top : 0) : _viewModel.Region.Height - top);</a>
<a name="ln1887"> </a>
<a name="ln1888">        //Ignore input if the new size will be smaller than the minimum.</a>
<a name="ln1889">        if ((height &lt; 25 &amp;&amp; (top &gt; 0 || bottom &lt; 0)) || (width &lt; 25 &amp;&amp; (left &gt; 0 || right &lt; 0)))</a>
<a name="ln1890">            return;</a>
<a name="ln1891"> </a>
<a name="ln1892">        _viewModel.Region = new Rect(newLeft, newTop, width, height);</a>
<a name="ln1893"> </a>
<a name="ln1894">        DetectMonitorChanges();</a>
<a name="ln1895">        DisplaySelection();</a>
<a name="ln1896">        MoveCommandPanel();</a>
<a name="ln1897">    }</a>
<a name="ln1898"> </a>
<a name="ln1899">    private void SetTaskbarButtonOverlay()</a>
<a name="ln1900">    {</a>
<a name="ln1901">        try</a>
<a name="ln1902">        {</a>
<a name="ln1903">            switch (Stage)</a>
<a name="ln1904">            {</a>
<a name="ln1905">                case RecorderStages.Stopped:</a>
<a name="ln1906">                    TaskbarItemInfo.Overlay = null;</a>
<a name="ln1907">                    return;</a>
<a name="ln1908">                case RecorderStages.Recording:</a>
<a name="ln1909">                    if (UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual)</a>
<a name="ln1910">                        TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Record&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1911">                    else</a>
<a name="ln1912">                        TaskbarItemInfo.Overlay = null;</a>
<a name="ln1913">                    return;</a>
<a name="ln1914">                case RecorderStages.Paused:</a>
<a name="ln1915">                    TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Pause&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1916">                    return;</a>
<a name="ln1917">                case RecorderStages.Discarding:</a>
<a name="ln1918">                    TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Remove&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1919">                    return;</a>
<a name="ln1920">            }</a>
<a name="ln1921">        }</a>
<a name="ln1922">        catch (Exception e)</a>
<a name="ln1923">        {</a>
<a name="ln1924">            LogWriter.Log(e, &quot;Impossible to set the taskbar button overlay&quot;);</a>
<a name="ln1925">        }</a>
<a name="ln1926">    }</a>
<a name="ln1927"> </a>
<a name="ln1928">    private void AdjustForWidthChange()</a>
<a name="ln1929">    {</a>
<a name="ln1930">        MoveCommandPanel(true);</a>
<a name="ln1931">        Show();</a>
<a name="ln1932">    }</a>
<a name="ln1933"> </a>
<a name="ln1934">    #endregion</a>
<a name="ln1935">}</a>
</code></pre>
<div class="balloon" rel="731"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3023/" target="_blank">V3023</a> Consider inspecting this expression. The expression is excessive or contains a misprint.</p></div>
<div class="balloon" rel="1856"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The 'Capture' object was used before it was verified against null. Check lines: 1856, 1857.</p></div>
<div class="balloon" rel="1903"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3002/" target="_blank">V3002</a> The switch statement does not cover all values of the 'RecorderStages' enum: PreStarting, Snapping.</p></div>
<div class="balloon" rel="1637"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3024/" target="_blank">V3024</a> An odd precise comparison. Consider using a comparison with defined precision: Math.Abs(A - B) &gt; Epsilon.</p></div>
<div class="balloon" rel="674"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3130/" target="_blank">V3130</a> Priority of the '&amp;&amp;' operator is higher than that of the '||' operator. Possible missing parentheses.</p></div>
<div class="balloon" rel="505"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<div class="balloon" rel="1348"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>