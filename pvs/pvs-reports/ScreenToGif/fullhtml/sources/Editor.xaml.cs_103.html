<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Editor.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Collections.Generic;</a>
<a name="ln3">using System.Collections.ObjectModel;</a>
<a name="ln4">using System.ComponentModel;</a>
<a name="ln5">using System.Diagnostics;</a>
<a name="ln6">using System.Globalization;</a>
<a name="ln7">using System.IO;</a>
<a name="ln8">using System.IO.Compression;</a>
<a name="ln9">using System.Linq;</a>
<a name="ln10">using System.Runtime.Serialization.Json;</a>
<a name="ln11">using System.Text;</a>
<a name="ln12">using System.Threading;</a>
<a name="ln13">using System.Threading.Tasks;</a>
<a name="ln14">using System.Windows;</a>
<a name="ln15">using System.Windows.Controls;</a>
<a name="ln16">using System.Windows.Documents;</a>
<a name="ln17">using System.Windows.Input;</a>
<a name="ln18">using System.Windows.Media;</a>
<a name="ln19">using System.Windows.Media.Animation;</a>
<a name="ln20">using System.Windows.Media.Imaging;</a>
<a name="ln21">using System.Windows.Shell;</a>
<a name="ln22">using System.Windows.Threading;</a>
<a name="ln23">using Microsoft.Win32;</a>
<a name="ln24">using ScreenToGif.Controls;</a>
<a name="ln25">using ScreenToGif.ImageUtil;</a>
<a name="ln26">using ScreenToGif.Model;</a>
<a name="ln27">using ScreenToGif.Util;</a>
<a name="ln28">using ScreenToGif.Windows.Other;</a>
<a name="ln29">using ButtonBase = System.Windows.Controls.Primitives.ButtonBase;</a>
<a name="ln30">using Color = System.Windows.Media.Color;</a>
<a name="ln31">using Cursors = System.Windows.Input.Cursors;</a>
<a name="ln32">using DataFormats = System.Windows.DataFormats;</a>
<a name="ln33">using DragDropEffects = System.Windows.DragDropEffects;</a>
<a name="ln34">using DragEventArgs = System.Windows.DragEventArgs;</a>
<a name="ln35">using Encoder = ScreenToGif.Windows.Other.Encoder;</a>
<a name="ln36">using KeyEventArgs = System.Windows.Input.KeyEventArgs;</a>
<a name="ln37">using ListViewItem = System.Windows.Controls.ListViewItem;</a>
<a name="ln38">using OpenFileDialog = Microsoft.Win32.OpenFileDialog;</a>
<a name="ln39">using Size = System.Windows.Size;</a>
<a name="ln40">using System.Windows.Data;</a>
<a name="ln41">using System.Windows.Media.Effects;</a>
<a name="ln42">using ScreenToGif.Domain.Enums;</a>
<a name="ln43">using ScreenToGif.Domain.Interfaces;</a>
<a name="ln44">using ScreenToGif.UserControls;</a>
<a name="ln45">using ScreenToGif.ViewModel;</a>
<a name="ln46">using ScreenToGif.ViewModel.Tasks;</a>
<a name="ln47">using VideoSource = ScreenToGif.Windows.Other.VideoSource;</a>
<a name="ln48">using ScreenToGif.Native.Helpers;</a>
<a name="ln49">using ScreenToGif.Util.Codification.Apng;</a>
<a name="ln50">using ScreenToGif.Util.Codification.Gif.Decoder;</a>
<a name="ln51">using ScreenToGif.Util.Extensions;</a>
<a name="ln52">using ScreenToGif.Util.Settings;</a>
<a name="ln53">using ScreenToGif.ViewModel.ExportPresets;</a>
<a name="ln54">using ScreenToGif.ViewModel.ExportPresets.Image;</a>
<a name="ln55">using ScreenToGif.ViewModel.ExportPresets.Other;</a>
<a name="ln56">using System.Collections.Immutable;</a>
<a name="ln57"> </a>
<a name="ln58">namespace ScreenToGif.Windows</a>
<a name="ln59">{</a>
<a name="ln60">    public partial class Editor : INotification, IEncoding</a>
<a name="ln61">    {</a>
<a name="ln62">        #region Properties</a>
<a name="ln63"> </a>
<a name="ln64">        public static readonly DependencyProperty FilledListProperty = DependencyProperty.Register(nameof(FilledList), typeof(bool), typeof(Editor), new FrameworkPropertyMetadata(false));</a>
<a name="ln65">        public static readonly DependencyProperty NotPreviewingProperty = DependencyProperty.Register(nameof(NotPreviewing), typeof(bool), typeof(Editor), new FrameworkPropertyMetadata(true));</a>
<a name="ln66">        public static readonly DependencyProperty IsLoadingProperty = DependencyProperty.Register(nameof(IsLoading), typeof(bool), typeof(Editor), new FrameworkPropertyMetadata(false));</a>
<a name="ln67">        public static readonly DependencyProperty TotalDurationProperty = DependencyProperty.Register(nameof(TotalDuration), typeof(TimeSpan), typeof(Editor));</a>
<a name="ln68">        public static readonly DependencyProperty CurrentTimeProperty = DependencyProperty.Register(nameof(CurrentTime), typeof(TimeSpan), typeof(Editor));</a>
<a name="ln69">        public static readonly DependencyProperty FrameSizeProperty = DependencyProperty.Register(nameof(FrameSize), typeof(Size), typeof(Editor));</a>
<a name="ln70">        public static readonly DependencyProperty FrameScaleProperty = DependencyProperty.Register(nameof(FrameScale), typeof(int), typeof(Editor));</a>
<a name="ln71">        public static readonly DependencyProperty AverageDelayProperty = DependencyProperty.Register(nameof(AverageDelay), typeof(double), typeof(Editor));</a>
<a name="ln72">        public static readonly DependencyProperty FrameDpiProperty = DependencyProperty.Register(nameof(FrameDpi), typeof(double), typeof(Editor));</a>
<a name="ln73">        public static readonly DependencyProperty IsCancelableProperty = DependencyProperty.Register(nameof(IsCancelable), typeof(bool), typeof(Editor), new FrameworkPropertyMetadata(false));</a>
<a name="ln74">        public static readonly DependencyProperty HasImprecisePlaybackProperty = DependencyProperty.Register(nameof(HasImprecisePlayback), typeof(bool), typeof(Editor), new FrameworkPropertyMetadata(false));</a>
<a name="ln75"> </a>
<a name="ln76">        /// &lt;summary&gt;</a>
<a name="ln77">        /// True if there is a value inside the list of frames.</a>
<a name="ln78">        /// &lt;/summary&gt;</a>
<a name="ln79">        public bool FilledList</a>
<a name="ln80">        {</a>
<a name="ln81">            get =&gt; (bool)GetValue(FilledListProperty);</a>
<a name="ln82">            set =&gt; SetValue(FilledListProperty, value);</a>
<a name="ln83">        }</a>
<a name="ln84"> </a>
<a name="ln85">        /// &lt;summary&gt;</a>
<a name="ln86">        /// True if not in preview mode.</a>
<a name="ln87">        /// &lt;/summary&gt;</a>
<a name="ln88">        public bool NotPreviewing</a>
<a name="ln89">        {</a>
<a name="ln90">            get =&gt; (bool)GetValue(NotPreviewingProperty);</a>
<a name="ln91">            set =&gt; SetValue(NotPreviewingProperty, value);</a>
<a name="ln92">        }</a>
<a name="ln93"> </a>
<a name="ln94">        /// &lt;summary&gt;</a>
<a name="ln95">        /// True if loading frames.</a>
<a name="ln96">        /// &lt;/summary&gt;</a>
<a name="ln97">        public bool IsLoading</a>
<a name="ln98">        {</a>
<a name="ln99">            get =&gt; (bool)GetValue(IsLoadingProperty);</a>
<a name="ln100">            set =&gt; SetValue(IsLoadingProperty, value);</a>
<a name="ln101">        }</a>
<a name="ln102"> </a>
<a name="ln103">        /// &lt;summary&gt;</a>
<a name="ln104">        /// The total duration of the animation. Used by the statistics tab.</a>
<a name="ln105">        /// &lt;/summary&gt;</a>
<a name="ln106">        private TimeSpan TotalDuration</a>
<a name="ln107">        {</a>
<a name="ln108">            get =&gt; (TimeSpan)GetValue(TotalDurationProperty);</a>
<a name="ln109">            set =&gt; SetValue(TotalDurationProperty, value);</a>
<a name="ln110">        }</a>
<a name="ln111"> </a>
<a name="ln112">        /// &lt;summary&gt;</a>
<a name="ln113">        /// The cumulative duration of the animation. Used by the statistics tab.</a>
<a name="ln114">        /// &lt;/summary&gt;</a>
<a name="ln115">        private TimeSpan CurrentTime</a>
<a name="ln116">        {</a>
<a name="ln117">            get =&gt; (TimeSpan)GetValue(CurrentTimeProperty);</a>
<a name="ln118">            set =&gt; SetValue(CurrentTimeProperty, value);</a>
<a name="ln119">        }</a>
<a name="ln120"> </a>
<a name="ln121">        /// &lt;summary&gt;</a>
<a name="ln122">        /// The size of the frames. Used by the statistics tab.</a>
<a name="ln123">        /// &lt;/summary&gt;</a>
<a name="ln124">        private Size FrameSize</a>
<a name="ln125">        {</a>
<a name="ln126">            get =&gt; (Size)GetValue(FrameSizeProperty);</a>
<a name="ln127">            set =&gt; SetValue(FrameSizeProperty, value);</a>
<a name="ln128">        }</a>
<a name="ln129"> </a>
<a name="ln130">        /// &lt;summary&gt;</a>
<a name="ln131">        /// The scale of the frames in %. Used by the statistics tab.</a>
<a name="ln132">        /// &lt;/summary&gt;</a>
<a name="ln133">        private int FrameScale</a>
<a name="ln134">        {</a>
<a name="ln135">            get =&gt; (int)GetValue(FrameScaleProperty);</a>
<a name="ln136">            set =&gt; SetValue(FrameScaleProperty, value);</a>
<a name="ln137">        }</a>
<a name="ln138"> </a>
<a name="ln139">        /// &lt;summary&gt;</a>
<a name="ln140">        /// The average delay of the animation. Used by the statistics tab.</a>
<a name="ln141">        /// &lt;/summary&gt;</a>
<a name="ln142">        private double AverageDelay</a>
<a name="ln143">        {</a>
<a name="ln144">            get =&gt; (double)GetValue(AverageDelayProperty);</a>
<a name="ln145">            set =&gt; SetValue(AverageDelayProperty, value);</a>
<a name="ln146">        }</a>
<a name="ln147"> </a>
<a name="ln148">        /// &lt;summary&gt;</a>
<a name="ln149">        /// The DPI of the frames. Used by the statistics tab.</a>
<a name="ln150">        /// &lt;/summary&gt;</a>
<a name="ln151">        private double FrameDpi</a>
<a name="ln152">        {</a>
<a name="ln153">            get =&gt; (double)GetValue(FrameDpiProperty);</a>
<a name="ln154">            set =&gt; SetValue(FrameDpiProperty, value);</a>
<a name="ln155">        }</a>
<a name="ln156"> </a>
<a name="ln157">        /// &lt;summary&gt;</a>
<a name="ln158">        /// True if the current recording being loaded can be cancelled.</a>
<a name="ln159">        /// &lt;/summary&gt;</a>
<a name="ln160">        public bool IsCancelable</a>
<a name="ln161">        {</a>
<a name="ln162">            get =&gt; (bool)GetValue(IsCancelableProperty);</a>
<a name="ln163">            set =&gt; SetValue(IsCancelableProperty, value);</a>
<a name="ln164">        }</a>
<a name="ln165"> </a>
<a name="ln166">        /// &lt;summary&gt;</a>
<a name="ln167">        /// True if the system can't playback the animation at the correct speed.</a>
<a name="ln168">        /// &lt;/summary&gt;</a>
<a name="ln169">        public bool HasImprecisePlayback</a>
<a name="ln170">        {</a>
<a name="ln171">            get =&gt; (bool)GetValue(HasImprecisePlaybackProperty);</a>
<a name="ln172">            set =&gt; SetValue(HasImprecisePlaybackProperty, value);</a>
<a name="ln173">        }</a>
<a name="ln174"> </a>
<a name="ln175">        #endregion</a>
<a name="ln176"> </a>
<a name="ln177">        #region Variables</a>
<a name="ln178"> </a>
<a name="ln179">        /// &lt;summary&gt;</a>
<a name="ln180">        /// The current project.</a>
<a name="ln181">        /// &lt;/summary&gt;</a>
<a name="ln182">        public ProjectInfo Project { get; set; }</a>
<a name="ln183"> </a>
<a name="ln184">        /// &lt;summary&gt;</a>
<a name="ln185">        /// Last selected frame index. Used to track users last selection and decide which frame to show.</a>
<a name="ln186">        /// &lt;/summary&gt;</a>
<a name="ln187">        private int LastSelected { get; set; } = -1;</a>
<a name="ln188"> </a>
<a name="ln189">        /// &lt;summary&gt;</a>
<a name="ln190">        /// True if the user was selecting frames using the FirstFrame/Previous/Next/LastFrame commands or the scroll wheel.</a>
<a name="ln191">        /// &lt;/summary&gt;</a>
<a name="ln192">        private bool WasChangingSelection { get; set; }</a>
<a name="ln193"> </a>
<a name="ln194">        /// &lt;summary&gt;</a>
<a name="ln195">        /// True if the user was previewing the recording.</a>
<a name="ln196">        /// &lt;/summary&gt;</a>
<a name="ln197">        private bool WasPreviewing { get; set; }</a>
<a name="ln198"> </a>
<a name="ln199">        /// &lt;summary&gt;</a>
<a name="ln200">        /// True if the PC is sleeping.</a>
<a name="ln201">        /// &lt;/summary&gt;</a>
<a name="ln202">        private bool Slept { get; set; }</a>
<a name="ln203"> </a>
<a name="ln204">        /// &lt;summary&gt;</a>
<a name="ln205">        /// True if this is the encoder window.</a>
<a name="ln206">        /// &lt;/summary&gt;</a>
<a name="ln207">        public bool IsEncoderWindow { get; } = false;</a>
<a name="ln208"> </a>
<a name="ln209">        private readonly EditorViewModel _viewModel;</a>
<a name="ln210"> </a>
<a name="ln211">        private CancellationTokenSource _previewToken;</a>
<a name="ln212"> </a>
<a name="ln213">        private Action&lt;object, RoutedEventArgs&gt; _applyAction = null;</a>
<a name="ln214"> </a>
<a name="ln215">        private bool _abortLoading;</a>
<a name="ln216"> </a>
<a name="ln217">        /// &lt;summary&gt;</a>
<a name="ln218">        /// Lock used to prevent firing multiple times (at the same time) both the Activated/Deactivated events.</a>
<a name="ln219">        /// &lt;/summary&gt;</a>
<a name="ln220">        public static readonly object ActivateLock = new object();</a>
<a name="ln221"> </a>
<a name="ln222">        #endregion</a>
<a name="ln223"> </a>
<a name="ln224">        public Editor()</a>
<a name="ln225">        {</a>
<a name="ln226">            InitializeComponent();</a>
<a name="ln227"> </a>
<a name="ln228">            DataContext = _viewModel = new EditorViewModel();</a>
<a name="ln229">        }</a>
<a name="ln230"> </a>
<a name="ln231">        #region Main Events</a>
<a name="ln232"> </a>
<a name="ln233">        private async void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln234">        {</a>
<a name="ln235">            SystemEvents.PowerModeChanged += System_PowerModeChanged;</a>
<a name="ln236">            SystemEvents.DisplaySettingsChanged += System_DisplaySettingsChanged;</a>
<a name="ln237">            SystemParameters.StaticPropertyChanged += SystemParameters_StaticPropertyChanged;</a>
<a name="ln238"> </a>
<a name="ln239">            #region Adjust the position</a>
<a name="ln240"> </a>
<a name="ln241">            //Tries to adjust the position/size of the window, centers on screen otherwise.</a>
<a name="ln242">            if (!UpdatePositioning())</a>
<a name="ln243">                WindowStartupLocation = WindowStartupLocation.CenterScreen;</a>
<a name="ln244"> </a>
<a name="ln245">            #endregion</a>
<a name="ln246"> </a>
<a name="ln247">            ScrollSynchronizer.SetScrollGroup(ZoomBoxControl.GetScrollViewer(), &quot;Canvas&quot;);</a>
<a name="ln248">            ScrollSynchronizer.SetScrollGroup(MainScrollViewer, &quot;Canvas&quot;);</a>
<a name="ln249">            ScrollSynchronizer.SetScrollGroup(BehindScrollViewer, &quot;Canvas&quot;);</a>
<a name="ln250"> </a>
<a name="ln251">            DisplayUpdatePromoter();</a>
<a name="ln252"> </a>
<a name="ln253">            #region Load</a>
<a name="ln254"> </a>
<a name="ln255">            if (Project != null)</a>
<a name="ln256">            {</a>
<a name="ln257">                ShowProgress(LocalizationHelper.Get(&quot;S.Editor.Preparing&quot;), Project.Frames.Count, true);</a>
<a name="ln258"> </a>
<a name="ln259">                Cursor = Cursors.AppStarting;</a>
<a name="ln260">                IsLoading = true;</a>
<a name="ln261">                IsCancelable = true;</a>
<a name="ln262"> </a>
<a name="ln263">                ActionStack.Project = Project;</a>
<a name="ln264"> </a>
<a name="ln265">                var result = await Task.Run(Load);</a>
<a name="ln266">                LoadCallback(result);</a>
<a name="ln267"> </a>
<a name="ln268">                return;</a>
<a name="ln269">            }</a>
<a name="ln270"> </a>
<a name="ln271">            #endregion</a>
<a name="ln272"> </a>
<a name="ln273">            //Open with...</a>
<a name="ln274">            LoadFromArguments();</a>
<a name="ln275">            Arguments.ClearAutomationArgs();</a>
<a name="ln276"> </a>
<a name="ln277">            RibbonTabControl.SelectedIndex = 0;</a>
<a name="ln278"> </a>
<a name="ln279">            WelcomeTextBlock.Text = LocalizationHelper.Get(Humanizer.WelcomeInfo());</a>
<a name="ln280">            SymbolTextBlock.Text = Humanizer.Welcome();</a>
<a name="ln281">        }</a>
<a name="ln282"> </a>
<a name="ln283">        private void Window_Activated(object sender, EventArgs e)</a>
<a name="ln284">        {</a>
<a name="ln285">            lock (ActivateLock)</a>
<a name="ln286">            {</a>
<a name="ln287">                RibbonTabControl.UpdateVisual();</a>
<a name="ln288"> </a>
<a name="ln289">                //Returns the preview if was playing before the deactivation of the window.</a>
<a name="ln290">                if (WasPreviewing)</a>
<a name="ln291">                {</a>
<a name="ln292">                    WasPreviewing = false;</a>
<a name="ln293">                    PlayPause();</a>
<a name="ln294">                }</a>
<a name="ln295">            }</a>
<a name="ln296">        }</a>
<a name="ln297"> </a>
<a name="ln298">        private void Window_Deactivated(object sender, EventArgs e)</a>
<a name="ln299">        {</a>
<a name="ln300">            if (!IsLoaded)</a>
<a name="ln301">                return;</a>
<a name="ln302"> </a>
<a name="ln303">            lock (ActivateLock)</a>
<a name="ln304">            {</a>
<a name="ln305">                try</a>
<a name="ln306">                {</a>
<a name="ln307">                    //Debug.WriteLine(&quot;Deactivated&quot;);</a>
<a name="ln308">                    RibbonTabControl.UpdateVisual(false);</a>
<a name="ln309"> </a>
<a name="ln310">                    //Pauses the recording preview.</a>
<a name="ln311">                    if (_previewToken != null)</a>
<a name="ln312">                    {</a>
<a name="ln313">                        WasPreviewing = true;</a>
<a name="ln314">                        Pause();</a>
<a name="ln315">                    }</a>
<a name="ln316">                }</a>
<a name="ln317">                catch (Exception ex)</a>
<a name="ln318">                {</a>
<a name="ln319">                    LogWriter.Log(ex, &quot;Exception when losing focus on window.&quot;);</a>
<a name="ln320">                }</a>
<a name="ln321">            }</a>
<a name="ln322">        }</a>
<a name="ln323"> </a>
<a name="ln324">        private void Window_KeyUp(object sender, KeyEventArgs e)</a>
<a name="ln325">        {</a>
<a name="ln326">            if (e.SystemKey == Key.LeftAlt)</a>
<a name="ln327">                e.Handled = true;</a>
<a name="ln328">        }</a>
<a name="ln329"> </a>
<a name="ln330">        private void Window_DpiChanged(object sender, DpiChangedEventArgs e)</a>
<a name="ln331">        {</a>
<a name="ln332">            if (Math.Abs(e.NewDpi.PixelsPerInchX - e.OldDpi.PixelsPerInchX) &lt; 0.01)</a>
<a name="ln333">                return;</a>
<a name="ln334"> </a>
<a name="ln335">            ZoomBoxControl.RefreshImage();</a>
<a name="ln336"> </a>
<a name="ln337">            if (e.OriginalSource is not Image)</a>
<a name="ln338">                Cancel_Executed(sender, null);</a>
<a name="ln339">        }</a>
<a name="ln340"> </a>
<a name="ln341">        private void Window_Closing(object sender, CancelEventArgs e)</a>
<a name="ln342">        {</a>
<a name="ln343">            //TODO: What if there's any processing happening? I need to try to stop.</a>
<a name="ln344"> </a>
<a name="ln345">            Pause();</a>
<a name="ln346">            ClosePanel();</a>
<a name="ln347"> </a>
<a name="ln348">            if (Project != null &amp;&amp; Project.Any)</a>
<a name="ln349">            {</a>
<a name="ln350">                Project.Persist();</a>
<a name="ln351"> </a>
<a name="ln352">                if (UserSettings.All.NotifyWhileClosingEditor &amp;&amp; !Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.Exiting.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.Exiting.Instruction&quot;),</a>
<a name="ln353">                        LocalizationHelper.Get(UserSettings.All.AutomaticCleanUp ? &quot;S.Editor.Exiting.Message2&quot; : &quot;S.Editor.Exiting.Message&quot;)))</a>
<a name="ln354">                {</a>
<a name="ln355">                    e.Cancel = true;</a>
<a name="ln356">                    return;</a>
<a name="ln357">                }</a>
<a name="ln358"> </a>
<a name="ln359">                Project.Clear();</a>
<a name="ln360"> </a>
<a name="ln361">                //Remove the ActionStack.</a>
<a name="ln362">                ActionStack.Clear();</a>
<a name="ln363">            }</a>
<a name="ln364"> </a>
<a name="ln365">            //Manually get the position/size of the window, so it's possible opening multiple instances.</a>
<a name="ln366">            UserSettings.All.EditorTop = Top;</a>
<a name="ln367">            UserSettings.All.EditorLeft = Left;</a>
<a name="ln368">            UserSettings.All.EditorWidth = Width;</a>
<a name="ln369">            UserSettings.All.EditorHeight = Height;</a>
<a name="ln370">            UserSettings.All.EditorWindowState = WindowState;</a>
<a name="ln371">            UserSettings.Save();</a>
<a name="ln372"> </a>
<a name="ln373">            Encoder.TryClose();</a>
<a name="ln374"> </a>
<a name="ln375">            SystemEvents.PowerModeChanged -= System_PowerModeChanged;</a>
<a name="ln376">            SystemEvents.DisplaySettingsChanged -= System_DisplaySettingsChanged;</a>
<a name="ln377">            SystemParameters.StaticPropertyChanged -= SystemParameters_StaticPropertyChanged;</a>
<a name="ln378">        }</a>
<a name="ln379"> </a>
<a name="ln380"> </a>
<a name="ln381">        private void ZoomBox_MouseWheel(object sender, MouseWheelEventArgs e)</a>
<a name="ln382">        {</a>
<a name="ln383">            if (Keyboard.Modifiers == ModifierKeys.Control || Keyboard.Modifiers == ModifierKeys.Shift || Keyboard.Modifiers == ModifierKeys.Alt)</a>
<a name="ln384">            {</a>
<a name="ln385">                #region Translate the Element (Scroll)</a>
<a name="ln386"> </a>
<a name="ln387">                if (sender.GetType() == typeof(ScrollViewer))</a>
<a name="ln388">                {</a>
<a name="ln389">                    switch (Keyboard.Modifiers)</a>
<a name="ln390">                    {</a>
<a name="ln391">                        case ModifierKeys.Alt:</a>
<a name="ln392"> </a>
<a name="ln393">                            var verDelta = e.Delta &gt; 0 ? -10.5 : 10.5;</a>
<a name="ln394">                            MainScrollViewer.ScrollToVerticalOffset(MainScrollViewer.VerticalOffset + verDelta);</a>
<a name="ln395"> </a>
<a name="ln396">                            break;</a>
<a name="ln397">                        case ModifierKeys.Shift:</a>
<a name="ln398"> </a>
<a name="ln399">                            var horDelta = e.Delta &gt; 0 ? -10.5 : 10.5;</a>
<a name="ln400">                            MainScrollViewer.ScrollToHorizontalOffset(MainScrollViewer.HorizontalOffset + horDelta);</a>
<a name="ln401"> </a>
<a name="ln402">                            break;</a>
<a name="ln403">                    }</a>
<a name="ln404"> </a>
<a name="ln405">                    return;</a>
<a name="ln406">                }</a>
<a name="ln407"> </a>
<a name="ln408">                #endregion</a>
<a name="ln409"> </a>
<a name="ln410">                e.Handled = false;</a>
<a name="ln411">                return;</a>
<a name="ln412">            }</a>
<a name="ln413"> </a>
<a name="ln414">            WasChangingSelection = true;</a>
<a name="ln415"> </a>
<a name="ln416">            if (e.Delta &gt; 0)</a>
<a name="ln417">            {</a>
<a name="ln418">                if (FrameListView.SelectedIndex == -1 || FrameListView.SelectedIndex == _viewModel.Frames.Count - 1)</a>
<a name="ln419">                {</a>
<a name="ln420">                    FrameListView.SelectedIndex = 0;</a>
<a name="ln421">                    return;</a>
<a name="ln422">                }</a>
<a name="ln423"> </a>
<a name="ln424">                //Show next frame.</a>
<a name="ln425">                FrameListView.SelectedIndex++;</a>
<a name="ln426">            }</a>
<a name="ln427">            else</a>
<a name="ln428">            {</a>
<a name="ln429">                if (FrameListView.SelectedIndex == -1 || FrameListView.SelectedIndex == 0)</a>
<a name="ln430">                {</a>
<a name="ln431">                    FrameListView.SelectedIndex = _viewModel.Frames.Count - 1;</a>
<a name="ln432">                    return;</a>
<a name="ln433">                }</a>
<a name="ln434"> </a>
<a name="ln435">                //Show previous frame.</a>
<a name="ln436">                FrameListView.SelectedIndex--;</a>
<a name="ln437">            }</a>
<a name="ln438">        }</a>
<a name="ln439"> </a>
<a name="ln440">        private void ZoomBoxControl_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)</a>
<a name="ln441">        {</a>
<a name="ln442">            //Perhaps ignore when the mouse up happened because of a drag?</a>
<a name="ln443">            if (_previewToken != null || !NotPreviewing)</a>
<a name="ln444">                (FindResource(&quot;Command.Play&quot;) as RoutedUICommand)?.Execute(null, this);</a>
<a name="ln445">        }</a>
<a name="ln446"> </a>
<a name="ln447">        private void System_PowerModeChanged(object sender, PowerModeChangedEventArgs e)</a>
<a name="ln448">        {</a>
<a name="ln449">            if (e.Mode == PowerModes.Suspend)</a>
<a name="ln450">            {</a>
<a name="ln451">                Slept = true;</a>
<a name="ln452">                Pause();</a>
<a name="ln453">                GC.Collect();</a>
<a name="ln454">                return;</a>
<a name="ln455">            }</a>
<a name="ln456"> </a>
<a name="ln457">            Slept = false;</a>
<a name="ln458">        }</a>
<a name="ln459"> </a>
<a name="ln460">        private void System_DisplaySettingsChanged(object sender, EventArgs e)</a>
<a name="ln461">        {</a>
<a name="ln462">            UpdatePositioning(false);</a>
<a name="ln463">        }</a>
<a name="ln464"> </a>
<a name="ln465">        private void SystemParameters_StaticPropertyChanged(object sender, PropertyChangedEventArgs e)</a>
<a name="ln466">        {</a>
<a name="ln467">            if (Slept)</a>
<a name="ln468">                return;</a>
<a name="ln469"> </a>
<a name="ln470">            //If the window color changes, update the tabs style.</a>
<a name="ln471">            if (e.PropertyName == &quot;WindowGlassColor&quot;)</a>
<a name="ln472">                RibbonTabControl.UpdateVisual(IsActive);</a>
<a name="ln473">        }</a>
<a name="ln474"> </a>
<a name="ln475">        #endregion</a>
<a name="ln476"> </a>
<a name="ln477">        #region Frame Selection</a>
<a name="ln478"> </a>
<a name="ln479">        private void FrameListView_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln480">        {</a>
<a name="ln481">            #region If nothing selected</a>
<a name="ln482"> </a>
<a name="ln483">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln484">            {</a>
<a name="ln485">                UpdateOtherStatistics();</a>
<a name="ln486">                ZoomBoxControl.ImageSource = null;</a>
<a name="ln487">                return;</a>
<a name="ln488">            }</a>
<a name="ln489"> </a>
<a name="ln490">            #endregion</a>
<a name="ln491"> </a>
<a name="ln492">            if (LastSelected == -1 || _previewToken != null || WasChangingSelection || LastSelected &gt;= _viewModel.Frames.Count || (e.AddedItems.Count &gt; 0 &amp;&amp; e.RemovedItems.Count &gt; 0))</a>
<a name="ln493">                LastSelected = FrameListView.SelectedIndex;</a>
<a name="ln494"> </a>
<a name="ln495">            FrameViewModel current;</a>
<a name="ln496"> </a>
<a name="ln497">            if (_previewToken != null || WasChangingSelection)</a>
<a name="ln498">            {</a>
<a name="ln499">                current = _viewModel.Frames[FrameListView.SelectedIndex];</a>
<a name="ln500">            }</a>
<a name="ln501">            else</a>
<a name="ln502">            {</a>
<a name="ln503">                //TODO: Test with other key shortcuts, because Ctrl + Z/Y was breaking this code.</a>
<a name="ln504"> </a>
<a name="ln505">                //current = _viewModel.Frames.GetItemAt(LastSelected) as FrameListBoxItem;</a>
<a name="ln506">                if (Keyboard.FocusedElement is ListViewItem focused &amp;&amp; focused.IsVisible &amp;&amp; (Keyboard.IsKeyDown(Key.LeftShift) || Keyboard.IsKeyDown(Key.RightShift) || Keyboard.IsKeyDown(Key.LeftCtrl) || Keyboard.IsKeyDown(Key.RightCtrl)))</a>
<a name="ln507">                    current = FrameListView.ItemContainerGenerator.ItemFromContainer(focused) as FrameViewModel;</a>
<a name="ln508">                else</a>
<a name="ln509">                    current = _viewModel.Frames.FirstOrDefault(x =&gt; FrameListView.ItemContainerGenerator.ContainerFromItem(x) is ListViewItem container &amp;&amp; (container.IsFocused || container.IsSelected));</a>
<a name="ln510">            }</a>
<a name="ln511"> </a>
<a name="ln512">            //If there's no focused item.</a>
<a name="ln513">            if (current == null)</a>
<a name="ln514">            {</a>
<a name="ln515">                if (_viewModel.Frames.Count - 1 &gt; LastSelected)</a>
<a name="ln516">                    FrameListView.SelectedIndex = LastSelected;</a>
<a name="ln517">                else</a>
<a name="ln518">                    FrameListView.SelectedIndex = LastSelected = _viewModel.Frames.Count - 1;</a>
<a name="ln519"> </a>
<a name="ln520">                if (FrameListView.SelectedIndex &gt; -1)</a>
<a name="ln521">                    current = _viewModel.Frames[FrameListView.SelectedIndex];</a>
<a name="ln522">            }</a>
<a name="ln523"> </a>
<a name="ln524">            if (current != null)</a>
<a name="ln525">            {</a>
<a name="ln526">                var index = _viewModel.Frames.IndexOf(current);</a>
<a name="ln527"> </a>
<a name="ln528">                if (index &gt; -1 &amp;&amp; Project.Frames.Count &gt; index)</a>
<a name="ln529">                {</a>
<a name="ln530">                    ZoomBoxControl.ImageSource = Project.Frames[index].Path;</a>
<a name="ln531">                    FrameListView.ScrollIntoView(current);</a>
<a name="ln532">                }</a>
<a name="ln533"> </a>
<a name="ln534">                if (FrameListView.ItemContainerGenerator.ContainerFromIndex(index) is ListViewItem container)</a>
<a name="ln535">                {</a>
<a name="ln536">                    if (!container.IsFocused &amp;&amp; _previewToken == null)// &amp;&amp; !WasChangingSelection)</a>
<a name="ln537">                        container.Focus();</a>
<a name="ln538">                }</a>
<a name="ln539">            }</a>
<a name="ln540"> </a>
<a name="ln541">            if (_previewToken == null)</a>
<a name="ln542">                UpdateOtherStatistics();</a>
<a name="ln543"> </a>
<a name="ln544">            WasChangingSelection = false;</a>
<a name="ln545">        }</a>
<a name="ln546"> </a>
<a name="ln547">        private void Item_PreviewMouseLeftButtonDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln548">        {</a>
<a name="ln549">            if (sender is not FrameViewModel item) // &amp;&amp; !WasChangingSelection)</a>
<a name="ln550">                return;</a>
<a name="ln551"> </a>
<a name="ln552">            LastSelected = item.Number;</a>
<a name="ln553"> </a>
<a name="ln554">            if (FrameListView.ItemContainerGenerator.ContainerFromItem(item) is ListViewItem container)</a>
<a name="ln555">                Keyboard.Focus(container);</a>
<a name="ln556">        }</a>
<a name="ln557"> </a>
<a name="ln558">        #endregion</a>
<a name="ln559"> </a>
<a name="ln560"> </a>
<a name="ln561">        #region File Tab</a>
<a name="ln562"> </a>
<a name="ln563">        #region New/Open</a>
<a name="ln564"> </a>
<a name="ln565">        private void NewRecording_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln566">        {</a>
<a name="ln567">            e.CanExecute = !IsLoading &amp;&amp; !e.Handled &amp;&amp; Application.Current.Windows.OfType&lt;Window&gt;().All(a =&gt; !(a is BaseRecorder));</a>
<a name="ln568">        }</a>
<a name="ln569"> </a>
<a name="ln570">        private void NewProject_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln571">        {</a>
<a name="ln572">            e.CanExecute = !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln573">        }</a>
<a name="ln574"> </a>
<a name="ln575">        private void NewRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln576">        {</a>
<a name="ln577">            e.Handled = true;</a>
<a name="ln578">            Pause();</a>
<a name="ln579">            WindowState = WindowState.Minimized;</a>
<a name="ln580">            ShowInTaskbar = false;</a>
<a name="ln581">            Encoder.Minimize();</a>
<a name="ln582">            ClosePanel(removeEvent: true);</a>
<a name="ln583"> </a>
<a name="ln584">            App.MainViewModel.OpenRecorder.Execute(this);</a>
<a name="ln585">        }</a>
<a name="ln586"> </a>
<a name="ln587">        private void NewWebcamRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln588">        {</a>
<a name="ln589">            e.Handled = true;</a>
<a name="ln590">            Pause();</a>
<a name="ln591">            ClosePanel(removeEvent: true);</a>
<a name="ln592"> </a>
<a name="ln593">            App.MainViewModel.OpenWebcamRecorder.Execute(this);</a>
<a name="ln594">        }</a>
<a name="ln595"> </a>
<a name="ln596">        private void NewBoardRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln597">        {</a>
<a name="ln598">            e.Handled = true;</a>
<a name="ln599">            Pause();</a>
<a name="ln600">            ClosePanel(removeEvent: true);</a>
<a name="ln601"> </a>
<a name="ln602">            App.MainViewModel.OpenBoardRecorder.Execute(this);</a>
<a name="ln603">        }</a>
<a name="ln604"> </a>
<a name="ln605">        private void NewProject_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln606">        {</a>
<a name="ln607">            Pause();</a>
<a name="ln608">            ShowPanel(PanelTypes.NewAnimation, LocalizationHelper.Get(&quot;S.Editor.File.Blank&quot;, true), &quot;Vector.File.New&quot;, ApplyNewProjectButton_Click);</a>
<a name="ln609">        }</a>
<a name="ln610"> </a>
<a name="ln611">        private void ApplyNewProjectButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln612">        {</a>
<a name="ln613">            Pause();</a>
<a name="ln614"> </a>
<a name="ln615">            //Start new project.</a>
<a name="ln616">            var project = new ProjectInfo().CreateProjectFolder(ProjectByType.Editor);</a>
<a name="ln617"> </a>
<a name="ln618">            var fileName = Path.Combine(project.FullPath, &quot;0.png&quot;);</a>
<a name="ln619"> </a>
<a name="ln620">            #region Create and Save Image</a>
<a name="ln621"> </a>
<a name="ln622">            using (var stream = new FileStream(fileName, FileMode.Create))</a>
<a name="ln623">            {</a>
<a name="ln624">                var bitmapSource = ImageMethods.CreateEmtpyBitmapSource(UserSettings.All.NewAnimationColor, UserSettings.All.NewAnimationWidth, UserSettings.All.NewAnimationHeight, this.Dpi(), PixelFormats.Indexed1);</a>
<a name="ln625"> </a>
<a name="ln626">                if (bitmapSource.Format != PixelFormats.Bgra32)</a>
<a name="ln627">                    bitmapSource = new FormatConvertedBitmap(bitmapSource, PixelFormats.Bgra32, null, 0);</a>
<a name="ln628"> </a>
<a name="ln629">                var bitmapFrame = BitmapFrame.Create(bitmapSource);</a>
<a name="ln630">                var encoder = new PngBitmapEncoder();</a>
<a name="ln631">                encoder.Frames.Add(bitmapFrame);</a>
<a name="ln632">                encoder.Save(stream);</a>
<a name="ln633">                stream.Flush();</a>
<a name="ln634">                stream.Close();</a>
<a name="ln635">            }</a>
<a name="ln636"> </a>
<a name="ln637">            GC.Collect();</a>
<a name="ln638"> </a>
<a name="ln639">            #endregion</a>
<a name="ln640"> </a>
<a name="ln641">            ClosePanel();</a>
<a name="ln642"> </a>
<a name="ln643">            project.Frames = new List&lt;FrameInfo&gt; { new FrameInfo(fileName, 66) };</a>
<a name="ln644"> </a>
<a name="ln645">            LoadProject(project);</a>
<a name="ln646">            ShowHint(&quot;S.Hint.NewAnimation&quot;);</a>
<a name="ln647">        }</a>
<a name="ln648"> </a>
<a name="ln649">        public void RecorderCallback(ProjectInfo project)</a>
<a name="ln650">        {</a>
<a name="ln651">            Activate();</a>
<a name="ln652"> </a>
<a name="ln653">            if (project?.Any == true)</a>
<a name="ln654">            {</a>
<a name="ln655">                LoadProject(project);</a>
<a name="ln656">                ShowHint(&quot;S.Hint.NewRecording&quot;);</a>
<a name="ln657">            }</a>
<a name="ln658"> </a>
<a name="ln659">            Encoder.Restore();</a>
<a name="ln660">            ShowInTaskbar = true;</a>
<a name="ln661">            WindowState = WindowState == WindowState.Minimized ? WindowState.Normal : WindowState;</a>
<a name="ln662">        }</a>
<a name="ln663"> </a>
<a name="ln664">        #endregion</a>
<a name="ln665"> </a>
<a name="ln666">        #region Insert</a>
<a name="ln667"> </a>
<a name="ln668">        private void Insert_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln669">        {</a>
<a name="ln670">            e.CanExecute = Project != null &amp;&amp; Project.Frames.Count &gt; 0 &amp;&amp; FrameListView.SelectedIndex != -1 &amp;&amp; !IsLoading &amp;&amp; !e.Handled &amp;&amp; Application.Current.Windows.OfType&lt;Window&gt;().All(a =&gt; !(a is BaseRecorder));</a>
<a name="ln671">        }</a>
<a name="ln672"> </a>
<a name="ln673">        private void InsertFromMedia_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln674">        {</a>
<a name="ln675">            e.CanExecute = Project != null &amp;&amp; Project.Frames.Count &gt; 0 &amp;&amp; FrameListView.SelectedIndex != -1 &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln676">        }</a>
<a name="ln677"> </a>
<a name="ln678">        private async void InsertRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln679">        {</a>
<a name="ln680">            e.Handled = true;</a>
<a name="ln681">            Pause();</a>
<a name="ln682">            WindowState = WindowState.Minimized;</a>
<a name="ln683">            Encoder.Minimize();</a>
<a name="ln684"> </a>
<a name="ln685">            ProjectInfo project = null;</a>
<a name="ln686"> </a>
<a name="ln687">            if (UserSettings.All.NewRecorder)</a>
<a name="ln688">            {</a>
<a name="ln689">                var recorder = new NewRecorder();</a>
<a name="ln690">                recorder.ShowDialog();</a>
<a name="ln691">                project = recorder.Project;</a>
<a name="ln692"> </a>
<a name="ln693">                if (recorder.Project?.Frames == null || !recorder.Project.Any)</a>
<a name="ln694">                {</a>
<a name="ln695">                    GC.Collect();</a>
<a name="ln696"> </a>
<a name="ln697">                    Encoder.Restore();</a>
<a name="ln698">                    WindowState = WindowState.Normal;</a>
<a name="ln699">                    return;</a>
<a name="ln700">                }</a>
<a name="ln701">            }</a>
<a name="ln702">            else</a>
<a name="ln703">            {</a>
<a name="ln704">                var recorder = new Recorder();</a>
<a name="ln705">                recorder.ShowDialog();</a>
<a name="ln706">                project = recorder.Project;</a>
<a name="ln707"> </a>
<a name="ln708">                if (recorder.Project?.Frames == null || !recorder.Project.Any)</a>
<a name="ln709">                {</a>
<a name="ln710">                    GC.Collect();</a>
<a name="ln711"> </a>
<a name="ln712">                    Encoder.Restore();</a>
<a name="ln713">                    WindowState = WindowState.Normal;</a>
<a name="ln714">                    return;</a>
<a name="ln715">                }</a>
<a name="ln716">            }</a>
<a name="ln717"> </a>
<a name="ln718">            #region Insert</a>
<a name="ln719"> </a>
<a name="ln720">            var insert = new Insert(Project.Frames.CopyList(), project.Frames, FrameListView.SelectedIndex) { Owner = this };</a>
<a name="ln721">            var result = insert.ShowDialog();</a>
<a name="ln722"> </a>
<a name="ln723">            if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln724">            {</a>
<a name="ln725">                Project.Frames = insert.CurrentList;</a>
<a name="ln726">                await LoadSelectedStarter(0);</a>
<a name="ln727">            }</a>
<a name="ln728"> </a>
<a name="ln729">            #endregion</a>
<a name="ln730"> </a>
<a name="ln731">            Encoder.Restore();</a>
<a name="ln732">            WindowState = WindowState.Normal;</a>
<a name="ln733">        }</a>
<a name="ln734"> </a>
<a name="ln735">        private async void InsertWebcamRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln736">        {</a>
<a name="ln737">            e.Handled = true;</a>
<a name="ln738">            Pause();</a>
<a name="ln739"> </a>
<a name="ln740">            var recorder = new Webcam();</a>
<a name="ln741">            recorder.ShowDialog();</a>
<a name="ln742"> </a>
<a name="ln743">            #region If recording cancelled</a>
<a name="ln744"> </a>
<a name="ln745">            if (recorder.Project?.Frames == null || !recorder.Project.Any)</a>
<a name="ln746">            {</a>
<a name="ln747">                GC.Collect();</a>
<a name="ln748"> </a>
<a name="ln749">                return;</a>
<a name="ln750">            }</a>
<a name="ln751"> </a>
<a name="ln752">            #endregion</a>
<a name="ln753"> </a>
<a name="ln754">            #region Insert</a>
<a name="ln755"> </a>
<a name="ln756">            var insert = new Insert(Project.Frames.CopyList(), recorder.Project.Frames, FrameListView.SelectedIndex) { Owner = this };</a>
<a name="ln757"> </a>
<a name="ln758">            var result = insert.ShowDialog();</a>
<a name="ln759"> </a>
<a name="ln760">            if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln761">            {</a>
<a name="ln762">                Project.Frames = insert.CurrentList;</a>
<a name="ln763">                await LoadSelectedStarter(0);</a>
<a name="ln764">            }</a>
<a name="ln765"> </a>
<a name="ln766">            #endregion</a>
<a name="ln767">        }</a>
<a name="ln768"> </a>
<a name="ln769">        private async void InsertBoardRecording_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln770">        {</a>
<a name="ln771">            e.Handled = true;</a>
<a name="ln772">            Pause();</a>
<a name="ln773"> </a>
<a name="ln774">            var recorder = new Board();</a>
<a name="ln775">            recorder.ShowDialog();</a>
<a name="ln776"> </a>
<a name="ln777">            #region If recording cancelled</a>
<a name="ln778"> </a>
<a name="ln779">            if (recorder.Project?.Frames == null || !recorder.Project.Any)</a>
<a name="ln780">            {</a>
<a name="ln781">                GC.Collect();</a>
<a name="ln782"> </a>
<a name="ln783">                return;</a>
<a name="ln784">            }</a>
<a name="ln785"> </a>
<a name="ln786">            #endregion</a>
<a name="ln787"> </a>
<a name="ln788">            #region Insert</a>
<a name="ln789"> </a>
<a name="ln790">            var insert = new Insert(Project.Frames.CopyList(), recorder.Project.Frames, FrameListView.SelectedIndex) { Owner = this };</a>
<a name="ln791"> </a>
<a name="ln792">            var result = insert.ShowDialog();</a>
<a name="ln793"> </a>
<a name="ln794">            if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln795">            {</a>
<a name="ln796">                Project.Frames = insert.CurrentList;</a>
<a name="ln797">                await LoadSelectedStarter(0);</a>
<a name="ln798">            }</a>
<a name="ln799"> </a>
<a name="ln800">            #endregion</a>
<a name="ln801">        }</a>
<a name="ln802"> </a>
<a name="ln803">        private async void InsertFromMedia_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln804">        {</a>
<a name="ln805">            e.Handled = true;</a>
<a name="ln806">            Pause();</a>
<a name="ln807"> </a>
<a name="ln808">            var ofd = new OpenFileDialog</a>
<a name="ln809">            {</a>
<a name="ln810">                Multiselect = true,</a>
<a name="ln811">                AddExtension = true,</a>
<a name="ln812">                CheckFileExists = true,</a>
<a name="ln813">                Title = LocalizationHelper.Get(&quot;S.Editor.File.OpenMedia&quot;),</a>
<a name="ln814">                Filter = $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.All&quot;)} (*.apng, *.avi, *.bmp, *.gif, *.jpg, *.jpeg, *.mkv, *.mp4, *.png, *.webp, *.webm, *.wmv)|*.apng;*.avi;*.bmp;*.gif;*.jpg;*.jpeg;*.mkv;*.mp4;*.png;*.webp;*.webm;*.wmv|&quot; +</a>
<a name="ln815">                         $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Image&quot;)} (*.apng, *.bmp, *.gif, *.jpg, *.jpeg, *.png)|*.apng;*.bmp;*.gif;*.jpg;*.jpeg;*.png|&quot; +</a>
<a name="ln816">                         $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Video&quot;)} (*.avi, *.mkv, *.mp4, *.webp, *.webm, *.wmv)|*.avi;*.mkv;*.mp4;*.webp;*.webm;*.wmv&quot;,</a>
<a name="ln817">            };</a>
<a name="ln818"> </a>
<a name="ln819">            var result = ofd.ShowDialog();</a>
<a name="ln820"> </a>
<a name="ln821">            #region Validation</a>
<a name="ln822"> </a>
<a name="ln823">            var extensionList = ofd.FileNames.Select(Path.GetExtension).ToList();</a>
<a name="ln824"> </a>
<a name="ln825">            var media = new[] { &quot;apng&quot;, &quot;avi&quot;, &quot;bmp&quot;, &quot;gif&quot;, &quot;jpg&quot;, &quot;jpeg&quot;, &quot;mkv&quot;, &quot;mp4&quot;, &quot;png&quot;, &quot;webp&quot;, &quot;webm&quot;, &quot;wmv&quot; };</a>
<a name="ln826"> </a>
<a name="ln827">            var projectCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; (x.Equals(&quot;stg&quot;) || x.Equals(&quot;zip&quot;)));</a>
<a name="ln828">            var mediaCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; media.Contains(x));</a>
<a name="ln829"> </a>
<a name="ln830">            if (projectCount != 0 &amp;&amp; mediaCount != 0)</a>
<a name="ln831">            {</a>
<a name="ln832">                Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.InvalidLoadingFiles&quot;)));</a>
<a name="ln833">                return;</a>
<a name="ln834">            }</a>
<a name="ln835"> </a>
<a name="ln836">            #endregion</a>
<a name="ln837"> </a>
<a name="ln838">            if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln839">            {</a>
<a name="ln840">                var done = await InsertImportFrom(ofd.FileNames.ToList());</a>
<a name="ln841"> </a>
<a name="ln842">                if (!done)</a>
<a name="ln843">                {</a>
<a name="ln844">                    Cursor = Cursors.Arrow;</a>
<a name="ln845">                    IsLoading = false;</a>
<a name="ln846">                    HideProgress();</a>
<a name="ln847"> </a>
<a name="ln848">                    ClosePanel(removeEvent: true);</a>
<a name="ln849"> </a>
<a name="ln850">                    FrameListView.Focus();</a>
<a name="ln851">                    CommandManager.InvalidateRequerySuggested();</a>
<a name="ln852">                }</a>
<a name="ln853">            }</a>
<a name="ln854">        }</a>
<a name="ln855"> </a>
<a name="ln856">        #endregion</a>
<a name="ln857"> </a>
<a name="ln858">        #region File</a>
<a name="ln859"> </a>
<a name="ln860">        private void File_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln861">        {</a>
<a name="ln862">            e.CanExecute = Project != null &amp;&amp; Project.Any &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln863">        }</a>
<a name="ln864"> </a>
<a name="ln865">        private void SaveAs_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln866">        {</a>
<a name="ln867">            Pause();</a>
<a name="ln868"> </a>
<a name="ln869">            ShowPanel(PanelTypes.SaveAs, LocalizationHelper.Get(&quot;S.Editor.File.Save&quot;, true), &quot;Vector.Save&quot;, SaveAsButton_Click);</a>
<a name="ln870">        }</a>
<a name="ln871"> </a>
<a name="ln872">        private async void SaveAsButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln873">        {</a>
<a name="ln874">            StatusList.Remove(StatusType.Warning);</a>
<a name="ln875"> </a>
<a name="ln876">            try</a>
<a name="ln877">            {</a>
<a name="ln878">                if (CustomContentControl.Content is not ExportPanel panel)</a>
<a name="ln879">                    return;</a>
<a name="ln880"> </a>
<a name="ln881">                //Lock UI.</a>
<a name="ln882">                IsLoading = true;</a>
<a name="ln883"> </a>
<a name="ln884">                if (!await panel.IsValid())</a>
<a name="ln885">                    return;</a>
<a name="ln886"> </a>
<a name="ln887">                var preset = panel.GetPreset();</a>
<a name="ln888"> </a>
<a name="ln889">                //Set some transient properties.</a>
<a name="ln890">                var size = Project.Frames[0].Path.SizeOf();</a>
<a name="ln891">                preset.Width = size.Width;</a>
<a name="ln892">                preset.Height = size.Height;</a>
<a name="ln893">                preset.Scale = this.Scale();</a>
<a name="ln894"> </a>
<a name="ln895">                if (await Task.Run(() =&gt; SaveAsync(preset)))</a>
<a name="ln896">                    ClosePanel();</a>
<a name="ln897">            }</a>
<a name="ln898">            catch (Exception ex)</a>
<a name="ln899">            {</a>
<a name="ln900">                LogWriter.Log(ex, &quot;Error while exporting&quot;);</a>
<a name="ln901">                StatusList.Error(ex.Message, StatusReasons.InvalidState); //TODO: Put a proper message and localize it.</a>
<a name="ln902">            }</a>
<a name="ln903">            finally</a>
<a name="ln904">            {</a>
<a name="ln905">                //Workaround for not disabling the CanExecute of the panel.</a>
<a name="ln906">                _applyAction = SaveAsButton_Click;</a>
<a name="ln907"> </a>
<a name="ln908">                //Return state of UI.</a>
<a name="ln909">                Cursor = Cursors.Arrow;</a>
<a name="ln910">                IsLoading = false;</a>
<a name="ln911"> </a>
<a name="ln912">                HideProgress();</a>
<a name="ln913"> </a>
<a name="ln914">                CommandManager.InvalidateRequerySuggested();</a>
<a name="ln915">            }</a>
<a name="ln916">        }</a>
<a name="ln917"> </a>
<a name="ln918"> </a>
<a name="ln919">        private async void Load_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln920">        {</a>
<a name="ln921">            e.Handled = true;</a>
<a name="ln922">            Pause();</a>
<a name="ln923"> </a>
<a name="ln924">            var ofd = new OpenFileDialog</a>
<a name="ln925">            {</a>
<a name="ln926">                Multiselect = true,</a>
<a name="ln927">                AddExtension = true,</a>
<a name="ln928">                CheckFileExists = true,</a>
<a name="ln929">                Title = LocalizationHelper.Get(&quot;S.Editor.File.OpenMediaProject&quot;),</a>
<a name="ln930">                Filter = $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.All&quot;)} (*.apng, *.avi, *.avif, *.bmp, *.gif, *.jpg, *.jpeg, *.mkv, *.mp4, *.png, *.stg, *.webp, *.webm, *.wmv, *.zip)|*.apng;*.avi;*.avif;*.bmp;*.gif;*.jpg;*.jpeg;*.mkv;*.mp4;*.png;*.stg;*.webp;*.webm;*.wmv;*.zip|&quot; +</a>
<a name="ln931">                         $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Image&quot;)} (*.apng, *.avif, *.bmp, *.gif, *.jpg, *.jpeg, *.png)|*.apng;*.avif;*.bmp;*.gif;*.jpg;*.jpeg;*.png|&quot; +</a>
<a name="ln932">                         $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Video&quot;)} (*.avi, *.mkv, *.mp4, *.webp, *.webm, *.wmv)|*.avi;*.mkv;*.mp4;*.webp;*.webm;*.wmv|&quot; +</a>
<a name="ln933">                         $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Project&quot;)} (*.stg, *.zip) |*.stg;*.zip&quot;,</a>
<a name="ln934">            };</a>
<a name="ln935"> </a>
<a name="ln936">            var result = ofd.ShowDialog();</a>
<a name="ln937"> </a>
<a name="ln938">            #region Validation</a>
<a name="ln939"> </a>
<a name="ln940">            var extensionList = ofd.FileNames.Select(s =&gt; Path.GetExtension(s).ToLowerInvariant()).ToList();</a>
<a name="ln941"> </a>
<a name="ln942">            var media = new[] { &quot;apng&quot;, &quot;avi&quot;, &quot;avif&quot;, &quot;bmp&quot;, &quot;gif&quot;, &quot;jpg&quot;, &quot;jpeg&quot;, &quot;mkv&quot;, &quot;mp4&quot;, &quot;png&quot;, &quot;webp&quot;, &quot;webm&quot;, &quot;wmv&quot; };</a>
<a name="ln943"> </a>
<a name="ln944">            var projectCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; (x.Equals(&quot;.stg&quot;) || x.Equals(&quot;.zip&quot;)));</a>
<a name="ln945">            var mediaCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; media.Contains(x));</a>
<a name="ln946"> </a>
<a name="ln947">            if (projectCount != 0 &amp;&amp; mediaCount != 0)</a>
<a name="ln948">            {</a>
<a name="ln949">                Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.InvalidLoadingFiles&quot;)));</a>
<a name="ln950">                return;</a>
<a name="ln951">            }</a>
<a name="ln952"> </a>
<a name="ln953">            #endregion</a>
<a name="ln954"> </a>
<a name="ln955">            if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln956">            {</a>
<a name="ln957">                await Task.Run(() =&gt; ImportFrom(ofd.FileNames.ToList()));</a>
<a name="ln958"> </a>
<a name="ln959">                CommandManager.InvalidateRequerySuggested();</a>
<a name="ln960">            }</a>
<a name="ln961">        }</a>
<a name="ln962"> </a>
<a name="ln963">        private void LoadRecent_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln964">        {</a>
<a name="ln965">            e.Handled = true;</a>
<a name="ln966">            Pause();</a>
<a name="ln967"> </a>
<a name="ln968">            ShowPanel(PanelTypes.LoadRecent, LocalizationHelper.Get(&quot;S.Editor.File.LoadRecent&quot;, true), &quot;Vector.Project&quot;, LoadRecentButton_Click);</a>
<a name="ln969">        }</a>
<a name="ln970"> </a>
<a name="ln971">        private void RecentDataGrid_MouseDoubleClick(object sender, MouseButtonEventArgs e)</a>
<a name="ln972">        {</a>
<a name="ln973">            LoadRecentButton_Click(sender, e);</a>
<a name="ln974">        }</a>
<a name="ln975"> </a>
<a name="ln976">        private void RecentDataGrid_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln977">        {</a>
<a name="ln978">            if (e.Key is Key.Return or Key.Enter)</a>
<a name="ln979">            {</a>
<a name="ln980">                LoadRecentButton_Click(sender, e);</a>
<a name="ln981">                e.Handled = true;</a>
<a name="ln982">            }</a>
<a name="ln983">        }</a>
<a name="ln984"> </a>
<a name="ln985">        private void LoadRecentButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln986">        {</a>
<a name="ln987">            if (RecentDataGrid.SelectedIndex &lt; 0)</a>
<a name="ln988">            {</a>
<a name="ln989">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Recent.Warning.NoSelection&quot;));</a>
<a name="ln990">                return;</a>
<a name="ln991">            }</a>
<a name="ln992"> </a>
<a name="ln993">            try</a>
<a name="ln994">            {</a>
<a name="ln995">                if (RecentDataGrid.SelectedItem is not ProjectInfo project)</a>
<a name="ln996">                    throw new Exception(&quot;Nothing selected&quot;);</a>
<a name="ln997"> </a>
<a name="ln998">                if (Project != null &amp;&amp; Project.RelativePath == project.RelativePath)</a>
<a name="ln999">                {</a>
<a name="ln1000">                    StatusList.Warning(LocalizationHelper.Get(&quot;S.Recent.Warning.SameProject&quot;));</a>
<a name="ln1001">                    return;</a>
<a name="ln1002">                }</a>
<a name="ln1003"> </a>
<a name="ln1004">                if (MutexList.IsInUse(project.RelativePath))</a>
<a name="ln1005">                {</a>
<a name="ln1006">                    StatusList.Warning(LocalizationHelper.Get(&quot;S.Recent.Warning.AnotherEditor&quot;));</a>
<a name="ln1007">                    return;</a>
<a name="ln1008">                }</a>
<a name="ln1009"> </a>
<a name="ln1010">                LoadProject(project, true, false, true);</a>
<a name="ln1011">            }</a>
<a name="ln1012">            catch (Exception ex)</a>
<a name="ln1013">            {</a>
<a name="ln1014">                ErrorDialog.Ok(&quot;ScreenToGif&quot;, &quot;Error while trying to load&quot;, ex.Message, ex);</a>
<a name="ln1015">                return;</a>
<a name="ln1016">            }</a>
<a name="ln1017"> </a>
<a name="ln1018">            _applyAction = null;</a>
<a name="ln1019"> </a>
<a name="ln1020">            ClosePanel();</a>
<a name="ln1021">        }</a>
<a name="ln1022"> </a>
<a name="ln1023">        private void DiscardProject_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1024">        {</a>
<a name="ln1025">            Discard(UserSettings.All.NotifyProjectDiscard);</a>
<a name="ln1026">        }</a>
<a name="ln1027"> </a>
<a name="ln1028">        #endregion</a>
<a name="ln1029"> </a>
<a name="ln1030">        #endregion</a>
<a name="ln1031"> </a>
<a name="ln1032">        #region Home Tab</a>
<a name="ln1033"> </a>
<a name="ln1034">        #region Action Stack</a>
<a name="ln1035"> </a>
<a name="ln1036">        private void Undo_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1037">        {</a>
<a name="ln1038">            e.CanExecute = ActionStack.CanUndo() &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln1039">        }</a>
<a name="ln1040"> </a>
<a name="ln1041">        private void Reset_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1042">        {</a>
<a name="ln1043">            e.CanExecute = ActionStack.CanReset() &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln1044">        }</a>
<a name="ln1045"> </a>
<a name="ln1046">        private void Redo_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1047">        {</a>
<a name="ln1048">            e.CanExecute = ActionStack.CanRedo() &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln1049">        }</a>
<a name="ln1050"> </a>
<a name="ln1051">        private void Undo_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1052">        {</a>
<a name="ln1053">            Pause();</a>
<a name="ln1054">            ClosePanel();</a>
<a name="ln1055"> </a>
<a name="ln1056">            Project.Frames = ActionStack.Undo(Project.Frames.CopyList());</a>
<a name="ln1057">            LoadProject(Project, false, false);</a>
<a name="ln1058"> </a>
<a name="ln1059">            ShowHint(&quot;S.Hint.Undo&quot;);</a>
<a name="ln1060">        }</a>
<a name="ln1061"> </a>
<a name="ln1062">        private void Reset_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1063">        {</a>
<a name="ln1064">            Pause();</a>
<a name="ln1065">            ClosePanel();</a>
<a name="ln1066"> </a>
<a name="ln1067">            Project.Frames = ActionStack.Reset(Project.Frames.CopyList());</a>
<a name="ln1068">            LoadProject(Project, false, false);</a>
<a name="ln1069"> </a>
<a name="ln1070">            ShowHint(&quot;S.Hint.Reset&quot;);</a>
<a name="ln1071">        }</a>
<a name="ln1072"> </a>
<a name="ln1073">        private void Redo_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1074">        {</a>
<a name="ln1075">            Pause();</a>
<a name="ln1076">            ClosePanel();</a>
<a name="ln1077"> </a>
<a name="ln1078">            Project.Frames = ActionStack.Redo(Project.Frames.CopyList());</a>
<a name="ln1079">            LoadProject(Project, false, false);</a>
<a name="ln1080"> </a>
<a name="ln1081">            ShowHint(&quot;S.Hint.Redo&quot;);</a>
<a name="ln1082">        }</a>
<a name="ln1083"> </a>
<a name="ln1084">        #endregion</a>
<a name="ln1085"> </a>
<a name="ln1086">        #region ClipBoard</a>
<a name="ln1087"> </a>
<a name="ln1088">        private void ClipBoard_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1089">        {</a>
<a name="ln1090">            e.CanExecute = FrameListView != null &amp;&amp; FrameListView.SelectedItem != null &amp;&amp; !IsLoading &amp;&amp; !e.Handled;</a>
<a name="ln1091">        }</a>
<a name="ln1092"> </a>
<a name="ln1093">        private void Cut_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1094">        {</a>
<a name="ln1095">            e.Handled = true;</a>
<a name="ln1096">            Pause();</a>
<a name="ln1097"> </a>
<a name="ln1098">            #region Validation</a>
<a name="ln1099"> </a>
<a name="ln1100">            if (FrameListView.SelectedItems.Count == _viewModel.Frames.Count)</a>
<a name="ln1101">            {</a>
<a name="ln1102">                Dialog.Ok(FindResource(&quot;S.Editor.Clipboard.InvalidCut.Title&quot;).ToString(),</a>
<a name="ln1103">                    FindResource(&quot;S.Editor.Clipboard.InvalidCut.Instruction&quot;).ToString(),</a>
<a name="ln1104">                    FindResource(&quot;S.Editor.Clipboard.InvalidCut.Message&quot;).ToString(), Icons.Info);</a>
<a name="ln1105">                return;</a>
<a name="ln1106">            }</a>
<a name="ln1107"> </a>
<a name="ln1108">            #endregion</a>
<a name="ln1109"> </a>
<a name="ln1110">            var index = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().OrderBy(x =&gt; x.Number).First().Number;</a>
<a name="ln1111"> </a>
<a name="ln1112">            ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, SelectedFramesIndex());</a>
<a name="ln1113"> </a>
<a name="ln1114">            var selected = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().ToList();</a>
<a name="ln1115">            var list = selected.Select(item =&gt; Project.Frames[item.Number]).ToList();</a>
<a name="ln1116"> </a>
<a name="ln1117">            FrameListView.SelectedIndex = -1;</a>
<a name="ln1118"> </a>
<a name="ln1119">            if (!Util.Clipboard.Cut(list))</a>
<a name="ln1120">            {</a>
<a name="ln1121">                Dialog.Ok(&quot;Clipboard Exception&quot;, &quot;Impossible to cut selected frames.&quot;,</a>
<a name="ln1122">                    &quot;Something wrong happened, please report this issue (by sending the exception log).&quot;);</a>
<a name="ln1123"> </a>
<a name="ln1124">                Undo_Executed(null, null);</a>
<a name="ln1125"> </a>
<a name="ln1126">                return;</a>
<a name="ln1127">            }</a>
<a name="ln1128"> </a>
<a name="ln1129">            selected.OrderByDescending(x =&gt; x.Number).ToList().ForEach(x =&gt; Project.Frames.RemoveAt(x.Number));</a>
<a name="ln1130">            selected.OrderByDescending(x =&gt; x.Number).ToList().ForEach(x =&gt; _viewModel.Frames.Remove(x));</a>
<a name="ln1131"> </a>
<a name="ln1132">            AdjustFrameNumbers(index);</a>
<a name="ln1133">            SelectNear(index);</a>
<a name="ln1134"> </a>
<a name="ln1135">            #region Item</a>
<a name="ln1136"> </a>
<a name="ln1137">            var imageItem = new ExtendedListBoxItem</a>
<a name="ln1138">            {</a>
<a name="ln1139">                Author = DateTime.Now.ToString(&quot;HH:mm:ss&quot;, CultureInfo.CurrentUICulture)</a>
<a name="ln1140">            };</a>
<a name="ln1141"> </a>
<a name="ln1142">            if (selected.Count &gt; 1)</a>
<a name="ln1143">            {</a>
<a name="ln1144">                imageItem.Tag = $&quot;{LocalizationHelper.Get(&quot;S.ImportVideo.Frames&quot;)} {string.Join(&quot;, &quot;, selected.Select(x =&gt; x.Number))}&quot;;</a>
<a name="ln1145">                imageItem.Icon = FindResource(&quot;Vector.ImageStack&quot;) as Brush;</a>
<a name="ln1146">                imageItem.Content = $&quot;{list.Count} Images&quot;;</a>
<a name="ln1147">            }</a>
<a name="ln1148">            else</a>
<a name="ln1149">            {</a>
<a name="ln1150">                imageItem.Tag = $&quot;{LocalizationHelper.Get(&quot;S.Editor.List.Frame&quot;)} {selected[0].Number}&quot;;</a>
<a name="ln1151">                imageItem.Icon = FindResource(&quot;Vector.Image&quot;) as Brush;</a>
<a name="ln1152">                imageItem.Content = $&quot;{list.Count} Image&quot;;</a>
<a name="ln1153">            }</a>
<a name="ln1154"> </a>
<a name="ln1155">            #endregion</a>
<a name="ln1156"> </a>
<a name="ln1157">            ClipboardListBox.Items.Add(imageItem);</a>
<a name="ln1158">            ClipboardListBox.SelectedIndex = ClipboardListBox.Items.Count - 1;</a>
<a name="ln1159"> </a>
<a name="ln1160">            ShowHint(&quot;S.Hint.Cut&quot;, false, selected.Count);</a>
<a name="ln1161"> </a>
<a name="ln1162">            ShowPanel(PanelTypes.Clipboard, LocalizationHelper.Get(&quot;S.Editor.Home.Clipboard&quot;, true), &quot;Vector.Paste&quot;);</a>
<a name="ln1163">        }</a>
<a name="ln1164"> </a>
<a name="ln1165">        private void Copy_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1166">        {</a>
<a name="ln1167">            Pause();</a>
<a name="ln1168"> </a>
<a name="ln1169">            var selected = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().ToList();</a>
<a name="ln1170">            var list = selected.Select(item =&gt; Project.Frames[item.Number]).ToList();</a>
<a name="ln1171"> </a>
<a name="ln1172">            if (!Util.Clipboard.Copy(list))</a>
<a name="ln1173">            {</a>
<a name="ln1174">                Dialog.Ok(&quot;Clipboard Exception&quot;, &quot;Impossible to copy selected frames.&quot;,</a>
<a name="ln1175">                    &quot;Something wrong happened, please report this issue (by sending the exception log).&quot;);</a>
<a name="ln1176">                return;</a>
<a name="ln1177">            }</a>
<a name="ln1178"> </a>
<a name="ln1179">            #region Item</a>
<a name="ln1180"> </a>
<a name="ln1181">            var imageItem = new ExtendedListBoxItem</a>
<a name="ln1182">            {</a>
<a name="ln1183">                Author = DateTime.Now.ToString(&quot;HH:mm:ss&quot;, CultureInfo.CurrentUICulture)</a>
<a name="ln1184">            };</a>
<a name="ln1185"> </a>
<a name="ln1186">            if (list.Count &gt; 1)</a>
<a name="ln1187">            {</a>
<a name="ln1188">                imageItem.Tag = $&quot;{LocalizationHelper.Get(&quot;S.ImportVideo.Frames&quot;)} {string.Join(&quot;, &quot;, selected.Select(x =&gt; x.Number))}&quot;;</a>
<a name="ln1189">                imageItem.Icon = FindResource(&quot;Vector.ImageStack&quot;) as Brush;</a>
<a name="ln1190">                imageItem.Content = LocalizationHelper.GetWithFormat(&quot;S.Clipboard.Entry.Images&quot;, &quot;{0} images&quot;, list.Count);</a>
<a name="ln1191">            }</a>
<a name="ln1192">            else</a>
<a name="ln1193">            {</a>
<a name="ln1194">                imageItem.Tag = $&quot;{LocalizationHelper.Get(&quot;S.Editor.List.Frame&quot;)} {selected[0].Number}&quot;;</a>
<a name="ln1195">                imageItem.Icon = FindResource(&quot;Vector.Image&quot;) as Brush;</a>
<a name="ln1196">                imageItem.Content = LocalizationHelper.GetWithFormat(&quot;S.Clipboard.Entry.Image&quot;, &quot;{0} image&quot;, list.Count);</a>
<a name="ln1197">            }</a>
<a name="ln1198"> </a>
<a name="ln1199">            #endregion</a>
<a name="ln1200"> </a>
<a name="ln1201">            ClipboardListBox.Items.Add(imageItem);</a>
<a name="ln1202">            ClipboardListBox.SelectedIndex = ClipboardListBox.Items.Count - 1;</a>
<a name="ln1203"> </a>
<a name="ln1204">            ShowHint(&quot;S.Hint.Copy&quot;, false, selected.Count);</a>
<a name="ln1205"> </a>
<a name="ln1206">            ShowPanel(PanelTypes.Clipboard, LocalizationHelper.Get(&quot;S.Editor.Home.Clipboard&quot;, true), &quot;Vector.Paste&quot;);</a>
<a name="ln1207">        }</a>
<a name="ln1208"> </a>
<a name="ln1209">        private void Paste_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1210">        {</a>
<a name="ln1211">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; Util.Clipboard.Items.Count &gt; 0 &amp;&amp; ClipboardListBox.SelectedItem != null;</a>
<a name="ln1212">        }</a>
<a name="ln1213"> </a>
<a name="ln1214">        private async void Paste_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1215">        {</a>
<a name="ln1216">            Pause();</a>
<a name="ln1217"> </a>
<a name="ln1218">            var index = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Last().Number;</a>
<a name="ln1219">            index = PasteBeforeRadioButton.IsChecked.HasValue &amp;&amp; PasteBeforeRadioButton.IsChecked.Value ? index : index + 1;</a>
<a name="ln1220"> </a>
<a name="ln1221">            var clipData = Util.Clipboard.Paste(Project.FullPath, ClipboardListBox.SelectedIndex, ClipboardListBox.SelectedIndex);</a>
<a name="ln1222"> </a>
<a name="ln1223">            ActionStack.SaveState(ActionStack.EditAction.Add, index, clipData.Count);</a>
<a name="ln1224"> </a>
<a name="ln1225">            Project.Frames.InsertRange(index, clipData);</a>
<a name="ln1226"> </a>
<a name="ln1227">            ClosePanel();</a>
<a name="ln1228"> </a>
<a name="ln1229">            await LoadSelectedStarter(index, Project.Frames.Count - 1);</a>
<a name="ln1230"> </a>
<a name="ln1231">            ShowHint(&quot;S.Hint.Paste&quot;, false, clipData.Count);</a>
<a name="ln1232">        }</a>
<a name="ln1233"> </a>
<a name="ln1234">        private void ShowClipboardButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1235">        {</a>
<a name="ln1236">            ShowPanel(PanelTypes.Clipboard, LocalizationHelper.Get(&quot;S.Editor.Home.Clipboard&quot;, true), &quot;Vector.Paste&quot;);</a>
<a name="ln1237">        }</a>
<a name="ln1238"> </a>
<a name="ln1239"> </a>
<a name="ln1240">        private void ClipBoardSelection_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1241">        {</a>
<a name="ln1242">            e.CanExecute = ClipboardListBox.SelectedItem != null &amp;&amp; !IsLoading;</a>
<a name="ln1243">        }</a>
<a name="ln1244"> </a>
<a name="ln1245">        private void ExploreClipBoard_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1246">        {</a>
<a name="ln1247">            try</a>
<a name="ln1248">            {</a>
<a name="ln1249">                var selected = Util.Clipboard.Items[ClipboardListBox.SelectedIndex];</a>
<a name="ln1250"> </a>
<a name="ln1251">                ProcessHelper.StartWithShell(Path.GetDirectoryName(selected[0].Path));</a>
<a name="ln1252">            }</a>
<a name="ln1253">            catch (Exception ex)</a>
<a name="ln1254">            {</a>
<a name="ln1255">                LogWriter.Log(ex, &quot;Impossible to browse the clipboard folder&quot;);</a>
<a name="ln1256">                Dialog.Ok(Title, &quot;Impossible to browse the clipboard folder&quot;, ex.Message);</a>
<a name="ln1257">            }</a>
<a name="ln1258">        }</a>
<a name="ln1259"> </a>
<a name="ln1260">        private void RemoveClipboard_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1261">        {</a>
<a name="ln1262">            Util.Clipboard.Remove(ClipboardListBox.SelectedIndex);</a>
<a name="ln1263">            ClipboardListBox.Items.RemoveAt(ClipboardListBox.SelectedIndex);</a>
<a name="ln1264">        }</a>
<a name="ln1265"> </a>
<a name="ln1266">        #endregion</a>
<a name="ln1267"> </a>
<a name="ln1268">        #region Zoom</a>
<a name="ln1269"> </a>
<a name="ln1270">        private void Zoom_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1271">        {</a>
<a name="ln1272">            e.CanExecute = Project != null &amp;&amp; Project.Any &amp;&amp; !IsLoading &amp;&amp; !OverlayGrid.IsVisible &amp;&amp; FrameListView.SelectedIndex != -1;</a>
<a name="ln1273">        }</a>
<a name="ln1274"> </a>
<a name="ln1275">        private void Zoom100_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1276">        {</a>
<a name="ln1277">            ZoomBoxControl.Zoom = 1.0;</a>
<a name="ln1278">            ZoomBoxControl.SaveCurrentZoom();</a>
<a name="ln1279"> </a>
<a name="ln1280">            ShowHint(&quot;S.Hint.Zoom&quot;, false, 100);</a>
<a name="ln1281">        }</a>
<a name="ln1282"> </a>
<a name="ln1283">        private void SizeToContent_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1284">        {</a>
<a name="ln1285">            WindowState = WindowState.Normal;</a>
<a name="ln1286">            ZoomBoxControl.UpdateLayout();</a>
<a name="ln1287"> </a>
<a name="ln1288">            var size = ZoomBoxControl.GetElementSize(true);</a>
<a name="ln1289"> </a>
<a name="ln1290">            //Tried to get the size again.</a>
<a name="ln1291">            if (size.Width &lt; 2)</a>
<a name="ln1292">                size = Project.Frames[0].Path.NonScaledSize();</a>
<a name="ln1293"> </a>
<a name="ln1294">            //If failed again, abort.</a>
<a name="ln1295">            if (size.Width &lt; 2)</a>
<a name="ln1296">                return;</a>
<a name="ln1297"> </a>
<a name="ln1298">            var scale = this.Scale();</a>
<a name="ln1299"> </a>
<a name="ln1300">            var borderHeight = ActualHeight - MainGrid.ActualHeight;</a>
<a name="ln1301">            var borderWidth = ActualWidth - MainGrid.ActualWidth;</a>
<a name="ln1302"> </a>
<a name="ln1303">            //Bug: I need to take into consideration that the RibbonTabControl.ActualHeight can change, because the tab headers can occupy 2 rows.</a>
<a name="ln1304">            var width = (size.Width * ZoomBoxControl.Zoom / ZoomBoxControl.ScaleDiff + 60) + borderWidth;</a>
<a name="ln1305">            var height = (size.Height * ZoomBoxControl.Zoom / ZoomBoxControl.ScaleDiff + (RibbonTabControl.ActualHeight + FrameListView.ActualHeight + LowerGrid.ActualHeight)) + borderHeight;</a>
<a name="ln1306"> </a>
<a name="ln1307">            //If image is too small, size to the minimum size.</a>
<a name="ln1308">            if (width &lt; 770)</a>
<a name="ln1309">                width = 770;</a>
<a name="ln1310"> </a>
<a name="ln1311">            if (height &lt; 575)</a>
<a name="ln1312">                height = 575;</a>
<a name="ln1313"> </a>
<a name="ln1314">            var screen = MonitorHelper.AllMonitorsScaled(scale).FirstOrDefault(x =&gt; x.Bounds.Contains(new Point(Left, Top))) ??</a>
<a name="ln1315">                         MonitorHelper.AllMonitorsScaled(scale).FirstOrDefault(x =&gt; x.IsPrimary);</a>
<a name="ln1316"> </a>
<a name="ln1317">            if (screen != null)</a>
<a name="ln1318">            {</a>
<a name="ln1319">                //If the resulting size is too big, fit the window on the available working area.</a>
<a name="ln1320">                if (screen.WorkingArea.Width &lt; width)</a>
<a name="ln1321">                    width = screen.WorkingArea.Width;</a>
<a name="ln1322"> </a>
<a name="ln1323">                if (screen.WorkingArea.Height &lt; height)</a>
<a name="ln1324">                    height = screen.WorkingArea.Height;</a>
<a name="ln1325"> </a>
<a name="ln1326">                //If the window overflows, put back in place.</a>
<a name="ln1327">                if (Left + width &gt; screen.WorkingArea.Right)</a>
<a name="ln1328">                    Left = screen.WorkingArea.Right - width;</a>
<a name="ln1329"> </a>
<a name="ln1330">                if (Top + height &gt; screen.WorkingArea.Bottom)</a>
<a name="ln1331">                    Top = screen.WorkingArea.Bottom - height;</a>
<a name="ln1332">            }</a>
<a name="ln1333"> </a>
<a name="ln1334">            Width = width;</a>
<a name="ln1335">            Height = height;</a>
<a name="ln1336">        }</a>
<a name="ln1337"> </a>
<a name="ln1338">        private void FitImage_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1339">        {</a>
<a name="ln1340">            //Reset the zoom, to get the actual image size.</a>
<a name="ln1341">            ZoomBoxControl.Zoom = 1;</a>
<a name="ln1342">            ZoomBoxControl.UpdateLayout();</a>
<a name="ln1343"> </a>
<a name="ln1344">            var size = ZoomBoxControl.GetElementSize();</a>
<a name="ln1345"> </a>
<a name="ln1346">            if (size.Width &lt; 2)</a>
<a name="ln1347">                size = Project.Frames[0].Path.ScaledSize();</a>
<a name="ln1348"> </a>
<a name="ln1349">            #region Calculate the Zoom</a>
<a name="ln1350"> </a>
<a name="ln1351">            var zoomHeight = 1D;</a>
<a name="ln1352">            var zoomWidth = 1D;</a>
<a name="ln1353"> </a>
<a name="ln1354">            if (size.Width &gt; ZoomBoxControl.ActualWidth)</a>
<a name="ln1355">                zoomWidth = ZoomBoxControl.ActualWidth / size.Width;// * this.Scale();</a>
<a name="ln1356"> </a>
<a name="ln1357">            if (size.Height &gt; ZoomBoxControl.ActualHeight)</a>
<a name="ln1358">                zoomHeight = ZoomBoxControl.ActualHeight / size.Height;// * this.Scale();</a>
<a name="ln1359"> </a>
<a name="ln1360">            #endregion</a>
<a name="ln1361"> </a>
<a name="ln1362">            #region Apply the zoom</a>
<a name="ln1363"> </a>
<a name="ln1364">            if (zoomHeight &gt; 0 &amp;&amp; zoomHeight &lt; zoomWidth)</a>
<a name="ln1365">                ZoomBoxControl.Zoom = zoomHeight;</a>
<a name="ln1366">            else if (zoomWidth &gt; 0 &amp;&amp; zoomWidth &lt; zoomHeight)</a>
<a name="ln1367">                ZoomBoxControl.Zoom = zoomWidth;</a>
<a name="ln1368">            else</a>
<a name="ln1369">                ZoomBoxControl.Zoom = 1;</a>
<a name="ln1370"> </a>
<a name="ln1371">            ZoomBoxControl.SaveCurrentZoom();</a>
<a name="ln1372"> </a>
<a name="ln1373">            #endregion</a>
<a name="ln1374"> </a>
<a name="ln1375">            ShowHint(&quot;S.Hint.Zoom&quot;, false, Convert.ToInt32(ZoomBoxControl.Zoom * 100));</a>
<a name="ln1376"> </a>
<a name="ln1377">            GC.Collect(1);</a>
<a name="ln1378">        }</a>
<a name="ln1379"> </a>
<a name="ln1380">        #endregion</a>
<a name="ln1381"> </a>
<a name="ln1382">        #region Select</a>
<a name="ln1383"> </a>
<a name="ln1384">        private void Selection_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1385">        {</a>
<a name="ln1386">            e.CanExecute = !IsLoading &amp;&amp; FrameListView != null &amp;&amp; FrameListView.HasItems;</a>
<a name="ln1387">        }</a>
<a name="ln1388"> </a>
<a name="ln1389">        private void SelectAll_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1390">        {</a>
<a name="ln1391">            Pause();</a>
<a name="ln1392"> </a>
<a name="ln1393">            FrameListView.UnselectAll();</a>
<a name="ln1394">            FrameListView.SelectAll();</a>
<a name="ln1395"> </a>
<a name="ln1396">            ShowHint(&quot;S.Hint.SelectAll&quot;);</a>
<a name="ln1397">        }</a>
<a name="ln1398"> </a>
<a name="ln1399">        private void GoTo_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1400">        {</a>
<a name="ln1401">            Pause();</a>
<a name="ln1402"> </a>
<a name="ln1403">            var go = new GoTo(Project.Frames.Count - 1) { Owner = this };</a>
<a name="ln1404">            var result = go.ShowDialog();</a>
<a name="ln1405"> </a>
<a name="ln1406">            if (!result.HasValue || !result.Value)</a>
<a name="ln1407">                return;</a>
<a name="ln1408"> </a>
<a name="ln1409">            WasChangingSelection = true;</a>
<a name="ln1410">            FrameListView.SelectedIndex = go.Selected;</a>
<a name="ln1411"> </a>
<a name="ln1412">            ShowHint(&quot;S.Hint.SelectSingle&quot;, false, go.Selected);</a>
<a name="ln1413">        }</a>
<a name="ln1414"> </a>
<a name="ln1415">        private void InverseSelection_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1416">        {</a>
<a name="ln1417">            Pause();</a>
<a name="ln1418"> </a>
<a name="ln1419">            foreach (var item in _viewModel.Frames)</a>
<a name="ln1420">            {</a>
<a name="ln1421">                if (FrameListView.ItemContainerGenerator.ContainerFromItem(item) is ListViewItem element)</a>
<a name="ln1422">                    element.IsSelected = !element.IsSelected;</a>
<a name="ln1423">            }</a>
<a name="ln1424"> </a>
<a name="ln1425">            ShowHint(&quot;S.Hint.SelectInverse&quot;);</a>
<a name="ln1426">        }</a>
<a name="ln1427"> </a>
<a name="ln1428">        private void DeselectAll_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1429">        {</a>
<a name="ln1430">            Pause();</a>
<a name="ln1431">            ClosePanel();</a>
<a name="ln1432"> </a>
<a name="ln1433">            FrameListView.SelectedIndex = -1;</a>
<a name="ln1434"> </a>
<a name="ln1435">            ShowHint(&quot;S.Hint.Deselect&quot;);</a>
<a name="ln1436">        }</a>
<a name="ln1437"> </a>
<a name="ln1438">        #endregion</a>
<a name="ln1439"> </a>
<a name="ln1440">        #endregion</a>
<a name="ln1441"> </a>
<a name="ln1442">        #region Playback Tab</a>
<a name="ln1443"> </a>
<a name="ln1444">        private void Playback_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1445">        {</a>
<a name="ln1446">            e.CanExecute = Project != null &amp;&amp; Project.Frames.Count &gt; 1 &amp;&amp; !IsLoading;</a>
<a name="ln1447">        }</a>
<a name="ln1448"> </a>
<a name="ln1449">        private void FirstFrame_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1450">        {</a>
<a name="ln1451">            Pause();</a>
<a name="ln1452"> </a>
<a name="ln1453">            WasChangingSelection = true;</a>
<a name="ln1454">            FrameListView.SelectedIndex = 0;</a>
<a name="ln1455">        }</a>
<a name="ln1456"> </a>
<a name="ln1457">        private void PreviousFrame_Executed(object sender, EventArgs e)</a>
<a name="ln1458">        {</a>
<a name="ln1459">            Pause();</a>
<a name="ln1460"> </a>
<a name="ln1461">            WasChangingSelection = true;</a>
<a name="ln1462"> </a>
<a name="ln1463">            if (FrameListView.SelectedIndex is -1 or 0)</a>
<a name="ln1464">            {</a>
<a name="ln1465">                if (Keyboard.IsKeyDown(Key.LeftShift) || Keyboard.IsKeyDown(Key.RightShift))</a>
<a name="ln1466">                    return;</a>
<a name="ln1467"> </a>
<a name="ln1468">                FrameListView.SelectedIndex = _viewModel.Frames.Count - 1;</a>
<a name="ln1469">                return;</a>
<a name="ln1470">            }</a>
<a name="ln1471"> </a>
<a name="ln1472">            //Show previous frame.</a>
<a name="ln1473">            //Control = 5</a>
<a name="ln1474">            //Alt = 10</a>
<a name="ln1475">            //Control + Alt = 20</a>
<a name="ln1476">            if (e != null &amp;&amp; (Keyboard.Modifiers &amp; (ModifierKeys.Alt | ModifierKeys.Control)) == (ModifierKeys.Alt | ModifierKeys.Control))</a>
<a name="ln1477">                FrameListView.SelectedIndex = Math.Max(0, FrameListView.SelectedIndex - 20);</a>
<a name="ln1478">            else if (e != null &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Control) != 0)</a>
<a name="ln1479">                FrameListView.SelectedIndex = Math.Max(0, FrameListView.SelectedIndex - 5);</a>
<a name="ln1480">            else if (e != null &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Alt) != 0)</a>
<a name="ln1481">                FrameListView.SelectedIndex = Math.Max(0, FrameListView.SelectedIndex - 10);</a>
<a name="ln1482">            else</a>
<a name="ln1483">                FrameListView.SelectedIndex--;</a>
<a name="ln1484">        }</a>
<a name="ln1485"> </a>
<a name="ln1486">        private void Play_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1487">        {</a>
<a name="ln1488">            PlayPause();</a>
<a name="ln1489">        }</a>
<a name="ln1490"> </a>
<a name="ln1491">        private void NextFrame_Executed(object sender, EventArgs e)</a>
<a name="ln1492">        {</a>
<a name="ln1493">            Pause();</a>
<a name="ln1494"> </a>
<a name="ln1495">            WasChangingSelection = true;</a>
<a name="ln1496"> </a>
<a name="ln1497">            if (FrameListView.SelectedIndex == -1 || FrameListView.SelectedIndex == _viewModel.Frames.Count - 1)</a>
<a name="ln1498">            {</a>
<a name="ln1499">                if (Keyboard.IsKeyDown(Key.LeftShift) || Keyboard.IsKeyDown(Key.RightShift))</a>
<a name="ln1500">                    return;</a>
<a name="ln1501"> </a>
<a name="ln1502">                FrameListView.SelectedIndex = 0;</a>
<a name="ln1503">                return;</a>
<a name="ln1504">            }</a>
<a name="ln1505"> </a>
<a name="ln1506">            //Show next frame.</a>
<a name="ln1507">            //Control = 5</a>
<a name="ln1508">            //Alt = 10</a>
<a name="ln1509">            //Control + Alt = 20</a>
<a name="ln1510">            if (e != null &amp;&amp; (Keyboard.Modifiers &amp; (ModifierKeys.Alt | ModifierKeys.Control)) == (ModifierKeys.Alt | ModifierKeys.Control))</a>
<a name="ln1511">                FrameListView.SelectedIndex = Math.Min(_viewModel.Frames.Count - 1, FrameListView.SelectedIndex + 20);</a>
<a name="ln1512">            else if (e != null &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Control) != 0)</a>
<a name="ln1513">                FrameListView.SelectedIndex = Math.Min(_viewModel.Frames.Count - 1, FrameListView.SelectedIndex + 5);</a>
<a name="ln1514">            else if (e != null &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Alt) != 0)</a>
<a name="ln1515">                FrameListView.SelectedIndex = Math.Min(_viewModel.Frames.Count - 1, FrameListView.SelectedIndex + 10);</a>
<a name="ln1516">            else</a>
<a name="ln1517">                FrameListView.SelectedIndex++;</a>
<a name="ln1518">        }</a>
<a name="ln1519"> </a>
<a name="ln1520">        private void LastFrame_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1521">        {</a>
<a name="ln1522">            Pause();</a>
<a name="ln1523"> </a>
<a name="ln1524">            WasChangingSelection = true;</a>
<a name="ln1525">            FrameListView.SelectedIndex = _viewModel.Frames.Count - 1;</a>
<a name="ln1526">        }</a>
<a name="ln1527"> </a>
<a name="ln1528">        #endregion</a>
<a name="ln1529"> </a>
<a name="ln1530">        #region Edit Tab</a>
<a name="ln1531"> </a>
<a name="ln1532">        #region Frames</a>
<a name="ln1533"> </a>
<a name="ln1534">        private void Delete_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1535">        {</a>
<a name="ln1536">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; !IsLoading;</a>
<a name="ln1537">        }</a>
<a name="ln1538"> </a>
<a name="ln1539">        private void DeletePrevious_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1540">        {</a>
<a name="ln1541">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; !IsLoading &amp;&amp;</a>
<a name="ln1542">                FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Min(s =&gt; s.Number) &gt; 0;</a>
<a name="ln1543">        }</a>
<a name="ln1544"> </a>
<a name="ln1545">        private void DeleteNext_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1546">        {</a>
<a name="ln1547">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; !IsLoading &amp;&amp;</a>
<a name="ln1548">                FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Max(s =&gt; s.Number) &lt; _viewModel.Frames.Count - 1;</a>
<a name="ln1549">        }</a>
<a name="ln1550"> </a>
<a name="ln1551">        private void Reduce_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1552">        {</a>
<a name="ln1553">            e.CanExecute = FrameListView != null &amp;&amp; !IsLoading &amp;&amp; _viewModel.Frames.Count &gt; 5;</a>
<a name="ln1554">        }</a>
<a name="ln1555"> </a>
<a name="ln1556">        private void RemoveDuplicates_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1557">        {</a>
<a name="ln1558">            e.CanExecute = FrameListView != null &amp;&amp; !IsLoading &amp;&amp; _viewModel.Frames.Count &gt; 1;</a>
<a name="ln1559">        }</a>
<a name="ln1560"> </a>
<a name="ln1561">        private void Delete_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1562">        {</a>
<a name="ln1563">            Pause();</a>
<a name="ln1564"> </a>
<a name="ln1565">            try</a>
<a name="ln1566">            {</a>
<a name="ln1567">                #region Validation</a>
<a name="ln1568"> </a>
<a name="ln1569">                if (Project.Frames.Count == FrameListView.SelectedItems.Count)</a>
<a name="ln1570">                {</a>
<a name="ln1571">                    //If the user wants to delete all frames, discard the project.</a>
<a name="ln1572">                    if (!UserSettings.All.NotifyProjectDiscard ||</a>
<a name="ln1573">                        Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DeleteAll.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DeleteAll.Instruction&quot;), LocalizationHelper.Get(&quot;S.Editor.DeleteAll.Message&quot;), false))</a>
<a name="ln1574">                        Discard(false);</a>
<a name="ln1575"> </a>
<a name="ln1576">                    return;</a>
<a name="ln1577">                }</a>
<a name="ln1578"> </a>
<a name="ln1579">                if (UserSettings.All.NotifyFrameDeletion)</a>
<a name="ln1580">                {</a>
<a name="ln1581">                    if (!Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Instruction&quot;),</a>
<a name="ln1582">                        string.Format(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Message&quot;), FrameListView.SelectedItems.Count)))</a>
<a name="ln1583">                        return;</a>
<a name="ln1584">                }</a>
<a name="ln1585"> </a>
<a name="ln1586">                #endregion</a>
<a name="ln1587"> </a>
<a name="ln1588">                var selected = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().ToList();</a>
<a name="ln1589">                var selectedOrdered = selected.OrderByDescending(x =&gt; x.Number).ToList();</a>
<a name="ln1590">                var list = selectedOrdered.Select(item =&gt; Project.Frames[item.Number]).ToList();</a>
<a name="ln1591"> </a>
<a name="ln1592">                ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, SelectedFramesIndex());</a>
<a name="ln1593"> </a>
<a name="ln1594">                FrameListView.SelectedItem = null;</a>
<a name="ln1595"> </a>
<a name="ln1596">                list.ForEach(x =&gt; File.Delete(x.Path));</a>
<a name="ln1597">                selectedOrdered.ForEach(x =&gt; Project.Frames.RemoveAt(x.Number));</a>
<a name="ln1598">                selectedOrdered.ForEach(x =&gt; _viewModel.Frames.Remove(x));</a>
<a name="ln1599"> </a>
<a name="ln1600">                AdjustFrameNumbers(selectedOrdered.Last().Number);</a>
<a name="ln1601"> </a>
<a name="ln1602">                SelectNear(selectedOrdered.Last().Number);</a>
<a name="ln1603"> </a>
<a name="ln1604">                Project.Persist();</a>
<a name="ln1605">                UpdateStatistics();</a>
<a name="ln1606">                ShowHint(&quot;S.Hint.DeleteFrames&quot;, false, selected.Count);</a>
<a name="ln1607">            }</a>
<a name="ln1608">            catch (Exception ex)</a>
<a name="ln1609">            {</a>
<a name="ln1610">                LogWriter.Log(ex, &quot;Error While Trying to Delete Frames&quot;);</a>
<a name="ln1611"> </a>
<a name="ln1612">                ErrorDialog.Ok(LocalizationHelper.Get(&quot;S.Editor.Title&quot;), &quot;Error while trying to delete frames&quot;, ex.Message, ex);</a>
<a name="ln1613">            }</a>
<a name="ln1614">        }</a>
<a name="ln1615"> </a>
<a name="ln1616">        private void DeletePrevious_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1617">        {</a>
<a name="ln1618">            Pause();</a>
<a name="ln1619"> </a>
<a name="ln1620">            var firstFrame = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Min(x =&gt; x.Number);</a>
<a name="ln1621"> </a>
<a name="ln1622">            if (UserSettings.All.NotifyFrameDeletion)</a>
<a name="ln1623">            {</a>
<a name="ln1624">                if (!Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Instruction&quot;),</a>
<a name="ln1625">                    string.Format(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Message&quot;), firstFrame)))</a>
<a name="ln1626">                    return;</a>
<a name="ln1627">            }</a>
<a name="ln1628"> </a>
<a name="ln1629">            ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, Util.Other.ListOfIndexesOld(0, firstFrame - 1));</a>
<a name="ln1630"> </a>
<a name="ln1631">            for (var index = firstFrame - 1; index &gt;= 0; index--)</a>
<a name="ln1632">                DeleteFrame(index);</a>
<a name="ln1633"> </a>
<a name="ln1634">            AdjustFrameNumbers(0);</a>
<a name="ln1635">            SelectNear(0);</a>
<a name="ln1636"> </a>
<a name="ln1637">            Project.Persist();</a>
<a name="ln1638">            UpdateStatistics();</a>
<a name="ln1639">            ShowHint(&quot;S.Hint.DeleteFrames&quot;, false, firstFrame);</a>
<a name="ln1640">        }</a>
<a name="ln1641"> </a>
<a name="ln1642">        private void DeleteNext_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1643">        {</a>
<a name="ln1644">            Pause();</a>
<a name="ln1645"> </a>
<a name="ln1646">            var lastFrame = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Max(m =&gt; m.Number);</a>
<a name="ln1647">            var count = _viewModel.Frames.Count - lastFrame - 1;</a>
<a name="ln1648"> </a>
<a name="ln1649">            if (UserSettings.All.NotifyFrameDeletion)</a>
<a name="ln1650">            {</a>
<a name="ln1651">                if (!Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Instruction&quot;),</a>
<a name="ln1652">                    string.Format(LocalizationHelper.Get(&quot;S.Editor.DeleteFrames.Message&quot;), count)))</a>
<a name="ln1653">                    return;</a>
<a name="ln1654">            }</a>
<a name="ln1655"> </a>
<a name="ln1656">            var countList = _viewModel.Frames.Count - 1;</a>
<a name="ln1657"> </a>
<a name="ln1658">            ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, Util.Other.ListOfIndexes(lastFrame + 1, count));</a>
<a name="ln1659"> </a>
<a name="ln1660">            //From the end to the start.</a>
<a name="ln1661">            for (var i = countList; i &gt; lastFrame; i--)</a>
<a name="ln1662">                DeleteFrame(i);</a>
<a name="ln1663"> </a>
<a name="ln1664">            SelectNear(lastFrame);</a>
<a name="ln1665"> </a>
<a name="ln1666">            Project.Persist();</a>
<a name="ln1667">            UpdateStatistics();</a>
<a name="ln1668">            ShowHint(&quot;S.Hint.DeleteFrames&quot;, false, count);</a>
<a name="ln1669">        }</a>
<a name="ln1670"> </a>
<a name="ln1671">        private void RemoveDuplicates_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1672">        {</a>
<a name="ln1673">            Pause();</a>
<a name="ln1674">            ShowPanel(PanelTypes.RemoveDuplicates, LocalizationHelper.Get(&quot;S.Editor.Edit.Frames.Duplicates&quot;, true), &quot;Vector.RemoveImage&quot;, ApplyRemoveDuplicatesCountButton_Click);</a>
<a name="ln1675">        }</a>
<a name="ln1676"> </a>
<a name="ln1677">        private async void ApplyRemoveDuplicatesCountButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1678">        {</a>
<a name="ln1679">            Cursor = Cursors.AppStarting;</a>
<a name="ln1680"> </a>
<a name="ln1681">            var index = await Task.Run(() =&gt; RemoveDuplicatesAsync((decimal)UserSettings.All.DuplicatesSimilarity, UserSettings.All.DuplicatesRemoval, UserSettings.All.DuplicatesDelay));</a>
<a name="ln1682"> </a>
<a name="ln1683">            for (var i = _viewModel.Frames.Count - 1; i &gt;= Project.Frames.Count; i--)</a>
<a name="ln1684">                _viewModel.Frames.RemoveAt(i);</a>
<a name="ln1685"> </a>
<a name="ln1686">            SelectNear(LastSelected);</a>
<a name="ln1687">            await Task.Run(() =&gt; Project.Persist());</a>
<a name="ln1688"> </a>
<a name="ln1689">            await LoadSelectedStarter(index, Project.Frames.Count - 1);</a>
<a name="ln1690"> </a>
<a name="ln1691">            ShowHint(&quot;S.Hint.Duplicates&quot;);</a>
<a name="ln1692"> </a>
<a name="ln1693">            ClosePanel();</a>
<a name="ln1694">        }</a>
<a name="ln1695"> </a>
<a name="ln1696">        private void Reduce_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1697">        {</a>
<a name="ln1698">            Pause();</a>
<a name="ln1699">            ShowPanel(PanelTypes.ReduceFrames, LocalizationHelper.Get(&quot;S.Editor.Edit.Frames.Reduce&quot;, true), &quot;Vector.RemoveImage&quot;, ApplyReduceFrameCountButton_Click);</a>
<a name="ln1700">        }</a>
<a name="ln1701"> </a>
<a name="ln1702">        private async void ApplyReduceFrameCountButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1703">        {</a>
<a name="ln1704">            var selected = UserSettings.All.ReduceApplyToAll ? Util.Other.ListOfIndexes(0, Project.Frames.Count - 1) : SelectedFramesIndex();</a>
<a name="ln1705"> </a>
<a name="ln1706">            if (selected.Count == 0)</a>
<a name="ln1707">            {</a>
<a name="ln1708">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Reduce.Warning.NoSelection&quot;));</a>
<a name="ln1709">                return;</a>
<a name="ln1710">            }</a>
<a name="ln1711"> </a>
<a name="ln1712">            //Detects if there's any non-consecutive frames selected.</a>
<a name="ln1713">            if (!selected.All(v =&gt; selected.Contains(v + 1) || v == selected.Last()))</a>
<a name="ln1714">            {</a>
<a name="ln1715">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Reduce.Warning.NonConsecutive&quot;));</a>
<a name="ln1716">                return;</a>
<a name="ln1717">            }</a>
<a name="ln1718"> </a>
<a name="ln1719">            if (selected.Count &lt;= UserSettings.All.ReduceFactor)</a>
<a name="ln1720">            {</a>
<a name="ln1721">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Reduce.Warning.SmallerThanFactor&quot;));</a>
<a name="ln1722">                return;</a>
<a name="ln1723">            }</a>
<a name="ln1724"> </a>
<a name="ln1725">            Cursor = Cursors.AppStarting;</a>
<a name="ln1726"> </a>
<a name="ln1727">            await Task.Run(() =&gt; ReduceFrameCount(selected, UserSettings.All.ReduceFactor, UserSettings.All.ReduceCount, UserSettings.All.ReduceDelay));</a>
<a name="ln1728"> </a>
<a name="ln1729">            for (var i = _viewModel.Frames.Count - 1; i &gt;= Project.Frames.Count; i--)</a>
<a name="ln1730">                _viewModel.Frames.RemoveAt(i);</a>
<a name="ln1731"> </a>
<a name="ln1732">            SelectNear(LastSelected);</a>
<a name="ln1733">            await Task.Run(() =&gt; Project.Persist());</a>
<a name="ln1734"> </a>
<a name="ln1735">            //TODO: Load from the start.</a>
<a name="ln1736">            await LoadSelectedStarter(ReduceFactorIntegerUpDown.Value - 1, Project.Frames.Count - 1);</a>
<a name="ln1737"> </a>
<a name="ln1738">            ShowHint(&quot;S.Hint.Reduce&quot;);</a>
<a name="ln1739"> </a>
<a name="ln1740">            ClosePanel();</a>
<a name="ln1741">        }</a>
<a name="ln1742"> </a>
<a name="ln1743">        private void SmoothLoop_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1744">        {</a>
<a name="ln1745">            Pause();</a>
<a name="ln1746">            ShowPanel(PanelTypes.SmoothLoop, LocalizationHelper.Get(&quot;S.Editor.Edit.Frames.SmoothLoop&quot;, true), &quot;Vector.Repeat&quot;, ApplySmoothLoopButton_Click);</a>
<a name="ln1747">        }</a>
<a name="ln1748"> </a>
<a name="ln1749">        private async void ApplySmoothLoopButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1750">        {</a>
<a name="ln1751">            if (UserSettings.All.SmoothLoopStartThreshold &gt; Project.Frames.Count - 1)</a>
<a name="ln1752">            {</a>
<a name="ln1753">                StatusList.Warning(LocalizationHelper.Get(&quot;S.SmoothLoop.Warning.Threshold&quot;));</a>
<a name="ln1754">                return;</a>
<a name="ln1755">            }</a>
<a name="ln1756"> </a>
<a name="ln1757">            Cursor = Cursors.AppStarting;</a>
<a name="ln1758">            var initialCount = Project.Frames.Count;</a>
<a name="ln1759"> </a>
<a name="ln1760">            var index = await Task.Run(() =&gt; SmoothLoopAsync((decimal)UserSettings.All.SmoothLoopSimilarity, UserSettings.All.SmoothLoopStartThreshold, UserSettings.All.SmoothLoopFrom));</a>
<a name="ln1761"> </a>
<a name="ln1762">            //If nothing changed, it means that no frame was removed.</a>
<a name="ln1763">            if (Project.Frames.Count == initialCount)</a>
<a name="ln1764">            {</a>
<a name="ln1765">                //The reason could be for no loop found or loop already smooth.</a>
<a name="ln1766">                if (index == Project.Frames.Count - 1)</a>
<a name="ln1767">                    StatusList.Info(LocalizationHelper.Get(&quot;S.SmoothLoop.Warning.AlreadySmoothLoop&quot;));</a>
<a name="ln1768">                else</a>
<a name="ln1769">                    StatusList.Warning(LocalizationHelper.Get(&quot;S.SmoothLoop.Warning.NoLoopFound&quot;));</a>
<a name="ln1770"> </a>
<a name="ln1771">                //Workaround for not disabling the CanExecute of the panel.</a>
<a name="ln1772">                _applyAction = ApplySmoothLoopButton_Click;</a>
<a name="ln1773"> </a>
<a name="ln1774">                //Return state of UI.</a>
<a name="ln1775">                Cursor = Cursors.Arrow;</a>
<a name="ln1776">                IsLoading = false;</a>
<a name="ln1777"> </a>
<a name="ln1778">                HideProgress();</a>
<a name="ln1779"> </a>
<a name="ln1780">                CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1781">                return;</a>
<a name="ln1782">            }</a>
<a name="ln1783"> </a>
<a name="ln1784">            for (var i = _viewModel.Frames.Count - 1; i &gt;= Project.Frames.Count; i--)</a>
<a name="ln1785">                _viewModel.Frames.RemoveAt(i);</a>
<a name="ln1786"> </a>
<a name="ln1787">            SelectNear(LastSelected);</a>
<a name="ln1788">            await Task.Run(() =&gt; Project.Persist());</a>
<a name="ln1789"> </a>
<a name="ln1790">            await LoadSelectedStarter(index, Project.Frames.Count - 1);</a>
<a name="ln1791"> </a>
<a name="ln1792">            ClosePanel();</a>
<a name="ln1793">        }</a>
<a name="ln1794"> </a>
<a name="ln1795">        #endregion</a>
<a name="ln1796"> </a>
<a name="ln1797">        #region Reordering</a>
<a name="ln1798"> </a>
<a name="ln1799">        private void Reordering_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1800">        {</a>
<a name="ln1801">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; !IsLoading &amp;&amp; _viewModel.Frames.Count &gt; 1;</a>
<a name="ln1802">        }</a>
<a name="ln1803"> </a>
<a name="ln1804">        private async void Reverse_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1805">        {</a>
<a name="ln1806">            Pause();</a>
<a name="ln1807"> </a>
<a name="ln1808">            ActionStack.SaveState(ActionStack.EditAction.Reorder, Project.Frames.CopyList());</a>
<a name="ln1809"> </a>
<a name="ln1810">            Project.Frames.Reverse();</a>
<a name="ln1811">            await LoadSelectedStarter(0);</a>
<a name="ln1812"> </a>
<a name="ln1813">            ShowHint(&quot;S.Hint.Reverse&quot;);</a>
<a name="ln1814">        }</a>
<a name="ln1815"> </a>
<a name="ln1816">        private async void Yoyo_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1817">        {</a>
<a name="ln1818">            Pause();</a>
<a name="ln1819"> </a>
<a name="ln1820">            ActionStack.SaveState(ActionStack.EditAction.Add, Project.Frames.Count, Project.Frames.Count);</a>
<a name="ln1821"> </a>
<a name="ln1822">            Project.Frames = Util.Other.Yoyo(Project.Frames);</a>
<a name="ln1823">            await LoadSelectedStarter(0);</a>
<a name="ln1824"> </a>
<a name="ln1825">            ShowHint(&quot;S.Hint.Yoyo&quot;);</a>
<a name="ln1826">        }</a>
<a name="ln1827"> </a>
<a name="ln1828">        private void MoveLeft_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1829">        {</a>
<a name="ln1830">            e.Handled = true;</a>
<a name="ln1831"> </a>
<a name="ln1832">            Pause();</a>
<a name="ln1833">            ActionStack.SaveState(ActionStack.EditAction.Reorder, Project.Frames.CopyList());</a>
<a name="ln1834"> </a>
<a name="ln1835">            var selection = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Select(s =&gt;</a>
<a name="ln1836">            {</a>
<a name="ln1837">                var index = _viewModel.Frames.IndexOf(s);</a>
<a name="ln1838">                return (Current: s, CurrentIndex: index, NextIndex: index &gt; 0 ? index - 1 : _viewModel.Frames.Count - 1);</a>
<a name="ln1839">            }).ToList();</a>
<a name="ln1840"> </a>
<a name="ln1841">            //Reorder the frames.</a>
<a name="ln1842">            foreach (var item in selection.OrderBy(o =&gt; o.CurrentIndex))</a>
<a name="ln1843">            {</a>
<a name="ln1844">                if (_viewModel.Frames.IndexOf(item.Current) == item.NextIndex)</a>
<a name="ln1845">                    continue;</a>
<a name="ln1846"> </a>
<a name="ln1847">                _viewModel.Frames.Move(item.CurrentIndex, item.NextIndex);</a>
<a name="ln1848">                Project.Frames.Move(item.CurrentIndex, item.NextIndex);</a>
<a name="ln1849">            }</a>
<a name="ln1850"> </a>
<a name="ln1851">            //Since each frame has a number, upon reordering the numbers must be updated.</a>
<a name="ln1852">            AdjustFrameNumbers(selection.Select(s =&gt; Math.Min(s.CurrentIndex, s.NextIndex)).Min());</a>
<a name="ln1853"> </a>
<a name="ln1854">            FocusOnSelectedFrames();</a>
<a name="ln1855">            ShowHint(&quot;S.Hint.MoveLeft&quot;);</a>
<a name="ln1856">        }</a>
<a name="ln1857"> </a>
<a name="ln1858">        private void MoveRight_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1859">        {</a>
<a name="ln1860">            e.Handled = true;</a>
<a name="ln1861"> </a>
<a name="ln1862">            Pause();</a>
<a name="ln1863">            ActionStack.SaveState(ActionStack.EditAction.Reorder, Project.Frames.CopyList());</a>
<a name="ln1864"> </a>
<a name="ln1865">            var selection = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Select(s =&gt;</a>
<a name="ln1866">            {</a>
<a name="ln1867">                var index = _viewModel.Frames.IndexOf(s);</a>
<a name="ln1868">                return (Current: s, CurrentIndex: index, NextIndex: index &lt; _viewModel.Frames.Count - 1 ? index + 1 : 0);</a>
<a name="ln1869">            }).ToList();</a>
<a name="ln1870"> </a>
<a name="ln1871">            //Reorder the frames.</a>
<a name="ln1872">            foreach (var item in selection.OrderByDescending(o =&gt; o.CurrentIndex))</a>
<a name="ln1873">            {</a>
<a name="ln1874">                if (_viewModel.Frames.IndexOf(item.Current) == item.NextIndex)</a>
<a name="ln1875">                    continue;</a>
<a name="ln1876"> </a>
<a name="ln1877">                _viewModel.Frames.Move(item.CurrentIndex, item.NextIndex);</a>
<a name="ln1878">                Project.Frames.Move(item.CurrentIndex, item.NextIndex);</a>
<a name="ln1879">            }</a>
<a name="ln1880"> </a>
<a name="ln1881">            //Since each frame has a number, upon reordering the numbers must be updated.</a>
<a name="ln1882">            AdjustFrameNumbers(selection.Select(s =&gt; Math.Min(s.CurrentIndex, s.NextIndex)).Min());</a>
<a name="ln1883"> </a>
<a name="ln1884">            FocusOnSelectedFrames();</a>
<a name="ln1885">            ShowHint(&quot;S.Hint.MoveRight&quot;);</a>
<a name="ln1886">        }</a>
<a name="ln1887"> </a>
<a name="ln1888">        #endregion</a>
<a name="ln1889"> </a>
<a name="ln1890">        #region Delay (Duration)</a>
<a name="ln1891"> </a>
<a name="ln1892">        private void OverrideDelay_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1893">        {</a>
<a name="ln1894">            Pause();</a>
<a name="ln1895">            ShowPanel(PanelTypes.OverrideDelay, LocalizationHelper.Get(&quot;S.Editor.Edit.Delay.Override&quot;, true), &quot;Vector.OverrideDelay&quot;, ApplyOverrideDelayButton_Click);</a>
<a name="ln1896">        }</a>
<a name="ln1897"> </a>
<a name="ln1898">        private async void ApplyOverrideDelayButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln1899">        {</a>
<a name="ln1900">            ActionStack.SaveState(ActionStack.EditAction.Properties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln1901"> </a>
<a name="ln1902">            Cursor = Cursors.AppStarting;</a>
<a name="ln1903"> </a>
<a name="ln1904">            await Task.Run(() =&gt; DelayAsync(DelayViewModel.FromSettings(DelayUpdateModes.Override), false, false));</a>
<a name="ln1905"> </a>
<a name="ln1906">            Cursor = Cursors.Arrow;</a>
<a name="ln1907"> </a>
<a name="ln1908">            UpdateStatistics();</a>
<a name="ln1909">            HideProgress();</a>
<a name="ln1910">            IsLoading = false;</a>
<a name="ln1911"> </a>
<a name="ln1912">            ShowHint(&quot;S.Hint.Delay&quot;);</a>
<a name="ln1913"> </a>
<a name="ln1914">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1915">            SetFocusOnCurrentFrame();</a>
<a name="ln1916"> </a>
<a name="ln1917">            ClosePanel();</a>
<a name="ln1918">        }</a>
<a name="ln1919"> </a>
<a name="ln1920"> </a>
<a name="ln1921">        private void IncreaseDecreaseDelay_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1922">        {</a>
<a name="ln1923">            Pause();</a>
<a name="ln1924">            ShowPanel(PanelTypes.IncreaseDecreaseDelay, LocalizationHelper.Get(&quot;S.Editor.Edit.Delay.IncreaseDecrease&quot;, true), &quot;Vector.IncreaseDecreaseDelay&quot;, ApplyIncreaseDecreaseDelayButtonClick);</a>
<a name="ln1925">        }</a>
<a name="ln1926"> </a>
<a name="ln1927">        private async void ApplyIncreaseDecreaseDelayButtonClick(object sender, RoutedEventArgs e)</a>
<a name="ln1928">        {</a>
<a name="ln1929">            if (IncreaseDecreaseDelayIntegerUpDown.Value == 0)</a>
<a name="ln1930">            {</a>
<a name="ln1931">                ClosePanel();</a>
<a name="ln1932">                return;</a>
<a name="ln1933">            }</a>
<a name="ln1934"> </a>
<a name="ln1935">            ActionStack.SaveState(ActionStack.EditAction.Properties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln1936"> </a>
<a name="ln1937">            Cursor = Cursors.AppStarting;</a>
<a name="ln1938"> </a>
<a name="ln1939">            await Task.Run(() =&gt; DelayAsync(DelayViewModel.FromSettings(DelayUpdateModes.IncreaseDecrease), false, false));</a>
<a name="ln1940"> </a>
<a name="ln1941">            Cursor = Cursors.Arrow;</a>
<a name="ln1942"> </a>
<a name="ln1943">            UpdateStatistics();</a>
<a name="ln1944">            HideProgress();</a>
<a name="ln1945">            IsLoading = false;</a>
<a name="ln1946"> </a>
<a name="ln1947">            ShowHint(&quot;S.Hint.Delay&quot;);</a>
<a name="ln1948"> </a>
<a name="ln1949">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1950">            SetFocusOnCurrentFrame();</a>
<a name="ln1951"> </a>
<a name="ln1952">            ClosePanel();</a>
<a name="ln1953">        }</a>
<a name="ln1954"> </a>
<a name="ln1955">        private void ScaleDelay_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln1956">        {</a>
<a name="ln1957">            Pause();</a>
<a name="ln1958">            ShowPanel(PanelTypes.ScaleDelay, LocalizationHelper.Get(&quot;S.Editor.Edit.Delay.Scale&quot;, true), &quot;Vector.ScaleDelay&quot;, ApplyScaleDelayButtonClick);</a>
<a name="ln1959">        }</a>
<a name="ln1960"> </a>
<a name="ln1961">        private async void ApplyScaleDelayButtonClick(object sender, RoutedEventArgs e)</a>
<a name="ln1962">        {</a>
<a name="ln1963">            if (ScaleDelayIntegerUpDown.Value == 0 || ScaleDelayIntegerUpDown.Value == 100)</a>
<a name="ln1964">            {</a>
<a name="ln1965">                ClosePanel();</a>
<a name="ln1966">                return;</a>
<a name="ln1967">            }</a>
<a name="ln1968"> </a>
<a name="ln1969">            ActionStack.SaveState(ActionStack.EditAction.Properties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln1970"> </a>
<a name="ln1971">            Cursor = Cursors.AppStarting;</a>
<a name="ln1972"> </a>
<a name="ln1973">            await Task.Run(() =&gt; DelayAsync(DelayViewModel.FromSettings(DelayUpdateModes.Scale), false, false));</a>
<a name="ln1974"> </a>
<a name="ln1975">            Cursor = Cursors.Arrow;</a>
<a name="ln1976"> </a>
<a name="ln1977">            UpdateStatistics();</a>
<a name="ln1978">            HideProgress();</a>
<a name="ln1979">            IsLoading = false;</a>
<a name="ln1980"> </a>
<a name="ln1981">            ShowHint(&quot;S.Hint.Delay&quot;);</a>
<a name="ln1982"> </a>
<a name="ln1983">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1984">            SetFocusOnCurrentFrame();</a>
<a name="ln1985"> </a>
<a name="ln1986">            ClosePanel();</a>
<a name="ln1987">        }</a>
<a name="ln1988"> </a>
<a name="ln1989">        #endregion</a>
<a name="ln1990"> </a>
<a name="ln1991">        #endregion</a>
<a name="ln1992"> </a>
<a name="ln1993">        #region Image Tab</a>
<a name="ln1994"> </a>
<a name="ln1995">        private void Image_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln1996">        {</a>
<a name="ln1997">            e.CanExecute = FrameListView?.SelectedItem != null &amp;&amp; !IsLoading;</a>
<a name="ln1998">        }</a>
<a name="ln1999"> </a>
<a name="ln2000">        #region Size and Position</a>
<a name="ln2001"> </a>
<a name="ln2002">        private void Resize_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2003">        {</a>
<a name="ln2004">            ShowPanel(PanelTypes.Resize, LocalizationHelper.Get(&quot;S.Editor.Image.Resize&quot;, true), &quot;Vector.Resize&quot;, ApplyResizeButton_Click);</a>
<a name="ln2005">        }</a>
<a name="ln2006"> </a>
<a name="ln2007">        private async void ApplyResizeButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2008">        {</a>
<a name="ln2009">            Pause();</a>
<a name="ln2010"> </a>
<a name="ln2011">            //Checks with the non scaled size.</a>
<a name="ln2012">            var size = Project.Frames[0].Path.ScaledSize();</a>
<a name="ln2013">            var settings = ResizePanel.DataContext as ResizeViewModel;</a>
<a name="ln2014"> </a>
<a name="ln2015">            if (settings == null || Math.Abs(size.Width - settings.Width) &lt; 0.1 &amp;&amp; Math.Abs(size.Height - settings.Height) &lt; 0.1 &amp;&amp; (int)Math.Round(Project.Frames[0].Path.DpiOf()) == (int)Math.Round(settings.Dpi))</a>
<a name="ln2016">            {</a>
<a name="ln2017">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Resize.Warning&quot;));</a>
<a name="ln2018">                return;</a>
<a name="ln2019">            }</a>
<a name="ln2020"> </a>
<a name="ln2021">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2022"> </a>
<a name="ln2023">            Cursor = Cursors.AppStarting;</a>
<a name="ln2024"> </a>
<a name="ln2025">            await Task.Run(() =&gt; Resize(settings.Width, settings.Height, settings.Dpi, settings.ScalingMode));</a>
<a name="ln2026"> </a>
<a name="ln2027">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2028"> </a>
<a name="ln2029">            ClosePanel();</a>
<a name="ln2030"> </a>
<a name="ln2031">            ShowHint(&quot;S.Hint.Resize&quot;);</a>
<a name="ln2032">        }</a>
<a name="ln2033"> </a>
<a name="ln2034"> </a>
<a name="ln2035">        private void Crop_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2036">        {</a>
<a name="ln2037">            Pause();</a>
<a name="ln2038">            ShowPanel(PanelTypes.Crop, LocalizationHelper.Get(&quot;S.Editor.Image.Crop&quot;, true), &quot;Vector.Crop&quot;, ApplyCropButton_Click);</a>
<a name="ln2039">        }</a>
<a name="ln2040"> </a>
<a name="ln2041">        private CroppingAdorner _cropAdorner;</a>
<a name="ln2042">        private FrameworkElement _currentElement = null;</a>
<a name="ln2043">        private bool _resizing = false;</a>
<a name="ln2044"> </a>
<a name="ln2045">        private void AddCropToElement(FrameworkElement fel)</a>
<a name="ln2046">        {</a>
<a name="ln2047">            if (_currentElement != null)</a>
<a name="ln2048">                RemoveCropElements();</a>
<a name="ln2049"> </a>
<a name="ln2050">            var rcInterior = new Rect((int)(fel.Width * 0.2), (int)(fel.Height * 0.2), (int)(fel.Width * 0.6), (int)(fel.Height * 0.6));</a>
<a name="ln2051"> </a>
<a name="ln2052">            var aly = AdornerLayer.GetAdornerLayer(fel);</a>
<a name="ln2053">            _cropAdorner = new CroppingAdorner(fel, rcInterior);</a>
<a name="ln2054">            aly.Add(_cropAdorner);</a>
<a name="ln2055"> </a>
<a name="ln2056">            _cropAdorner.CropChanged += CropChanged;</a>
<a name="ln2057">            _currentElement = fel;</a>
<a name="ln2058"> </a>
<a name="ln2059">            _cropAdorner.Fill = new SolidColorBrush(Color.FromArgb(110, 0, 0, 0));</a>
<a name="ln2060">            RefreshCropImage();</a>
<a name="ln2061">        }</a>
<a name="ln2062"> </a>
<a name="ln2063">        private void RemoveCropElements()</a>
<a name="ln2064">        {</a>
<a name="ln2065">            var aly = AdornerLayer.GetAdornerLayer(_currentElement);</a>
<a name="ln2066">            aly.Remove(_cropAdorner);</a>
<a name="ln2067"> </a>
<a name="ln2068">            _currentElement = null;</a>
<a name="ln2069">            _cropAdorner.CropChanged -= CropChanged;</a>
<a name="ln2070">            _cropAdorner = null;</a>
<a name="ln2071">        }</a>
<a name="ln2072"> </a>
<a name="ln2073">        private void CropChanged(object sender, RoutedEventArgs rea)</a>
<a name="ln2074">        {</a>
<a name="ln2075">            RefreshCropImage();</a>
<a name="ln2076"> </a>
<a name="ln2077">            _resizing = true;</a>
<a name="ln2078"> </a>
<a name="ln2079">            TopCropNumericUpDown.Value = (int)_cropAdorner.ClipRectangle.Top;</a>
<a name="ln2080">            LeftCropNumericUpDown.Value = (int)_cropAdorner.ClipRectangle.Left;</a>
<a name="ln2081">            BottomCropNumericUpDown.Value = (int)_cropAdorner.ClipRectangle.Bottom;</a>
<a name="ln2082">            RightCropNumericUpDown.Value = (int)_cropAdorner.ClipRectangle.Right;</a>
<a name="ln2083"> </a>
<a name="ln2084">            var scale = this.Scale();</a>
<a name="ln2085">            CropSizeTextBlock.Text = $&quot;{(int)Math.Round(_cropAdorner.ClipRectangle.Width * scale)}  {(int)Math.Round(_cropAdorner.ClipRectangle.Height * scale)}&quot;;</a>
<a name="ln2086"> </a>
<a name="ln2087">            _resizing = false;</a>
<a name="ln2088">        }</a>
<a name="ln2089"> </a>
<a name="ln2090">        private void RefreshCropImage()</a>
<a name="ln2091">        {</a>
<a name="ln2092">            if (_cropAdorner == null || Math.Abs(ZoomBoxControl.Zoom - 1) &gt; 0) return;</a>
<a name="ln2093"> </a>
<a name="ln2094">            try</a>
<a name="ln2095">            {</a>
<a name="ln2096">                var rect = new Int32Rect((int)(_cropAdorner.ClipRectangle.X * ZoomBoxControl.ScaleDiff),</a>
<a name="ln2097">                    (int)(_cropAdorner.ClipRectangle.Y * ZoomBoxControl.ScaleDiff),</a>
<a name="ln2098">                    (int)(_cropAdorner.ClipRectangle.Width * ZoomBoxControl.ScaleDiff),</a>
<a name="ln2099">                    (int)(_cropAdorner.ClipRectangle.Height * ZoomBoxControl.ScaleDiff));</a>
<a name="ln2100"> </a>
<a name="ln2101">                if (rect.HasArea)</a>
<a name="ln2102">                    CropImage.Source = (ZoomBoxControl.ImageSource ?? Project.Frames[LastSelected].Path).CropFrom(rect);</a>
<a name="ln2103">            }</a>
<a name="ln2104">            catch (Exception ex)</a>
<a name="ln2105">            {</a>
<a name="ln2106">                LogWriter.Log(ex, &quot;Crop preview&quot;, _cropAdorner.ClipRectangle + &quot; =&gt; &quot; + FrameSize);</a>
<a name="ln2107">            }</a>
<a name="ln2108">        }</a>
<a name="ln2109"> </a>
<a name="ln2110">        private void CropIntegerUpDown_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln2111">        {</a>
<a name="ln2112">            if (_cropAdorner == null)</a>
<a name="ln2113">                return;</a>
<a name="ln2114"> </a>
<a name="ln2115">            if (_resizing)</a>
<a name="ln2116">                return;</a>
<a name="ln2117"> </a>
<a name="ln2118">            var top = TopCropNumericUpDown.Value;</a>
<a name="ln2119">            var left = LeftCropNumericUpDown.Value;</a>
<a name="ln2120">            var bottom = BottomCropNumericUpDown.Value;</a>
<a name="ln2121">            var right = RightCropNumericUpDown.Value;</a>
<a name="ln2122"> </a>
<a name="ln2123">            _cropAdorner.ClipRectangle = new Rect(new Point(left, top), new Point(right, bottom));</a>
<a name="ln2124">        }</a>
<a name="ln2125"> </a>
<a name="ln2126">        private async void ApplyCropButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2127">        {</a>
<a name="ln2128">            Pause();</a>
<a name="ln2129">            RefreshCropImage();</a>
<a name="ln2130"> </a>
<a name="ln2131">            var rect = new Int32Rect((int)Math.Round(_cropAdorner.ClipRectangle.X * ZoomBoxControl.ScaleDiff, MidpointRounding.AwayFromZero),</a>
<a name="ln2132">                (int)Math.Round(_cropAdorner.ClipRectangle.Y * ZoomBoxControl.ScaleDiff, MidpointRounding.AwayFromZero),</a>
<a name="ln2133">                (int)Math.Round(_cropAdorner.ClipRectangle.Width * ZoomBoxControl.ScaleDiff),</a>
<a name="ln2134">                (int)Math.Round(_cropAdorner.ClipRectangle.Height * ZoomBoxControl.ScaleDiff));</a>
<a name="ln2135"> </a>
<a name="ln2136">            if (!rect.HasArea)</a>
<a name="ln2137">            {</a>
<a name="ln2138">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Crop.Warning&quot;));</a>
<a name="ln2139">                return;</a>
<a name="ln2140">            }</a>
<a name="ln2141"> </a>
<a name="ln2142">            if (rect.Width &lt; 10 || rect.Height &lt; 10)</a>
<a name="ln2143">            {</a>
<a name="ln2144">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Crop.Warning.Bigger&quot;));</a>
<a name="ln2145">                return;</a>
<a name="ln2146">            }</a>
<a name="ln2147"> </a>
<a name="ln2148">            if (CropImage.Source == null)</a>
<a name="ln2149">            {</a>
<a name="ln2150">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Crop.Warning&quot;));</a>
<a name="ln2151">                return;</a>
<a name="ln2152">            }</a>
<a name="ln2153"> </a>
<a name="ln2154">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2155"> </a>
<a name="ln2156">            Cursor = Cursors.AppStarting;</a>
<a name="ln2157"> </a>
<a name="ln2158">            await Task.Run(() =&gt; Crop(rect));</a>
<a name="ln2159">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2160"> </a>
<a name="ln2161">            RemoveCropElements();</a>
<a name="ln2162">            ClosePanel();</a>
<a name="ln2163"> </a>
<a name="ln2164">            ShowHint(&quot;S.Hint.Crop&quot;);</a>
<a name="ln2165">        }</a>
<a name="ln2166"> </a>
<a name="ln2167"> </a>
<a name="ln2168">        private void FlipRotate_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2169">        {</a>
<a name="ln2170">            Pause();</a>
<a name="ln2171">            ShowPanel(PanelTypes.FlipRotate, LocalizationHelper.Get(&quot;S.Editor.Image.FlipRotate&quot;, true), &quot;Vector.FlipHorizontal&quot;, ApplyFlipRotateButton_Click);</a>
<a name="ln2172">        }</a>
<a name="ln2173"> </a>
<a name="ln2174">        private async void ApplyFlipRotateButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2175">        {</a>
<a name="ln2176">            Pause();</a>
<a name="ln2177"> </a>
<a name="ln2178">            Cursor = Cursors.AppStarting;</a>
<a name="ln2179"> </a>
<a name="ln2180">            var type = FlipHorizontalRadioButton.IsChecked == true</a>
<a name="ln2181">                ? FlipRotateType.FlipHorizontal : FlipVerticalRadioButton.IsChecked == true</a>
<a name="ln2182">                ? FlipRotateType.FlipVertical : RotateLeftRadioButton.IsChecked == true ?</a>
<a name="ln2183">                  FlipRotateType.RotateLeft90 : FlipRotateType.RotateRight90;</a>
<a name="ln2184"> </a>
<a name="ln2185">            //If it's a rotate operation, the entire list of frames will be altered.</a>
<a name="ln2186">            var selectedIndexes = type == FlipRotateType.RotateLeft90 || type == FlipRotateType.RotateRight90</a>
<a name="ln2187">                ? Util.Other.ListOfIndexes(0, Project.Frames.Count)</a>
<a name="ln2188">                : SelectedFramesIndex();</a>
<a name="ln2189"> </a>
<a name="ln2190">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, selectedIndexes);</a>
<a name="ln2191"> </a>
<a name="ln2192">            await Task.Run(() =&gt; FlipRotate(type));</a>
<a name="ln2193">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2194"> </a>
<a name="ln2195">            ClosePanel();</a>
<a name="ln2196"> </a>
<a name="ln2197">            ShowHint(&quot;S.Hint.FlipRotate&quot;);</a>
<a name="ln2198">        }</a>
<a name="ln2199"> </a>
<a name="ln2200">        #endregion</a>
<a name="ln2201"> </a>
<a name="ln2202">        #region Text</a>
<a name="ln2203"> </a>
<a name="ln2204">        private void Caption_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2205">        {</a>
<a name="ln2206">            Pause();</a>
<a name="ln2207">            ShowPanel(PanelTypes.Caption, LocalizationHelper.Get(&quot;S.Editor.Image.Caption&quot;, true), &quot;Vector.Caption&quot;, ApplyCaptionButton_Click);</a>
<a name="ln2208">        }</a>
<a name="ln2209"> </a>
<a name="ln2210">        private async void ApplyCaptionButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2211">        {</a>
<a name="ln2212">            if (CaptionTextBox.Text.Trim().Length == 0)</a>
<a name="ln2213">            {</a>
<a name="ln2214">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Caption.WarningNoText&quot;));</a>
<a name="ln2215">                return;</a>
<a name="ln2216">            }</a>
<a name="ln2217"> </a>
<a name="ln2218">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2219">            {</a>
<a name="ln2220">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Caption.WarningSelection&quot;));</a>
<a name="ln2221">                return;</a>
<a name="ln2222">            }</a>
<a name="ln2223"> </a>
<a name="ln2224">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2225"> </a>
<a name="ln2226">            var render = CaptionOverlayGrid.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2227"> </a>
<a name="ln2228">            Cursor = Cursors.AppStarting;</a>
<a name="ln2229"> </a>
<a name="ln2230">            var selected = await Task.Run(() =&gt; OverlayAsync(render, false));</a>
<a name="ln2231"> </a>
<a name="ln2232">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2233"> </a>
<a name="ln2234">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2235"> </a>
<a name="ln2236">            ClosePanel();</a>
<a name="ln2237">        }</a>
<a name="ln2238"> </a>
<a name="ln2239"> </a>
<a name="ln2240">        private void FreeText_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2241">        {</a>
<a name="ln2242">            Pause();</a>
<a name="ln2243">            ShowPanel(PanelTypes.FreeText, LocalizationHelper.Get(&quot;S.Editor.Image.FreeText&quot;, true), &quot;Vector.FreeText&quot;, ApplyFreeTextButton_Click);</a>
<a name="ln2244">        }</a>
<a name="ln2245"> </a>
<a name="ln2246">        private void FreeTextTextBox_TextChanged(object sender, TextChangedEventArgs e)</a>
<a name="ln2247">        {</a>
<a name="ln2248">            if (!IsLoaded)</a>
<a name="ln2249">                return;</a>
<a name="ln2250"> </a>
<a name="ln2251">            //TODO: This event is not fired when the entire text is deleted.</a>
<a name="ln2252"> </a>
<a name="ln2253">            FreeTextOverlayControl.AdjustContent();</a>
<a name="ln2254">        }</a>
<a name="ln2255"> </a>
<a name="ln2256">        private async void ApplyFreeTextButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2257">        {</a>
<a name="ln2258">            if (FreeTextTextBox.Text.Length == 0)</a>
<a name="ln2259">            {</a>
<a name="ln2260">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Caption.WarningNoText&quot;));</a>
<a name="ln2261">                return;</a>
<a name="ln2262">            }</a>
<a name="ln2263"> </a>
<a name="ln2264">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2265">            {</a>
<a name="ln2266">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.FreeText.WarningSelection&quot;));</a>
<a name="ln2267">                return;</a>
<a name="ln2268">            }</a>
<a name="ln2269"> </a>
<a name="ln2270">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2271"> </a>
<a name="ln2272">            FreeTextOverlayControl.CanMove = false;</a>
<a name="ln2273"> </a>
<a name="ln2274">            var render = FreeTextOverlayControl.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2275"> </a>
<a name="ln2276">            FreeTextOverlayControl.CanMove = true;</a>
<a name="ln2277"> </a>
<a name="ln2278">            Cursor = Cursors.AppStarting;</a>
<a name="ln2279"> </a>
<a name="ln2280">            var selected = await Task.Run(() =&gt; OverlayAsync(render, false));</a>
<a name="ln2281"> </a>
<a name="ln2282">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2283"> </a>
<a name="ln2284">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2285"> </a>
<a name="ln2286">            ClosePanel();</a>
<a name="ln2287">        }</a>
<a name="ln2288"> </a>
<a name="ln2289"> </a>
<a name="ln2290">        private void TitleFrame_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2291">        {</a>
<a name="ln2292">            Pause();</a>
<a name="ln2293">            ShowPanel(PanelTypes.TitleFrame, LocalizationHelper.Get(&quot;S.Editor.Image.TitleFrame&quot;, true), &quot;Vector.TitleFrame&quot;, ApplyTitleFrameButton_Click);</a>
<a name="ln2294">        }</a>
<a name="ln2295"> </a>
<a name="ln2296">        private async void ApplyTitleFrameButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2297">        {</a>
<a name="ln2298">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2299">            {</a>
<a name="ln2300">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.TitleFrame.WarningSelection&quot;));</a>
<a name="ln2301">                return;</a>
<a name="ln2302">            }</a>
<a name="ln2303"> </a>
<a name="ln2304">            ActionStack.SaveState(ActionStack.EditAction.Add, FrameListView.SelectedIndex, 1);</a>
<a name="ln2305"> </a>
<a name="ln2306">            var render = TitleFrameOverlayGrid.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2307"> </a>
<a name="ln2308">            Cursor = Cursors.AppStarting;</a>
<a name="ln2309"> </a>
<a name="ln2310">            var index = FrameListView.SelectedIndex;</a>
<a name="ln2311">            var dpi = ZoomBoxControl.ImageDpi;</a>
<a name="ln2312">            var selected = await Task.Run(() =&gt; TitleFrame(render, index, dpi));</a>
<a name="ln2313"> </a>
<a name="ln2314">            await LoadSelectedStarter(selected, Project.Frames.Count - 1);</a>
<a name="ln2315"> </a>
<a name="ln2316">            ClosePanel();</a>
<a name="ln2317">        }</a>
<a name="ln2318"> </a>
<a name="ln2319"> </a>
<a name="ln2320">        private void KeyStrokes_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2321">        {</a>
<a name="ln2322">            Pause();</a>
<a name="ln2323">            ShowPanel(PanelTypes.KeyStrokes, LocalizationHelper.Get(&quot;S.Editor.Image.KeyStrokes&quot;, true), &quot;Vector.Keyboard&quot;, ApplyKeyStrokesButton_Click);</a>
<a name="ln2324">        }</a>
<a name="ln2325"> </a>
<a name="ln2326">        private void EditKeyStrokesButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2327">        {</a>
<a name="ln2328">            var keyStrokes = new KeyStrokes</a>
<a name="ln2329">            {</a>
<a name="ln2330">                InternalList = new ObservableCollection&lt;FrameInfo&gt;(Project.Frames.CopyList())</a>
<a name="ln2331">            };</a>
<a name="ln2332"> </a>
<a name="ln2333">            var result = keyStrokes.ShowDialog();</a>
<a name="ln2334"> </a>
<a name="ln2335">            if (!result.HasValue || !result.Value)</a>
<a name="ln2336">                return;</a>
<a name="ln2337"> </a>
<a name="ln2338">            ActionStack.SaveState(ActionStack.EditAction.Properties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2339"> </a>
<a name="ln2340">            for (var i = 0; i &lt; keyStrokes.InternalList.Count; i++)</a>
<a name="ln2341">                Project.Frames[i].KeyList = new List&lt;IKeyGesture&gt;(keyStrokes.InternalList[i].KeyList);</a>
<a name="ln2342">        }</a>
<a name="ln2343"> </a>
<a name="ln2344">        private async void ApplyKeyStrokesButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2345">        {</a>
<a name="ln2346">            if (!Project.Frames.Any(x =&gt; x.KeyList != null &amp;&amp; x.KeyList.Any()))</a>
<a name="ln2347">            {</a>
<a name="ln2348">                StatusList.Warning(LocalizationHelper.Get(&quot;S.KeyStrokes.Warning.None&quot;));</a>
<a name="ln2349">                return;</a>
<a name="ln2350">            }</a>
<a name="ln2351"> </a>
<a name="ln2352">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2353"> </a>
<a name="ln2354">            Cursor = Cursors.AppStarting;</a>
<a name="ln2355"> </a>
<a name="ln2356">            await Task.Run(() =&gt; KeyStrokesAsync(KeyStrokesViewModel.FromSettings()));</a>
<a name="ln2357"> </a>
<a name="ln2358">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2359"> </a>
<a name="ln2360">            ClosePanel();</a>
<a name="ln2361">        }</a>
<a name="ln2362"> </a>
<a name="ln2363">        #endregion</a>
<a name="ln2364"> </a>
<a name="ln2365">        #region Overlay</a>
<a name="ln2366"> </a>
<a name="ln2367">        private void FreeDrawing_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2368">        {</a>
<a name="ln2369">            Pause();</a>
<a name="ln2370">            ShowPanel(PanelTypes.FreeDrawing, LocalizationHelper.Get(&quot;S.Editor.Image.FreeDrawing&quot;, true), &quot;Vector.FreeDrawing&quot;, ApplyFreeDrawingButton_Click);</a>
<a name="ln2371">        }</a>
<a name="ln2372"> </a>
<a name="ln2373">        private async void ApplyFreeDrawingButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2374">        {</a>
<a name="ln2375">            if (FreeDrawingInkCanvas.Strokes.Count == 0)</a>
<a name="ln2376">            {</a>
<a name="ln2377">                StatusList.Warning(LocalizationHelper.Get(&quot;S.FreeDrawing.Warning.NoDrawing&quot;));</a>
<a name="ln2378">                return;</a>
<a name="ln2379">            }</a>
<a name="ln2380"> </a>
<a name="ln2381">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2382">            {</a>
<a name="ln2383">                StatusList.Warning(LocalizationHelper.Get(&quot;S.FreeDrawing.WarningSelection&quot;));</a>
<a name="ln2384">                return;</a>
<a name="ln2385">            }</a>
<a name="ln2386"> </a>
<a name="ln2387">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2388"> </a>
<a name="ln2389">            var render = FreeDrawingInkCanvas.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2390"> </a>
<a name="ln2391">            Cursor = Cursors.AppStarting;</a>
<a name="ln2392"> </a>
<a name="ln2393">            FreeDrawingInkCanvas.Strokes.Clear();</a>
<a name="ln2394"> </a>
<a name="ln2395">            var selected = await Task.Run(() =&gt; OverlayAsync(render, false));</a>
<a name="ln2396"> </a>
<a name="ln2397">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2398"> </a>
<a name="ln2399">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2400"> </a>
<a name="ln2401">            ClosePanel();</a>
<a name="ln2402">        }</a>
<a name="ln2403"> </a>
<a name="ln2404"> </a>
<a name="ln2405">        private void Shapes_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2406">        {</a>
<a name="ln2407">            Pause();</a>
<a name="ln2408">            ShowPanel(PanelTypes.Shapes, LocalizationHelper.Get(&quot;S.Editor.Image.Shape&quot;, true), &quot;Vector.Ellipse&quot;, ApplyShapesButton_Click);</a>
<a name="ln2409">        }</a>
<a name="ln2410"> </a>
<a name="ln2411">        private void ShapeModes_Checked(object sender, RoutedEventArgs e)</a>
<a name="ln2412">        {</a>
<a name="ln2413">            ShapeDrawingCanvas.DrawingMode = AddModeRadioButton.IsChecked == true ? DrawingCanvas.DrawingModes.Shape : DrawingCanvas.DrawingModes.Select;</a>
<a name="ln2414">        }</a>
<a name="ln2415"> </a>
<a name="ln2416">        private void ShapeType_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln2417">        {</a>
<a name="ln2418">            if (!(sender is ListBox listBox))</a>
<a name="ln2419">                return;</a>
<a name="ln2420"> </a>
<a name="ln2421">            switch (listBox.SelectedIndex)</a>
<a name="ln2422">            {</a>
<a name="ln2423">                case 0:</a>
<a name="ln2424">                    ShapeDrawingCanvas.CurrentShape = DrawingCanvas.Shapes.Rectangle;</a>
<a name="ln2425">                    break;</a>
<a name="ln2426">                case 1:</a>
<a name="ln2427">                    ShapeDrawingCanvas.CurrentShape = DrawingCanvas.Shapes.Ellipse;</a>
<a name="ln2428">                    break;</a>
<a name="ln2429">                case 2:</a>
<a name="ln2430">                    ShapeDrawingCanvas.CurrentShape = DrawingCanvas.Shapes.Triangle;</a>
<a name="ln2431">                    break;</a>
<a name="ln2432">                case 3:</a>
<a name="ln2433">                    ShapeDrawingCanvas.CurrentShape = DrawingCanvas.Shapes.Arrow;</a>
<a name="ln2434">                    break;</a>
<a name="ln2435">            }</a>
<a name="ln2436">        }</a>
<a name="ln2437"> </a>
<a name="ln2438">        private void ShapeProperties_Changed(object sender, RoutedEventArgs e)</a>
<a name="ln2439">        {</a>
<a name="ln2440">            if (!IsLoaded)</a>
<a name="ln2441">                return;</a>
<a name="ln2442"> </a>
<a name="ln2443">            ShapeDrawingCanvas.StrokeThickness = ShapeOutlineDoubleUpDown.Value;</a>
<a name="ln2444">            ShapeDrawingCanvas.Stroke = ShapeOutlineColorBox.SelectedBrush;</a>
<a name="ln2445">            ShapeDrawingCanvas.Radius = ShapeRadiusDoubleUpDown.Value;</a>
<a name="ln2446">            ShapeDrawingCanvas.Fill = ShapesFillColorBox.SelectedBrush;</a>
<a name="ln2447">        }</a>
<a name="ln2448"> </a>
<a name="ln2449">        private async void ApplyShapesButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2450">        {</a>
<a name="ln2451">            if (ShapeDrawingCanvas.ShapesCount == 0)</a>
<a name="ln2452">            {</a>
<a name="ln2453">                StatusList.Warning(LocalizationHelper.Get(&quot;S.FreeDrawing.Warning.NoDrawing&quot;));</a>
<a name="ln2454">                return;</a>
<a name="ln2455">            }</a>
<a name="ln2456"> </a>
<a name="ln2457">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2458">            {</a>
<a name="ln2459">                StatusList.Warning(LocalizationHelper.Get(&quot;S.FreeDrawing.WarningSelection&quot;));</a>
<a name="ln2460">                return;</a>
<a name="ln2461">            }</a>
<a name="ln2462"> </a>
<a name="ln2463">            ShapeDrawingCanvas.DeselectAll();</a>
<a name="ln2464"> </a>
<a name="ln2465">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2466"> </a>
<a name="ln2467">            var render = ShapeDrawingCanvas.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2468"> </a>
<a name="ln2469">            Cursor = Cursors.AppStarting;</a>
<a name="ln2470"> </a>
<a name="ln2471">            ShapeDrawingCanvas.RemoveAllShapes();</a>
<a name="ln2472"> </a>
<a name="ln2473">            var selected = await Task.Run(() =&gt; OverlayAsync(render, false));</a>
<a name="ln2474"> </a>
<a name="ln2475">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2476"> </a>
<a name="ln2477">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2478"> </a>
<a name="ln2479">            ClosePanel();</a>
<a name="ln2480">        }</a>
<a name="ln2481"> </a>
<a name="ln2482"> </a>
<a name="ln2483">        private void MouseEvents_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2484">        {</a>
<a name="ln2485">            Pause();</a>
<a name="ln2486">            ShowPanel(PanelTypes.MouseEvents, LocalizationHelper.Get(&quot;S.Editor.Image.MouseEvents&quot;, true), &quot;Vector.Cursor&quot;, ApplyMouseEventsButton_Click);</a>
<a name="ln2487">        }</a>
<a name="ln2488"> </a>
<a name="ln2489">        private async void ApplyMouseEventsButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2490">        {</a>
<a name="ln2491">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2492"> </a>
<a name="ln2493">            Cursor = Cursors.AppStarting;</a>
<a name="ln2494"> </a>
<a name="ln2495">            await Task.Run(() =&gt; MouseEventsAsync(MouseEventsViewModel.FromSettings()));</a>
<a name="ln2496"> </a>
<a name="ln2497">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2498"> </a>
<a name="ln2499">            ClosePanel();</a>
<a name="ln2500">        }</a>
<a name="ln2501"> </a>
<a name="ln2502"> </a>
<a name="ln2503">        private void Watermark_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2504">        {</a>
<a name="ln2505">            Pause();</a>
<a name="ln2506">            ShowPanel(PanelTypes.Watermark, LocalizationHelper.Get(&quot;S.Editor.Image.Watermark&quot;, true), &quot;Vector.Watermark&quot;, ApplyWatermarkButton_Click);</a>
<a name="ln2507"> </a>
<a name="ln2508">            TopWatermarkDoubleUpDown.Scale = LeftWatermarkDoubleUpDown.Scale = this.Scale();</a>
<a name="ln2509">            TopWatermarkDoubleUpDown.Value = UserSettings.All.WatermarkTop;</a>
<a name="ln2510">            LeftWatermarkDoubleUpDown.Value = UserSettings.All.WatermarkLeft;</a>
<a name="ln2511"> </a>
<a name="ln2512">            if (string.IsNullOrEmpty(UserSettings.All.WatermarkFilePath))</a>
<a name="ln2513">            {</a>
<a name="ln2514">                if (TopWatermarkDoubleUpDown.Value &lt; 0)</a>
<a name="ln2515">                    TopWatermarkDoubleUpDown.Value = 0;</a>
<a name="ln2516"> </a>
<a name="ln2517">                if (LeftWatermarkDoubleUpDown.Value &lt; 0)</a>
<a name="ln2518">                    LeftWatermarkDoubleUpDown.Value = 0;</a>
<a name="ln2519">            }</a>
<a name="ln2520">        }</a>
<a name="ln2521"> </a>
<a name="ln2522">        private void SelectWatermark_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2523">        {</a>
<a name="ln2524">            var ofd = new OpenFileDialog</a>
<a name="ln2525">            {</a>
<a name="ln2526">                AddExtension = true,</a>
<a name="ln2527">                CheckFileExists = true,</a>
<a name="ln2528">                Title = LocalizationHelper.Get(&quot;S.Watermark.Select&quot;, true),</a>
<a name="ln2529">                Filter = $&quot;{LocalizationHelper.Get(&quot;S.Editor.File.Image&quot;)} (*.bmp, *.jpg, *.jpeg, *.png)|*.bmp;*.jpg;*.jpeg;*.png&quot;,</a>
<a name="ln2530">            };</a>
<a name="ln2531"> </a>
<a name="ln2532">            var result = ofd.ShowDialog();</a>
<a name="ln2533"> </a>
<a name="ln2534">            if (!result.HasValue || !result.Value)</a>
<a name="ln2535">                return;</a>
<a name="ln2536"> </a>
<a name="ln2537">            UserSettings.All.WatermarkFilePath = ofd.FileName;</a>
<a name="ln2538">            UserSettings.All.WatermarkSize = 1;</a>
<a name="ln2539"> </a>
<a name="ln2540">            WatermarkOverlayCanvas.AdjustContent();</a>
<a name="ln2541">        }</a>
<a name="ln2542"> </a>
<a name="ln2543">        private async void ApplyWatermarkButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2544">        {</a>
<a name="ln2545">            if (string.IsNullOrEmpty(UserSettings.All.WatermarkFilePath) || !File.Exists(UserSettings.All.WatermarkFilePath))</a>
<a name="ln2546">            {</a>
<a name="ln2547">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Watermark.WarningNoImage&quot;));</a>
<a name="ln2548">                return;</a>
<a name="ln2549">            }</a>
<a name="ln2550"> </a>
<a name="ln2551">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2552">            {</a>
<a name="ln2553">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Watermark.WarningSelection&quot;));</a>
<a name="ln2554">                return;</a>
<a name="ln2555">            }</a>
<a name="ln2556"> </a>
<a name="ln2557">            UserSettings.All.WatermarkTop = TopWatermarkDoubleUpDown.Value;</a>
<a name="ln2558">            UserSettings.All.WatermarkLeft = LeftWatermarkDoubleUpDown.Value;</a>
<a name="ln2559"> </a>
<a name="ln2560">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2561"> </a>
<a name="ln2562">            WatermarkOverlayCanvas.CanMove = false;</a>
<a name="ln2563">            WatermarkOverlayCanvas.CanResize = false;</a>
<a name="ln2564"> </a>
<a name="ln2565">            var render = WatermarkOverlayCanvas.GetScaledRender(ZoomBoxControl.ScaleDiff, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2566"> </a>
<a name="ln2567">            WatermarkOverlayCanvas.CanMove = true;</a>
<a name="ln2568">            WatermarkOverlayCanvas.CanResize = true;</a>
<a name="ln2569"> </a>
<a name="ln2570">            #region Remove adorners</a>
<a name="ln2571"> </a>
<a name="ln2572">            var adornerLayer = AdornerLayer.GetAdornerLayer(WatermarkImage);</a>
<a name="ln2573"> </a>
<a name="ln2574">            //Remove all the adorners.</a>
<a name="ln2575">            foreach (var adorner in (adornerLayer.GetAdorners(WatermarkImage) ?? new Adorner[0]).OfType&lt;ResizingAdorner&gt;())</a>
<a name="ln2576">            {</a>
<a name="ln2577">                adorner.Destroy();</a>
<a name="ln2578">                adornerLayer.Remove(adorner);</a>
<a name="ln2579">            }</a>
<a name="ln2580"> </a>
<a name="ln2581">            #endregion</a>
<a name="ln2582"> </a>
<a name="ln2583">            Cursor = Cursors.AppStarting;</a>
<a name="ln2584"> </a>
<a name="ln2585">            var selected = await Task.Run(() =&gt; OverlayAsync(render, false));</a>
<a name="ln2586"> </a>
<a name="ln2587">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2588"> </a>
<a name="ln2589">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2590"> </a>
<a name="ln2591">            ClosePanel();</a>
<a name="ln2592">        }</a>
<a name="ln2593"> </a>
<a name="ln2594"> </a>
<a name="ln2595">        private void Border_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2596">        {</a>
<a name="ln2597">            Pause();</a>
<a name="ln2598">            ShowPanel(PanelTypes.Border, LocalizationHelper.Get(&quot;S.Editor.Image.Border&quot;, true), &quot;Vector.Border&quot;, ApplyBorderButton_Click);</a>
<a name="ln2599">        }</a>
<a name="ln2600"> </a>
<a name="ln2601">        private void BorderProperties_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln2602">        {</a>
<a name="ln2603">            try</a>
<a name="ln2604">            {</a>
<a name="ln2605">                if (CaptionOverlayGrid.Width &lt; 0)</a>
<a name="ln2606">                    return;</a>
<a name="ln2607"> </a>
<a name="ln2608">                //Measure the border size.</a>
<a name="ln2609">                var left = Math.Min(0, UserSettings.All.BorderLeftThickness);</a>
<a name="ln2610">                var top = Math.Min(0, UserSettings.All.BorderTopThickness);</a>
<a name="ln2611">                var right = Math.Min(0, UserSettings.All.BorderRightThickness);</a>
<a name="ln2612">                var bottom = Math.Min(0, UserSettings.All.BorderBottomThickness);</a>
<a name="ln2613">                var width = CaptionOverlayGrid.Width + Math.Abs(left) + +Math.Abs(right);</a>
<a name="ln2614">                var height = CaptionOverlayGrid.Height + Math.Abs(top) + Math.Abs(bottom);</a>
<a name="ln2615"> </a>
<a name="ln2616">                BorderBehindOverlayBorder.Width = width;</a>
<a name="ln2617">                BorderBehindOverlayBorder.Height = height;</a>
<a name="ln2618">                BorderPreviewGrid.Margin = new Thickness(left, top, right, bottom);</a>
<a name="ln2619">            }</a>
<a name="ln2620">            catch (Exception ex)</a>
<a name="ln2621">            {</a>
<a name="ln2622">                LogWriter.Log(ex, &quot;Error while trying to measure dropshadow size.&quot;);</a>
<a name="ln2623">            }</a>
<a name="ln2624">        }</a>
<a name="ln2625"> </a>
<a name="ln2626">        private async void ApplyBorderButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2627">        {</a>
<a name="ln2628">            var model = BorderViewModel.FromSettings(true);</a>
<a name="ln2629"> </a>
<a name="ln2630">            if (Math.Abs(model.LeftThickness) &lt; 0.001 &amp;&amp; Math.Abs(model.TopThickness) &lt; 0.001 &amp;&amp; Math.Abs(model.RightThickness) &lt; 0.001 &amp;&amp; Math.Abs(model.BottomThickness) &lt; 0.001)</a>
<a name="ln2631">            {</a>
<a name="ln2632">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Border.WarningThickness&quot;));</a>
<a name="ln2633">                return;</a>
<a name="ln2634">            }</a>
<a name="ln2635"> </a>
<a name="ln2636">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2637">            {</a>
<a name="ln2638">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Border.WarningSelection&quot;));</a>
<a name="ln2639">                return;</a>
<a name="ln2640">            }</a>
<a name="ln2641"> </a>
<a name="ln2642">            if (model.LeftThickness &lt; 0 || model.TopThickness &lt; 0 || model.RightThickness &lt; 0 || model.BottomThickness &lt; 0)</a>
<a name="ln2643">                ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2644">            else</a>
<a name="ln2645">                ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2646"> </a>
<a name="ln2647">            Cursor = Cursors.AppStarting;</a>
<a name="ln2648"> </a>
<a name="ln2649">            await Task.Run(() =&gt; BorderAsync(model));</a>
<a name="ln2650"> </a>
<a name="ln2651">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2652"> </a>
<a name="ln2653">            ClosePanel();</a>
<a name="ln2654">        }</a>
<a name="ln2655"> </a>
<a name="ln2656"> </a>
<a name="ln2657">        private void Shadow_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2658">        {</a>
<a name="ln2659">            Pause();</a>
<a name="ln2660">            ShowPanel(PanelTypes.Shadow, LocalizationHelper.Get(&quot;S.Editor.Image.Shadow&quot;, true), &quot;Vector.Shadow&quot;, ApplyShadowButton_Click);</a>
<a name="ln2661">        }</a>
<a name="ln2662"> </a>
<a name="ln2663">        private void ShadowProperties_ValueChanged(object sender, RoutedEventArgs e)</a>
<a name="ln2664">        {</a>
<a name="ln2665">            try</a>
<a name="ln2666">            {</a>
<a name="ln2667">                if (CaptionOverlayGrid.Width &lt; 0)</a>
<a name="ln2668">                    return;</a>
<a name="ln2669"> </a>
<a name="ln2670">                //Converts the direction in degrees to radians.</a>
<a name="ln2671">                var radians = Math.PI / 180.0 * UserSettings.All.ShadowDirection;</a>
<a name="ln2672">                var offsetX = UserSettings.All.ShadowDepth * Math.Cos(radians);</a>
<a name="ln2673">                var offsetY = UserSettings.All.ShadowDepth * Math.Sin(radians);</a>
<a name="ln2674"> </a>
<a name="ln2675">                //Each side can have a different offset based on the direction of the shadow.</a>
<a name="ln2676">                var offsetLeft = offsetX &lt; 0 ? offsetX * -1 : 0;</a>
<a name="ln2677">                var offsetTop = offsetY &gt; 0 ? offsetY : 0;</a>
<a name="ln2678">                var offsetRight = offsetX &gt; 0 ? offsetX : 0;</a>
<a name="ln2679">                var offsetBottom = offsetY &lt; 0 ? offsetY * -1 : 0;</a>
<a name="ln2680"> </a>
<a name="ln2681">                //Measure drop shadow space.</a>
<a name="ln2682">                var marginLeft = offsetLeft &gt; 0 ? offsetLeft + UserSettings.All.ShadowBlurRadius / 2d : Math.Max(UserSettings.All.ShadowBlurRadius / 2d - offsetLeft, 0); //- offsetX</a>
<a name="ln2683">                var marginTop = offsetTop &gt; 0 ? offsetTop + UserSettings.All.ShadowBlurRadius / 2d : Math.Max(UserSettings.All.ShadowBlurRadius / 2d - offsetTop, 0); //- offsetY</a>
<a name="ln2684">                var marginRight = offsetRight &gt; 0 ? offsetRight + UserSettings.All.ShadowBlurRadius / 2d : Math.Max(UserSettings.All.ShadowBlurRadius / 2d + offsetRight, 0); //+ offsetX</a>
<a name="ln2685">                var marginBottom = offsetBottom &gt; 0 ? offsetBottom + UserSettings.All.ShadowBlurRadius / 2d : Math.Max(UserSettings.All.ShadowBlurRadius / 2d + offsetBottom, 0); //+ offsetY</a>
<a name="ln2686"> </a>
<a name="ln2687">                ShadowPreviewGrid.Width = marginLeft + CaptionOverlayGrid.Width + marginRight;</a>
<a name="ln2688">                ShadowPreviewGrid.Height = Math.Round(marginTop + CaptionOverlayGrid.Height + marginBottom, 0);</a>
<a name="ln2689"> </a>
<a name="ln2690">                ShadowPreviewGrid.Margin = new Thickness(marginRight - marginLeft, marginBottom - marginTop, 0, 0);</a>
<a name="ln2691">                ShadowInternalGrid.Margin = new Thickness(marginLeft, marginTop, marginRight, marginBottom);</a>
<a name="ln2692"> </a>
<a name="ln2693">                ShadowInternalGrid.InvalidateVisual();</a>
<a name="ln2694">                ShadowPreviewGrid.InvalidateVisual();</a>
<a name="ln2695">                ShadowInternalGrid.InvalidateProperty(EffectProperty);</a>
<a name="ln2696">            }</a>
<a name="ln2697">            catch (Exception ex)</a>
<a name="ln2698">            {</a>
<a name="ln2699">                LogWriter.Log(ex, &quot;Error while trying to measure dropshadow size for the previewer.&quot;);</a>
<a name="ln2700">            }</a>
<a name="ln2701">        }</a>
<a name="ln2702"> </a>
<a name="ln2703">        private async void ApplyShadowButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2704">        {</a>
<a name="ln2705">            var model = ShadowViewModel.FromSettings();</a>
<a name="ln2706"> </a>
<a name="ln2707">            if (Math.Abs(model.Depth) &lt; 0.1 &amp;&amp; Math.Abs(model.BlurRadius) &lt; 0.1)</a>
<a name="ln2708">            {</a>
<a name="ln2709">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Shadow.Warning.Behind&quot;));</a>
<a name="ln2710">                return;</a>
<a name="ln2711">            }</a>
<a name="ln2712"> </a>
<a name="ln2713">            if (Math.Abs(model.Opacity) &lt; 0.1)</a>
<a name="ln2714">            {</a>
<a name="ln2715">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Shadow.Warning.Invisible&quot;));</a>
<a name="ln2716">                return;</a>
<a name="ln2717">            }</a>
<a name="ln2718"> </a>
<a name="ln2719">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2720"> </a>
<a name="ln2721">            Cursor = Cursors.AppStarting;</a>
<a name="ln2722"> </a>
<a name="ln2723">            await Task.Run(() =&gt; ShadowAsync(model));</a>
<a name="ln2724"> </a>
<a name="ln2725">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2726"> </a>
<a name="ln2727">            ClosePanel();</a>
<a name="ln2728">        }</a>
<a name="ln2729"> </a>
<a name="ln2730"> </a>
<a name="ln2731">        private void Obfuscate_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2732">        {</a>
<a name="ln2733">            Pause();</a>
<a name="ln2734">            ShowPanel(PanelTypes.Obfuscate, LocalizationHelper.Get(&quot;S.Editor.Image.Obfuscate&quot;, true), &quot;Vector.Obfuscate&quot;, ApplyObfuscateButton_Click);</a>
<a name="ln2735">        }</a>
<a name="ln2736"> </a>
<a name="ln2737">        private async void ApplyObfuscateButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2738">        {</a>
<a name="ln2739">            if (ObfuscateOverlaySelectControl.Selected.IsEmpty)</a>
<a name="ln2740">            {</a>
<a name="ln2741">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Obfuscate.Warning&quot;));</a>
<a name="ln2742">                return;</a>
<a name="ln2743">            }</a>
<a name="ln2744"> </a>
<a name="ln2745">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, SelectedFramesIndex());</a>
<a name="ln2746"> </a>
<a name="ln2747">            Cursor = Cursors.AppStarting;</a>
<a name="ln2748"> </a>
<a name="ln2749">            var region = ObfuscateOverlaySelectControl.Selected;</a>
<a name="ln2750">            var scale = this.Scale();</a>
<a name="ln2751">            var selected = await Task.Run(() =&gt; ObfuscateAsync(region, scale, false));</a>
<a name="ln2752"> </a>
<a name="ln2753">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2754"> </a>
<a name="ln2755">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2756"> </a>
<a name="ln2757">            ClosePanel();</a>
<a name="ln2758">        }</a>
<a name="ln2759"> </a>
<a name="ln2760"> </a>
<a name="ln2761">        private void Cinemagraph_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2762">        {</a>
<a name="ln2763">            Pause();</a>
<a name="ln2764">            ShowPanel(PanelTypes.Cinemagraph, LocalizationHelper.Get(&quot;S.Editor.Image.Cinemagraph&quot;, true), &quot;Vector.Cinemagraph&quot;, ApplyCinemagraphButton_Click);</a>
<a name="ln2765">        }</a>
<a name="ln2766"> </a>
<a name="ln2767">        private async void ApplyCinemagraphButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2768">        {</a>
<a name="ln2769">            if (CinemagraphInkCanvas.Strokes.Count == 0)</a>
<a name="ln2770">            {</a>
<a name="ln2771">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Cinemagraph.WarningNoDrawing&quot;));</a>
<a name="ln2772">                return;</a>
<a name="ln2773">            }</a>
<a name="ln2774"> </a>
<a name="ln2775">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2776"> </a>
<a name="ln2777">            #region Get the Strokes and Clip the Image</a>
<a name="ln2778"> </a>
<a name="ln2779">            var image = Project.Frames[0].Path.SourceFrom();</a>
<a name="ln2780">            var rectangle = new RectangleGeometry(new Rect(new Point(0, 0), new Size(image.PixelWidth, image.PixelHeight)));</a>
<a name="ln2781">            var geometry = Geometry.Empty;</a>
<a name="ln2782"> </a>
<a name="ln2783">            foreach (var stroke in CinemagraphInkCanvas.Strokes)</a>
<a name="ln2784">                geometry = Geometry.Combine(geometry, stroke.GetGeometry(), GeometryCombineMode.Union, null);</a>
<a name="ln2785"> </a>
<a name="ln2786">            geometry = Geometry.Combine(geometry, rectangle, GeometryCombineMode.Xor, null);</a>
<a name="ln2787"> </a>
<a name="ln2788">            //Since the geometry is bound to the screen, it needs to be scaled to follow the image scale.</a>
<a name="ln2789">            geometry.Transform = new ScaleTransform(this.Scale() / ZoomBoxControl.ImageScale, this.Scale() / ZoomBoxControl.ImageScale);</a>
<a name="ln2790"> </a>
<a name="ln2791">            var clippedImage = new Image</a>
<a name="ln2792">            {</a>
<a name="ln2793">                Source = image,</a>
<a name="ln2794">                Clip = geometry</a>
<a name="ln2795">            };</a>
<a name="ln2796"> </a>
<a name="ln2797">            clippedImage.Measure(new Size(image.Width, image.Height));</a>
<a name="ln2798">            clippedImage.Arrange(new Rect(clippedImage.DesiredSize));</a>
<a name="ln2799"> </a>
<a name="ln2800">            //The ScaleDiff (ScreenScale / ImageScale) must be calculated as if the screen has 96DPI, since the clippedImage is not being attached to any visual.</a>
<a name="ln2801">            //var imageRender = clippedImage.GetScaledRender(1 / ZoomBoxControl.ImageScale, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2802">            var imageRender = clippedImage.GetScaledRender(1, ZoomBoxControl.ImageDpi, ZoomBoxControl.GetImageSize());</a>
<a name="ln2803"> </a>
<a name="ln2804">            #endregion</a>
<a name="ln2805"> </a>
<a name="ln2806">            Cursor = Cursors.AppStarting;</a>
<a name="ln2807"> </a>
<a name="ln2808">            var selected = await Task.Run(() =&gt; OverlayAsync(imageRender, false));</a>
<a name="ln2809"> </a>
<a name="ln2810">            ShowHint(&quot;S.Hint.Overlay&quot;);</a>
<a name="ln2811"> </a>
<a name="ln2812">            await LoadSelectedStarter(selected.Min(), selected.Max());</a>
<a name="ln2813"> </a>
<a name="ln2814">            ClosePanel();</a>
<a name="ln2815">        }</a>
<a name="ln2816"> </a>
<a name="ln2817"> </a>
<a name="ln2818">        private void Progress_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2819">        {</a>
<a name="ln2820">            Pause();</a>
<a name="ln2821"> </a>
<a name="ln2822">            var size = Project.Frames[0].Path.ScaledSize();</a>
<a name="ln2823">            ProgressHorizontalRectangle.Width = size.Width / 2;</a>
<a name="ln2824">            ProgressVerticalRectangle.Height = size.Height / 2;</a>
<a name="ln2825"> </a>
<a name="ln2826">            ShowPanel(PanelTypes.Progress, LocalizationHelper.Get(&quot;S.Editor.Image.Progress&quot;, true), &quot;Vector.Progress&quot;, ApplyProgressButton_Click);</a>
<a name="ln2827">        }</a>
<a name="ln2828"> </a>
<a name="ln2829">        private void ProgressPrecisionComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)</a>
<a name="ln2830">        {</a>
<a name="ln2831">            if (!IsLoaded || !ProgressGrid.IsVisible || TextRadioButton.IsChecked == false)</a>
<a name="ln2832">                return;</a>
<a name="ln2833"> </a>
<a name="ln2834">            ChangeProgressTextToCurrent();</a>
<a name="ln2835">        }</a>
<a name="ln2836"> </a>
<a name="ln2837">        private void ExtendedCheckBox_CheckedChanged(object sender, RoutedEventArgs e)</a>
<a name="ln2838">        {</a>
<a name="ln2839">            if (!IsLoaded || !ProgressGrid.IsVisible || TextRadioButton.IsChecked == false)</a>
<a name="ln2840">                return;</a>
<a name="ln2841"> </a>
<a name="ln2842">            ChangeProgressTextToCurrent();</a>
<a name="ln2843">        }</a>
<a name="ln2844"> </a>
<a name="ln2845">        private void CustomProgressTextBox_TextChanged(object sender, TextChangedEventArgs e)</a>
<a name="ln2846">        {</a>
<a name="ln2847">            if (!IsLoaded || !ProgressGrid.IsVisible || TextRadioButton.IsChecked == false)</a>
<a name="ln2848">                return;</a>
<a name="ln2849"> </a>
<a name="ln2850">            ChangeProgressTextToCurrent();</a>
<a name="ln2851">        }</a>
<a name="ln2852"> </a>
<a name="ln2853">        private void Hyperlink_RequestNavigate(object sender, System.Windows.Navigation.RequestNavigateEventArgs e)</a>
<a name="ln2854">        {</a>
<a name="ln2855">            try</a>
<a name="ln2856">            {</a>
<a name="ln2857">                ProcessHelper.StartWithShell(e.Uri.AbsoluteUri);</a>
<a name="ln2858">            }</a>
<a name="ln2859">            catch (Exception ex)</a>
<a name="ln2860">            {</a>
<a name="ln2861">                LogWriter.Log(ex, $&quot;Error while trying to navigate to a given URI: '{e?.Uri?.AbsoluteUri}'.&quot;);</a>
<a name="ln2862">            }</a>
<a name="ln2863">        }</a>
<a name="ln2864"> </a>
<a name="ln2865">        private async void ApplyProgressButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2866">        {</a>
<a name="ln2867">            Cursor = Cursors.AppStarting;</a>
<a name="ln2868"> </a>
<a name="ln2869">            ActionStack.SaveState(ActionStack.EditAction.ImageAndProperties, Project.Frames, Util.Other.ListOfIndexes(0, Project.Frames.Count));</a>
<a name="ln2870"> </a>
<a name="ln2871">            await Task.Run(() =&gt; ProgressAsync(ProgressViewModel.FromSettings()));</a>
<a name="ln2872"> </a>
<a name="ln2873">            await LoadSelectedStarter(0, Project.Frames.Count - 1);</a>
<a name="ln2874"> </a>
<a name="ln2875">            ClosePanel();</a>
<a name="ln2876">        }</a>
<a name="ln2877"> </a>
<a name="ln2878">        #endregion</a>
<a name="ln2879"> </a>
<a name="ln2880">        #endregion</a>
<a name="ln2881"> </a>
<a name="ln2882">        #region Transitions Tab</a>
<a name="ln2883"> </a>
<a name="ln2884">        private void Transition_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln2885">        {</a>
<a name="ln2886">            e.CanExecute = Project != null &amp;&amp; FrameListView?.SelectedItems != null &amp;&amp; !IsLoading &amp;&amp; FrameListView.SelectedIndex != -1;</a>
<a name="ln2887">        }</a>
<a name="ln2888"> </a>
<a name="ln2889">        private void Fade_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2890">        {</a>
<a name="ln2891">            Pause();</a>
<a name="ln2892">            ShowPanel(PanelTypes.Fade, LocalizationHelper.Get(&quot;S.Editor.Fade.Title&quot;, true), &quot;Vector.Fade&quot;, ApplyFadeButtonButton_Click);</a>
<a name="ln2893">        }</a>
<a name="ln2894"> </a>
<a name="ln2895">        private async void ApplyFadeButtonButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2896">        {</a>
<a name="ln2897">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2898">            {</a>
<a name="ln2899">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Fade.WarningSelection&quot;));</a>
<a name="ln2900">                return;</a>
<a name="ln2901">            }</a>
<a name="ln2902"> </a>
<a name="ln2903">            if (UserSettings.All.FadeToType == FadeModes.Color &amp;&amp; UserSettings.All.FadeToColor.A == 0)</a>
<a name="ln2904">            {</a>
<a name="ln2905">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Fade.WarningColor&quot;));</a>
<a name="ln2906">                return;</a>
<a name="ln2907">            }</a>
<a name="ln2908"> </a>
<a name="ln2909">            Cursor = Cursors.AppStarting;</a>
<a name="ln2910"> </a>
<a name="ln2911">            ActionStack.SaveState(ActionStack.EditAction.Add, FrameListView.SelectedIndex + 1, (int)FadeSlider.Value);</a>
<a name="ln2912"> </a>
<a name="ln2913">            var index = FrameListView.SelectedIndex;</a>
<a name="ln2914">            var value = (int)FadeSlider.Value;</a>
<a name="ln2915">            var selected = await Task.Run(() =&gt; Fade(index, value, null));</a>
<a name="ln2916"> </a>
<a name="ln2917">            await LoadSelectedStarter(selected, Project.Frames.Count - 1);</a>
<a name="ln2918"> </a>
<a name="ln2919">            ShowHint(&quot;S.Hint.Transition&quot;);</a>
<a name="ln2920"> </a>
<a name="ln2921">            ClosePanel();</a>
<a name="ln2922">        }</a>
<a name="ln2923"> </a>
<a name="ln2924"> </a>
<a name="ln2925">        private void Slide_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2926">        {</a>
<a name="ln2927">            Pause();</a>
<a name="ln2928">            ShowPanel(PanelTypes.Slide, LocalizationHelper.Get(&quot;S.Editor.Slide.Title&quot;, true), &quot;Vector.Slide&quot;, ApplySlideButtonButton_Click);</a>
<a name="ln2929">        }</a>
<a name="ln2930"> </a>
<a name="ln2931">        private async void ApplySlideButtonButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln2932">        {</a>
<a name="ln2933">            if (FrameListView.SelectedIndex == -1)</a>
<a name="ln2934">            {</a>
<a name="ln2935">                StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Slide.WarningSelection&quot;));</a>
<a name="ln2936">                return;</a>
<a name="ln2937">            }</a>
<a name="ln2938"> </a>
<a name="ln2939">            Cursor = Cursors.AppStarting;</a>
<a name="ln2940"> </a>
<a name="ln2941">            ActionStack.SaveState(ActionStack.EditAction.Add, FrameListView.SelectedIndex + 1, (int)SlideSlider.Value);</a>
<a name="ln2942"> </a>
<a name="ln2943">            var index = FrameListView.SelectedIndex;</a>
<a name="ln2944">            var value = (int)SlideSlider.Value;</a>
<a name="ln2945">            var selected = await Task.Run(() =&gt; Slide(index, value, SlideFromType.Right));</a>
<a name="ln2946"> </a>
<a name="ln2947">            await LoadSelectedStarter(selected, Project.Frames.Count - 1);</a>
<a name="ln2948"> </a>
<a name="ln2949">            ShowHint(&quot;S.Hint.Transition&quot;);</a>
<a name="ln2950"> </a>
<a name="ln2951">            ClosePanel();</a>
<a name="ln2952">        }</a>
<a name="ln2953"> </a>
<a name="ln2954">        #endregion</a>
<a name="ln2955"> </a>
<a name="ln2956"> </a>
<a name="ln2957">        #region Other Events</a>
<a name="ln2958"> </a>
<a name="ln2959">        #region Panel</a>
<a name="ln2960"> </a>
<a name="ln2961">        private void PanelAction_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln2962">        {</a>
<a name="ln2963">            if (!IsLoaded)</a>
<a name="ln2964">                return;</a>
<a name="ln2965"> </a>
<a name="ln2966">            e.CanExecute = _applyAction != null || ClipboardGrid.IsVisible || LoadRecentGrid.IsVisible;// &amp;&amp; ActionGrid.Width &gt; 50 &amp;&amp; ActionLowerGrid.IsVisible;</a>
<a name="ln2967">        }</a>
<a name="ln2968"> </a>
<a name="ln2969">        private void Ok_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2970">        {</a>
<a name="ln2971">            ApplyButton.Focus();</a>
<a name="ln2972"> </a>
<a name="ln2973">            _applyAction?.Invoke(sender, e);</a>
<a name="ln2974"> </a>
<a name="ln2975">            //If the StatusBand started displaying the message, it means that the action failed.</a>
<a name="ln2976">            if (!StatusList.Children.OfType&lt;StatusBand&gt;().Any(a =&gt; a.Starting))</a>
<a name="ln2977">                _applyAction = null;</a>
<a name="ln2978">        }</a>
<a name="ln2979"> </a>
<a name="ln2980">        private void Cancel_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2981">        {</a>
<a name="ln2982">            _applyAction = null;</a>
<a name="ln2983"> </a>
<a name="ln2984">            ClosePanel(true);</a>
<a name="ln2985">        }</a>
<a name="ln2986"> </a>
<a name="ln2987">        #endregion</a>
<a name="ln2988"> </a>
<a name="ln2989">        #region Frame ListView</a>
<a name="ln2990"> </a>
<a name="ln2991">        private void ListFramesSelection_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln2992">        {</a>
<a name="ln2993">            e.CanExecute = FrameListView.SelectedIndex != -1 &amp;&amp; !IsLoading;</a>
<a name="ln2994">        }</a>
<a name="ln2995"> </a>
<a name="ln2996">        private void OpenImage_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln2997">        {</a>
<a name="ln2998">            try</a>
<a name="ln2999">            {</a>
<a name="ln3000">                ProcessHelper.StartWithShell(Project.Frames[FrameListView.SelectedIndex].Path);</a>
<a name="ln3001">            }</a>
<a name="ln3002">            catch (Exception ex)</a>
<a name="ln3003">            {</a>
<a name="ln3004">                LogWriter.Log(ex, &quot;Open Image&quot;);</a>
<a name="ln3005">                Dialog.Ok(&quot;Open Image&quot;, &quot;Impossible to open image.&quot;, ex.Message);</a>
<a name="ln3006">            }</a>
<a name="ln3007">        }</a>
<a name="ln3008"> </a>
<a name="ln3009">        private void ExploreFolder_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln3010">        {</a>
<a name="ln3011">            try</a>
<a name="ln3012">            {</a>
<a name="ln3013">                Process.Start(&quot;explorer.exe&quot;, $&quot;/select,\&quot;{Project.Frames[FrameListView.SelectedIndex].Path}\&quot;&quot;);</a>
<a name="ln3014">            }</a>
<a name="ln3015">            catch (Exception ex)</a>
<a name="ln3016">            {</a>
<a name="ln3017">                LogWriter.Log(ex, &quot;Open Image Folder&quot;);</a>
<a name="ln3018">                Dialog.Ok(&quot;Open Image&quot;, &quot;Impossible to open the image folder.&quot;, ex.Message);</a>
<a name="ln3019">            }</a>
<a name="ln3020">        }</a>
<a name="ln3021"> </a>
<a name="ln3022">        private void FrameListView_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln3023">        {</a>
<a name="ln3024">            var key = Keyboard.Modifiers == ModifierKeys.Alt ? e.SystemKey : e.Key;</a>
<a name="ln3025"> </a>
<a name="ln3026">            switch (key)</a>
<a name="ln3027">            {</a>
<a name="ln3028">                case Key.Space:</a>
<a name="ln3029">                {</a>
<a name="ln3030">                    if (PlayButton.IsEnabled)</a>
<a name="ln3031">                        PlayPause();</a>
<a name="ln3032"> </a>
<a name="ln3033">                    //Avoids the selection of the frame by using the Space key.</a>
<a name="ln3034">                    e.Handled = true;</a>
<a name="ln3035">                    break;</a>
<a name="ln3036">                }</a>
<a name="ln3037"> </a>
<a name="ln3038">                case Key.Right:</a>
<a name="ln3039">                {</a>
<a name="ln3040">                    if ((Keyboard.Modifiers &amp; ModifierKeys.Alt) == 0 &amp;&amp; (Keyboard.Modifiers &amp; (ModifierKeys.Alt | ModifierKeys.Control)) == 0)</a>
<a name="ln3041">                    {</a>
<a name="ln3042">                        NextFrame_Executed(sender, null);</a>
<a name="ln3043">                        e.Handled = true;</a>
<a name="ln3044">                    }</a>
<a name="ln3045">                    else if (Keyboard.Modifiers.HasFlag(ModifierKeys.Alt | ModifierKeys.Control))</a>
<a name="ln3046">                    {</a>
<a name="ln3047">                        MoveRightButton.Command.Execute(null);</a>
<a name="ln3048">                        e.Handled = true;</a>
<a name="ln3049">                    }</a>
<a name="ln3050">                    else if (Keyboard.Modifiers.HasFlag(ModifierKeys.Alt))</a>
<a name="ln3051">                    {</a>
<a name="ln3052">                        DeleteAfterButton.Command.Execute(null);</a>
<a name="ln3053">                        e.Handled = true;</a>
<a name="ln3054">                    }</a>
<a name="ln3055"> </a>
<a name="ln3056">                    break;</a>
<a name="ln3057">                }</a>
<a name="ln3058"> </a>
<a name="ln3059">                case Key.PageDown:</a>
<a name="ln3060">                {</a>
<a name="ln3061">                    NextFrame_Executed(sender, EventArgs.Empty);</a>
<a name="ln3062">                    e.Handled = true;</a>
<a name="ln3063">                    break;</a>
<a name="ln3064">                }</a>
<a name="ln3065">                </a>
<a name="ln3066">                case Key.Left:</a>
<a name="ln3067">                {</a>
<a name="ln3068">                    if ((Keyboard.Modifiers &amp; ModifierKeys.Alt) == 0 &amp;&amp; (Keyboard.Modifiers &amp; (ModifierKeys.Alt | ModifierKeys.Control)) == 0)</a>
<a name="ln3069">                    {</a>
<a name="ln3070">                        PreviousFrame_Executed(sender, null);</a>
<a name="ln3071">                        e.Handled = true;</a>
<a name="ln3072">                    }</a>
<a name="ln3073">                    else if (Keyboard.Modifiers.HasFlag(ModifierKeys.Alt | ModifierKeys.Control))</a>
<a name="ln3074">                    {</a>
<a name="ln3075">                        MoveLeftButton.Command.Execute(null);</a>
<a name="ln3076">                        e.Handled = true;</a>
<a name="ln3077">                    }</a>
<a name="ln3078">                    else if (Keyboard.Modifiers.HasFlag(ModifierKeys.Alt))</a>
<a name="ln3079">                    {</a>
<a name="ln3080">                        DeleteBeforeButton.Command.Execute(null);</a>
<a name="ln3081">                        e.Handled = true;</a>
<a name="ln3082">                    }</a>
<a name="ln3083"> </a>
<a name="ln3084">                    break;</a>
<a name="ln3085">                }</a>
<a name="ln3086"> </a>
<a name="ln3087">                case Key.PageUp:</a>
<a name="ln3088">                {</a>
<a name="ln3089">                    PreviousFrame_Executed(sender, EventArgs.Empty);</a>
<a name="ln3090">                    e.Handled = true;</a>
<a name="ln3091">                    break;</a>
<a name="ln3092">                }</a>
<a name="ln3093"> </a>
<a name="ln3094">                case Key.Home:</a>
<a name="ln3095">                {</a>
<a name="ln3096">                    FirstFrame_Executed(sender, null);</a>
<a name="ln3097">                    e.Handled = true;</a>
<a name="ln3098">                    break;</a>
<a name="ln3099">                }</a>
<a name="ln3100"> </a>
<a name="ln3101">                case Key.End:</a>
<a name="ln3102">                {</a>
<a name="ln3103">                    LastFrame_Executed(sender, null);</a>
<a name="ln3104">                    e.Handled = true;</a>
<a name="ln3105">                    break;</a>
<a name="ln3106">                }</a>
<a name="ln3107">            }</a>
<a name="ln3108">        }</a>
<a name="ln3109"> </a>
<a name="ln3110">        #endregion</a>
<a name="ln3111"> </a>
<a name="ln3112">        private void PreviewLoop(int selectedIndex)</a>
<a name="ln3113">        {</a>
<a name="ln3114">            using (var resolution = new TimerResolution(1))</a>
<a name="ln3115">            {</a>
<a name="ln3116">                if (!resolution.SuccessfullySetTargetResolution)</a>
<a name="ln3117">                {</a>
<a name="ln3118">                    LogWriter.Log($&quot;Imprecise timer resolution... Target: {resolution.TargetResolution}, Current: {resolution.CurrentResolution}&quot;);</a>
<a name="ln3119">                    Dispatcher.Invoke(() =&gt; HasImprecisePlayback = true);</a>
<a name="ln3120">                }</a>
<a name="ln3121"> </a>
<a name="ln3122">                #region Preview loop</a>
<a name="ln3123"> </a>
<a name="ln3124">                var sw = new Stopwatch();</a>
<a name="ln3125"> </a>
<a name="ln3126">                while (_previewToken != null &amp;&amp; !_previewToken.IsCancellationRequested)</a>
<a name="ln3127">                {</a>
<a name="ln3128">                    sw.Restart();</a>
<a name="ln3129"> </a>
<a name="ln3130">                    long frameDelay = Project.Frames[selectedIndex].Delay;</a>
<a name="ln3131"> </a>
<a name="ln3132">                    // Change active frame</a>
<a name="ln3133">                    Dispatcher.Invoke(() =&gt; FrameListView.SelectedIndex = selectedIndex);</a>
<a name="ln3134"> </a>
<a name="ln3135">                    // Wait for application UI to render changes (there is no point in ordering change of next frame if the previous one is not displayed yet)</a>
<a name="ln3136">                    // Loaded priority could be used but input can become laggy</a>
<a name="ln3137">                    Dispatcher.Invoke(() =&gt; { }, DispatcherPriority.Background);</a>
<a name="ln3138"> </a>
<a name="ln3139">                    var pass = 0;</a>
<a name="ln3140">                    do</a>
<a name="ln3141">                    {</a>
<a name="ln3142">                        pass++;</a>
<a name="ln3143"> </a>
<a name="ln3144">                        if (Project.Frames.Count - 1 == selectedIndex)</a>
<a name="ln3145">                        {</a>
<a name="ln3146">                            //If the playback should not loop, it will stop at the latest frame.</a>
<a name="ln3147">                            if (!UserSettings.All.LoopedPlayback)</a>
<a name="ln3148">                            {</a>
<a name="ln3149">                                // This will ensure that latest frame will be shown if drops frames behind is enabled</a>
<a name="ln3150">                                if (UserSettings.All.DropFramesDuringPreviewIfBehind &amp;&amp; pass &gt; 1)</a>
<a name="ln3151">                                    break;</a>
<a name="ln3152"> </a>
<a name="ln3153">                                Dispatcher.Invoke(Pause);</a>
<a name="ln3154">                                return;</a>
<a name="ln3155">                            }</a>
<a name="ln3156"> </a>
<a name="ln3157">                            selectedIndex = 0;</a>
<a name="ln3158">                        }</a>
<a name="ln3159">                        else</a>
<a name="ln3160">                        {</a>
<a name="ln3161">                            selectedIndex++;</a>
<a name="ln3162">                        }</a>
<a name="ln3163"> </a>
<a name="ln3164">                        if (!UserSettings.All.DropFramesDuringPreviewIfBehind)</a>
<a name="ln3165">                            break;</a>
<a name="ln3166"> </a>
<a name="ln3167">                        if (pass &gt;= 2)</a>
<a name="ln3168">                            frameDelay += Project.Frames[selectedIndex].Delay;</a>
<a name="ln3169">                    }</a>
<a name="ln3170">                    while (sw.ElapsedMilliseconds &gt;= frameDelay);</a>
<a name="ln3171"> </a>
<a name="ln3172">                    if (Project.Frames[selectedIndex].Delay == 0)</a>
<a name="ln3173">                        Project.Frames[selectedIndex].Delay = 10;</a>
<a name="ln3174"> </a>
<a name="ln3175">                    //Wait rest of actual frame delay time</a>
<a name="ln3176">                    if (sw.ElapsedMilliseconds &gt;= frameDelay)</a>
<a name="ln3177">                        continue;</a>
<a name="ln3178"> </a>
<a name="ln3179">                    while (sw.Elapsed.TotalMilliseconds &lt; frameDelay)</a>
<a name="ln3180">                        Thread.Sleep(1);</a>
<a name="ln3181"> </a>
<a name="ln3182">                    //SpinWait.SpinUntil(() =&gt; sw.ElapsedMilliseconds &gt;= frameDelay);</a>
<a name="ln3183">                }</a>
<a name="ln3184"> </a>
<a name="ln3185">                sw.Stop();</a>
<a name="ln3186"> </a>
<a name="ln3187">                #endregion</a>
<a name="ln3188">            }</a>
<a name="ln3189">        }</a>
<a name="ln3190"> </a>
<a name="ln3191">        private void Control_DragEnter(object sender, DragEventArgs e)</a>
<a name="ln3192">        {</a>
<a name="ln3193">            Pause();</a>
<a name="ln3194"> </a>
<a name="ln3195">            e.Effects = e.Data.GetDataPresent(DataFormats.FileDrop)</a>
<a name="ln3196">                ? DragDropEffects.Copy</a>
<a name="ln3197">                : DragDropEffects.None;</a>
<a name="ln3198">        }</a>
<a name="ln3199"> </a>
<a name="ln3200">        private async void Control_Drop(object sender, DragEventArgs e)</a>
<a name="ln3201">        {</a>
<a name="ln3202">            Pause();</a>
<a name="ln3203"> </a>
<a name="ln3204">            if (e.Data.GetData(DataFormats.FileDrop) is not string[] fileNames || fileNames.Length == 0)</a>
<a name="ln3205">                return;</a>
<a name="ln3206"> </a>
<a name="ln3207">            #region Validation</a>
<a name="ln3208"> </a>
<a name="ln3209">            var extensionList = fileNames.Select(s =&gt; Path.GetExtension(s).ToLowerInvariant()).ToList();</a>
<a name="ln3210"> </a>
<a name="ln3211">            var media = new[] { &quot;.jpg&quot;, &quot;.jpeg&quot;, &quot;.gif&quot;, &quot;.bmp&quot;, &quot;.png&quot;, &quot;.avi&quot;, &quot;.mp4&quot;, &quot;.wmv&quot; };</a>
<a name="ln3212"> </a>
<a name="ln3213">            var projectCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; (x.Equals(&quot;.stg&quot;) || x.Equals(&quot;.zip&quot;)));</a>
<a name="ln3214">            var mediaCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; media.Contains(Path.GetExtension(x)));</a>
<a name="ln3215"> </a>
<a name="ln3216">            if (projectCount != 0 &amp;&amp; mediaCount != 0)</a>
<a name="ln3217">            {</a>
<a name="ln3218">                Dialog.Ok(LocalizationHelper.Get(&quot;S.Editor.DragDrop.Invalid.Title&quot;),</a>
<a name="ln3219">                    LocalizationHelper.Get(&quot;S.Editor.DragDrop.MultipleFiles.Instruction&quot;),</a>
<a name="ln3220">                    LocalizationHelper.Get(&quot;S.Editor.DragDrop.MultipleFiles.Message&quot;), Icons.Warning);</a>
<a name="ln3221">                return;</a>
<a name="ln3222">            }</a>
<a name="ln3223"> </a>
<a name="ln3224">            if (mediaCount == 0 &amp;&amp; projectCount == 0)</a>
<a name="ln3225">            {</a>
<a name="ln3226">                Dialog.Ok(LocalizationHelper.Get(&quot;S.Editor.DragDrop.Invalid.Title&quot;),</a>
<a name="ln3227">                    LocalizationHelper.Get(&quot;S.Editor.DragDrop.Invalid.Instruction&quot;),</a>
<a name="ln3228">                    LocalizationHelper.Get(&quot;S.Editor.DragDrop.Invalid.Message&quot;), Icons.Warning);</a>
<a name="ln3229">                return;</a>
<a name="ln3230">            }</a>
<a name="ln3231"> </a>
<a name="ln3232">            //if (projectCount &gt; 0)</a>
<a name="ln3233">            //{</a>
<a name="ln3234">            //    Dialog.Ok(LocalizationHelper.Get(&quot;S.Editor.DragDrop.Invalid.Title&quot;),</a>
<a name="ln3235">            //        LocalizationHelper.Get(&quot;S.Editor.DragDrop.InvalidProject.Instruction&quot;),</a>
<a name="ln3236">            //        LocalizationHelper.Get(&quot;S.Editor.DragDrop.InvalidProject.Message&quot;), Dialog.Icons.Warning);</a>
<a name="ln3237">            //    return;</a>
<a name="ln3238">            //}</a>
<a name="ln3239"> </a>
<a name="ln3240">            #endregion</a>
<a name="ln3241"> </a>
<a name="ln3242">            #region Importing options</a>
<a name="ln3243"> </a>
<a name="ln3244">            //If inserted into new recording or forced into new one.</a>
<a name="ln3245">            if (Project == null || !Project.Any || e.KeyStates == DragDropKeyStates.ControlKey || projectCount &gt; 0)</a>
<a name="ln3246">                await Task.Run(() =&gt; ImportFrom(fileNames.ToList()));</a>
<a name="ln3247">            else</a>
<a name="ln3248">                await InsertImportFrom(fileNames.ToList());</a>
<a name="ln3249"> </a>
<a name="ln3250">            #endregion</a>
<a name="ln3251"> </a>
<a name="ln3252">            ClosePanel(removeEvent: true);</a>
<a name="ln3253">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3254">            GC.Collect();</a>
<a name="ln3255">        }</a>
<a name="ln3256"> </a>
<a name="ln3257">        private void CancelLoadingButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln3258">        {</a>
<a name="ln3259">            _abortLoading = true;</a>
<a name="ln3260">            CancelLoadingButton.IsEnabled = false;</a>
<a name="ln3261">        }</a>
<a name="ln3262"> </a>
<a name="ln3263">        private void InkCanvas_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln3264">        {</a>
<a name="ln3265">            if (e.Key != Key.Escape || sender is not InkCanvas canvas)</a>
<a name="ln3266">                return;</a>
<a name="ln3267"> </a>
<a name="ln3268">            //This event only exists because the InkPanel eats the Esc key used in Commands.</a>
<a name="ln3269">            //if something is not selected, run the command to close the panel.</a>
<a name="ln3270">            if (canvas.ActiveEditingMode != InkCanvasEditingMode.Select &amp;&amp; canvas.GetSelectedStrokes().Any())</a>
<a name="ln3271">                CancelCommandBinding.Command.Execute(null);</a>
<a name="ln3272">        }</a>
<a name="ln3273"> </a>
<a name="ln3274">        #endregion</a>
<a name="ln3275"> </a>
<a name="ln3276">        #region Methods</a>
<a name="ln3277"> </a>
<a name="ln3278">        #region Load</a>
<a name="ln3279"> </a>
<a name="ln3280">        internal async void LoadFromArguments()</a>
<a name="ln3281">        {</a>
<a name="ln3282">            if (Arguments.FileNames.Count &lt; 1)</a>
<a name="ln3283">                return;</a>
<a name="ln3284"> </a>
<a name="ln3285">            #region Validation</a>
<a name="ln3286"> </a>
<a name="ln3287">            var extensionList = Arguments.FileNames.Select(Path.GetExtension).ToList();</a>
<a name="ln3288"> </a>
<a name="ln3289">            var media = new[] { &quot;avif&quot;, &quot;jpg&quot;, &quot;jpeg&quot;, &quot;gif&quot;, &quot;bmp&quot;, &quot;png&quot;, &quot;apng&quot;, &quot;avi&quot;, &quot;mkv&quot;, &quot;mp4&quot;, &quot;webp&quot;, &quot;webm&quot;, &quot;wmv&quot; };</a>
<a name="ln3290"> </a>
<a name="ln3291">            var projectCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; (x.Equals(&quot;stg&quot;) || x.Equals(&quot;zip&quot;)));</a>
<a name="ln3292">            var mediaCount = extensionList.Count(x =&gt; !string.IsNullOrEmpty(x) &amp;&amp; media.Contains(x));</a>
<a name="ln3293"> </a>
<a name="ln3294">            //TODO: Later I need to implement another validation for multiple video files.</a>
<a name="ln3295"> </a>
<a name="ln3296">            if (projectCount != 0 &amp;&amp; mediaCount != 0)</a>
<a name="ln3297">            {</a>
<a name="ln3298">                Dispatcher.Invoke(() =&gt; StatusList.Warning(FindResource(&quot;S.Editor.InvalidLoadingFiles&quot;).ToString()));</a>
<a name="ln3299">                return;</a>
<a name="ln3300">            }</a>
<a name="ln3301"> </a>
<a name="ln3302">            if (projectCount &gt; 0)</a>
<a name="ln3303">            {</a>
<a name="ln3304">                Dispatcher.Invoke(() =&gt; StatusList.Warning(FindResource(&quot;S.Editor.InvalidLoadingProjects&quot;).ToString()));</a>
<a name="ln3305">                return;</a>
<a name="ln3306">            }</a>
<a name="ln3307"> </a>
<a name="ln3308">            #endregion</a>
<a name="ln3309"> </a>
<a name="ln3310">            await Task.Run(() =&gt; ImportFrom(Arguments.FileNames.ToImmutableList()));</a>
<a name="ln3311"> </a>
<a name="ln3312">            ClosePanel(removeEvent: true);</a>
<a name="ln3313">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3314">            GC.Collect();</a>
<a name="ln3315">        }</a>
<a name="ln3316"> </a>
<a name="ln3317">        #region Async Loading</a>
<a name="ln3318"> </a>
<a name="ln3319">        /// &lt;summary&gt;</a>
<a name="ln3320">        /// Loads the new frames and clears the old ones.</a>
<a name="ln3321">        /// &lt;/summary&gt;</a>
<a name="ln3322">        /// &lt;param name=&quot;newProject&quot;&gt;The project to load.&lt;/param&gt;</a>
<a name="ln3323">        /// &lt;param name=&quot;isNew&quot;&gt;True if this is a new project.&lt;/param&gt;</a>
<a name="ln3324">        /// &lt;param name=&quot;clear&quot;&gt;True if should clear the current list of frames.&lt;/param&gt;</a>
<a name="ln3325">        /// &lt;param name=&quot;createFlag&quot;&gt;True if it should create a flag for single use, a mutex.&lt;/param&gt;</a>
<a name="ln3326">        internal async void LoadProject(ProjectInfo newProject, bool isNew = true, bool clear = true, bool createFlag = false)</a>
<a name="ln3327">        {</a>
<a name="ln3328">            Cursor = Cursors.AppStarting;</a>
<a name="ln3329">            IsLoading = true;</a>
<a name="ln3330"> </a>
<a name="ln3331">            _viewModel.Frames.Clear();</a>
<a name="ln3332">            ZoomBoxControl.Zoom = 1;</a>
<a name="ln3333"> </a>
<a name="ln3334">            #region Discard</a>
<a name="ln3335"> </a>
<a name="ln3336">            if (clear || isNew)</a>
<a name="ln3337">            {</a>
<a name="ln3338">                //Clear clipboard data.</a>
<a name="ln3339">                ClipboardListBox.Items.Clear();</a>
<a name="ln3340">                Util.Clipboard.Items?.Clear();</a>
<a name="ln3341">            }</a>
<a name="ln3342"> </a>
<a name="ln3343">            //TODO: Settings to choose if the project will be discarded.</a>
<a name="ln3344">            if (clear &amp;&amp; Project != null &amp;&amp; Project.Any)</a>
<a name="ln3345">            {</a>
<a name="ln3346">                Project.Persist();</a>
<a name="ln3347"> </a>
<a name="ln3348">                if (!UserSettings.All.NotifyProjectDiscard || Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DiscardProject.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DiscardPreviousProject.Instruction&quot;),</a>
<a name="ln3349">                        LocalizationHelper.Get(&quot;S.Editor.DiscardPreviousProject.Message&quot;), false))</a>
<a name="ln3350">                {</a>
<a name="ln3351">                    await Task.Run(() =&gt; Discard(Project));</a>
<a name="ln3352">                    FilledList = false;</a>
<a name="ln3353">                    FrameListView.SelectionChanged += FrameListView_SelectionChanged;</a>
<a name="ln3354"> </a>
<a name="ln3355">                    Project = newProject;</a>
<a name="ln3356"> </a>
<a name="ln3357">                    ActionStack.Clear();</a>
<a name="ln3358">                    ActionStack.Project = Project;</a>
<a name="ln3359"> </a>
<a name="ln3360">                    LoadCallback(await Task.Run(Load));</a>
<a name="ln3361"> </a>
<a name="ln3362">                    GC.Collect();</a>
<a name="ln3363">                    return;</a>
<a name="ln3364">                }</a>
<a name="ln3365"> </a>
<a name="ln3366">                Project.Clear();</a>
<a name="ln3367">                ActionStack.Clear();</a>
<a name="ln3368">            }</a>
<a name="ln3369"> </a>
<a name="ln3370">            #endregion</a>
<a name="ln3371"> </a>
<a name="ln3372">            if (isNew)</a>
<a name="ln3373">            {</a>
<a name="ln3374">                if (!clear) //Already clears the project above if flag 'clear' is true.</a>
<a name="ln3375">                    Project?.Clear();</a>
<a name="ln3376"> </a>
<a name="ln3377">                Project = newProject;</a>
<a name="ln3378"> </a>
<a name="ln3379">                if (createFlag)</a>
<a name="ln3380">                    Project.CreateMutex();</a>
<a name="ln3381"> </a>
<a name="ln3382">                ActionStack.Clear();</a>
<a name="ln3383">                ActionStack.Project = Project;</a>
<a name="ln3384">            }</a>
<a name="ln3385"> </a>
<a name="ln3386">            var result = await Task.Run(Load);</a>
<a name="ln3387">            LoadCallback(result);</a>
<a name="ln3388">        }</a>
<a name="ln3389"> </a>
<a name="ln3390">        private bool Load()</a>
<a name="ln3391">        {</a>
<a name="ln3392">            try</a>
<a name="ln3393">            {</a>
<a name="ln3394">                Dispatcher.Invoke(() =&gt;</a>
<a name="ln3395">                {</a>
<a name="ln3396">                    IsCancelable = true;</a>
<a name="ln3397">                });</a>
<a name="ln3398"> </a>
<a name="ln3399">                if (!Project.IsNew)</a>
<a name="ln3400">                    Project.Persist();</a>
<a name="ln3401"> </a>
<a name="ln3402">                var corruptedList = new List&lt;FrameInfo&gt;();</a>
<a name="ln3403">                var count = 0;</a>
<a name="ln3404"> </a>
<a name="ln3405">                #region Get images from cache</a>
<a name="ln3406"> </a>
<a name="ln3407">                if (File.Exists(Project.CachePath))</a>
<a name="ln3408">                {</a>
<a name="ln3409">                    ShowProgress(LocalizationHelper.Get(&quot;S.Editor.RetrievingFromCache&quot;), Project.Frames.Count);</a>
<a name="ln3410"> </a>
<a name="ln3411">                    using (var fileStream = new FileStream(Project.CachePath, FileMode.Open, FileAccess.Read, FileShare.Read))</a>
<a name="ln3412">                    {</a>
<a name="ln3413">                        using (var deflateStream = new DeflateStream(fileStream, CompressionMode.Decompress))</a>
<a name="ln3414">                        {</a>
<a name="ln3415">                            var number = 0;</a>
<a name="ln3416"> </a>
<a name="ln3417">                            for (var index = 0; index &lt; Project.Frames.Count; index++)</a>
<a name="ln3418">                            {</a>
<a name="ln3419">                                var frame = Project.Frames[index];</a>
<a name="ln3420"> </a>
<a name="ln3421">                                if (_abortLoading)</a>
<a name="ln3422">                                    return false;</a>
<a name="ln3423"> </a>
<a name="ln3424">                                Dispatcher.Invoke(() =&gt; { UpdateProgress(number++); });</a>
<a name="ln3425">                                BitmapSource source;</a>
<a name="ln3426"> </a>
<a name="ln3427">                                try</a>
<a name="ln3428">                                {</a>
<a name="ln3429">                                    var array = deflateStream.ReadBytesUntilFull((int)frame.DataLength);</a>
<a name="ln3430"> </a>
<a name="ln3431">                                    if (Project.BitDepth == 24)</a>
<a name="ln3432">                                    {</a>
<a name="ln3433">                                        //24 bits: ((Project.Width * 24 + 31) / 32) * 4</a>
<a name="ln3434">                                        source = BitmapSource.Create(Project.Width, Project.Height, Project.Dpi, Project.Dpi, PixelFormats.Bgr24, null, array, ((Project.Width * 24 + 31) / 32) * 4);</a>
<a name="ln3435">                                        source = new FormatConvertedBitmap(source, PixelFormats.Bgra32, null, 0);</a>
<a name="ln3436">                                    }</a>
<a name="ln3437">                                    else</a>
<a name="ln3438">                                    {</a>
<a name="ln3439">                                        //32 bits: 4 * Project.Width</a>
<a name="ln3440">                                        source = BitmapSource.Create(Project.Width, Project.Height, Project.Dpi, Project.Dpi, PixelFormats.Bgra32, null, array, 4 * Project.Width);</a>
<a name="ln3441">                                    }</a>
<a name="ln3442">                                }</a>
<a name="ln3443">                                catch (EndOfStreamException d)</a>
<a name="ln3444">                                {</a>
<a name="ln3445">                                    LogWriter.Log(d, &quot;It was not possible to read more bytes from the frame cache, since it reached the end&quot;);</a>
<a name="ln3446">                                    break;</a>
<a name="ln3447">                                }</a>
<a name="ln3448"> </a>
<a name="ln3449">                                using (var stream = new FileStream(frame.Path, FileMode.Create))</a>
<a name="ln3450">                                {</a>
<a name="ln3451">                                    var encoder = new PngBitmapEncoder();</a>
<a name="ln3452">                                    encoder.Frames.Add(BitmapFrame.Create(source));</a>
<a name="ln3453">                                    encoder.Save(stream);</a>
<a name="ln3454">                                    stream.Close();</a>
<a name="ln3455">                                }</a>
<a name="ln3456">                            }</a>
<a name="ln3457"> </a>
<a name="ln3458">                            GC.Collect();</a>
<a name="ln3459">                        }</a>
<a name="ln3460">                    }</a>
<a name="ln3461"> </a>
<a name="ln3462">                    File.Delete(Project.CachePath);</a>
<a name="ln3463">                }</a>
<a name="ln3464"> </a>
<a name="ln3465">                #endregion</a>
<a name="ln3466"> </a>
<a name="ln3467">                ShowProgress(LocalizationHelper.Get(&quot;S.Editor.LoadingFrames&quot;), Project.Frames.Count);</a>
<a name="ln3468"> </a>
<a name="ln3469">                #region Check if there's any missing frames (and remove them)</a>
<a name="ln3470"> </a>
<a name="ln3471">                var processedFrame = 0;</a>
<a name="ln3472"> </a>
<a name="ln3473">                foreach (var frame in Project.Frames)</a>
<a name="ln3474">                {</a>
<a name="ln3475">                    if (_abortLoading)</a>
<a name="ln3476">                        break;</a>
<a name="ln3477"> </a>
<a name="ln3478">                    if (!File.Exists(frame.Path))</a>
<a name="ln3479">                        corruptedList.Add(frame);</a>
<a name="ln3480"> </a>
<a name="ln3481">                    UpdateProgress(processedFrame++);</a>
<a name="ln3482">                }</a>
<a name="ln3483"> </a>
<a name="ln3484">                if (_abortLoading)</a>
<a name="ln3485">                    return false;</a>
<a name="ln3486"> </a>
<a name="ln3487">                //Remove the corrupted frames.</a>
<a name="ln3488">                foreach (var frame in corruptedList)</a>
<a name="ln3489">                    Project.Frames.Remove(frame);</a>
<a name="ln3490"> </a>
<a name="ln3491">                if (Project.Frames.Count == 0)</a>
<a name="ln3492">                {</a>
<a name="ln3493">                    Dispatcher.InvokeAsync(() =&gt;</a>
<a name="ln3494">                    {</a>
<a name="ln3495">                        Dialog.Ok(LocalizationHelper.Get(&quot;S.Editor.LoadingFrames&quot;), LocalizationHelper.Get(&quot;S.Editor.LoadingFrames.ProjectCorrupted.Instruction&quot;),</a>
<a name="ln3496">                            LocalizationHelper.Get(&quot;S.Editor.LoadingFrames.ProjectCorrupted.Message&quot;));</a>
<a name="ln3497">                    });</a>
<a name="ln3498">                    return false;</a>
<a name="ln3499">                }</a>
<a name="ln3500"> </a>
<a name="ln3501">                #endregion</a>
<a name="ln3502"> </a>
<a name="ln3503">                //If the project was never loaded inside the editor. Projects created with any version older than 2.14 won't enter here.</a>
<a name="ln3504">                if (Project.IsNew)</a>
<a name="ln3505">                {</a>
<a name="ln3506">                    Project.IsNew = false;</a>
<a name="ln3507">                    Project.Persist();</a>
<a name="ln3508"> </a>
<a name="ln3509">                    //Get enabled tasks.</a>
<a name="ln3510">                    var tasks = UserSettings.All.AutomatedTasksList?.Cast&lt;BaseTaskViewModel&gt;().Where(w =&gt; w != null &amp;&amp; w.IsEnabled).ToList() ?? new List&lt;BaseTaskViewModel&gt;();</a>
<a name="ln3511"> </a>
<a name="ln3512">                    if (tasks.Any())</a>
<a name="ln3513">                    {</a>
<a name="ln3514">                        #region Initialize the previewer</a>
<a name="ln3515"> </a>
<a name="ln3516">                        Dispatcher.Invoke(() =&gt;</a>
<a name="ln3517">                        {</a>
<a name="ln3518">                            ZoomBoxControl.LoadFromPath(Project.Frames[0].Path);</a>
<a name="ln3519"> </a>
<a name="ln3520">                            OverlayGrid.Visibility = Visibility.Visible;</a>
<a name="ln3521">                            OverlayGrid.Opacity = 1;</a>
<a name="ln3522">                            OverlayGrid.UpdateLayout();</a>
<a name="ln3523"> </a>
<a name="ln3524">                            var size = ZoomBoxControl.GetElementSize();</a>
<a name="ln3525"> </a>
<a name="ln3526">                            CaptionOverlayGrid.Width = size.Width;</a>
<a name="ln3527">                            CaptionOverlayGrid.Height = size.Height;</a>
<a name="ln3528">                            CaptionOverlayGrid.UpdateLayout();</a>
<a name="ln3529">                        });</a>
<a name="ln3530"> </a>
<a name="ln3531">                        #endregion</a>
<a name="ln3532"> </a>
<a name="ln3533">                        foreach (var task in tasks)</a>
<a name="ln3534">                        {</a>
<a name="ln3535">                            if (_abortLoading)</a>
<a name="ln3536">                            {</a>
<a name="ln3537">                                Dispatcher.Invoke(() =&gt;</a>
<a name="ln3538">                                {</a>
<a name="ln3539">                                    ZoomBoxControl.ImageSource = null;</a>
<a name="ln3540"> </a>
<a name="ln3541">                                    OverlayGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln3542">                                    OverlayGrid.Opacity = 0;</a>
<a name="ln3543">                                });</a>
<a name="ln3544"> </a>
<a name="ln3545">                                return false;</a>
<a name="ln3546">                            }</a>
<a name="ln3547"> </a>
<a name="ln3548">                            try</a>
<a name="ln3549">                            {</a>
<a name="ln3550">                                switch (task.TaskType)</a>
<a name="ln3551">                                {</a>
<a name="ln3552">                                    case TaskTypes.MouseEvents:</a>
<a name="ln3553">                                    {</a>
<a name="ln3554">                                        if (Project.CreatedBy == ProjectByType.ScreenRecorder)</a>
<a name="ln3555">                                            MouseEventsAsync(task as MouseEventsViewModel ?? MouseEventsViewModel.FromSettings());</a>
<a name="ln3556"> </a>
<a name="ln3557">                                        break;</a>
<a name="ln3558">                                    }</a>
<a name="ln3559"> </a>
<a name="ln3560">                                    case TaskTypes.KeyStrokes:</a>
<a name="ln3561">                                    {</a>
<a name="ln3562">                                        if (Project.CreatedBy == ProjectByType.ScreenRecorder)</a>
<a name="ln3563">                                            KeyStrokesAsync(task as KeyStrokesViewModel ?? KeyStrokesViewModel.FromSettings());</a>
<a name="ln3564"> </a>
<a name="ln3565">                                        break;</a>
<a name="ln3566">                                    }</a>
<a name="ln3567"> </a>
<a name="ln3568">                                    case TaskTypes.Delay:</a>
<a name="ln3569">                                    {</a>
<a name="ln3570">                                        if (Project.CreatedBy != ProjectByType.Editor &amp;&amp; Project.CreatedBy != ProjectByType.Unknown)</a>
<a name="ln3571">                                            DelayAsync(task as DelayViewModel ?? DelayViewModel.FromSettings(), true, true);</a>
<a name="ln3572"> </a>
<a name="ln3573">                                        break;</a>
<a name="ln3574">                                    }</a>
<a name="ln3575"> </a>
<a name="ln3576">                                    case TaskTypes.Progress:</a>
<a name="ln3577">                                    {</a>
<a name="ln3578">                                        if (Project.CreatedBy != ProjectByType.Editor &amp;&amp; Project.CreatedBy != ProjectByType.Unknown)</a>
<a name="ln3579">                                            ProgressAsync(task as ProgressViewModel ?? ProgressViewModel.FromSettings());</a>
<a name="ln3580"> </a>
<a name="ln3581">                                        break;</a>
<a name="ln3582">                                    }</a>
<a name="ln3583"> </a>
<a name="ln3584">                                    case TaskTypes.Border:</a>
<a name="ln3585">                                    {</a>
<a name="ln3586">                                        if (Project.CreatedBy != ProjectByType.Editor &amp;&amp; Project.CreatedBy != ProjectByType.Unknown)</a>
<a name="ln3587">                                            BorderAsync(task as BorderViewModel ?? BorderViewModel.FromSettings());</a>
<a name="ln3588"> </a>
<a name="ln3589">                                        break;</a>
<a name="ln3590">                                    }</a>
<a name="ln3591"> </a>
<a name="ln3592">                                    case TaskTypes.Shadow:</a>
<a name="ln3593">                                    {</a>
<a name="ln3594">                                        if (Project.CreatedBy != ProjectByType.Editor &amp;&amp; Project.CreatedBy != ProjectByType.Unknown)</a>
<a name="ln3595">                                            ShadowAsync(task as ShadowViewModel ?? ShadowViewModel.FromSettings());</a>
<a name="ln3596"> </a>
<a name="ln3597">                                        break;</a>
<a name="ln3598">                                    }</a>
<a name="ln3599">                                }</a>
<a name="ln3600">                            }</a>
<a name="ln3601">                            catch (Exception e)</a>
<a name="ln3602">                            {</a>
<a name="ln3603">                                LogWriter.Log(e, &quot;Error while applying automatic task&quot;);</a>
<a name="ln3604">                                Dispatcher.Invoke(() =&gt; { ExceptionDialog.Ok(e, &quot;ScreenToGif&quot;, &quot;Error while executing a task&quot;, e.Message); });</a>
<a name="ln3605">                            }</a>
<a name="ln3606">                        }</a>
<a name="ln3607"> </a>
<a name="ln3608">                        #region Reset the previewer state</a>
<a name="ln3609"> </a>
<a name="ln3610">                        Dispatcher.Invoke(() =&gt;</a>
<a name="ln3611">                        {</a>
<a name="ln3612">                            ZoomBoxControl.ImageSource = null;</a>
<a name="ln3613"> </a>
<a name="ln3614">                            OverlayGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln3615">                            OverlayGrid.Opacity = 0;</a>
<a name="ln3616">                        });</a>
<a name="ln3617"> </a>
<a name="ln3618">                        #endregion</a>
<a name="ln3619">                    }</a>
<a name="ln3620">                }</a>
<a name="ln3621"> </a>
<a name="ln3622">                #region Load frames into the ListView</a>
<a name="ln3623"> </a>
<a name="ln3624">                Dispatcher.Invoke(() =&gt; _viewModel.Frames.Clear());</a>
<a name="ln3625"> </a>
<a name="ln3626">                foreach (var frame in Project.Frames)</a>
<a name="ln3627">                {</a>
<a name="ln3628">                    if (_abortLoading)</a>
<a name="ln3629">                        break;</a>
<a name="ln3630"> </a>
<a name="ln3631">                    frame.Index = count++;</a>
<a name="ln3632"> </a>
<a name="ln3633">                    Dispatcher.Invoke(() =&gt;</a>
<a name="ln3634">                    {</a>
<a name="ln3635">                        var item = new FrameViewModel</a>
<a name="ln3636">                        {</a>
<a name="ln3637">                            Number = frame.Index,</a>
<a name="ln3638">                            Image = frame.Path,</a>
<a name="ln3639">                            Delay = frame.Delay</a>
<a name="ln3640">                        };</a>
<a name="ln3641"> </a>
<a name="ln3642">                        _viewModel.Frames.Add(item);</a>
<a name="ln3643"> </a>
<a name="ln3644">                        UpdateProgress(item.Number);</a>
<a name="ln3645">                    });</a>
<a name="ln3646">                }</a>
<a name="ln3647"> </a>
<a name="ln3648">                if (_abortLoading)</a>
<a name="ln3649">                    return false;</a>
<a name="ln3650"> </a>
<a name="ln3651">                if (corruptedList.Any())</a>
<a name="ln3652">                {</a>
<a name="ln3653">                    Dispatcher.InvokeAsync(() =&gt;</a>
<a name="ln3654">                    {</a>
<a name="ln3655">                        Dialog.Ok(LocalizationHelper.Get(&quot;S.Editor.LoadingFrames&quot;), LocalizationHelper.Get(&quot;S.Editor.LoadingFrames.FramesCorrupted.Instruction&quot;),</a>
<a name="ln3656">                            LocalizationHelper.Get(&quot;S.Editor.LoadingFrames.FramesCorrupted.Message&quot;));</a>
<a name="ln3657">                    });</a>
<a name="ln3658">                }</a>
<a name="ln3659"> </a>
<a name="ln3660">                #endregion</a>
<a name="ln3661"> </a>
<a name="ln3662">                return true;</a>
<a name="ln3663">            }</a>
<a name="ln3664">            catch (Exception ex)</a>
<a name="ln3665">            {</a>
<a name="ln3666">                LogWriter.Log(ex, &quot;Error in loading frames&quot;);</a>
<a name="ln3667">                Dispatcher.Invoke(() =&gt; ErrorDialog.Ok(Title, &quot;Error loading frames&quot;, &quot;It was not possible to load all the frames.&quot;, ex));</a>
<a name="ln3668"> </a>
<a name="ln3669">                return false;</a>
<a name="ln3670">            }</a>
<a name="ln3671">            finally</a>
<a name="ln3672">            {</a>
<a name="ln3673">                _abortLoading = false;</a>
<a name="ln3674">            }</a>
<a name="ln3675">        }</a>
<a name="ln3676"> </a>
<a name="ln3677">        private async void LoadCallback(bool result)</a>
<a name="ln3678">        {</a>
<a name="ln3679">            Cursor = Cursors.Arrow;</a>
<a name="ln3680">            IsLoading = false;</a>
<a name="ln3681">            IsCancelable = false;</a>
<a name="ln3682"> </a>
<a name="ln3683">            if (Project.Any)</a>
<a name="ln3684">                FilledList = true;</a>
<a name="ln3685"> </a>
<a name="ln3686">            if (!result)</a>
<a name="ln3687">            {</a>
<a name="ln3688">                CancelLoadingButton.IsEnabled = true; //TODO: Is this right?</a>
<a name="ln3689"> </a>
<a name="ln3690">                await Task.Run(() =&gt; Discard(Project));</a>
<a name="ln3691"> </a>
<a name="ln3692">                WelcomeGrid.BeginStoryboard(this.FindStoryboard(&quot;ShowWelcomeBorderStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln3693"> </a>
<a name="ln3694">                FilledList = false;</a>
<a name="ln3695">                IsLoading = false;</a>
<a name="ln3696"> </a>
<a name="ln3697">                WelcomeTextBlock.Text = LocalizationHelper.Get(Humanizer.WelcomeInfo());</a>
<a name="ln3698">                SymbolTextBlock.Text = Humanizer.Welcome();</a>
<a name="ln3699"> </a>
<a name="ln3700">                UpdateStatistics();</a>
<a name="ln3701"> </a>
<a name="ln3702">                FrameListView.SelectionChanged += FrameListView_SelectionChanged;</a>
<a name="ln3703"> </a>
<a name="ln3704">                CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3705"> </a>
<a name="ln3706">                return;</a>
<a name="ln3707">            }</a>
<a name="ln3708"> </a>
<a name="ln3709">            FrameListView.SelectedIndex = -1;</a>
<a name="ln3710">            FrameListView.SelectedIndex = 0; //TODO: Get the latest selected frame if it's the same project.</a>
<a name="ln3711">            ZoomBoxControl.PixelSize = Project.Frames[0].Path.ScaledSize();</a>
<a name="ln3712">            ZoomBoxControl.ImageScale = Project.Frames[0].Path.ScaleOf();</a>
<a name="ln3713">            ZoomBoxControl.RefreshImage();</a>
<a name="ln3714"> </a>
<a name="ln3715">            //ListBoxSelector.SetIsEnabled(FrameListView, true);</a>
<a name="ln3716">            //new ListBoxSelector(FrameListView);</a>
<a name="ln3717"> </a>
<a name="ln3718">            HideProgress();</a>
<a name="ln3719">            UpdateStatistics();</a>
<a name="ln3720"> </a>
<a name="ln3721">            WelcomeGrid.BeginStoryboard(this.FindStoryboard(&quot;HideWelcomeBorderStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln3722"> </a>
<a name="ln3723">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3724"> </a>
<a name="ln3725">            SetFocusOnCurrentFrame();</a>
<a name="ln3726"> </a>
<a name="ln3727">            //Adjust the window size based on the frame size.</a>
<a name="ln3728">            if (UserSettings.All.AutomaticallySizeOnContent &amp;&amp; SizeToContentCommand.Command != null &amp;&amp; SizeToContentCommand.Command.CanExecute(null))</a>
<a name="ln3729">                SizeToContentCommand.Command.Execute(null);</a>
<a name="ln3730"> </a>
<a name="ln3731">            //Adjust the frame zoom based on the window size.</a>
<a name="ln3732">            if (UserSettings.All.AutomaticallyFitImage &amp;&amp; FitImageCommand.Command != null &amp;&amp; FitImageCommand.Command.CanExecute(null))</a>
<a name="ln3733">                FitImageCommand.Command.Execute(null);</a>
<a name="ln3734">        }</a>
<a name="ln3735"> </a>
<a name="ln3736">        #endregion</a>
<a name="ln3737"> </a>
<a name="ln3738">        #region Async Selective Loading</a>
<a name="ln3739"> </a>
<a name="ln3740">        private async Task LoadSelectedStarter(int start, int? end = null)</a>
<a name="ln3741">        {</a>
<a name="ln3742">            Cursor = Cursors.AppStarting;</a>
<a name="ln3743">            IsLoading = true;</a>
<a name="ln3744">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.UpdatingFrames&quot;), Project.Frames.Count, true);</a>
<a name="ln3745"> </a>
<a name="ln3746">            //Persists the project to the disk.</a>
<a name="ln3747">            await Task.Run(() =&gt; Project.Persist());</a>
<a name="ln3748"> </a>
<a name="ln3749">            await Task.Run(() =&gt; LoadSelected(start, end));</a>
<a name="ln3750"> </a>
<a name="ln3751">            //Adjust the UI.</a>
<a name="ln3752">            Cursor = Cursors.Arrow;</a>
<a name="ln3753">            HideProgress();</a>
<a name="ln3754"> </a>
<a name="ln3755">            if (LastSelected != -1)</a>
<a name="ln3756">            {</a>
<a name="ln3757">                ZoomBoxControl.ImageSource = null;</a>
<a name="ln3758"> </a>
<a name="ln3759">                var valid = Project.ValidIndex(LastSelected);</a>
<a name="ln3760"> </a>
<a name="ln3761">                if (valid &gt; -1)</a>
<a name="ln3762">                {</a>
<a name="ln3763">                    ZoomBoxControl.ImageSource = Project.Frames[valid].Path;</a>
<a name="ln3764">                    ZoomBoxControl.PixelSize = Project.Frames[0].Path.ScaledSize();</a>
<a name="ln3765">                    ZoomBoxControl.ImageScale = Project.Frames[0].Path.ScaleOf();</a>
<a name="ln3766">                    ZoomBoxControl.RefreshImage();</a>
<a name="ln3767">                    FrameListView.ScrollIntoView(_viewModel.Frames[valid]);</a>
<a name="ln3768">                }</a>
<a name="ln3769">            }</a>
<a name="ln3770"> </a>
<a name="ln3771">            UpdateStatistics();</a>
<a name="ln3772"> </a>
<a name="ln3773">            IsLoading = false;</a>
<a name="ln3774">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3775"> </a>
<a name="ln3776">            SetFocusOnCurrentFrame();</a>
<a name="ln3777">        }</a>
<a name="ln3778"> </a>
<a name="ln3779">        private bool LoadSelected(int start, int? end)</a>
<a name="ln3780">        {</a>
<a name="ln3781">            end ??= Project.Frames.Count - 1;</a>
<a name="ln3782">            UpdateProgress(0);</a>
<a name="ln3783"> </a>
<a name="ln3784">            try</a>
<a name="ln3785">            {</a>
<a name="ln3786">                //Perhaps there's no need for part of this anymore, since there's a working virtualization now.</a>
<a name="ln3787">                Dispatcher.Invoke(() =&gt;</a>
<a name="ln3788">                {</a>
<a name="ln3789">                    //For each changed frame.</a>
<a name="ln3790">                    for (var index = start; index &lt;= end; index++)</a>
<a name="ln3791">                    {</a>
<a name="ln3792">                        //Check if within limits.</a>
<a name="ln3793">                        if (index &lt;= _viewModel.Frames.Count - 1)</a>
<a name="ln3794">                        {</a>
<a name="ln3795">                            #region Edit the existing frame</a>
<a name="ln3796"> </a>
<a name="ln3797">                            var frame = _viewModel.Frames[index];</a>
<a name="ln3798">                            frame.Number = index;</a>
<a name="ln3799">                            frame.Delay = Project.Frames[index].Delay;</a>
<a name="ln3800">                            frame.Image = null; //To update the image.</a>
<a name="ln3801">                            frame.Image = Project.Frames[index].Path;</a>
<a name="ln3802"> </a>
<a name="ln3803">                            Project.Frames[index].Index = index;</a>
<a name="ln3804"> </a>
<a name="ln3805">                            #endregion</a>
<a name="ln3806">                        }</a>
<a name="ln3807">                        else</a>
<a name="ln3808">                        {</a>
<a name="ln3809">                            #region Create another frame</a>
<a name="ln3810"> </a>
<a name="ln3811">                            _viewModel.Frames.Add(new FrameViewModel</a>
<a name="ln3812">                            {</a>
<a name="ln3813">                                Number = index,</a>
<a name="ln3814">                                Image = Project.Frames[index].Path,</a>
<a name="ln3815">                                Delay = Project.Frames[index].Delay</a>
<a name="ln3816">                            });</a>
<a name="ln3817"> </a>
<a name="ln3818">                            Project.Frames[index].Index = index;</a>
<a name="ln3819"> </a>
<a name="ln3820">                            #endregion</a>
<a name="ln3821">                        }</a>
<a name="ln3822"> </a>
<a name="ln3823">                        UpdateProgress(index);</a>
<a name="ln3824">                    }</a>
<a name="ln3825">                });</a>
<a name="ln3826"> </a>
<a name="ln3827">                if (Project.Frames.Count &gt; 0)</a>
<a name="ln3828">                    Dispatcher.Invoke(() =&gt; { FilledList = true; });</a>
<a name="ln3829"> </a>
<a name="ln3830">                return true;</a>
<a name="ln3831">            }</a>
<a name="ln3832">            catch (Exception ex)</a>
<a name="ln3833">            {</a>
<a name="ln3834">                LogWriter.Log(ex, &quot;Frame Loading Error&quot;);</a>
<a name="ln3835">                return false;</a>
<a name="ln3836">            }</a>
<a name="ln3837">        }</a>
<a name="ln3838"> </a>
<a name="ln3839">        #endregion</a>
<a name="ln3840"> </a>
<a name="ln3841">        #region Async Import</a>
<a name="ln3842"> </a>
<a name="ln3843">        private List&lt;FrameInfo&gt; InsertInternal(string fileName, string pathTemp, ref Size previousSize, ref double previousDpi, ref bool warn, ref bool warnSize)</a>
<a name="ln3844">        {</a>
<a name="ln3845">            List&lt;FrameInfo&gt; listFrames;</a>
<a name="ln3846"> </a>
<a name="ln3847">            try</a>
<a name="ln3848">            {</a>
<a name="ln3849">                switch (fileName.Split('.').Last().ToLowerInvariant())</a>
<a name="ln3850">                {</a>
<a name="ln3851">                    case &quot;stg&quot;:</a>
<a name="ln3852">                    case &quot;zip&quot;:</a>
<a name="ln3853">                    {</a>
<a name="ln3854">                        listFrames = ImportFromProject(fileName, pathTemp);</a>
<a name="ln3855">                        break;</a>
<a name="ln3856">                    }</a>
<a name="ln3857"> </a>
<a name="ln3858">                    case &quot;gif&quot;:</a>
<a name="ln3859">                    {</a>
<a name="ln3860">                        listFrames = ImportFromGif(fileName, pathTemp);</a>
<a name="ln3861">                        break;</a>
<a name="ln3862">                    }</a>
<a name="ln3863"> </a>
<a name="ln3864">                    case &quot;avi&quot;:</a>
<a name="ln3865">                    case &quot;avif&quot;:</a>
<a name="ln3866">                    case &quot;mkv&quot;:</a>
<a name="ln3867">                    case &quot;mp4&quot;:</a>
<a name="ln3868">                    case &quot;wmv&quot;:</a>
<a name="ln3869">                    case &quot;webp&quot;:</a>
<a name="ln3870">                    case &quot;webm&quot;:</a>
<a name="ln3871">                    {</a>
<a name="ln3872">                        listFrames = ImportFromVideo(fileName, pathTemp);</a>
<a name="ln3873">                        break;</a>
<a name="ln3874">                    }</a>
<a name="ln3875"> </a>
<a name="ln3876">                    case &quot;apng&quot;:</a>
<a name="ln3877">                    case &quot;png&quot;:</a>
<a name="ln3878">                    {</a>
<a name="ln3879">                        listFrames = ImportFromPng(fileName, pathTemp, ref previousSize, ref previousDpi, ref warn, ref warnSize);</a>
<a name="ln3880">                        break;</a>
<a name="ln3881">                    }</a>
<a name="ln3882"> </a>
<a name="ln3883">                    default:</a>
<a name="ln3884">                    {</a>
<a name="ln3885">                        listFrames = ImportFromImage(fileName, pathTemp, ref previousSize, ref previousDpi, ref warn, ref warnSize);</a>
<a name="ln3886">                        break;</a>
<a name="ln3887">                    }</a>
<a name="ln3888">                }</a>
<a name="ln3889">            }</a>
<a name="ln3890">            catch (Exception ex)</a>
<a name="ln3891">            {</a>
<a name="ln3892">                LogWriter.Log(ex, &quot;Import error&quot;);</a>
<a name="ln3893"> </a>
<a name="ln3894">                return new List&lt;FrameInfo&gt;();</a>
<a name="ln3895">            }</a>
<a name="ln3896"> </a>
<a name="ln3897">            return listFrames;</a>
<a name="ln3898">        }</a>
<a name="ln3899"> </a>
<a name="ln3900">        private bool ImportFrom(IList&lt;string&gt; fileList)</a>
<a name="ln3901">        {</a>
<a name="ln3902">            #region Disable UI</a>
<a name="ln3903"> </a>
<a name="ln3904">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln3905">            {</a>
<a name="ln3906">                Cursor = Cursors.AppStarting;</a>
<a name="ln3907">                IsLoading = true;</a>
<a name="ln3908">            });</a>
<a name="ln3909"> </a>
<a name="ln3910">            #endregion</a>
<a name="ln3911"> </a>
<a name="ln3912">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.PreparingImport&quot;), 100, false);</a>
<a name="ln3913"> </a>
<a name="ln3914">            var project = new ProjectInfo().CreateProjectFolder(ProjectByType.Editor);</a>
<a name="ln3915">            var currentDpi = 0D;</a>
<a name="ln3916">            var currentSize = Size.Empty;</a>
<a name="ln3917">            var wasWarned = false;</a>
<a name="ln3918">            var wasWarnedSized = false;</a>
<a name="ln3919"> </a>
<a name="ln3920">            //Adds each image to a list.</a>
<a name="ln3921">            foreach (var file in fileList)</a>
<a name="ln3922">            {</a>
<a name="ln3923">                if (Dispatcher.HasShutdownStarted)</a>
<a name="ln3924">                    return false;</a>
<a name="ln3925"> </a>
<a name="ln3926">                var warn = false;</a>
<a name="ln3927">                var warnSize = false;</a>
<a name="ln3928">                var frame = InsertInternal(file, project.FullPath, ref currentSize, ref currentDpi, ref warn, ref warnSize);</a>
<a name="ln3929"> </a>
<a name="ln3930">                //Size and DPI validations.</a>
<a name="ln3931">                if (warnSize &amp;&amp; !wasWarnedSized)</a>
<a name="ln3932">                {</a>
<a name="ln3933">                    wasWarnedSized = true;</a>
<a name="ln3934">                    Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Warning.DifferentSize&quot;)));</a>
<a name="ln3935">                    continue;</a>
<a name="ln3936">                }</a>
<a name="ln3937"> </a>
<a name="ln3938">                if (warn &amp;&amp; !wasWarned)</a>
<a name="ln3939">                {</a>
<a name="ln3940">                    wasWarned = true;</a>
<a name="ln3941">                    Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Warning.DifferentDpi&quot;)));</a>
<a name="ln3942">                    continue;</a>
<a name="ln3943">                }</a>
<a name="ln3944"> </a>
<a name="ln3945">                if (frame != null)</a>
<a name="ln3946">                    project.Frames.AddRange(frame);</a>
<a name="ln3947">            }</a>
<a name="ln3948"> </a>
<a name="ln3949">            if (project.Frames.Count == 0)</a>
<a name="ln3950">            {</a>
<a name="ln3951">                if (Dispatcher.HasShutdownStarted)</a>
<a name="ln3952">                    return false;</a>
<a name="ln3953"> </a>
<a name="ln3954">                Dispatcher.Invoke(() =&gt;</a>
<a name="ln3955">                {</a>
<a name="ln3956">                    Cursor = Cursors.Arrow;</a>
<a name="ln3957">                    IsLoading = false;</a>
<a name="ln3958"> </a>
<a name="ln3959">                    if (project.Any)</a>
<a name="ln3960">                        FilledList = true;</a>
<a name="ln3961"> </a>
<a name="ln3962">                    HideProgress();</a>
<a name="ln3963"> </a>
<a name="ln3964">                    CommandManager.InvalidateRequerySuggested();</a>
<a name="ln3965">                    SetFocusOnCurrentFrame();</a>
<a name="ln3966">                });</a>
<a name="ln3967"> </a>
<a name="ln3968">                return false;</a>
<a name="ln3969">            }</a>
<a name="ln3970"> </a>
<a name="ln3971">            Dispatcher.Invoke(() =&gt; LoadProject(project));</a>
<a name="ln3972"> </a>
<a name="ln3973">            return true;</a>
<a name="ln3974">        }</a>
<a name="ln3975"> </a>
<a name="ln3976">        private async Task&lt;bool&gt; InsertImportFrom(List&lt;string&gt; fileList)</a>
<a name="ln3977">        {</a>
<a name="ln3978">            #region Disable UI</a>
<a name="ln3979"> </a>
<a name="ln3980">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln3981">            {</a>
<a name="ln3982">                Cursor = Cursors.AppStarting;</a>
<a name="ln3983">                IsLoading = true;</a>
<a name="ln3984">            });</a>
<a name="ln3985"> </a>
<a name="ln3986">            #endregion</a>
<a name="ln3987"> </a>
<a name="ln3988">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.PreparingImport&quot;), 100);</a>
<a name="ln3989"> </a>
<a name="ln3990">            var project = new ProjectInfo().CreateProjectFolder(ProjectByType.Editor);</a>
<a name="ln3991">            var currentDpi = 0D;</a>
<a name="ln3992">            var currentSize = Size.Empty;</a>
<a name="ln3993">            var wasWarned = false;</a>
<a name="ln3994">            var wasWarnedSized = false;</a>
<a name="ln3995"> </a>
<a name="ln3996">            //Adds each image to a list.</a>
<a name="ln3997">            foreach (var file in fileList)</a>
<a name="ln3998">            {</a>
<a name="ln3999">                if (Dispatcher.HasShutdownStarted)</a>
<a name="ln4000">                    return false;</a>
<a name="ln4001"> </a>
<a name="ln4002">                var warn = false;</a>
<a name="ln4003">                var warnSize = false;</a>
<a name="ln4004">                var frame = InsertInternal(file, project.FullPath, ref currentSize, ref currentDpi, ref warn, ref warnSize);</a>
<a name="ln4005"> </a>
<a name="ln4006">                //Size and DPI validations.</a>
<a name="ln4007">                if (warnSize &amp;&amp; !wasWarnedSized)</a>
<a name="ln4008">                {</a>
<a name="ln4009">                    wasWarnedSized = true;</a>
<a name="ln4010">                    Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Warning.DifferentSize&quot;)));</a>
<a name="ln4011">                    continue;</a>
<a name="ln4012">                }</a>
<a name="ln4013"> </a>
<a name="ln4014">                if (warn &amp;&amp; !wasWarned)</a>
<a name="ln4015">                {</a>
<a name="ln4016">                    wasWarned = true;</a>
<a name="ln4017">                    Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.Editor.Warning.DifferentDpi&quot;)));</a>
<a name="ln4018">                    continue;</a>
<a name="ln4019">                }</a>
<a name="ln4020"> </a>
<a name="ln4021">                if (frame != null)</a>
<a name="ln4022">                    project.Frames.AddRange(frame);</a>
<a name="ln4023">            }</a>
<a name="ln4024"> </a>
<a name="ln4025">            if (!project.Any)</a>
<a name="ln4026">            {</a>
<a name="ln4027">                project.ReleaseMutex();</a>
<a name="ln4028"> </a>
<a name="ln4029">                Dispatcher.Invoke(() =&gt;</a>
<a name="ln4030">                {</a>
<a name="ln4031">                    Cursor = Cursors.Arrow;</a>
<a name="ln4032">                    IsLoading = false;</a>
<a name="ln4033">                });</a>
<a name="ln4034"> </a>
<a name="ln4035">                return false;</a>
<a name="ln4036">            }</a>
<a name="ln4037"> </a>
<a name="ln4038">            var list = Dispatcher.Invoke(() =&gt;</a>
<a name="ln4039">            {</a>
<a name="ln4040">                #region Insert</a>
<a name="ln4041"> </a>
<a name="ln4042">                var insert = new Insert(Project.Frames, project.Frames, FrameListView.SelectedIndex) { Owner = this };</a>
<a name="ln4043">                var result = insert.ShowDialog();</a>
<a name="ln4044"> </a>
<a name="ln4045">                if (result.HasValue &amp;&amp; result.Value)</a>
<a name="ln4046">                    return insert.CurrentList;</a>
<a name="ln4047"> </a>
<a name="ln4048">                return null;</a>
<a name="ln4049"> </a>
<a name="ln4050">                #endregion</a>
<a name="ln4051">            });</a>
<a name="ln4052"> </a>
<a name="ln4053">            project.ReleaseMutex();</a>
<a name="ln4054"> </a>
<a name="ln4055">            if (list != null)</a>
<a name="ln4056">            {</a>
<a name="ln4057">                ActionStack.SaveState(ActionStack.EditAction.Add, FrameListView.SelectedIndex, project.Frames.Count);</a>
<a name="ln4058"> </a>
<a name="ln4059">                Dispatcher.Invoke(() =&gt; Project.Frames = list);</a>
<a name="ln4060"> </a>
<a name="ln4061">                await LoadSelectedStarter(FrameListView.SelectedIndex, Project.Frames.Count - 1); //Check</a>
<a name="ln4062"> </a>
<a name="ln4063">                return true;</a>
<a name="ln4064">            }</a>
<a name="ln4065"> </a>
<a name="ln4066">            #region Enabled the UI</a>
<a name="ln4067"> </a>
<a name="ln4068">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln4069">            {</a>
<a name="ln4070">                HideProgress();</a>
<a name="ln4071"> </a>
<a name="ln4072">                if (LastSelected != -1)</a>
<a name="ln4073">                {</a>
<a name="ln4074">                    ZoomBoxControl.ImageSource = null;</a>
<a name="ln4075">                    ZoomBoxControl.ImageSource = Project.Frames[LastSelected].Path;</a>
<a name="ln4076"> </a>
<a name="ln4077">                    FrameListView.ScrollIntoView(_viewModel.Frames[LastSelected]);</a>
<a name="ln4078">                }</a>
<a name="ln4079"> </a>
<a name="ln4080">                Cursor = Cursors.Arrow;</a>
<a name="ln4081">                IsLoading = false;</a>
<a name="ln4082">            });</a>
<a name="ln4083"> </a>
<a name="ln4084">            #endregion</a>
<a name="ln4085"> </a>
<a name="ln4086">            return false;</a>
<a name="ln4087">        }</a>
<a name="ln4088"> </a>
<a name="ln4089">        #endregion</a>
<a name="ln4090"> </a>
<a name="ln4091">        private List&lt;FrameInfo&gt; ImportFromProject(string source, string pathTemp)</a>
<a name="ln4092">        {</a>
<a name="ln4093">            try</a>
<a name="ln4094">            {</a>
<a name="ln4095">                //Extract to the folder of the newly created project.</a>
<a name="ln4096">                ZipFile.ExtractToDirectory(source, pathTemp);</a>
<a name="ln4097"> </a>
<a name="ln4098">                List&lt;FrameInfo&gt; list;</a>
<a name="ln4099"> </a>
<a name="ln4100">                if (File.Exists(Path.Combine(pathTemp, &quot;Project.json&quot;)))</a>
<a name="ln4101">                {</a>
<a name="ln4102">                    //Read as text.</a>
<a name="ln4103">                    var json = File.ReadAllText(Path.Combine(pathTemp, &quot;Project.json&quot;));</a>
<a name="ln4104"> </a>
<a name="ln4105">                    using (var ms = new MemoryStream(Encoding.UTF8.GetBytes(json)))</a>
<a name="ln4106">                    {</a>
<a name="ln4107">                        var ser = new DataContractJsonSerializer(typeof(ProjectInfo));</a>
<a name="ln4108">                        var project = ser.ReadObject(ms) as ProjectInfo;</a>
<a name="ln4109"> </a>
<a name="ln4110">                        list = project?.Frames;</a>
<a name="ln4111">                    }</a>
<a name="ln4112">                }</a>
<a name="ln4113">                else</a>
<a name="ln4114">                {</a>
<a name="ln4115">                    if (File.Exists(Path.Combine(pathTemp, &quot;List.sb&quot;)))</a>
<a name="ln4116">                        throw new Exception(&quot;Project not compatible with this version&quot;);</a>
<a name="ln4117"> </a>
<a name="ln4118">                    throw new FileNotFoundException(&quot;Impossible to open project.&quot;, &quot;List.sb&quot;);</a>
<a name="ln4119">                }</a>
<a name="ln4120"> </a>
<a name="ln4121">                //Shows the ProgressBar</a>
<a name="ln4122">                ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ImportingFrames&quot;), list?.Count ?? 0);</a>
<a name="ln4123"> </a>
<a name="ln4124">                var count = 0;</a>
<a name="ln4125">                foreach (var frame in list ?? [])</a>
<a name="ln4126">                {</a>
<a name="ln4127">                    //Change the file path to the current one.</a>
<a name="ln4128">                    frame.Path = Path.Combine(pathTemp, Path.GetFileName(frame.Path));</a>
<a name="ln4129"> </a>
<a name="ln4130">                    count++;</a>
<a name="ln4131">                    UpdateProgress(count);</a>
<a name="ln4132">                }</a>
<a name="ln4133"> </a>
<a name="ln4134">                return list;</a>
<a name="ln4135">            }</a>
<a name="ln4136">            catch (Exception ex)</a>
<a name="ln4137">            {</a>
<a name="ln4138">                LogWriter.Log(ex, &quot;Importing project&quot;);</a>
<a name="ln4139">                Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;ScreenToGif&quot;, &quot;Impossible to load project&quot;, ex.Message));</a>
<a name="ln4140"> </a>
<a name="ln4141">                return [];</a>
<a name="ln4142">            }</a>
<a name="ln4143">        }</a>
<a name="ln4144"> </a>
<a name="ln4145">        private List&lt;FrameInfo&gt; ImportFromGif(string source, string pathTemp)</a>
<a name="ln4146">        {</a>
<a name="ln4147">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ImportingFrames&quot;), 50, true);</a>
<a name="ln4148"> </a>
<a name="ln4149">            var listFrames = new List&lt;FrameInfo&gt;();</a>
<a name="ln4150"> </a>
<a name="ln4151">            var decoder = ImageMethods.GetDecoder(source, out var gifMetadata) as GifBitmapDecoder;</a>
<a name="ln4152"> </a>
<a name="ln4153">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ImportingFrames&quot;), decoder?.Frames?.Count ?? 0);</a>
<a name="ln4154"> </a>
<a name="ln4155">            if (decoder == null || decoder?.Frames.Count &lt;= 0)</a>
<a name="ln4156">                return listFrames;</a>
<a name="ln4157"> </a>
<a name="ln4158">            var fullSize = ImageMethods.GetFullSize(decoder, gifMetadata);</a>
<a name="ln4159">            var index = 0;</a>
<a name="ln4160"> </a>
<a name="ln4161">            BitmapSource baseFrame = null;</a>
<a name="ln4162">            foreach (var rawFrame in decoder.Frames)</a>
<a name="ln4163">            {</a>
<a name="ln4164">                var metadata = ImageMethods.GetFrameMetadata(decoder, gifMetadata, index);</a>
<a name="ln4165"> </a>
<a name="ln4166">                var bitmapSource = ImageMethods.MakeFrame(fullSize, rawFrame, metadata, baseFrame, 96D);</a>
<a name="ln4167"> </a>
<a name="ln4168">                #region Disposal Method</a>
<a name="ln4169"> </a>
<a name="ln4170">                switch (metadata.DisposalMethod)</a>
<a name="ln4171">                {</a>
<a name="ln4172">                    case FrameDisposalMethod.None:</a>
<a name="ln4173">                    case FrameDisposalMethod.DoNotDispose:</a>
<a name="ln4174">                        baseFrame = bitmapSource;</a>
<a name="ln4175">                        break;</a>
<a name="ln4176">                    case FrameDisposalMethod.RestoreBackground:</a>
<a name="ln4177">                        baseFrame = ImageMethods.IsFullFrame(metadata, fullSize) ? null : ImageMethods.ClearArea(bitmapSource, metadata, 96D);</a>
<a name="ln4178">                        break;</a>
<a name="ln4179">                    case FrameDisposalMethod.RestorePrevious:</a>
<a name="ln4180">                        //Reuse same base frame.</a>
<a name="ln4181">                        break;</a>
<a name="ln4182">                }</a>
<a name="ln4183"> </a>
<a name="ln4184">                #endregion</a>
<a name="ln4185"> </a>
<a name="ln4186">                #region Each Frame</a>
<a name="ln4187"> </a>
<a name="ln4188">                var fileName = Path.Combine(pathTemp, $&quot;{index} {DateTime.Now:hh-mm-ss-ffff}.png&quot;);</a>
<a name="ln4189"> </a>
<a name="ln4190">                using (var stream = new FileStream(fileName, FileMode.Create))</a>
<a name="ln4191">                {</a>
<a name="ln4192">                    var encoder = new PngBitmapEncoder();</a>
<a name="ln4193">                    encoder.Frames.Add(BitmapFrame.Create(bitmapSource));</a>
<a name="ln4194">                    encoder.Save(stream);</a>
<a name="ln4195">                    stream.Close();</a>
<a name="ln4196">                }</a>
<a name="ln4197"> </a>
<a name="ln4198">                //It should not throw a overflow exception because of the maximum value for the milliseconds.</a>
<a name="ln4199">                var frame = new FrameInfo(fileName, (int)metadata.Delay.TotalMilliseconds);</a>
<a name="ln4200">                listFrames.Add(frame);</a>
<a name="ln4201"> </a>
<a name="ln4202">                UpdateProgress(index);</a>
<a name="ln4203"> </a>
<a name="ln4204">                GC.Collect(1);</a>
<a name="ln4205"> </a>
<a name="ln4206">                #endregion</a>
<a name="ln4207"> </a>
<a name="ln4208">                index++;</a>
<a name="ln4209">            }</a>
<a name="ln4210"> </a>
<a name="ln4211">            return listFrames;</a>
<a name="ln4212">        }</a>
<a name="ln4213"> </a>
<a name="ln4214">        private List&lt;FrameInfo&gt; ImportFromPng(string source, string pathTemp, ref Size previousSize, ref double previousDpi, ref bool warn, ref bool warnSize)</a>
<a name="ln4215">        {</a>
<a name="ln4216">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ImportingFrames&quot;), 50, true);</a>
<a name="ln4217"> </a>
<a name="ln4218">            using (var stream = new FileStream(source, FileMode.Open, FileAccess.Read, FileShare.Read))</a>
<a name="ln4219">            {</a>
<a name="ln4220">                var apng = new Apng(stream);</a>
<a name="ln4221">                var success = apng.ReadFrames();</a>
<a name="ln4222"> </a>
<a name="ln4223">                if (!success)</a>
<a name="ln4224">                    return ImportFromImage(source, pathTemp, ref previousSize, ref previousDpi, ref warn, ref warnSize);</a>
<a name="ln4225"> </a>
<a name="ln4226">                var fullSize = new System.Drawing.Size((int)apng.Ihdr.Width, (int)apng.Ihdr.Height);</a>
<a name="ln4227">                var list = new List&lt;FrameInfo&gt;();</a>
<a name="ln4228"> </a>
<a name="ln4229">                BitmapSource baseFrame = null;</a>
<a name="ln4230">                for (var index = 0; index &lt; apng.Actl.NumFrames; index++)</a>
<a name="ln4231">                {</a>
<a name="ln4232">                    var metadata = apng.GetFrame(index);</a>
<a name="ln4233">                    var rawFrame = metadata.ImageData.SourceFrom();</a>
<a name="ln4234"> </a>
<a name="ln4235">                    var bitmapSource = Apng.MakeFrame(fullSize, rawFrame, metadata, baseFrame);</a>
<a name="ln4236"> </a>
<a name="ln4237">                    #region Disposal Method</a>
<a name="ln4238"> </a>
<a name="ln4239">                    switch (metadata.DisposeOp)</a>
<a name="ln4240">                    {</a>
<a name="ln4241">                        case Apng.DisposeOps.None: //No disposal is done on this frame before rendering the next; the contents of the output buffer are left as is.</a>
<a name="ln4242">                            baseFrame = bitmapSource;</a>
<a name="ln4243">                            break;</a>
<a name="ln4244">                        case Apng.DisposeOps.Background: //The frame's region of the output buffer is to be cleared to fully transparent black before rendering the next frame.</a>
<a name="ln4245">                            baseFrame = baseFrame == null || Apng.IsFullFrame(metadata, fullSize) ? null : Apng.ClearArea(baseFrame, metadata);</a>
<a name="ln4246">                            break;</a>
<a name="ln4247">                        case Apng.DisposeOps.Previous: //The frame's region of the output buffer is to be reverted to the previous contents before rendering the next frame.</a>
<a name="ln4248">                            //Reuse same base frame.</a>
<a name="ln4249">                            break;</a>
<a name="ln4250">                    }</a>
<a name="ln4251"> </a>
<a name="ln4252">                    #endregion</a>
<a name="ln4253"> </a>
<a name="ln4254">                    #region Each Frame</a>
<a name="ln4255"> </a>
<a name="ln4256">                    var fileName = Path.Combine(pathTemp, $&quot;{index} {DateTime.Now:hh-mm-ss-ffff}.png&quot;);</a>
<a name="ln4257"> </a>
<a name="ln4258">                    //TODO: Do I need to verify the DPI of the image?</a>
<a name="ln4259"> </a>
<a name="ln4260">                    using (var output = new FileStream(fileName, FileMode.Create))</a>
<a name="ln4261">                    {</a>
<a name="ln4262">                        var encoder = new PngBitmapEncoder();</a>
<a name="ln4263">                        encoder.Frames.Add(BitmapFrame.Create(bitmapSource));</a>
<a name="ln4264">                        encoder.Save(output);</a>
<a name="ln4265">                        stream.Close();</a>
<a name="ln4266">                    }</a>
<a name="ln4267"> </a>
<a name="ln4268">                    list.Add(new FrameInfo(fileName, metadata.Delay));</a>
<a name="ln4269"> </a>
<a name="ln4270">                    UpdateProgress(index);</a>
<a name="ln4271"> </a>
<a name="ln4272">                    GC.Collect(1);</a>
<a name="ln4273"> </a>
<a name="ln4274">                    #endregion</a>
<a name="ln4275">                }</a>
<a name="ln4276"> </a>
<a name="ln4277">                return list;</a>
<a name="ln4278">            }</a>
<a name="ln4279">        }</a>
<a name="ln4280"> </a>
<a name="ln4281">        private List&lt;FrameInfo&gt; ImportFromImage(string source, string pathTemp, ref Size previousSize, ref double previousDpi, ref bool warn, ref bool warnSize)</a>
<a name="ln4282">        {</a>
<a name="ln4283">            var fileName = Path.Combine(pathTemp, $&quot;{0} {DateTime.Now:hh-mm-ss-ffff}.png&quot;);</a>
<a name="ln4284"> </a>
<a name="ln4285">            #region Save the Image to the Recording Folder</a>
<a name="ln4286"> </a>
<a name="ln4287">            BitmapSource bitmap = new BitmapImage(new Uri(source));</a>
<a name="ln4288"> </a>
<a name="ln4289">            //Don't let it import multiple images with different DPI's.</a>
<a name="ln4290">            if (previousDpi &gt; 0 &amp;&amp; Math.Abs(previousDpi - bitmap.DpiX) &gt; 0.09)</a>
<a name="ln4291">            {</a>
<a name="ln4292">                warn = true;</a>
<a name="ln4293">                return null;</a>
<a name="ln4294">            }</a>
<a name="ln4295"> </a>
<a name="ln4296">            if (!previousSize.IsEmpty &amp;&amp; (bitmap.PixelHeight != (int)previousSize.Height || bitmap.PixelWidth != (int)previousSize.Width))</a>
<a name="ln4297">            {</a>
<a name="ln4298">                warnSize = true;</a>
<a name="ln4299">                return null;</a>
<a name="ln4300">            }</a>
<a name="ln4301"> </a>
<a name="ln4302">            if (Math.Abs(previousDpi) &lt; 0.01)</a>
<a name="ln4303">                previousDpi = bitmap.DpiX;</a>
<a name="ln4304"> </a>
<a name="ln4305">            if (bitmap.PixelHeight != (int)previousSize.Height || bitmap.PixelWidth != (int)previousSize.Width)</a>
<a name="ln4306">                previousSize = new Size(bitmap.PixelWidth, bitmap.PixelHeight);</a>
<a name="ln4307"> </a>
<a name="ln4308">            if (bitmap.Format != PixelFormats.Bgra32)</a>
<a name="ln4309">                bitmap = new FormatConvertedBitmap(bitmap, PixelFormats.Bgra32, null, 0);</a>
<a name="ln4310"> </a>
<a name="ln4311">            using (var stream = new FileStream(fileName, FileMode.Create))</a>
<a name="ln4312">            {</a>
<a name="ln4313">                var encoder = new PngBitmapEncoder();</a>
<a name="ln4314">                encoder.Frames.Add(BitmapFrame.Create(bitmap));</a>
<a name="ln4315">                encoder.Save(stream);</a>
<a name="ln4316">                stream.Close();</a>
<a name="ln4317">            }</a>
<a name="ln4318"> </a>
<a name="ln4319">            GC.Collect();</a>
<a name="ln4320"> </a>
<a name="ln4321">            #endregion</a>
<a name="ln4322"> </a>
<a name="ln4323">            return new List&lt;FrameInfo&gt; { new(fileName, 66) };</a>
<a name="ln4324">        }</a>
<a name="ln4325"> </a>
<a name="ln4326">        private List&lt;FrameInfo&gt; ImportFromVideo(string source, string pathTemp)</a>
<a name="ln4327">        {</a>
<a name="ln4328">            //Get frames from video.</a>
<a name="ln4329">            return Dispatcher?.Invoke(() =&gt;</a>
<a name="ln4330">            {</a>
<a name="ln4331">                var vid = new VideoSource</a>
<a name="ln4332">                {</a>
<a name="ln4333">                    RootFolder = pathTemp,</a>
<a name="ln4334">                    VideoPath = source,</a>
<a name="ln4335">                    Owner = this</a>
<a name="ln4336">                };</a>
<a name="ln4337">                var result = vid.ShowDialog();</a>
<a name="ln4338"> </a>
<a name="ln4339">                return result.HasValue &amp;&amp; result.Value ? vid.Frames : null;</a>
<a name="ln4340">            });</a>
<a name="ln4341">        }</a>
<a name="ln4342"> </a>
<a name="ln4343">        #endregion</a>
<a name="ln4344"> </a>
<a name="ln4345">        #region Playback</a>
<a name="ln4346"> </a>
<a name="ln4347">        private void PlayPause()</a>
<a name="ln4348">        {</a>
<a name="ln4349">            lock (UserSettings.Lock)</a>
<a name="ln4350">            {</a>
<a name="ln4351">                if (_previewToken != null || !NotPreviewing)</a>
<a name="ln4352">                {</a>
<a name="ln4353">                    if (_previewToken != null)</a>
<a name="ln4354">                    {</a>
<a name="ln4355">                        _previewToken.Cancel();</a>
<a name="ln4356">                        _previewToken.Dispose();</a>
<a name="ln4357">                        _previewToken = null;</a>
<a name="ln4358">                    }</a>
<a name="ln4359"> </a>
<a name="ln4360">                    NotPreviewing = true;</a>
<a name="ln4361">                    PlayButton.Text = LocalizationHelper.Get(&quot;S.Editor.Playback.Play&quot;);</a>
<a name="ln4362">                    PlayButton.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4363">                    PlayPauseButton.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4364"> </a>
<a name="ln4365">                    PlayMenuItem.Header = LocalizationHelper.Get(&quot;S.Editor.Playback.Play&quot;);</a>
<a name="ln4366">                    PlayMenuItem.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4367"> </a>
<a name="ln4368">                    SetFocusOnCurrentFrame();</a>
<a name="ln4369">                    UpdateOtherStatistics();</a>
<a name="ln4370">                }</a>
<a name="ln4371">                else</a>
<a name="ln4372">                {</a>
<a name="ln4373">                    NotPreviewing = false;</a>
<a name="ln4374">                    PlayButton.Text = LocalizationHelper.Get(&quot;S.Editor.Playback.Pause&quot;);</a>
<a name="ln4375">                    PlayButton.Icon = FindResource(&quot;Vector.Pause&quot;) as Brush;</a>
<a name="ln4376">                    PlayPauseButton.Icon = FindResource(&quot;Vector.Pause&quot;) as Brush;</a>
<a name="ln4377"> </a>
<a name="ln4378">                    PlayMenuItem.Header = LocalizationHelper.Get(&quot;S.Editor.Playback.Pause&quot;);</a>
<a name="ln4379">                    PlayMenuItem.Icon = FindResource(&quot;Vector.Pause&quot;) as Brush;</a>
<a name="ln4380"> </a>
<a name="ln4381">                    #region Starts playing the next frame</a>
<a name="ln4382"> </a>
<a name="ln4383">                    if (Project.Frames.Count - 1 == FrameListView.SelectedIndex)</a>
<a name="ln4384">                        FrameListView.SelectedIndex = 0;</a>
<a name="ln4385">                    else</a>
<a name="ln4386">                        FrameListView.SelectedIndex++;</a>
<a name="ln4387"> </a>
<a name="ln4388">                    #endregion</a>
<a name="ln4389"> </a>
<a name="ln4390">                    if (Project.Frames[FrameListView.SelectedIndex].Delay == 0)</a>
<a name="ln4391">                        Project.Frames[FrameListView.SelectedIndex].Delay = 10;</a>
<a name="ln4392"> </a>
<a name="ln4393">                    _previewToken = new CancellationTokenSource();</a>
<a name="ln4394">                    var selectedIndex = FrameListView.SelectedIndex;</a>
<a name="ln4395"> </a>
<a name="ln4396">                    Task.Run(() =&gt; PreviewLoop(selectedIndex), _previewToken.Token);</a>
<a name="ln4397">                }</a>
<a name="ln4398">            }</a>
<a name="ln4399">        }</a>
<a name="ln4400"> </a>
<a name="ln4401">        private void Pause()</a>
<a name="ln4402">        {</a>
<a name="ln4403">            lock (UserSettings.Lock)</a>
<a name="ln4404">            {</a>
<a name="ln4405">                if (_previewToken == null &amp;&amp; NotPreviewing)</a>
<a name="ln4406">                    return;</a>
<a name="ln4407"> </a>
<a name="ln4408">                if (_previewToken != null)</a>
<a name="ln4409">                {</a>
<a name="ln4410">                    _previewToken.Cancel();</a>
<a name="ln4411">                    _previewToken.Dispose();</a>
<a name="ln4412">                    _previewToken = null;</a>
<a name="ln4413">                }</a>
<a name="ln4414"> </a>
<a name="ln4415">                NotPreviewing = true;</a>
<a name="ln4416">                PlayButton.Text = LocalizationHelper.Get(&quot;S.Editor.Playback.Play&quot;);</a>
<a name="ln4417">                PlayButton.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4418">                PlayPauseButton.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4419"> </a>
<a name="ln4420">                PlayMenuItem.Header = LocalizationHelper.Get(&quot;S.Editor.Playback.Play&quot;);</a>
<a name="ln4421">                PlayMenuItem.Icon = FindResource(&quot;Vector.Play&quot;) as Brush;</a>
<a name="ln4422">            }</a>
<a name="ln4423"> </a>
<a name="ln4424">            SetFocusOnCurrentFrame();</a>
<a name="ln4425">            UpdateOtherStatistics();</a>
<a name="ln4426">        }</a>
<a name="ln4427"> </a>
<a name="ln4428">        #endregion</a>
<a name="ln4429"> </a>
<a name="ln4430">        #region UI</a>
<a name="ln4431"> </a>
<a name="ln4432">        #region Progress</a>
<a name="ln4433"> </a>
<a name="ln4434">        private void ShowProgress(string description, int maximum, bool isIndeterminate = false)</a>
<a name="ln4435">        {</a>
<a name="ln4436">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln4437">            {</a>
<a name="ln4438">                StatusLabel.Content = description;</a>
<a name="ln4439">                StatusProgressBar.Maximum = maximum;</a>
<a name="ln4440">                StatusProgressBar.Value = 0;</a>
<a name="ln4441">                StatusProgressBar.IsIndeterminate = isIndeterminate;</a>
<a name="ln4442">                StatusGrid.Visibility = Visibility.Visible;</a>
<a name="ln4443"> </a>
<a name="ln4444">                TaskbarItemInfo.ProgressState = isIndeterminate ? TaskbarItemProgressState.Indeterminate : TaskbarItemProgressState.Normal;</a>
<a name="ln4445">                TaskbarItemInfo.ProgressValue = 0;</a>
<a name="ln4446">            }, DispatcherPriority.Loaded);</a>
<a name="ln4447">        }</a>
<a name="ln4448"> </a>
<a name="ln4449">        private void UpdateProgress(int value)</a>
<a name="ln4450">        {</a>
<a name="ln4451">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln4452">            {</a>
<a name="ln4453">                TaskbarItemInfo.ProgressState = TaskbarItemProgressState.Normal;</a>
<a name="ln4454">                TaskbarItemInfo.ProgressValue = MathExtensions.CrossMultiplication(StatusProgressBar.Maximum, value, null) / 100d;</a>
<a name="ln4455"> </a>
<a name="ln4456">                StatusProgressBar.IsIndeterminate = false;</a>
<a name="ln4457">                StatusProgressBar.Value = value;</a>
<a name="ln4458">            });</a>
<a name="ln4459">        }</a>
<a name="ln4460"> </a>
<a name="ln4461">        private void HideProgress()</a>
<a name="ln4462">        {</a>
<a name="ln4463">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln4464">            {</a>
<a name="ln4465">                StatusGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln4466">                TaskbarItemInfo.ProgressState = TaskbarItemProgressState.None;</a>
<a name="ln4467">            });</a>
<a name="ln4468">        }</a>
<a name="ln4469"> </a>
<a name="ln4470">        #endregion</a>
<a name="ln4471"> </a>
<a name="ln4472">        private void SelectNear(int index)</a>
<a name="ln4473">        {</a>
<a name="ln4474">            if (_viewModel.Frames.Count - 1 &lt; index)</a>
<a name="ln4475">            {</a>
<a name="ln4476">                SelectFrame(_viewModel.Frames.Count - 1, true);</a>
<a name="ln4477">                return;</a>
<a name="ln4478">            }</a>
<a name="ln4479"> </a>
<a name="ln4480">            SelectFrame(index, true);</a>
<a name="ln4481">        }</a>
<a name="ln4482"> </a>
<a name="ln4483">        private void SelectFrame(int index, bool focus)</a>
<a name="ln4484">        {</a>
<a name="ln4485">            var forceScroll = FrameListView.SelectedIndex == index;</a>
<a name="ln4486"> </a>
<a name="ln4487">            WasChangingSelection = true;</a>
<a name="ln4488">            FrameListView.SelectedIndex = index;</a>
<a name="ln4489"> </a>
<a name="ln4490">            if (focus)</a>
<a name="ln4491">            {</a>
<a name="ln4492">                FrameListView.Focus();</a>
<a name="ln4493"> </a>
<a name="ln4494">                if (forceScroll)</a>
<a name="ln4495">                {</a>
<a name="ln4496">                    FrameListView.ScrollIntoView(_viewModel.Frames[FrameListView.SelectedIndex]);</a>
<a name="ln4497"> </a>
<a name="ln4498">                    SetFocusOnCurrentFrame();</a>
<a name="ln4499">                }</a>
<a name="ln4500">            }</a>
<a name="ln4501">        }</a>
<a name="ln4502"> </a>
<a name="ln4503">        private void AdjustFrameNumbers(int startIndex)</a>
<a name="ln4504">        {</a>
<a name="ln4505">            for (var index = startIndex; index &lt; _viewModel.Frames.Count; index++)</a>
<a name="ln4506">            {</a>
<a name="ln4507">                Project.Frames[index].Index = index;</a>
<a name="ln4508">                _viewModel.Frames[index].Number = index;</a>
<a name="ln4509">            }</a>
<a name="ln4510">        }</a>
<a name="ln4511"> </a>
<a name="ln4512">        private void FocusOnSelectedFrames()</a>
<a name="ln4513">        {</a>
<a name="ln4514">            FrameListView.Focus();</a>
<a name="ln4515"> </a>
<a name="ln4516">            var item = FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().FirstOrDefault();</a>
<a name="ln4517"> </a>
<a name="ln4518">            if (item != null)</a>
<a name="ln4519">                FrameListView.ScrollIntoView(item);</a>
<a name="ln4520"> </a>
<a name="ln4521">            SetFocusOnCurrentFrame();</a>
<a name="ln4522">        }</a>
<a name="ln4523"> </a>
<a name="ln4524">        private async void ShowPanel(PanelTypes type, string title, string vector, Action&lt;object, RoutedEventArgs&gt; apply = null)</a>
<a name="ln4525">        {</a>
<a name="ln4526">            var focusFirstVisibleChild = true;</a>
<a name="ln4527"> </a>
<a name="ln4528">            HideAllVisibleGrids();</a>
<a name="ln4529"> </a>
<a name="ln4530">            #region Overlay</a>
<a name="ln4531"> </a>
<a name="ln4532">            ZoomBoxControl.SaveCurrentZoom();</a>
<a name="ln4533"> </a>
<a name="ln4534">            if (Project != null &amp;&amp; Project.Any &amp;&amp; type &lt; 0)</a>
<a name="ln4535">            {</a>
<a name="ln4536">                ZoomBoxControl.Zoom = 1.0;</a>
<a name="ln4537">                var size = ZoomBoxControl.GetElementSize();</a>
<a name="ln4538"> </a>
<a name="ln4539">                CaptionOverlayGrid.Width = size.Width;</a>
<a name="ln4540">                CaptionOverlayGrid.Height = size.Height;</a>
<a name="ln4541">            }</a>
<a name="ln4542"> </a>
<a name="ln4543">            #endregion</a>
<a name="ln4544"> </a>
<a name="ln4545">            #region Commons</a>
<a name="ln4546"> </a>
<a name="ln4547">            ActionTitleTextBlock.Text = title;</a>
<a name="ln4548">            ActionIconBorder.Background = FindResource(vector) as Brush;</a>
<a name="ln4549"> </a>
<a name="ln4550">            Util.Other.RemoveRoutedEventHandlers(ApplyButton, ButtonBase.ClickEvent);</a>
<a name="ln4551"> </a>
<a name="ln4552">            if (apply != null)</a>
<a name="ln4553">            {</a>
<a name="ln4554">                ApplyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Action.Apply&quot;);</a>
<a name="ln4555">                ApplyButton.Icon = FindResource(&quot;Vector.Ok&quot;) as Brush;</a>
<a name="ln4556">                _applyAction = apply;</a>
<a name="ln4557"> </a>
<a name="ln4558">                ActionLowerGrid.Visibility = Visibility.Visible;</a>
<a name="ln4559">            }</a>
<a name="ln4560">            else</a>
<a name="ln4561">            {</a>
<a name="ln4562">                ActionLowerGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln4563">            }</a>
<a name="ln4564"> </a>
<a name="ln4565">            #endregion</a>
<a name="ln4566"> </a>
<a name="ln4567">            #region Type</a>
<a name="ln4568"> </a>
<a name="ln4569">            switch (type)</a>
<a name="ln4570">            {</a>
<a name="ln4571">                case PanelTypes.NewAnimation:</a>
<a name="ln4572">                    NewGrid.Visibility = Visibility.Visible;</a>
<a name="ln4573">                    break;</a>
<a name="ln4574">                case PanelTypes.SaveAs:</a>
<a name="ln4575">                    ApplyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Action.Save&quot;);</a>
<a name="ln4576">                    ApplyButton.Icon = FindResource(&quot;Vector.Save&quot;) as Brush;</a>
<a name="ln4577"> </a>
<a name="ln4578">                    //WARNING: Temporary!!!</a>
<a name="ln4579">                    var grid = new ExportPanel();</a>
<a name="ln4580">                    grid.Save += (sender, args) =&gt;</a>
<a name="ln4581">                    {</a>
<a name="ln4582">                        SaveAs_Executed(null, null);</a>
<a name="ln4583">                    };</a>
<a name="ln4584">                    grid.Validated += (sender, args) =&gt;</a>
<a name="ln4585">                    {</a>
<a name="ln4586">                        StatusList.Warning(LocalizationHelper.Get(args.MessageKey), args.Reason, args.Action);</a>
<a name="ln4587">                    };</a>
<a name="ln4588">                    grid.ValidationRemoved += (sender, args) =&gt;</a>
<a name="ln4589">                    {</a>
<a name="ln4590">                        StatusList.Remove(StatusType.Warning, args.Reason);</a>
<a name="ln4591">                    };</a>
<a name="ln4592"> </a>
<a name="ln4593">                    var frameCountBinding = new Binding();</a>
<a name="ln4594">                    frameCountBinding.ElementName = &quot;FrameListView&quot;;</a>
<a name="ln4595">                    frameCountBinding.Path = new PropertyPath(&quot;Items.Count&quot;);</a>
<a name="ln4596">                    frameCountBinding.Mode = BindingMode.OneWay;</a>
<a name="ln4597">                    frameCountBinding.UpdateSourceTrigger = UpdateSourceTrigger.PropertyChanged;</a>
<a name="ln4598">                    BindingOperations.SetBinding(grid, ExportPanel.FrameCountProperty, frameCountBinding);</a>
<a name="ln4599"> </a>
<a name="ln4600">                    var durationBinding = new Binding();</a>
<a name="ln4601">                    durationBinding.ElementName = &quot;EditorWindow&quot;;</a>
<a name="ln4602">                    durationBinding.Path = new PropertyPath(&quot;TotalDuration&quot;);</a>
<a name="ln4603">                    durationBinding.Mode = BindingMode.OneWay;</a>
<a name="ln4604">                    durationBinding.UpdateSourceTrigger = UpdateSourceTrigger.PropertyChanged;</a>
<a name="ln4605">                    BindingOperations.SetBinding(grid, ExportPanel.TotalTimeProperty, durationBinding);</a>
<a name="ln4606"> </a>
<a name="ln4607">                    var selectionCountBinding = new Binding();</a>
<a name="ln4608">                    selectionCountBinding.ElementName = &quot;FrameListView&quot;;</a>
<a name="ln4609">                    selectionCountBinding.Path = new PropertyPath(&quot;SelectedItems.Count&quot;);</a>
<a name="ln4610">                    selectionCountBinding.Mode = BindingMode.OneWay;</a>
<a name="ln4611">                    selectionCountBinding.UpdateSourceTrigger = UpdateSourceTrigger.PropertyChanged;</a>
<a name="ln4612">                    BindingOperations.SetBinding(grid, ExportPanel.SelectionCountProperty, selectionCountBinding);</a>
<a name="ln4613"> </a>
<a name="ln4614">                    var currentFrameBinding = new Binding</a>
<a name="ln4615">                    {</a>
<a name="ln4616">                        //Path = new PropertyPath(&quot;Frames[CurrentIndex]&quot;), // I don't really get why data context is already a FrameViewModel here instead of the EditorViewModel but it means we need no Path</a>
<a name="ln4617">                        Mode = BindingMode.OneWay,</a>
<a name="ln4618">                        UpdateSourceTrigger = UpdateSourceTrigger.PropertyChanged,</a>
<a name="ln4619">                    };</a>
<a name="ln4620">                    BindingOperations.SetBinding(grid, ExportPanel.CurrentFrameProperty, currentFrameBinding);</a>
<a name="ln4621"> </a>
<a name="ln4622">                    CustomContentControl.Content = grid;</a>
<a name="ln4623">                    CustomContentControl.Visibility = Visibility.Visible;</a>
<a name="ln4624"> </a>
<a name="ln4625">                    focusFirstVisibleChild = false;</a>
<a name="ln4626">                    break;</a>
<a name="ln4627">                case PanelTypes.LoadRecent:</a>
<a name="ln4628">                    ApplyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Action.Open&quot;);</a>
<a name="ln4629">                    ApplyButton.Icon = FindResource(&quot;Vector.Open&quot;) as Brush;</a>
<a name="ln4630">                    LoadRecentGrid.Visibility = Visibility.Visible;</a>
<a name="ln4631"> </a>
<a name="ln4632">                    //Load list.</a>
<a name="ln4633">                    await Task.Run(LoadRecentAsync);</a>
<a name="ln4634"> </a>
<a name="ln4635">                    Cursor = Cursors.Arrow;</a>
<a name="ln4636">                    IsLoading = false;</a>
<a name="ln4637"> </a>
<a name="ln4638">                    HideProgress();</a>
<a name="ln4639">                    CommandManager.InvalidateRequerySuggested();</a>
<a name="ln4640"> </a>
<a name="ln4641">                    break;</a>
<a name="ln4642">                case PanelTypes.Clipboard:</a>
<a name="ln4643">                    ClipboardGrid.Visibility = Visibility.Visible;</a>
<a name="ln4644">                    break;</a>
<a name="ln4645">                case PanelTypes.Resize:</a>
<a name="ln4646">                {</a>
<a name="ln4647">                    var image = Project.Frames[0].Path.SourceFrom();</a>
<a name="ln4648"> </a>
<a name="ln4649">                    ResizePanel.DataContext = ResizeViewModel.FromSettings(image.PixelWidth, image.PixelHeight, image.DpiX);</a>
<a name="ln4650">                    ResizePanel.Visibility = Visibility.Visible;</a>
<a name="ln4651"> </a>
<a name="ln4652">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4653"> </a>
<a name="ln4654">                    break;</a>
<a name="ln4655">                }</a>
<a name="ln4656"> </a>
<a name="ln4657">                case PanelTypes.FlipRotate:</a>
<a name="ln4658">                    FlipRotateGrid.Visibility = Visibility.Visible;</a>
<a name="ln4659">                    ShowHint(&quot;S.Hint.FlipRotate2&quot;, true);</a>
<a name="ln4660">                    break;</a>
<a name="ln4661">                case PanelTypes.Crop:</a>
<a name="ln4662"> </a>
<a name="ln4663">                    #region Crop</a>
<a name="ln4664"> </a>
<a name="ln4665">                    CropGrid.Visibility = Visibility.Visible;</a>
<a name="ln4666"> </a>
<a name="ln4667">                    AddCropToElement(CropAreaGrid);</a>
<a name="ln4668"> </a>
<a name="ln4669">                    BottomCropNumericUpDown.Scale = TopCropNumericUpDown.Scale = RightCropNumericUpDown.Scale = LeftCropNumericUpDown.Scale = this.Scale();</a>
<a name="ln4670"> </a>
<a name="ln4671">                    BottomCropNumericUpDown.Value = (int)(CaptionOverlayGrid.Height - (CaptionOverlayGrid.Height * .1));</a>
<a name="ln4672">                    TopCropNumericUpDown.Value = (int)(CaptionOverlayGrid.Height * .1);</a>
<a name="ln4673"> </a>
<a name="ln4674">                    RightCropNumericUpDown.Value = (int)(CaptionOverlayGrid.Width - (CaptionOverlayGrid.Width * .1));</a>
<a name="ln4675">                    LeftCropNumericUpDown.Value = (int)(CaptionOverlayGrid.Width * .1);</a>
<a name="ln4676"> </a>
<a name="ln4677">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4678"> </a>
<a name="ln4679">                    #endregion</a>
<a name="ln4680"> </a>
<a name="ln4681">                    break;</a>
<a name="ln4682">                case PanelTypes.Caption:</a>
<a name="ln4683">                    CaptionGrid.Visibility = Visibility.Visible;</a>
<a name="ln4684">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4685">                    break;</a>
<a name="ln4686">                case PanelTypes.FreeText:</a>
<a name="ln4687">                    FreeTextGrid.Visibility = Visibility.Visible;</a>
<a name="ln4688">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4689">                    break;</a>
<a name="ln4690">                case PanelTypes.TitleFrame:</a>
<a name="ln4691">                    TitleFrameGrid.Visibility = Visibility.Visible;</a>
<a name="ln4692">                    ShowHint(&quot;S.Hint.TitleFrame2&quot;, true);</a>
<a name="ln4693">                    break;</a>
<a name="ln4694">                case PanelTypes.KeyStrokes:</a>
<a name="ln4695">                    KeyStrokesLabel.Text = &quot;Ctrl + C&quot;;</a>
<a name="ln4696">                    KeyStrokesGrid.Visibility = Visibility.Visible;</a>
<a name="ln4697">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4698">                    break;</a>
<a name="ln4699">                case PanelTypes.FreeDrawing:</a>
<a name="ln4700">                    FreeDrawingGrid.Visibility = Visibility.Visible;</a>
<a name="ln4701">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4702">                    break;</a>
<a name="ln4703">                case PanelTypes.Shapes:</a>
<a name="ln4704">                    ShapesGrid.Visibility = Visibility.Visible;</a>
<a name="ln4705">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4706"> </a>
<a name="ln4707">                    ShapeProperties_Changed(this, null);</a>
<a name="ln4708">                    ShapeType_SelectionChanged(ShapesListBox, null);</a>
<a name="ln4709">                    break;</a>
<a name="ln4710">                case PanelTypes.Watermark:</a>
<a name="ln4711"> </a>
<a name="ln4712">                    #region Watermark</a>
<a name="ln4713"> </a>
<a name="ln4714">                    //#region Arrange</a>
<a name="ln4715"> </a>
<a name="ln4716">                    //if (UserSettings.All.WatermarkLeft &lt; 0)</a>
<a name="ln4717">                    //    UserSettings.All.WatermarkLeft = 10;</a>
<a name="ln4718"> </a>
<a name="ln4719">                    //if (UserSettings.All.WatermarkLeft + 10 &gt; CaptionOverlayGrid.Width)</a>
<a name="ln4720">                    //    UserSettings.All.WatermarkLeft = 10;</a>
<a name="ln4721"> </a>
<a name="ln4722">                    //if (UserSettings.All.WatermarkTop &lt; 0)</a>
<a name="ln4723">                    //    UserSettings.All.WatermarkTop = 10;</a>
<a name="ln4724"> </a>
<a name="ln4725">                    //if (UserSettings.All.WatermarkTop + 10 &gt; CaptionOverlayGrid.Height)</a>
<a name="ln4726">                    //    UserSettings.All.WatermarkTop = 10;</a>
<a name="ln4727"> </a>
<a name="ln4728">                    //#endregion</a>
<a name="ln4729"> </a>
<a name="ln4730">                    WatermarkGrid.Visibility = Visibility.Visible;</a>
<a name="ln4731">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4732"> </a>
<a name="ln4733">                    #endregion</a>
<a name="ln4734"> </a>
<a name="ln4735">                    break;</a>
<a name="ln4736">                case PanelTypes.Border:</a>
<a name="ln4737">                    BorderProperties_ValueChanged(null, null);</a>
<a name="ln4738">                    BorderGrid.Visibility = Visibility.Visible;</a>
<a name="ln4739">                    ShowHint(&quot;S.Hint.ApplySelectedOrAll&quot;, true);</a>
<a name="ln4740">                    break;</a>
<a name="ln4741">                case PanelTypes.Obfuscate:</a>
<a name="ln4742">                    ObfuscateOverlaySelectControl.Scale = this.Scale();</a>
<a name="ln4743">                    ObfuscateOverlaySelectControl.Retry();</a>
<a name="ln4744">                    ObfuscateGrid.Visibility = Visibility.Visible;</a>
<a name="ln4745">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4746">                    break;</a>
<a name="ln4747">                case PanelTypes.Progress:</a>
<a name="ln4748">                    ProgressGrid.Visibility = Visibility.Visible;</a>
<a name="ln4749">                    ChangeProgressTextToCurrent();</a>
<a name="ln4750">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4751">                    break;</a>
<a name="ln4752">                case PanelTypes.Shadow:</a>
<a name="ln4753">                    ShadowProperties_ValueChanged(null, null);</a>
<a name="ln4754">                    ShadowGrid.Visibility = Visibility.Visible;</a>
<a name="ln4755">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4756">                    break;</a>
<a name="ln4757">                case PanelTypes.OverrideDelay:</a>
<a name="ln4758">                    OverrideDelayGrid.Visibility = Visibility.Visible;</a>
<a name="ln4759">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4760">                    break;</a>
<a name="ln4761">                case PanelTypes.IncreaseDecreaseDelay:</a>
<a name="ln4762">                    IncreaseDecreaseDelayGrid.Visibility = Visibility.Visible;</a>
<a name="ln4763">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4764">                    break;</a>
<a name="ln4765">                case PanelTypes.ScaleDelay:</a>
<a name="ln4766">                    ScaleDelayGrid.Visibility = Visibility.Visible;</a>
<a name="ln4767">                    ShowHint(&quot;S.Hint.ApplySelected&quot;, true);</a>
<a name="ln4768">                    break;</a>
<a name="ln4769">                case PanelTypes.Cinemagraph:</a>
<a name="ln4770">                    CinemagraphGrid.Visibility = Visibility.Visible;</a>
<a name="ln4771">                    ShowHint(&quot;S.Hint.Cinemagraph&quot;, true);</a>
<a name="ln4772">                    break;</a>
<a name="ln4773">                case PanelTypes.Fade:</a>
<a name="ln4774">                    FadeGrid.Visibility = Visibility.Visible;</a>
<a name="ln4775">                    ShowHint(&quot;S.Transitions.Info&quot;, true);</a>
<a name="ln4776">                    break;</a>
<a name="ln4777">                case PanelTypes.Slide:</a>
<a name="ln4778">                    SlideGrid.Visibility = Visibility.Visible;</a>
<a name="ln4779">                    ShowHint(&quot;S.Transitions.Info&quot;, true);</a>
<a name="ln4780">                    break;</a>
<a name="ln4781">                case PanelTypes.ReduceFrames:</a>
<a name="ln4782">                    ReduceGrid.Visibility = Visibility.Visible;</a>
<a name="ln4783">                    ShowHint(&quot;S.Hint.ApplySelectedOrAll&quot;, true);</a>
<a name="ln4784">                    break;</a>
<a name="ln4785">                case PanelTypes.RemoveDuplicates:</a>
<a name="ln4786">                    RemoveDuplicatesGrid.Visibility = Visibility.Visible;</a>
<a name="ln4787">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4788">                    break;</a>
<a name="ln4789">                case PanelTypes.MouseEvents:</a>
<a name="ln4790">                    MouseEventsGrid.Visibility = Visibility.Visible;</a>
<a name="ln4791">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4792">                    break;</a>
<a name="ln4793">                case PanelTypes.SmoothLoop:</a>
<a name="ln4794">                    SmoothLoopGrid.Visibility = Visibility.Visible;</a>
<a name="ln4795">                    ShowHint(&quot;S.Hint.ApplyAll&quot;, true);</a>
<a name="ln4796">                    break;</a>
<a name="ln4797">            }</a>
<a name="ln4798"> </a>
<a name="ln4799">            #endregion</a>
<a name="ln4800"> </a>
<a name="ln4801">            #region Focus</a>
<a name="ln4802"> </a>
<a name="ln4803">            if (focusFirstVisibleChild)</a>
<a name="ln4804">            {</a>
<a name="ln4805">                var visible = ActionInternalGrid.Children.OfType&lt;Grid&gt;().FirstOrDefault(x =&gt; x.Visibility == Visibility.Visible);</a>
<a name="ln4806"> </a>
<a name="ln4807">                if (visible != null)</a>
<a name="ln4808">                {</a>
<a name="ln4809">                    visible.Focus();</a>
<a name="ln4810">                    visible.MoveFocus(new TraversalRequest(FocusNavigationDirection.Next));</a>
<a name="ln4811">                }</a>
<a name="ln4812">            }</a>
<a name="ln4813"> </a>
<a name="ln4814">            #endregion</a>
<a name="ln4815"> </a>
<a name="ln4816">            #region Animate</a>
<a name="ln4817"> </a>
<a name="ln4818">            if (type is PanelTypes.SaveAs or PanelTypes.LoadRecent &amp;&amp; ActionGrid.Width &lt; 300)</a>
<a name="ln4819">                ActionGrid.BeginStoryboard(this.FindStoryboard(&quot;ShowExtendedPanelStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4820">            else if (type != PanelTypes.SaveAs &amp;&amp; type != PanelTypes.LoadRecent &amp;&amp; ActionGrid.Width is &lt; 5 or &gt; 280)</a>
<a name="ln4821">                ActionGrid.BeginStoryboard(this.FindStoryboard(&quot;ShowPanelStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4822"> </a>
<a name="ln4823">            #endregion</a>
<a name="ln4824"> </a>
<a name="ln4825">            #region Overlay Grid</a>
<a name="ln4826"> </a>
<a name="ln4827">            if (OverlayGrid.Opacity &lt; 1 &amp;&amp; type &lt; 0)</a>
<a name="ln4828">                OverlayGrid.BeginStoryboard(this.FindStoryboard(&quot;ShowOverlayGridStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4829">            else if (OverlayGrid.Opacity &gt; 0 &amp;&amp; type &gt; 0)</a>
<a name="ln4830">                OverlayGrid.BeginStoryboard(this.FindStoryboard(&quot;HideOverlayGridStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4831"> </a>
<a name="ln4832">            #endregion</a>
<a name="ln4833"> </a>
<a name="ln4834">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln4835">        }</a>
<a name="ln4836"> </a>
<a name="ln4837">        private void HideAllVisibleGrids()</a>
<a name="ln4838">        {</a>
<a name="ln4839">            foreach (var child in ActionInternalGrid.Children.OfType&lt;FrameworkElement&gt;().Where(x =&gt; x.Visibility == Visibility.Visible))</a>
<a name="ln4840">            {</a>
<a name="ln4841">                child.Visibility = Visibility.Collapsed;</a>
<a name="ln4842"> </a>
<a name="ln4843">                //Persist the latest settings if the panel has any to be saved.</a>
<a name="ln4844">                if (child.DataContext is IPersistent per)</a>
<a name="ln4845">                    per.Persist();</a>
<a name="ln4846">            }</a>
<a name="ln4847"> </a>
<a name="ln4848">            CustomContentControl.Content = null;</a>
<a name="ln4849"> </a>
<a name="ln4850">            ShapeDrawingCanvas.DeselectAll();</a>
<a name="ln4851">        }</a>
<a name="ln4852"> </a>
<a name="ln4853">        private void ClosePanel(bool isCancel = false, bool removeEvent = false)</a>
<a name="ln4854">        {</a>
<a name="ln4855">            StatusList.Remove(StatusType.Warning);</a>
<a name="ln4856"> </a>
<a name="ln4857">            if (ActionGrid.ActualWidth &gt; 0)</a>
<a name="ln4858">                ZoomBoxControl.RestoreSavedZoom();</a>
<a name="ln4859"> </a>
<a name="ln4860">            HideHint();</a>
<a name="ln4861"> </a>
<a name="ln4862">            if (isCancel)</a>
<a name="ln4863">                SetFocusOnCurrentFrame();</a>
<a name="ln4864"> </a>
<a name="ln4865">            if (removeEvent)</a>
<a name="ln4866">                _applyAction = null;</a>
<a name="ln4867"> </a>
<a name="ln4868">            BeginStoryboard(this.FindStoryboard(&quot;HidePanelStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4869">            BeginStoryboard(this.FindStoryboard(&quot;HideOverlayGridStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln4870"> </a>
<a name="ln4871">            HideAllVisibleGrids();</a>
<a name="ln4872">        }</a>
<a name="ln4873"> </a>
<a name="ln4874">        private List&lt;int&gt; SelectedFramesIndex()</a>
<a name="ln4875">        {</a>
<a name="ln4876">            return FrameListView.SelectedItems.OfType&lt;FrameViewModel&gt;().Select(x =&gt; _viewModel.Frames.IndexOf(x)).OrderBy(y =&gt; y).ToList();</a>
<a name="ln4877">        }</a>
<a name="ln4878"> </a>
<a name="ln4879">        private bool UpdatePositioning(bool onLoad = true)</a>
<a name="ln4880">        {</a>
<a name="ln4881">            //TODO: When the DPI changes, these values are still from the latest dpi.</a>
<a name="ln4882">            var top = onLoad ? UserSettings.All.EditorTop : Top;</a>
<a name="ln4883">            var left = onLoad ? UserSettings.All.EditorLeft : Left;</a>
<a name="ln4884">            var width = onLoad ? UserSettings.All.EditorWidth : Width;</a>
<a name="ln4885">            var height = onLoad ? UserSettings.All.EditorHeight : Height;</a>
<a name="ln4886">            var state = onLoad ? UserSettings.All.EditorWindowState : WindowState;</a>
<a name="ln4887"> </a>
<a name="ln4888">            //If the position was never set, let it center on screen.</a>
<a name="ln4889">            if (double.IsNaN(top) &amp;&amp; double.IsNaN(left))</a>
<a name="ln4890">                return false;</a>
<a name="ln4891"> </a>
<a name="ln4892">            //The catch here is to get the closest monitor from current Top/Left point.</a>
<a name="ln4893">            var monitors = MonitorHelper.AllMonitorsScaled(this.Scale());</a>
<a name="ln4894">            var closest = monitors.FirstOrDefault(x =&gt; x.Bounds.Contains(new Point((int)left, (int)top))) ?? monitors.FirstOrDefault(x =&gt; x.IsPrimary);</a>
<a name="ln4895"> </a>
<a name="ln4896">            if (closest == null)</a>
<a name="ln4897">                return false;</a>
<a name="ln4898"> </a>
<a name="ln4899">            //To much to the Left.</a>
<a name="ln4900">            if (closest.WorkingArea.Left &gt; left + width - 100)</a>
<a name="ln4901">                left = closest.WorkingArea.Left;</a>
<a name="ln4902"> </a>
<a name="ln4903">            //Too much to the top.</a>
<a name="ln4904">            if (closest.WorkingArea.Top &gt; top + height - 100)</a>
<a name="ln4905">                top = closest.WorkingArea.Top;</a>
<a name="ln4906"> </a>
<a name="ln4907">            //Too much to the right.</a>
<a name="ln4908">            if (closest.WorkingArea.Right &lt; left + 100)</a>
<a name="ln4909">                left = closest.WorkingArea.Right - width;</a>
<a name="ln4910"> </a>
<a name="ln4911">            //Too much to the bottom.</a>
<a name="ln4912">            if (closest.WorkingArea.Bottom &lt; top + 100)</a>
<a name="ln4913">                top = closest.WorkingArea.Bottom - height;</a>
<a name="ln4914"> </a>
<a name="ln4915">            if (top &gt; int.MaxValue || top &lt; int.MinValue || left &gt; int.MaxValue || left &lt; int.MinValue || width &gt; int.MaxValue || width &lt; 0 || height &gt; int.MaxValue || height &lt; 0)</a>
<a name="ln4916">            {</a>
<a name="ln4917">                var desc = $&quot;On load: {onLoad}\nScale: {this.Scale()}\n\n&quot; +</a>
<a name="ln4918">                           $&quot;Screen: {closest.AdapterName}\nBounds: {closest.Bounds}\n\nTopLeft: {top}x{left}\nWidthHeight: {width}x{height}\n\n&quot; +</a>
<a name="ln4919">                           $&quot;TopLeft Settings: {UserSettings.All.EditorTop}x{UserSettings.All.EditorLeft}\nWidthHeight Settings: {UserSettings.All.EditorWidth}x{UserSettings.All.EditorHeight}&quot;;</a>
<a name="ln4920">                LogWriter.Log(&quot;Wrong Editor window sizing&quot;, desc);</a>
<a name="ln4921">                return false;</a>
<a name="ln4922">            }</a>
<a name="ln4923"> </a>
<a name="ln4924">            //To eliminate the flicker of moving the window to the correct screen, hide and then show it again.</a>
<a name="ln4925">            if (onLoad)</a>
<a name="ln4926">                Opacity = 0;</a>
<a name="ln4927"> </a>
<a name="ln4928">            //First move the window to the final monitor, so that the UI scale can be adjusted.</a>
<a name="ln4929">            this.MoveToScreen(closest);</a>
<a name="ln4930"> </a>
<a name="ln4931">            Top = top;</a>
<a name="ln4932">            Left = left;</a>
<a name="ln4933">            Width = width;</a>
<a name="ln4934">            Height = height;</a>
<a name="ln4935">            WindowState = state;</a>
<a name="ln4936"> </a>
<a name="ln4937">            if (onLoad)</a>
<a name="ln4938">                Opacity = 1;</a>
<a name="ln4939"> </a>
<a name="ln4940">            return true;</a>
<a name="ln4941">        }</a>
<a name="ln4942"> </a>
<a name="ln4943">        #endregion</a>
<a name="ln4944"> </a>
<a name="ln4945">        #region Other</a>
<a name="ln4946"> </a>
<a name="ln4947">        public void NotificationUpdated()</a>
<a name="ln4948">        {</a>
<a name="ln4949">            RibbonTabControl.UpdateNotifications();</a>
<a name="ln4950">        }</a>
<a name="ln4951"> </a>
<a name="ln4952">        public EncoderListViewItem EncodingAdded(int id)</a>
<a name="ln4953">        {</a>
<a name="ln4954">            return RibbonTabControl.AddEncoding(id, IsActive);</a>
<a name="ln4955">        }</a>
<a name="ln4956"> </a>
<a name="ln4957">        public void EncodingUpdated(int? id = null, bool onlyStatus = false)</a>
<a name="ln4958">        {</a>
<a name="ln4959">            RibbonTabControl.UpdateEncoding(id, onlyStatus);</a>
<a name="ln4960">        }</a>
<a name="ln4961"> </a>
<a name="ln4962">        public EncoderListViewItem EncodingRemoved(int id)</a>
<a name="ln4963">        {</a>
<a name="ln4964">            return RibbonTabControl.RemoveEncoding(id);</a>
<a name="ln4965">        }</a>
<a name="ln4966"> </a>
<a name="ln4967"> </a>
<a name="ln4968">        /// &lt;summary&gt;</a>
<a name="ln4969">        /// If there's an update available, it will adjust the UI to warn the user about it.</a>
<a name="ln4970">        /// It does not control the notification list, that's separated.</a>
<a name="ln4971">        /// &lt;/summary&gt;</a>
<a name="ln4972">        private void DisplayUpdatePromoter()</a>
<a name="ln4973">        {</a>
<a name="ln4974">            if (Global.UpdateAvailable == null)</a>
<a name="ln4975">            {</a>
<a name="ln4976">                UpdateStackPanel.Visibility = Visibility.Collapsed;</a>
<a name="ln4977">                return;</a>
<a name="ln4978">            }</a>
<a name="ln4979"> </a>
<a name="ln4980">            UpdateVersionRun.Text = $&quot;{Global.UpdateAvailable.Version}&quot;;</a>
<a name="ln4981">            UpdateSizeRun.Text = Global.UpdateAvailable.InstallerSize &gt; 0 ? Humanizer.BytesToString(Global.UpdateAvailable.InstallerSize) : &quot;&quot;;</a>
<a name="ln4982">            UpdateStackPanel.Visibility = Visibility.Visible;</a>
<a name="ln4983">        }</a>
<a name="ln4984"> </a>
<a name="ln4985">        private async void Discard(bool notify = true)</a>
<a name="ln4986">        {</a>
<a name="ln4987">            Pause();</a>
<a name="ln4988"> </a>
<a name="ln4989">            if (notify &amp;&amp; !Dialog.Ask(LocalizationHelper.Get(&quot;S.Editor.DiscardProject.Title&quot;), LocalizationHelper.Get(&quot;S.Editor.DiscardProject.Instruction&quot;), LocalizationHelper.Get(&quot;S.Editor.DiscardProject.Message&quot;), false))</a>
<a name="ln4990">                return;</a>
<a name="ln4991"> </a>
<a name="ln4992">            #region Prepare UI</a>
<a name="ln4993"> </a>
<a name="ln4994">            ClosePanel();</a>
<a name="ln4995"> </a>
<a name="ln4996">            FrameListView.SelectedIndex = -1;</a>
<a name="ln4997">            FrameListView.SelectionChanged -= FrameListView_SelectionChanged;</a>
<a name="ln4998"> </a>
<a name="ln4999">            _viewModel.Frames.Clear();</a>
<a name="ln5000">            ClipboardListBox.Items.Clear();</a>
<a name="ln5001">            Util.Clipboard.Items.Clear();</a>
<a name="ln5002">            ZoomBoxControl.Clear();</a>
<a name="ln5003"> </a>
<a name="ln5004">            #endregion</a>
<a name="ln5005"> </a>
<a name="ln5006">            if (Project == null || !Project.Any)</a>
<a name="ln5007">                return;</a>
<a name="ln5008"> </a>
<a name="ln5009">            await Task.Run(() =&gt; Discard(Project));</a>
<a name="ln5010"> </a>
<a name="ln5011">            WelcomeGrid.BeginStoryboard(this.FindStoryboard(&quot;ShowWelcomeBorderStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln5012"> </a>
<a name="ln5013">            FilledList = false;</a>
<a name="ln5014">            IsLoading = false;</a>
<a name="ln5015"> </a>
<a name="ln5016">            WelcomeTextBlock.Text = LocalizationHelper.Get(Humanizer.WelcomeInfo());</a>
<a name="ln5017">            SymbolTextBlock.Text = Humanizer.Welcome();</a>
<a name="ln5018"> </a>
<a name="ln5019">            UpdateStatistics();</a>
<a name="ln5020"> </a>
<a name="ln5021">            FrameListView.SelectionChanged += FrameListView_SelectionChanged;</a>
<a name="ln5022"> </a>
<a name="ln5023">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln5024">        }</a>
<a name="ln5025"> </a>
<a name="ln5026">        private void DeleteFrame(int index)</a>
<a name="ln5027">        {</a>
<a name="ln5028">            //Delete the File from the disk.</a>
<a name="ln5029">            File.Delete(Project.Frames[index].Path);</a>
<a name="ln5030"> </a>
<a name="ln5031">            //Remove from the list.</a>
<a name="ln5032">            Project.Frames.RemoveAt(index);</a>
<a name="ln5033">            _viewModel.Frames.RemoveAt(index);</a>
<a name="ln5034">        }</a>
<a name="ln5035"> </a>
<a name="ln5036">        private List&lt;FrameInfo&gt; SelectedFrames()</a>
<a name="ln5037">        {</a>
<a name="ln5038">            var selectedIndexList = Dispatcher.Invoke(SelectedFramesIndex);</a>
<a name="ln5039">            return Project.Frames.Where(x =&gt; selectedIndexList.Contains(Project.Frames.IndexOf(x))).ToList();</a>
<a name="ln5040">        }</a>
<a name="ln5041"> </a>
<a name="ln5042">        private void UpdateStatistics()</a>
<a name="ln5043">        {</a>
<a name="ln5044">            TotalDuration = TimeSpan.FromMilliseconds(Project.Frames.Sum(x =&gt; x.Delay));</a>
<a name="ln5045">            FrameSize = Project.Frames.Count &gt; 0 ? Project.Frames[0].Path.ScaledSize() : new Size(0, 0);</a>
<a name="ln5046">            FrameScale = Project.Frames.Count &gt; 0 ? Convert.ToInt32(Project.Frames[0].Path.DpiOf() / 96d * 100d) : 0;</a>
<a name="ln5047">            AverageDelay = Project.Frames.Count &gt; 0 ? Project.Frames.Average(x =&gt; x.Delay) : 0;</a>
<a name="ln5048">            FrameDpi = Project.Frames.Count &gt; 0 ? Math.Round(Project.Frames[0].Path.DpiOf(), 0) : 0d;</a>
<a name="ln5049">        }</a>
<a name="ln5050"> </a>
<a name="ln5051">        private void UpdateOtherStatistics()</a>
<a name="ln5052">        {</a>
<a name="ln5053">            if (FrameListView.SelectedIndex &gt; -1 &amp;&amp; FrameListView.SelectedIndex &lt; Project.Frames.Count)</a>
<a name="ln5054">                CurrentTime = TimeSpan.FromMilliseconds(Project.Frames.Take(FrameListView.SelectedIndex + 1).Sum(x =&gt; x.Delay));</a>
<a name="ln5055">            else</a>
<a name="ln5056">                CurrentTime = TimeSpan.Zero;</a>
<a name="ln5057">        }</a>
<a name="ln5058"> </a>
<a name="ln5059">        private void ShowHint(string hint, bool isPermanent = false, params object[] values)</a>
<a name="ln5060">        {</a>
<a name="ln5061">            if (HintTextBlock.Visibility == Visibility.Visible)</a>
<a name="ln5062">                BeginStoryboard(this.FindStoryboard(&quot;HideHintStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln5063"> </a>
<a name="ln5064">            HintTextBlock.Text = values.Length == 0 ? LocalizationHelper.Get(hint) : LocalizationHelper.GetWithFormat(hint, values);</a>
<a name="ln5065"> </a>
<a name="ln5066">            BeginStoryboard(this.FindStoryboard(isPermanent ? &quot;ShowPermanentHintStoryboard&quot; : &quot;ShowHintStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln5067">        }</a>
<a name="ln5068"> </a>
<a name="ln5069">        private void HideHint()</a>
<a name="ln5070">        {</a>
<a name="ln5071">            if (HintTextBlock.Visibility == Visibility.Visible)</a>
<a name="ln5072">                BeginStoryboard(this.FindStoryboard(&quot;HideHintStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln5073">        }</a>
<a name="ln5074"> </a>
<a name="ln5075">        private void SetFocusOnCurrentFrame()</a>
<a name="ln5076">        {</a>
<a name="ln5077">            FrameListView.Focus();</a>
<a name="ln5078"> </a>
<a name="ln5079">            if (FrameListView.SelectedItem is not FrameViewModel current)</a>
<a name="ln5080">                return;</a>
<a name="ln5081"> </a>
<a name="ln5082">            if (FrameListView.ItemContainerGenerator.ContainerFromItem(current) is ListViewItem container)</a>
<a name="ln5083">            {</a>
<a name="ln5084">                Keyboard.Focus(container);</a>
<a name="ln5085">                container.Focus();</a>
<a name="ln5086">            }</a>
<a name="ln5087">        }</a>
<a name="ln5088"> </a>
<a name="ln5089">        private string GetProgressText(int precision, bool showTotal, string format, string dateFormat, int startNumber, long cumulative, long total, int current)</a>
<a name="ln5090">        {</a>
<a name="ln5091">            try</a>
<a name="ln5092">            {</a>
<a name="ln5093">                switch (precision)</a>
<a name="ln5094">                {</a>
<a name="ln5095">                    case 0: //Minutes</a>
<a name="ln5096">                        return showTotal ? TimeSpan.FromMilliseconds(cumulative).ToString(@&quot;m\:ss&quot;) + &quot;/&quot; + TimeSpan.FromMilliseconds(total).ToString(@&quot;m\:ss&quot;) : TimeSpan.FromMilliseconds(cumulative).ToString(@&quot;m\:ss&quot;);</a>
<a name="ln5097">                    case 1: //Seconds</a>
<a name="ln5098">                        return showTotal ? (int)TimeSpan.FromMilliseconds(cumulative).TotalSeconds + &quot;/&quot; + TimeSpan.FromMilliseconds(total).TotalSeconds + &quot; s&quot; : (int)TimeSpan.FromMilliseconds(cumulative).TotalSeconds + &quot; s&quot;;</a>
<a name="ln5099">                    case 2: //Milliseconds</a>
<a name="ln5100">                        return showTotal ? cumulative + &quot;/&quot; + total + &quot; ms&quot; : cumulative + &quot; ms&quot;;</a>
<a name="ln5101">                    case 3: //Percentage</a>
<a name="ln5102">                        var count = (double)Project.Frames.Count;</a>
<a name="ln5103">                        return (current / count * 100).ToString(&quot;##0.#&quot;, CultureInfo.CurrentUICulture) + (showTotal ? &quot;/100%&quot; : &quot; %&quot;);</a>
<a name="ln5104">                    case 4: //Frame number</a>
<a name="ln5105">                        return showTotal ? (startNumber + current - 1) + &quot;/&quot; + (startNumber + Project.Frames.Count - 1) : current.ToString();</a>
<a name="ln5106">                    case 5: //Custom</a>
<a name="ln5107">                        return format</a>
<a name="ln5108">                            .Replace(&quot;$ms&quot;, cumulative.ToString())</a>
<a name="ln5109">                            .Replace(&quot;$s&quot;, ((int)TimeSpan.FromMilliseconds(cumulative).TotalSeconds).ToString())</a>
<a name="ln5110">                            .Replace(&quot;$m&quot;, TimeSpan.FromMilliseconds(cumulative).ToString())</a>
<a name="ln5111">                            .Replace(&quot;$p&quot;, (current / (double)Project.Frames.Count * 100).ToString(&quot;##0.#&quot;, CultureInfo.CurrentUICulture))</a>
<a name="ln5112">                            .Replace(&quot;$f&quot;, (startNumber + current - 1).ToString())</a>
<a name="ln5113">                            .Replace(&quot;@ms&quot;, total.ToString())</a>
<a name="ln5114">                            .Replace(&quot;@s&quot;, ((int)TimeSpan.FromMilliseconds(total).TotalSeconds).ToString())</a>
<a name="ln5115">                            .Replace(&quot;@m&quot;, TimeSpan.FromMilliseconds(total).ToString(@&quot;m\:ss&quot;))</a>
<a name="ln5116">                            .Replace(&quot;@p&quot;, &quot;100&quot;)</a>
<a name="ln5117">                            .Replace(&quot;@f&quot;, (startNumber + Project.Frames.Count - 1).ToString());</a>
<a name="ln5118">                    case 6: //Actual date/time</a>
<a name="ln5119">                        return showTotal ? $&quot;{Project.CreationDate.AddMilliseconds(cumulative).ToString(dateFormat)} -&gt; {Project.CreationDate.AddMilliseconds(total).ToString(dateFormat)}&quot;</a>
<a name="ln5120">                            : Project.CreationDate.AddMilliseconds(cumulative).ToString(dateFormat);</a>
<a name="ln5121">                    default:</a>
<a name="ln5122">                        return &quot;???&quot;;</a>
<a name="ln5123">                }</a>
<a name="ln5124">            }</a>
<a name="ln5125">            catch (Exception e)</a>
<a name="ln5126">            {</a>
<a name="ln5127">                LogWriter.Log(e, &quot;Invalid progress format.&quot;);</a>
<a name="ln5128">                return &quot;???&quot;;</a>
<a name="ln5129">            }</a>
<a name="ln5130">        }</a>
<a name="ln5131"> </a>
<a name="ln5132">        private void ChangeProgressTextToCurrent()</a>
<a name="ln5133">        {</a>
<a name="ln5134">            var total = Project.Frames.Sum(y =&gt; y.Delay);</a>
<a name="ln5135">            var cumulative = 0L;</a>
<a name="ln5136"> </a>
<a name="ln5137">            for (var j = 0; j &lt; FrameListView.SelectedIndex; j++)</a>
<a name="ln5138">                cumulative += Project.Frames[j].Delay;</a>
<a name="ln5139"> </a>
<a name="ln5140">            ProgressHorizontalTextBlock.Text = GetProgressText(UserSettings.All.ProgressPrecision, UserSettings.All.ProgressShowTotal, UserSettings.All.ProgressFormat, UserSettings.All.ProgressDateFormat,</a>
<a name="ln5141">                UserSettings.All.ProgressStartNumber, cumulative, total, FrameListView.SelectedIndex + 1);</a>
<a name="ln5142">        }</a>
<a name="ln5143"> </a>
<a name="ln5144">        #endregion</a>
<a name="ln5145"> </a>
<a name="ln5146">        #endregion</a>
<a name="ln5147"> </a>
<a name="ln5148"> </a>
<a name="ln5149">        #region Async</a>
<a name="ln5150"> </a>
<a name="ln5151">        private void LoadRecentAsync()</a>
<a name="ln5152">        {</a>
<a name="ln5153">            ShowProgress(LocalizationHelper.Get(&quot;S.Recent.Searching&quot;), 100, true);</a>
<a name="ln5154"> </a>
<a name="ln5155">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln5156"> </a>
<a name="ln5157">            #region Enumerate recent projects</a>
<a name="ln5158"> </a>
<a name="ln5159">            var list = new List&lt;ProjectInfo&gt;();</a>
<a name="ln5160"> </a>
<a name="ln5161">            try</a>
<a name="ln5162">            {</a>
<a name="ln5163">                Dispatcher.Invoke(() =&gt; RecentDataGrid.ItemsSource = null);</a>
<a name="ln5164"> </a>
<a name="ln5165">                var path = Path.Combine(UserSettings.All.TemporaryFolderResolved, &quot;ScreenToGif&quot;, &quot;Recording&quot;);</a>
<a name="ln5166"> </a>
<a name="ln5167">                if (!Directory.Exists(path))</a>
<a name="ln5168">                {</a>
<a name="ln5169">                    Dispatcher.Invoke(DispatcherPriority.Background, new Action(() =&gt; RecentDataGrid.ItemsSource = null));</a>
<a name="ln5170">                    return;</a>
<a name="ln5171">                }</a>
<a name="ln5172"> </a>
<a name="ln5173">                var folderList = Directory.GetDirectories(path).Select(x =&gt; new DirectoryInfo(x)).ToList();</a>
<a name="ln5174"> </a>
<a name="ln5175">                foreach (var folder in folderList)</a>
<a name="ln5176">                {</a>
<a name="ln5177">                    var file = Path.Combine(folder.FullName, &quot;Project.json&quot;);</a>
<a name="ln5178"> </a>
<a name="ln5179">                    if (!File.Exists(file))</a>
<a name="ln5180">                        continue;</a>
<a name="ln5181"> </a>
<a name="ln5182">                    var json = File.ReadAllText(file);</a>
<a name="ln5183"> </a>
<a name="ln5184">                    using (var ms = new MemoryStream(Encoding.UTF8.GetBytes(json)))</a>
<a name="ln5185">                    {</a>
<a name="ln5186">                        var ser = new DataContractJsonSerializer(typeof(ProjectInfo));</a>
<a name="ln5187"> </a>
<a name="ln5188">                        //Ignore empty projects.</a>
<a name="ln5189">                        if (ser.ReadObject(ms) is not ProjectInfo project || project.Frames.Count == 0 || !project.Frames.Any(x =&gt; File.Exists(x.Path)))</a>
<a name="ln5190">                            continue;</a>
<a name="ln5191"> </a>
<a name="ln5192">                        list.Add(project);</a>
<a name="ln5193">                    }</a>
<a name="ln5194">                }</a>
<a name="ln5195"> </a>
<a name="ln5196">                //Waits the animation to complete before filling the grid.</a>
<a name="ln5197">                Dispatcher.Invoke(DispatcherPriority.Background, new Action(() =&gt;</a>
<a name="ln5198">                {</a>
<a name="ln5199">                    RecentDataGrid.ItemsSource = list;</a>
<a name="ln5200"> </a>
<a name="ln5201">                    if (RecentDataGrid.Items.Count &gt; 0)</a>
<a name="ln5202">                    {</a>
<a name="ln5203">                        RecentDataGrid.Sort(ListSortDirection.Descending, &quot;CreationDate&quot;);</a>
<a name="ln5204">                        RecentDataGrid.FocusOnFirstCell();</a>
<a name="ln5205">                    }</a>
<a name="ln5206">                }));</a>
<a name="ln5207">            }</a>
<a name="ln5208">            catch (Exception ex)</a>
<a name="ln5209">            {</a>
<a name="ln5210">                LogWriter.Log(ex, &quot;Loading list of recent&quot;);</a>
<a name="ln5211"> </a>
<a name="ln5212">                Dispatcher.Invoke(() =&gt; ErrorDialog.Ok(&quot;ScreenToGif&quot;, &quot;Error while enumerating recent projects&quot;, ex.Message, ex));</a>
<a name="ln5213">            }</a>
<a name="ln5214"> </a>
<a name="ln5215">            #endregion</a>
<a name="ln5216">        }</a>
<a name="ln5217"> </a>
<a name="ln5218">        private bool SaveAsync(ExportPreset preset)</a>
<a name="ln5219">        {</a>
<a name="ln5220">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.PreparingSaving&quot;), 1, true);</a>
<a name="ln5221"> </a>
<a name="ln5222">            #region Filter out frames</a>
<a name="ln5223"> </a>
<a name="ln5224">            var indexes = new List&lt;int&gt;();</a>
<a name="ln5225"> </a>
<a name="ln5226">            if (preset.ExportPartially)</a>
<a name="ln5227">            {</a>
<a name="ln5228">                switch (preset.PartialExport)</a>
<a name="ln5229">                {</a>
<a name="ln5230">                    case PartialExportModes.FrameExpression:</a>
<a name="ln5231">                    {</a>
<a name="ln5232">                        var blocks = preset.PartialExportFrameExpression.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln5233"> </a>
<a name="ln5234">                        foreach (var block in blocks)</a>
<a name="ln5235">                        {</a>
<a name="ln5236">                            //Frame range.</a>
<a name="ln5237">                            if (block.Contains(&quot;-&quot;))</a>
<a name="ln5238">                            {</a>
<a name="ln5239">                                var subs = block.Split(new[] { '-' }, StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln5240"> </a>
<a name="ln5241">                                if (!int.TryParse(subs[0], out var start) || !int.TryParse(subs[1], out var end))</a>
<a name="ln5242">                                    continue;</a>
<a name="ln5243"> </a>
<a name="ln5244">                                if (start == end)</a>
<a name="ln5245">                                {</a>
<a name="ln5246">                                    //Single frame.</a>
<a name="ln5247">                                    indexes.Add(start); //indexes.Add(frames[start]);</a>
<a name="ln5248">                                }</a>
<a name="ln5249">                                else if (start &lt; end)</a>
<a name="ln5250">                                {</a>
<a name="ln5251">                                    //Normal range.</a>
<a name="ln5252">                                    for (var i = start; i &lt;= end; i++)</a>
<a name="ln5253">                                        indexes.Add(i); //indexes.Add(frames[i]);</a>
<a name="ln5254">                                }</a>
<a name="ln5255">                                else</a>
<a name="ln5256">                                {</a>
<a name="ln5257">                                    //Reversed range.</a>
<a name="ln5258">                                    //The CopyToExport() method below has no support for this yet, so it just copies the frames in order anyway.</a>
<a name="ln5259">                                    for (var i = start; i &gt;= end; i--)</a>
<a name="ln5260">                                        indexes.Add(i); //indexes.Add(frames[i]);</a>
<a name="ln5261">                                }</a>
<a name="ln5262">                            }</a>
<a name="ln5263">                            else</a>
<a name="ln5264">                            {</a>
<a name="ln5265">                                if (int.TryParse(block, out var number))</a>
<a name="ln5266">                                    indexes.Add(number);</a>
<a name="ln5267">                            }</a>
<a name="ln5268">                        }</a>
<a name="ln5269"> </a>
<a name="ln5270">                        break;</a>
<a name="ln5271">                    }</a>
<a name="ln5272"> </a>
<a name="ln5273">                    case PartialExportModes.FrameRange:</a>
<a name="ln5274">                    {</a>
<a name="ln5275">                        indexes = Enumerable.Range(preset.PartialExportFrameStart, preset.PartialExportFrameEnd - preset.PartialExportFrameStart).ToList();</a>
<a name="ln5276">                        break;</a>
<a name="ln5277">                    }</a>
<a name="ln5278"> </a>
<a name="ln5279">                    case PartialExportModes.TimeRange:</a>
<a name="ln5280">                    {</a>
<a name="ln5281">                        var span = TimeSpan.Zero;</a>
<a name="ln5282"> </a>
<a name="ln5283">                        //Playback mode.</a>
<a name="ln5284">                        if (preset.PartialExportTimeStart &lt; preset.PartialExportTimeEnd)</a>
<a name="ln5285">                        {</a>
<a name="ln5286">                            //Normal playback.</a>
<a name="ln5287">                            for (var i = 0; i &lt; Project.Frames.Count; i++)</a>
<a name="ln5288">                            {</a>
<a name="ln5289">                                if (span &gt;= preset.PartialExportTimeStart &amp;&amp; span &lt;= preset.PartialExportTimeEnd)</a>
<a name="ln5290">                                    indexes.Add(i);</a>
<a name="ln5291"> </a>
<a name="ln5292">                                if (span &gt; preset.PartialExportTimeEnd)</a>
<a name="ln5293">                                    break;</a>
<a name="ln5294"> </a>
<a name="ln5295">                                span = span.Add(TimeSpan.FromMilliseconds(Project.Frames[i].Delay));</a>
<a name="ln5296">                            }</a>
<a name="ln5297">                        }</a>
<a name="ln5298">                        else</a>
<a name="ln5299">                        {</a>
<a name="ln5300">                            //Reversed playback.</a>
<a name="ln5301">                            //The CopyToExport() method below has no support for this yet, so it just copies the frames in order anyway.</a>
<a name="ln5302">                            span = TimeSpan.FromMilliseconds(Project.Frames.Sum(s =&gt; s.Delay));</a>
<a name="ln5303"> </a>
<a name="ln5304">                            for (var i = Project.Frames.Count - 1; i &gt;= 0; i--)</a>
<a name="ln5305">                            {</a>
<a name="ln5306">                                if (span &gt;= preset.PartialExportTimeEnd &amp;&amp; span &lt;= preset.PartialExportTimeStart)</a>
<a name="ln5307">                                    indexes.Add(i);</a>
<a name="ln5308"> </a>
<a name="ln5309">                                if (span &gt; preset.PartialExportTimeStart)</a>
<a name="ln5310">                                    break;</a>
<a name="ln5311"> </a>
<a name="ln5312">                                span = span.Subtract(TimeSpan.FromMilliseconds(Project.Frames[i].Delay));</a>
<a name="ln5313">                            }</a>
<a name="ln5314">                        }</a>
<a name="ln5315"> </a>
<a name="ln5316">                        break;</a>
<a name="ln5317">                    }</a>
<a name="ln5318"> </a>
<a name="ln5319">                    case PartialExportModes.Selection:</a>
<a name="ln5320">                    {</a>
<a name="ln5321">                        indexes = Dispatcher.Invoke(SelectedFramesIndex);</a>
<a name="ln5322">                        break;</a>
<a name="ln5323">                    }</a>
<a name="ln5324">                }</a>
<a name="ln5325">            }</a>
<a name="ln5326"> </a>
<a name="ln5327">            #endregion</a>
<a name="ln5328"> </a>
<a name="ln5329">            #region Last minute validation</a>
<a name="ln5330"> </a>
<a name="ln5331">            //Validates each file name when saving multiple images (if more than one image, that will not be zipped).</a>
<a name="ln5332">            if (preset is ImagePreset { ZipFiles: false })</a>
<a name="ln5333">            {</a>
<a name="ln5334">                if (preset.OverwriteMode != OverwriteModes.Allow)</a>
<a name="ln5335">                {</a>
<a name="ln5336">                    var output = Path.Combine(preset.OutputFolder, preset.ResolvedFilename);</a>
<a name="ln5337">                    var padSize = (Project.Frames.Count - 1).ToString().Length;</a>
<a name="ln5338"> </a>
<a name="ln5339">                    //With or without exporting it partially.</a>
<a name="ln5340">                    var any = preset.ExportPartially ? indexes.Any(a =&gt; File.Exists($&quot;{output} {(a + &quot;&quot;).PadLeft(padSize, '0')}&quot; + preset.Extension)) :</a>
<a name="ln5341">                        Project.Frames.Any(a =&gt; File.Exists($&quot;{output} {(a.Index + &quot;&quot;).PadLeft(padSize, '0')}&quot; + preset.Extension));</a>
<a name="ln5342"> </a>
<a name="ln5343">                    if (any)</a>
<a name="ln5344">                    {</a>
<a name="ln5345">                        if (preset.OverwriteMode == OverwriteModes.Prompt)</a>
<a name="ln5346">                        {</a>
<a name="ln5347">                            if (Dispatcher.Invoke(() =&gt; !Dialog.Ask(LocalizationHelper.Get(&quot;S.SaveAs.Dialogs.Overwrite.Title&quot;), LocalizationHelper.Get(&quot;S.SaveAs.Dialogs.OverwriteMultiple.Instruction&quot;),</a>
<a name="ln5348">                                LocalizationHelper.Get(&quot;S.SaveAs.Dialogs.OverwriteMultiple.Message&quot;))))</a>
<a name="ln5349">                            {</a>
<a name="ln5350">                                Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.SaveAs.Warning.Overwrite&quot;)));</a>
<a name="ln5351">                                return false;</a>
<a name="ln5352">                            }</a>
<a name="ln5353">                        }</a>
<a name="ln5354">                        else</a>
<a name="ln5355">                        {</a>
<a name="ln5356">                            Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.SaveAs.Warning.Overwrite&quot;)));</a>
<a name="ln5357">                            return false;</a>
<a name="ln5358">                        }</a>
<a name="ln5359">                    }</a>
<a name="ln5360">                }</a>
<a name="ln5361"> </a>
<a name="ln5362">                if (indexes.Count &gt; 1 &amp;&amp; !Dispatcher.Invoke(() =&gt; Dialog.Ask(LocalizationHelper.Get(&quot;S.SaveAs.Dialogs.Multiple.Title&quot;),</a>
<a name="ln5363">                    LocalizationHelper.Get(&quot;S.SaveAs.Dialogs.Multiple.Instruction&quot;), LocalizationHelper.GetWithFormat(&quot;S.SaveAs.Dialogs.Multiple.Message&quot;, indexes.Count))))</a>
<a name="ln5364">                {</a>
<a name="ln5365">                    Dispatcher.Invoke(() =&gt; StatusList.Warning(LocalizationHelper.Get(&quot;S.SaveAs.Warning.Canceled&quot;)));</a>
<a name="ln5366">                    return false;</a>
<a name="ln5367">                }</a>
<a name="ln5368">            }</a>
<a name="ln5369"> </a>
<a name="ln5370">            #endregion</a>
<a name="ln5371"> </a>
<a name="ln5372">            //Copy the frames, so it can be manipulated without problem.</a>
<a name="ln5373">            var copied = Project.CopyToExport(indexes, preset.Type == ExportFormats.Stg, preset.Type == ExportFormats.Gif &amp;&amp; preset.Encoder == EncoderTypes.ScreenToGif);</a>
<a name="ln5374"> </a>
<a name="ln5375">            EncodingManager.StartEncoding(copied, preset);</a>
<a name="ln5376"> </a>
<a name="ln5377">            if (preset.ExportAsProjectToo)</a>
<a name="ln5378">            {</a>
<a name="ln5379">                var copiedAux = Project.CopyToExport(indexes, true);</a>
<a name="ln5380"> </a>
<a name="ln5381">                //Get default project encoder settings.</a>
<a name="ln5382">                var projectPreset = (UserSettings.All.ExportPresets.OfType&lt;StgPreset&gt;().FirstOrDefault(f =&gt; f.IsSelectedForEncoder) ?? UserSettings.All.ExportPresets.OfType&lt;StgPreset&gt;().FirstOrDefault() ?? StgPreset.Default).ShallowCopy();</a>
<a name="ln5383">                projectPreset.OutputFolder = preset.OutputFolder;</a>
<a name="ln5384">                projectPreset.OutputFilename = preset.OutputFilename;</a>
<a name="ln5385">                projectPreset.ResolvedFilename = preset.ResolvedFilename;</a>
<a name="ln5386">                projectPreset.ExportPartially = false;</a>
<a name="ln5387">                projectPreset.PickLocation = true;</a>
<a name="ln5388">                projectPreset.UploadFile = false;</a>
<a name="ln5389">                projectPreset.SaveToClipboard = false;</a>
<a name="ln5390">                projectPreset.ExecuteCustomCommands = false;</a>
<a name="ln5391"> </a>
<a name="ln5392">                EncodingManager.StartEncoding(copiedAux, projectPreset);</a>
<a name="ln5393">            }</a>
<a name="ln5394"> </a>
<a name="ln5395">            return true;</a>
<a name="ln5396">        }</a>
<a name="ln5397"> </a>
<a name="ln5398">        private void Discard(ProjectInfo project)</a>
<a name="ln5399">        {</a>
<a name="ln5400">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.DiscardingFrames&quot;), project.Frames.Count);</a>
<a name="ln5401"> </a>
<a name="ln5402">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln5403"> </a>
<a name="ln5404">            try</a>
<a name="ln5405">            {</a>
<a name="ln5406">                var count = 0;</a>
<a name="ln5407">                foreach (var frame in project.Frames)</a>
<a name="ln5408">                {</a>
<a name="ln5409">                    File.Delete(frame.Path);</a>
<a name="ln5410"> </a>
<a name="ln5411">                    UpdateProgress(count++);</a>
<a name="ln5412">                }</a>
<a name="ln5413"> </a>
<a name="ln5414">                var folderList = Directory.EnumerateDirectories(project.FullPath).ToList();</a>
<a name="ln5415"> </a>
<a name="ln5416">                ShowProgress(LocalizationHelper.Get(&quot;S.Editor.DiscardingFolders&quot;), folderList.Count);</a>
<a name="ln5417"> </a>
<a name="ln5418">                count = 0;</a>
<a name="ln5419">                foreach (var folder in folderList)</a>
<a name="ln5420">                {</a>
<a name="ln5421">                    if (!folder.Contains(&quot;Encode &quot;))</a>
<a name="ln5422">                        Directory.Delete(folder, true);</a>
<a name="ln5423"> </a>
<a name="ln5424">                    UpdateProgress(count++);</a>
<a name="ln5425">                }</a>
<a name="ln5426"> </a>
<a name="ln5427">                //Deletes the JSON file.</a>
<a name="ln5428">                if (File.Exists(project.ProjectPath))</a>
<a name="ln5429">                    File.Delete(project.ProjectPath);</a>
<a name="ln5430">            }</a>
<a name="ln5431">            catch (IOException io)</a>
<a name="ln5432">            {</a>
<a name="ln5433">                LogWriter.Log(io, &quot;Error while trying to Discard the Project&quot;);</a>
<a name="ln5434">            }</a>
<a name="ln5435">            catch (Exception ex)</a>
<a name="ln5436">            {</a>
<a name="ln5437">                Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Discard Error&quot;, &quot;Error while trying to discard the project&quot;, ex.Message));</a>
<a name="ln5438">                LogWriter.Log(ex, &quot;Error while trying to Discard the Project&quot;);</a>
<a name="ln5439">            }</a>
<a name="ln5440"> </a>
<a name="ln5441">            ActionStack.Clear();</a>
<a name="ln5442">            project.Clear();</a>
<a name="ln5443"> </a>
<a name="ln5444">            HideProgress();</a>
<a name="ln5445">        }</a>
<a name="ln5446"> </a>
<a name="ln5447">        private void Resize(int width, int height, double dpi, BitmapScalingMode scalingQuality)</a>
<a name="ln5448">        {</a>
<a name="ln5449">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ResizingFrames&quot;), Project.Frames.Count);</a>
<a name="ln5450"> </a>
<a name="ln5451">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln5452"> </a>
<a name="ln5453">            var count = 0;</a>
<a name="ln5454">            foreach (var frame in Project.Frames)</a>
<a name="ln5455">            {</a>
<a name="ln5456">                var png = new PngBitmapEncoder();</a>
<a name="ln5457">                png.Frames.Add(ImageMethods.ResizeImage((BitmapImage)frame.Path.SourceFrom(), width, height, 0, dpi, scalingQuality));</a>
<a name="ln5458"> </a>
<a name="ln5459">                using (Stream stm = File.OpenWrite(frame.Path))</a>
<a name="ln5460">                    png.Save(stm);</a>
<a name="ln5461"> </a>
<a name="ln5462">                UpdateProgress(count++);</a>
<a name="ln5463">            }</a>
<a name="ln5464">        }</a>
<a name="ln5465"> </a>
<a name="ln5466">        private void Crop(Int32Rect rect)</a>
<a name="ln5467">        {</a>
<a name="ln5468">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.CroppingFrames&quot;), Project.Frames.Count);</a>
<a name="ln5469"> </a>
<a name="ln5470">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln5471"> </a>
<a name="ln5472">            var count = 0;</a>
<a name="ln5473">            foreach (var frame in Project.Frames)</a>
<a name="ln5474">            {</a>
<a name="ln5475">                var png = new PngBitmapEncoder();</a>
<a name="ln5476">                png.Frames.Add(BitmapFrame.Create(frame.Path.CropFrom(rect)));</a>
<a name="ln5477"> </a>
<a name="ln5478">                using (Stream stm = File.OpenWrite(frame.Path))</a>
<a name="ln5479">                    png.Save(stm);</a>
<a name="ln5480"> </a>
<a name="ln5481">                UpdateProgress(count++);</a>
<a name="ln5482">            }</a>
<a name="ln5483">        }</a>
<a name="ln5484"> </a>
<a name="ln5485">        private void ProgressAsync(ProgressViewModel model)</a>
<a name="ln5486">        {</a>
<a name="ln5487">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln5488">            {</a>
<a name="ln5489">                IsLoading = true;</a>
<a name="ln5490">            });</a>
<a name="ln5491"> </a>
<a name="ln5492">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), Project.Frames.Count);</a>
<a name="ln5493"> </a>
<a name="ln5494">            var total = Project.Frames.Sum(y =&gt; y.Delay);</a>
<a name="ln5495">            var thickness = model.Thickness * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5496">            var fontSize = model.FontSize * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5497"> </a>
<a name="ln5498">            var count = 1;</a>
<a name="ln5499">            var cumulative = 0L;</a>
<a name="ln5500"> </a>
<a name="ln5501">            foreach (var frame in Project.Frames)</a>
<a name="ln5502">            {</a>
<a name="ln5503">                if (_abortLoading)</a>
<a name="ln5504">                    return;</a>
<a name="ln5505"> </a>
<a name="ln5506">                var image = frame.Path.SourceFrom();</a>
<a name="ln5507"> </a>
<a name="ln5508">                var drawingVisual = new DrawingVisual();</a>
<a name="ln5509">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln5510">                {</a>
<a name="ln5511">                    drawingContext.DrawImage(image, new Rect(0, 0, image.Width, image.Height));</a>
<a name="ln5512"> </a>
<a name="ln5513">                    //TODO: Test with high dpi.</a>
<a name="ln5514">                    if (model.Type == ProgressTypes.Bar)</a>
<a name="ln5515">                    {</a>
<a name="ln5516">                        #region Bar</a>
<a name="ln5517"> </a>
<a name="ln5518">                        if (model.Orientation == Orientation.Horizontal)</a>
<a name="ln5519">                        {</a>
<a name="ln5520">                            //Width changes (Current/Total * Available size), Height is thickness.</a>
<a name="ln5521">                            var width = count / (double)Project.Frames.Count * image.Width; //* image.Width instead?</a>
<a name="ln5522">                            var left = model.HorizontalAlignment == HorizontalAlignment.Left ? 0 :</a>
<a name="ln5523">                                model.HorizontalAlignment == HorizontalAlignment.Right ? image.Width - width :</a>
<a name="ln5524">                                (image.Width - width) / 2d;</a>
<a name="ln5525">                            var top = model.VerticalAlignment == VerticalAlignment.Top ? 0 :</a>
<a name="ln5526">                                model.VerticalAlignment == VerticalAlignment.Bottom ? image.Height - thickness :</a>
<a name="ln5527">                                (image.Height - thickness) / 2d;</a>
<a name="ln5528"> </a>
<a name="ln5529">                            drawingContext.DrawRectangle(new SolidColorBrush(model.Color), null, new Rect(Math.Round(left, 0), Math.Round(top, 0), Math.Round(width, 0), thickness));</a>
<a name="ln5530">                        }</a>
<a name="ln5531">                        else</a>
<a name="ln5532">                        {</a>
<a name="ln5533">                            //Height changes (Current/Total * Available size), Width is thickness.</a>
<a name="ln5534">                            var height = count / (double)Project.Frames.Count * image.Height;</a>
<a name="ln5535">                            var left = model.HorizontalAlignment == HorizontalAlignment.Left ? 0 :</a>
<a name="ln5536">                                model.HorizontalAlignment == HorizontalAlignment.Right ? image.Width - thickness :</a>
<a name="ln5537">                                (image.Width - thickness) / 2d;</a>
<a name="ln5538">                            var top = model.VerticalAlignment == VerticalAlignment.Top ? 0 :</a>
<a name="ln5539">                                model.VerticalAlignment == VerticalAlignment.Bottom ? image.Height - height :</a>
<a name="ln5540">                                (image.Height - height) / 2d;</a>
<a name="ln5541"> </a>
<a name="ln5542">                            drawingContext.DrawRectangle(new SolidColorBrush(model.Color), null, new Rect(Math.Round(left, 0), Math.Round(top, 0), thickness, Math.Round(height, 0)));</a>
<a name="ln5543">                        }</a>
<a name="ln5544"> </a>
<a name="ln5545">                        #endregion</a>
<a name="ln5546">                    }</a>
<a name="ln5547">                    else</a>
<a name="ln5548">                    {</a>
<a name="ln5549">                        #region Text</a>
<a name="ln5550"> </a>
<a name="ln5551">                        if (count &gt; 0)</a>
<a name="ln5552">                            cumulative += Project.Frames[count - 1].Delay;</a>
<a name="ln5553"> </a>
<a name="ln5554">                        //Calculate size.</a>
<a name="ln5555">                        var text = GetProgressText(model.Precision, model.ShowTotal, model.Format, model.DateFormat, model.StartNumber, cumulative, total, count); //FrameListView.SelectedIndex</a>
<a name="ln5556">                        var formatted = new FormattedText(text, CultureInfo.CurrentUICulture, FlowDirection.LeftToRight,</a>
<a name="ln5557">                            new Typeface(model.FontFamily, model.FontStyle, model.FontWeight, default), fontSize, new SolidColorBrush(model.FontColor),</a>
<a name="ln5558">                            null, TextFormattingMode.Ideal);</a>
<a name="ln5559"> </a>
<a name="ln5560">                        var width = formatted.Width + 4; //2px padding for both sides.</a>
<a name="ln5561">                        var height = formatted.Height;</a>
<a name="ln5562">                        var left = model.HorizontalAlignment == HorizontalAlignment.Left ? 0 :</a>
<a name="ln5563">                            model.HorizontalAlignment == HorizontalAlignment.Right ? image.Width - width :</a>
<a name="ln5564">                            (image.Width - width) / 2d;</a>
<a name="ln5565">                        var top = model.VerticalAlignment == VerticalAlignment.Top ? 0 :</a>
<a name="ln5566">                            model.VerticalAlignment == VerticalAlignment.Bottom ? image.Height - height :</a>
<a name="ln5567">                            (image.Height - height) / 2d;</a>
<a name="ln5568"> </a>
<a name="ln5569">                        //Draw background rectangle and the text.</a>
<a name="ln5570">                        drawingContext.DrawRectangle(new SolidColorBrush(model.Color), null, new Rect(Math.Round(left, 0), Math.Round(top, 0), Math.Round(width, 0), Math.Round(height, 0)));</a>
<a name="ln5571">                        drawingContext.DrawText(formatted, new Point(Math.Round(left + 2, 0), Math.Round(top, 0)));</a>
<a name="ln5572"> </a>
<a name="ln5573">                        #endregion</a>
<a name="ln5574">                    }</a>
<a name="ln5575">                }</a>
<a name="ln5576"> </a>
<a name="ln5577">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln5578">                var bmp = new RenderTargetBitmap(image.PixelWidth, image.PixelHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln5579">                bmp.Render(drawingVisual);</a>
<a name="ln5580"> </a>
<a name="ln5581">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln5582">                var encoder = new PngBitmapEncoder();</a>
<a name="ln5583">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln5584"> </a>
<a name="ln5585">                //Saves the image into a file using the encoder.</a>
<a name="ln5586">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln5587">                    encoder.Save(stream);</a>
<a name="ln5588"> </a>
<a name="ln5589">                UpdateProgress((count++) - 1);</a>
<a name="ln5590">            }</a>
<a name="ln5591">        }</a>
<a name="ln5592"> </a>
<a name="ln5593">        private List&lt;int&gt; OverlayAsync(RenderTargetBitmap render, bool forAll = false)</a>
<a name="ln5594">        {</a>
<a name="ln5595">            var frameList = forAll ? Project.Frames : SelectedFrames();</a>
<a name="ln5596">            var selectedList = Dispatcher.Invoke(() =&gt;</a>
<a name="ln5597">            {</a>
<a name="ln5598">                IsLoading = true;</a>
<a name="ln5599"> </a>
<a name="ln5600">                return forAll ? Project.Frames.Select(x =&gt; Project.Frames.IndexOf(x)).ToList() : SelectedFramesIndex();</a>
<a name="ln5601">            });</a>
<a name="ln5602"> </a>
<a name="ln5603">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), frameList.Count);</a>
<a name="ln5604"> </a>
<a name="ln5605">            var count = 0;</a>
<a name="ln5606">            foreach (var frame in frameList)</a>
<a name="ln5607">            {</a>
<a name="ln5608">                var image = frame.Path.SourceFrom();</a>
<a name="ln5609"> </a>
<a name="ln5610">                var drawingVisual = new DrawingVisual();</a>
<a name="ln5611">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln5612">                {</a>
<a name="ln5613">                    drawingContext.DrawImage(image, new Rect(0, 0, image.Width, image.Height));</a>
<a name="ln5614">                    drawingContext.DrawImage(render, new Rect(0, 0, render.Width, render.Height));</a>
<a name="ln5615">                }</a>
<a name="ln5616"> </a>
<a name="ln5617">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln5618">                var bmp = new RenderTargetBitmap(image.PixelWidth, image.PixelHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln5619">                bmp.Render(drawingVisual);</a>
<a name="ln5620"> </a>
<a name="ln5621">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln5622">                var encoder = new PngBitmapEncoder();</a>
<a name="ln5623">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln5624"> </a>
<a name="ln5625">                //Saves the image into a file using the encoder.</a>
<a name="ln5626">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln5627">                    encoder.Save(stream);</a>
<a name="ln5628"> </a>
<a name="ln5629">                UpdateProgress(count++);</a>
<a name="ln5630">            }</a>
<a name="ln5631"> </a>
<a name="ln5632">            return selectedList;</a>
<a name="ln5633">        }</a>
<a name="ln5634"> </a>
<a name="ln5635">        private int TitleFrame(RenderTargetBitmap render, int selected, double dpi)</a>
<a name="ln5636">        {</a>
<a name="ln5637">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.CreatingTitleFrame&quot;), 1, true);</a>
<a name="ln5638"> </a>
<a name="ln5639">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln5640"> </a>
<a name="ln5641">            #region Save Image</a>
<a name="ln5642"> </a>
<a name="ln5643">            var name = Path.GetFileNameWithoutExtension(Project.Frames[selected].Path);</a>
<a name="ln5644">            var folder = Path.GetDirectoryName(Project.Frames[selected].Path);</a>
<a name="ln5645">            var fileName = Path.Combine(folder, $&quot;{name} TF {DateTime.Now:hh-mm-ss}.png&quot;);</a>
<a name="ln5646"> </a>
<a name="ln5647">            var encoder = new PngBitmapEncoder();</a>
<a name="ln5648">            encoder.Frames.Add(BitmapFrame.Create(render));</a>
<a name="ln5649"> </a>
<a name="ln5650">            //Saves the image into a file using the encoder.</a>
<a name="ln5651">            using (Stream stream = File.Create(fileName))</a>
<a name="ln5652">                encoder.Save(stream);</a>
<a name="ln5653"> </a>
<a name="ln5654">            GC.Collect();</a>
<a name="ln5655"> </a>
<a name="ln5656">            #endregion</a>
<a name="ln5657"> </a>
<a name="ln5658">            //Adds to the List</a>
<a name="ln5659">            Project.Frames.Insert(selected, new FrameInfo(fileName, UserSettings.All.TitleFrameDelay));</a>
<a name="ln5660"> </a>
<a name="ln5661">            return selected;</a>
<a name="ln5662">        }</a>
<a name="ln5663"> </a>
<a name="ln5664">        private void KeyStrokesAsync(KeyStrokesViewModel model)</a>
<a name="ln5665">        {</a>
<a name="ln5666">            Dispatcher?.Invoke(() =&gt;</a>
<a name="ln5667">            {</a>
<a name="ln5668">                IsLoading = true;</a>
<a name="ln5669">            });</a>
<a name="ln5670"> </a>
<a name="ln5671">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), Project.Frames.Count);</a>
<a name="ln5672"> </a>
<a name="ln5673">            var auxList = Project.Frames.CopyList();</a>
<a name="ln5674"> </a>
<a name="ln5675">            #region Make the keystrokes start earlier</a>
<a name="ln5676"> </a>
<a name="ln5677">            if (model.KeyStrokesEarlier)</a>
<a name="ln5678">            {</a>
<a name="ln5679">                //Checks if there is a key stroke that needs to be shown earlier, into the previous frames.</a>
<a name="ln5680">                for (var outer = 0; outer &lt; auxList.Count; outer++)</a>
<a name="ln5681">                {</a>
<a name="ln5682">                    //For each frame, check if any other key pressed later wants to be shown on this frame.</a>
<a name="ln5683"> </a>
<a name="ln5684">                    var amount = 0;</a>
<a name="ln5685"> </a>
<a name="ln5686">                    //If it's the last item of the list.</a>
<a name="ln5687">                    //if (outer == auxList.Count - 1 &amp;&amp; amount &lt;= model.KeyStrokesEarlierBy)</a>
<a name="ln5688">                    //    auxList[outer].KeyList.InsertRange(auxList[outer].KeyList.Count, auxList[0].KeyList);</a>
<a name="ln5689"> </a>
<a name="ln5690">                    //Check next items.</a>
<a name="ln5691">                    for (var inner = outer + 1; inner &lt; auxList.Count - 1; inner++)</a>
<a name="ln5692">                    {</a>
<a name="ln5693">                        //For each frame, check if a next frame needs to show their key strokes.</a>
<a name="ln5694">                        amount += auxList[inner].Delay;</a>
<a name="ln5695"> </a>
<a name="ln5696">                        //If next item bleeds into this frame, insert on the list.</a>
<a name="ln5697">                        if (inner &lt; auxList.Count - 1 &amp;&amp; auxList[inner + 1].Delay &lt;= model.KeyStrokesEarlierBy)</a>
<a name="ln5698">                            auxList[outer].KeyList.InsertRange(auxList[outer].KeyList.Count, auxList[inner].KeyList);</a>
<a name="ln5699"> </a>
<a name="ln5700">                        //Stops veryfying the previous frames if the delay sum is greater than the maximum.</a>
<a name="ln5701">                        if (amount &gt;= model.KeyStrokesEarlierBy)</a>
<a name="ln5702">                            break;</a>
<a name="ln5703">                    }</a>
<a name="ln5704">                }</a>
<a name="ln5705">            }</a>
<a name="ln5706"> </a>
<a name="ln5707">            #endregion</a>
<a name="ln5708"> </a>
<a name="ln5709">            #region Expand the keystrokes</a>
<a name="ln5710"> </a>
<a name="ln5711">            if (model.KeyStrokesExtended)</a>
<a name="ln5712">            {</a>
<a name="ln5713">                //Checks from the end to the start, if there is a key stroke that needs to 'bleed'/'delayed' into the next frames.</a>
<a name="ln5714">                //I need to check from the end to the start so the keystrokes stays in position.</a>
<a name="ln5715">                for (var outer = auxList.Count - 1; outer &gt; 0; outer--)</a>
<a name="ln5716">                {</a>
<a name="ln5717">                    var amount = 0;</a>
<a name="ln5718"> </a>
<a name="ln5719">                    if (outer == 1 &amp;&amp; amount &lt;= model.KeyStrokesDelay)</a>
<a name="ln5720">                    {</a>
<a name="ln5721">                        var listA = auxList[0].KeyList.TakeWhile((_, i) =&gt; !auxList[0].KeyList.Skip(i).SequenceEqual(auxList[1].KeyList.Take(auxList[0].KeyList.Count - i))).Concat(auxList[1].KeyList);</a>
<a name="ln5722"> </a>
<a name="ln5723">                        auxList[1].KeyList = new List&lt;IKeyGesture&gt;(listA);</a>
<a name="ln5724">                    }</a>
<a name="ln5725"> </a>
<a name="ln5726">                    //Check previous items.</a>
<a name="ln5727">                    for (var inner = outer - 1; inner &gt;= 0; inner--)</a>
<a name="ln5728">                    {</a>
<a name="ln5729">                        //For each frame, check if a previous frame needs to show their key strokes.</a>
<a name="ln5730">                        amount += auxList[inner].Delay;</a>
<a name="ln5731"> </a>
<a name="ln5732">                        //If previous item bleeds into this frame, insert on the list.</a>
<a name="ln5733">                        if (inner &gt; 0 &amp;&amp; auxList[inner - 1].Delay &lt;= model.KeyStrokesDelay)</a>
<a name="ln5734">                        {</a>
<a name="ln5735">                            var listA = auxList[inner].KeyList.TakeWhile((_, i) =&gt; !auxList[inner].KeyList.Skip(i).SequenceEqual(auxList[outer].KeyList.Take(auxList[inner].KeyList.Count - i))).Concat(auxList[outer].KeyList);</a>
<a name="ln5736"> </a>
<a name="ln5737">                            auxList[outer].KeyList = new List&lt;IKeyGesture&gt;(listA);</a>
<a name="ln5738">                        }</a>
<a name="ln5739"> </a>
<a name="ln5740">                        //Stops veryfying the previous frames if the delay sum is greater than the maximum.</a>
<a name="ln5741">                        if (amount &gt;= model.KeyStrokesDelay)</a>
<a name="ln5742">                            break;</a>
<a name="ln5743">                    }</a>
<a name="ln5744">                }</a>
<a name="ln5745">            }</a>
<a name="ln5746"> </a>
<a name="ln5747">            #endregion</a>
<a name="ln5748"> </a>
<a name="ln5749">            //Pen used for drawing the outline of the text shape.</a>
<a name="ln5750">            var pen = new Pen(new SolidColorBrush(model.KeyStrokesOutlineColor), model.KeyStrokesOutlineThickness)</a>
<a name="ln5751">            {</a>
<a name="ln5752">                DashCap = PenLineCap.Round,</a>
<a name="ln5753">                EndLineCap = PenLineCap.Round,</a>
<a name="ln5754">                LineJoin = PenLineJoin.Round,</a>
<a name="ln5755">                StartLineCap = PenLineCap.Round</a>
<a name="ln5756">            };</a>
<a name="ln5757"> </a>
<a name="ln5758">            var count = 0;</a>
<a name="ln5759">            foreach (var frame in auxList)</a>
<a name="ln5760">            {</a>
<a name="ln5761">                if (_abortLoading)</a>
<a name="ln5762">                    return;</a>
<a name="ln5763"> </a>
<a name="ln5764">                if (!frame.KeyList.Any())</a>
<a name="ln5765">                {</a>
<a name="ln5766">                    UpdateProgress(count++);</a>
<a name="ln5767">                    continue;</a>
<a name="ln5768">                }</a>
<a name="ln5769"> </a>
<a name="ln5770">                #region Removes any duplicated modifier key</a>
<a name="ln5771"> </a>
<a name="ln5772">                var keyList = new List&lt;IKeyGesture&gt;();</a>
<a name="ln5773">                for (var i = 0; i &lt; frame.KeyList.Count; i++)</a>
<a name="ln5774">                {</a>
<a name="ln5775">                    if (model.KeyStrokesIgnoreInjected &amp;&amp; frame.KeyList[i].IsInjected)</a>
<a name="ln5776">                        continue;</a>
<a name="ln5777"> </a>
<a name="ln5778">                    //Ignore Control, Shift, Alt and Windows keys if not acting as modifiers.</a>
<a name="ln5779">                    if (model.KeyStrokesIgnoreNonModifiers &amp;&amp; frame.KeyList[i].Key is &gt;= Key.LeftShift and &lt;= Key.RightAlt or Key.LWin or Key.RWin)</a>
<a name="ln5780">                        continue;</a>
<a name="ln5781"> </a>
<a name="ln5782">                    //If there's another key ahead on the same frame.</a>
<a name="ln5783">                    if (frame.KeyList.Count &gt; i + 1)</a>
<a name="ln5784">                    {</a>
<a name="ln5785">                        //If this frame being added will be repeated next, ignore.</a>
<a name="ln5786">                        if (frame.KeyList[i + 1].Key == frame.KeyList[i].Key &amp;&amp; frame.KeyList[i + 1].Modifiers == frame.KeyList[i].Modifiers)</a>
<a name="ln5787">                            continue;</a>
<a name="ln5788"> </a>
<a name="ln5789">                        //TODO: If there's a key between the current key and the one that is repeated, they are going to be shown.</a>
<a name="ln5790"> </a>
<a name="ln5791">                        //If this frame being added will be repeated within the next key presses as a modifier, ignore.</a>
<a name="ln5792">                        if (frame.KeyList[i].Key is Key.LeftCtrl or Key.RightCtrl &amp;&amp; (frame.KeyList[i + 1].Modifiers &amp; ModifierKeys.Control) != 0)</a>
<a name="ln5793">                            continue;</a>
<a name="ln5794"> </a>
<a name="ln5795">                        if (frame.KeyList[i].Key is Key.LeftShift or Key.RightShift &amp;&amp; (frame.KeyList[i + 1].Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln5796">                            continue;</a>
<a name="ln5797"> </a>
<a name="ln5798">                        if (frame.KeyList[i].Key is Key.LeftAlt or Key.RightAlt &amp;&amp; (frame.KeyList[i + 1].Modifiers &amp; ModifierKeys.Alt) != 0)</a>
<a name="ln5799">                            continue;</a>
<a name="ln5800"> </a>
<a name="ln5801">                        if (frame.KeyList[i].Key is Key.LWin or Key.RWin &amp;&amp; (frame.KeyList[i + 1].Modifiers &amp; ModifierKeys.Windows) != 0)</a>
<a name="ln5802">                            continue;</a>
<a name="ln5803">                    }</a>
<a name="ln5804"> </a>
<a name="ln5805">                    //Removes the previous modifier key, if a combination is next to it: &quot;LeftCtrl Control + A&quot; will be &quot;Control + A&quot;. (This checks if the next modifier is not present as a current key).</a>
<a name="ln5806">                    if (i + 1 &gt; frame.KeyList.Count - 1 || !(frame.KeyList[i].Key != Key.Left &amp;&amp; frame.KeyList[i].Key != Key.Right &amp;&amp; frame.KeyList[i + 1].Modifiers.ToString().Contains(frame.KeyList[i].Key.ToString().Remove(&quot;Left&quot;, &quot;Right&quot;).Replace(&quot;Ctrl&quot;, &quot;Control&quot;).TrimStart('L').TrimStart('R'))))</a>
<a name="ln5807">                        keyList.Add(frame.KeyList[i]);</a>
<a name="ln5808">                }</a>
<a name="ln5809"> </a>
<a name="ln5810">                if (keyList.Count == 0)</a>
<a name="ln5811">                {</a>
<a name="ln5812">                    UpdateProgress(count++);</a>
<a name="ln5813">                    continue;</a>
<a name="ln5814">                }</a>
<a name="ln5815"> </a>
<a name="ln5816">                #endregion</a>
<a name="ln5817"> </a>
<a name="ln5818">                #region Prepare the text</a>
<a name="ln5819"> </a>
<a name="ln5820">                var text = keyList.Select(x =&gt; &quot;&quot; + Native.Helpers.Other.GetSelectKeyText(x.Key, x.Modifiers, x.IsUppercase)).Aggregate((p, n) =&gt; p + model.KeyStrokesSeparator + n);</a>
<a name="ln5821"> </a>
<a name="ln5822">                if (string.IsNullOrEmpty(text))</a>
<a name="ln5823">                {</a>
<a name="ln5824">                    UpdateProgress(count++);</a>
<a name="ln5825">                    continue;</a>
<a name="ln5826">                }</a>
<a name="ln5827"> </a>
<a name="ln5828">                #endregion</a>
<a name="ln5829"> </a>
<a name="ln5830">                var image = frame.Path.SourceFrom();</a>
<a name="ln5831"> </a>
<a name="ln5832">                #region Check if margins and paddings are set properly</a>
<a name="ln5833"> </a>
<a name="ln5834">                if (image.Width - (model.KeyStrokesPadding + model.KeyStrokesMargin) * 2 &lt;= 0 || image.Height - (model.KeyStrokesPadding + model.KeyStrokesMargin) * 2 &lt;= 0)</a>
<a name="ln5835">                {</a>
<a name="ln5836">                    UpdateProgress(count++);</a>
<a name="ln5837">                    continue;</a>
<a name="ln5838">                }</a>
<a name="ln5839"> </a>
<a name="ln5840">                #endregion</a>
<a name="ln5841"> </a>
<a name="ln5842">                var drawingVisual = new DrawingVisual();</a>
<a name="ln5843">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln5844">                {</a>
<a name="ln5845">                    //The FormattedText class helps in transforming the text to a shape.</a>
<a name="ln5846">                    var formatted = new FormattedText(text, CultureInfo.CurrentUICulture, FlowDirection.LeftToRight,</a>
<a name="ln5847">                        new Typeface(model.KeyStrokesFontFamily, model.KeyStrokesFontStyle, model.KeyStrokesFontWeight, default), model.KeyStrokesFontSize,</a>
<a name="ln5848">                        new SolidColorBrush(model.KeyStrokesFontColor), null, TextFormattingMode.Ideal)</a>
<a name="ln5849">                    {</a>
<a name="ln5850">                        MaxTextWidth = image.Width - (model.KeyStrokesPadding + model.KeyStrokesMargin) * 2,</a>
<a name="ln5851">                        MaxTextHeight = image.Height - (model.KeyStrokesPadding + model.KeyStrokesMargin) * 2,</a>
<a name="ln5852">                    };</a>
<a name="ln5853"> </a>
<a name="ln5854">                    //TODO: Test with high dpi.</a>
<a name="ln5855"> </a>
<a name="ln5856">                    var geometry = formatted.BuildGeometry(new Point(0.5, 0.5));</a>
<a name="ln5857">                    var bounds = geometry.GetRenderBounds(pen);</a>
<a name="ln5858"> </a>
<a name="ln5859">                    var widthText = bounds.Width + model.KeyStrokesPadding * 2;</a>
<a name="ln5860">                    var heightText = bounds.Height + model.KeyStrokesPadding * 2 + 1; //Why 1?</a>
<a name="ln5861"> </a>
<a name="ln5862">                    var leftText =</a>
<a name="ln5863">                        model.KeyStrokesHorizontalAlignment == HorizontalAlignment.Left ? model.KeyStrokesMargin - bounds.X :</a>
<a name="ln5864">                        model.KeyStrokesHorizontalAlignment == HorizontalAlignment.Right ? image.Width - widthText - bounds.X - model.KeyStrokesMargin :</a>
<a name="ln5865">                        (image.Width - widthText - bounds.X) / 2d;</a>
<a name="ln5866"> </a>
<a name="ln5867">                    var topText =</a>
<a name="ln5868">                        model.KeyStrokesVerticalAlignment == VerticalAlignment.Top ? model.KeyStrokesMargin - bounds.Y :</a>
<a name="ln5869">                        model.KeyStrokesVerticalAlignment == VerticalAlignment.Bottom ? image.Height - heightText - bounds.Y - model.KeyStrokesMargin :</a>
<a name="ln5870">                        (image.Height - heightText) / 2d - bounds.Y;</a>
<a name="ln5871"> </a>
<a name="ln5872">                    var widthRectangle = model.KeyStrokesHorizontalAlignment == HorizontalAlignment.Stretch ? image.Width - model.KeyStrokesMargin * 2 : widthText;</a>
<a name="ln5873">                    var heightRectangle = model.KeyStrokesVerticalAlignment == VerticalAlignment.Stretch ? image.Height - model.KeyStrokesMargin * 2 : Math.Max(heightText, model.KeyStrokesMinHeight);</a>
<a name="ln5874"> </a>
<a name="ln5875">                    //Center text when setting minimum height.</a>
<a name="ln5876">                    var minHeightAdjustment = model.KeyStrokesMinHeight &gt; heightText &amp;&amp; model.KeyStrokesVerticalAlignment != VerticalAlignment.Center &amp;&amp; model.KeyStrokesVerticalAlignment != VerticalAlignment.Stretch ?</a>
<a name="ln5877">                        ((model.KeyStrokesMinHeight - heightText) / 2d) * (model.KeyStrokesVerticalAlignment == VerticalAlignment.Bottom ? -1 : 1) : 0;</a>
<a name="ln5878"> </a>
<a name="ln5879">                    var minHeightAdjustmentRectangle = model.KeyStrokesMinHeight &gt; heightText &amp;&amp; model.KeyStrokesVerticalAlignment == VerticalAlignment.Center ? ((model.KeyStrokesMinHeight - heightText) / 2d) : 0;</a>
<a name="ln5880"> </a>
<a name="ln5881">                    var leftRectangle =</a>
<a name="ln5882">                        model.KeyStrokesHorizontalAlignment == HorizontalAlignment.Stretch ? model.KeyStrokesMargin :</a>
<a name="ln5883">                        leftText + bounds.X &lt; model.KeyStrokesMargin ? model.KeyStrokesMargin : leftText + bounds.X;</a>
<a name="ln5884"> </a>
<a name="ln5885">                    var topRectangle =</a>
<a name="ln5886">                        model.KeyStrokesVerticalAlignment == VerticalAlignment.Stretch || model.KeyStrokesVerticalAlignment == VerticalAlignment.Top ? model.KeyStrokesMargin :</a>
<a name="ln5887">                        model.KeyStrokesVerticalAlignment == VerticalAlignment.Bottom ? image.Height - heightRectangle - model.KeyStrokesMargin :</a>
<a name="ln5888">                        topText + bounds.Y &lt; model.KeyStrokesMargin ? model.KeyStrokesMargin : topText + bounds.Y - minHeightAdjustmentRectangle;</a>
<a name="ln5889"> </a>
<a name="ln5890">                    geometry.Transform = new TranslateTransform(Math.Round(leftText + model.KeyStrokesPadding, 0), Math.Round(topText + model.KeyStrokesPadding + minHeightAdjustment, 0));</a>
<a name="ln5891"> </a>
<a name="ln5892">                    //Draws everything in order, the image, the rectangle and the text.</a>
<a name="ln5893">                    drawingContext.DrawImage(image, new Rect(0, 0, image.Width, image.Height));</a>
<a name="ln5894">                    drawingContext.DrawRectangle(new SolidColorBrush(model.KeyStrokesBackgroundColor), null, new Rect(Math.Round(leftRectangle, 0), Math.Round(topRectangle, 0), Math.Round(widthRectangle, 0), Math.Round(heightRectangle, 0)));</a>
<a name="ln5895"> </a>
<a name="ln5896">                    //This code will draw the outline outside the text.</a>
<a name="ln5897">                    if (UserSettings.All.DrawOutlineOutside)</a>
<a name="ln5898">                    {</a>
<a name="ln5899">                        drawingContext.DrawGeometry(null, pen, geometry);</a>
<a name="ln5900">                        drawingContext.DrawGeometry(new SolidColorBrush(model.KeyStrokesFontColor), null, geometry);</a>
<a name="ln5901">                    }</a>
<a name="ln5902">                    else</a>
<a name="ln5903">                        drawingContext.DrawGeometry(new SolidColorBrush(model.KeyStrokesFontColor), pen, geometry);</a>
<a name="ln5904">                }</a>
<a name="ln5905"> </a>
<a name="ln5906">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln5907">                var bmp = new RenderTargetBitmap(image.PixelWidth, image.PixelHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln5908">                bmp.Render(drawingVisual);</a>
<a name="ln5909"> </a>
<a name="ln5910">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln5911">                var encoder = new PngBitmapEncoder();</a>
<a name="ln5912">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln5913"> </a>
<a name="ln5914">                //Saves the image into a file using the encoder.</a>
<a name="ln5915">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln5916">                    encoder.Save(stream);</a>
<a name="ln5917"> </a>
<a name="ln5918">                GC.WaitForPendingFinalizers();</a>
<a name="ln5919">                GC.Collect(1);</a>
<a name="ln5920"> </a>
<a name="ln5921">                UpdateProgress(count++);</a>
<a name="ln5922">            }</a>
<a name="ln5923">        }</a>
<a name="ln5924"> </a>
<a name="ln5925">        private void BorderAsync(BorderViewModel model)</a>
<a name="ln5926">        {</a>
<a name="ln5927">            Dispatcher?.Invoke(() =&gt;</a>
<a name="ln5928">            {</a>
<a name="ln5929">                IsLoading = true;</a>
<a name="ln5930">            });</a>
<a name="ln5931"> </a>
<a name="ln5932">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), Project.Frames.Count);</a>
<a name="ln5933"> </a>
<a name="ln5934">            //If the borders are negative or this was called by an automatic task, select all frames.</a>
<a name="ln5935">            var frames = model.LeftThickness &lt; 0 || model.TopThickness &lt; 0 || model.RightThickness &lt; 0 || model.BottomThickness &lt; 0 || !model.IsManual ? Project.Frames : SelectedFrames();</a>
<a name="ln5936">            var scale = Math.Round(ZoomBoxControl.ImageDpi / 96d, 2); //ZoomBoxControl.ImageScale;</a>
<a name="ln5937"> </a>
<a name="ln5938">            //Since there could be a difference in the DPI of the UI vs the one from the image, I need to adjust the scale of the thickness.</a>
<a name="ln5939">            var leftThick = model.LeftThickness * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5940">            var topThick = model.TopThickness * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5941">            var rightThick = model.RightThickness * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5942">            var bottomThick = model.BottomThickness * ZoomBoxControl.ScaleDiff;</a>
<a name="ln5943"> </a>
<a name="ln5944">            var count = 0;</a>
<a name="ln5945">            foreach (var frame in frames)</a>
<a name="ln5946">            {</a>
<a name="ln5947">                if (_abortLoading)</a>
<a name="ln5948">                    return;</a>
<a name="ln5949"> </a>
<a name="ln5950">                var image = frame.Path.SourceFrom();</a>
<a name="ln5951">                var drawingVisual = new DrawingVisual();</a>
<a name="ln5952"> </a>
<a name="ln5953">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln5954">                {</a>
<a name="ln5955">                    #region Draws the white rectangle behind with full size</a>
<a name="ln5956"> </a>
<a name="ln5957">                    var marginHorizontal = Math.Abs((int)Math.Min(leftThick, 0) + Math.Min(rightThick, 0)); //Left and right negative margins as a positive number.</a>
<a name="ln5958">                    var marginVertical = Math.Abs((int)Math.Min(topThick, 0) + Math.Min(bottomThick, 0)); //Top and bottom negative margins as a positive number.</a>
<a name="ln5959"> </a>
<a name="ln5960">                    drawingContext.DrawRectangle(Brushes.White, null, new Rect(0, 0, image.Width + marginHorizontal, image.Height + marginVertical));</a>
<a name="ln5961"> </a>
<a name="ln5962">                    #endregion</a>
<a name="ln5963"> </a>
<a name="ln5964">                    #region Draws the image with the top-left margin</a>
<a name="ln5965"> </a>
<a name="ln5966">                    var marginLeft = (int)Math.Abs(Math.Min(leftThick, 0)); //Left negative margin as a positive number.</a>
<a name="ln5967">                    var marginTop = (int)Math.Abs(Math.Min(topThick, 0)); //Right negative margin as a positive number.</a>
<a name="ln5968"> </a>
<a name="ln5969">                    drawingContext.DrawImage(image, new Rect(marginLeft, marginTop, image.Width, image.Height));</a>
<a name="ln5970"> </a>
<a name="ln5971">                    #endregion</a>
<a name="ln5972"> </a>
<a name="ln5973">                    #region Draws the 4 lines</a>
<a name="ln5974"> </a>
<a name="ln5975">                    //The lines are centrally aligned, so they must be drawn at thickness / 2.</a>
<a name="ln5976">                    var brush = new SolidColorBrush(model.Color);</a>
<a name="ln5977"> </a>
<a name="ln5978">                    var height = image.Height + marginVertical;</a>
<a name="ln5979">                    var width = image.Width + marginLeft - (rightThick &gt; 0 ? rightThick : 0); //image.Width + width / 2d - trueRight / 2d</a>
<a name="ln5980"> </a>
<a name="ln5981">                    //Left border.</a>
<a name="ln5982">                    var xLeft = Math.Abs(leftThick) / 2d;</a>
<a name="ln5983">                    drawingContext.DrawLine(new Pen(brush, Math.Abs(leftThick)), new Point(xLeft, 0), new Point(xLeft, height));</a>
<a name="ln5984"> </a>
<a name="ln5985">                    //Right border.</a>
<a name="ln5986">                    var xRight = (leftThick &lt; 0 ? leftThick * -1 : 0) + image.Width + (Math.Abs(rightThick) / 2d * (rightThick &lt; 0 ? 1 : -1));</a>
<a name="ln5987">                    drawingContext.DrawLine(new Pen(brush, Math.Abs(rightThick)), new Point(xRight, 0), new Point(xRight, height));</a>
<a name="ln5988"> </a>
<a name="ln5989">                    //Top border.</a>
<a name="ln5990">                    var xTop = Math.Abs(leftThick);</a>
<a name="ln5991">                    var yTop = Math.Abs(topThick) / 2d;</a>
<a name="ln5992">                    drawingContext.DrawLine(new Pen(brush, Math.Abs(topThick)), new Point(xTop, yTop), new Point(width, yTop));</a>
<a name="ln5993"> </a>
<a name="ln5994">                    //Bottom border.</a>
<a name="ln5995">                    var yBottom = (topThick &lt; 0 ? topThick * -1 : 0) + image.Height + (Math.Abs(bottomThick) / 2d * (bottomThick &lt; 0 ? 1 : -1));</a>
<a name="ln5996">                    drawingContext.DrawLine(new Pen(brush, Math.Abs(bottomThick)), new Point(xTop, yBottom), new Point(width, yBottom));</a>
<a name="ln5997"> </a>
<a name="ln5998">                    #endregion</a>
<a name="ln5999">                }</a>
<a name="ln6000"> </a>
<a name="ln6001">                var frameHeight = image.PixelHeight + (int)(Math.Round((topThick &lt; 0 ? Math.Abs(topThick) : 0) + (bottomThick &lt; 0 ? Math.Abs(bottomThick) : 0), 0) * scale);</a>
<a name="ln6002">                var frameWidth = image.PixelWidth + (int)(Math.Round((leftThick &lt; 0 ? Math.Abs(leftThick) : 0) + (rightThick &lt; 0 ? Math.Abs(rightThick) : 0), 0) * scale);</a>
<a name="ln6003"> </a>
<a name="ln6004">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln6005">                var bmp = new RenderTargetBitmap(frameWidth, frameHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln6006">                bmp.Render(drawingVisual);</a>
<a name="ln6007"> </a>
<a name="ln6008">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln6009">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6010">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln6011"> </a>
<a name="ln6012">                //Saves the image into a file using the encoder.</a>
<a name="ln6013">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln6014">                    encoder.Save(stream);</a>
<a name="ln6015"> </a>
<a name="ln6016">                UpdateProgress(count++);</a>
<a name="ln6017">            }</a>
<a name="ln6018">        }</a>
<a name="ln6019"> </a>
<a name="ln6020">        private void ShadowAsync(ShadowViewModel model)</a>
<a name="ln6021">        {</a>
<a name="ln6022">            Dispatcher?.Invoke(() =&gt;</a>
<a name="ln6023">            {</a>
<a name="ln6024">                IsLoading = true;</a>
<a name="ln6025">            });</a>
<a name="ln6026"> </a>
<a name="ln6027">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), Project.Frames.Count);</a>
<a name="ln6028"> </a>
<a name="ln6029">            var scale = Math.Round(ZoomBoxControl.ImageDpi / 96d, 2); //ZoomBoxControl.ImageScale;</a>
<a name="ln6030">            var blur = model.BlurRadius * ZoomBoxControl.ScaleDiff;</a>
<a name="ln6031">            var depth = model.Depth * ZoomBoxControl.ScaleDiff;</a>
<a name="ln6032"> </a>
<a name="ln6033">            var count = 0;</a>
<a name="ln6034">            foreach (var frame in Project.Frames)</a>
<a name="ln6035">            {</a>
<a name="ln6036">                if (_abortLoading)</a>
<a name="ln6037">                    return;</a>
<a name="ln6038"> </a>
<a name="ln6039">                var image = frame.Path.SourceFrom();</a>
<a name="ln6040">                var drawingVisual = new DrawingVisual();</a>
<a name="ln6041"> </a>
<a name="ln6042">                //Sizes:</a>
<a name="ln6043">                var frameHeight = 0;</a>
<a name="ln6044">                var frameWidth = 0;</a>
<a name="ln6045"> </a>
<a name="ln6046">                drawingVisual.Effect = new DropShadowEffect</a>
<a name="ln6047">                {</a>
<a name="ln6048">                    Color = model.Color,</a>
<a name="ln6049">                    BlurRadius = model.BlurRadius * ZoomBoxControl.ScaleDiff,</a>
<a name="ln6050">                    Opacity = model.Opacity,</a>
<a name="ln6051">                    Direction = model.Direction,</a>
<a name="ln6052">                    ShadowDepth = model.Depth * ZoomBoxControl.ScaleDiff,</a>
<a name="ln6053">                    RenderingBias = RenderingBias.Quality</a>
<a name="ln6054">                };</a>
<a name="ln6055"> </a>
<a name="ln6056">                //Draws image with shadow.</a>
<a name="ln6057">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln6058">                {</a>
<a name="ln6059">                    //https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Sin_Cos_Tan_Cot_unit_circle.svg/1154px-Sin_Cos_Tan_Cot_unit_circle.svg.png</a>
<a name="ln6060">                    //The cosine of the direction gives the offset of the X axis based on the Width/2 of the point where the circle line crosses the line coming from the center of the circle.</a>
<a name="ln6061">                    //The sine of the direction gives the offset of the Y axis based on the Height/2 of the point where the circle line crosses the line coming from the center of the circle.</a>
<a name="ln6062"> </a>
<a name="ln6063">                    // Cosine:</a>
<a name="ln6064">                    //Negative: to the left.</a>
<a name="ln6065">                    //Positive: to the right.</a>
<a name="ln6066">                    // Sine:</a>
<a name="ln6067">                    //Positive: to the top.</a>
<a name="ln6068">                    //Negative: to the bottom.</a>
<a name="ln6069"> </a>
<a name="ln6070">                    //&lt;- 180, 3.14rad</a>
<a name="ln6071">                    //L: Blur + Depth</a>
<a name="ln6072">                    //T: Blur</a>
<a name="ln6073">                    //R: Math.Max(Blur - Depth, 0) //If the depth is lower than the blur radius, a bit of shadow will appear at the side.</a>
<a name="ln6074">                    //B: Blur</a>
<a name="ln6075"> </a>
<a name="ln6076">                    //-&gt; 0, 0rad</a>
<a name="ln6077">                    //L: Math.Max(Blur - Depth, 0) //If the depth is lower than the blur radius, a bit of shadow will appear at the side.</a>
<a name="ln6078">                    //T: Blur</a>
<a name="ln6079">                    //R: Blur + Depth</a>
<a name="ln6080">                    //B: Blur</a>
<a name="ln6081"> </a>
<a name="ln6082">                    //^&gt; 45, 0.78rad</a>
<a name="ln6083">                    //L: Math.Max(Blur - Depth * ratio, 0) //If the depth is lower than the blur radius, a bit of shadow will appear at the side.</a>
<a name="ln6084">                    //T: Blur + Depth * ratio</a>
<a name="ln6085">                    //R: Blur + Depth * ratio</a>
<a name="ln6086">                    //B: Math.Max(Blur - Depth * ratio, 0) //If the depth is lower than the blur radius, a bit of shadow will appear at the side.</a>
<a name="ln6087"> </a>
<a name="ln6088">                    //Converts the direction in degrees to radians.</a>
<a name="ln6089">                    var radians = Math.PI / 180.0 * model.Direction;</a>
<a name="ln6090">                    var offsetX = depth * Math.Cos(radians);</a>
<a name="ln6091">                    var offsetY = depth * Math.Sin(radians);</a>
<a name="ln6092"> </a>
<a name="ln6093">                    var offsetLeft = offsetX &lt; 0 ? offsetX * -1 : 0;</a>
<a name="ln6094">                    var offsetTop = offsetY &gt; 0 ? offsetY : 0;</a>
<a name="ln6095">                    var offsetRight = offsetX &gt; 0 ? offsetX : 0;</a>
<a name="ln6096">                    var offsetBottom = offsetY &lt; 0 ? offsetY * -1 : 0;</a>
<a name="ln6097"> </a>
<a name="ln6098">                    //Measure drop shadow space.</a>
<a name="ln6099">                    var marginLeft = offsetLeft &gt; 0 ? offsetLeft + blur / 2d : Math.Max(blur / 2d - offsetLeft, 0); //- offsetX</a>
<a name="ln6100">                    var marginTop = offsetTop &gt; 0 ? offsetTop + blur / 2d : Math.Max(blur / 2d - offsetTop, 0); //- offsetY</a>
<a name="ln6101">                    var marginRight = offsetRight &gt; 0 ? offsetRight + blur / 2d : Math.Max(blur / 2d - offsetRight, 0); //+ offsetX</a>
<a name="ln6102">                    var marginBottom = offsetBottom &gt; 0 ? offsetBottom + blur / 2d : Math.Max(blur / 2d - offsetBottom, 0); //+ offsetY</a>
<a name="ln6103"> </a>
<a name="ln6104">                    drawingContext.DrawImage(image, new Rect((int)marginLeft, (int)marginTop, image.Width, image.Height));</a>
<a name="ln6105"> </a>
<a name="ln6106">                    frameHeight = (int)((marginTop + image.Height + marginBottom) * scale);</a>
<a name="ln6107">                    frameWidth = (int)((marginLeft + image.Width + marginRight) * scale);</a>
<a name="ln6108">                }</a>
<a name="ln6109"> </a>
<a name="ln6110">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln6111">                var innerBmp = new RenderTargetBitmap(frameWidth, frameHeight, ZoomBoxControl.ImageDpi, ZoomBoxControl.ImageDpi, PixelFormats.Pbgra32);</a>
<a name="ln6112">                innerBmp.Render(drawingVisual);</a>
<a name="ln6113"> </a>
<a name="ln6114">                //Draws background and rendered image on top.</a>
<a name="ln6115">                drawingVisual = new DrawingVisual();</a>
<a name="ln6116">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln6117">                {</a>
<a name="ln6118">                    //Draws the background of the image.</a>
<a name="ln6119">                    drawingContext.DrawRectangle(new SolidColorBrush(model.BackgroundColor), null, new Rect(0, 0, innerBmp.Width, innerBmp.Height));</a>
<a name="ln6120"> </a>
<a name="ln6121">                    //Image, already with the shadow.</a>
<a name="ln6122">                    drawingContext.DrawImage(innerBmp, new Rect(0, 0, innerBmp.Width, innerBmp.Height));</a>
<a name="ln6123">                }</a>
<a name="ln6124"> </a>
<a name="ln6125">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln6126">                var bmp = new RenderTargetBitmap(frameWidth, frameHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln6127">                bmp.Render(drawingVisual);</a>
<a name="ln6128"> </a>
<a name="ln6129">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln6130">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6131">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln6132"> </a>
<a name="ln6133">                //Saves the image into a file using the encoder.</a>
<a name="ln6134">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln6135">                    encoder.Save(stream);</a>
<a name="ln6136"> </a>
<a name="ln6137">                UpdateProgress(count++);</a>
<a name="ln6138">            }</a>
<a name="ln6139">        }</a>
<a name="ln6140"> </a>
<a name="ln6141">        private void FlipRotate(FlipRotateType type)</a>
<a name="ln6142">        {</a>
<a name="ln6143">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingFlipRotate&quot;), Project.Frames.Count);</a>
<a name="ln6144"> </a>
<a name="ln6145">            var frameList = type is FlipRotateType.RotateLeft90 or FlipRotateType.RotateRight90 ? Project.Frames : SelectedFrames();</a>
<a name="ln6146"> </a>
<a name="ln6147">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln6148"> </a>
<a name="ln6149">            var count = 0;</a>
<a name="ln6150">            foreach (var frame in frameList)</a>
<a name="ln6151">            {</a>
<a name="ln6152">                var image = frame.Path.SourceFrom();</a>
<a name="ln6153"> </a>
<a name="ln6154">                Transform transform = null;</a>
<a name="ln6155"> </a>
<a name="ln6156">                switch (type)</a>
<a name="ln6157">                {</a>
<a name="ln6158">                    case FlipRotateType.FlipVertical:</a>
<a name="ln6159">                        transform = new ScaleTransform(1, -1, 0.5, 0.5);</a>
<a name="ln6160">                        break;</a>
<a name="ln6161">                    case FlipRotateType.FlipHorizontal:</a>
<a name="ln6162">                        transform = new ScaleTransform(-1, 1, 0.5, 0.5);</a>
<a name="ln6163">                        break;</a>
<a name="ln6164">                    case FlipRotateType.RotateLeft90:</a>
<a name="ln6165">                        transform = new RotateTransform(-90, 0.5, 0.5);</a>
<a name="ln6166">                        break;</a>
<a name="ln6167">                    case FlipRotateType.RotateRight90:</a>
<a name="ln6168">                        transform = new RotateTransform(90, 0.5, 0.5);</a>
<a name="ln6169">                        break;</a>
<a name="ln6170">                    default:</a>
<a name="ln6171">                        transform = new ScaleTransform(1, 1, 0.5, 0.5);</a>
<a name="ln6172">                        break;</a>
<a name="ln6173">                }</a>
<a name="ln6174"> </a>
<a name="ln6175">                var transBitmap = new TransformedBitmap(image, transform);</a>
<a name="ln6176"> </a>
<a name="ln6177">                // Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder</a>
<a name="ln6178">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6179">                encoder.Frames.Add(BitmapFrame.Create(transBitmap));</a>
<a name="ln6180"> </a>
<a name="ln6181">                // Saves the image into a file using the encoder</a>
<a name="ln6182">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln6183">                    encoder.Save(stream);</a>
<a name="ln6184"> </a>
<a name="ln6185">                UpdateProgress(count++);</a>
<a name="ln6186">            }</a>
<a name="ln6187">        }</a>
<a name="ln6188"> </a>
<a name="ln6189">        private void ReduceFrameCount(List&lt;int&gt; selection, int factor, int removeCount, ReduceDelayModes mode)</a>
<a name="ln6190">        {</a>
<a name="ln6191">            var removeList = new List&lt;int&gt;();</a>
<a name="ln6192"> </a>
<a name="ln6193">            //Gets the list of frames to be removed.</a>
<a name="ln6194">            for (var i = selection.Min() + factor - 1; i &lt; selection.Min() + selection.Count - 1; i += factor + removeCount)</a>
<a name="ln6195">                removeList.AddRange(Util.Other.ListOfIndexes(i + 1, removeCount));</a>
<a name="ln6196"> </a>
<a name="ln6197">            //Only allow removing frames within the possible range.</a>
<a name="ln6198">            removeList = removeList.Where(x =&gt; x &lt; Project.Frames.Count).ToList();</a>
<a name="ln6199"> </a>
<a name="ln6200">            var alterList = mode == ReduceDelayModes.Evenly ? Util.Other.ListOfIndexes(0, Project.Frames.Count).Where(w =&gt; !removeList.Contains(w)).ToList() :</a>
<a name="ln6201">                mode == ReduceDelayModes.Previous ? (from item in removeList where item - 1 &gt;= 0 select item - 1).ToList() : //.Union(removeList)</a>
<a name="ln6202">                new List&lt;int&gt;(); //No other frame will be altered if the delay is not adjusted.</a>
<a name="ln6203"> </a>
<a name="ln6204">            if (alterList.Any())</a>
<a name="ln6205">                ActionStack.SaveState(ActionStack.EditAction.RemoveAndAlter, Project.Frames, removeList, alterList);</a>
<a name="ln6206">            else</a>
<a name="ln6207">                ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, removeList);</a>
<a name="ln6208"> </a>
<a name="ln6209">            var delayRemoved = 0;</a>
<a name="ln6210">            for (var i = removeList.Count - 1; i &gt;= 0; i--)</a>
<a name="ln6211">            {</a>
<a name="ln6212">                var removeIndex = removeList[i];</a>
<a name="ln6213"> </a>
<a name="ln6214">                if (mode != ReduceDelayModes.DontAdjust)</a>
<a name="ln6215">                {</a>
<a name="ln6216">                    if (mode == ReduceDelayModes.Previous || factor == 1)</a>
<a name="ln6217">                    {</a>
<a name="ln6218">                        //Simply stacks the delay of the removed frames to the previous frame;</a>
<a name="ln6219">                        Project.Frames[removeIndex - 1].Delay += Project.Frames[removeIndex].Delay;</a>
<a name="ln6220">                    }</a>
<a name="ln6221">                    else if (mode == ReduceDelayModes.Evenly)</a>
<a name="ln6222">                    {</a>
<a name="ln6223">                        if (i == removeList.Count - 1 || removeList[i] + 1 == removeList[i + 1])</a>
<a name="ln6224">                        {</a>
<a name="ln6225">                            //Store the delay of the frames being removed.</a>
<a name="ln6226">                            delayRemoved += Project.Frames[removeIndex].Delay;</a>
<a name="ln6227">                        }</a>
<a name="ln6228">                        else</a>
<a name="ln6229">                        {</a>
<a name="ln6230">                            if (delayRemoved &gt; 0)</a>
<a name="ln6231">                            {</a>
<a name="ln6232">                                //Calculate the size of the remaining section (this is the factor, the number of frames not being removed in each section).</a>
<a name="ln6233">                                var size = removeList[i + 1] - removeList[i] - 1;</a>
<a name="ln6234"> </a>
<a name="ln6235">                                //Spread evenly the accumulated delay among the remaining frames.</a>
<a name="ln6236">                                for (var r = removeList[i + 1] - 1; r &gt; removeList[i]; r--)</a>
<a name="ln6237">                                    Project.Frames[r].Delay += delayRemoved / size; //Some information may be lost due to rounding.</a>
<a name="ln6238">                            }</a>
<a name="ln6239"> </a>
<a name="ln6240">                            //Start again the accumulation for this block of frames being removed.</a>
<a name="ln6241">                            delayRemoved = Project.Frames[removeIndex].Delay;</a>
<a name="ln6242">                        }</a>
<a name="ln6243">                    }</a>
<a name="ln6244">                }</a>
<a name="ln6245"> </a>
<a name="ln6246">                File.Delete(Project.Frames[removeIndex].Path);</a>
<a name="ln6247">                Project.Frames.RemoveAt(removeIndex);</a>
<a name="ln6248">            }</a>
<a name="ln6249">        }</a>
<a name="ln6250"> </a>
<a name="ln6251">        private int RemoveDuplicatesAsync(decimal similarity, DuplicatesRemovalModes removal, DuplicatesDelayModes delay)</a>
<a name="ln6252">        {</a>
<a name="ln6253">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln6254">            {</a>
<a name="ln6255">                IsLoading = true;</a>
<a name="ln6256">                Cursor = Cursors.AppStarting;</a>
<a name="ln6257">            });</a>
<a name="ln6258"> </a>
<a name="ln6259">            var removeList = new List&lt;int&gt;();</a>
<a name="ln6260">            var alterList = new List&lt;int&gt;();</a>
<a name="ln6261"> </a>
<a name="ln6262">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.AnalyzingDuplicates&quot;), Project.Frames.Count - 1);</a>
<a name="ln6263"> </a>
<a name="ln6264">            var similarFramePairs = Enumerable.Range(0, Project.Frames.Count - 1)</a>
<a name="ln6265">                .Select(i =&gt; { UpdateProgress(i + 1); return i; })</a>
<a name="ln6266">                .Select(i =&gt; (First: Project.Frames[i], Last: Project.Frames[i + 1]))</a>
<a name="ln6267">                .AsParallel()</a>
<a name="ln6268">                .Where(t =&gt; ImageMethods.CalculateDifference(t.First, t.Last) &gt;= similarity);</a>
<a name="ln6269"> </a>
<a name="ln6270">            foreach (var (firstFrame, lastFrame) in similarFramePairs)</a>
<a name="ln6271">            {</a>
<a name="ln6272">                switch (removal)</a>
<a name="ln6273">                {</a>
<a name="ln6274">                    case DuplicatesRemovalModes.First:</a>
<a name="ln6275">                        removeList.Add(firstFrame.Index);</a>
<a name="ln6276">                        alterList.Add(lastFrame.Index);</a>
<a name="ln6277">                        break;</a>
<a name="ln6278">                    case DuplicatesRemovalModes.Last:</a>
<a name="ln6279">                        alterList.Add(firstFrame.Index);</a>
<a name="ln6280">                        removeList.Add(lastFrame.Index);</a>
<a name="ln6281">                        break;</a>
<a name="ln6282">                    default:</a>
<a name="ln6283">                        throw new ArgumentOutOfRangeException(nameof(removal));</a>
<a name="ln6284">                }</a>
<a name="ln6285">            }</a>
<a name="ln6286"> </a>
<a name="ln6287">            if (removeList.Count == 0)</a>
<a name="ln6288">            {</a>
<a name="ln6289">                //TODO: Nothing being removed. I need to warn the user.</a>
<a name="ln6290">                return Project.Frames.Count;</a>
<a name="ln6291">            }</a>
<a name="ln6292"> </a>
<a name="ln6293">            // ActionStack assumes the list is sorted.</a>
<a name="ln6294">            removeList.Sort();</a>
<a name="ln6295">            alterList.Sort();</a>
<a name="ln6296"> </a>
<a name="ln6297">            var count = 0;</a>
<a name="ln6298">            if (delay != DuplicatesDelayModes.DontAdjust)</a>
<a name="ln6299">            {</a>
<a name="ln6300">                ShowProgress(LocalizationHelper.Get(&quot;S.Editor.AdjustingDuplicatesDelay&quot;), removeList.Count);</a>
<a name="ln6301"> </a>
<a name="ln6302">                //Gets the list of frames that will be altered (if the delay will be adjusted).</a>
<a name="ln6303">                var mode = removal == DuplicatesRemovalModes.First ? 1 : -1;</a>
<a name="ln6304"> </a>
<a name="ln6305">                ActionStack.SaveState(ActionStack.EditAction.RemoveAndAlter, Project.Frames, removeList, alterList);</a>
<a name="ln6306"> </a>
<a name="ln6307">                if (removal == DuplicatesRemovalModes.Last)</a>
<a name="ln6308">                {</a>
<a name="ln6309">                    for (var i = alterList.Count - 1; i &gt;= 0; i--)</a>
<a name="ln6310">                    {</a>
<a name="ln6311">                        var index = alterList[i];</a>
<a name="ln6312"> </a>
<a name="ln6313">                        //Sum or average of the delays.</a>
<a name="ln6314">                        if (delay == DuplicatesDelayModes.Sum)</a>
<a name="ln6315">                            Project.Frames[index].Delay += Project.Frames[index - mode].Delay;</a>
<a name="ln6316">                        else</a>
<a name="ln6317">                            Project.Frames[index].Delay = (Project.Frames[index - mode].Delay + Project.Frames[index].Delay) / 2;</a>
<a name="ln6318"> </a>
<a name="ln6319">                        UpdateProgress(count++);</a>
<a name="ln6320">                    }</a>
<a name="ln6321">                }</a>
<a name="ln6322">                else</a>
<a name="ln6323">                {</a>
<a name="ln6324">                    foreach (var index in alterList)</a>
<a name="ln6325">                    {</a>
<a name="ln6326">                        //Sum or average of the delays.</a>
<a name="ln6327">                        if (delay == DuplicatesDelayModes.Sum)</a>
<a name="ln6328">                            Project.Frames[index].Delay += Project.Frames[index - mode].Delay;</a>
<a name="ln6329">                        else</a>
<a name="ln6330">                            Project.Frames[index].Delay = (Project.Frames[index - mode].Delay + Project.Frames[index].Delay) / 2;</a>
<a name="ln6331"> </a>
<a name="ln6332">                        UpdateProgress(count++);</a>
<a name="ln6333">                    }</a>
<a name="ln6334">                }</a>
<a name="ln6335">            }</a>
<a name="ln6336">            else</a>
<a name="ln6337">            {</a>
<a name="ln6338">                ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, removeList);</a>
<a name="ln6339">            }</a>
<a name="ln6340"> </a>
<a name="ln6341">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.DiscardingDuplicates&quot;), removeList.Count);</a>
<a name="ln6342"> </a>
<a name="ln6343">            var removeFrames = removeList.Select(i =&gt; Project.Frames[i]).ToArray();</a>
<a name="ln6344"> </a>
<a name="ln6345">            foreach (var frame in removeFrames)</a>
<a name="ln6346">            {</a>
<a name="ln6347">                File.Delete(frame.Path);</a>
<a name="ln6348">                Project.Frames.Remove(frame);</a>
<a name="ln6349"> </a>
<a name="ln6350">                UpdateProgress(count++);</a>
<a name="ln6351">            }</a>
<a name="ln6352"> </a>
<a name="ln6353">            //Gets the minimum index being altered.</a>
<a name="ln6354">            return alterList.Concat(removeList).Min();</a>
<a name="ln6355">        }</a>
<a name="ln6356"> </a>
<a name="ln6357">        private int SmoothLoopAsync(decimal similarity, int threshold, SmoothLoopFromModes from)</a>
<a name="ln6358">        {</a>
<a name="ln6359">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln6360">            {</a>
<a name="ln6361">                IsLoading = true;</a>
<a name="ln6362">                Cursor = Cursors.AppStarting;</a>
<a name="ln6363">            });</a>
<a name="ln6364"> </a>
<a name="ln6365">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.FindingLoop&quot;), Project.Frames.Count - threshold);</a>
<a name="ln6366"> </a>
<a name="ln6367">            var start = from == SmoothLoopFromModes.Start ? threshold : Project.Frames.Count - 1;</a>
<a name="ln6368">            var end = from == SmoothLoopFromModes.Start ? Project.Frames.Count - 1 : threshold;</a>
<a name="ln6369">            var step = from == SmoothLoopFromModes.Start ? 1 : -1;</a>
<a name="ln6370"> </a>
<a name="ln6371">            var found = -1;</a>
<a name="ln6372">            var count = 0;</a>
<a name="ln6373">            var max = Math.Abs(start - end) + 1;</a>
<a name="ln6374"> </a>
<a name="ln6375">            while (count &lt; max)</a>
<a name="ln6376">            {</a>
<a name="ln6377">                UpdateProgress(count++);</a>
<a name="ln6378"> </a>
<a name="ln6379">                if (ImageMethods.CalculateDifference(Project.Frames[0], Project.Frames[start]) &gt;= similarity)</a>
<a name="ln6380">                {</a>
<a name="ln6381">                    found = start;</a>
<a name="ln6382">                    break;</a>
<a name="ln6383">                }</a>
<a name="ln6384"> </a>
<a name="ln6385">                start += step;</a>
<a name="ln6386">            }</a>
<a name="ln6387"> </a>
<a name="ln6388">            if (found == -1 || found == threshold - 1 || found == Project.Frames.Count - 1)</a>
<a name="ln6389">                return found;</a>
<a name="ln6390"> </a>
<a name="ln6391">            var removeList = Project.Frames.GetRange(found + 1, Project.Frames.Count - 1 - found).Select(s =&gt; s.Index).ToList();</a>
<a name="ln6392"> </a>
<a name="ln6393">            ActionStack.SaveState(ActionStack.EditAction.Remove, Project.Frames, removeList);</a>
<a name="ln6394"> </a>
<a name="ln6395">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.DiscardingLoop&quot;), removeList.Count);</a>
<a name="ln6396"> </a>
<a name="ln6397">            var removeFrames = removeList.Select(i =&gt; Project.Frames[i]).ToArray();</a>
<a name="ln6398">            count = 0;</a>
<a name="ln6399"> </a>
<a name="ln6400">            foreach (var frame in removeFrames)</a>
<a name="ln6401">            {</a>
<a name="ln6402">                File.Delete(frame.Path);</a>
<a name="ln6403">                Project.Frames.Remove(frame);</a>
<a name="ln6404"> </a>
<a name="ln6405">                UpdateProgress(count++);</a>
<a name="ln6406">            }</a>
<a name="ln6407"> </a>
<a name="ln6408">            return Project.Frames.Count - 1;</a>
<a name="ln6409">        }</a>
<a name="ln6410"> </a>
<a name="ln6411">        private void DelayAsync(DelayViewModel model, bool forAll = false, bool ignoreUi = false)</a>
<a name="ln6412">        {</a>
<a name="ln6413">            var frameList = forAll ? Project.Frames : SelectedFrames();</a>
<a name="ln6414"> </a>
<a name="ln6415">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln6416">            {</a>
<a name="ln6417">                IsLoading = true;</a>
<a name="ln6418">                Cursor = Cursors.AppStarting;</a>
<a name="ln6419">            });</a>
<a name="ln6420"> </a>
<a name="ln6421">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ChangingDelay&quot;), frameList.Count);</a>
<a name="ln6422"> </a>
<a name="ln6423">            var count = 0;</a>
<a name="ln6424">            foreach (var frameInfo in frameList)</a>
<a name="ln6425">            {</a>
<a name="ln6426">                if (_abortLoading)</a>
<a name="ln6427">                    return;</a>
<a name="ln6428"> </a>
<a name="ln6429">                switch (model.Type)</a>
<a name="ln6430">                {</a>
<a name="ln6431">                    case DelayUpdateModes.Override:</a>
<a name="ln6432">                    {</a>
<a name="ln6433">                        frameInfo.Delay = model.NewDelay;</a>
<a name="ln6434">                        break;</a>
<a name="ln6435">                    }</a>
<a name="ln6436">                    case DelayUpdateModes.IncreaseDecrease:</a>
<a name="ln6437">                    {</a>
<a name="ln6438">                        frameInfo.Delay += model.IncreaseDecreaseDelay;</a>
<a name="ln6439"> </a>
<a name="ln6440">                        if (frameInfo.Delay &lt; 10)</a>
<a name="ln6441">                            frameInfo.Delay = 10;</a>
<a name="ln6442">                        break;</a>
<a name="ln6443">                    }</a>
<a name="ln6444">                    default:</a>
<a name="ln6445">                    {</a>
<a name="ln6446">                        frameInfo.Delay = (int)Math.Round(frameInfo.Delay * model.Percent / 100m, 0);</a>
<a name="ln6447"> </a>
<a name="ln6448">                        if (frameInfo.Delay &lt; 10)</a>
<a name="ln6449">                            frameInfo.Delay = 10;</a>
<a name="ln6450">                        break;</a>
<a name="ln6451">                    }</a>
<a name="ln6452">                }</a>
<a name="ln6453"> </a>
<a name="ln6454">                #region Update UI</a>
<a name="ln6455"> </a>
<a name="ln6456">                if (!ignoreUi)</a>
<a name="ln6457">                {</a>
<a name="ln6458">                    var index = Project.Frames.IndexOf(frameInfo);</a>
<a name="ln6459">                    Dispatcher.Invoke(() =&gt; _viewModel.Frames[index].Delay = frameInfo.Delay);</a>
<a name="ln6460">                }</a>
<a name="ln6461"> </a>
<a name="ln6462">                #endregion</a>
<a name="ln6463"> </a>
<a name="ln6464">                UpdateProgress(count++);</a>
<a name="ln6465">            }</a>
<a name="ln6466"> </a>
<a name="ln6467">            Project.Persist();</a>
<a name="ln6468">        }</a>
<a name="ln6469"> </a>
<a name="ln6470">        private int Fade(int selected, int frameCount, object optional)</a>
<a name="ln6471">        {</a>
<a name="ln6472">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingTransition&quot;), Project.Frames.Count - selected + frameCount);</a>
<a name="ln6473"> </a>
<a name="ln6474">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln6475"> </a>
<a name="ln6476">            //Calculate opacity increment. When fading to a color, it will add a frame with a 100% opacity at the end.</a>
<a name="ln6477">            var increment = 1F / (frameCount + (UserSettings.All.FadeToType == FadeModes.NextFrame ? 1 : 0));</a>
<a name="ln6478">            var previousName = Path.GetFileNameWithoutExtension(Project.Frames[selected].Path);</a>
<a name="ln6479">            var previousFolder = Path.GetDirectoryName(Project.Frames[selected].Path);</a>
<a name="ln6480"> </a>
<a name="ln6481">            #region Images</a>
<a name="ln6482"> </a>
<a name="ln6483">            var previousImage = Project.Frames[selected].Path.SourceFrom();</a>
<a name="ln6484">            var nextImage = UserSettings.All.FadeToType == FadeModes.NextFrame ? Project.Frames[Project.Frames.Count - 1 == selected ? 0 : selected + 1].Path.SourceFrom() :</a>
<a name="ln6485">                ImageMethods.CreateEmtpyBitmapSource(UserSettings.All.FadeToColor, previousImage.PixelWidth, previousImage.PixelHeight, previousImage.DpiX, PixelFormats.Indexed1);</a>
<a name="ln6486"> </a>
<a name="ln6487">            var nextBrush = new ImageBrush</a>
<a name="ln6488">            {</a>
<a name="ln6489">                ImageSource = nextImage,</a>
<a name="ln6490">                Stretch = Stretch.Uniform,</a>
<a name="ln6491">                TileMode = TileMode.None,</a>
<a name="ln6492">                Opacity = increment,</a>
<a name="ln6493">                AlignmentX = AlignmentX.Center,</a>
<a name="ln6494">                AlignmentY = AlignmentY.Center</a>
<a name="ln6495">            };</a>
<a name="ln6496"> </a>
<a name="ln6497">            #endregion</a>
<a name="ln6498"> </a>
<a name="ln6499">            #region Creates and Save each Transition Frame</a>
<a name="ln6500"> </a>
<a name="ln6501">            for (var index = 0; index &lt; frameCount; index++)</a>
<a name="ln6502">            {</a>
<a name="ln6503">                var drawingVisual = new DrawingVisual();</a>
<a name="ln6504">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln6505">                {</a>
<a name="ln6506">                    drawingContext.DrawImage(previousImage, new Rect(0, 0, previousImage.Width, previousImage.Height));</a>
<a name="ln6507">                    drawingContext.DrawRectangle(nextBrush, null, new Rect(0, 0, nextImage.Width, nextImage.Height));</a>
<a name="ln6508">                }</a>
<a name="ln6509"> </a>
<a name="ln6510">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln6511">                var bmp = new RenderTargetBitmap(previousImage.PixelWidth, previousImage.PixelHeight, previousImage.DpiX, previousImage.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln6512">                bmp.Render(drawingVisual);</a>
<a name="ln6513"> </a>
<a name="ln6514">                //Increase the opacity for the next frame.</a>
<a name="ln6515">                nextBrush.Opacity += increment;</a>
<a name="ln6516"> </a>
<a name="ln6517">                //TODO: Fix filenaming.</a>
<a name="ln6518">                //TODO: This transition doesn't preserve any other frame info, such as keys pressed and mouse clicks.</a>
<a name="ln6519">                var fileName = Path.Combine(previousFolder, $&quot;{previousName} T {index} {DateTime.Now:hh-mm-ss fff}.png&quot;);</a>
<a name="ln6520">                Project.Frames.Insert(selected + index + 1, new FrameInfo(fileName, UserSettings.All.FadeTransitionDelay));</a>
<a name="ln6521"> </a>
<a name="ln6522">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln6523">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6524">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln6525"> </a>
<a name="ln6526">                //Saves the image into a file using the encoder.</a>
<a name="ln6527">                using (Stream stream = File.Create(fileName))</a>
<a name="ln6528">                    encoder.Save(stream);</a>
<a name="ln6529"> </a>
<a name="ln6530">                UpdateProgress(index);</a>
<a name="ln6531">            }</a>
<a name="ln6532"> </a>
<a name="ln6533">            #endregion</a>
<a name="ln6534"> </a>
<a name="ln6535">            return selected;</a>
<a name="ln6536">        }</a>
<a name="ln6537"> </a>
<a name="ln6538">        private int Slide(int selected, int frameCount, object optional)</a>
<a name="ln6539">        {</a>
<a name="ln6540">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingTransition&quot;), Project.Frames.Count - selected + frameCount);</a>
<a name="ln6541"> </a>
<a name="ln6542">            Dispatcher.Invoke(() =&gt; IsLoading = true);</a>
<a name="ln6543"> </a>
<a name="ln6544">            var previousName = Path.GetFileNameWithoutExtension(Project.Frames[selected].Path);</a>
<a name="ln6545">            var previousFolder = Path.GetDirectoryName(Project.Frames[selected].Path);</a>
<a name="ln6546"> </a>
<a name="ln6547">            #region Images</a>
<a name="ln6548"> </a>
<a name="ln6549">            var previousImage = Project.Frames[selected].Path.SourceFrom();</a>
<a name="ln6550">            var nextImage = Project.Frames[(Project.Frames.Count - 1) == selected ? 0 : selected + 1].Path.SourceFrom();</a>
<a name="ln6551"> </a>
<a name="ln6552">            var nextBrush = new ImageBrush</a>
<a name="ln6553">            {</a>
<a name="ln6554">                ImageSource = nextImage,</a>
<a name="ln6555">                Stretch = Stretch.Uniform,</a>
<a name="ln6556">                TileMode = TileMode.None,</a>
<a name="ln6557">                AlignmentX = AlignmentX.Center,</a>
<a name="ln6558">                AlignmentY = AlignmentY.Center</a>
<a name="ln6559">            };</a>
<a name="ln6560"> </a>
<a name="ln6561">            #endregion</a>
<a name="ln6562"> </a>
<a name="ln6563">            //Calculate Translate Transform increment.</a>
<a name="ln6564">            var increment = previousImage.Width / (frameCount + 1);</a>
<a name="ln6565">            var transf = increment;</a>
<a name="ln6566"> </a>
<a name="ln6567">            //Calculate the Opacity increment.</a>
<a name="ln6568">            var alphaIncrement = 1F / (frameCount + 1);</a>
<a name="ln6569">            nextBrush.Opacity = alphaIncrement;</a>
<a name="ln6570"> </a>
<a name="ln6571">            #region Creates and Save each Transition Frame</a>
<a name="ln6572"> </a>
<a name="ln6573">            for (var index = 0; index &lt; frameCount; index++)</a>
<a name="ln6574">            {</a>
<a name="ln6575">                var drawingVisual = new DrawingVisual();</a>
<a name="ln6576">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln6577">                {</a>
<a name="ln6578">                    drawingContext.DrawImage(previousImage, new Rect(0, 0, previousImage.Width, previousImage.Height));</a>
<a name="ln6579">                    drawingContext.DrawRectangle(nextBrush, null, new Rect(previousImage.Width - transf, 0, nextImage.Width, nextImage.Height));</a>
<a name="ln6580">                }</a>
<a name="ln6581"> </a>
<a name="ln6582">                // Converts the Visual (DrawingVisual) into a BitmapSource</a>
<a name="ln6583">                var bmp = new RenderTargetBitmap(previousImage.PixelWidth, previousImage.PixelHeight, previousImage.DpiX, previousImage.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln6584">                bmp.Render(drawingVisual);</a>
<a name="ln6585"> </a>
<a name="ln6586">                //Increase the translation and opacity for the next frame.</a>
<a name="ln6587">                transf += increment;</a>
<a name="ln6588">                nextBrush.Opacity += alphaIncrement;</a>
<a name="ln6589"> </a>
<a name="ln6590">                //TODO: Fix filenaming.</a>
<a name="ln6591">                //TODO: This transition doesn't preserve any other frame info, such as keys pressed and mouse clicks.</a>
<a name="ln6592">                var fileName = Path.Combine(previousFolder, $&quot;{previousName} T {index} {DateTime.Now:hh-mm-ss fff}.png&quot;);</a>
<a name="ln6593">                Project.Frames.Insert(selected + index + 1, new FrameInfo(fileName, UserSettings.All.FadeTransitionDelay));</a>
<a name="ln6594"> </a>
<a name="ln6595">                // Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder</a>
<a name="ln6596">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6597">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln6598"> </a>
<a name="ln6599">                // Saves the image into a file using the encoder</a>
<a name="ln6600">                using (Stream stream = File.Create(fileName))</a>
<a name="ln6601">                    encoder.Save(stream);</a>
<a name="ln6602"> </a>
<a name="ln6603">                UpdateProgress(index);</a>
<a name="ln6604">            }</a>
<a name="ln6605"> </a>
<a name="ln6606">            #endregion</a>
<a name="ln6607"> </a>
<a name="ln6608">            return selected;</a>
<a name="ln6609">        }</a>
<a name="ln6610"> </a>
<a name="ln6611">        private List&lt;int&gt; ObfuscateAsync(Rect rect, double screenScale, bool forAll = false)</a>
<a name="ln6612">        {</a>
<a name="ln6613">            var frameList = forAll ? Project.Frames : SelectedFrames();</a>
<a name="ln6614">            var selectedList = Dispatcher.Invoke(() =&gt;</a>
<a name="ln6615">            {</a>
<a name="ln6616">                IsLoading = true;</a>
<a name="ln6617"> </a>
<a name="ln6618">                return forAll ? Project.Frames.Select(x =&gt; Project.Frames.IndexOf(x)).ToList() : SelectedFramesIndex();</a>
<a name="ln6619">            });</a>
<a name="ln6620"> </a>
<a name="ln6621">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), frameList.Count);</a>
<a name="ln6622"> </a>
<a name="ln6623">            var size = frameList[0].Path.ScaledSize();</a>
<a name="ln6624"> </a>
<a name="ln6625">            rect = rect.Scale(screenScale).Limit(size.Width, size.Height);</a>
<a name="ln6626"> </a>
<a name="ln6627">            var count = 0;</a>
<a name="ln6628">            foreach (var frame in frameList)</a>
<a name="ln6629">            {</a>
<a name="ln6630">                var image = frame.Path.SourceFrom();</a>
<a name="ln6631">                BitmapSource render;</a>
<a name="ln6632"> </a>
<a name="ln6633">                switch (UserSettings.All.ObfuscationMode)</a>
<a name="ln6634">                {</a>
<a name="ln6635">                    case ObfuscationModes.Blur:</a>
<a name="ln6636">                    {</a>
<a name="ln6637">                        render = ImageMethods.Blur(image, (int)rect.X, (int)rect.Y, (int)rect.Width, (int)rect.Height,</a>
<a name="ln6638">                            UserSettings.All.BlurLevel, UserSettings.All.ObfuscationSmoothnessOpacity, UserSettings.All.ObfuscationSmoothnessRadius, UserSettings.All.ObfuscationInvertedSelection);</a>
<a name="ln6639">                        break;</a>
<a name="ln6640">                    }</a>
<a name="ln6641">                    case ObfuscationModes.Darken:</a>
<a name="ln6642">                    {</a>
<a name="ln6643">                        render = ImageMethods.Lightness(image, (int)rect.X, (int)rect.Y, (int)rect.Width, (int)rect.Height, true,</a>
<a name="ln6644">                            UserSettings.All.DarkenLevel, UserSettings.All.ObfuscationSmoothnessOpacity, UserSettings.All.ObfuscationSmoothnessRadius, UserSettings.All.ObfuscationInvertedSelection);</a>
<a name="ln6645">                        break;</a>
<a name="ln6646">                    }</a>
<a name="ln6647">                    case ObfuscationModes.Lighten:</a>
<a name="ln6648">                    {</a>
<a name="ln6649">                        render = ImageMethods.Lightness(image, (int)rect.X, (int)rect.Y, (int)rect.Width, (int)rect.Height, false,</a>
<a name="ln6650">                            UserSettings.All.LightenLevel, UserSettings.All.ObfuscationSmoothnessOpacity, UserSettings.All.ObfuscationSmoothnessRadius, UserSettings.All.ObfuscationInvertedSelection);</a>
<a name="ln6651">                        break;</a>
<a name="ln6652">                    }</a>
<a name="ln6653">                    default:</a>
<a name="ln6654">                    {</a>
<a name="ln6655">                        render = ImageMethods.Pixelate(image, (int)rect.X, (int)rect.Y, (int)rect.Width, (int)rect.Height,</a>
<a name="ln6656">                            UserSettings.All.PixelSize, UserSettings.All.ObfuscationSmoothnessOpacity, UserSettings.All.ObfuscationSmoothnessRadius, UserSettings.All.UseMedian, UserSettings.All.ObfuscationInvertedSelection);</a>
<a name="ln6657">                        break;</a>
<a name="ln6658">                    }</a>
<a name="ln6659">                }</a>
<a name="ln6660"> </a>
<a name="ln6661">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln6662">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6663">                encoder.Frames.Add(BitmapFrame.Create(render));</a>
<a name="ln6664"> </a>
<a name="ln6665">                //Saves the image into a file using the encoder.</a>
<a name="ln6666">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln6667">                    encoder.Save(stream);</a>
<a name="ln6668"> </a>
<a name="ln6669">                UpdateProgress(count++);</a>
<a name="ln6670">            }</a>
<a name="ln6671"> </a>
<a name="ln6672">            return selectedList;</a>
<a name="ln6673">        }</a>
<a name="ln6674"> </a>
<a name="ln6675">        private void MouseEventsAsync(MouseEventsViewModel model)</a>
<a name="ln6676">        {</a>
<a name="ln6677">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln6678">            {</a>
<a name="ln6679">                IsLoading = true;</a>
<a name="ln6680">            });</a>
<a name="ln6681"> </a>
<a name="ln6682">            ShowProgress(LocalizationHelper.Get(&quot;S.Editor.ApplyingOverlay&quot;), Project.Frames.Count);</a>
<a name="ln6683"> </a>
<a name="ln6684">            var auxList = Project.Frames.CopyList();</a>
<a name="ln6685"> </a>
<a name="ln6686">            // Initialize brushes.</a>
<a name="ln6687">            var brushesByMouseButton = new Dictionary&lt;MouseButtons, SolidColorBrush&gt;();</a>
<a name="ln6688"> </a>
<a name="ln6689">            if (model.HighlightForegroundColor.A != 0)</a>
<a name="ln6690">            {</a>
<a name="ln6691">                var highlightSolidBrush = new SolidColorBrush(model.HighlightForegroundColor);</a>
<a name="ln6692">                highlightSolidBrush.Freeze();</a>
<a name="ln6693">                brushesByMouseButton.Add(MouseButtons.None, highlightSolidBrush);</a>
<a name="ln6694">            }</a>
<a name="ln6695"> </a>
<a name="ln6696">            if (model.LeftButtonForegroundColor.A != 0)</a>
<a name="ln6697">            {</a>
<a name="ln6698">                var leftClickSolidColorBrush = new SolidColorBrush(model.LeftButtonForegroundColor);</a>
<a name="ln6699">                leftClickSolidColorBrush.Freeze();</a>
<a name="ln6700">                brushesByMouseButton.Add(MouseButtons.Left, leftClickSolidColorBrush);</a>
<a name="ln6701">            }</a>
<a name="ln6702"> </a>
<a name="ln6703">            if (model.RightButtonForegroundColor.A != 0)</a>
<a name="ln6704">            {</a>
<a name="ln6705">                var rightClickSolidColorBrush = new SolidColorBrush(model.RightButtonForegroundColor);</a>
<a name="ln6706">                rightClickSolidColorBrush.Freeze();</a>
<a name="ln6707">                brushesByMouseButton.Add(MouseButtons.Right, rightClickSolidColorBrush);</a>
<a name="ln6708">            }</a>
<a name="ln6709"> </a>
<a name="ln6710">            if (model.MiddleButtonForegroundColor.A != 0)</a>
<a name="ln6711">            {</a>
<a name="ln6712">                var middleClickSolidColorBrush = new SolidColorBrush(model.MiddleButtonForegroundColor);</a>
<a name="ln6713">                middleClickSolidColorBrush.Freeze();</a>
<a name="ln6714">                brushesByMouseButton.Add(MouseButtons.Middle, middleClickSolidColorBrush);</a>
<a name="ln6715">            }</a>
<a name="ln6716"> </a>
<a name="ln6717">            if (model.FirstExtraButtonForegroundColor.A != 0)</a>
<a name="ln6718">            {</a>
<a name="ln6719">                var brush = new SolidColorBrush(model.FirstExtraButtonForegroundColor);</a>
<a name="ln6720">                brush.Freeze();</a>
<a name="ln6721">                brushesByMouseButton.Add(MouseButtons.FirstExtra, brush);</a>
<a name="ln6722">            }</a>
<a name="ln6723"> </a>
<a name="ln6724">            if (model.SecondExtraButtonForegroundColor.A != 0)</a>
<a name="ln6725">            {</a>
<a name="ln6726">                var brush = new SolidColorBrush(model.SecondExtraButtonForegroundColor);</a>
<a name="ln6727">                brush.Freeze();</a>
<a name="ln6728">                brushesByMouseButton.Add(MouseButtons.SecondExtra, brush);</a>
<a name="ln6729">            }</a>
<a name="ln6730"> </a>
<a name="ln6731">            var count = 0;</a>
<a name="ln6732">            foreach (var frame in auxList)</a>
<a name="ln6733">            {</a>
<a name="ln6734">                if (_abortLoading)</a>
<a name="ln6735">                    return;</a>
<a name="ln6736"> </a>
<a name="ln6737">                if (frame.ButtonClicked == MouseButtons.None || frame.CursorX == int.MinValue)</a>
<a name="ln6738">                {</a>
<a name="ln6739">                    UpdateProgress(count++);</a>
<a name="ln6740">                }</a>
<a name="ln6741"> </a>
<a name="ln6742">                if (!brushesByMouseButton.TryGetValue(frame.ButtonClicked, out var brush))</a>
<a name="ln6743">                {</a>
<a name="ln6744">                    continue;</a>
<a name="ln6745">                }</a>
<a name="ln6746"> </a>
<a name="ln6747">                var image = frame.Path.SourceFrom();</a>
<a name="ln6748">                var scale = Math.Round(image.DpiX / 96d, 2);</a>
<a name="ln6749">                var drawingVisual = new DrawingVisual();</a>
<a name="ln6750">                using (var drawingContext = drawingVisual.RenderOpen())</a>
<a name="ln6751">                {</a>
<a name="ln6752">                    drawingContext.DrawImage(image, new Rect(0, 0, image.Width, image.Height));</a>
<a name="ln6753">                    drawingContext.DrawEllipse(brush, null, new Point(frame.CursorX / scale, frame.CursorY / scale), model.Width, model.Height);</a>
<a name="ln6754">                }</a>
<a name="ln6755"> </a>
<a name="ln6756">                //Converts the Visual (DrawingVisual) into a BitmapSource.</a>
<a name="ln6757">                var bmp = new RenderTargetBitmap(image.PixelWidth, image.PixelHeight, image.DpiX, image.DpiY, PixelFormats.Pbgra32);</a>
<a name="ln6758">                bmp.Render(drawingVisual);</a>
<a name="ln6759"> </a>
<a name="ln6760">                //Creates a PngBitmapEncoder and adds the BitmapSource to the frames of the encoder.</a>
<a name="ln6761">                var encoder = new PngBitmapEncoder();</a>
<a name="ln6762">                encoder.Frames.Add(BitmapFrame.Create(bmp));</a>
<a name="ln6763"> </a>
<a name="ln6764">                //Saves the image into a file using the encoder.</a>
<a name="ln6765">                using (Stream stream = File.Create(frame.Path))</a>
<a name="ln6766">                    encoder.Save(stream);</a>
<a name="ln6767"> </a>
<a name="ln6768">                GC.WaitForPendingFinalizers();</a>
<a name="ln6769">                GC.Collect(1);</a>
<a name="ln6770"> </a>
<a name="ln6771">                UpdateProgress(count++);</a>
<a name="ln6772">            }</a>
<a name="ln6773">        }</a>
<a name="ln6774"> </a>
<a name="ln6775">        #endregion</a>
<a name="ln6776">    }</a>
<a name="ln6777">}</a>
</code></pre>
<div class="balloon" rel="2857"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The 'e' object was used before it was verified against null. Check lines: 2857, 2861.</p></div>
<div class="balloon" rel="2857"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The 'e.Uri' object was used before it was verified against null. Check lines: 2857, 2861.</p></div>
<div class="balloon" rel="3179"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3032/" target="_blank">V3032</a> Waiting on this expression is unreliable, as compiler may optimize some of the variables. Use volatile variable(s) or synchronization primitives to avoid this.</p></div>
<div class="balloon" rel="4233"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3080/" target="_blank">V3080</a> Possible null dereference. Consider inspecting 'metadata'.</p></div>
<div class="balloon" rel="4155"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3125/" target="_blank">V3125</a> The 'Frames' object was used after it was verified against null. Check lines: 4155, 4153.</p></div>
<div class="balloon" rel="1582"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3156/" target="_blank">V3156</a> The first argument of the 'Format' method is not expected to be null.</p></div>
<div class="balloon" rel="1625"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3156/" target="_blank">V3156</a> The first argument of the 'Format' method is not expected to be null.</p></div>
<div class="balloon" rel="1652"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3156/" target="_blank">V3156</a> The first argument of the 'Format' method is not expected to be null.</p></div>
<div class="balloon" rel="1534"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3013/" target="_blank">V3013</a> It is odd that the body of 'Delete_CanExecute' function is fully equivalent to the body of 'Image_CanExecute' function (1534, line 1995).</p></div>
<div class="balloon" rel="220"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3090/" target="_blank">V3090</a> Unsafe locking on public member 'ActivateLock' in class 'Editor'.</p></div>
<div class="balloon" rel="6470"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3203/" target="_blank">V3203</a> Method parameter is not used: optional.</p></div>
<div class="balloon" rel="6538"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3203/" target="_blank">V3203</a> Method parameter is not used: optional.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>