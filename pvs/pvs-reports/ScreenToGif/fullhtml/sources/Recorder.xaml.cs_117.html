<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Recorder.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Diagnostics;</a>
<a name="ln3">using System.IO;</a>
<a name="ln4">using System.Linq;</a>
<a name="ln5">using System.Threading.Tasks;</a>
<a name="ln6">using System.Windows;</a>
<a name="ln7">using System.Windows.Forms;</a>
<a name="ln8">using System.Windows.Input;</a>
<a name="ln9">using System.Windows.Media;</a>
<a name="ln10">using System.Windows.Media.Animation;</a>
<a name="ln11">using System.Windows.Threading;</a>
<a name="ln12">using Microsoft.Win32;</a>
<a name="ln13">using ScreenToGif.Capture;</a>
<a name="ln14">using ScreenToGif.Controls;</a>
<a name="ln15">using ScreenToGif.Domain.Enums;</a>
<a name="ln16">using ScreenToGif.Domain.Events;</a>
<a name="ln17">using ScreenToGif.Domain.Exceptions;</a>
<a name="ln18">using ScreenToGif.Domain.Models;</a>
<a name="ln19">using ScreenToGif.Model;</a>
<a name="ln20">using ScreenToGif.Native.External;</a>
<a name="ln21">using ScreenToGif.Native.Helpers;</a>
<a name="ln22">using ScreenToGif.Native.Structs;</a>
<a name="ln23">using ScreenToGif.Util;</a>
<a name="ln24">using ScreenToGif.Util.Extensions;</a>
<a name="ln25">using ScreenToGif.Util.Settings;</a>
<a name="ln26">using ScreenToGif.ViewModel;</a>
<a name="ln27">using ScreenToGif.Windows.Other;</a>
<a name="ln28">using Cursors = System.Windows.Input.Cursors;</a>
<a name="ln29">using DpiChangedEventArgs = System.Windows.DpiChangedEventArgs;</a>
<a name="ln30">using KeyEventArgs = System.Windows.Input.KeyEventArgs;</a>
<a name="ln31">using MouseButtons = ScreenToGif.Domain.Enums.MouseButtons;</a>
<a name="ln32">using Timer = System.Windows.Forms.Timer;</a>
<a name="ln33"> </a>
<a name="ln34">namespace ScreenToGif.Windows;</a>
<a name="ln35"> </a>
<a name="ln36">public partial class Recorder</a>
<a name="ln37">{</a>
<a name="ln38">    #region Variables</a>
<a name="ln39"> </a>
<a name="ln40">    /// &lt;summary&gt;</a>
<a name="ln41">    /// The view model of the recorder.</a>
<a name="ln42">    /// &lt;/summary&gt;</a>
<a name="ln43">    private readonly ScreenRecorderViewModel _viewModel;</a>
<a name="ln44"> </a>
<a name="ln45">    /// &lt;summary&gt;</a>
<a name="ln46">    /// The region's left edge position.</a>
<a name="ln47">    /// &lt;/summary&gt;</a>
<a name="ln48">    private int _left = 0;</a>
<a name="ln49"> </a>
<a name="ln50">    /// &lt;summary&gt;</a>
<a name="ln51">    /// The region's top edge position.</a>
<a name="ln52">    /// &lt;/summary&gt;</a>
<a name="ln53">    private int _top = 0;</a>
<a name="ln54"> </a>
<a name="ln55">    /// &lt;summary&gt;</a>
<a name="ln56">    /// The region's width.</a>
<a name="ln57">    /// &lt;/summary&gt;</a>
<a name="ln58">    private int _width = 0;</a>
<a name="ln59"> </a>
<a name="ln60">    /// &lt;summary&gt;</a>
<a name="ln61">    /// The region's height.</a>
<a name="ln62">    /// &lt;/summary&gt;</a>
<a name="ln63">    private int _height = 0;</a>
<a name="ln64"> </a>
<a name="ln65">    /// &lt;summary&gt;</a>
<a name="ln66">    /// The object of the keyboard and mouse hooks.</a>
<a name="ln67">    /// &lt;/summary&gt;</a>
<a name="ln68">    private readonly InputHook _actHook;</a>
<a name="ln69"> </a>
<a name="ln70">    /// &lt;summary&gt;</a>
<a name="ln71">    /// The amount of seconds of the pre start delay, plus 1 (1+1=2);</a>
<a name="ln72">    /// &lt;/summary&gt;</a>
<a name="ln73">    private int _preStartCount = 1;</a>
<a name="ln74"> </a>
<a name="ln75">    /// &lt;summary&gt;</a>
<a name="ln76">    /// The DPI of the current screen.</a>
<a name="ln77">    /// &lt;/summary&gt;</a>
<a name="ln78">    private double _scale = 1;</a>
<a name="ln79"> </a>
<a name="ln80">    /// &lt;summary&gt;</a>
<a name="ln81">    /// The last window handle saved.</a>
<a name="ln82">    /// &lt;/summary&gt;</a>
<a name="ln83">    private IntPtr _lastHandle;</a>
<a name="ln84"> </a>
<a name="ln85">    #region Mouse cursor follow up</a>
<a name="ln86"> </a>
<a name="ln87">    /// &lt;summary&gt;</a>
<a name="ln88">    /// The previous position of the cursor in the X axis.</a>
<a name="ln89">    /// &lt;/summary&gt;</a>
<a name="ln90">    private int _prevPosX = 0;</a>
<a name="ln91"> </a>
<a name="ln92">    /// &lt;summary&gt;</a>
<a name="ln93">    /// The previous position of the cursor in the Y axis.</a>
<a name="ln94">    /// &lt;/summary&gt;</a>
<a name="ln95">    private int _prevPosY = 0;</a>
<a name="ln96"> </a>
<a name="ln97">    /// &lt;summary&gt;</a>
<a name="ln98">    /// The latest position of the cursor in the X axis.</a>
<a name="ln99">    /// &lt;/summary&gt;</a>
<a name="ln100">    private int _posX = 0;</a>
<a name="ln101"> </a>
<a name="ln102">    /// &lt;summary&gt;</a>
<a name="ln103">    /// The latest position of the cursor in the Y axis.</a>
<a name="ln104">    /// &lt;/summary&gt;</a>
<a name="ln105">    private int _posY = 0;</a>
<a name="ln106"> </a>
<a name="ln107">    /// &lt;summary&gt;</a>
<a name="ln108">    /// The offset in pixels. Used for moving the recorder around the X axis.</a>
<a name="ln109">    /// &lt;/summary&gt;</a>
<a name="ln110">    private double _offsetX = 0;</a>
<a name="ln111"> </a>
<a name="ln112">    /// &lt;summary&gt;</a>
<a name="ln113">    /// The offset in pixels. Used for moving the recorder around the Y axis.</a>
<a name="ln114">    /// &lt;/summary&gt;</a>
<a name="ln115">    private double _offsetY = 0;</a>
<a name="ln116"> </a>
<a name="ln117">    #endregion</a>
<a name="ln118"> </a>
<a name="ln119">    #endregion</a>
<a name="ln120"> </a>
<a name="ln121">    #region Timer</a>
<a name="ln122"> </a>
<a name="ln123">    private readonly Timer _preStartTimer = new Timer();</a>
<a name="ln124"> </a>
<a name="ln125">    private readonly Timer _followTimer = new Timer();</a>
<a name="ln126">    private readonly Timer _showBorderTimer = new Timer();</a>
<a name="ln127">    private readonly Timer _limitTimer = new Timer();</a>
<a name="ln128"> </a>
<a name="ln129">    #endregion</a>
<a name="ln130"> </a>
<a name="ln131"> </a>
<a name="ln132">    public Recorder()</a>
<a name="ln133">    {</a>
<a name="ln134">        InitializeComponent();</a>
<a name="ln135"> </a>
<a name="ln136">        _preStartTimer.Tick += PreStart_Elapsed;</a>
<a name="ln137">        _preStartTimer.Interval = 1000;</a>
<a name="ln138"> </a>
<a name="ln139">        #region Global Hook</a>
<a name="ln140"> </a>
<a name="ln141">        try</a>
<a name="ln142">        {</a>
<a name="ln143">            _actHook = new InputHook(true, true); //true for the mouse, true for the keyboard.</a>
<a name="ln144">            _actHook.KeyDown += KeyHookTarget;</a>
<a name="ln145">            _actHook.OnMouseActivity += MouseHookTarget;</a>
<a name="ln146">        }</a>
<a name="ln147">        catch (Exception) { }</a>
<a name="ln148"> </a>
<a name="ln149">        #endregion</a>
<a name="ln150"> </a>
<a name="ln151">        #region Model and commands</a>
<a name="ln152"> </a>
<a name="ln153">        DataContext = _viewModel = new ScreenRecorderViewModel();</a>
<a name="ln154"> </a>
<a name="ln155">        RegisterCommands();</a>
<a name="ln156"> </a>
<a name="ln157">        #endregion</a>
<a name="ln158"> </a>
<a name="ln159">        SystemEvents.PowerModeChanged += System_PowerModeChanged;</a>
<a name="ln160">        SystemEvents.DisplaySettingsChanged += SystemEvents_DisplaySettingsChanged;</a>
<a name="ln161">    }</a>
<a name="ln162"> </a>
<a name="ln163"> </a>
<a name="ln164">    #region Events</a>
<a name="ln165"> </a>
<a name="ln166">    private async void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln167">    {</a>
<a name="ln168">        #region Adjust the position</a>
<a name="ln169"> </a>
<a name="ln170">        UpdateScreenDpi();</a>
<a name="ln171"> </a>
<a name="ln172">        _viewModel.IsDirectMode = UserSettings.All.UseDesktopDuplication;</a>
<a name="ln173"> </a>
<a name="ln174">        await UpdatePositioning(true);</a>
<a name="ln175"> </a>
<a name="ln176">        #endregion</a>
<a name="ln177"> </a>
<a name="ln178">        UpdateSize();</a>
<a name="ln179">        UpdateLocation();</a>
<a name="ln180"> </a>
<a name="ln181">        DetectCaptureFrequency();</a>
<a name="ln182">        DetectThinMode();</a>
<a name="ln183">        AutoFitButtons(true);</a>
<a name="ln184"> </a>
<a name="ln185">        #region Timers</a>
<a name="ln186"> </a>
<a name="ln187">        _showBorderTimer.Interval = 500;</a>
<a name="ln188">        _showBorderTimer.Tick += ShowBorderTimer_Tick;</a>
<a name="ln189"> </a>
<a name="ln190">        _followTimer.Tick += FollowTimer_Tick;</a>
<a name="ln191"> </a>
<a name="ln192">        #endregion</a>
<a name="ln193"> </a>
<a name="ln194">        CommandManager.InvalidateRequerySuggested();</a>
<a name="ln195"> </a>
<a name="ln196">        if (UserSettings.All.CursorFollowing)</a>
<a name="ln197">            Follow();</a>
<a name="ln198"> </a>
<a name="ln199">        SizeChanged += Window_SizeChanged;</a>
<a name="ln200">        DpiChanged += Window_DpiChanged;</a>
<a name="ln201">        LocationChanged += Window_LocationChanged;</a>
<a name="ln202"> </a>
<a name="ln203">        //Automation arguments were passed by command line.</a>
<a name="ln204">        if (Arguments.Open)</a>
<a name="ln205">        {</a>
<a name="ln206">            if (Arguments.FrequencyType.HasValue)</a>
<a name="ln207">            {</a>
<a name="ln208">                UserSettings.All.CaptureFrequency = Arguments.FrequencyType.Value;</a>
<a name="ln209">                UserSettings.All.LatestFps = Arguments.Frequency;</a>
<a name="ln210">                DetectCaptureFrequency();</a>
<a name="ln211"> </a>
<a name="ln212">                Arguments.FrequencyType = null;</a>
<a name="ln213">            }</a>
<a name="ln214"> </a>
<a name="ln215">            if (Arguments.StartCapture &amp;&amp; UserSettings.All.CaptureFrequency &gt;= CaptureFrequencies.PerSecond)</a>
<a name="ln216">            {</a>
<a name="ln217">                if (Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln218">                {</a>
<a name="ln219">                    _limitTimer.Tick += Limit_Elapsed;</a>
<a name="ln220">                    _limitTimer.Interval = (int)Math.Min(int.MaxValue, Arguments.Limit.TotalMilliseconds);</a>
<a name="ln221">                }</a>
<a name="ln222"> </a>
<a name="ln223">                await Record();</a>
<a name="ln224">            }</a>
<a name="ln225">            else</a>
<a name="ln226">            {</a>
<a name="ln227">                Arguments.ClearAutomationArgs();</a>
<a name="ln228">            }</a>
<a name="ln229">        }</a>
<a name="ln230">    }</a>
<a name="ln231"> </a>
<a name="ln232">    private void Window_Activated(object sender, EventArgs e)</a>
<a name="ln233">    {</a>
<a name="ln234">        if (IsFollowing &amp;&amp; UserSettings.All.FollowShortcut == Key.None)</a>
<a name="ln235">        {</a>
<a name="ln236">            IsFollowing = false;</a>
<a name="ln237"> </a>
<a name="ln238">            Dialog.Ok(LocalizationHelper.Get(&quot;S.StartUp.Recorder&quot;), LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Header&quot;),</a>
<a name="ln239">                LocalizationHelper.Get(&quot;S.Options.Warning.Follow.Message&quot;), Icons.Warning);</a>
<a name="ln240">        }</a>
<a name="ln241">    }</a>
<a name="ln242"> </a>
<a name="ln243">    private void Window_DpiChanged(object sender, DpiChangedEventArgs e)</a>
<a name="ln244">    {</a>
<a name="ln245">        _scale = e.NewDpi.DpiScaleX;</a>
<a name="ln246"> </a>
<a name="ln247">        UpdateSize();</a>
<a name="ln248">        UpdateLocation();</a>
<a name="ln249"> </a>
<a name="ln250">        WidthIntegerBox.Scale = _scale;</a>
<a name="ln251">        HeightIntegerBox.Scale = _scale;</a>
<a name="ln252">    }</a>
<a name="ln253"> </a>
<a name="ln254">    private void Window_SizeChanged(object sender, SizeChangedEventArgs e)</a>
<a name="ln255">    {</a>
<a name="ln256">        UpdateSize();</a>
<a name="ln257">        AutoFitButtons();</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    private void Window_KeyDown(object sender, KeyEventArgs e)</a>
<a name="ln261">    {</a>
<a name="ln262">        var step = (Keyboard.Modifiers &amp; ModifierKeys.Alt) != 0 ? 5 : 1;</a>
<a name="ln263">        var key = e.Key == Key.System ? e.SystemKey : e.Key;</a>
<a name="ln264"> </a>
<a name="ln265">        if (Stage == RecorderStages.Stopped)</a>
<a name="ln266">        {</a>
<a name="ln267">            //Control + Shift: Expand both ways.</a>
<a name="ln268">            if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0 &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln269">            {</a>
<a name="ln270">                switch (key)</a>
<a name="ln271">                {</a>
<a name="ln272">                    case Key.Up:</a>
<a name="ln273">                        ResizeWindow(0, -step, 0, step);</a>
<a name="ln274">                        e.Handled = true;</a>
<a name="ln275">                        break;</a>
<a name="ln276">                    case Key.Down:</a>
<a name="ln277">                        ResizeWindow(0, step, 0, -step);</a>
<a name="ln278">                        e.Handled = true;</a>
<a name="ln279">                        break;</a>
<a name="ln280">                    case Key.Left:</a>
<a name="ln281">                        ResizeWindow(step, 0, -step, 0);</a>
<a name="ln282">                        e.Handled = true;</a>
<a name="ln283">                        break;</a>
<a name="ln284">                    case Key.Right:</a>
<a name="ln285">                        ResizeWindow(-step, 0, step, 0);</a>
<a name="ln286">                        e.Handled = true;</a>
<a name="ln287">                        break;</a>
<a name="ln288">                }</a>
<a name="ln289"> </a>
<a name="ln290">                return;</a>
<a name="ln291">            }</a>
<a name="ln292"> </a>
<a name="ln293">            //If the Shift key is pressed, the sizing mode is enabled (bottom right).</a>
<a name="ln294">            if ((Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln295">            {</a>
<a name="ln296">                switch (key)</a>
<a name="ln297">                {</a>
<a name="ln298">                    case Key.Left:</a>
<a name="ln299">                        ResizeWindow(0, 0, -step, 0);</a>
<a name="ln300">                        e.Handled = true;</a>
<a name="ln301">                        break;</a>
<a name="ln302">                    case Key.Up:</a>
<a name="ln303">                        ResizeWindow(0, 0, 0, -step);</a>
<a name="ln304">                        e.Handled = true;</a>
<a name="ln305">                        break;</a>
<a name="ln306">                    case Key.Right:</a>
<a name="ln307">                        ResizeWindow(0, 0, step, 0);</a>
<a name="ln308">                        e.Handled = true;</a>
<a name="ln309">                        break;</a>
<a name="ln310">                    case Key.Down:</a>
<a name="ln311">                        ResizeWindow(0, 0, 0, step);</a>
<a name="ln312">                        e.Handled = true;</a>
<a name="ln313">                        break;</a>
<a name="ln314">                }</a>
<a name="ln315"> </a>
<a name="ln316">                return;</a>
<a name="ln317">            }</a>
<a name="ln318"> </a>
<a name="ln319">            //If the Control key is pressed, the sizing mode is enabled (top left).</a>
<a name="ln320">            if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0)</a>
<a name="ln321">            {</a>
<a name="ln322">                switch (key)</a>
<a name="ln323">                {</a>
<a name="ln324">                    case Key.Left:</a>
<a name="ln325">                        ResizeWindow(-step, 0, 0, 0);</a>
<a name="ln326">                        e.Handled = true;</a>
<a name="ln327">                        break;</a>
<a name="ln328">                    case Key.Up:</a>
<a name="ln329">                        ResizeWindow(0, -step, 0, 0);</a>
<a name="ln330">                        e.Handled = true;</a>
<a name="ln331">                        break;</a>
<a name="ln332">                    case Key.Right:</a>
<a name="ln333">                        ResizeWindow(step, 0, 0, 0);</a>
<a name="ln334">                        e.Handled = true;</a>
<a name="ln335">                        break;</a>
<a name="ln336">                    case Key.Down:</a>
<a name="ln337">                        ResizeWindow(0, step, 0, 0);</a>
<a name="ln338">                        e.Handled = true;</a>
<a name="ln339">                        break;</a>
<a name="ln340">                }</a>
<a name="ln341"> </a>
<a name="ln342">                return;</a>
<a name="ln343">            }</a>
<a name="ln344">        }</a>
<a name="ln345"> </a>
<a name="ln346">        //If no other key is pressed, move the region.</a>
<a name="ln347">        switch (key)</a>
<a name="ln348">        {</a>
<a name="ln349">            case Key.Left:</a>
<a name="ln350">                MoveWindow(step, 0, 0, 0);</a>
<a name="ln351">                e.Handled = true;</a>
<a name="ln352">                break;</a>
<a name="ln353">            case Key.Up:</a>
<a name="ln354">                MoveWindow(0, step, 0, 0);</a>
<a name="ln355">                e.Handled = true;</a>
<a name="ln356">                break;</a>
<a name="ln357">            case Key.Right:</a>
<a name="ln358">                MoveWindow(0, 0, step, 0);</a>
<a name="ln359">                e.Handled = true;</a>
<a name="ln360">                break;</a>
<a name="ln361">            case Key.Down:</a>
<a name="ln362">                MoveWindow(0, 0, 0, step);</a>
<a name="ln363">                e.Handled = true;</a>
<a name="ln364">                break;</a>
<a name="ln365">        }</a>
<a name="ln366">    }</a>
<a name="ln367"> </a>
<a name="ln368">    private void CommandGrid_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln369">    {</a>
<a name="ln370">        if (Mouse.LeftButton == MouseButtonState.Pressed)</a>
<a name="ln371">            DragMove();</a>
<a name="ln372">    }</a>
<a name="ln373"> </a>
<a name="ln374">    private void Window_LocationChanged(object sender, EventArgs e)</a>
<a name="ln375">    {</a>
<a name="ln376">        UpdateLocation();</a>
<a name="ln377">    }</a>
<a name="ln378"> </a>
<a name="ln379">    private void SizeIntegerBox_MouseWheel(object sender, MouseWheelEventArgs e)</a>
<a name="ln380">    {</a>
<a name="ln381">        if (!(sender is IntegerBox box))</a>
<a name="ln382">            return;</a>
<a name="ln383"> </a>
<a name="ln384">        var screenPoint = box.PointToScreen(new Point(0, 0));</a>
<a name="ln385">        var scale = this.Scale();</a>
<a name="ln386"> </a>
<a name="ln387">        User32.SetCursorPos((int)(screenPoint.X + (box.ActualWidth / 2) * scale), (int)(screenPoint.Y + (box.ActualHeight / 2) * scale));</a>
<a name="ln388">    }</a>
<a name="ln389"> </a>
<a name="ln390">    private async void System_PowerModeChanged(object sender, PowerModeChangedEventArgs e)</a>
<a name="ln391">    {</a>
<a name="ln392">        if (e.Mode == PowerModes.Suspend)</a>
<a name="ln393">        {</a>
<a name="ln394">            if (Stage == RecorderStages.Recording)</a>
<a name="ln395">                Pause();</a>
<a name="ln396">            else if (Stage == RecorderStages.PreStarting)</a>
<a name="ln397">                await Stop();</a>
<a name="ln398"> </a>
<a name="ln399">            GC.Collect();</a>
<a name="ln400">        }</a>
<a name="ln401">    }</a>
<a name="ln402"> </a>
<a name="ln403">    private async void SystemEvents_DisplaySettingsChanged(object sender, EventArgs eventArgs)</a>
<a name="ln404">    {</a>
<a name="ln405">        await UpdatePositioning();</a>
<a name="ln406">    }</a>
<a name="ln407"> </a>
<a name="ln408">    private void SnapWindowButton_PreviewMouseDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln409">    {</a>
<a name="ln410">        Mouse.Capture(this);</a>
<a name="ln411"> </a>
<a name="ln412">        Cursor = Cursors.Cross;</a>
<a name="ln413">    }</a>
<a name="ln414"> </a>
<a name="ln415">    private void CloseButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln416">    {</a>
<a name="ln417">        Close();</a>
<a name="ln418">    }</a>
<a name="ln419"> </a>
<a name="ln420">    private async void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)</a>
<a name="ln421">    {</a>
<a name="ln422">        //Save the settings</a>
<a name="ln423">        UserSettings.All.RecorderTop = Top;</a>
<a name="ln424">        UserSettings.All.RecorderLeft = Left;</a>
<a name="ln425">        UserSettings.All.RecorderHeight = (int) Height;</a>
<a name="ln426">        UserSettings.All.RecorderWidth = (int) Width;</a>
<a name="ln427">        UserSettings.Save();</a>
<a name="ln428"> </a>
<a name="ln429">        #region Remove Hooks</a>
<a name="ln430"> </a>
<a name="ln431">        try</a>
<a name="ln432">        {</a>
<a name="ln433">            _actHook.OnMouseActivity -= MouseHookTarget;</a>
<a name="ln434">            _actHook.KeyDown -= KeyHookTarget;</a>
<a name="ln435">            _actHook.Stop(); //Stop the user activity watcher.</a>
<a name="ln436">        }</a>
<a name="ln437">        catch (Exception) { }</a>
<a name="ln438"> </a>
<a name="ln439">        #endregion</a>
<a name="ln440"> </a>
<a name="ln441">        SystemEvents.PowerModeChanged -= System_PowerModeChanged;</a>
<a name="ln442">        SystemEvents.DisplaySettingsChanged -= SystemEvents_DisplaySettingsChanged;</a>
<a name="ln443"> </a>
<a name="ln444">        #region Stops the timers</a>
<a name="ln445"> </a>
<a name="ln446">        if (Stage != RecorderStages.Stopped)</a>
<a name="ln447">        {</a>
<a name="ln448">            _preStartTimer.Stop();</a>
<a name="ln449">            _preStartTimer.Dispose();</a>
<a name="ln450"> </a>
<a name="ln451">            await StopCapture();</a>
<a name="ln452">        }</a>
<a name="ln453"> </a>
<a name="ln454">        //Garbage Collector Timer.</a>
<a name="ln455">        GarbageTimer?.Stop();</a>
<a name="ln456">        _followTimer?.Stop();</a>
<a name="ln457"> </a>
<a name="ln458">        #endregion</a>
<a name="ln459"> </a>
<a name="ln460">        //Clean all capture resources.</a>
<a name="ln461">        if (Capture != null)</a>
<a name="ln462">            await Capture.DisposeAsync();</a>
<a name="ln463"> </a>
<a name="ln464">        GC.Collect();</a>
<a name="ln465">    }</a>
<a name="ln466"> </a>
<a name="ln467">    #endregion</a>
<a name="ln468"> </a>
<a name="ln469">    #region Hooks</a>
<a name="ln470"> </a>
<a name="ln471">    /// &lt;summary&gt;</a>
<a name="ln472">    /// KeyHook event method. This fires when the user press a key.</a>
<a name="ln473">    /// &lt;/summary&gt;</a>
<a name="ln474">    private async void KeyHookTarget(object sender, CustomKeyEventArgs e)</a>
<a name="ln475">    {</a>
<a name="ln476">        if (RegionSelectHelper.IsSelecting || Stage == RecorderStages.Discarding)</a>
<a name="ln477">            return;</a>
<a name="ln478"> </a>
<a name="ln479">        //Capture when an user interactions happens.</a>
<a name="ln480">        if (Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction &amp;&amp; !IsKeyboardFocusWithin)</a>
<a name="ln481">            await Snap();</a>
<a name="ln482"> </a>
<a name="ln483">        //Record/snap or pause.</a>
<a name="ln484">        if (Keyboard.Modifiers.HasFlag(UserSettings.All.StartPauseModifiers) &amp;&amp; e.Key == UserSettings.All.StartPauseShortcut)</a>
<a name="ln485">        {</a>
<a name="ln486">            if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual)</a>
<a name="ln487">            {</a>
<a name="ln488">                _viewModel.SnapCommand.Execute(null, this);</a>
<a name="ln489">                return;</a>
<a name="ln490">            }</a>
<a name="ln491"> </a>
<a name="ln492">            if (Stage == RecorderStages.Recording)</a>
<a name="ln493">                _viewModel.PauseCommand.Execute(null, this);</a>
<a name="ln494">            else</a>
<a name="ln495">            {</a>
<a name="ln496">                if (_viewModel.Region.IsEmpty &amp;&amp; WindowState == WindowState.Minimized)</a>
<a name="ln497">                    WindowState = WindowState.Normal;</a>
<a name="ln498"> </a>
<a name="ln499">                _viewModel.RecordCommand.Execute(null, this);</a>
<a name="ln500">            }</a>
<a name="ln501"> </a>
<a name="ln502">            return;</a>
<a name="ln503">        }</a>
<a name="ln504"> </a>
<a name="ln505">        if (Keyboard.Modifiers.HasFlag(UserSettings.All.StopModifiers) &amp;&amp; e.Key == UserSettings.All.StopShortcut &amp;&amp; (Stage == RecorderStages.Recording || Stage == RecorderStages.Paused || Stage == RecorderStages.PreStarting))</a>
<a name="ln506">            await Stop();</a>
<a name="ln507">        else if (Keyboard.Modifiers.HasFlag(UserSettings.All.DiscardModifiers) &amp;&amp; e.Key == UserSettings.All.DiscardShortcut)</a>
<a name="ln508">            _viewModel.DiscardCommand.Execute(null, this);</a>
<a name="ln509">        else if (Keyboard.Modifiers.HasFlag(UserSettings.All.FollowModifiers) &amp;&amp; e.Key == UserSettings.All.FollowShortcut)</a>
<a name="ln510">            UserSettings.All.CursorFollowing = IsFollowing = !IsFollowing;</a>
<a name="ln511">        else</a>
<a name="ln512">            KeyList.Add(new SimpleKeyGesture(e.Key, Keyboard.Modifiers, e.IsUppercase, e.IsInjected));</a>
<a name="ln513">    }</a>
<a name="ln514"> </a>
<a name="ln515">    /// &lt;summary&gt;</a>
<a name="ln516">    /// MouseHook event method, detects the mouse clicks.</a>
<a name="ln517">    /// &lt;/summary&gt;</a>
<a name="ln518">    private async void MouseHookTarget(object sender, SimpleMouseGesture args)</a>
<a name="ln519">    {</a>
<a name="ln520">        try</a>
<a name="ln521">        {</a>
<a name="ln522">            if (RegionSelectHelper.IsSelecting || Stage == RecorderStages.Discarding)</a>
<a name="ln523">                return;</a>
<a name="ln524"> </a>
<a name="ln525">            //In the future, store each mouse event, with a timestamp, independently of the capture.</a>
<a name="ln526">            if (args.LeftButton == MouseButtonState.Pressed)</a>
<a name="ln527">                RecordClicked = MouseButtons.Left;</a>
<a name="ln528">            else if (args.RightButton == MouseButtonState.Pressed)</a>
<a name="ln529">                RecordClicked = MouseButtons.Right;</a>
<a name="ln530">            else if (args.MiddleButton == MouseButtonState.Pressed)</a>
<a name="ln531">                RecordClicked = MouseButtons.Middle;</a>
<a name="ln532">            else if (args.FirstExtraButton == MouseButtonState.Pressed)</a>
<a name="ln533">                RecordClicked = MouseButtons.FirstExtra;</a>
<a name="ln534">            else if (args.SecondExtraButton == MouseButtonState.Pressed)</a>
<a name="ln535">                RecordClicked = MouseButtons.SecondExtra;</a>
<a name="ln536">            else</a>
<a name="ln537">                RecordClicked = MouseButtons.None;</a>
<a name="ln538"> </a>
<a name="ln539">            _posX = args.PosX;</a>
<a name="ln540">            _posY = args.PosY;</a>
<a name="ln541"> </a>
<a name="ln542">            if (Stage == RecorderStages.Recording &amp;&amp; args.IsInteraction &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln543">            {</a>
<a name="ln544">                var controlHit = VisualTreeHelper.HitTest(this, Mouse.GetPosition(this));</a>
<a name="ln545"> </a>
<a name="ln546">                if (controlHit == null)</a>
<a name="ln547">                    await Snap();</a>
<a name="ln548">            }</a>
<a name="ln549">        }</a>
<a name="ln550">        catch (Exception e)</a>
<a name="ln551">        {</a>
<a name="ln552">            LogWriter.Log(e, &quot;Error in mouse hook target.&quot;);</a>
<a name="ln553">        }</a>
<a name="ln554"> </a>
<a name="ln555">        if (WindowState == WindowState.Minimized || !IsMouseCaptured || Mouse.Captured == null)</a>
<a name="ln556">            return;</a>
<a name="ln557"> </a>
<a name="ln558">        #region Get Handle and Window Rect</a>
<a name="ln559"> </a>
<a name="ln560">        var handle = User32.WindowFromPoint(new PointW { X = args.PosX, Y = args.PosY });</a>
<a name="ln561">        var scale = this.Scale();</a>
<a name="ln562"> </a>
<a name="ln563">        if (_lastHandle != handle)</a>
<a name="ln564">        {</a>
<a name="ln565">            if (_lastHandle != IntPtr.Zero)</a>
<a name="ln566">                Native.Helpers.Other.DrawFrame(_lastHandle, scale);</a>
<a name="ln567"> </a>
<a name="ln568">            _lastHandle = handle;</a>
<a name="ln569">            Native.Helpers.Other.DrawFrame(handle, scale);</a>
<a name="ln570">        }</a>
<a name="ln571"> </a>
<a name="ln572">        var rect = Native.Helpers.Windows.TrueWindowRectangle(handle);</a>
<a name="ln573"> </a>
<a name="ln574">        #endregion</a>
<a name="ln575"> </a>
<a name="ln576">        if (args.LeftButton == MouseButtonState.Pressed &amp;&amp; Mouse.LeftButton == MouseButtonState.Pressed)</a>
<a name="ln577">            return;</a>
<a name="ln578"> </a>
<a name="ln579">        #region Mouse Up</a>
<a name="ln580"> </a>
<a name="ln581">        Cursor = Cursors.Arrow;</a>
<a name="ln582"> </a>
<a name="ln583">        try</a>
<a name="ln584">        {</a>
<a name="ln585">            #region Try to get the process</a>
<a name="ln586"> </a>
<a name="ln587">            User32.GetWindowThreadProcessId(handle, out var id);</a>
<a name="ln588">            var target = Process.GetProcesses().FirstOrDefault(p =&gt; p.Id == id);</a>
<a name="ln589"> </a>
<a name="ln590">            #endregion</a>
<a name="ln591"> </a>
<a name="ln592">            if (target is { ProcessName: &quot;ScreenToGif&quot; })</a>
<a name="ln593">                return;</a>
<a name="ln594"> </a>
<a name="ln595">            //Clear up the selected window frame.</a>
<a name="ln596">            Native.Helpers.Other.DrawFrame(handle, scale);</a>
<a name="ln597">            _lastHandle = IntPtr.Zero;</a>
<a name="ln598"> </a>
<a name="ln599">            #region Values</a>
<a name="ln600"> </a>
<a name="ln601">            //TODO: Test values with other versions of windows.</a>
<a name="ln602">            var top = (rect.Y / scale) - Constants.TopOffset + 0;</a>
<a name="ln603">            var left = (rect.X / scale) - Constants.LeftOffset + 0;</a>
<a name="ln604">            var height = ((rect.Height + 1) / scale) + Constants.TopOffset + Constants.BottomOffset - 1;</a>
<a name="ln605">            var width = ((rect.Width + 1) / scale) + Constants.LeftOffset + Constants.RightOffset - 1;</a>
<a name="ln606"> </a>
<a name="ln607">            #endregion</a>
<a name="ln608"> </a>
<a name="ln609">            #region Validate</a>
<a name="ln610"> </a>
<a name="ln611">            if (top &lt; SystemParameters.VirtualScreenTop)</a>
<a name="ln612">                top = SystemParameters.VirtualScreenTop - 1;</a>
<a name="ln613">            if (left &lt; SystemParameters.VirtualScreenLeft)</a>
<a name="ln614">                left = SystemParameters.VirtualScreenLeft - 1;</a>
<a name="ln615">            if (SystemInformation.VirtualScreen.Height &lt; (height + top) * scale) //TODO: Check if works with 2 screens.</a>
<a name="ln616">                height = (SystemInformation.VirtualScreen.Height - top) / scale;</a>
<a name="ln617">            if (SystemInformation.VirtualScreen.Width &lt; (width + left) * scale)</a>
<a name="ln618">                width = (SystemInformation.VirtualScreen.Width - left) / scale;</a>
<a name="ln619"> </a>
<a name="ln620">            #endregion</a>
<a name="ln621"> </a>
<a name="ln622">            Top = top;</a>
<a name="ln623">            Left = left;</a>
<a name="ln624">            Height = height;</a>
<a name="ln625">            Width = width;</a>
<a name="ln626">        }</a>
<a name="ln627">        catch (Exception ex)</a>
<a name="ln628">        {</a>
<a name="ln629">            LogWriter.Log(ex, &quot;Error • Snap To Window&quot;);</a>
<a name="ln630">        }</a>
<a name="ln631">        finally</a>
<a name="ln632">        {</a>
<a name="ln633">            ReleaseMouseCapture();</a>
<a name="ln634">        }</a>
<a name="ln635"> </a>
<a name="ln636">        #endregion</a>
<a name="ln637">    }</a>
<a name="ln638"> </a>
<a name="ln639">    #endregion</a>
<a name="ln640"> </a>
<a name="ln641">    #region Timers</a>
<a name="ln642"> </a>
<a name="ln643">    private void PreStart_Elapsed(object sender, EventArgs e)</a>
<a name="ln644">    {</a>
<a name="ln645">        if (_preStartCount &gt;= 1)</a>
<a name="ln646">        {</a>
<a name="ln647">            Title = &quot;ScreenToGif - &quot; + LocalizationHelper.Get(&quot;S.Recorder.PreStarting&quot;);</a>
<a name="ln648">            DisplayTimer.SetElapsed(-_preStartCount);</a>
<a name="ln649">            Splash.SetTime(-_preStartCount);</a>
<a name="ln650">            _preStartCount--;</a>
<a name="ln651">            return;</a>
<a name="ln652">        }</a>
<a name="ln653"> </a>
<a name="ln654">        _preStartTimer.Stop();</a>
<a name="ln655">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln656">        IsRecording = true;</a>
<a name="ln657"> </a>
<a name="ln658">        StartCapture();</a>
<a name="ln659"> </a>
<a name="ln660">        Stage = RecorderStages.Recording;</a>
<a name="ln661">        AutoFitButtons();</a>
<a name="ln662"> </a>
<a name="ln663">        if (Arguments.StartCapture &amp;&amp; Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln664">            _limitTimer.Start();</a>
<a name="ln665">    }</a>
<a name="ln666"> </a>
<a name="ln667">    private void FollowTimer_Tick(object sender, EventArgs e)</a>
<a name="ln668">    {</a>
<a name="ln669">        if (WindowState != WindowState.Normal || _prevPosX == _posX &amp;&amp; _prevPosY == _posY || Stage == RecorderStages.Paused || Stage == RecorderStages.Stopped || Stage == RecorderStages.Discarding ||</a>
<a name="ln670">            (Keyboard.Modifiers != ModifierKeys.None &amp;&amp; Keyboard.Modifiers == UserSettings.All.DisableFollowModifiers))</a>
<a name="ln671">            return;</a>
<a name="ln672"> </a>
<a name="ln673">        _prevPosX = _posX;</a>
<a name="ln674">        _prevPosY = _posY;</a>
<a name="ln675"> </a>
<a name="ln676">        //TODO: Test with 2 monitors.</a>
<a name="ln677">        //if (isCentered)</a>
<a name="ln678">        //{</a>
<a name="ln679">        //    //Hide the UI.</a>
<a name="ln680">        //    _showBorderTimer.Stop();</a>
<a name="ln681">        //    BeginStoryboard(this.FindStoryboard(&quot;HideRectangleStoryboard&quot;), HandoffBehavior.SnapshotAndReplace);</a>
<a name="ln682">        //    _showBorderTimer.Start();</a>
<a name="ln683"> </a>
<a name="ln684">        //    //_offsetX = _posX - Region.Width / 2d;</a>
<a name="ln685">        //    //_offsetY = _posY - Region.Height / 2d;</a>
<a name="ln686"> </a>
<a name="ln687">        //    //Region = new Rect(new Point(_offsetX.Clamp(-1, Width - Region.Width + 1), _offsetY.Clamp(-1, Height - Region.Height + 1)), Region.Size);</a>
<a name="ln688">        //    //DashedRectangle.Refresh();</a>
<a name="ln689">        //}</a>
<a name="ln690">        //else</a>
<a name="ln691">        {</a>
<a name="ln692">            if (_width &lt; 1)</a>
<a name="ln693">                UpdateSize();</a>
<a name="ln694"> </a>
<a name="ln695">            //Only move to the left if 'Mouse.X &lt; Rect.L' and only move to the right if 'Mouse.X &gt; Rect.R'</a>
<a name="ln696">            _offsetX = _posX - UserSettings.All.FollowBuffer &lt; _left ? _posX - _left - UserSettings.All.FollowBuffer : _posX + UserSettings.All.FollowBuffer &gt; _left + _width ?</a>
<a name="ln697">                _posX - (_left + _width) + UserSettings.All.FollowBuffer : 0;</a>
<a name="ln698">            _offsetY = _posY - UserSettings.All.FollowBuffer &lt; _top ? _posY - _top - UserSettings.All.FollowBuffer : _posY + UserSettings.All.FollowBuffer &gt; _top + _height ?</a>
<a name="ln699">                _posY - (_top + _height) + UserSettings.All.FollowBuffer : 0;</a>
<a name="ln700"> </a>
<a name="ln701">            //Hide the UI when moving.</a>
<a name="ln702">            if (_posX - UserSettings.All.FollowBuffer - UserSettings.All.FollowBufferInvisible &lt; _left || _posX + UserSettings.All.FollowBuffer + UserSettings.All.FollowBufferInvisible &gt; _left + _width ||</a>
<a name="ln703">                _posY - UserSettings.All.FollowBuffer - UserSettings.All.FollowBufferInvisible &lt; _top || _posY + UserSettings.All.FollowBuffer + UserSettings.All.FollowBufferInvisible &gt; _top + _height)</a>
<a name="ln704">            {</a>
<a name="ln705">                _showBorderTimer.Stop();</a>
<a name="ln706">                HideInternals();</a>
<a name="ln707">                BeginStoryboard(this.FindStoryboard(&quot;HideWindowStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln708">                _showBorderTimer.Start();</a>
<a name="ln709">            }</a>
<a name="ln710"> </a>
<a name="ln711">            this.Refresh();</a>
<a name="ln712">        }</a>
<a name="ln713"> </a>
<a name="ln714">        //Rearrange the window.</a>
<a name="ln715">        Left = (Left + _offsetX / _scale).Clamp(0 - Constants.LeftOffset, SystemParameters.VirtualScreenWidth - Width + Constants.RightOffset);</a>
<a name="ln716">        Top = (Top + _offsetY / _scale).Clamp(0 - Constants.TopOffset, SystemParameters.VirtualScreenHeight - Height + Constants.BottomOffset);</a>
<a name="ln717">    }</a>
<a name="ln718"> </a>
<a name="ln719">    private void ShowBorderTimer_Tick(object sender, EventArgs e)</a>
<a name="ln720">    {</a>
<a name="ln721">        _showBorderTimer.Stop();</a>
<a name="ln722"> </a>
<a name="ln723">        this.Refresh();</a>
<a name="ln724">        ShowInternals();</a>
<a name="ln725"> </a>
<a name="ln726">        BeginStoryboard(this.FindStoryboard(&quot;ShowWindowStoryboard&quot;), HandoffBehavior.Compose);</a>
<a name="ln727">    }</a>
<a name="ln728"> </a>
<a name="ln729">    private async void Limit_Elapsed(object sender, EventArgs e)</a>
<a name="ln730">    {</a>
<a name="ln731">        _limitTimer.Stop();</a>
<a name="ln732"> </a>
<a name="ln733">        if (!IsLoaded || (Stage != RecorderStages.Recording &amp;&amp; Stage == RecorderStages.PreStarting))</a>
<a name="ln734">            return;</a>
<a name="ln735"> </a>
<a name="ln736">        await Stop();</a>
<a name="ln737">    }</a>
<a name="ln738"> </a>
<a name="ln739">    #endregion</a>
<a name="ln740"> </a>
<a name="ln741">    #region Methods</a>
<a name="ln742"> </a>
<a name="ln743">    private void RegisterCommands()</a>
<a name="ln744">    {</a>
<a name="ln745">        CommandBindings.Clear();</a>
<a name="ln746">        CommandBindings.AddRange(new CommandBindingCollection</a>
<a name="ln747">        {</a>
<a name="ln748">            new CommandBinding(_viewModel.CloseCommand, (_, _) =&gt; Close(),</a>
<a name="ln749">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Stopped || (UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction &amp;&amp; (Project == null || !Project.Any))),</a>
<a name="ln750"> </a>
<a name="ln751">            new CommandBinding(_viewModel.OptionsCommand, ShowOptions,</a>
<a name="ln752">                (_, args) =&gt; args.CanExecute = (Stage != RecorderStages.Recording || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction) &amp;&amp; Stage != RecorderStages.PreStarting),</a>
<a name="ln753"> </a>
<a name="ln754">            new CommandBinding(_viewModel.SnapToWindowCommand, null,</a>
<a name="ln755">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Stopped || (Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction &amp;&amp; (Project == null || Project.Frames.Count == 0))),</a>
<a name="ln756"> </a>
<a name="ln757">            new CommandBinding(_viewModel.SwitchFrequencyCommand, SwitchFrequency,</a>
<a name="ln758">                (_, args) =&gt;</a>
<a name="ln759">                {</a>
<a name="ln760">                    if (args.Parameter != null &amp;&amp; !args.Parameter.Equals(&quot;Switch&quot;))</a>
<a name="ln761">                    {</a>
<a name="ln762">                        args.CanExecute = true;</a>
<a name="ln763">                        return;</a>
<a name="ln764">                    }</a>
<a name="ln765"> </a>
<a name="ln766">                    args.CanExecute = ((Stage != RecorderStages.Recording || Project == null) || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction) &amp;&amp; Stage != RecorderStages.PreStarting;</a>
<a name="ln767">                }),</a>
<a name="ln768"> </a>
<a name="ln769">            new CommandBinding(_viewModel.RecordCommand, async (_, _) =&gt; await Record(),</a>
<a name="ln770">                (_, args) =&gt; args.CanExecute = Stage is RecorderStages.Stopped or RecorderStages.Paused &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual),</a>
<a name="ln771"> </a>
<a name="ln772">            new CommandBinding(_viewModel.PauseCommand, (_, _) =&gt; Pause(),</a>
<a name="ln773">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual),</a>
<a name="ln774"> </a>
<a name="ln775">            new CommandBinding(_viewModel.SnapCommand, async (_, _) =&gt; await Snap(),</a>
<a name="ln776">                (_, args) =&gt; args.CanExecute = Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual),</a>
<a name="ln777"> </a>
<a name="ln778">            new CommandBinding(_viewModel.StopLargeCommand, async (_, _) =&gt; await Stop(),</a>
<a name="ln779">                (_, args) =&gt; args.CanExecute = (Stage == RecorderStages.Recording &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Interaction &amp;&amp;</a>
<a name="ln780">                    !UserSettings.All.RecorderDisplayDiscard) || Stage == RecorderStages.PreStarting),</a>
<a name="ln781"> </a>
<a name="ln782">            new CommandBinding(_viewModel.StopCommand, async (_, _) =&gt; await Stop(),</a>
<a name="ln783">                (_, args) =&gt;</a>
<a name="ln784">                {</a>
<a name="ln785">                    args.CanExecute = Stage == RecorderStages.Recording &amp;&amp;</a>
<a name="ln786">                        ((UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual &amp;&amp; UserSettings.All.CaptureFrequency != CaptureFrequencies.Interaction &amp;&amp; !UserSettings.All.RecorderDisplayDiscard) || FrameCount &gt; 0) || Stage == RecorderStages.Paused;</a>
<a name="ln787">                }),</a>
<a name="ln788"> </a>
<a name="ln789">            new CommandBinding(_viewModel.DiscardCommand, async (_, _) =&gt; await Discard(),</a>
<a name="ln790">                (_, args) =&gt; args.CanExecute = (Stage == RecorderStages.Paused &amp;&amp; FrameCount &gt; 0) || (Stage == RecorderStages.Recording &amp;&amp; (UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction || UserSettings.All.RecorderDisplayDiscard) &amp;&amp; FrameCount &gt; 0)),</a>
<a name="ln791">        });</a>
<a name="ln792"> </a>
<a name="ln793">        _viewModel.RefreshKeyGestures();</a>
<a name="ln794">    }</a>
<a name="ln795"> </a>
<a name="ln796">    private void ShowOptions(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln797">    {</a>
<a name="ln798">        Topmost = false;</a>
<a name="ln799"> </a>
<a name="ln800">        var options = new Options(Options.RecorderIndex);</a>
<a name="ln801">        options.ShowDialog();</a>
<a name="ln802"> </a>
<a name="ln803">        DetectCaptureFrequency();</a>
<a name="ln804">        RegisterCommands();</a>
<a name="ln805">        DetectThinMode();</a>
<a name="ln806"> </a>
<a name="ln807">        //If not recording (or recording in manual/interactive mode, but with no frames captured yet), adjust the maximum bounds for the recorder.</a>
<a name="ln808">        if (Stage == RecorderStages.Stopped || ((UserSettings.All.CaptureFrequency == CaptureFrequencies.Manual || UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction) &amp;&amp; Stage == RecorderStages.Recording &amp;&amp; FrameCount == 0))</a>
<a name="ln809">            _viewModel.IsDirectMode = UserSettings.All.UseDesktopDuplication;</a>
<a name="ln810"> </a>
<a name="ln811">        Topmost = true;</a>
<a name="ln812">    }</a>
<a name="ln813"> </a>
<a name="ln814">    private void SwitchFrequency(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln815">    {</a>
<a name="ln816">        //When this event is fired from clicking on the switch button.</a>
<a name="ln817">        if (e.Parameter?.Equals(&quot;Switch&quot;) == true)</a>
<a name="ln818">        {</a>
<a name="ln819">            switch (UserSettings.All.CaptureFrequency)</a>
<a name="ln820">            {</a>
<a name="ln821">                case CaptureFrequencies.Manual:</a>
<a name="ln822">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.Interaction;</a>
<a name="ln823">                    break;</a>
<a name="ln824"> </a>
<a name="ln825">                case CaptureFrequencies.Interaction:</a>
<a name="ln826">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerSecond;</a>
<a name="ln827">                    break;</a>
<a name="ln828"> </a>
<a name="ln829">                case CaptureFrequencies.PerSecond:</a>
<a name="ln830">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerMinute;</a>
<a name="ln831">                    break;</a>
<a name="ln832"> </a>
<a name="ln833">                case CaptureFrequencies.PerMinute:</a>
<a name="ln834">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.PerHour;</a>
<a name="ln835">                    break;</a>
<a name="ln836"> </a>
<a name="ln837">                default: //PerHour.</a>
<a name="ln838">                    UserSettings.All.CaptureFrequency = CaptureFrequencies.Manual;</a>
<a name="ln839">                    break;</a>
<a name="ln840">            }</a>
<a name="ln841">        }</a>
<a name="ln842"> </a>
<a name="ln843">        //When event is fired when the frequency is picked from the context menu, just switch the labels.</a>
<a name="ln844">        DetectCaptureFrequency();</a>
<a name="ln845">        AutoFitButtons();</a>
<a name="ln846">    }</a>
<a name="ln847"> </a>
<a name="ln848">    /// &lt;summary&gt;</a>
<a name="ln849">    /// Method that starts or pauses the recording</a>
<a name="ln850">    /// &lt;/summary&gt;</a>
<a name="ln851">    internal async Task Record()</a>
<a name="ln852">    {</a>
<a name="ln853">        try</a>
<a name="ln854">        {</a>
<a name="ln855">            switch (Stage)</a>
<a name="ln856">            {</a>
<a name="ln857">                case RecorderStages.Stopped:</a>
<a name="ln858"> </a>
<a name="ln859">                    #region If interaction mode</a>
<a name="ln860"> </a>
<a name="ln861">                    if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln862">                    {</a>
<a name="ln863">                        Stage = RecorderStages.Recording;</a>
<a name="ln864">                        SetTaskbarButtonOverlay();</a>
<a name="ln865">                        return;</a>
<a name="ln866">                    }</a>
<a name="ln867"> </a>
<a name="ln868">                    #endregion</a>
<a name="ln869"> </a>
<a name="ln870">                    #region To record</a>
<a name="ln871"> </a>
<a name="ln872">                    Project = new ProjectInfo().CreateProjectFolder(ProjectByType.ScreenRecorder);</a>
<a name="ln873"> </a>
<a name="ln874">                    KeyList.Clear();</a>
<a name="ln875">                    FrameCount = 0;</a>
<a name="ln876"> </a>
<a name="ln877">                    await Task.Factory.StartNew(UpdateScreenDpi);</a>
<a name="ln878">                    await PrepareCapture();</a>
<a name="ln879">                    HideGuidelines();</a>
<a name="ln880"> </a>
<a name="ln881">                    HeightIntegerBox.IsEnabled = false;</a>
<a name="ln882">                    WidthIntegerBox.IsEnabled = false;</a>
<a name="ln883">                    FrequencyIntegerUpDown.IsEnabled = false;</a>
<a name="ln884"> </a>
<a name="ln885">                    IsRecording = true;</a>
<a name="ln886">                    Topmost = true;</a>
<a name="ln887"> </a>
<a name="ln888">                    #region Start</a>
<a name="ln889"> </a>
<a name="ln890">                    if (UserSettings.All.UsePreStart)</a>
<a name="ln891">                    {</a>
<a name="ln892">                        Stage = RecorderStages.PreStarting;</a>
<a name="ln893"> </a>
<a name="ln894">                        Title = $&quot;ScreenToGif ({LocalizationHelper.Get(&quot;S.Recorder.PreStart&quot;)} {UserSettings.All.PreStartValue}s)&quot;;</a>
<a name="ln895">                        DisplayTimer.SetElapsed(-UserSettings.All.PreStartValue);</a>
<a name="ln896"> </a>
<a name="ln897">                        _preStartCount = UserSettings.All.PreStartValue - 1;</a>
<a name="ln898">                        _preStartTimer.Start();</a>
<a name="ln899">                        return;</a>
<a name="ln900">                    }</a>
<a name="ln901"> </a>
<a name="ln902">                    StartCapture();</a>
<a name="ln903"> </a>
<a name="ln904">                    Stage = RecorderStages.Recording;</a>
<a name="ln905">                    AutoFitButtons();</a>
<a name="ln906">                    SetTaskbarButtonOverlay();</a>
<a name="ln907"> </a>
<a name="ln908">                    if (Arguments.StartCapture &amp;&amp; Arguments.Limit &gt; TimeSpan.Zero)</a>
<a name="ln909">                        _limitTimer.Start();</a>
<a name="ln910"> </a>
<a name="ln911">                    break;</a>
<a name="ln912"> </a>
<a name="ln913">                #endregion</a>
<a name="ln914"> </a>
<a name="ln915">                #endregion</a>
<a name="ln916"> </a>
<a name="ln917">                case RecorderStages.Paused:</a>
<a name="ln918"> </a>
<a name="ln919">                    #region To record again</a>
<a name="ln920"> </a>
<a name="ln921">                    Stage = RecorderStages.Recording;</a>
<a name="ln922">                    Title = &quot;ScreenToGif&quot;;</a>
<a name="ln923"> </a>
<a name="ln924">                    SetTaskbarButtonOverlay();</a>
<a name="ln925">                    await PrepareCapture(false);</a>
<a name="ln926">                    HideGuidelines();</a>
<a name="ln927">                    AutoFitButtons();</a>
<a name="ln928"> </a>
<a name="ln929">                    //If it's interaction mode, the capture is done via Snap().</a>
<a name="ln930">                    if (UserSettings.All.CaptureFrequency == CaptureFrequencies.Interaction)</a>
<a name="ln931">                        return;</a>
<a name="ln932"> </a>
<a name="ln933">                    FrequencyIntegerUpDown.IsEnabled = false;</a>
<a name="ln934"> </a>
<a name="ln935">                    StartCapture();</a>
<a name="ln936">                    break;</a>
<a name="ln937"> </a>
<a name="ln938">                #endregion</a>
<a name="ln939">            }</a>
<a name="ln940">        }</a>
<a name="ln941">        catch (GraphicsConfigurationException g)</a>
<a name="ln942">        {</a>
<a name="ln943">            LogWriter.Log(g, &quot;Impossible to start the recording due to wrong graphics adapter.&quot;);</a>
<a name="ln944">            GraphicsConfigurationDialog.Ok(g, _viewModel.CurrentMonitor);</a>
<a name="ln945">        }</a>
<a name="ln946">        catch (Exception e)</a>
<a name="ln947">        {</a>
<a name="ln948">            LogWriter.Log(e, &quot;Impossible to start the recording.&quot;);</a>
<a name="ln949">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.StartPauseNotPossible&quot;), e.Message, e);</a>
<a name="ln950">        }</a>
<a name="ln951">        finally</a>
<a name="ln952">        {</a>
<a name="ln953">            Arguments.ClearAutomationArgs();</a>
<a name="ln954"> </a>
<a name="ln955">            //Wait a bit, then refresh the commands. Some of the commands are dependent of the FrameCount property.</a>
<a name="ln956">            await Task.Delay(TimeSpan.FromMilliseconds(GetCaptureInterval() + 200));</a>
<a name="ln957"> </a>
<a name="ln958">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln959">        }</a>
<a name="ln960">    }</a>
<a name="ln961"> </a>
<a name="ln962">    /// &lt;summary&gt;</a>
<a name="ln963">    /// Capture a single frame.</a>
<a name="ln964">    /// &lt;/summary&gt;</a>
<a name="ln965">    private async Task Snap()</a>
<a name="ln966">    {</a>
<a name="ln967">        var snapTriggerDelay = GetTriggerDelay();</a>
<a name="ln968"> </a>
<a name="ln969">        if (snapTriggerDelay != 0)</a>
<a name="ln970">            await Task.Delay(snapTriggerDelay);</a>
<a name="ln971"> </a>
<a name="ln972">        HideGuidelines();</a>
<a name="ln973"> </a>
<a name="ln974">        if (Project == null || Project.Frames.Count == 0)</a>
<a name="ln975">        {</a>
<a name="ln976">            try</a>
<a name="ln977">            {</a>
<a name="ln978">                Project = new ProjectInfo().CreateProjectFolder(ProjectByType.ScreenRecorder);</a>
<a name="ln979"> </a>
<a name="ln980">                await PrepareCapture();</a>
<a name="ln981"> </a>
<a name="ln982">                IsRecording = true;</a>
<a name="ln983">            }</a>
<a name="ln984">            catch (Exception ex)</a>
<a name="ln985">            {</a>
<a name="ln986">                LogWriter.Log(ex, &quot;Impossible to start the screencasting.&quot;);</a>
<a name="ln987">                ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), ex.Message, ex);</a>
<a name="ln988">                return;</a>
<a name="ln989">            }</a>
<a name="ln990">        }</a>
<a name="ln991"> </a>
<a name="ln992">        #region Take the screenshot</a>
<a name="ln993"> </a>
<a name="ln994">        try</a>
<a name="ln995">        {</a>
<a name="ln996">            var limit = 0;</a>
<a name="ln997">            do</a>
<a name="ln998">            {</a>
<a name="ln999">                FrameCount = await Capture.ManualCaptureAsync(new FrameInfo(RecordClicked, KeyList), UserSettings.All.ShowCursor);</a>
<a name="ln1000"> </a>
<a name="ln1001">                if (limit &gt; 5)</a>
<a name="ln1002">                    throw new Exception(&quot;Impossible to capture the manual screenshot.&quot;);</a>
<a name="ln1003"> </a>
<a name="ln1004">                limit++;</a>
<a name="ln1005">            }</a>
<a name="ln1006">            while (FrameCount == 0);</a>
<a name="ln1007"> </a>
<a name="ln1008">            KeyList.Clear();</a>
<a name="ln1009"> </a>
<a name="ln1010">            DisplayTimer.ManuallyCapturedCount++;</a>
<a name="ln1011">            CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1012">        }</a>
<a name="ln1013">        catch (GraphicsConfigurationException g)</a>
<a name="ln1014">        {</a>
<a name="ln1015">            IsRecording = false;</a>
<a name="ln1016"> </a>
<a name="ln1017">            LogWriter.Log(g, &quot;Impossible to start the recording due to wrong graphics adapter.&quot;);</a>
<a name="ln1018">            GraphicsConfigurationDialog.Ok(g, _viewModel.CurrentMonitor);</a>
<a name="ln1019">        }</a>
<a name="ln1020">        catch (Exception e)</a>
<a name="ln1021">        {</a>
<a name="ln1022">            IsRecording = false;</a>
<a name="ln1023"> </a>
<a name="ln1024">            LogWriter.Log(e, &quot;Impossible to capture the manual screenshot.&quot;);</a>
<a name="ln1025">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible.Info&quot;), e);</a>
<a name="ln1026">        }</a>
<a name="ln1027"> </a>
<a name="ln1028">        #endregion</a>
<a name="ln1029">    }</a>
<a name="ln1030"> </a>
<a name="ln1031">    internal void Pause()</a>
<a name="ln1032">    {</a>
<a name="ln1033">        try</a>
<a name="ln1034">        {</a>
<a name="ln1035">            if (Stage != RecorderStages.Recording || UserSettings.All.CaptureFrequency is CaptureFrequencies.Manual or CaptureFrequencies.Interaction)</a>
<a name="ln1036">                return;</a>
<a name="ln1037"> </a>
<a name="ln1038">            Stage = RecorderStages.Paused;</a>
<a name="ln1039">            Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1040"> </a>
<a name="ln1041">            PauseCapture();</a>
<a name="ln1042">            _limitTimer.Stop();</a>
<a name="ln1043"> </a>
<a name="ln1044">            FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1045">            DisplayGuidelines();</a>
<a name="ln1046">            AutoFitButtons();</a>
<a name="ln1047">            SetTaskbarButtonOverlay();</a>
<a name="ln1048">        }</a>
<a name="ln1049">        catch (Exception e)</a>
<a name="ln1050">        {</a>
<a name="ln1051">            LogWriter.Log(e, &quot;Impossible to pause the recording.&quot;);</a>
<a name="ln1052">            ErrorDialog.Ok(Title, LocalizationHelper.Get(&quot;S.Recorder.Warning.StartPauseNotPossible&quot;), e.Message, e);</a>
<a name="ln1053">        }</a>
<a name="ln1054">    }</a>
<a name="ln1055"> </a>
<a name="ln1056">    /// &lt;summary&gt;</a>
<a name="ln1057">    /// Stops the recording or the Pre-Start countdown.</a>
<a name="ln1058">    /// &lt;/summary&gt;</a>
<a name="ln1059">    private async Task Stop()</a>
<a name="ln1060">    {</a>
<a name="ln1061">        try</a>
<a name="ln1062">        {</a>
<a name="ln1063">            ControlStackPanel.IsEnabled = false;</a>
<a name="ln1064">            Title = &quot;ScreenToGif - &quot; + LocalizationHelper.Get(&quot;S.Recorder.Stopping&quot;);</a>
<a name="ln1065">            Cursor = Cursors.AppStarting;</a>
<a name="ln1066"> </a>
<a name="ln1067">            _limitTimer.Stop();</a>
<a name="ln1068">            await StopCapture();</a>
<a name="ln1069"> </a>
<a name="ln1070">            if (Stage is RecorderStages.Recording or RecorderStages.Paused &amp;&amp; Project?.Any == true)</a>
<a name="ln1071">            {</a>
<a name="ln1072">                #region Finishes if it's recording and it has any frames</a>
<a name="ln1073"> </a>
<a name="ln1074">                await Task.Delay(100);</a>
<a name="ln1075"> </a>
<a name="ln1076">                Close();</a>
<a name="ln1077">                return;</a>
<a name="ln1078"> </a>
<a name="ln1079">                #endregion</a>
<a name="ln1080">            }</a>
<a name="ln1081"> </a>
<a name="ln1082">            #region Stops if it is not recording, or has no frames</a>
<a name="ln1083"> </a>
<a name="ln1084">            //Stop the pre-start timer to kill pre-start warming up.</a>
<a name="ln1085">            if (Stage == RecorderStages.PreStarting)</a>
<a name="ln1086">                _preStartTimer.Stop();</a>
<a name="ln1087"> </a>
<a name="ln1088">            Stage = RecorderStages.Stopped;</a>
<a name="ln1089"> </a>
<a name="ln1090">            //Enables the controls that are disabled while recording;</a>
<a name="ln1091">            FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1092">            ControlStackPanel.IsEnabled = true;</a>
<a name="ln1093">            HeightIntegerBox.IsEnabled = true;</a>
<a name="ln1094">            WidthIntegerBox.IsEnabled = true;</a>
<a name="ln1095"> </a>
<a name="ln1096">            IsRecording = false;</a>
<a name="ln1097">            Topmost = true;</a>
<a name="ln1098"> </a>
<a name="ln1099">            AutoFitButtons();</a>
<a name="ln1100">            DisplayGuidelines();</a>
<a name="ln1101">            SetTaskbarButtonOverlay();</a>
<a name="ln1102"> </a>
<a name="ln1103">            #endregion</a>
<a name="ln1104">        }</a>
<a name="ln1105">        catch (Exception ex)</a>
<a name="ln1106">        {</a>
<a name="ln1107">            LogWriter.Log(ex, &quot;Error on the Stop function&quot;);</a>
<a name="ln1108"> </a>
<a name="ln1109">            ErrorDialog.Ok(&quot;ScreenToGif&quot;, &quot;Error while stopping&quot;, ex.Message, ex);</a>
<a name="ln1110">        }</a>
<a name="ln1111">        finally</a>
<a name="ln1112">        {</a>
<a name="ln1113">            if (IsLoaded)</a>
<a name="ln1114">            {</a>
<a name="ln1115">                Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1116">                Cursor = Cursors.Arrow;</a>
<a name="ln1117">                ControlStackPanel.IsEnabled = true;</a>
<a name="ln1118">            }</a>
<a name="ln1119">        }</a>
<a name="ln1120">    }</a>
<a name="ln1121"> </a>
<a name="ln1122">    private async Task Discard()</a>
<a name="ln1123">    {</a>
<a name="ln1124">        Pause();</a>
<a name="ln1125"> </a>
<a name="ln1126">        if (UserSettings.All.NotifyRecordingDiscard &amp;&amp; !Dialog.Ask(LocalizationHelper.Get(&quot;S.Recorder.Discard.Title&quot;),</a>
<a name="ln1127">                LocalizationHelper.Get(&quot;S.Recorder.Discard.Instruction&quot;), LocalizationHelper.Get(&quot;S.Recorder.Discard.Message&quot;), false))</a>
<a name="ln1128">            return;</a>
<a name="ln1129"> </a>
<a name="ln1130">        await StopCapture();</a>
<a name="ln1131"> </a>
<a name="ln1132">        FrameCount = 0;</a>
<a name="ln1133">        Stage = RecorderStages.Discarding;</a>
<a name="ln1134">        OutterGrid.IsEnabled = false;</a>
<a name="ln1135">        Cursor = Cursors.AppStarting;</a>
<a name="ln1136">        SetTaskbarButtonOverlay();</a>
<a name="ln1137"> </a>
<a name="ln1138">        await Task.Run(() =&gt;</a>
<a name="ln1139">        {</a>
<a name="ln1140">            try</a>
<a name="ln1141">            {</a>
<a name="ln1142">                #region Remove all the files</a>
<a name="ln1143"> </a>
<a name="ln1144">                //Not sure if needed.</a>
<a name="ln1145">                foreach (var frame in Project.Frames)</a>
<a name="ln1146">                {</a>
<a name="ln1147">                    try</a>
<a name="ln1148">                    {</a>
<a name="ln1149">                        if (File.Exists(frame.Path))</a>
<a name="ln1150">                            File.Delete(frame.Path);</a>
<a name="ln1151">                    }</a>
<a name="ln1152">                    catch (Exception)</a>
<a name="ln1153">                    { }</a>
<a name="ln1154">                }</a>
<a name="ln1155"> </a>
<a name="ln1156">                try</a>
<a name="ln1157">                {</a>
<a name="ln1158">                    Directory.Delete(Project.FullPath, true);</a>
<a name="ln1159">                }</a>
<a name="ln1160">                catch (Exception ex)</a>
<a name="ln1161">                {</a>
<a name="ln1162">                    LogWriter.Log(ex, &quot;Delete temp path&quot;);</a>
<a name="ln1163">                }</a>
<a name="ln1164"> </a>
<a name="ln1165">                #endregion</a>
<a name="ln1166"> </a>
<a name="ln1167">                Project.Frames.Clear();</a>
<a name="ln1168">            }</a>
<a name="ln1169">            catch (IOException io)</a>
<a name="ln1170">            {</a>
<a name="ln1171">                LogWriter.Log(io, &quot;Error while trying to discard the recording&quot;);</a>
<a name="ln1172">            }</a>
<a name="ln1173">            catch (Exception ex)</a>
<a name="ln1174">            {</a>
<a name="ln1175">                Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Discard Error&quot;, &quot;Error while trying to discard the recording&quot;, ex.Message));</a>
<a name="ln1176">                LogWriter.Log(ex, &quot;Error while trying to discard the recording&quot;);</a>
<a name="ln1177">            }</a>
<a name="ln1178">        });</a>
<a name="ln1179"> </a>
<a name="ln1180">        //Enables the controls that are disabled while recording;</a>
<a name="ln1181">        FrequencyIntegerUpDown.IsEnabled = true;</a>
<a name="ln1182">        HeightIntegerBox.IsEnabled = true;</a>
<a name="ln1183">        WidthIntegerBox.IsEnabled = true;</a>
<a name="ln1184">        OutterGrid.IsEnabled = true;</a>
<a name="ln1185"> </a>
<a name="ln1186">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1187">        Cursor = Cursors.Arrow;</a>
<a name="ln1188">        IsRecording = false;</a>
<a name="ln1189"> </a>
<a name="ln1190">        DetectCaptureFrequency();</a>
<a name="ln1191">        AutoFitButtons();</a>
<a name="ln1192">        SetTaskbarButtonOverlay();</a>
<a name="ln1193">    }</a>
<a name="ln1194"> </a>
<a name="ln1195">    /// &lt;summary&gt;</a>
<a name="ln1196">    /// Changes the way that the Record and Stop buttons are shown.</a>
<a name="ln1197">    /// &lt;/summary&gt;</a>
<a name="ln1198">    private void AutoFitButtons(bool force = false)</a>
<a name="ln1199">    {</a>
<a name="ln1200">        if (LowerGrid.ActualWidth &lt; 360)</a>
<a name="ln1201">        {</a>
<a name="ln1202">            if (MinimizeVisibility == Visibility.Collapsed &amp;&amp; !force)</a>
<a name="ln1203">                return;</a>
<a name="ln1204"> </a>
<a name="ln1205">            _viewModel.ButtonStyle = (Style)FindResource(&quot;Style.Button.NoText&quot;);</a>
<a name="ln1206"> </a>
<a name="ln1207">            MinimizeVisibility = Visibility.Collapsed;</a>
<a name="ln1208"> </a>
<a name="ln1209">            if (IsThin)</a>
<a name="ln1210">                CaptionText.Visibility = Visibility.Collapsed;</a>
<a name="ln1211">        }</a>
<a name="ln1212">        else</a>
<a name="ln1213">        {</a>
<a name="ln1214">            if (MinimizeVisibility == Visibility.Visible &amp;&amp; !force)</a>
<a name="ln1215">                return;</a>
<a name="ln1216"> </a>
<a name="ln1217">            _viewModel.ButtonStyle = (Style)FindResource(&quot;Style.Button.Horizontal&quot;);</a>
<a name="ln1218"> </a>
<a name="ln1219">            MinimizeVisibility = Visibility.Visible;</a>
<a name="ln1220"> </a>
<a name="ln1221">            if (IsThin)</a>
<a name="ln1222">                CaptionText.Visibility = Visibility.Visible;</a>
<a name="ln1223">        }</a>
<a name="ln1224">    }</a>
<a name="ln1225"> </a>
<a name="ln1226"> </a>
<a name="ln1227">    private void UpdateScreenDpi()</a>
<a name="ln1228">    {</a>
<a name="ln1229">        try</a>
<a name="ln1230">        {</a>
<a name="ln1231">            var source = Dispatcher.Invoke(() =&gt; PresentationSource.FromVisual(this));</a>
<a name="ln1232"> </a>
<a name="ln1233">            if (source?.CompositionTarget != null)</a>
<a name="ln1234">                _scale = Dispatcher.Invoke(() =&gt; source.CompositionTarget.TransformToDevice.M11);</a>
<a name="ln1235"> </a>
<a name="ln1236">            Dispatcher.Invoke(() =&gt;</a>
<a name="ln1237">            {</a>
<a name="ln1238">                if (_viewModel.Monitors?.Any() == true)</a>
<a name="ln1239">                {</a>
<a name="ln1240">                    UpdateSize();</a>
<a name="ln1241">                    UpdateLocation();</a>
<a name="ln1242">                }</a>
<a name="ln1243"> </a>
<a name="ln1244">                WidthIntegerBox.Scale = _scale;</a>
<a name="ln1245">                HeightIntegerBox.Scale = _scale;</a>
<a name="ln1246">            });</a>
<a name="ln1247">        }</a>
<a name="ln1248">        finally</a>
<a name="ln1249">        {</a>
<a name="ln1250">            GC.Collect(1);</a>
<a name="ln1251">        }</a>
<a name="ln1252">    }</a>
<a name="ln1253"> </a>
<a name="ln1254">    private void UpdateSize()</a>
<a name="ln1255">    {</a>
<a name="ln1256">        //If minimized, assume that the position is the same.</a>
<a name="ln1257">        if (WindowState != WindowState.Minimized)</a>
<a name="ln1258">        {</a>
<a name="ln1259">            _width = (int)Math.Round((Width - Constants.HorizontalOffset) * _scale);</a>
<a name="ln1260">            _height = (int)Math.Round((Height - Constants.VerticalOffset) * _scale);</a>
<a name="ln1261">        }</a>
<a name="ln1262"> </a>
<a name="ln1263">        _viewModel.Region = new Rect(_viewModel.Region.TopLeft, new Size(_width, _height));</a>
<a name="ln1264"> </a>
<a name="ln1265">        if (Capture != null)</a>
<a name="ln1266">        {</a>
<a name="ln1267">            Capture.Width = _width;</a>
<a name="ln1268">            Capture.Height = _height;</a>
<a name="ln1269">        }</a>
<a name="ln1270"> </a>
<a name="ln1271">        DetectMonitorChanges(true);</a>
<a name="ln1272">    }</a>
<a name="ln1273"> </a>
<a name="ln1274">    private void UpdateLocation()</a>
<a name="ln1275">    {</a>
<a name="ln1276">        UserSettings.All.RecorderLeft = _left = (int)Math.Round((Math.Round(Left, MidpointRounding.AwayFromZero) + Constants.LeftOffset) * _scale);</a>
<a name="ln1277">        UserSettings.All.RecorderTop = _top = (int)Math.Round((Math.Round(Top, MidpointRounding.AwayFromZero) + Constants.TopOffset) * _scale);</a>
<a name="ln1278"> </a>
<a name="ln1279">        _viewModel.Region = new Rect(new Point(_left, _top), _viewModel.Region.BottomRight);</a>
<a name="ln1280"> </a>
<a name="ln1281">        if (Capture == null)</a>
<a name="ln1282">            return;</a>
<a name="ln1283"> </a>
<a name="ln1284">        Capture.Left = _left;</a>
<a name="ln1285">        Capture.Top = _top;</a>
<a name="ln1286"> </a>
<a name="ln1287">        DetectMonitorChanges(true);</a>
<a name="ln1288">    }</a>
<a name="ln1289"> </a>
<a name="ln1290">    private async void DetectMonitorChanges(bool detectCurrent = false)</a>
<a name="ln1291">    {</a>
<a name="ln1292">        if (detectCurrent)</a>
<a name="ln1293">        {</a>
<a name="ln1294">            var interop = new System.Windows.Interop.WindowInteropHelper(this);</a>
<a name="ln1295">            var current = Screen.FromHandle(interop.Handle);</a>
<a name="ln1296"> </a>
<a name="ln1297">            _viewModel.CurrentMonitor = _viewModel.Monitors.FirstOrDefault(f =&gt; f.Name == current.DeviceName);</a>
<a name="ln1298">        }</a>
<a name="ln1299"> </a>
<a name="ln1300">        if (_viewModel.CurrentMonitor != null &amp;&amp; _viewModel.CurrentMonitor.Handle != _viewModel.PreviousMonitor?.Handle)</a>
<a name="ln1301">        {</a>
<a name="ln1302">            if (_viewModel.PreviousMonitor != null &amp;&amp; Stage == RecorderStages.Recording &amp;&amp; Project?.Any == true)</a>
<a name="ln1303">            {</a>
<a name="ln1304">                Pause();</a>
<a name="ln1305"> </a>
<a name="ln1306">                Capture.DeviceName = _viewModel.CurrentMonitor.Name;</a>
<a name="ln1307">                Capture?.ResetConfiguration();</a>
<a name="ln1308"> </a>
<a name="ln1309">                await Record();</a>
<a name="ln1310">            }</a>
<a name="ln1311"> </a>
<a name="ln1312">            _viewModel.PreviousMonitor = _viewModel.CurrentMonitor;</a>
<a name="ln1313">        }</a>
<a name="ln1314">    }</a>
<a name="ln1315"> </a>
<a name="ln1316">    private bool UpdatePositioning2(bool startup = false)</a>
<a name="ln1317">    {</a>
<a name="ln1318">        try</a>
<a name="ln1319">        {</a>
<a name="ln1320">            var top = UserSettings.All.RecorderTop;</a>
<a name="ln1321">            var left = UserSettings.All.RecorderLeft;</a>
<a name="ln1322"> </a>
<a name="ln1323">            //If the position was never set.</a>
<a name="ln1324">            if (double.IsNaN(top) || double.IsNaN(left))</a>
<a name="ln1325">            {</a>
<a name="ln1326">                //Let it center on screen when the window is loading.</a>
<a name="ln1327">                if (startup)</a>
<a name="ln1328">                    return false;</a>
<a name="ln1329"> </a>
<a name="ln1330">                //Let the code below decide where to position the screen.</a>
<a name="ln1331">                top = 0;</a>
<a name="ln1332">                left = 0;</a>
<a name="ln1333">            }</a>
<a name="ln1334"> </a>
<a name="ln1335">            //The catch here is to get the closest monitor from current Top/Left point.</a>
<a name="ln1336">            var monitors = MonitorHelper.AllMonitorsGranular();</a>
<a name="ln1337">            var closest = monitors.FirstOrDefault(x =&gt; x.Bounds.Contains(new Point((int)left, (int)top))) ?? monitors.FirstOrDefault(x =&gt; x.IsPrimary) ?? monitors.FirstOrDefault();</a>
<a name="ln1338"> </a>
<a name="ln1339">            if (closest == null)</a>
<a name="ln1340">                return false;</a>
<a name="ln1341"> </a>
<a name="ln1342">            //To much to the Left.</a>
<a name="ln1343">            if (closest.WorkingArea.Left &gt; UserSettings.All.RecorderLeft + UserSettings.All.RecorderWidth - 100)</a>
<a name="ln1344">                left = closest.WorkingArea.Left;</a>
<a name="ln1345"> </a>
<a name="ln1346">            //Too much to the top.</a>
<a name="ln1347">            if (closest.WorkingArea.Top &gt; UserSettings.All.RecorderTop + UserSettings.All.RecorderHeight - 100)</a>
<a name="ln1348">                top = closest.WorkingArea.Top;</a>
<a name="ln1349"> </a>
<a name="ln1350">            //Too much to the right.</a>
<a name="ln1351">            if (closest.WorkingArea.Right &lt; UserSettings.All.RecorderLeft + 100)</a>
<a name="ln1352">                left = closest.WorkingArea.Right - UserSettings.All.RecorderWidth;</a>
<a name="ln1353"> </a>
<a name="ln1354">            //Too much to the bottom.</a>
<a name="ln1355">            if (closest.WorkingArea.Bottom &lt; UserSettings.All.RecorderTop + 100)</a>
<a name="ln1356">                top = closest.WorkingArea.Bottom - UserSettings.All.RecorderHeight;</a>
<a name="ln1357"> </a>
<a name="ln1358">            Top = UserSettings.All.RecorderTop = top;</a>
<a name="ln1359">            Left = UserSettings.All.RecorderLeft = left;</a>
<a name="ln1360"> </a>
<a name="ln1361">            return true;</a>
<a name="ln1362">        }</a>
<a name="ln1363">        catch (Exception e)</a>
<a name="ln1364">        {</a>
<a name="ln1365">            LogWriter.Log(e, &quot;Impossible to position the recorder window.&quot;);</a>
<a name="ln1366">            return false;</a>
<a name="ln1367">        }</a>
<a name="ln1368">        finally</a>
<a name="ln1369">        {</a>
<a name="ln1370">            DetectMonitorChanges(true);</a>
<a name="ln1371">        }</a>
<a name="ln1372">    }</a>
<a name="ln1373"> </a>
<a name="ln1374">    private async Task UpdatePositioning(bool startup = false)</a>
<a name="ln1375">    {</a>
<a name="ln1376">        if (!startup)</a>
<a name="ln1377">        {</a>
<a name="ln1378">            switch (Stage)</a>
<a name="ln1379">            {</a>
<a name="ln1380">                case RecorderStages.PreStarting:</a>
<a name="ln1381">                {</a>
<a name="ln1382">                    await Stop();</a>
<a name="ln1383">                    break;</a>
<a name="ln1384">                }</a>
<a name="ln1385">                case RecorderStages.Recording:</a>
<a name="ln1386">                {</a>
<a name="ln1387">                    if (UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual)</a>
<a name="ln1388">                        Pause();</a>
<a name="ln1389"> </a>
<a name="ln1390">                    break;</a>
<a name="ln1391">                }</a>
<a name="ln1392">            }</a>
<a name="ln1393">        }</a>
<a name="ln1394">        else</a>
<a name="ln1395">        {</a>
<a name="ln1396">            //The user can opt out of the using the previous position and size.</a>
<a name="ln1397">            if (!UserSettings.All.RecorderRememberPosition)</a>
<a name="ln1398">            {</a>
<a name="ln1399">                UserSettings.All.RecorderLeft = double.NaN;</a>
<a name="ln1400">                UserSettings.All.RecorderTop = double.NaN;</a>
<a name="ln1401"> </a>
<a name="ln1402">                if (!UserSettings.All.RecorderRememberSize)</a>
<a name="ln1403">                {</a>
<a name="ln1404">                    UserSettings.All.RecorderWidth = 518;</a>
<a name="ln1405">                    UserSettings.All.RecorderHeight = 269;</a>
<a name="ln1406">                }</a>
<a name="ln1407">            }</a>
<a name="ln1408"> </a>
<a name="ln1409">            //Command line arguments were sent.</a>
<a name="ln1410">            if (Arguments.Region != Rect.Empty)</a>
<a name="ln1411">            {</a>
<a name="ln1412">                UserSettings.All.RecorderLeft = Arguments.Region.Left - Constants.LeftOffset;</a>
<a name="ln1413">                UserSettings.All.RecorderTop = Arguments.Region.Top - Constants.TopOffset;</a>
<a name="ln1414">                UserSettings.All.RecorderWidth = (int)Arguments.Region.Width + Constants.HorizontalOffset;</a>
<a name="ln1415">                UserSettings.All.RecorderHeight = (int)Arguments.Region.Height + Constants.VerticalOffset;</a>
<a name="ln1416">                Arguments.Region = Rect.Empty;</a>
<a name="ln1417">            }</a>
<a name="ln1418">        }</a>
<a name="ln1419"> </a>
<a name="ln1420">        //Since the list of monitors could have been changed, it needs to be queried again.</a>
<a name="ln1421">        _viewModel.Monitors = MonitorHelper.AllMonitorsGranular();</a>
<a name="ln1422"> </a>
<a name="ln1423">        //Detect closest screen to the point (previously selected top/left point or current mouse coordinate).</a>
<a name="ln1424">        var point = startup ? (double.IsNaN(UserSettings.All.RecorderTop) || double.IsNaN(UserSettings.All.RecorderLeft) ?</a>
<a name="ln1425">            Native.Helpers.Other.GetMousePosition(_scale, Left, Top) : new Point((int)UserSettings.All.RecorderLeft, (int)UserSettings.All.RecorderTop)) : new Point((int) Left, (int) Top);</a>
<a name="ln1426">        var closest = _viewModel.Monitors.FirstOrDefault(x =&gt; x.Bounds.Contains(point)) ?? _viewModel.Monitors.FirstOrDefault(x =&gt; x.IsPrimary) ?? _viewModel.Monitors.FirstOrDefault();</a>
<a name="ln1427"> </a>
<a name="ln1428">        if (closest == null)</a>
<a name="ln1429">            throw new Exception(&quot;It was not possible to get a list of known screens.&quot;);</a>
<a name="ln1430"> </a>
<a name="ln1431">        //Move the window to the correct location.</a>
<a name="ln1432">        var left = UserSettings.All.RecorderLeft;</a>
<a name="ln1433">        var top = UserSettings.All.RecorderTop;</a>
<a name="ln1434"> </a>
<a name="ln1435">        if (double.IsNaN(UserSettings.All.RecorderTop) || double.IsNaN(UserSettings.All.RecorderLeft))</a>
<a name="ln1436">        {</a>
<a name="ln1437">            left = closest.WorkingArea.Left + closest.WorkingArea.Width / 2d - ActualWidth / 2d;</a>
<a name="ln1438">            top = closest.WorkingArea.Top + closest.WorkingArea.Height / 2d - ActualHeight / 2d;</a>
<a name="ln1439">        }</a>
<a name="ln1440">        else</a>
<a name="ln1441">        {</a>
<a name="ln1442">            //To much to the Left.</a>
<a name="ln1443">            if (closest.WorkingArea.Left &gt; UserSettings.All.RecorderLeft + UserSettings.All.RecorderWidth - 100)</a>
<a name="ln1444">                left = closest.WorkingArea.Left;</a>
<a name="ln1445"> </a>
<a name="ln1446">            //Too much to the top.</a>
<a name="ln1447">            if (closest.WorkingArea.Top &gt; UserSettings.All.RecorderTop + UserSettings.All.RecorderHeight - 100)</a>
<a name="ln1448">                top = closest.WorkingArea.Top;</a>
<a name="ln1449"> </a>
<a name="ln1450">            //Too much to the right.</a>
<a name="ln1451">            if (closest.WorkingArea.Right &lt; UserSettings.All.RecorderLeft + 100)</a>
<a name="ln1452">                left = closest.WorkingArea.Right - UserSettings.All.RecorderWidth;</a>
<a name="ln1453"> </a>
<a name="ln1454">            //Too much to the bottom.</a>
<a name="ln1455">            if (closest.WorkingArea.Bottom &lt; UserSettings.All.RecorderTop + 100)</a>
<a name="ln1456">                top = closest.WorkingArea.Bottom - UserSettings.All.RecorderHeight;</a>
<a name="ln1457">        }</a>
<a name="ln1458"> </a>
<a name="ln1459">        Top = closest.NativeBounds.Top + 1;</a>
<a name="ln1460">        Left = closest.NativeBounds.Left + 1;</a>
<a name="ln1461"> </a>
<a name="ln1462">        var diff = this.Scale() / closest.Scale;</a>
<a name="ln1463">        Top = UserSettings.All.RecorderTop = top / diff;</a>
<a name="ln1464">        Left = UserSettings.All.RecorderLeft = left / diff;</a>
<a name="ln1465">        Height = UserSettings.All.RecorderHeight;</a>
<a name="ln1466">        Width = UserSettings.All.RecorderWidth;</a>
<a name="ln1467"> </a>
<a name="ln1468">        //After moving, detect the current monitor using a more reliable method.</a>
<a name="ln1469">        var windowInteropHelper = new System.Windows.Interop.WindowInteropHelper(this);</a>
<a name="ln1470">        var current = Screen.FromHandle(windowInteropHelper.Handle);</a>
<a name="ln1471"> </a>
<a name="ln1472">        _viewModel.CurrentMonitor =  _viewModel.Monitors.FirstOrDefault(f =&gt; f.Name == current.DeviceName) ?? closest;</a>
<a name="ln1473"> </a>
<a name="ln1474">        var regionLeft = (int)Math.Round((Math.Round(Left, MidpointRounding.AwayFromZero) + Constants.LeftOffset) * _viewModel.CurrentMonitor.Scale);</a>
<a name="ln1475">        var regionTop = (int)Math.Round((Math.Round(Top, MidpointRounding.AwayFromZero) + Constants.TopOffset) * _viewModel.CurrentMonitor.Scale);</a>
<a name="ln1476">        var regionWidth = (int)Math.Round((UserSettings.All.RecorderWidth - Constants.HorizontalOffset) * _viewModel.CurrentMonitor.Scale);</a>
<a name="ln1477">        var regionHeight = (int)Math.Round((UserSettings.All.RecorderHeight - Constants.VerticalOffset) * _viewModel.CurrentMonitor.Scale);</a>
<a name="ln1478"> </a>
<a name="ln1479">        if (regionWidth &lt; 0 || regionHeight &lt; 0)</a>
<a name="ln1480">        {</a>
<a name="ln1481">            var desc = $&quot;Scale: {this.Scale()}\n\nScreen: {closest.AdapterName}\nBounds: {closest.Bounds}\n\nTopLeft: {top}x{left}\nWidthHeight: {regionWidth}x{regionHeight}&quot;;</a>
<a name="ln1482"> </a>
<a name="ln1483">            LogWriter.Log(&quot;Wrong recorder window sizing&quot;, desc);</a>
<a name="ln1484"> </a>
<a name="ln1485">            Height = UserSettings.All.RecorderHeight = 500;</a>
<a name="ln1486">            Width = UserSettings.All.RecorderWidth = 250;</a>
<a name="ln1487">            return;</a>
<a name="ln1488">        }</a>
<a name="ln1489"> </a>
<a name="ln1490">        _viewModel.Region = new Rect(regionLeft, regionTop, regionWidth, regionHeight);</a>
<a name="ln1491">    }</a>
<a name="ln1492"> </a>
<a name="ln1493">    internal override void OnFollowingChanged()</a>
<a name="ln1494">    {</a>
<a name="ln1495">        Follow();</a>
<a name="ln1496"> </a>
<a name="ln1497">        base.OnFollowingChanged();</a>
<a name="ln1498">    }</a>
<a name="ln1499"> </a>
<a name="ln1500">    private void Follow()</a>
<a name="ln1501">    {</a>
<a name="ln1502">        if (IsFollowing &amp;&amp; UserSettings.All.FollowShortcut != Key.None)</a>
<a name="ln1503">        {</a>
<a name="ln1504">            _followTimer.Interval = (1000 / UserSettings.All.LatestFps) / 2;</a>
<a name="ln1505">            _followTimer.Start();</a>
<a name="ln1506">            return;</a>
<a name="ln1507">        }</a>
<a name="ln1508"> </a>
<a name="ln1509">        _followTimer.Stop();</a>
<a name="ln1510">    }</a>
<a name="ln1511"> </a>
<a name="ln1512">    private async Task PrepareCapture(bool isNew = true)</a>
<a name="ln1513">    {</a>
<a name="ln1514">        if (isNew &amp;&amp; Capture != null)</a>
<a name="ln1515">        {</a>
<a name="ln1516">            await Capture.DisposeAsync();</a>
<a name="ln1517">            Capture = null;</a>
<a name="ln1518">        }</a>
<a name="ln1519"> </a>
<a name="ln1520">        //If the capture helper was initialized already, ignore this.</a>
<a name="ln1521">        if (Capture != null)</a>
<a name="ln1522">            return;</a>
<a name="ln1523"> </a>
<a name="ln1524">        if (UserSettings.All.UseDesktopDuplication)</a>
<a name="ln1525">        {</a>
<a name="ln1526">            //Check if Windows 8 or newer.</a>
<a name="ln1527">            if (!OperationalSystemHelper.IsWin8OrHigher())</a>
<a name="ln1528">                throw new Exception(LocalizationHelper.Get(&quot;S.Recorder.Warning.Windows8&quot;));</a>
<a name="ln1529"> </a>
<a name="ln1530">            Capture = GetDirectCapture();</a>
<a name="ln1531">            Capture.DeviceName = _viewModel.CurrentMonitor.Name;</a>
<a name="ln1532">            _viewModel.IsDirectMode = true;</a>
<a name="ln1533">        }</a>
<a name="ln1534">        else</a>
<a name="ln1535">        {</a>
<a name="ln1536">            //Capture with BitBlt.</a>
<a name="ln1537">            Capture = UserSettings.All.UseMemoryCache ? new CachedCapture() : new ImageCapture();</a>
<a name="ln1538">            _viewModel.IsDirectMode = true;</a>
<a name="ln1539">        }</a>
<a name="ln1540"> </a>
<a name="ln1541">        Capture.OnError += exception =&gt;</a>
<a name="ln1542">        {</a>
<a name="ln1543">            Dispatcher?.Invoke(() =&gt;</a>
<a name="ln1544">            {</a>
<a name="ln1545">                //Pause the recording and show the error.</a>
<a name="ln1546">                Pause();</a>
<a name="ln1547"> </a>
<a name="ln1548">                if (exception is GraphicsConfigurationException)</a>
<a name="ln1549">                    GraphicsConfigurationDialog.Ok(exception, _viewModel.CurrentMonitor);</a>
<a name="ln1550">                else</a>
<a name="ln1551">                    ErrorDialog.Ok(&quot;ScreenToGif&quot;, LocalizationHelper.Get(&quot;S.Recorder.Warning.CaptureNotPossible&quot;), exception.Message, exception);</a>
<a name="ln1552"> </a>
<a name="ln1553">                Capture.Dispose();</a>
<a name="ln1554">                Capture = null;</a>
<a name="ln1555">            });</a>
<a name="ln1556">        };</a>
<a name="ln1557"> </a>
<a name="ln1558">        var dpi = MonitorHelper.AllMonitors.FirstOrDefault(f =&gt; f.IsPrimary)?.Dpi ?? 96d;</a>
<a name="ln1559"> </a>
<a name="ln1560">        Capture.Start(GetCaptureInterval(), _left, _top, _width, _height, dpi / 96d, Project);</a>
<a name="ln1561">    }</a>
<a name="ln1562"> </a>
<a name="ln1563">    private void DetectCaptureFrequency()</a>
<a name="ln1564">    {</a>
<a name="ln1565">        switch (UserSettings.All.CaptureFrequency)</a>
<a name="ln1566">        {</a>
<a name="ln1567">            case CaptureFrequencies.Manual:</a>
<a name="ln1568">                FrequencyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Recorder.Manual.Short&quot;);</a>
<a name="ln1569">                FrequencyIntegerUpDown.Visibility = Visibility.Collapsed;</a>
<a name="ln1570">                FrequencyViewbox.Visibility = Visibility.Collapsed;</a>
<a name="ln1571">                AdjustToManual();</a>
<a name="ln1572">                break;</a>
<a name="ln1573">            case CaptureFrequencies.Interaction:</a>
<a name="ln1574">                FrequencyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Recorder.Interaction.Short&quot;);</a>
<a name="ln1575">                FrequencyIntegerUpDown.Visibility = Visibility.Collapsed;</a>
<a name="ln1576">                FrequencyViewbox.Visibility = Visibility.Collapsed;</a>
<a name="ln1577">                AdjustToInteraction();</a>
<a name="ln1578">                break;</a>
<a name="ln1579">            case CaptureFrequencies.PerSecond:</a>
<a name="ln1580">                FrequencyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Recorder.Fps.Short&quot;);</a>
<a name="ln1581">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fps&quot;);</a>
<a name="ln1582">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fps.Range&quot;);</a>
<a name="ln1583">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1584">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1585">                AdjustToAutomatic();</a>
<a name="ln1586">                break;</a>
<a name="ln1587"> </a>
<a name="ln1588">            case CaptureFrequencies.PerMinute:</a>
<a name="ln1589">                FrequencyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Recorder.Fpm.Short&quot;);</a>
<a name="ln1590">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fpm&quot;);</a>
<a name="ln1591">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fpm.Range&quot;);</a>
<a name="ln1592">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1593">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1594">                AdjustToAutomatic();</a>
<a name="ln1595">                break;</a>
<a name="ln1596"> </a>
<a name="ln1597">            default: //PerHour.</a>
<a name="ln1598">                FrequencyButton.SetResourceReference(ExtendedButton.TextProperty, &quot;S.Recorder.Fph.Short&quot;);</a>
<a name="ln1599">                FrequencyIntegerUpDown.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fph&quot;);</a>
<a name="ln1600">                FrequencyViewbox.SetResourceReference(ToolTipProperty, &quot;S.Recorder.Fph.Range&quot;);</a>
<a name="ln1601">                FrequencyIntegerUpDown.Visibility = Visibility.Visible;</a>
<a name="ln1602">                FrequencyViewbox.Visibility = Visibility.Visible;</a>
<a name="ln1603">                AdjustToAutomatic();</a>
<a name="ln1604">                break;</a>
<a name="ln1605">        }</a>
<a name="ln1606"> </a>
<a name="ln1607">        CommandManager.InvalidateRequerySuggested();</a>
<a name="ln1608">    }</a>
<a name="ln1609"> </a>
<a name="ln1610">    private void AdjustToManual()</a>
<a name="ln1611">    {</a>
<a name="ln1612">        Stage = RecorderStages.Recording;</a>
<a name="ln1613">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1614">        FrameRate.Start(HasFixedDelay(), GetFixedDelay());</a>
<a name="ln1615"> </a>
<a name="ln1616">        AutoFitButtons();</a>
<a name="ln1617">        DisplayGuidelines();</a>
<a name="ln1618">    }</a>
<a name="ln1619"> </a>
<a name="ln1620">    private void AdjustToInteraction()</a>
<a name="ln1621">    {</a>
<a name="ln1622">        Stage = Project?.Frames?.Count &gt; 0 ? RecorderStages.Paused : RecorderStages.Stopped;</a>
<a name="ln1623">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1624">        FrameRate.Start(HasFixedDelay(), GetFixedDelay());</a>
<a name="ln1625"> </a>
<a name="ln1626">        AutoFitButtons();</a>
<a name="ln1627">        DisplayGuidelines();</a>
<a name="ln1628">    }</a>
<a name="ln1629"> </a>
<a name="ln1630">    private void AdjustToAutomatic()</a>
<a name="ln1631">    {</a>
<a name="ln1632">        Stage = Project?.Frames?.Count &gt; 0 ? RecorderStages.Paused : RecorderStages.Stopped;</a>
<a name="ln1633">        Title = &quot;ScreenToGif&quot;;</a>
<a name="ln1634">        FrameRate.Stop();</a>
<a name="ln1635"> </a>
<a name="ln1636">        AutoFitButtons();</a>
<a name="ln1637">        DisplayGuidelines();</a>
<a name="ln1638">    }</a>
<a name="ln1639"> </a>
<a name="ln1640">    internal override void StartCapture()</a>
<a name="ln1641">    {</a>
<a name="ln1642">        DisplayTimer.Start();</a>
<a name="ln1643"> </a>
<a name="ln1644">        base.StartCapture();</a>
<a name="ln1645">    }</a>
<a name="ln1646"> </a>
<a name="ln1647">    internal override void PauseCapture()</a>
<a name="ln1648">    {</a>
<a name="ln1649">        DisplayTimer.Pause();</a>
<a name="ln1650"> </a>
<a name="ln1651">        base.PauseCapture();</a>
<a name="ln1652">    }</a>
<a name="ln1653"> </a>
<a name="ln1654">    internal override async Task StopCapture()</a>
<a name="ln1655">    {</a>
<a name="ln1656">        DisplayTimer.Stop();</a>
<a name="ln1657"> </a>
<a name="ln1658">        await base.StopCapture();</a>
<a name="ln1659">    }</a>
<a name="ln1660"> </a>
<a name="ln1661">    private void DetectThinMode()</a>
<a name="ln1662">    {</a>
<a name="ln1663">        //Updates the Offsets of the two controls (because it's a static property, it will not update by itself).</a>
<a name="ln1664">        HeightIntegerBox.Offset = Constants.VerticalOffset;</a>
<a name="ln1665">        WidthIntegerBox.Offset = Constants.HorizontalOffset;</a>
<a name="ln1666">    }</a>
<a name="ln1667"> </a>
<a name="ln1668">    private void MoveWindow(int left, int top, int right, int bottom)</a>
<a name="ln1669">    {</a>
<a name="ln1670">        Left = left &gt; 0 ? Math.Max(Left - left, _viewModel.MaximumBounds.Left - Constants.LeftOffset) : right &gt; 0 ? Math.Min(Left + right, _viewModel.MaximumBounds.Right - Width + Constants.RightOffset) : Left;</a>
<a name="ln1671">        Top = top &gt; 0 ? Math.Max(Top - top, _viewModel.MaximumBounds.Top - Constants.TopOffset) : bottom &gt; 0 ? Math.Min(Top + bottom, _viewModel.MaximumBounds.Bottom - Height + Constants.BottomOffset) : Top;</a>
<a name="ln1672"> </a>
<a name="ln1673">        DetectMonitorChanges(true);</a>
<a name="ln1674">    }</a>
<a name="ln1675"> </a>
<a name="ln1676">    private void ResizeWindow(int left, int top, int right, int bottom)</a>
<a name="ln1677">    {</a>
<a name="ln1678">        var newLeft = left &lt; 0 ? Math.Max(Left + left, _viewModel.MaximumBounds.Left - Constants.LeftOffset) : left &gt; 0 ? Left + left : Left;</a>
<a name="ln1679">        var newTop = top &lt; 0 ? Math.Max(Top + top, _viewModel.MaximumBounds.Top - Constants.TopOffset) : top &gt; 0 ? Top + top : Top;</a>
<a name="ln1680">        var width = (right &gt; 0 ? Math.Min(Width + right, _viewModel.MaximumBounds.Right - Left + Constants.RightOffset) - left : right &lt; 0 ? Width + right + (left &gt; 0 ? -left : 0) : Width - (newLeft - Left));</a>
<a name="ln1681">        var height = (bottom &gt; 0 ? Math.Min(Height + bottom, _viewModel.MaximumBounds.Bottom - Top + Constants.BottomOffset) - top : bottom &lt; 0 ? Height + bottom + (top &gt; 0 ? -top : 0) : Height - (newTop - Top));</a>
<a name="ln1682"> </a>
<a name="ln1683">        //Ignore input if the new size will be smaller than the minimum.</a>
<a name="ln1684">        if ((height &lt; 25 &amp;&amp; (top &gt; 0 || bottom &lt; 0)) || (width &lt; 25 &amp;&amp; (left &gt; 0 || right &lt; 0)))</a>
<a name="ln1685">            return;</a>
<a name="ln1686"> </a>
<a name="ln1687">        Left = newLeft;</a>
<a name="ln1688">        Top = newTop;</a>
<a name="ln1689">        Width = width;</a>
<a name="ln1690">        Height = height;</a>
<a name="ln1691"> </a>
<a name="ln1692">        DetectMonitorChanges(true);</a>
<a name="ln1693">    }</a>
<a name="ln1694"> </a>
<a name="ln1695">    private void SetTaskbarButtonOverlay()</a>
<a name="ln1696">    {</a>
<a name="ln1697">        try</a>
<a name="ln1698">        {</a>
<a name="ln1699">            switch (Stage)</a>
<a name="ln1700">            {</a>
<a name="ln1701">                case RecorderStages.Stopped:</a>
<a name="ln1702">                    TaskbarItemInfo.Overlay = null;</a>
<a name="ln1703">                    return;</a>
<a name="ln1704">                case RecorderStages.Recording:</a>
<a name="ln1705">                    if (UserSettings.All.CaptureFrequency != CaptureFrequencies.Manual)</a>
<a name="ln1706">                        TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Record&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1707">                    else</a>
<a name="ln1708">                        TaskbarItemInfo.Overlay = null;</a>
<a name="ln1709">                    return;</a>
<a name="ln1710">                case RecorderStages.Paused:</a>
<a name="ln1711">                    TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Pause&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1712">                    return;</a>
<a name="ln1713">                case RecorderStages.Discarding:</a>
<a name="ln1714">                    TaskbarItemInfo.Overlay = new DrawingImage((FindResource(&quot;Vector.Remove&quot;) as DrawingBrush)?.Drawing);</a>
<a name="ln1715">                    return;</a>
<a name="ln1716">            }</a>
<a name="ln1717">        }</a>
<a name="ln1718">        catch (Exception e)</a>
<a name="ln1719">        {</a>
<a name="ln1720">            LogWriter.Log(e, &quot;Impossible to set the taskbar button overlay&quot;);</a>
<a name="ln1721">        }</a>
<a name="ln1722">    }</a>
<a name="ln1723"> </a>
<a name="ln1724">    private void DisplayGuidelines()</a>
<a name="ln1725">    {</a>
<a name="ln1726">        GuidelinesGrid.Visibility = Visibility.Visible;</a>
<a name="ln1727">    }</a>
<a name="ln1728"> </a>
<a name="ln1729">    private void HideGuidelines()</a>
<a name="ln1730">    {</a>
<a name="ln1731">        GuidelinesGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln1732">        Dispatcher.Invoke(new Action(() =&gt; { }), DispatcherPriority.ContextIdle, null);</a>
<a name="ln1733">    }</a>
<a name="ln1734"> </a>
<a name="ln1735">    #endregion</a>
<a name="ln1736">}</a>
</code></pre>
<div class="balloon" rel="733"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3023/" target="_blank">V3023</a> Consider inspecting this expression. The expression is excessive or contains a misprint.</p></div>
<div class="balloon" rel="1306"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The 'Capture' object was used before it was verified against null. Check lines: 1306, 1307.</p></div>
<div class="balloon" rel="1699"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3002/" target="_blank">V3002</a> The switch statement does not cover all values of the 'RecorderStages' enum: PreStarting, Snapping.</p></div>
<div class="balloon" rel="669"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3130/" target="_blank">V3130</a> Priority of the '&amp;&amp;' operator is higher than that of the '||' operator. Possible missing parentheses.</p></div>
<div class="balloon" rel="147"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<div class="balloon" rel="437"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<div class="balloon" rel="1152"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>