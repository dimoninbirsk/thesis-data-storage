<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>TranslatorWindow.xaml.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using Microsoft.Win32;</a>
<a name="ln2">using System;</a>
<a name="ln3">using System.Collections.Generic;</a>
<a name="ln4">using System.Collections.ObjectModel;</a>
<a name="ln5">using System.ComponentModel;</a>
<a name="ln6">using System.Diagnostics;</a>
<a name="ln7">using System.Globalization;</a>
<a name="ln8">using System.IO;</a>
<a name="ln9">using System.Linq;</a>
<a name="ln10">using System.Net;</a>
<a name="ln11">using System.Runtime.Serialization.Json;</a>
<a name="ln12">using System.Text;</a>
<a name="ln13">using System.Threading.Tasks;</a>
<a name="ln14">using System.Windows;</a>
<a name="ln15">using System.Windows.Controls;</a>
<a name="ln16">using System.Windows.Input;</a>
<a name="ln17">using System.Windows.Markup;</a>
<a name="ln18">using System.Windows.Navigation;</a>
<a name="ln19">using System.Windows.Threading;</a>
<a name="ln20">using System.Xml.Linq;</a>
<a name="ln21">using System.Xml.XPath;</a>
<a name="ln22">using Translator.Util;</a>
<a name="ln23">using XamlReader = System.Windows.Markup.XamlReader;</a>
<a name="ln24"> </a>
<a name="ln25">namespace Translator;</a>
<a name="ln26"> </a>
<a name="ln27">public partial class TranslatorWindow : Window</a>
<a name="ln28">{</a>
<a name="ln29">    private readonly List&lt;ResourceDictionary&gt; _resourceList = new();</a>
<a name="ln30">    private IEnumerable&lt;string&gt; _cultures;</a>
<a name="ln31">    private ObservableCollection&lt;Translation&gt; _translationList = new();</a>
<a name="ln32">    private string _tempPath;</a>
<a name="ln33">    private string _resourceTemplate;</a>
<a name="ln34"> </a>
<a name="ln35">    public TranslatorWindow()</a>
<a name="ln36">    {</a>
<a name="ln37">        InitializeComponent();</a>
<a name="ln38">    }</a>
<a name="ln39"> </a>
<a name="ln40">    #region Events</a>
<a name="ln41"> </a>
<a name="ln42">    private async void Window_Loaded(object sender, RoutedEventArgs e)</a>
<a name="ln43">    {</a>
<a name="ln44">        PrepareTempPath();</a>
<a name="ln45"> </a>
<a name="ln46">        OpenButton.IsEnabled = false;</a>
<a name="ln47">        RefreshButton.IsEnabled = false;</a>
<a name="ln48">        ToComboBox.IsEnabled = false;</a>
<a name="ln49"> </a>
<a name="ln50">        #region Languages</a>
<a name="ln51"> </a>
<a name="ln52">        FromComboBox.Text = &quot;Loading...&quot;;</a>
<a name="ln53">        ToComboBox.Text = &quot;Loading...&quot;;</a>
<a name="ln54"> </a>
<a name="ln55">        StatusBand.Info(&quot;Downloading English resource file...&quot;);</a>
<a name="ln56"> </a>
<a name="ln57">        //We have to get english resource first in case we import first without refreshing</a>
<a name="ln58">        await DownloadSingleResourceAsync(&quot;en&quot;);</a>
<a name="ln59"> </a>
<a name="ln60">        StatusBand.Info(&quot;Loading language codes...&quot;);</a>
<a name="ln61"> </a>
<a name="ln62">        _cultures = await GetProperCulturesAsync();</a>
<a name="ln63">        var languageList = await Task.Factory.StartNew(() =&gt; _cultures.Select(x =&gt; new Culture { Code = x, Name = CultureInfo.GetCultureInfo(x).DisplayName }).ToList());</a>
<a name="ln64">        //var languageList = CultureInfo.GetCultures(CultureTypes.AllCultures).Select(x =&gt; new Culture { Code = x.IetfLanguageTag, Name = x.EnglishName }).ToList();</a>
<a name="ln65"> </a>
<a name="ln66">        FromComboBox.ItemsSource = languageList;</a>
<a name="ln67">        ToComboBox.ItemsSource = languageList;</a>
<a name="ln68">        ToComboBox.Text = null;</a>
<a name="ln69">        FromComboBox.SelectedIndex = languageList.FindIndex(x =&gt; x.Code == &quot;en&quot;);</a>
<a name="ln70"> </a>
<a name="ln71">        StatusBand.Hide();</a>
<a name="ln72"> </a>
<a name="ln73">        #endregion</a>
<a name="ln74"> </a>
<a name="ln75">        OpenButton.IsEnabled = true;</a>
<a name="ln76">        RefreshButton.IsEnabled = true;</a>
<a name="ln77">        ToComboBox.IsEnabled = true;</a>
<a name="ln78"> </a>
<a name="ln79">        ToComboBox.Focus();</a>
<a name="ln80">    }</a>
<a name="ln81"> </a>
<a name="ln82">    private void TutorialHyperlink_RequestNavigate(object sender, RequestNavigateEventArgs e)</a>
<a name="ln83">    {</a>
<a name="ln84">        try</a>
<a name="ln85">        {</a>
<a name="ln86">            Process.Start(&quot;https://github.com/NickeManarin/ScreenToGif/wiki/Localization&quot;);</a>
<a name="ln87">        }</a>
<a name="ln88">        catch (Exception ex)</a>
<a name="ln89">        {</a>
<a name="ln90">            Dialog.Ok(&quot;Translator&quot;, &quot;Tutorial&quot;, &quot;Error while trying to open the tutorial link&quot;);</a>
<a name="ln91">        }</a>
<a name="ln92">    }</a>
<a name="ln93"> </a>
<a name="ln94">    private void NewLineHyperlink_Click(object sender, RoutedEventArgs e)</a>
<a name="ln95">    {</a>
<a name="ln96">        Clipboard.SetText(&quot;&amp;#10;&quot;);</a>
<a name="ln97">    }</a>
<a name="ln98"> </a>
<a name="ln99">    private void ComboBox_KeyDown(object sender, KeyEventArgs e)</a>
<a name="ln100">    {</a>
<a name="ln101">        if (e.Key == Key.Return || e.Key == Key.Enter)</a>
<a name="ln102">        {</a>
<a name="ln103">            e.Handled = true;</a>
<a name="ln104">            RefreshButton.Focus();</a>
<a name="ln105">        }</a>
<a name="ln106">    }</a>
<a name="ln107"> </a>
<a name="ln108">    private async void Refresh_Click(object sender, RoutedEventArgs e)</a>
<a name="ln109">    {</a>
<a name="ln110">        var baseCulture = FromComboBox.SelectedValue as string;</a>
<a name="ln111"> </a>
<a name="ln112">        if (ToComboBox.SelectedValue is not string specificCulture)</a>
<a name="ln113">        {</a>
<a name="ln114">            StatusBand.Info(&quot;You need to select a target language to load the translations.&quot;);</a>
<a name="ln115">            return;</a>
<a name="ln116">        }</a>
<a name="ln117"> </a>
<a name="ln118">        HeaderLabel.Content = &quot;Downloading resources...&quot;;</a>
<a name="ln119">        StatusBand.Info(&quot;Downloading selected translations...&quot;);</a>
<a name="ln120"> </a>
<a name="ln121">        await DownloadResourcesAsync(baseCulture, specificCulture);</a>
<a name="ln122">        ShowTranslations(baseCulture, specificCulture);</a>
<a name="ln123"> </a>
<a name="ln124">        HeaderLabel.Content = &quot;Translator&quot;;</a>
<a name="ln125">        BaseDataGrid.IsEnabled = true;</a>
<a name="ln126">        StatusBand.Hide();</a>
<a name="ln127">    }</a>
<a name="ln128"> </a>
<a name="ln129">    private void Itens_GotFocus(object sender, RoutedEventArgs e)</a>
<a name="ln130">    {</a>
<a name="ln131">        if (e.OriginalSource is not TextBox ue)</a>
<a name="ln132">            return;</a>
<a name="ln133"> </a>
<a name="ln134">        ue.Dispatcher.BeginInvoke(DispatcherPriority.Send, () =&gt; ue.SelectAll());</a>
<a name="ln135"> </a>
<a name="ln136">        BaseDataGrid.SelectedItem = ((FrameworkElement)sender).DataContext;</a>
<a name="ln137">    }</a>
<a name="ln138"> </a>
<a name="ln139">    private void Item_PreviewKeyDown(object sender, KeyEventArgs e)</a>
<a name="ln140">    {</a>
<a name="ln141">        var source = e.OriginalSource as TextBox;</a>
<a name="ln142"> </a>
<a name="ln143">        if (source == null)</a>
<a name="ln144">            return;</a>
<a name="ln145"> </a>
<a name="ln146">        //Back, up.</a>
<a name="ln147">        if (e.Key == Key.Up || e.Key is Key.Enter or Key.Return &amp;&amp; (Keyboard.IsKeyDown(Key.LeftShift) || Keyboard.IsKeyDown(Key.RightShift)))</a>
<a name="ln148">        {</a>
<a name="ln149">            source.MoveFocus(new TraversalRequest(FocusNavigationDirection.Up));</a>
<a name="ln150">            BaseDataGrid.BeginEdit();</a>
<a name="ln151"> </a>
<a name="ln152">            var current = DataGridHelper.GetDataGridCell(BaseDataGrid.CurrentCell);</a>
<a name="ln153"> </a>
<a name="ln154">            current?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Up));</a>
<a name="ln155"> </a>
<a name="ln156">            e.Handled = true;</a>
<a name="ln157">            return;</a>
<a name="ln158">        }</a>
<a name="ln159"> </a>
<a name="ln160">        //Back, left.</a>
<a name="ln161">        if ((e.Key == Key.Left &amp;&amp; (source.CaretIndex == 0 || source.IsReadOnly)) || (e.Key == Key.Tab &amp;&amp; (Keyboard.IsKeyDown(Key.LeftShift) || Keyboard.IsKeyDown(Key.RightShift))))</a>
<a name="ln162">        {</a>
<a name="ln163">            source.MoveFocus(new TraversalRequest(FocusNavigationDirection.Left));</a>
<a name="ln164">            BaseDataGrid.BeginEdit();</a>
<a name="ln165"> </a>
<a name="ln166">            var current = DataGridHelper.GetDataGridCell(BaseDataGrid.CurrentCell);</a>
<a name="ln167"> </a>
<a name="ln168">            current?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Left));</a>
<a name="ln169"> </a>
<a name="ln170">            e.Handled = true;</a>
<a name="ln171">            return;</a>
<a name="ln172">        }</a>
<a name="ln173"> </a>
<a name="ln174">        //Next, down.</a>
<a name="ln175">        if (e.Key == Key.Down || e.Key == Key.Enter || e.Key == Key.Return)</a>
<a name="ln176">        {</a>
<a name="ln177">            source.MoveFocus(new TraversalRequest(FocusNavigationDirection.Down));</a>
<a name="ln178">            BaseDataGrid.BeginEdit();</a>
<a name="ln179"> </a>
<a name="ln180">            var current = DataGridHelper.GetDataGridCell(BaseDataGrid.CurrentCell);</a>
<a name="ln181"> </a>
<a name="ln182">            current?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Down));</a>
<a name="ln183"> </a>
<a name="ln184">            e.Handled = true;</a>
<a name="ln185">            return;</a>
<a name="ln186">        }</a>
<a name="ln187"> </a>
<a name="ln188">        //Next, right. OLD (e.Key == Key.Right &amp;&amp; (source.CaretIndex == source.Text.Length - 1 || source.IsReadOnly)) ||</a>
<a name="ln189">        if (e.Key == Key.Tab)</a>
<a name="ln190">        {</a>
<a name="ln191">            source.MoveFocus(new TraversalRequest(FocusNavigationDirection.Next));</a>
<a name="ln192">            BaseDataGrid.BeginEdit();</a>
<a name="ln193"> </a>
<a name="ln194">            var current = DataGridHelper.GetDataGridCell(BaseDataGrid.CurrentCell);</a>
<a name="ln195"> </a>
<a name="ln196">            current?.MoveFocus(new TraversalRequest(FocusNavigationDirection.Next));</a>
<a name="ln197"> </a>
<a name="ln198">            e.Handled = true;</a>
<a name="ln199">            return;</a>
<a name="ln200">        }</a>
<a name="ln201">    }</a>
<a name="ln202"> </a>
<a name="ln203">    private void Load_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln204">    {</a>
<a name="ln205">        e.CanExecute = true;</a>
<a name="ln206">    }</a>
<a name="ln207"> </a>
<a name="ln208">    private void Export_CanExecute(object sender, CanExecuteRoutedEventArgs e)</a>
<a name="ln209">    {</a>
<a name="ln210">        e.CanExecute = BaseDataGrid.IsEnabled &amp;&amp; ToComboBox.SelectedValue != null &amp;&amp; BaseDataGrid.Items.Count &gt; 0;</a>
<a name="ln211">    }</a>
<a name="ln212"> </a>
<a name="ln213">    private async void Load_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln214">    {</a>
<a name="ln215">        var ofd = new OpenFileDialog</a>
<a name="ln216">        {</a>
<a name="ln217">            AddExtension = true,</a>
<a name="ln218">            CheckFileExists = true,</a>
<a name="ln219">            Title = &quot;Open a Resource Dictionary&quot;,</a>
<a name="ln220">            Filter = &quot;Resource Dictionary (*.xaml)|*.xaml;&quot;,</a>
<a name="ln221">            InitialDirectory = Path.GetFullPath(_tempPath)</a>
<a name="ln222">        };</a>
<a name="ln223"> </a>
<a name="ln224">        var result = ofd.ShowDialog();</a>
<a name="ln225"> </a>
<a name="ln226">        if (!result.HasValue || !result.Value)</a>
<a name="ln227">            return;</a>
<a name="ln228"> </a>
<a name="ln229">        //Will save the file to other folder.</a>
<a name="ln230">        var tempFile = Path.Combine(_tempPath, &quot;Temp&quot;, Path.GetFileName(ofd.FileName));</a>
<a name="ln231"> </a>
<a name="ln232">        Directory.CreateDirectory(Path.Combine(_tempPath, &quot;Temp&quot;));</a>
<a name="ln233"> </a>
<a name="ln234">        //Replaces the special chars.</a>
<a name="ln235">        var text = await Task.Factory.StartNew(() =&gt; File.ReadAllText(ofd.FileName, Encoding.UTF8).Replace(&quot;&amp;#&quot;, &quot;&amp;amp;#&quot;).Replace(&quot;&lt;!--&lt;!--&quot;, &quot;&lt;!--&quot;).Replace(&quot;--&gt;--&gt;&quot;, &quot;--&gt;&quot;));</a>
<a name="ln236">        await Task.Factory.StartNew(() =&gt; File.WriteAllText(tempFile, text, Encoding.UTF8));</a>
<a name="ln237"> </a>
<a name="ln238">        var dictionary = await Task.Factory.StartNew(() =&gt; new ResourceDictionary { Source = new Uri(Path.GetFullPath(tempFile), UriKind.Absolute) });</a>
<a name="ln239">        _resourceList.Add(dictionary);</a>
<a name="ln240"> </a>
<a name="ln241">        var baseCulture = FromComboBox.SelectedValue as string;</a>
<a name="ln242">        var specificCulture = Path.GetFileName(ofd.FileName).Replace(&quot;StringResources.&quot;, &quot;&quot;).Replace(&quot;.xaml&quot;, &quot;&quot;);</a>
<a name="ln243"> </a>
<a name="ln244">        string properCulture;</a>
<a name="ln245"> </a>
<a name="ln246">        //Catching here, because we can access UI thread easily here to show dialogs</a>
<a name="ln247">        try</a>
<a name="ln248">        {</a>
<a name="ln249">            properCulture = await Task.Factory.StartNew(() =&gt; CheckSupportedCulture(specificCulture));</a>
<a name="ln250">        }</a>
<a name="ln251">        catch (CultureNotFoundException)</a>
<a name="ln252">        {</a>
<a name="ln253">            Dialog.Ok(&quot;Action Denied&quot;, &quot;Unknown Language.&quot;,</a>
<a name="ln254">                $&quot;The \&quot;{specificCulture}\&quot; and its family were not recognized as a valid language codes.&quot;);</a>
<a name="ln255"> </a>
<a name="ln256">            return;</a>
<a name="ln257">        }</a>
<a name="ln258">        catch (Exception ex)</a>
<a name="ln259">        {</a>
<a name="ln260">            Dialog.Ok(&quot;Action Denied&quot;, &quot;Error checking culture.&quot;, ex.Message);</a>
<a name="ln261"> </a>
<a name="ln262">            return;</a>
<a name="ln263">        }</a>
<a name="ln264"> </a>
<a name="ln265">        if (properCulture != specificCulture)</a>
<a name="ln266">        {</a>
<a name="ln267">            Dialog.Ok(&quot;Action Denied&quot;, &quot;Redundant Language Code.&quot;,</a>
<a name="ln268">                $&quot;The \&quot;{specificCulture}\&quot; code is redundant. Try using \'{properCulture}\&quot; instead&quot;);</a>
<a name="ln269"> </a>
<a name="ln270">            return;</a>
<a name="ln271">        }</a>
<a name="ln272"> </a>
<a name="ln273">        ToComboBox.SelectedValue = specificCulture;</a>
<a name="ln274"> </a>
<a name="ln275">        ShowTranslations(baseCulture, specificCulture);</a>
<a name="ln276"> </a>
<a name="ln277">        BaseDataGrid.IsEnabled = true;</a>
<a name="ln278">    }</a>
<a name="ln279"> </a>
<a name="ln280">    private async void Export_Executed(object sender, ExecutedRoutedEventArgs e)</a>
<a name="ln281">    {</a>
<a name="ln282">        var sfd = new SaveFileDialog</a>
<a name="ln283">        {</a>
<a name="ln284">            AddExtension = true,</a>
<a name="ln285">            Filter = &quot;Resource Dictionary (*.xaml)|*.xaml&quot;,</a>
<a name="ln286">            Title = &quot;Save Resource Dictionary&quot;,</a>
<a name="ln287">            FileName = $&quot;StringResources.{ToComboBox.SelectedValue}.xaml&quot;</a>
<a name="ln288">        };</a>
<a name="ln289"> </a>
<a name="ln290">        var result = sfd.ShowDialog();</a>
<a name="ln291"> </a>
<a name="ln292">        if (!result.HasValue || !result.Value)</a>
<a name="ln293">            return;</a>
<a name="ln294"> </a>
<a name="ln295">        BaseDataGrid.IsEnabled = false;</a>
<a name="ln296">        StatusBand.Info(&quot;Exporting translation...&quot;);</a>
<a name="ln297"> </a>
<a name="ln298">        var fileName = sfd.FileName;</a>
<a name="ln299">        var saved = await Task.Factory.StartNew(() =&gt; ExportTranslation(fileName));</a>
<a name="ln300"> </a>
<a name="ln301">        BaseDataGrid.IsEnabled = true;</a>
<a name="ln302"> </a>
<a name="ln303">        if (saved)</a>
<a name="ln304">            StatusBand.Info(&quot;Translation saved!&quot;);</a>
<a name="ln305">        else</a>
<a name="ln306">            StatusBand.Hide();</a>
<a name="ln307">    }</a>
<a name="ln308"> </a>
<a name="ln309">    private void CancelButton_Click(object sender, RoutedEventArgs e)</a>
<a name="ln310">    {</a>
<a name="ln311">        Close();</a>
<a name="ln312">    }</a>
<a name="ln313"> </a>
<a name="ln314">    private void Window_Closing(object sender, CancelEventArgs e)</a>
<a name="ln315">    {</a>
<a name="ln316">        if (BaseDataGrid.Items.Count &gt; 0 &amp;&amp; !Dialog.Ask(&quot;Translator&quot;, &quot;Do you really wish to close?&quot;, &quot;Don't forget to export your translation, if you started translating but not exported yet.&quot;))</a>
<a name="ln317">            e.Cancel = true;</a>
<a name="ln318">    }</a>
<a name="ln319"> </a>
<a name="ln320">    #endregion</a>
<a name="ln321"> </a>
<a name="ln322">    #region Methods</a>
<a name="ln323"> </a>
<a name="ln324">    private void PrepareTempPath()</a>
<a name="ln325">    {</a>
<a name="ln326">        _tempPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, &quot;ScreenToGif&quot;, &quot;Resources&quot;);</a>
<a name="ln327"> </a>
<a name="ln328">        if (!Directory.Exists(_tempPath))</a>
<a name="ln329">            Directory.CreateDirectory(_tempPath);</a>
<a name="ln330">    }</a>
<a name="ln331"> </a>
<a name="ln332">    private async Task DownloadSingleResourceAsync(string culture)</a>
<a name="ln333">    {</a>
<a name="ln334">        try</a>
<a name="ln335">        {</a>
<a name="ln336">            var request = (HttpWebRequest)WebRequest.Create(&quot;https://api.github.com/repos/NickeManarin/ScreenToGif/contents/ScreenToGif/Resources/Localization&quot;);</a>
<a name="ln337">            request.UserAgent = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393&quot;;</a>
<a name="ln338"> </a>
<a name="ln339">            var response = (HttpWebResponse)await request.GetResponseAsync();</a>
<a name="ln340"> </a>
<a name="ln341">            await using (var resultStream = response.GetResponseStream())</a>
<a name="ln342">            {</a>
<a name="ln343">                using (var reader = new StreamReader(resultStream))</a>
<a name="ln344">                {</a>
<a name="ln345">                    var result = await reader.ReadToEndAsync();</a>
<a name="ln346"> </a>
<a name="ln347">                    var jsonReader = JsonReaderWriterFactory.CreateJsonReader(Encoding.UTF8.GetBytes(result),</a>
<a name="ln348">                        new System.Xml.XmlDictionaryReaderQuotas());</a>
<a name="ln349"> </a>
<a name="ln350">                    var json = await Task&lt;XElement&gt;.Factory.StartNew(() =&gt; XElement.Load(jsonReader));</a>
<a name="ln351"> </a>
<a name="ln352">                    var element = json.XPathSelectElement(&quot;/&quot;).Elements().FirstOrDefault(x =&gt; x.XPathSelectElement(&quot;name&quot;).Value.EndsWith(culture + &quot;.xaml&quot;));</a>
<a name="ln353"> </a>
<a name="ln354">                    if (element == null)</a>
<a name="ln355">                        throw new WebException(&quot;File not found&quot;);</a>
<a name="ln356"> </a>
<a name="ln357">                    var name = element.XPathSelectElement(&quot;name&quot;).Value;</a>
<a name="ln358">                    var downloadUrl = element.XPathSelectElement(&quot;download_url&quot;).Value;</a>
<a name="ln359"> </a>
<a name="ln360">                    await DownloadFileAsync(new Uri(downloadUrl), name);</a>
<a name="ln361"> </a>
<a name="ln362">                    CommandManager.InvalidateRequerySuggested();</a>
<a name="ln363">                }</a>
<a name="ln364">            }</a>
<a name="ln365">        }</a>
<a name="ln366">        catch (WebException web)</a>
<a name="ln367">        {</a>
<a name="ln368">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading Single Resource&quot;, web.Message +</a>
<a name="ln369">                Environment.NewLine + &quot;Trying to load files already downloaded.&quot;));</a>
<a name="ln370"> </a>
<a name="ln371">            await LoadFilesAsync();</a>
<a name="ln372">        }</a>
<a name="ln373">        catch (Exception ex)</a>
<a name="ln374">        {</a>
<a name="ln375">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading Single Resource&quot;, ex.Message));</a>
<a name="ln376">        }</a>
<a name="ln377"> </a>
<a name="ln378">        GC.Collect();</a>
<a name="ln379">    }</a>
<a name="ln380"> </a>
<a name="ln381">    private async Task DownloadResourcesAsync(string baseCulture, string specificCulture)</a>
<a name="ln382">    {</a>
<a name="ln383">        try</a>
<a name="ln384">        {</a>
<a name="ln385">            var request = (HttpWebRequest)WebRequest.Create(&quot;https://api.github.com/repos/NickeManarin/ScreenToGif/contents/ScreenToGif/Resources/Localization&quot;);</a>
<a name="ln386">            request.UserAgent = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393&quot;;</a>
<a name="ln387"> </a>
<a name="ln388">            var response = (HttpWebResponse)await request.GetResponseAsync();</a>
<a name="ln389"> </a>
<a name="ln390">            await using (var resultStream = response.GetResponseStream())</a>
<a name="ln391">            {</a>
<a name="ln392">                using (var reader = new StreamReader(resultStream))</a>
<a name="ln393">                {</a>
<a name="ln394">                    var result = await reader.ReadToEndAsync();</a>
<a name="ln395"> </a>
<a name="ln396">                    var jsonReader = JsonReaderWriterFactory.CreateJsonReader(Encoding.UTF8.GetBytes(result),</a>
<a name="ln397">                        new System.Xml.XmlDictionaryReaderQuotas());</a>
<a name="ln398"> </a>
<a name="ln399">                    var json = await Task&lt;XElement&gt;.Factory.StartNew(() =&gt; XElement.Load(jsonReader));</a>
<a name="ln400"> </a>
<a name="ln401">                    foreach (var element in json.XPathSelectElement(&quot;/&quot;).Elements())</a>
<a name="ln402">                    {</a>
<a name="ln403">                        var name = element.XPathSelectElement(&quot;name&quot;).Value;</a>
<a name="ln404"> </a>
<a name="ln405">                        if (string.IsNullOrEmpty(name) || (!name.EndsWith(baseCulture + &quot;.xaml&quot;) &amp;&amp; !name.EndsWith(specificCulture + &quot;.xaml&quot;)))</a>
<a name="ln406">                            continue;</a>
<a name="ln407"> </a>
<a name="ln408">                        var downloadUrl = element.XPathSelectElement(&quot;download_url&quot;).Value;</a>
<a name="ln409"> </a>
<a name="ln410">                        await DownloadFileAsync(new Uri(downloadUrl), name);</a>
<a name="ln411">                    }</a>
<a name="ln412"> </a>
<a name="ln413">                    CommandManager.InvalidateRequerySuggested();</a>
<a name="ln414">                }</a>
<a name="ln415">            }</a>
<a name="ln416">        }</a>
<a name="ln417">        catch (WebException web)</a>
<a name="ln418">        {</a>
<a name="ln419">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading Resources&quot;, web.Message +</a>
<a name="ln420">                Environment.NewLine + &quot;Trying to load files already downloaded.&quot;));</a>
<a name="ln421"> </a>
<a name="ln422">            await LoadFilesAsync();</a>
<a name="ln423">        }</a>
<a name="ln424">        catch (Exception ex)</a>
<a name="ln425">        {</a>
<a name="ln426">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading Resources&quot;, ex.Message));</a>
<a name="ln427">        }</a>
<a name="ln428"> </a>
<a name="ln429">        GC.Collect();</a>
<a name="ln430">    }</a>
<a name="ln431"> </a>
<a name="ln432">    private async Task DownloadFileAsync2(Uri uri, string name)</a>
<a name="ln433">    {</a>
<a name="ln434">        try</a>
<a name="ln435">        {</a>
<a name="ln436">            var file = Path.Combine(Dispatcher.Invoke&lt;string&gt;(() =&gt; _tempPath), name);</a>
<a name="ln437"> </a>
<a name="ln438">            if (File.Exists(file))</a>
<a name="ln439">                File.Delete(file);</a>
<a name="ln440"> </a>
<a name="ln441">            using (var webClient = new WebClient { Credentials = CredentialCache.DefaultNetworkCredentials })</a>
<a name="ln442">                await webClient.DownloadFileTaskAsync(uri, file);</a>
<a name="ln443"> </a>
<a name="ln444">            //Saves the template for later, when exporting the translation.</a>
<a name="ln445">            if (name.EndsWith(&quot;en.xaml&quot;))</a>
<a name="ln446">            {</a>
<a name="ln447">                using (var sr = new StreamReader(file, Encoding.UTF8))</a>
<a name="ln448">                {</a>
<a name="ln449">                    _resourceTemplate = await sr.ReadToEndAsync();</a>
<a name="ln450">                }</a>
<a name="ln451">            }</a>
<a name="ln452"> </a>
<a name="ln453">            await using (var fs = new FileStream(file, FileMode.Open, FileAccess.Read, FileShare.Read))</a>
<a name="ln454">            {</a>
<a name="ln455">                var dictionary = await Task.Factory.StartNew(() =&gt; (ResourceDictionary)XamlReader.Load(fs, new ParserContext { XmlSpace = &quot;preserve&quot; }));</a>
<a name="ln456">                //var dictionary = new ResourceDictionary();</a>
<a name="ln457">                dictionary.Source = await Task.Factory.StartNew(() =&gt; new Uri(Path.GetFullPath(file), UriKind.Absolute));</a>
<a name="ln458"> </a>
<a name="ln459">                _resourceList.Add(dictionary);</a>
<a name="ln460"> </a>
<a name="ln461">                if (name.EndsWith(&quot;en.xaml&quot;))</a>
<a name="ln462">                    Application.Current.Resources.MergedDictionaries.Add(dictionary);</a>
<a name="ln463">            }</a>
<a name="ln464">        }</a>
<a name="ln465">        catch (Exception ex)</a>
<a name="ln466">        {</a>
<a name="ln467">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading File&quot;, ex.Message));</a>
<a name="ln468">        }</a>
<a name="ln469">    }</a>
<a name="ln470"> </a>
<a name="ln471">    private async Task DownloadFileAsync(Uri uri, string name)</a>
<a name="ln472">    {</a>
<a name="ln473">        try</a>
<a name="ln474">        {</a>
<a name="ln475">            var file = Path.Combine(Dispatcher.Invoke&lt;string&gt;(() =&gt; _tempPath), name);</a>
<a name="ln476"> </a>
<a name="ln477">            if (File.Exists(file))</a>
<a name="ln478">                File.Delete(file);</a>
<a name="ln479"> </a>
<a name="ln480">            using (var webClient = new WebClient { Credentials = CredentialCache.DefaultNetworkCredentials })</a>
<a name="ln481">                await webClient.DownloadFileTaskAsync(uri, file);</a>
<a name="ln482"> </a>
<a name="ln483">            //Replaces the special chars.</a>
<a name="ln484">            var text = await Task.Factory.StartNew(() =&gt; File.ReadAllText(file, Encoding.UTF8).Replace(&quot;&amp;#&quot;, &quot;&amp;amp;#&quot;));</a>
<a name="ln485">            await Task.Factory.StartNew(() =&gt; File.WriteAllText(file, text, Encoding.UTF8));</a>
<a name="ln486"> </a>
<a name="ln487"> </a>
<a name="ln488">            //Saves the template for later, when exporting the translation.</a>
<a name="ln489">            if (name.EndsWith(&quot;en.xaml&quot;))</a>
<a name="ln490">                _resourceTemplate = text;</a>
<a name="ln491"> </a>
<a name="ln492">            var dictionary = await Task.Factory.StartNew(() =&gt; new ResourceDictionary { Source = new Uri(Path.GetFullPath(file), UriKind.Absolute) });</a>
<a name="ln493"> </a>
<a name="ln494">            _resourceList.Add(dictionary);</a>
<a name="ln495"> </a>
<a name="ln496">            //if (name.EndsWith(&quot;en.xaml&quot;))</a>
<a name="ln497">            //    Application.Current.Resources.MergedDictionaries.Add(dictionary);</a>
<a name="ln498"> </a>
<a name="ln499">            //using (var stream = new MemoryStream(Encoding.UTF8.GetBytes(text)))</a>
<a name="ln500">            //{</a>
<a name="ln501">            //    var dictionary = (ResourceDictionary)System.Windows.Markup.XamlReader.Load(stream, new ParserContext { XmlSpace = &quot;preserve&quot; });</a>
<a name="ln502">            //}</a>
<a name="ln503">        }</a>
<a name="ln504">        catch (Exception ex)</a>
<a name="ln505">        {</a>
<a name="ln506">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Downloading File&quot;, ex.Message));</a>
<a name="ln507">        }</a>
<a name="ln508">    }</a>
<a name="ln509"> </a>
<a name="ln510">    private async Task LoadFilesAsync()</a>
<a name="ln511">    {</a>
<a name="ln512">        try</a>
<a name="ln513">        {</a>
<a name="ln514">            var files = await Task.Factory.StartNew(() =&gt; Directory.EnumerateFiles(_tempPath, &quot;*.xaml&quot;));</a>
<a name="ln515"> </a>
<a name="ln516">            foreach (var file in files)</a>
<a name="ln517">            {</a>
<a name="ln518">                //Replaces the special chars.</a>
<a name="ln519">                var text = await Task.Factory.StartNew(() =&gt; File.ReadAllText(file, Encoding.UTF8).Replace(&quot;&amp;#&quot;, &quot;&amp;amp;#&quot;));</a>
<a name="ln520">                await Task.Factory.StartNew(() =&gt; File.WriteAllText(file, text, Encoding.UTF8));</a>
<a name="ln521"> </a>
<a name="ln522">                //Saves the template for later, when exporting the translation.</a>
<a name="ln523">                if (file.EndsWith(&quot;en.xaml&quot;))</a>
<a name="ln524">                    _resourceTemplate = text;</a>
<a name="ln525"> </a>
<a name="ln526">                var dictionary = await Task.Factory.StartNew(() =&gt; new ResourceDictionary { Source = new Uri(Path.GetFullPath(file), UriKind.Absolute) });</a>
<a name="ln527"> </a>
<a name="ln528">                _resourceList.Add(dictionary);</a>
<a name="ln529">            }</a>
<a name="ln530">        }</a>
<a name="ln531">        catch (Exception ex)</a>
<a name="ln532">        {</a>
<a name="ln533">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Loading Offline File&quot;, ex.Message));</a>
<a name="ln534">        }</a>
<a name="ln535">    }</a>
<a name="ln536"> </a>
<a name="ln537">    private void ShowTranslations(string baseCulture, string specificCulture)</a>
<a name="ln538">    {</a>
<a name="ln539">        //var baseCulture = FromComboBox.SelectionBoxItem as Culture;</a>
<a name="ln540">        //var specificCulture = ToComboBox.SelectionBoxItem as Culture;</a>
<a name="ln541"> </a>
<a name="ln542">        if (baseCulture == null)</a>
<a name="ln543">        {</a>
<a name="ln544">            _translationList = null;</a>
<a name="ln545">            BaseDataGrid.ItemsSource = null;</a>
<a name="ln546">            return;</a>
<a name="ln547">        }</a>
<a name="ln548"> </a>
<a name="ln549">        var baseResource = _resourceList.FirstOrDefault(x =&gt; x.Source?.OriginalString.EndsWith(baseCulture + &quot;.xaml&quot;) ?? false);</a>
<a name="ln550">        //var baseResource = Application.Current.Resources.MergedDictionaries.FirstOrDefault(x =&gt; x.Source?.OriginalString.EndsWith(baseCulture + &quot;.xaml&quot;) ?? false);</a>
<a name="ln551"> </a>
<a name="ln552">        if (baseResource == null)</a>
<a name="ln553">            return;</a>
<a name="ln554"> </a>
<a name="ln555">        if (specificCulture == null)</a>
<a name="ln556">        {</a>
<a name="ln557">            _translationList = new ObservableCollection&lt;Translation&gt;(baseResource.Keys.Cast&lt;string&gt;().Select(y =&gt; new Translation</a>
<a name="ln558">            {</a>
<a name="ln559">                Key = y,</a>
<a name="ln560">                BaseText = (string)baseResource[y]</a>
<a name="ln561">            }).OrderBy(o =&gt; o.Key).ToList());</a>
<a name="ln562"> </a>
<a name="ln563">            BaseDataGrid.ItemsSource = _translationList;</a>
<a name="ln564">            return;</a>
<a name="ln565">        }</a>
<a name="ln566"> </a>
<a name="ln567">        var specificResource = _resourceList.LastOrDefault(x =&gt; x.Source?.OriginalString.EndsWith(specificCulture + &quot;.xaml&quot;) ?? false);</a>
<a name="ln568"> </a>
<a name="ln569">        if (specificResource == null)</a>
<a name="ln570">        {</a>
<a name="ln571">            _translationList = new ObservableCollection&lt;Translation&gt;(baseResource.Keys.Cast&lt;string&gt;().Select(y =&gt; new Translation</a>
<a name="ln572">            {</a>
<a name="ln573">                Key = y,</a>
<a name="ln574">                BaseText = (string)baseResource[y]</a>
<a name="ln575">            }).OrderBy(o =&gt; o.Key).ToList());</a>
<a name="ln576"> </a>
<a name="ln577">            BaseDataGrid.ItemsSource = _translationList;</a>
<a name="ln578">            return;</a>
<a name="ln579">        }</a>
<a name="ln580"> </a>
<a name="ln581">        _translationList = new ObservableCollection&lt;Translation&gt;(baseResource.Keys.Cast&lt;string&gt;().Select(y =&gt; new Translation</a>
<a name="ln582">        {</a>
<a name="ln583">            Key = y,</a>
<a name="ln584">            BaseText = (string)baseResource[y],</a>
<a name="ln585">            SpecificText = (string)specificResource[y]</a>
<a name="ln586">        }).OrderBy(o =&gt; o.Key).ToList());</a>
<a name="ln587"> </a>
<a name="ln588">        BaseDataGrid.ItemsSource = _translationList;</a>
<a name="ln589">    }</a>
<a name="ln590"> </a>
<a name="ln591">    private bool ExportTranslation(string path)</a>
<a name="ln592">    {</a>
<a name="ln593">        try</a>
<a name="ln594">        {</a>
<a name="ln595">            var lines = _resourceTemplate.Split('\n');</a>
<a name="ln596"> </a>
<a name="ln597">            for (var i = 0; i &lt; lines.Length; i++)</a>
<a name="ln598">            {</a>
<a name="ln599">                var keyIndex = lines[i].IndexOf(&quot;:Key=&quot;, StringComparison.Ordinal);</a>
<a name="ln600"> </a>
<a name="ln601">                if (lines[i].TrimStart().StartsWith(&quot;&lt;!--&quot;) || keyIndex == -1)</a>
<a name="ln602">                    continue;</a>
<a name="ln603"> </a>
<a name="ln604">                var keyAux = lines[i].Substring(keyIndex + 6);</a>
<a name="ln605">                var key = keyAux.Substring(0, keyAux.IndexOf(&quot;\&quot;&quot;, StringComparison.Ordinal));</a>
<a name="ln606"> </a>
<a name="ln607">                var translated = _translationList.FirstOrDefault(x =&gt; x.Key == key);</a>
<a name="ln608"> </a>
<a name="ln609">                //&quot;    &lt;s:String x:Key=\&quot;Size\&quot;&gt;Size&lt;/s:String&gt;&quot;</a>
<a name="ln610">                if (string.IsNullOrWhiteSpace(translated?.SpecificText))</a>
<a name="ln611">                    lines[i] = $&quot;    &lt;!--{lines[i].TrimStart()}--&gt;&quot;; //Comment the line.</a>
<a name="ln612">                else</a>
<a name="ln613">                    lines[i] = $&quot;    &lt;s:String x:Key=\&quot;{key}\&quot;&gt;{translated.SpecificText}&lt;/s:String&gt;&quot;;</a>
<a name="ln614">            }</a>
<a name="ln615"> </a>
<a name="ln616">            if (File.Exists(path))</a>
<a name="ln617">                File.Delete(path);</a>
<a name="ln618"> </a>
<a name="ln619">            File.WriteAllText(path, string.Join(Environment.NewLine, lines).Replace(&quot;&amp;amp;#&quot;, &quot;&amp;#&quot;), Encoding.UTF8);</a>
<a name="ln620">            return true;</a>
<a name="ln621">        }</a>
<a name="ln622">        catch (Exception ex)</a>
<a name="ln623">        {</a>
<a name="ln624">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Saving Translation&quot;, ex.Message));</a>
<a name="ln625">            return false;</a>
<a name="ln626">        }</a>
<a name="ln627">    }</a>
<a name="ln628"> </a>
<a name="ln629">    private string CheckSupportedCulture(string cultureName)</a>
<a name="ln630">    {</a>
<a name="ln631">        //Using HashSet, because we can check if it contains string in O(1) time</a>
<a name="ln632">        //Only creating it takes some time,</a>
<a name="ln633">        //but it's better than performing Contains multiple times on the list in the loop below</a>
<a name="ln634">        var cultureHash = new HashSet&lt;string&gt;(_cultures);</a>
<a name="ln635"> </a>
<a name="ln636">        if (cultureHash.Contains(cultureName))</a>
<a name="ln637">            return cultureName;</a>
<a name="ln638"> </a>
<a name="ln639">        var t = CultureInfo.GetCultureInfo(cultureName);</a>
<a name="ln640"> </a>
<a name="ln641">        while (t != CultureInfo.InvariantCulture)</a>
<a name="ln642">        {</a>
<a name="ln643">            if (cultureHash.Contains(t.Name))</a>
<a name="ln644">                return t.Name;</a>
<a name="ln645"> </a>
<a name="ln646">            t = t.Parent;</a>
<a name="ln647">        }</a>
<a name="ln648"> </a>
<a name="ln649">        throw new CultureNotFoundException();</a>
<a name="ln650">    }</a>
<a name="ln651"> </a>
<a name="ln652">    private async Task&lt;IEnumerable&lt;string&gt;&gt; GetProperCulturesAsync()</a>
<a name="ln653">    {</a>
<a name="ln654">        var allCodes = await Task.Factory.StartNew(() =&gt; CultureInfo.GetCultures(CultureTypes.AllCultures).Where(x =&gt; !string.IsNullOrEmpty(x.Name)).Select(x =&gt; x.Name));</a>
<a name="ln655"> </a>
<a name="ln656">        try</a>
<a name="ln657">        {</a>
<a name="ln658">            var downloadedCodes = GetLanguageCodesOffline();</a>
<a name="ln659">            var properCodes = await Task.Factory.StartNew(() =&gt; allCodes.Where(x =&gt; downloadedCodes.Contains(x)));</a>
<a name="ln660">                </a>
<a name="ln661">            return properCodes ?? allCodes;</a>
<a name="ln662">        }</a>
<a name="ln663">        catch (Exception ex)</a>
<a name="ln664">        {</a>
<a name="ln665">            Dispatcher.Invoke(() =&gt; Dialog.Ok(&quot;Translator&quot;, &quot;Translator - Getting Language Codes&quot;, ex.Message +</a>
<a name="ln666">                Environment.NewLine + &quot;Loading all local language codes.&quot;));</a>
<a name="ln667">        }</a>
<a name="ln668"> </a>
<a name="ln669">        GC.Collect();</a>
<a name="ln670">        return allCodes;</a>
<a name="ln671">    }</a>
<a name="ln672"> </a>
<a name="ln673">    private List&lt;string&gt; GetLanguageCodesOffline()</a>
<a name="ln674">    {</a>
<a name="ln675">        //I'm taking a shortcut in here.</a>
<a name="ln676">        return (&quot;af;af-NA;agq;ak;am;ar;ar-AE;ar-BH;ar-DJ;ar-DZ;ar-EG;ar-ER;ar-IL;ar-IQ;ar-JO;ar-KM;ar-KW;ar-LB;ar-LY;ar-MA;ar-MR;ar-OM;ar-PS;ar-QA;ar-SA;ar-SD;ar-SO;&quot; +</a>
<a name="ln677">                &quot;ar-SS;ar-SY;ar-TD;ar-TN;ar-YE;as;asa;ast;az;az-Cyrl;bas;be;bem;bez;bg;bm;bn;bn-IN;bo;bo-IN;br;brx;bs;bs-Cyrl;ca;ca-FR;ccp;ce;ceb;cgg;chr;cs;cu;cy;da;&quot; +</a>
<a name="ln678">                &quot;dav;de;de-AT;de-CH;de-IT;de-LI;de-LU;dje;dsb;dua;dyo;dz;ebu;ee;ee-TG;el;en;en-001;en-150;en-AE;en-AG;en-AI;en-AT;en-AU;en-BB;en-BE;en-BI;en-BM;en-BS;&quot; +</a>
<a name="ln679">                &quot;en-BW;en-BZ;en-CA;en-CC;en-CH;en-CK;en-CM;en-CX;en-DE;en-DK;en-DM;en-ER;en-FI;en-FJ;en-FK;en-GB;en-GD;en-GG;en-GH;en-GI;en-GM;en-GU;en-GY;en-HK;en-IE;&quot; +</a>
<a name="ln680">                &quot;en-IL;en-IM;en-IN;en-IO;en-JE;en-JM;en-KE;en-KI;en-KN;en-KY;en-LC;en-LR;en-LS;en-MG;en-MH;en-MO;en-MP;en-MS;en-MT;en-MU;en-MW;en-MY;en-NA;en-NF;en-NG;&quot; +</a>
<a name="ln681">                &quot;en-NL;en-NR;en-NU;en-NZ;en-PG;en-PH;en-PK;en-PN;en-PW;en-RW;en-SB;en-SC;en-SD;en-SE;en-SG;en-SH;en-SI;en-SL;en-SS;en-SX;en-SZ;en-TK;en-TO;en-TT;en-TV;&quot; +</a>
<a name="ln682">                &quot;en-TZ;en-UG;en-VC;en-VU;en-WS;en-ZA;en-ZM;en-ZW;eo;es;es-419;es-AR;es-BO;es-BR;es-BZ;es-CL;es-CO;es-CR;es-CU;es-DO;es-EC;es-GQ;es-GT;es-HN;es-MX;es-NI;&quot; +</a>
<a name="ln683">                &quot;es-PA;es-PE;es-PH;es-PR;es-PY;es-SV;es-US;es-UY;es-VE;et;eu;ewo;fa;ff;ff-Latn-GH;ff-Latn-GM;ff-Latn-GN;ff-Latn-LR;ff-Latn-MR;ff-Latn-NG;ff-Latn-SL;fi;fil;&quot; +</a>
<a name="ln684">                &quot;fo;fo-DK;fr;fr-BE;fr-BI;fr-CA;fr-CD;fr-CH;fr-CI;fr-CM;fr-DJ;fr-DZ;fr-GF;fr-GN;fr-HT;fr-KM;fr-LU;fr-MA;fr-MG;fr-ML;fr-MR;fr-MU;fr-RE;fr-RW;fr-SC;fr-SN;fr-SY;&quot; +</a>
<a name="ln685">                &quot;fr-TD;fr-TN;fr-VU;fur;fy;ga;gd;gl;gsw;gu;guz;gv;ha;haw;he;hi;hr;hr-BA;hsb;hu;hy;ia;id;ig;ii;is;it;it-CH;ja;jgo;jmc;jv;ka;kab;kam;kde;kea;khq;ki;kk;kkj;kl;kln;&quot; +</a>
<a name="ln686">                &quot;km;kn;ko;ko-KP;kok;ks;ksb;ksf;ksh;ku;kw;ky;lag;lb;lg;lkt;ln;ln-AO;lo;lrc;lrc-IQ;lt;lu;luo;luy;lv;mas;mas-TZ;mer;mfe;mg;mgh;mgo;mi;mk;ml;mn;mni;mr;ms;ms-BN;ms-SG;&quot; +</a>
<a name="ln687">                &quot;mt;mua;my;mzn;naq;nb;nd;nds;nds-NL;ne;ne-IN;nl;nl-AW;nl-BE;nl-BQ;nl-CW;nl-SR;nl-SX;nmg;nn;nnh;nus;nyn;om;om-KE;or;os;os-RU;pa;pa-Arab;pl;prg;ps;ps-PK;pt;pt-AO;&quot; +</a>
<a name="ln688">                &quot;pt-CV;pt-GW;pt-LU;pt-MO;pt-MZ;pt-PT;pt-ST;pt-TL;rm;rn;ro;ro-MD;rof;ru;ru-BY;ru-KG;ru-KZ;ru-MD;ru-UA;rw;rwk;sah;saq;sbp;sd;sd-Deva;se;se-FI;se-SE;seh;ses;sg;shi;&quot; +</a>
<a name="ln689">                &quot;shi-Latn;si;sk;sl;smn;sn;so;so-DJ;so-ET;so-KE;sq;sq-MK;sq-XK;sr;sr-Cyrl-BA;sr-Cyrl-ME;sr-Cyrl-XK;sr-Latn;sr-Latn-BA;sr-Latn-ME;sr-Latn-XK;sv;sv-FI;sw;sw-CD;sw-KE;&quot; +</a>
<a name="ln690">                &quot;sw-UG;ta;ta-LK;ta-MY;ta-SG;te;teo;teo-KE;tg;th;ti;ti-ER;tk;to;tr;tr-CY;tt;twq;tzm;ug;uk;ur;ur-IN;uz;uz-Arab;uz-Cyrl;vai;vai-Latn;vi;vo;vun;wae;wo;xh;xog;yav;yi;yo;&quot; +</a>
<a name="ln691">                &quot;yo-BJ;zgh;zh;zh-Hans-HK;zh-Hans-MO;zh-Hant;zu&quot;).Split(';').ToList();</a>
<a name="ln692">    }</a>
<a name="ln693"> </a>
<a name="ln694">    private async Task&lt;IEnumerable&lt;string&gt;&gt; GetLanguageCodesAsync()</a>
<a name="ln695">    {</a>
<a name="ln696">        var path = await GetLanguageCodesPathAsync();</a>
<a name="ln697"> </a>
<a name="ln698">        if (string.IsNullOrEmpty(path))</a>
<a name="ln699">            throw new WebException(&quot;Can't get language codes. Path to language codes is null&quot;);</a>
<a name="ln700"> </a>
<a name="ln701">        var request = (HttpWebRequest)WebRequest.Create(path);</a>
<a name="ln702">        request.UserAgent = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393&quot;;</a>
<a name="ln703"> </a>
<a name="ln704">        var response = (HttpWebResponse)await request.GetResponseAsync();</a>
<a name="ln705"> </a>
<a name="ln706">        using (var resultStream = response.GetResponseStream())</a>
<a name="ln707">        {</a>
<a name="ln708">            if (resultStream == null)</a>
<a name="ln709">                throw new WebException(&quot;Empty response from server when getting language codes&quot;);</a>
<a name="ln710"> </a>
<a name="ln711">            using (var reader = new StreamReader(resultStream))</a>
<a name="ln712">            {</a>
<a name="ln713">                var result = await reader.ReadToEndAsync();</a>
<a name="ln714"> </a>
<a name="ln715">                var jsonReader = JsonReaderWriterFactory.CreateJsonReader(Encoding.UTF8.GetBytes(result),</a>
<a name="ln716">                    new System.Xml.XmlDictionaryReaderQuotas());</a>
<a name="ln717"> </a>
<a name="ln718">                var json = await Task&lt;XElement&gt;.Factory.StartNew(() =&gt; XElement.Load(jsonReader));</a>
<a name="ln719">                var languages = json.Elements();</a>
<a name="ln720"> </a>
<a name="ln721">                return await Task.Factory.StartNew(() =&gt; languages.Where(x =&gt; x.XPathSelectElement(&quot;defs&quot;).Value != &quot;0&quot;).Select(x =&gt; x.XPathSelectElement(&quot;lang&quot;).Value));</a>
<a name="ln722">            }</a>
<a name="ln723">        }</a>
<a name="ln724">    }</a>
<a name="ln725"> </a>
<a name="ln726">    private async Task&lt;string&gt; GetLanguageCodesPathAsync()</a>
<a name="ln727">    {</a>
<a name="ln728">        var request = (HttpWebRequest)WebRequest.Create(&quot;https://datahub.io/core/language-codes/datapackage.json&quot;);</a>
<a name="ln729">        request.UserAgent = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36 Edge/14.14393&quot;;</a>
<a name="ln730"> </a>
<a name="ln731">        var response = (HttpWebResponse)await request.GetResponseAsync();</a>
<a name="ln732"> </a>
<a name="ln733">        using (var resultStream = response.GetResponseStream())</a>
<a name="ln734">        {</a>
<a name="ln735">            if (resultStream == null)</a>
<a name="ln736">                throw new WebException(&quot;Empty response from server when getting language codes path&quot;);</a>
<a name="ln737"> </a>
<a name="ln738">            using (var reader = new StreamReader(resultStream))</a>
<a name="ln739">            {</a>
<a name="ln740">                var result = await reader.ReadToEndAsync();</a>
<a name="ln741"> </a>
<a name="ln742">                var jsonReader = JsonReaderWriterFactory.CreateJsonReader(Encoding.UTF8.GetBytes(result),</a>
<a name="ln743">                    new System.Xml.XmlDictionaryReaderQuotas());</a>
<a name="ln744"> </a>
<a name="ln745">                var json = await Task&lt;XElement&gt;.Factory.StartNew(() =&gt; XElement.Load(jsonReader));</a>
<a name="ln746"> </a>
<a name="ln747">                return await Task.Factory.StartNew(() =&gt; json.XPathSelectElement(&quot;resources&quot;).Elements().First(x =&gt; x.XPathSelectElement(&quot;name&quot;).Value == &quot;ietf-language-tags_json&quot;).XPathSelectElement(&quot;path&quot;).Value);</a>
<a name="ln748">            }</a>
<a name="ln749">        }</a>
<a name="ln750">    }</a>
<a name="ln751"> </a>
<a name="ln752">    #endregion</a>
<a name="ln753">}</a>
<a name="ln754"> </a>
<a name="ln755">internal class Culture</a>
<a name="ln756">{</a>
<a name="ln757">    public string Code { get; set; }</a>
<a name="ln758">    public string Name { get; set; }</a>
<a name="ln759">    public string CodeName =&gt; Code.PadRight(3) + &quot; - &quot; + Name;</a>
<a name="ln760">}</a>
<a name="ln761"> </a>
<a name="ln762">internal class Translation</a>
<a name="ln763">{</a>
<a name="ln764">    public string Key { get; set; }</a>
<a name="ln765">    public string BaseText { get; set; }</a>
<a name="ln766">    public string SpecificText { get; set; }</a>
<a name="ln767">}</a>
</code></pre>
<div class="balloon" rel="101"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3063/" target="_blank">V3063</a> A part of conditional expression is always false if it is evaluated: e.Key == Key.Enter.</p></div>
<div class="balloon" rel="175"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3063/" target="_blank">V3063</a> A part of conditional expression is always false if it is evaluated: e.Key == Key.Return.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>