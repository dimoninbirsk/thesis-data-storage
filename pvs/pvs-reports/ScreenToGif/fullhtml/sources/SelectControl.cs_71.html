<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>SelectControl.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">using System;</a>
<a name="ln2">using System.Collections.Generic;</a>
<a name="ln3">using System.Linq;</a>
<a name="ln4">using System.Windows;</a>
<a name="ln5">using System.Windows.Controls;</a>
<a name="ln6">using System.Windows.Controls.Primitives;</a>
<a name="ln7">using System.Windows.Input;</a>
<a name="ln8">using System.Windows.Media;</a>
<a name="ln9">using System.Windows.Media.Imaging;</a>
<a name="ln10">using System.Windows.Shapes;</a>
<a name="ln11">using Microsoft.Win32;</a>
<a name="ln12">using ScreenToGif.Domain.Enums;</a>
<a name="ln13">using ScreenToGif.Domain.Models;</a>
<a name="ln14">using ScreenToGif.Native.External;</a>
<a name="ln15">using ScreenToGif.Util;</a>
<a name="ln16">using ScreenToGif.Util.Extensions;</a>
<a name="ln17">using ScreenToGif.Util.Settings;</a>
<a name="ln18"> </a>
<a name="ln19">namespace ScreenToGif.Controls;</a>
<a name="ln20"> </a>
<a name="ln21">public class SelectControl : Control</a>
<a name="ln22">{</a>
<a name="ln23">    #region Variables</a>
<a name="ln24"> </a>
<a name="ln25">    /// &lt;summary&gt;</a>
<a name="ln26">    /// Resizing adorner uses Thumbs for visual elements.</a>
<a name="ln27">    /// The Thumbs have built-in mouse input handling.</a>
<a name="ln28">    /// &lt;/summary&gt;</a>
<a name="ln29">    private Thumb _topLeft, _topRight, _bottomLeft, _bottomRight, _top, _bottom, _left, _right;</a>
<a name="ln30"> </a>
<a name="ln31">    /// &lt;summary&gt;</a>
<a name="ln32">    /// The selection rectangle, used to drag the selection Rect elsewhere.</a>
<a name="ln33">    /// &lt;/summary&gt;</a>
<a name="ln34">    private Rectangle _rectangle;</a>
<a name="ln35"> </a>
<a name="ln36">    /// &lt;summary&gt;</a>
<a name="ln37">    /// The grid that holds the three buttons to control the selection.</a>
<a name="ln38">    /// &lt;/summary&gt;</a>
<a name="ln39">    private ExtendedUniformGrid _statusControlGrid;</a>
<a name="ln40"> </a>
<a name="ln41">    /// &lt;summary&gt;</a>
<a name="ln42">    /// The pre-calculated size of the horizontal and vertical versions of the status control grid.</a>
<a name="ln43">    /// &lt;/summary&gt;</a>
<a name="ln44">    private Size _statusHorizontalSize, _statusVerticalSize;</a>
<a name="ln45"> </a>
<a name="ln46">    /// &lt;summary&gt;</a>
<a name="ln47">    /// The grids that holds the zoomed image and size info.</a>
<a name="ln48">    /// &lt;/summary&gt;</a>
<a name="ln49">    private Grid _zoomGrid, _sizeGrid;</a>
<a name="ln50"> </a>
<a name="ln51">    //private readonly RegionMagnifier _regionMagnifier;</a>
<a name="ln52"> </a>
<a name="ln53">    /// &lt;summary&gt;</a>
<a name="ln54">    /// The zoomed image.</a>
<a name="ln55">    /// &lt;/summary&gt;</a>
<a name="ln56">    private Image _croppedImage;</a>
<a name="ln57"> </a>
<a name="ln58">    /// &lt;summary&gt;</a>
<a name="ln59">    /// The textblock that lies at the bottom of the zoom view.</a>
<a name="ln60">    /// &lt;/summary&gt;</a>
<a name="ln61">    private TextBlock _zoomTextBlock;</a>
<a name="ln62"> </a>
<a name="ln63">    /// &lt;summary&gt;</a>
<a name="ln64">    /// The main canvas, the root element.</a>
<a name="ln65">    /// &lt;/summary&gt;</a>
<a name="ln66">    private Canvas _mainCanvas;</a>
<a name="ln67"> </a>
<a name="ln68">    /// &lt;summary&gt;</a>
<a name="ln69">    /// Status control buttons.</a>
<a name="ln70">    /// &lt;/summary&gt;</a>
<a name="ln71">    private ExtendedButton _acceptButton, _retryButton, _cancelButton;</a>
<a name="ln72"> </a>
<a name="ln73">    ///// &lt;summary&gt;</a>
<a name="ln74">    ///// The texblock that shows the size of the selection.</a>
<a name="ln75">    ///// &lt;/summary&gt;</a>
<a name="ln76">    //private TextBlock _sizeTextBlock, _sizeNativeTextBlock;</a>
<a name="ln77"> </a>
<a name="ln78">    ///// &lt;summary&gt;</a>
<a name="ln79">    ///// The grid that holds the sizing controls.</a>
<a name="ln80">    ///// &lt;/summary&gt;</a>
<a name="ln81">    //private Grid _rectGrid;</a>
<a name="ln82"> </a>
<a name="ln83">    ///// &lt;summary&gt;</a>
<a name="ln84">    ///// The button that closes the sizing widget.</a>
<a name="ln85">    ///// &lt;/summary&gt;</a>
<a name="ln86">    //private ImageButton _closeRectButton;</a>
<a name="ln87"> </a>
<a name="ln88">    ///// &lt;summary&gt;</a>
<a name="ln89">    ///// The grid that enables the movement of the sizing widget.</a>
<a name="ln90">    ///// &lt;/summary&gt;</a>
<a name="ln91">    //private Grid _moveSizeWidgetGrid;</a>
<a name="ln92"> </a>
<a name="ln93">    /// &lt;summary&gt;</a>
<a name="ln94">    /// The start point for the drag operation.</a>
<a name="ln95">    /// &lt;/summary&gt;</a>
<a name="ln96">    private Point _startPoint;</a>
<a name="ln97"> </a>
<a name="ln98">    /// &lt;summary&gt;</a>
<a name="ln99">    /// Blind spots for the ZoomView. If the cursor is on top of any of this spots, the zoom view should not appear.</a>
<a name="ln100">    /// &lt;/summary&gt;</a>
<a name="ln101">    private readonly List&lt;Rect&gt; _blindSpots = new List&lt;Rect&gt;();</a>
<a name="ln102"> </a>
<a name="ln103">    /// &lt;summary&gt;</a>
<a name="ln104">    /// The latest window that contains the mouse cursor on top of it.</a>
<a name="ln105">    /// &lt;/summary&gt;</a>
<a name="ln106">    private DetectedRegion _hitTestWindow;</a>
<a name="ln107"> </a>
<a name="ln108">    /// &lt;summary&gt;</a>
<a name="ln109">    /// True when this control is ready to process mouse input when using the Screen/Window selection mode.</a>
<a name="ln110">    /// This was added because the event MouseMove was being fired before the method that adjusts the other controls finished. (TL;DR It was a race condition)</a>
<a name="ln111">    /// &lt;/summary&gt;</a>
<a name="ln112">    private bool _ready;</a>
<a name="ln113"> </a>
<a name="ln114">    /// &lt;summary&gt;</a>
<a name="ln115">    /// True if the hover focus was changed to this selector.</a>
<a name="ln116">    /// Other selectors must lose the hover focus.</a>
<a name="ln117">    /// This makes the zoom view to be hidden everywhere else.</a>
<a name="ln118">    /// &lt;/summary&gt;</a>
<a name="ln119">    private bool _wasHoverFocusChanged;</a>
<a name="ln120"> </a>
<a name="ln121">    public List&lt;DetectedRegion&gt; Windows = new List&lt;DetectedRegion&gt;();</a>
<a name="ln122"> </a>
<a name="ln123">    public BitmapSource BackImage;</a>
<a name="ln124"> </a>
<a name="ln125">    #endregion</a>
<a name="ln126"> </a>
<a name="ln127">    #region Dependency Properties</a>
<a name="ln128"> </a>
<a name="ln129">    public static readonly DependencyProperty ParentLeftProperty = DependencyProperty.Register(nameof(ParentLeft), typeof(double), typeof(SelectControl), new PropertyMetadata(0d));</a>
<a name="ln130"> </a>
<a name="ln131">    public static readonly DependencyProperty ParentTopProperty = DependencyProperty.Register(nameof(ParentTop), typeof(double), typeof(SelectControl), new PropertyMetadata(0d));</a>
<a name="ln132"> </a>
<a name="ln133">    public static readonly DependencyProperty IsPickingRegionProperty = DependencyProperty.Register(nameof(IsPickingRegion), typeof(bool), typeof(SelectControl), new PropertyMetadata(true));</a>
<a name="ln134"> </a>
<a name="ln135">    public static readonly DependencyProperty SelectedProperty = DependencyProperty.Register(nameof(Selected), typeof(Rect), typeof(SelectControl), new PropertyMetadata(Rect.Empty, Selected_PropertyChanged));</a>
<a name="ln136"> </a>
<a name="ln137">    public static readonly DependencyProperty NonExpandedSelectionProperty = DependencyProperty.Register(nameof(NonExpandedSelection), typeof(Rect), typeof(SelectControl), new PropertyMetadata(Rect.Empty));</a>
<a name="ln138"> </a>
<a name="ln139">    public static readonly DependencyProperty NonExpandedNativeSelectionProperty = DependencyProperty.Register(nameof(NonExpandedNativeSelection), typeof(Rect), typeof(SelectControl), new PropertyMetadata(Rect.Empty));</a>
<a name="ln140"> </a>
<a name="ln141">    public static readonly DependencyProperty FinishedSelectionProperty = DependencyProperty.Register(nameof(FinishedSelection), typeof(bool), typeof(SelectControl), new PropertyMetadata(false));</a>
<a name="ln142"> </a>
<a name="ln143">    public static readonly DependencyProperty ModeProperty = DependencyProperty.Register(nameof(Mode), typeof(ModeType), typeof(SelectControl), new PropertyMetadata(ModeType.Region));</a>
<a name="ln144"> </a>
<a name="ln145">    public static readonly DependencyProperty ScaleProperty = DependencyProperty.Register(nameof(Scale), typeof(double), typeof(SelectControl), new PropertyMetadata(1d));</a>
<a name="ln146"> </a>
<a name="ln147">    public static readonly DependencyProperty EmbeddedModeProperty = DependencyProperty.Register(nameof(EmbeddedMode), typeof(bool), typeof(SelectControl), new PropertyMetadata(false));</a>
<a name="ln148"> </a>
<a name="ln149">    public static readonly DependencyProperty AnimateBorderProperty = DependencyProperty.Register(nameof(AnimateBorder), typeof(bool), typeof(SelectControl), new PropertyMetadata(false));</a>
<a name="ln150"> </a>
<a name="ln151"> </a>
<a name="ln152">    public static readonly RoutedEvent MouseHoveringEvent = EventManager.RegisterRoutedEvent(nameof(MouseHovering), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(SelectControl));</a>
<a name="ln153"> </a>
<a name="ln154">    public static readonly RoutedEvent SelectionAcceptedEvent = EventManager.RegisterRoutedEvent(nameof(SelectionAccepted), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(SelectControl));</a>
<a name="ln155"> </a>
<a name="ln156">    public static readonly RoutedEvent SelectionChangedEvent = EventManager.RegisterRoutedEvent(nameof(SelectionChanged), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(SelectControl));</a>
<a name="ln157"> </a>
<a name="ln158">    public static readonly RoutedEvent SelectionCanceledEvent = EventManager.RegisterRoutedEvent(nameof(SelectionCanceled), RoutingStrategy.Bubble, typeof(RoutedEventHandler), typeof(SelectControl));</a>
<a name="ln159"> </a>
<a name="ln160">    #endregion</a>
<a name="ln161"> </a>
<a name="ln162">    #region Properties</a>
<a name="ln163"> </a>
<a name="ln164">    public double ParentLeft</a>
<a name="ln165">    {</a>
<a name="ln166">        get =&gt; (double)GetValue(ParentLeftProperty);</a>
<a name="ln167">        set =&gt; SetValue(ParentLeftProperty, value);</a>
<a name="ln168">    }</a>
<a name="ln169"> </a>
<a name="ln170">    public double ParentTop</a>
<a name="ln171">    {</a>
<a name="ln172">        get =&gt; (double)GetValue(ParentTopProperty);</a>
<a name="ln173">        set =&gt; SetValue(ParentTopProperty, value);</a>
<a name="ln174">    }</a>
<a name="ln175"> </a>
<a name="ln176">    public bool IsPickingRegion</a>
<a name="ln177">    {</a>
<a name="ln178">        get =&gt; (bool)GetValue(IsPickingRegionProperty);</a>
<a name="ln179">        set =&gt; SetValue(IsPickingRegionProperty, value);</a>
<a name="ln180">    }</a>
<a name="ln181"> </a>
<a name="ln182">    public Rect Selected</a>
<a name="ln183">    {</a>
<a name="ln184">        get =&gt; (Rect)GetValue(SelectedProperty);</a>
<a name="ln185">        set =&gt; SetValue(SelectedProperty, value);</a>
<a name="ln186">    }</a>
<a name="ln187"> </a>
<a name="ln188">    public Rect NonExpandedSelection</a>
<a name="ln189">    {</a>
<a name="ln190">        get =&gt; (Rect)GetValue(NonExpandedSelectionProperty);</a>
<a name="ln191">        set =&gt; SetValue(NonExpandedSelectionProperty, value);</a>
<a name="ln192">    }</a>
<a name="ln193"> </a>
<a name="ln194">    public Rect NonExpandedNativeSelection</a>
<a name="ln195">    {</a>
<a name="ln196">        get =&gt; (Rect)GetValue(NonExpandedNativeSelectionProperty);</a>
<a name="ln197">        set =&gt; SetValue(NonExpandedNativeSelectionProperty, value);</a>
<a name="ln198">    }</a>
<a name="ln199"> </a>
<a name="ln200">    public bool FinishedSelection</a>
<a name="ln201">    {</a>
<a name="ln202">        get =&gt; (bool)GetValue(FinishedSelectionProperty);</a>
<a name="ln203">        set =&gt; SetValue(FinishedSelectionProperty, value);</a>
<a name="ln204">    }</a>
<a name="ln205"> </a>
<a name="ln206">    public ModeType Mode</a>
<a name="ln207">    {</a>
<a name="ln208">        get =&gt; (ModeType)GetValue(ModeProperty);</a>
<a name="ln209">        set =&gt; SetValue(ModeProperty, value);</a>
<a name="ln210">    }</a>
<a name="ln211"> </a>
<a name="ln212">    public double Scale</a>
<a name="ln213">    {</a>
<a name="ln214">        get =&gt; (double)GetValue(ScaleProperty);</a>
<a name="ln215">        set =&gt; SetValue(ScaleProperty, value);</a>
<a name="ln216">    }</a>
<a name="ln217"> </a>
<a name="ln218">    public bool EmbeddedMode</a>
<a name="ln219">    {</a>
<a name="ln220">        get =&gt; (bool)GetValue(EmbeddedModeProperty);</a>
<a name="ln221">        set =&gt; SetValue(EmbeddedModeProperty, value);</a>
<a name="ln222">    }</a>
<a name="ln223"> </a>
<a name="ln224">    public bool AnimateBorder</a>
<a name="ln225">    {</a>
<a name="ln226">        get =&gt; (bool)GetValue(AnimateBorderProperty);</a>
<a name="ln227">        set =&gt; SetValue(AnimateBorderProperty, value);</a>
<a name="ln228">    }</a>
<a name="ln229"> </a>
<a name="ln230"> </a>
<a name="ln231">    public event RoutedEventHandler MouseHovering</a>
<a name="ln232">    {</a>
<a name="ln233">        add =&gt; AddHandler(MouseHoveringEvent, value);</a>
<a name="ln234">        remove =&gt; RemoveHandler(MouseHoveringEvent, value);</a>
<a name="ln235">    }</a>
<a name="ln236"> </a>
<a name="ln237">    public event RoutedEventHandler SelectionAccepted</a>
<a name="ln238">    {</a>
<a name="ln239">        add =&gt; AddHandler(SelectionAcceptedEvent, value);</a>
<a name="ln240">        remove =&gt; RemoveHandler(SelectionAcceptedEvent, value);</a>
<a name="ln241">    }</a>
<a name="ln242"> </a>
<a name="ln243">    public event RoutedEventHandler SelectionChanged</a>
<a name="ln244">    {</a>
<a name="ln245">        add =&gt; AddHandler(SelectionChangedEvent, value);</a>
<a name="ln246">        remove =&gt; RemoveHandler(SelectionChangedEvent, value);</a>
<a name="ln247">    }</a>
<a name="ln248"> </a>
<a name="ln249">    public event RoutedEventHandler SelectionCanceled</a>
<a name="ln250">    {</a>
<a name="ln251">        add =&gt; AddHandler(SelectionCanceledEvent, value);</a>
<a name="ln252">        remove =&gt; RemoveHandler(SelectionCanceledEvent, value);</a>
<a name="ln253">    }</a>
<a name="ln254"> </a>
<a name="ln255">    #endregion</a>
<a name="ln256"> </a>
<a name="ln257">    static SelectControl()</a>
<a name="ln258">    {</a>
<a name="ln259">        DefaultStyleKeyProperty.OverrideMetadata(typeof(SelectControl), new FrameworkPropertyMetadata(typeof(SelectControl)));</a>
<a name="ln260">    }</a>
<a name="ln261"> </a>
<a name="ln262">    #region Overrides</a>
<a name="ln263"> </a>
<a name="ln264">    public override void OnApplyTemplate()</a>
<a name="ln265">    {</a>
<a name="ln266">        base.OnApplyTemplate();</a>
<a name="ln267"> </a>
<a name="ln268">        _mainCanvas = Template.FindName(&quot;MainCanvas&quot;, this) as Canvas;</a>
<a name="ln269"> </a>
<a name="ln270">        _topLeft = Template.FindName(&quot;TopLeftThumb&quot;, this) as Thumb;</a>
<a name="ln271">        _topRight = Template.FindName(&quot;TopRightThumb&quot;, this) as Thumb;</a>
<a name="ln272">        _bottomLeft = Template.FindName(&quot;BottomLeftThumb&quot;, this) as Thumb;</a>
<a name="ln273">        _bottomRight = Template.FindName(&quot;BottomRightThumb&quot;, this) as Thumb;</a>
<a name="ln274"> </a>
<a name="ln275">        _top = Template.FindName(&quot;TopThumb&quot;, this) as Thumb;</a>
<a name="ln276">        _bottom = Template.FindName(&quot;BottomThumb&quot;, this) as Thumb;</a>
<a name="ln277">        _left = Template.FindName(&quot;LeftThumb&quot;, this) as Thumb;</a>
<a name="ln278">        _right = Template.FindName(&quot;RightThumb&quot;, this) as Thumb;</a>
<a name="ln279"> </a>
<a name="ln280">        _rectangle = Template.FindName(&quot;SelectRectangle&quot;, this) as Rectangle;</a>
<a name="ln281">        _statusControlGrid = Template.FindName(&quot;StatusControlGrid&quot;, this) as ExtendedUniformGrid;</a>
<a name="ln282">        _acceptButton = Template.FindName(&quot;AcceptButton&quot;, this) as ExtendedButton;</a>
<a name="ln283">        _retryButton = Template.FindName(&quot;RetryButton&quot;, this) as ExtendedButton;</a>
<a name="ln284">        _cancelButton = Template.FindName(&quot;CancelButton&quot;, this) as ExtendedButton;</a>
<a name="ln285"> </a>
<a name="ln286">        _zoomGrid = Template.FindName(&quot;ZoomGrid&quot;, this) as Grid;</a>
<a name="ln287">        _croppedImage = Template.FindName(&quot;CroppedImage&quot;, this) as Image;</a>
<a name="ln288">        _zoomTextBlock = Template.FindName(&quot;ZoomTextBlock&quot;, this) as TextBlock;</a>
<a name="ln289">        _sizeGrid = Template.FindName(&quot;SizeGrid&quot;, this) as Grid;</a>
<a name="ln290">        //_sizeTextBlock = Template.FindName(&quot;SizeTextBlock&quot;, this) as TextBlock;</a>
<a name="ln291">        //_sizeNativeTextBlock = Template.FindName(&quot;NativeSizeTextBlock&quot;, this) as TextBlock;</a>
<a name="ln292"> </a>
<a name="ln293">        //_rectGrid = Template.FindName(&quot;RectGrid&quot;, this) as Grid;</a>
<a name="ln294">        //_closeRectButton = Template.FindName(&quot;CloseSizeWidgetButton&quot;, this) as ImageButton;</a>
<a name="ln295">        //_moveSizeWidgetGrid = Template.FindName(&quot;MoveSizeWidgetGrid&quot;, this) as Grid;</a>
<a name="ln296"> </a>
<a name="ln297">        Loaded += Control_Loaded;</a>
<a name="ln298">        Unloaded += Control_Unloaded;</a>
<a name="ln299">        SystemEvents.DisplaySettingsChanged += SystemEvents_DisplaySettingsChanged;</a>
<a name="ln300"> </a>
<a name="ln301">        //Add handlers for resizing • Corners.</a>
<a name="ln302">        _topLeft.DragDelta += HandleTopLeft;</a>
<a name="ln303">        _topRight.DragDelta += HandleTopRight;</a>
<a name="ln304">        _bottomLeft.DragDelta += HandleBottomLeft;</a>
<a name="ln305">        _bottomRight.DragDelta += HandleBottomRight;</a>
<a name="ln306"> </a>
<a name="ln307">        //Add handlers for resizing • Sides.</a>
<a name="ln308">        _top.DragDelta += HandleTop;</a>
<a name="ln309">        _bottom.DragDelta += HandleBottom;</a>
<a name="ln310">        _left.DragDelta += HandleLeft;</a>
<a name="ln311">        _right.DragDelta += HandleRight;</a>
<a name="ln312"> </a>
<a name="ln313">        //Drag to move.</a>
<a name="ln314">        _rectangle.MouseLeftButtonDown += Rectangle_MouseLeftButtonDown;</a>
<a name="ln315">        _rectangle.MouseMove += Rectangle_MouseMove;</a>
<a name="ln316">        _rectangle.MouseLeftButtonUp += Rectangle_MouseLeftButtonUp;</a>
<a name="ln317"> </a>
<a name="ln318">        _acceptButton.Click += (sender, e) =&gt; { Accept(); };</a>
<a name="ln319">        _retryButton.Click += (sender, e) =&gt; { Retry(); };</a>
<a name="ln320">        _cancelButton.Click += (sender, e) =&gt; { Cancel(); };</a>
<a name="ln321"> </a>
<a name="ln322">        //Replace with singleton property.</a>
<a name="ln323">        //if (_regionMagnifier == null)</a>
<a name="ln324">        //_regionMagnifier = new RegionMagnifier();</a>
<a name="ln325"> </a>
<a name="ln326">        //Enable sizing controls.</a>
<a name="ln327">        //if (!EmbeddedMode)</a>
<a name="ln328">        //{</a>
<a name="ln329">        //    _sizeTextBlock.PreviewMouseLeftButtonDown += SizeTextBlock_MouseUp;</a>
<a name="ln330">        //    _sizeTextBlock.IsHitTestVisible = true;</a>
<a name="ln331">        //    _sizeTextBlock.Cursor = Cursors.Hand;</a>
<a name="ln332">        //}</a>
<a name="ln333">    }</a>
<a name="ln334"> </a>
<a name="ln335">    protected override void OnMouseLeftButtonDown(MouseButtonEventArgs e)</a>
<a name="ln336">    {</a>
<a name="ln337">        _startPoint = e.GetPosition(this);</a>
<a name="ln338"> </a>
<a name="ln339">        if (Mode == ModeType.Region)</a>
<a name="ln340">        {</a>
<a name="ln341">            Selected = new Rect(e.GetPosition(this), new Size(0, 0));</a>
<a name="ln342">            FinishedSelection = false;</a>
<a name="ln343"> </a>
<a name="ln344">            CaptureMouse();</a>
<a name="ln345"> </a>
<a name="ln346">            AdjustStatusControls();</a>
<a name="ln347">            AdjustFlowControls();</a>
<a name="ln348">            DetectBlindSpots();</a>
<a name="ln349">        }</a>
<a name="ln350">        else</a>
<a name="ln351">        {</a>
<a name="ln352">            if (Selected.Width &gt; 0 &amp;&amp; Selected.Height &gt; 0)</a>
<a name="ln353">            {</a>
<a name="ln354">                if (Mode == ModeType.Window &amp;&amp; _hitTestWindow != null)</a>
<a name="ln355">                    User32.SetForegroundWindow(_hitTestWindow.Handle);</a>
<a name="ln356"> </a>
<a name="ln357">                Selected = Selected.Offset(-1);</a>
<a name="ln358">                RaiseAcceptedEvent();</a>
<a name="ln359">            }</a>
<a name="ln360">        }</a>
<a name="ln361"> </a>
<a name="ln362">        e.Handled = true;</a>
<a name="ln363">        base.OnMouseLeftButtonDown(e);</a>
<a name="ln364">    }</a>
<a name="ln365"> </a>
<a name="ln366">    protected override void OnMouseRightButtonDown(MouseButtonEventArgs e)</a>
<a name="ln367">    {</a>
<a name="ln368">        if (Mode == ModeType.Region)</a>
<a name="ln369">            Retry();</a>
<a name="ln370"> </a>
<a name="ln371">        e.Handled = true;</a>
<a name="ln372">        base.OnMouseLeftButtonDown(e);</a>
<a name="ln373">    }</a>
<a name="ln374"> </a>
<a name="ln375">    protected override void OnMouseMove(MouseEventArgs e)</a>
<a name="ln376">    {</a>
<a name="ln377">        if (Mode == ModeType.Region)</a>
<a name="ln378">        {</a>
<a name="ln379">            var current = e.GetPosition(this);</a>
<a name="ln380"> </a>
<a name="ln381">            AdjustZoomView(current);</a>
<a name="ln382"> </a>
<a name="ln383">            if (!IsMouseCaptured || e.LeftButton != MouseButtonState.Pressed)</a>
<a name="ln384">                return;</a>
<a name="ln385"> </a>
<a name="ln386">            // Move 1 pixel to current the position of the selection to the cursor.</a>
<a name="ln387">            current.X++;</a>
<a name="ln388">            current.Y++;</a>
<a name="ln389"> </a>
<a name="ln390">            if (current.X &lt; -1)</a>
<a name="ln391">                current.X = -1;</a>
<a name="ln392"> </a>
<a name="ln393">            if (current.Y &lt; -1)</a>
<a name="ln394">                current.Y = -1;</a>
<a name="ln395"> </a>
<a name="ln396">            if (current.X &gt; ActualWidth)</a>
<a name="ln397">                current.X = ActualWidth;</a>
<a name="ln398"> </a>
<a name="ln399">            if (current.Y &gt; ActualHeight)</a>
<a name="ln400">                current.Y = ActualHeight;</a>
<a name="ln401"> </a>
<a name="ln402">            Selected = new Rect(Math.Min(current.X, _startPoint.X), Math.Min(current.Y, _startPoint.Y), Math.Abs(current.X - _startPoint.X), Math.Abs(current.Y - _startPoint.Y));</a>
<a name="ln403"> </a>
<a name="ln404">            AdjustInfo(current);</a>
<a name="ln405">        }</a>
<a name="ln406">        else if (_ready)</a>
<a name="ln407">        {</a>
<a name="ln408">            var current = e.GetPosition(this);</a>
<a name="ln409"> </a>
<a name="ln410">            _hitTestWindow = Windows.FirstOrDefault(x =&gt; x.Bounds.Contains(current));</a>
<a name="ln411">            Selected = _hitTestWindow?.Bounds ?? Rect.Empty;</a>
<a name="ln412"> </a>
<a name="ln413">            AdjustInfo(current);</a>
<a name="ln414">        }</a>
<a name="ln415"> </a>
<a name="ln416">        base.OnMouseMove(e);</a>
<a name="ln417">    }</a>
<a name="ln418"> </a>
<a name="ln419">    protected override void OnMouseLeftButtonUp(MouseButtonEventArgs e)</a>
<a name="ln420">    {</a>
<a name="ln421">        if (Mode == ModeType.Region)</a>
<a name="ln422">        {</a>
<a name="ln423">            ReleaseMouseCapture();</a>
<a name="ln424"> </a>
<a name="ln425">            if (Selected.Width &lt; 30 || Selected.Height &lt; 30)</a>
<a name="ln426">            {</a>
<a name="ln427">                OnMouseRightButtonDown(e);</a>
<a name="ln428">                return;</a>
<a name="ln429">            }</a>
<a name="ln430"> </a>
<a name="ln431">            FinishedSelection = true;</a>
<a name="ln432"> </a>
<a name="ln433">            AdjustThumbs();</a>
<a name="ln434">            AdjustStatusControls(e.GetPosition(this));</a>
<a name="ln435">            AdjustFlowControls();</a>
<a name="ln436">            DetectBlindSpots();</a>
<a name="ln437">        }</a>
<a name="ln438"> </a>
<a name="ln439">        //e.Handled = true;</a>
<a name="ln440">        base.OnMouseLeftButtonUp(e);</a>
<a name="ln441">    }</a>
<a name="ln442"> </a>
<a name="ln443">    protected override void OnPreviewKeyDown(KeyEventArgs e)</a>
<a name="ln444">    {</a>
<a name="ln445">        //Apparently, this event is not triggered.</a>
<a name="ln446">        if (e.Key == Key.Escape)</a>
<a name="ln447">            Cancel();</a>
<a name="ln448"> </a>
<a name="ln449">        if (e.Key == Key.Enter || e.Key == Key.Return)</a>
<a name="ln450">            Accept();</a>
<a name="ln451"> </a>
<a name="ln452">        e.Handled = true;</a>
<a name="ln453">        base.OnPreviewKeyDown(e);</a>
<a name="ln454"> </a>
<a name="ln455">        if (Mode != ModeType.Region || Selected.IsEmpty)</a>
<a name="ln456">            return;</a>
<a name="ln457"> </a>
<a name="ln458">        var step = (Keyboard.Modifiers &amp; ModifierKeys.Alt) != 0 ? 5 : 1;</a>
<a name="ln459">        var key = e.Key == Key.System ? e.SystemKey : e.Key;</a>
<a name="ln460"> </a>
<a name="ln461">        //Control + Shift: Expand both ways.</a>
<a name="ln462">        if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0 &amp;&amp; (Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0)</a>
<a name="ln463">        {</a>
<a name="ln464">            switch (key)</a>
<a name="ln465">            {</a>
<a name="ln466">                case Key.Up:</a>
<a name="ln467">                    HandleBottom(_bottom, new DragDeltaEventArgs(0, step));</a>
<a name="ln468">                    HandleTop(_top, new DragDeltaEventArgs(0, -step));</a>
<a name="ln469">                    break;</a>
<a name="ln470">                case Key.Down:</a>
<a name="ln471">                    HandleBottom(_bottom, new DragDeltaEventArgs(0, -step));</a>
<a name="ln472">                    HandleTop(_top, new DragDeltaEventArgs(0, step));</a>
<a name="ln473">                    break;</a>
<a name="ln474">                case Key.Left:</a>
<a name="ln475">                    HandleRight(_right, new DragDeltaEventArgs(-step, 0));</a>
<a name="ln476">                    HandleLeft(_left, new DragDeltaEventArgs(step, 0));</a>
<a name="ln477">                    break;</a>
<a name="ln478">                case Key.Right:</a>
<a name="ln479">                    HandleRight(_right, new DragDeltaEventArgs(step, 0));</a>
<a name="ln480">                    HandleLeft(_left, new DragDeltaEventArgs(-step, 0));</a>
<a name="ln481">                    break;</a>
<a name="ln482">            }</a>
<a name="ln483">        }</a>
<a name="ln484">        else if ((Keyboard.Modifiers &amp; ModifierKeys.Shift) != 0) //If the Shift key is pressed, the sizing mode is enabled (bottom right).</a>
<a name="ln485">        {</a>
<a name="ln486">            switch (key)</a>
<a name="ln487">            {</a>
<a name="ln488">                case Key.Up:</a>
<a name="ln489">                    HandleBottom(_bottom, new DragDeltaEventArgs(0, -step));</a>
<a name="ln490">                    break;</a>
<a name="ln491">                case Key.Down:</a>
<a name="ln492">                    HandleBottom(_bottom, new DragDeltaEventArgs(0, step));</a>
<a name="ln493">                    break;</a>
<a name="ln494">                case Key.Left:</a>
<a name="ln495">                    HandleRight(_right, new DragDeltaEventArgs(-step, 0));</a>
<a name="ln496">                    break;</a>
<a name="ln497">                case Key.Right:</a>
<a name="ln498">                    HandleRight(_right, new DragDeltaEventArgs(step, 0));</a>
<a name="ln499">                    break;</a>
<a name="ln500">            }</a>
<a name="ln501">        }</a>
<a name="ln502">        else if ((Keyboard.Modifiers &amp; ModifierKeys.Control) != 0) //If the Control key is pressed, the sizing mode is enabled (top left).</a>
<a name="ln503">        {</a>
<a name="ln504">            switch (key)</a>
<a name="ln505">            {</a>
<a name="ln506">                case Key.Up:</a>
<a name="ln507">                    HandleTop(_top, new DragDeltaEventArgs(0, -step));</a>
<a name="ln508">                    break;</a>
<a name="ln509">                case Key.Down:</a>
<a name="ln510">                    HandleTop(_top, new DragDeltaEventArgs(0, step));</a>
<a name="ln511">                    break;</a>
<a name="ln512">                case Key.Left:</a>
<a name="ln513">                    HandleLeft(_left, new DragDeltaEventArgs(-step, 0));</a>
<a name="ln514">                    break;</a>
<a name="ln515">                case Key.Right:</a>
<a name="ln516">                    HandleLeft(_left, new DragDeltaEventArgs(step, 0));</a>
<a name="ln517">                    break;</a>
<a name="ln518">            }</a>
<a name="ln519">        }</a>
<a name="ln520">        else</a>
<a name="ln521">        {</a>
<a name="ln522">            switch (key) //If no other key is pressed, the movement mode is enabled.</a>
<a name="ln523">            {</a>
<a name="ln524">                case Key.Up:</a>
<a name="ln525">                    HandleCenter(new DragDeltaEventArgs(0, -step));</a>
<a name="ln526">                    break;</a>
<a name="ln527">                case Key.Down:</a>
<a name="ln528">                    HandleCenter(new DragDeltaEventArgs(0, step));</a>
<a name="ln529">                    break;</a>
<a name="ln530">                case Key.Left:</a>
<a name="ln531">                    HandleCenter(new DragDeltaEventArgs(-step, 0));</a>
<a name="ln532">                    break;</a>
<a name="ln533">                case Key.Right:</a>
<a name="ln534">                    HandleCenter(new DragDeltaEventArgs(step, 0));</a>
<a name="ln535">                    break;</a>
<a name="ln536">            }</a>
<a name="ln537">        }</a>
<a name="ln538">    }</a>
<a name="ln539"> </a>
<a name="ln540">    #endregion</a>
<a name="ln541"> </a>
<a name="ln542">    #region Methods</a>
<a name="ln543"> </a>
<a name="ln544">    private void AdjustSelection()</a>
<a name="ln545">    {</a>
<a name="ln546">        //If already opened with a region selected, treat as &quot;already selected&quot;.</a>
<a name="ln547">        if (Selected == Rect.Empty)</a>
<a name="ln548">            return;</a>
<a name="ln549"> </a>
<a name="ln550">        FinishedSelection = true;</a>
<a name="ln551"> </a>
<a name="ln552">        var point = Mouse.GetPosition(this);</a>
<a name="ln553"> </a>
<a name="ln554">        AdjustThumbs();</a>
<a name="ln555">        AdjustStatusControls(point);</a>
<a name="ln556">        AdjustFlowControls();</a>
<a name="ln557">        DetectBlindSpots();</a>
<a name="ln558">        AdjustInfo(point);</a>
<a name="ln559">    }</a>
<a name="ln560"> </a>
<a name="ln561">    private void AdjustThumbs()</a>
<a name="ln562">    {</a>
<a name="ln563">        //Top left.</a>
<a name="ln564">        Canvas.SetLeft(_topLeft, Selected.Left - _topLeft.Width / 2);</a>
<a name="ln565">        Canvas.SetTop(_topLeft, Selected.Top - _topLeft.Height / 2);</a>
<a name="ln566"> </a>
<a name="ln567">        //Top right.</a>
<a name="ln568">        Canvas.SetLeft(_topRight, Selected.Right - _topRight.Width / 2);</a>
<a name="ln569">        Canvas.SetTop(_topRight, Selected.Top - _topRight.Height / 2);</a>
<a name="ln570"> </a>
<a name="ln571">        //Bottom left.</a>
<a name="ln572">        Canvas.SetLeft(_bottomLeft, Selected.Left - _bottomLeft.Width / 2);</a>
<a name="ln573">        Canvas.SetTop(_bottomLeft, Selected.Bottom - _bottomLeft.Height / 2);</a>
<a name="ln574"> </a>
<a name="ln575">        //Bottom right.</a>
<a name="ln576">        Canvas.SetLeft(_bottomRight, Selected.Right - _bottomRight.Width / 2);</a>
<a name="ln577">        Canvas.SetTop(_bottomRight, Selected.Bottom - _bottomRight.Height / 2);</a>
<a name="ln578"> </a>
<a name="ln579">        //Top.</a>
<a name="ln580">        Canvas.SetLeft(_top, Selected.Left + Selected.Width / 2 - _top.Width / 2);</a>
<a name="ln581">        Canvas.SetTop(_top, Selected.Top - _top.Height / 2);</a>
<a name="ln582"> </a>
<a name="ln583">        //Left.</a>
<a name="ln584">        Canvas.SetLeft(_left, Selected.Left - _left.Width / 2);</a>
<a name="ln585">        Canvas.SetTop(_left, Selected.Top + Selected.Height / 2 - _left.Height / 2);</a>
<a name="ln586"> </a>
<a name="ln587">        //Right.</a>
<a name="ln588">        Canvas.SetLeft(_right, Selected.Right - _right.Width / 2);</a>
<a name="ln589">        Canvas.SetTop(_right, Selected.Top + Selected.Height / 2 - _right.Height / 2);</a>
<a name="ln590"> </a>
<a name="ln591">        //Bottom.</a>
<a name="ln592">        Canvas.SetLeft(_bottom, Selected.Left + Selected.Width / 2 - _bottom.Width / 2);</a>
<a name="ln593">        Canvas.SetTop(_bottom, Selected.Bottom - _bottom.Height / 2);</a>
<a name="ln594">    }</a>
<a name="ln595"> </a>
<a name="ln596">    private void AdjustZoomView(Point point)</a>
<a name="ln597">    {</a>
<a name="ln598">        //_bottom.IsVisible</a>
<a name="ln599">        if (BackImage == null || Mode != ModeType.Region || !UserSettings.All.Magnifier || (Selected.Width &gt; 10 &amp;&amp; Selected.Height &gt; 10 &amp;&amp; Selected.Offset(5).Contains(point)) || _blindSpots.Any(x =&gt; x.Contains(point)))</a>
<a name="ln600">        {</a>
<a name="ln601">            _zoomGrid.Visibility = Visibility.Hidden;</a>
<a name="ln602">            return;</a>
<a name="ln603">        }</a>
<a name="ln604"> </a>
<a name="ln605">        //If this selector got the hover, the other selectors must hide their zoom views.</a>
<a name="ln606">        if (!_wasHoverFocusChanged)</a>
<a name="ln607">        {</a>
<a name="ln608">            _wasHoverFocusChanged = true;</a>
<a name="ln609">            RaiseMouseHoveringEvent();</a>
<a name="ln610">        }</a>
<a name="ln611"> </a>
<a name="ln612">        var scaledPoint = point.Scale(Scale);</a>
<a name="ln613">        var scaledSize = (int)Math.Round(15 * Scale, MidpointRounding.AwayFromZero);</a>
<a name="ln614"> </a>
<a name="ln615">        try</a>
<a name="ln616">        {</a>
<a name="ln617">            //When using multiple monitors, the mouse cursor can paqss to another screen. This makes sure that to only get a valid screen position.</a>
<a name="ln618">            if (scaledPoint.X &lt; 0 || scaledPoint.Y &lt; 0 || scaledPoint.X + scaledSize &gt; BackImage.PixelWidth || scaledPoint.Y + scaledSize &gt; BackImage.PixelHeight)</a>
<a name="ln619">            {</a>
<a name="ln620">                _zoomGrid.Visibility = Visibility.Hidden;</a>
<a name="ln621">                return;</a>
<a name="ln622">            }</a>
<a name="ln623"> </a>
<a name="ln624">            //The image is already 7 pixels offset of the current position.</a>
<a name="ln625">            _croppedImage.Source = new CroppedBitmap(BackImage, new Int32Rect((int)scaledPoint.X, (int)scaledPoint.Y, scaledSize, scaledSize));</a>
<a name="ln626">        }</a>
<a name="ln627">        catch (Exception)</a>
<a name="ln628">        { }</a>
<a name="ln629"> </a>
<a name="ln630">        var left = point.X + 20;</a>
<a name="ln631">        var top = point.Y - _zoomGrid.ActualHeight - 20;</a>
<a name="ln632"> </a>
<a name="ln633">        //Right overflow, adjust to the left.</a>
<a name="ln634">        if (ActualWidth - point.X &lt; _zoomGrid.ActualWidth + 20)</a>
<a name="ln635">            left = point.X - _zoomGrid.ActualWidth - 20;</a>
<a name="ln636"> </a>
<a name="ln637">        //Top overflow, adjust to the bottom.</a>
<a name="ln638">        if (point.Y - _zoomGrid.ActualHeight - 20 &lt; 0)</a>
<a name="ln639">            top = point.Y + 20;</a>
<a name="ln640"> </a>
<a name="ln641">        Canvas.SetLeft(_zoomGrid, left);</a>
<a name="ln642">        Canvas.SetTop(_zoomGrid, top);</a>
<a name="ln643"> </a>
<a name="ln644">        _zoomTextBlock.Text = $&quot;X: {Math.Round(point.X + ParentLeft, 2)} ◇ Y: {Math.Round(point.Y + ParentTop, 2)}&quot;;</a>
<a name="ln645">        _zoomGrid.Visibility = Visibility.Visible;</a>
<a name="ln646">    }</a>
<a name="ln647"> </a>
<a name="ln648">    private void AdjustZoomViewDetached(Point point)</a>
<a name="ln649">    {</a>
<a name="ln650">        //If it should not display the zoom view.</a>
<a name="ln651">        if (BackImage == null || Mode != ModeType.Region || !UserSettings.All.Magnifier || (Selected.Width &gt; 10 &amp;&amp; Selected.Height &gt; 10 &amp;&amp; Selected.Offset(5).Contains(point)) || _blindSpots.Any(x =&gt; x.Contains(point)))</a>
<a name="ln652">        {</a>
<a name="ln653">            //_regionMagnifier.Hide();</a>
<a name="ln654">            return;</a>
<a name="ln655">        }</a>
<a name="ln656"> </a>
<a name="ln657">        //If this selector got the hover, the other selectors must hide their zoom views.</a>
<a name="ln658">        if (!_wasHoverFocusChanged)</a>
<a name="ln659">        {</a>
<a name="ln660">            _wasHoverFocusChanged = true;</a>
<a name="ln661">            RaiseMouseHoveringEvent();</a>
<a name="ln662">        }</a>
<a name="ln663"> </a>
<a name="ln664">        #region Get the zoommed-in part of the image</a>
<a name="ln665"> </a>
<a name="ln666">        //var scaledPoint = point.Scale(Scale);</a>
<a name="ln667">        //var scaledSize = (int)Math.Round(15 * Scale, MidpointRounding.AwayFromZero);</a>
<a name="ln668"> </a>
<a name="ln669">        try</a>
<a name="ln670">        {</a>
<a name="ln671">            //The image is already 7 pixels offset of the current position.</a>
<a name="ln672">            //_regionMagnifier.Image = new CroppedBitmap(BackImage, new Int32Rect((int)scaledPoint.X, (int)scaledPoint.Y, scaledSize, scaledSize));</a>
<a name="ln673">        }</a>
<a name="ln674">        catch (Exception)</a>
<a name="ln675">        { }</a>
<a name="ln676"> </a>
<a name="ln677">        #endregion</a>
<a name="ln678"> </a>
<a name="ln679">        //if (!_regionMagnifier.IsVisible)</a>
<a name="ln680">        //    _regionMagnifier.Show();</a>
<a name="ln681"> </a>
<a name="ln682">        #region Reposition the zoom view</a>
<a name="ln683"> </a>
<a name="ln684">        //var left = point.X + 20;</a>
<a name="ln685">        //var top = point.Y - _regionMagnifier.ActualHeight - 20;</a>
<a name="ln686"> </a>
<a name="ln687">        ////Right overflow, adjust to the left.</a>
<a name="ln688">        //if (ActualWidth - point.X &lt; _regionMagnifier.ActualWidth + 20)</a>
<a name="ln689">        //    left = point.X - _regionMagnifier.ActualWidth - 20;</a>
<a name="ln690"> </a>
<a name="ln691">        ////Top overflow, adjust to the bottom.</a>
<a name="ln692">        //if (point.Y - _regionMagnifier.ActualHeight - 20 &lt; 0)</a>
<a name="ln693">        //    top = point.Y + 20;</a>
<a name="ln694"> </a>
<a name="ln695">        //_regionMagnifier.Left = left + ParentLeft;</a>
<a name="ln696">        //_regionMagnifier.Top = top + ParentTop;</a>
<a name="ln697">        //_regionMagnifier.LeftPosition = point.X + ParentLeft;</a>
<a name="ln698">        //_regionMagnifier.TopPosition = point.Y + ParentTop;</a>
<a name="ln699"> </a>
<a name="ln700">        #endregion</a>
<a name="ln701">    }</a>
<a name="ln702"> </a>
<a name="ln703">    private void AdjustStatusControls(Point? point = null)</a>
<a name="ln704">    {</a>
<a name="ln705">        if (_statusControlGrid == null)</a>
<a name="ln706">            return;</a>
<a name="ln707"> </a>
<a name="ln708">        if (!FinishedSelection || EmbeddedMode)</a>
<a name="ln709">        {</a>
<a name="ln710">            _statusControlGrid.Visibility = Visibility.Hidden;</a>
<a name="ln711">            return;</a>
<a name="ln712">        }</a>
<a name="ln713"> </a>
<a name="ln714">        //Show the controls always closest to the given point, if there's no space on the current monitor,</a>
<a name="ln715">        //try finding the second closest point, or else show inside the selection rectangle.</a>
<a name="ln716"> </a>
<a name="ln717">        if (!point.HasValue)</a>
<a name="ln718">            return;</a>
<a name="ln719"> </a>
<a name="ln720">        //var absolutePoint = new Point(point.Value.X, point.Value.Y);</a>
<a name="ln721"> </a>
<a name="ln722">        //If there's no space at the sides, show inside the rectangle.</a>
<a name="ln723">        if (Selected.Width &gt; ActualWidth - _statusVerticalSize.Width * 2 &amp;&amp; Selected.Height &gt; ActualHeight - _statusHorizontalSize.Height * 2)</a>
<a name="ln724">        {</a>
<a name="ln725">            _statusControlGrid.Rows = 1;</a>
<a name="ln726">            _statusControlGrid.Columns = 3;</a>
<a name="ln727">            _statusControlGrid.IsReversed = false;</a>
<a name="ln728">            _statusControlGrid.UpdateLayout();</a>
<a name="ln729"> </a>
<a name="ln730">            Canvas.SetLeft(_statusControlGrid, Selected.Left + Selected.Width / 2 - _statusControlGrid.ActualWidth / 2);</a>
<a name="ln731">            Canvas.SetTop(_statusControlGrid, Selected.Top + Selected.Height / 2 - _statusControlGrid.ActualHeight / 2);</a>
<a name="ln732">        }</a>
<a name="ln733">        else</a>
<a name="ln734">        {</a>
<a name="ln735">            //Out of 4 Points, get the one that is closest to the current mouse position.</a>
<a name="ln736">            var distances = new[] { (Selected.TopLeft - point.Value).Length, (Selected.TopRight - point.Value).Length, (Selected.BottomLeft - point.Value).Length, (Selected.BottomRight - point.Value).Length };</a>
<a name="ln737">            var index = Array.IndexOf(distances, distances.Min());</a>
<a name="ln738"> </a>
<a name="ln739">            const int margin = 10;</a>
<a name="ln740"> </a>
<a name="ln741">            var canTopLeft = Selected.Top &gt; _statusHorizontalSize.Height + margin || Selected.Left &gt; _statusVerticalSize.Width + margin;</a>
<a name="ln742">            var canBottomLeft = ActualHeight - Selected.Bottom &gt; _statusHorizontalSize.Height + margin || Selected.Left &gt; _statusVerticalSize.Width + margin;</a>
<a name="ln743"> </a>
<a name="ln744">            switch (index)</a>
<a name="ln745">            {</a>
<a name="ln746">                case 0: //Top Left.</a>
<a name="ln747">                    if (Selected.Top &gt; _statusHorizontalSize.Height + margin)</a>
<a name="ln748">                    {</a>
<a name="ln749">                        //On top.</a>
<a name="ln750">                        _statusControlGrid.Rows = 1;</a>
<a name="ln751">                        _statusControlGrid.Columns = 3;</a>
<a name="ln752">                        _statusControlGrid.IsReversed = false;</a>
<a name="ln753">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln754"> </a>
<a name="ln755">                        Canvas.SetLeft(_statusControlGrid, Selected.Left);</a>
<a name="ln756">                        Canvas.SetTop(_statusControlGrid, Selected.Top - _statusControlGrid.ActualHeight - margin);</a>
<a name="ln757">                        break;</a>
<a name="ln758">                    }</a>
<a name="ln759">                    else if (Selected.Left &gt; _statusVerticalSize.Width + margin)</a>
<a name="ln760">                    {</a>
<a name="ln761">                        //To the left.</a>
<a name="ln762">                        _statusControlGrid.Rows = 3;</a>
<a name="ln763">                        _statusControlGrid.Columns = 1;</a>
<a name="ln764">                        _statusControlGrid.IsReversed = false;</a>
<a name="ln765">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln766"> </a>
<a name="ln767">                        Canvas.SetLeft(_statusControlGrid, Selected.Left - _statusControlGrid.ActualWidth - margin);</a>
<a name="ln768">                        Canvas.SetTop(_statusControlGrid, Selected.Top);</a>
<a name="ln769">                        break;</a>
<a name="ln770">                    }</a>
<a name="ln771"> </a>
<a name="ln772">                    if (Selected.Width &gt; Selected.Height &amp;&amp; canBottomLeft)</a>
<a name="ln773">                        goto case 2; //Bottom left.</a>
<a name="ln774">                    else</a>
<a name="ln775">                        goto case 1; //Top right.</a>
<a name="ln776"> </a>
<a name="ln777">                case 1: //Top Right.</a>
<a name="ln778">                    if (Selected.Top &gt; _statusHorizontalSize.Height + margin)</a>
<a name="ln779">                    {</a>
<a name="ln780">                        //On top.</a>
<a name="ln781">                        _statusControlGrid.Rows = 1;</a>
<a name="ln782">                        _statusControlGrid.Columns = 3;</a>
<a name="ln783">                        _statusControlGrid.IsReversed = true;</a>
<a name="ln784">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln785"> </a>
<a name="ln786">                        Canvas.SetLeft(_statusControlGrid, Selected.Right - _statusControlGrid.ActualWidth);</a>
<a name="ln787">                        Canvas.SetTop(_statusControlGrid, Selected.Top - _statusControlGrid.ActualHeight - margin);</a>
<a name="ln788">                        break;</a>
<a name="ln789">                    }</a>
<a name="ln790">                    else if (ActualWidth - Selected.Right &gt; _statusVerticalSize.Width + margin)</a>
<a name="ln791">                    {</a>
<a name="ln792">                        //To the right.</a>
<a name="ln793">                        _statusControlGrid.Rows = 3;</a>
<a name="ln794">                        _statusControlGrid.Columns = 1;</a>
<a name="ln795">                        _statusControlGrid.IsReversed = false;</a>
<a name="ln796">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln797"> </a>
<a name="ln798">                        Canvas.SetLeft(_statusControlGrid, Selected.Right + margin);</a>
<a name="ln799">                        Canvas.SetTop(_statusControlGrid, Selected.Top);</a>
<a name="ln800">                        break;</a>
<a name="ln801">                    }</a>
<a name="ln802"> </a>
<a name="ln803">                    if (Selected.Width &gt; Selected.Height &amp;&amp; !canTopLeft)</a>
<a name="ln804">                        goto case 3; //Bottom right.</a>
<a name="ln805">                    else</a>
<a name="ln806">                        goto case 0; //Top left.</a>
<a name="ln807"> </a>
<a name="ln808">                case 2: //Bottom Left.</a>
<a name="ln809">                    if (ActualHeight - Selected.Bottom &gt; _statusHorizontalSize.Height + margin)</a>
<a name="ln810">                    {</a>
<a name="ln811">                        //On the bottom.</a>
<a name="ln812">                        _statusControlGrid.Rows = 1;</a>
<a name="ln813">                        _statusControlGrid.Columns = 3;</a>
<a name="ln814">                        _statusControlGrid.IsReversed = false;</a>
<a name="ln815">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln816"> </a>
<a name="ln817">                        Canvas.SetLeft(_statusControlGrid, Selected.Left.Clamp(0, ActualWidth - _statusControlGrid.ActualWidth));</a>
<a name="ln818">                        Canvas.SetTop(_statusControlGrid, Selected.Bottom + margin);</a>
<a name="ln819">                        break;</a>
<a name="ln820">                    }</a>
<a name="ln821">                    else if (Selected.Left &gt; _statusVerticalSize.Width + margin)</a>
<a name="ln822">                    {</a>
<a name="ln823">                        //To the left.</a>
<a name="ln824">                        _statusControlGrid.Rows = 3;</a>
<a name="ln825">                        _statusControlGrid.Columns = 1;</a>
<a name="ln826">                        _statusControlGrid.IsReversed = true;</a>
<a name="ln827">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln828"> </a>
<a name="ln829">                        Canvas.SetLeft(_statusControlGrid, Selected.Left - _statusControlGrid.ActualWidth - margin);</a>
<a name="ln830">                        Canvas.SetTop(_statusControlGrid, Selected.Bottom - _statusControlGrid.ActualHeight);</a>
<a name="ln831">                        break;</a>
<a name="ln832">                    }</a>
<a name="ln833"> </a>
<a name="ln834">                    if (Selected.Width &gt; Selected.Height &amp;&amp; canTopLeft)</a>
<a name="ln835">                        goto case 0; //Top left.</a>
<a name="ln836">                    else</a>
<a name="ln837">                        goto case 3; //Bottom right.</a>
<a name="ln838"> </a>
<a name="ln839">                case 3: //Bottom Right.</a>
<a name="ln840">                    if (ActualHeight - Selected.Bottom &gt; _statusHorizontalSize.Height + margin)</a>
<a name="ln841">                    {</a>
<a name="ln842">                        //On the bottom.</a>
<a name="ln843">                        _statusControlGrid.Rows = 1;</a>
<a name="ln844">                        _statusControlGrid.Columns = 3;</a>
<a name="ln845">                        _statusControlGrid.IsReversed = true;</a>
<a name="ln846">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln847"> </a>
<a name="ln848">                        Canvas.SetLeft(_statusControlGrid, (Selected.Right - _statusControlGrid.ActualWidth).Clamp(0, ActualWidth - _statusControlGrid.ActualWidth));</a>
<a name="ln849">                        Canvas.SetTop(_statusControlGrid, Selected.Bottom + margin);</a>
<a name="ln850">                        break;</a>
<a name="ln851">                    }</a>
<a name="ln852">                    else if (ActualWidth - Selected.Right &gt; _statusVerticalSize.Width + margin)</a>
<a name="ln853">                    {</a>
<a name="ln854">                        //To the right.</a>
<a name="ln855">                        _statusControlGrid.Rows = 3;</a>
<a name="ln856">                        _statusControlGrid.Columns = 1;</a>
<a name="ln857">                        _statusControlGrid.IsReversed = true;</a>
<a name="ln858">                        _statusControlGrid.UpdateLayout();</a>
<a name="ln859"> </a>
<a name="ln860">                        Canvas.SetLeft(_statusControlGrid, Selected.Right + margin);</a>
<a name="ln861">                        Canvas.SetTop(_statusControlGrid, Selected.Bottom - _statusControlGrid.ActualHeight);</a>
<a name="ln862">                        break;</a>
<a name="ln863">                    }</a>
<a name="ln864"> </a>
<a name="ln865">                    if (Selected.Width &gt; Selected.Height &amp;&amp; !canBottomLeft)</a>
<a name="ln866">                        goto case 1; //Top right.</a>
<a name="ln867">                    else</a>
<a name="ln868">                        goto case 2; //Bottom left.</a>
<a name="ln869">            }</a>
<a name="ln870">        }</a>
<a name="ln871"> </a>
<a name="ln872">        _statusControlGrid.Visibility = Visibility.Visible;</a>
<a name="ln873">    }</a>
<a name="ln874"> </a>
<a name="ln875">    private void AdjustFlowControls()</a>
<a name="ln876">    {</a>
<a name="ln877">        if (_mainCanvas == null)</a>
<a name="ln878">            return;</a>
<a name="ln879"> </a>
<a name="ln880">        foreach (var button in _mainCanvas.Children.OfType&lt;ExtendedButton&gt;())</a>
<a name="ln881">            button.Visibility = FinishedSelection ? Visibility.Hidden : Visibility.Visible;</a>
<a name="ln882">    }</a>
<a name="ln883"> </a>
<a name="ln884">    private void AdjustInfo(Point? point = null)</a>
<a name="ln885">    {</a>
<a name="ln886">        if (_sizeGrid == null)</a>
<a name="ln887">            return;</a>
<a name="ln888"> </a>
<a name="ln889">        if (point == null || Selected.IsEmpty || Selected.Width &lt; _sizeGrid.ActualWidth || Selected.Height &lt; _sizeGrid.ActualHeight)</a>
<a name="ln890">        {</a>
<a name="ln891">            _sizeGrid.Visibility = Visibility.Hidden;</a>
<a name="ln892">            return;</a>
<a name="ln893">        }</a>
<a name="ln894"> </a>
<a name="ln895">        //Out of 4 Points, get the one that is farthest from the current mouse position.</a>
<a name="ln896">        var distances = new[] { (Selected.TopLeft - point.Value).Length, (Selected.TopRight - point.Value).Length, (Selected.BottomLeft - point.Value).Length, (Selected.BottomRight - point.Value).Length };</a>
<a name="ln897">        var index = Array.IndexOf(distances, distances.Max());</a>
<a name="ln898"> </a>
<a name="ln899">        switch (index)</a>
<a name="ln900">        {</a>
<a name="ln901">            case 0:</a>
<a name="ln902">                Canvas.SetTop(_sizeGrid, Selected.Top);</a>
<a name="ln903">                Canvas.SetLeft(_sizeGrid, Selected.Left);</a>
<a name="ln904">                break;</a>
<a name="ln905">            case 1:</a>
<a name="ln906">                Canvas.SetTop(_sizeGrid, Selected.Top);</a>
<a name="ln907">                Canvas.SetLeft(_sizeGrid, Selected.Right - _sizeGrid.ActualWidth);</a>
<a name="ln908">                break;</a>
<a name="ln909">            case 2:</a>
<a name="ln910">                Canvas.SetTop(_sizeGrid, Selected.Bottom - _sizeGrid.ActualHeight);</a>
<a name="ln911">                Canvas.SetLeft(_sizeGrid, Selected.Left);</a>
<a name="ln912">                break;</a>
<a name="ln913">            case 3:</a>
<a name="ln914">                Canvas.SetTop(_sizeGrid, Selected.Bottom - _sizeGrid.ActualHeight);</a>
<a name="ln915">                Canvas.SetLeft(_sizeGrid, Selected.Right - _sizeGrid.ActualWidth);</a>
<a name="ln916">                break;</a>
<a name="ln917">        }</a>
<a name="ln918"> </a>
<a name="ln919">        _sizeGrid.Visibility = Visibility.Visible;</a>
<a name="ln920">    }</a>
<a name="ln921"> </a>
<a name="ln922">    private void DetectBlindSpots()</a>
<a name="ln923">    {</a>
<a name="ln924">        _blindSpots.Clear();</a>
<a name="ln925"> </a>
<a name="ln926">        if (Mode != ModeType.Region || !UserSettings.All.Magnifier)</a>
<a name="ln927">            return;</a>
<a name="ln928"> </a>
<a name="ln929">        //If nothing selected, only the Close button will appear.</a>
<a name="ln930">        if (Selected.IsEmpty) // || !FinishedSelection)</a>
<a name="ln931">        {</a>
<a name="ln932">            _blindSpots.Add(new Rect(new Point(ActualWidth - 40, 0), new Size(40, 40)));</a>
<a name="ln933">            return;</a>
<a name="ln934">        }</a>
<a name="ln935"> </a>
<a name="ln936">        if (_statusControlGrid.Visibility == Visibility.Visible)</a>
<a name="ln937">            _blindSpots.Add(new Rect(new Point(Canvas.GetLeft(_statusControlGrid), Canvas.GetTop(_statusControlGrid)), new Size(_statusControlGrid.ActualWidth, _statusControlGrid.ActualHeight)));</a>
<a name="ln938">    }</a>
<a name="ln939"> </a>
<a name="ln940"> </a>
<a name="ln941">    internal void Accept()</a>
<a name="ln942">    {</a>
<a name="ln943">        if (!FinishedSelection)</a>
<a name="ln944">            return;</a>
<a name="ln945"> </a>
<a name="ln946">        //Selected = Selected.Offset(-1);</a>
<a name="ln947">        RaiseAcceptedEvent();</a>
<a name="ln948">    }</a>
<a name="ln949"> </a>
<a name="ln950">    public void Retry()</a>
<a name="ln951">    {</a>
<a name="ln952">        Selected = Rect.Empty;</a>
<a name="ln953"> </a>
<a name="ln954">        FinishedSelection = false;</a>
<a name="ln955"> </a>
<a name="ln956">        AdjustStatusControls();</a>
<a name="ln957">        AdjustFlowControls();</a>
<a name="ln958">        DetectBlindSpots();</a>
<a name="ln959">        AdjustInfo();</a>
<a name="ln960">    }</a>
<a name="ln961"> </a>
<a name="ln962">    public void Cancel()</a>
<a name="ln963">    {</a>
<a name="ln964">        Selected = Rect.Empty;</a>
<a name="ln965"> </a>
<a name="ln966">        FinishedSelection = false;</a>
<a name="ln967"> </a>
<a name="ln968">        AdjustStatusControls();</a>
<a name="ln969">        DetectBlindSpots();</a>
<a name="ln970">        RaiseCanceledEvent();</a>
<a name="ln971">    }</a>
<a name="ln972"> </a>
<a name="ln973">    public void HideZoom()</a>
<a name="ln974">    {</a>
<a name="ln975">        _wasHoverFocusChanged = false;</a>
<a name="ln976">        _zoomGrid.Visibility = Visibility.Hidden;</a>
<a name="ln977">        //_regionMagnifier.Hide();</a>
<a name="ln978">    }</a>
<a name="ln979"> </a>
<a name="ln980"> </a>
<a name="ln981">    public void RaiseMouseHoveringEvent()</a>
<a name="ln982">    {</a>
<a name="ln983">        if (MouseHoveringEvent == null || !IsLoaded)</a>
<a name="ln984">            return;</a>
<a name="ln985"> </a>
<a name="ln986">        RaiseEvent(new RoutedEventArgs(MouseHoveringEvent));</a>
<a name="ln987">    }</a>
<a name="ln988"> </a>
<a name="ln989">    public void RaiseAcceptedEvent()</a>
<a name="ln990">    {</a>
<a name="ln991">        if (SelectionAcceptedEvent == null || !IsLoaded)</a>
<a name="ln992">            return;</a>
<a name="ln993"> </a>
<a name="ln994">        RaiseEvent(new RoutedEventArgs(SelectionAcceptedEvent));</a>
<a name="ln995">    }</a>
<a name="ln996"> </a>
<a name="ln997">    public void RaiseChangedEvent()</a>
<a name="ln998">    {</a>
<a name="ln999">        if (SelectionChangedEvent == null || !IsLoaded)</a>
<a name="ln1000">            return;</a>
<a name="ln1001"> </a>
<a name="ln1002">        RaiseEvent(new RoutedEventArgs(SelectionChangedEvent));</a>
<a name="ln1003">    }</a>
<a name="ln1004"> </a>
<a name="ln1005">    public void RaiseCanceledEvent()</a>
<a name="ln1006">    {</a>
<a name="ln1007">        if (SelectionCanceledEvent == null || !IsLoaded)</a>
<a name="ln1008">            return;</a>
<a name="ln1009"> </a>
<a name="ln1010">        RaiseEvent(new RoutedEventArgs(SelectionCanceledEvent));</a>
<a name="ln1011">    }</a>
<a name="ln1012"> </a>
<a name="ln1013">    private void CalculateStatusGridSizes()</a>
<a name="ln1014">    {</a>
<a name="ln1015">        _statusControlGrid.Rows = 3;</a>
<a name="ln1016">        _statusControlGrid.Columns = 1;</a>
<a name="ln1017">        _statusControlGrid.UpdateLayout();</a>
<a name="ln1018"> </a>
<a name="ln1019">        _statusVerticalSize = new Size(_statusControlGrid.ActualWidth, _statusControlGrid.ActualHeight);</a>
<a name="ln1020"> </a>
<a name="ln1021">        _statusControlGrid.Rows = 1;</a>
<a name="ln1022">        _statusControlGrid.Columns = 3;</a>
<a name="ln1023">        _statusControlGrid.UpdateLayout();</a>
<a name="ln1024"> </a>
<a name="ln1025">        _statusHorizontalSize = new Size(_statusControlGrid.ActualWidth, _statusControlGrid.ActualHeight);</a>
<a name="ln1026">    }</a>
<a name="ln1027"> </a>
<a name="ln1028">    #endregion</a>
<a name="ln1029"> </a>
<a name="ln1030">    #region Events</a>
<a name="ln1031"> </a>
<a name="ln1032">    public void Control_Loaded(object o, RoutedEventArgs routedEventArgs)</a>
<a name="ln1033">    {</a>
<a name="ln1034">        _ready = false;</a>
<a name="ln1035"> </a>
<a name="ln1036">        Keyboard.Focus(this);</a>
<a name="ln1037"> </a>
<a name="ln1038">        _blindSpots.Clear();</a>
<a name="ln1039"> </a>
<a name="ln1040">        if (EmbeddedMode)</a>
<a name="ln1041">        {</a>
<a name="ln1042">            var viewBox = new Viewbox</a>
<a name="ln1043">            {</a>
<a name="ln1044">                Height = Height,</a>
<a name="ln1045">                Width = Width,</a>
<a name="ln1046">                Stretch = Stretch.Uniform,</a>
<a name="ln1047">                StretchDirection = StretchDirection.Both,</a>
<a name="ln1048">                Tag = &quot;T&quot;,</a>
<a name="ln1049">                ClipToBounds = true,</a>
<a name="ln1050">                IsHitTestVisible = false,</a>
<a name="ln1051">                Child = new TextPath</a>
<a name="ln1052">                {</a>
<a name="ln1053">                    IsHitTestVisible = false,</a>
<a name="ln1054">                    Text = LocalizationHelper.Get(&quot;S.Recorder.SelectArea.Embedded&quot;),</a>
<a name="ln1055">                    Fill = new SolidColorBrush(Color.FromArgb(200, 0, 0, 0)),</a>
<a name="ln1056">                    Stroke = new SolidColorBrush(Color.FromArgb(200, 255, 255, 255)),</a>
<a name="ln1057">                    StrokeThickness = 1.6,</a>
<a name="ln1058">                    FontFamily = new FontFamily(&quot;Segoe UI&quot;),</a>
<a name="ln1059">                    FontSize = 80,</a>
<a name="ln1060">                    FontWeight = FontWeights.SemiBold,</a>
<a name="ln1061">                    Margin = new Thickness(80),</a>
<a name="ln1062">                    VerticalAlignment = VerticalAlignment.Stretch,</a>
<a name="ln1063">                    HorizontalAlignment = HorizontalAlignment.Stretch,</a>
<a name="ln1064">                    ClipToBounds = true</a>
<a name="ln1065">                }</a>
<a name="ln1066">            };</a>
<a name="ln1067"> </a>
<a name="ln1068">            _mainCanvas.Children.Insert(0, viewBox);</a>
<a name="ln1069"> </a>
<a name="ln1070">            Canvas.SetLeft(viewBox, 0);</a>
<a name="ln1071">            Canvas.SetTop(viewBox, 0);</a>
<a name="ln1072">            Panel.SetZIndex(viewBox, 0);</a>
<a name="ln1073"> </a>
<a name="ln1074">            AdjustSelection();</a>
<a name="ln1075">            return;</a>
<a name="ln1076">        }</a>
<a name="ln1077"> </a>
<a name="ln1078">        if (IsMouseOver)</a>
<a name="ln1079">            AdjustZoomView(Mouse.GetPosition(this));</a>
<a name="ln1080"> </a>
<a name="ln1081">        CalculateStatusGridSizes();</a>
<a name="ln1082"> </a>
<a name="ln1083">        #region Close button</a>
<a name="ln1084"> </a>
<a name="ln1085">        //Close button.</a>
<a name="ln1086">        var button = new ExtendedButton</a>
<a name="ln1087">        {</a>
<a name="ln1088">            Name = &quot;CancelButton&quot;,</a>
<a name="ln1089">            Width = 40,</a>
<a name="ln1090">            Height = 40,</a>
<a name="ln1091">            ContentHeight = 25,</a>
<a name="ln1092">            ContentWidth = 25,</a>
<a name="ln1093">            ToolTip = LocalizationHelper.Get(&quot;S.Recorder.CancelSelection&quot;),</a>
<a name="ln1094">            Icon = TryFindResource(&quot;Vector.Cancel&quot;) as Brush,</a>
<a name="ln1095">            Style = TryFindResource(&quot;Style.Button.NoText.White&quot;) as Style,</a>
<a name="ln1096">            Cursor = Cursors.Arrow,</a>
<a name="ln1097">            Tag = &quot;T&quot;</a>
<a name="ln1098">        };</a>
<a name="ln1099"> </a>
<a name="ln1100">        button.Click += (sender, e) =&gt; { Cancel(); };</a>
<a name="ln1101"> </a>
<a name="ln1102">        _mainCanvas.Children.Add(button);</a>
<a name="ln1103"> </a>
<a name="ln1104">        Canvas.SetLeft(button, ActualWidth - 40);</a>
<a name="ln1105">        Canvas.SetTop(button, 0);</a>
<a name="ln1106">        Panel.SetZIndex(button, 8);</a>
<a name="ln1107"> </a>
<a name="ln1108">        _blindSpots.Add(new Rect(new Point(ActualWidth - 40, 0), new Size(40, 40)));</a>
<a name="ln1109"> </a>
<a name="ln1110">        #endregion</a>
<a name="ln1111"> </a>
<a name="ln1112">        if (Mode == ModeType.Fullscreen)</a>
<a name="ln1113">        {</a>
<a name="ln1114">            var viewBox = new Viewbox</a>
<a name="ln1115">            {</a>
<a name="ln1116">                Height = ActualHeight,</a>
<a name="ln1117">                Width = ActualWidth,</a>
<a name="ln1118">                Stretch = Stretch.Uniform,</a>
<a name="ln1119">                Tag = &quot;T&quot;,</a>
<a name="ln1120">                IsHitTestVisible = false,</a>
<a name="ln1121">                Child = new TextPath</a>
<a name="ln1122">                {</a>
<a name="ln1123">                    IsHitTestVisible = false,</a>
<a name="ln1124">                    Text = &quot;👆 &quot; + LocalizationHelper.Get(&quot;S.Recorder.SelectScreen&quot;),</a>
<a name="ln1125">                    Fill = new SolidColorBrush(Color.FromArgb(200, 0, 0, 0)),</a>
<a name="ln1126">                    Stroke = new SolidColorBrush(Color.FromArgb(200, 255, 255, 255)),</a>
<a name="ln1127">                    StrokeThickness = 3,</a>
<a name="ln1128">                    FontFamily = new FontFamily(&quot;Segoe UI&quot;),</a>
<a name="ln1129">                    FontSize = 72,</a>
<a name="ln1130">                    FontWeight = FontWeights.SemiBold,</a>
<a name="ln1131">                    Margin = new Thickness(50)</a>
<a name="ln1132">                }</a>
<a name="ln1133">            };</a>
<a name="ln1134"> </a>
<a name="ln1135">            _mainCanvas.Children.Insert(0, viewBox);</a>
<a name="ln1136"> </a>
<a name="ln1137">            Canvas.SetLeft(viewBox, 0);</a>
<a name="ln1138">            Canvas.SetTop(viewBox, 0);</a>
<a name="ln1139">            Panel.SetZIndex(viewBox, 0);</a>
<a name="ln1140">        }</a>
<a name="ln1141">        else if (Mode == ModeType.Window)</a>
<a name="ln1142">        {</a>
<a name="ln1143">            foreach (var window in Windows)</a>
<a name="ln1144">            {</a>
<a name="ln1145">                var border = new Border</a>
<a name="ln1146">                {</a>
<a name="ln1147">                    Tag = &quot;T&quot;,</a>
<a name="ln1148">                    ClipToBounds = true,</a>
<a name="ln1149">                    IsHitTestVisible = false,</a>
<a name="ln1150">                    Height = window.Bounds.Height,</a>
<a name="ln1151">                    Width = window.Bounds.Width,</a>
<a name="ln1152">                    Child = new Viewbox</a>
<a name="ln1153">                    {</a>
<a name="ln1154">                        Stretch = Stretch.Uniform,</a>
<a name="ln1155">                        StretchDirection = StretchDirection.Both,</a>
<a name="ln1156">                        VerticalAlignment = VerticalAlignment.Center,</a>
<a name="ln1157">                        Child = new TextPath</a>
<a name="ln1158">                        {</a>
<a name="ln1159">                            IsHitTestVisible = false,</a>
<a name="ln1160">                            Text = window.Bounds.Width &lt; 400 || window.Bounds.Height &lt; 100 ? &quot;👆&quot; : &quot;👆 &quot; + LocalizationHelper.Get(&quot;S.Recorder.SelectWindow&quot;),</a>
<a name="ln1161">                            Fill = new SolidColorBrush(Color.FromArgb(200, 0, 0, 0)),</a>
<a name="ln1162">                            Stroke = new SolidColorBrush(Color.FromArgb(200, 255, 255, 255)),</a>
<a name="ln1163">                            StrokeThickness = 3,</a>
<a name="ln1164">                            FontFamily = new FontFamily(&quot;Segoe UI&quot;),</a>
<a name="ln1165">                            FontSize = 80,</a>
<a name="ln1166">                            FontWeight = FontWeights.SemiBold,</a>
<a name="ln1167">                            Margin = new Thickness(20),</a>
<a name="ln1168">                            VerticalAlignment = VerticalAlignment.Stretch,</a>
<a name="ln1169">                            HorizontalAlignment = HorizontalAlignment.Stretch,</a>
<a name="ln1170">                        }</a>
<a name="ln1171">                    }</a>
<a name="ln1172">                };</a>
<a name="ln1173"> </a>
<a name="ln1174">                border.UpdateLayout();</a>
<a name="ln1175"> </a>
<a name="ln1176">                var top = Windows.Where(x =&gt; x.Order &lt; window.Order).Select(x =&gt; x.Bounds).ToList();</a>
<a name="ln1177">                var geo = new RectangleGeometry { Rect = new Rect(new Size(window.Bounds.Width, window.Bounds.Height)) }.GetFlattenedPathGeometry(0, ToleranceType.Absolute);</a>
<a name="ln1178"> </a>
<a name="ln1179">                if (top.Any())</a>
<a name="ln1180">                {</a>
<a name="ln1181">                    foreach (var region in top)</a>
<a name="ln1182">                    {</a>
<a name="ln1183">                        geo = Geometry.Combine(geo, new RectangleGeometry { Rect = new Rect(new Point(region.X - window.Bounds.X, region.Y - window.Bounds.Y), new Size(region.Width, region.Height)) },</a>
<a name="ln1184">                            GeometryCombineMode.Exclude, Transform.Identity);</a>
<a name="ln1185">                    }</a>
<a name="ln1186"> </a>
<a name="ln1187">                    border.Clip = geo;</a>
<a name="ln1188">                }</a>
<a name="ln1189"> </a>
<a name="ln1190">                _mainCanvas.Children.Insert(0, border);</a>
<a name="ln1191"> </a>
<a name="ln1192">                Canvas.SetLeft(border, window.Bounds.Left);</a>
<a name="ln1193">                Canvas.SetTop(border, window.Bounds.Top);</a>
<a name="ln1194">                Panel.SetZIndex(border, 0);</a>
<a name="ln1195">            }</a>
<a name="ln1196">        }</a>
<a name="ln1197">        else</a>
<a name="ln1198">        {</a>
<a name="ln1199">            var viewBox = new Viewbox</a>
<a name="ln1200">            {</a>
<a name="ln1201">                Height = ActualHeight,</a>
<a name="ln1202">                Width = ActualWidth,</a>
<a name="ln1203">                Stretch = Stretch.Uniform,</a>
<a name="ln1204">                StretchDirection = StretchDirection.Both,</a>
<a name="ln1205">                Tag = &quot;T&quot;,</a>
<a name="ln1206">                ClipToBounds = true,</a>
<a name="ln1207">                IsHitTestVisible = false,</a>
<a name="ln1208">                Child = new TextPath</a>
<a name="ln1209">                {</a>
<a name="ln1210">                    IsHitTestVisible = false,</a>
<a name="ln1211">                    Text = LocalizationHelper.Get(&quot;S.Recorder.SelectArea&quot;),</a>
<a name="ln1212">                    Fill = new SolidColorBrush(Color.FromArgb(200, 0, 0, 0)),</a>
<a name="ln1213">                    Stroke = new SolidColorBrush(Color.FromArgb(200, 255, 255, 255)),</a>
<a name="ln1214">                    StrokeThickness = 3,</a>
<a name="ln1215">                    FontFamily = new FontFamily(&quot;Segoe UI&quot;),</a>
<a name="ln1216">                    FontSize = 80,</a>
<a name="ln1217">                    FontWeight = FontWeights.SemiBold,</a>
<a name="ln1218">                    Margin = new Thickness(80),</a>
<a name="ln1219">                    VerticalAlignment = VerticalAlignment.Stretch,</a>
<a name="ln1220">                    HorizontalAlignment = HorizontalAlignment.Stretch,</a>
<a name="ln1221">                    ClipToBounds = true</a>
<a name="ln1222">                }</a>
<a name="ln1223">            };</a>
<a name="ln1224"> </a>
<a name="ln1225">            _mainCanvas.Children.Insert(0, viewBox);</a>
<a name="ln1226"> </a>
<a name="ln1227">            Canvas.SetLeft(viewBox, 0);</a>
<a name="ln1228">            Canvas.SetTop(viewBox, 0);</a>
<a name="ln1229">            Panel.SetZIndex(viewBox, 0);</a>
<a name="ln1230">        }</a>
<a name="ln1231"> </a>
<a name="ln1232">        AdjustSelection();</a>
<a name="ln1233"> </a>
<a name="ln1234">        _ready = true;</a>
<a name="ln1235"> </a>
<a name="ln1236">        //Triggers the mouse event to detect the mouse hit at start.</a>
<a name="ln1237">        OnMouseMove(new MouseButtonEventArgs(Mouse.PrimaryDevice, 0, MouseButton.Left));</a>
<a name="ln1238">    }</a>
<a name="ln1239"> </a>
<a name="ln1240">    private void SystemEvents_DisplaySettingsChanged(object o, EventArgs eventArgs)</a>
<a name="ln1241">    {</a>
<a name="ln1242">        Scale = this.Scale();</a>
<a name="ln1243">    }</a>
<a name="ln1244"> </a>
<a name="ln1245">    private void Control_Unloaded(object sender, RoutedEventArgs e)</a>
<a name="ln1246">    {</a>
<a name="ln1247">        SystemEvents.DisplaySettingsChanged -= SystemEvents_DisplaySettingsChanged;</a>
<a name="ln1248"> </a>
<a name="ln1249">        if (_mainCanvas == null)</a>
<a name="ln1250">            return;</a>
<a name="ln1251"> </a>
<a name="ln1252">        var list = _mainCanvas.Children.OfType&lt;FrameworkElement&gt;().Where(x =&gt; x.Tag as string == &quot;T&quot;).ToList();</a>
<a name="ln1253"> </a>
<a name="ln1254">        foreach (var element in list)</a>
<a name="ln1255">            _mainCanvas.Children.Remove(element);</a>
<a name="ln1256"> </a>
<a name="ln1257">        //_regionMagnifier.Close();</a>
<a name="ln1258">    }</a>
<a name="ln1259"> </a>
<a name="ln1260"> </a>
<a name="ln1261">    private static void Selected_PropertyChanged(DependencyObject o, DependencyPropertyChangedEventArgs e)</a>
<a name="ln1262">    {</a>
<a name="ln1263">        if (!(o is SelectControl control))</a>
<a name="ln1264">            return;</a>
<a name="ln1265"> </a>
<a name="ln1266">        //If nothing selected, simply ignore.</a>
<a name="ln1267">        if (control.Selected.IsEmpty)</a>
<a name="ln1268">        {</a>
<a name="ln1269">            control.NonExpandedSelection = control.Selected;</a>
<a name="ln1270">            control.NonExpandedNativeSelection = control.Selected;</a>
<a name="ln1271">            return;</a>
<a name="ln1272">        }</a>
<a name="ln1273"> </a>
<a name="ln1274">        //In a predetermined selection mode (window or screen)</a>
<a name="ln1275">        if (control.Mode == ModeType.Fullscreen || control.Mode == ModeType.Window)</a>
<a name="ln1276">        {</a>
<a name="ln1277">            control.NonExpandedSelection = control.Selected.Offset(0); //In this case Offset is just rounding the selection points.</a>
<a name="ln1278">            control.NonExpandedNativeSelection = control.Selected.Scale(control.Scale);</a>
<a name="ln1279">            control.RaiseChangedEvent();</a>
<a name="ln1280">            return;</a>
<a name="ln1281">        }</a>
<a name="ln1282"> </a>
<a name="ln1283">        #region Region selection mode</a>
<a name="ln1284"> </a>
<a name="ln1285">        //For way too small regions, avoid applying the offset. That would throw an exception.</a>
<a name="ln1286">        if (control.Selected.Width &lt; 5 || control.Selected.Height &lt; 5)</a>
<a name="ln1287">        {</a>
<a name="ln1288">            control.NonExpandedSelection = control.Selected;</a>
<a name="ln1289">            control.NonExpandedNativeSelection = control.Selected;</a>
<a name="ln1290">            return;</a>
<a name="ln1291">        }</a>
<a name="ln1292"> </a>
<a name="ln1293">        control.NonExpandedSelection = control.Selected.Offset(1);</a>
<a name="ln1294">        control.NonExpandedNativeSelection = control.Selected.Scale(control.Scale).Offset(MathExtensions.RoundUpValue(control.Scale));</a>
<a name="ln1295">        control.RaiseChangedEvent();</a>
<a name="ln1296"> </a>
<a name="ln1297">        #endregion</a>
<a name="ln1298">    }</a>
<a name="ln1299"> </a>
<a name="ln1300">    private void Rectangle_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)</a>
<a name="ln1301">    {</a>
<a name="ln1302">        if (Mode != ModeType.Region)</a>
<a name="ln1303">            return;</a>
<a name="ln1304"> </a>
<a name="ln1305">        _startPoint = e.GetPosition(this);</a>
<a name="ln1306"> </a>
<a name="ln1307">        _rectangle.CaptureMouse();</a>
<a name="ln1308"> </a>
<a name="ln1309">        FinishedSelection = false;</a>
<a name="ln1310"> </a>
<a name="ln1311">        AdjustStatusControls();</a>
<a name="ln1312">        DetectBlindSpots();</a>
<a name="ln1313">        AdjustInfo();</a>
<a name="ln1314"> </a>
<a name="ln1315">        RaiseChangedEvent(); //Check if makes sense.</a>
<a name="ln1316"> </a>
<a name="ln1317">        e.Handled = true;</a>
<a name="ln1318">    }</a>
<a name="ln1319"> </a>
<a name="ln1320">    private void Rectangle_MouseMove(object sender, MouseEventArgs e)</a>
<a name="ln1321">    {</a>
<a name="ln1322">        if (Mode != ModeType.Region || !_rectangle.IsMouseCaptured || e.LeftButton != MouseButtonState.Pressed)</a>
<a name="ln1323">            return;</a>
<a name="ln1324"> </a>
<a name="ln1325">        //A quick double click will fire this event, when it should fire the OnMouseLeftButtonUp.</a>
<a name="ln1326">        if (Selected.IsEmpty || Selected.Width &lt; 10 || Selected.Height &lt; 10)</a>
<a name="ln1327">            return;</a>
<a name="ln1328"> </a>
<a name="ln1329">        _rectangle.MouseMove -= Rectangle_MouseMove;</a>
<a name="ln1330"> </a>
<a name="ln1331">        var currentPosition = e.GetPosition(this);</a>
<a name="ln1332"> </a>
<a name="ln1333">        var x = Selected.X + (currentPosition.X - _startPoint.X);</a>
<a name="ln1334">        var y = Selected.Y + (currentPosition.Y - _startPoint.Y);</a>
<a name="ln1335"> </a>
<a name="ln1336">        if (x &lt; -1)</a>
<a name="ln1337">            x = -1;</a>
<a name="ln1338"> </a>
<a name="ln1339">        if (y &lt; -1)</a>
<a name="ln1340">            y = -1;</a>
<a name="ln1341"> </a>
<a name="ln1342">        if (x + Selected.Width &gt; ActualWidth + 1)</a>
<a name="ln1343">            x = ActualWidth + 1 - Selected.Width;</a>
<a name="ln1344"> </a>
<a name="ln1345">        if (y + Selected.Height &gt; ActualHeight + 1)</a>
<a name="ln1346">            y = ActualHeight + 1 - Selected.Height;</a>
<a name="ln1347"> </a>
<a name="ln1348">        Selected = new Rect(x, y, Selected.Width, Selected.Height);</a>
<a name="ln1349"> </a>
<a name="ln1350">        _startPoint = currentPosition;</a>
<a name="ln1351">        e.Handled = true;</a>
<a name="ln1352"> </a>
<a name="ln1353">        AdjustInfo();</a>
<a name="ln1354"> </a>
<a name="ln1355">        _rectangle.MouseMove += Rectangle_MouseMove;</a>
<a name="ln1356">        _zoomGrid.Visibility = Visibility.Collapsed;</a>
<a name="ln1357">    }</a>
<a name="ln1358"> </a>
<a name="ln1359">    private void Rectangle_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)</a>
<a name="ln1360">    {</a>
<a name="ln1361">        if (Mode != ModeType.Region)</a>
<a name="ln1362">            return;</a>
<a name="ln1363"> </a>
<a name="ln1364">        if (_rectangle.IsMouseCaptured)</a>
<a name="ln1365">            _rectangle?.ReleaseMouseCapture();</a>
<a name="ln1366"> </a>
<a name="ln1367">        //A quick double quick will fire this event, when it should fire the OnMouseLeftButtonUp.</a>
<a name="ln1368">        if (Selected.IsEmpty || Selected.Width &lt; 10 || Selected.Height &lt; 10)</a>
<a name="ln1369">            return;</a>
<a name="ln1370"> </a>
<a name="ln1371">        FinishedSelection = true;</a>
<a name="ln1372"> </a>
<a name="ln1373">        var point = Mouse.GetPosition(this);</a>
<a name="ln1374"> </a>
<a name="ln1375">        AdjustThumbs();</a>
<a name="ln1376">        AdjustStatusControls(point);</a>
<a name="ln1377">        DetectBlindSpots();</a>
<a name="ln1378">        AdjustInfo(point);</a>
<a name="ln1379">        AdjustZoomView(point);</a>
<a name="ln1380"> </a>
<a name="ln1381">        e.Handled = true;</a>
<a name="ln1382">    }</a>
<a name="ln1383"> </a>
<a name="ln1384">    private void SizeTextBlock_MouseUp(object sender, MouseButtonEventArgs e)</a>
<a name="ln1385">    {</a>
<a name="ln1386">        //Open dialog asking for left/top/width/height.</a>
<a name="ln1387">        //_rectGrid.Visibility = Visibility.Visible;</a>
<a name="ln1388">    }</a>
<a name="ln1389"> </a>
<a name="ln1390"> </a>
<a name="ln1391">    ///&lt;summary&gt;</a>
<a name="ln1392">    ///Handler for resizing from the top-left.</a>
<a name="ln1393">    ///&lt;/summary&gt;</a>
<a name="ln1394">    private void HandleTopLeft(object sender, DragDeltaEventArgs e)</a>
<a name="ln1395">    {</a>
<a name="ln1396">        if (!(sender is Thumb)) return;</a>
<a name="ln1397"> </a>
<a name="ln1398">        e.Handled = true;</a>
<a name="ln1399"> </a>
<a name="ln1400">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1401">        var width = Math.Max(Selected.Width - e.HorizontalChange, 10);</a>
<a name="ln1402">        var left = Selected.Left - (width - Selected.Width);</a>
<a name="ln1403">        var height = Math.Max(Selected.Height - e.VerticalChange, 10);</a>
<a name="ln1404">        var top = Selected.Top - (height - Selected.Height);</a>
<a name="ln1405"> </a>
<a name="ln1406">        if (top &lt; 0)</a>
<a name="ln1407">        {</a>
<a name="ln1408">            height -= top * -1;</a>
<a name="ln1409">            top = 0;</a>
<a name="ln1410">        }</a>
<a name="ln1411"> </a>
<a name="ln1412">        if (left &lt; 0)</a>
<a name="ln1413">        {</a>
<a name="ln1414">            width -= left * -1;</a>
<a name="ln1415">            left = 0;</a>
<a name="ln1416">        }</a>
<a name="ln1417"> </a>
<a name="ln1418">        Selected = new Rect(left, top, width, height);</a>
<a name="ln1419"> </a>
<a name="ln1420">        var point = Mouse.GetPosition(this);</a>
<a name="ln1421"> </a>
<a name="ln1422">        AdjustThumbs();</a>
<a name="ln1423">        AdjustStatusControls(point);</a>
<a name="ln1424">        DetectBlindSpots();</a>
<a name="ln1425">        AdjustInfo(point);</a>
<a name="ln1426">    }</a>
<a name="ln1427"> </a>
<a name="ln1428">    /// &lt;summary&gt;</a>
<a name="ln1429">    ///  Handler for resizing from the top-right.</a>
<a name="ln1430">    /// &lt;/summary&gt;</a>
<a name="ln1431">    private void HandleTopRight(object sender, DragDeltaEventArgs e)</a>
<a name="ln1432">    {</a>
<a name="ln1433">        if (!(sender is Thumb)) return;</a>
<a name="ln1434"> </a>
<a name="ln1435">        e.Handled = true;</a>
<a name="ln1436"> </a>
<a name="ln1437">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1438">        var width = Math.Max(Selected.Width + e.HorizontalChange, 10);</a>
<a name="ln1439">        var height = Math.Max(Selected.Height - e.VerticalChange, 10);</a>
<a name="ln1440">        var top = Selected.Top - (height - Selected.Height);</a>
<a name="ln1441"> </a>
<a name="ln1442">        if (top &lt; 0)</a>
<a name="ln1443">        {</a>
<a name="ln1444">            height -= top * -1;</a>
<a name="ln1445">            top = 0;</a>
<a name="ln1446">        }</a>
<a name="ln1447"> </a>
<a name="ln1448">        if (Selected.Left + width &gt; ActualWidth)</a>
<a name="ln1449">            width = ActualWidth - Selected.Left;</a>
<a name="ln1450"> </a>
<a name="ln1451">        Selected = new Rect(Selected.Left, top, width, height);</a>
<a name="ln1452"> </a>
<a name="ln1453">        var point = Mouse.GetPosition(this);</a>
<a name="ln1454"> </a>
<a name="ln1455">        AdjustThumbs();</a>
<a name="ln1456">        AdjustStatusControls(point);</a>
<a name="ln1457">        DetectBlindSpots();</a>
<a name="ln1458">        AdjustInfo(point);</a>
<a name="ln1459">    }</a>
<a name="ln1460"> </a>
<a name="ln1461">    /// &lt;summary&gt;</a>
<a name="ln1462">    ///  Handler for resizing from the bottom-left.</a>
<a name="ln1463">    /// &lt;/summary&gt;</a>
<a name="ln1464">    private void HandleBottomLeft(object sender, DragDeltaEventArgs e)</a>
<a name="ln1465">    {</a>
<a name="ln1466">        if (!(sender is Thumb)) return;</a>
<a name="ln1467"> </a>
<a name="ln1468">        e.Handled = true;</a>
<a name="ln1469"> </a>
<a name="ln1470">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1471">        var width = Math.Max(Selected.Width - e.HorizontalChange, 10);</a>
<a name="ln1472">        var left = Selected.Left - (width - Selected.Width);</a>
<a name="ln1473">        var height = Math.Max(Selected.Height + e.VerticalChange, 10);</a>
<a name="ln1474"> </a>
<a name="ln1475">        if (left &lt; 0)</a>
<a name="ln1476">        {</a>
<a name="ln1477">            width -= left * -1;</a>
<a name="ln1478">            left = 0;</a>
<a name="ln1479">        }</a>
<a name="ln1480"> </a>
<a name="ln1481">        if (Selected.Left + width &gt; ActualWidth)</a>
<a name="ln1482">            width = ActualWidth - Selected.Left;</a>
<a name="ln1483"> </a>
<a name="ln1484">        if (Selected.Top + height &gt; ActualHeight)</a>
<a name="ln1485">            height = ActualHeight - Selected.Top;</a>
<a name="ln1486"> </a>
<a name="ln1487">        Selected = new Rect(left, Selected.Top, width, height);</a>
<a name="ln1488"> </a>
<a name="ln1489">        var point = Mouse.GetPosition(this);</a>
<a name="ln1490"> </a>
<a name="ln1491">        AdjustThumbs();</a>
<a name="ln1492">        AdjustStatusControls(point);</a>
<a name="ln1493">        DetectBlindSpots();</a>
<a name="ln1494">        AdjustInfo(point);</a>
<a name="ln1495">    }</a>
<a name="ln1496"> </a>
<a name="ln1497">    /// &lt;summary&gt;</a>
<a name="ln1498">    /// Handler for resizing from the bottom-right.</a>
<a name="ln1499">    /// &lt;/summary&gt;</a>
<a name="ln1500">    private void HandleBottomRight(object sender, DragDeltaEventArgs e)</a>
<a name="ln1501">    {</a>
<a name="ln1502">        if (!(sender is Thumb)) return;</a>
<a name="ln1503"> </a>
<a name="ln1504">        e.Handled = true;</a>
<a name="ln1505"> </a>
<a name="ln1506">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1507">        var width = Math.Max(Selected.Width + e.HorizontalChange, 10);</a>
<a name="ln1508">        var height = Math.Max(Selected.Height + e.VerticalChange, 10);</a>
<a name="ln1509"> </a>
<a name="ln1510">        if (Selected.Left + width &gt; ActualWidth)</a>
<a name="ln1511">            width = ActualWidth - Selected.Left;</a>
<a name="ln1512"> </a>
<a name="ln1513">        if (Selected.Top + height &gt; ActualHeight)</a>
<a name="ln1514">            height = ActualHeight - Selected.Top;</a>
<a name="ln1515"> </a>
<a name="ln1516">        Selected = new Rect(Selected.Left, Selected.Top, width, height);</a>
<a name="ln1517"> </a>
<a name="ln1518">        var point = Mouse.GetPosition(this);</a>
<a name="ln1519"> </a>
<a name="ln1520">        AdjustThumbs();</a>
<a name="ln1521">        AdjustStatusControls(point);</a>
<a name="ln1522">        DetectBlindSpots();</a>
<a name="ln1523">        AdjustInfo(point);</a>
<a name="ln1524">    }</a>
<a name="ln1525"> </a>
<a name="ln1526">    /// &lt;summary&gt;</a>
<a name="ln1527">    /// Handler for resizing from the left-middle.</a>
<a name="ln1528">    /// &lt;/summary&gt;</a>
<a name="ln1529">    private void HandleLeft(object sender, DragDeltaEventArgs e)</a>
<a name="ln1530">    {</a>
<a name="ln1531">        if (!(sender is Thumb)) return;</a>
<a name="ln1532"> </a>
<a name="ln1533">        e.Handled = true;</a>
<a name="ln1534"> </a>
<a name="ln1535">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1536">        var width = Math.Max(Selected.Width - e.HorizontalChange, 10);</a>
<a name="ln1537">        var left = Selected.Left - (width - Selected.Width);</a>
<a name="ln1538"> </a>
<a name="ln1539">        if (left &lt; 0)</a>
<a name="ln1540">        {</a>
<a name="ln1541">            width -= left * -1;</a>
<a name="ln1542">            left = 0;</a>
<a name="ln1543">        }</a>
<a name="ln1544"> </a>
<a name="ln1545">        Selected = new Rect(left, Selected.Top, width, Selected.Height);</a>
<a name="ln1546"> </a>
<a name="ln1547">        var point = Mouse.GetPosition(this);</a>
<a name="ln1548"> </a>
<a name="ln1549">        AdjustThumbs();</a>
<a name="ln1550">        AdjustStatusControls(point);</a>
<a name="ln1551">        DetectBlindSpots();</a>
<a name="ln1552">        AdjustInfo(point);</a>
<a name="ln1553">    }</a>
<a name="ln1554"> </a>
<a name="ln1555">    /// &lt;summary&gt;</a>
<a name="ln1556">    /// Handler for resizing from the top-middle.</a>
<a name="ln1557">    /// &lt;/summary&gt;</a>
<a name="ln1558">    private void HandleTop(object sender, DragDeltaEventArgs e)</a>
<a name="ln1559">    {</a>
<a name="ln1560">        if (!(sender is Thumb)) return;</a>
<a name="ln1561"> </a>
<a name="ln1562">        e.Handled = true;</a>
<a name="ln1563"> </a>
<a name="ln1564">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1565">        var height = Math.Max(Selected.Height - e.VerticalChange, 10);</a>
<a name="ln1566">        var top = Selected.Top - (height - Selected.Height);</a>
<a name="ln1567"> </a>
<a name="ln1568">        if (top &lt; 0)</a>
<a name="ln1569">        {</a>
<a name="ln1570">            height -= top * -1;</a>
<a name="ln1571">            top = 0;</a>
<a name="ln1572">        }</a>
<a name="ln1573"> </a>
<a name="ln1574">        Selected = new Rect(Selected.Left, top, Selected.Width, height);</a>
<a name="ln1575"> </a>
<a name="ln1576">        var point = Mouse.GetPosition(this);</a>
<a name="ln1577"> </a>
<a name="ln1578">        AdjustThumbs();</a>
<a name="ln1579">        AdjustStatusControls(point);</a>
<a name="ln1580">        DetectBlindSpots();</a>
<a name="ln1581">        AdjustInfo(point);</a>
<a name="ln1582">    }</a>
<a name="ln1583"> </a>
<a name="ln1584">    /// &lt;summary&gt;</a>
<a name="ln1585">    ///  Handler for resizing from the right-middle.</a>
<a name="ln1586">    /// &lt;/summary&gt;</a>
<a name="ln1587">    private void HandleRight(object sender, DragDeltaEventArgs e)</a>
<a name="ln1588">    {</a>
<a name="ln1589">        if (!(sender is Thumb)) return;</a>
<a name="ln1590"> </a>
<a name="ln1591">        e.Handled = true;</a>
<a name="ln1592"> </a>
<a name="ln1593">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1594">        var width = Math.Max(Selected.Width + e.HorizontalChange, 10);</a>
<a name="ln1595"> </a>
<a name="ln1596">        if (Selected.Left + width &gt; ActualWidth)</a>
<a name="ln1597">            width = ActualWidth - Selected.Left;</a>
<a name="ln1598"> </a>
<a name="ln1599">        Selected = new Rect(Selected.Left, Selected.Top, width, Selected.Height);</a>
<a name="ln1600"> </a>
<a name="ln1601">        var point = Mouse.GetPosition(this);</a>
<a name="ln1602"> </a>
<a name="ln1603">        AdjustThumbs();</a>
<a name="ln1604">        DetectBlindSpots();</a>
<a name="ln1605">        AdjustStatusControls(point);</a>
<a name="ln1606">        AdjustInfo(point);</a>
<a name="ln1607">    }</a>
<a name="ln1608"> </a>
<a name="ln1609">    /// &lt;summary&gt;</a>
<a name="ln1610">    /// Handler for resizing from the bottom-middle.</a>
<a name="ln1611">    /// &lt;/summary&gt;</a>
<a name="ln1612">    private void HandleBottom(object sender, DragDeltaEventArgs e)</a>
<a name="ln1613">    {</a>
<a name="ln1614">        if (!(sender is Thumb)) return;</a>
<a name="ln1615"> </a>
<a name="ln1616">        e.Handled = true;</a>
<a name="ln1617"> </a>
<a name="ln1618">        //Change the size by the amount the user drags the cursor.</a>
<a name="ln1619">        var height = Math.Max(Selected.Height + e.VerticalChange, 10);</a>
<a name="ln1620"> </a>
<a name="ln1621">        if (Selected.Top + height &gt; ActualHeight)</a>
<a name="ln1622">            height = ActualHeight - Selected.Top;</a>
<a name="ln1623"> </a>
<a name="ln1624">        Selected = new Rect(Selected.Left, Selected.Top, Selected.Width, height);</a>
<a name="ln1625"> </a>
<a name="ln1626">        var point = Mouse.GetPosition(this);</a>
<a name="ln1627"> </a>
<a name="ln1628">        AdjustThumbs();</a>
<a name="ln1629">        AdjustStatusControls(point);</a>
<a name="ln1630">        DetectBlindSpots();</a>
<a name="ln1631">        AdjustInfo(point);</a>
<a name="ln1632">    }</a>
<a name="ln1633"> </a>
<a name="ln1634">    /// &lt;summary&gt;</a>
<a name="ln1635">    /// Handler for moving the selection.</a>
<a name="ln1636">    /// &lt;/summary&gt;</a>
<a name="ln1637">    private void HandleCenter(DragDeltaEventArgs e)</a>
<a name="ln1638">    {</a>
<a name="ln1639">        e.Handled = true;</a>
<a name="ln1640"> </a>
<a name="ln1641">        var sel = new Rect(Selected.Left + e.HorizontalChange, Selected.Top + e.VerticalChange, Selected.Width, Selected.Height);</a>
<a name="ln1642"> </a>
<a name="ln1643">        #region Limit the drag to inside the bounds</a>
<a name="ln1644"> </a>
<a name="ln1645">        if (sel.Left &lt; 0)</a>
<a name="ln1646">            sel.X = 0;</a>
<a name="ln1647"> </a>
<a name="ln1648">        if (sel.Top &lt; 0)</a>
<a name="ln1649">            sel.Y = 0;</a>
<a name="ln1650"> </a>
<a name="ln1651">        if (sel.Right &gt; ActualWidth)</a>
<a name="ln1652">            sel.X = ActualWidth - sel.Width;</a>
<a name="ln1653"> </a>
<a name="ln1654">        if (sel.Bottom &gt; ActualHeight)</a>
<a name="ln1655">            sel.Y = ActualHeight - sel.Height;</a>
<a name="ln1656"> </a>
<a name="ln1657">        #endregion</a>
<a name="ln1658"> </a>
<a name="ln1659">        Selected = new Rect(sel.Left, sel.Top, sel.Width, sel.Height);</a>
<a name="ln1660"> </a>
<a name="ln1661">        var point = Mouse.GetPosition(this);</a>
<a name="ln1662"> </a>
<a name="ln1663">        AdjustThumbs();</a>
<a name="ln1664">        AdjustStatusControls(point);</a>
<a name="ln1665">        DetectBlindSpots();</a>
<a name="ln1666">        AdjustInfo(point);</a>
<a name="ln1667">    }</a>
<a name="ln1668"> </a>
<a name="ln1669">    #endregion</a>
<a name="ln1670">}</a>
</code></pre>
<div class="balloon" rel="1364"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3095/" target="_blank">V3095</a> The '_rectangle' object was used before it was verified against null. Check lines: 1364, 1365.</p></div>
<div class="balloon" rel="449"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3063/" target="_blank">V3063</a> A part of conditional expression is always false if it is evaluated: e.Key == Key.Return.</p></div>
<div class="balloon" rel="627"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<div class="balloon" rel="674"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5606/" target="_blank">V5606</a> An empty exception handler. Silent suppression of exceptions may hide the presence of bugs or vulnerabilities.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>