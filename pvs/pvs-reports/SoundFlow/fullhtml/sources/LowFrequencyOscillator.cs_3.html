<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>LowFrequencyOscillator.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">ï»¿using SoundFlow.Abstracts;</a>
<a name="ln2"> </a>
<a name="ln3">namespace SoundFlow.Components;</a>
<a name="ln4"> </a>
<a name="ln5">/// &lt;summary&gt;</a>
<a name="ln6">/// A Low Frequency Oscillator (LFO) component that generates periodic waveforms at a sub-audio rate.</a>
<a name="ln7">/// &lt;/summary&gt;</a>
<a name="ln8">public class LowFrequencyOscillator : SoundComponent</a>
<a name="ln9">{</a>
<a name="ln10">    /// &lt;inheritdoc/&gt;</a>
<a name="ln11">    public override string Name { get; set; } = &quot;LFO&quot;;</a>
<a name="ln12"> </a>
<a name="ln13">    /// &lt;summary&gt;</a>
<a name="ln14">    /// Defines the different waveform shapes that the LFO can generate.</a>
<a name="ln15">    /// &lt;/summary&gt;</a>
<a name="ln16">    public enum WaveformType</a>
<a name="ln17">    {</a>
<a name="ln18">        /// &lt;summary&gt;</a>
<a name="ln19">        /// A smooth, sinusoidal waveform.</a>
<a name="ln20">        /// &lt;/summary&gt;</a>
<a name="ln21">        Sine,</a>
<a name="ln22">        /// &lt;summary&gt;</a>
<a name="ln23">        /// A waveform that alternates abruptly between two levels, creating a pulse.</a>
<a name="ln24">        /// &lt;/summary&gt;</a>
<a name="ln25">        Square,</a>
<a name="ln26">        /// &lt;summary&gt;</a>
<a name="ln27">        /// A waveform that linearly ramps up and down, creating a triangular shape.</a>
<a name="ln28">        /// &lt;/summary&gt;</a>
<a name="ln29">        Triangle,</a>
<a name="ln30">        /// &lt;summary&gt;</a>
<a name="ln31">        /// A waveform that ramps upwards linearly and then abruptly resets to the starting level.</a>
<a name="ln32">        /// &lt;/summary&gt;</a>
<a name="ln33">        Sawtooth,</a>
<a name="ln34">        /// &lt;summary&gt;</a>
<a name="ln35">        /// A waveform that ramps downwards linearly and then abruptly resets to the starting level.</a>
<a name="ln36">        /// &lt;/summary&gt;</a>
<a name="ln37">        ReverseSawtooth,</a>
<a name="ln38">        /// &lt;summary&gt;</a>
<a name="ln39">        /// A waveform that generates random values at each sample.</a>
<a name="ln40">        /// &lt;/summary&gt;</a>
<a name="ln41">        Random,</a>
<a name="ln42">        /// &lt;summary&gt;</a>
<a name="ln43">        /// A waveform that holds a random value constant for a cycle and then changes to a new random value.</a>
<a name="ln44">        /// &lt;/summary&gt;</a>
<a name="ln45">        SampleAndHold</a>
<a name="ln46">    }</a>
<a name="ln47"> </a>
<a name="ln48">    /// &lt;summary&gt;</a>
<a name="ln49">    /// Defines how the LFO's phase is triggered or progresses.</a>
<a name="ln50">    /// &lt;/summary&gt;</a>
<a name="ln51">    public enum TriggerMode</a>
<a name="ln52">    {</a>
<a name="ln53">        /// &lt;summary&gt;</a>
<a name="ln54">        /// The LFO runs continuously without any external triggering.</a>
<a name="ln55">        /// &lt;/summary&gt;</a>
<a name="ln56">        FreeRunning,</a>
<a name="ln57">        /// &lt;summary&gt;</a>
<a name="ln58">        /// The LFO's phase is reset to the &lt;see cref=&quot;Phase&quot;/&gt; value each time the &lt;see cref=&quot;Trigger&quot;/&gt; method is called.</a>
<a name="ln59">        /// &lt;/summary&gt;</a>
<a name="ln60">        NoteTrigger</a>
<a name="ln61">    }</a>
<a name="ln62"> </a>
<a name="ln63">    // Parameters</a>
<a name="ln64">    private float _rate = 1f;</a>
<a name="ln65"> </a>
<a name="ln66">    /// &lt;summary&gt;</a>
<a name="ln67">    /// Gets or sets the rate of the LFO in Hertz (cycles per second).</a>
<a name="ln68">    /// This determines how fast the waveform oscillates. Must be a non-negative value.</a>
<a name="ln69">    /// &lt;/summary&gt;</a>
<a name="ln70">    public float Rate</a>
<a name="ln71">    {</a>
<a name="ln72">        get =&gt; _rate;</a>
<a name="ln73">        set =&gt; _rate = Math.Max(0f, value);</a>
<a name="ln74">    }</a>
<a name="ln75"> </a>
<a name="ln76">    private float _depth = 1f;</a>
<a name="ln77"> </a>
<a name="ln78">    /// &lt;summary&gt;</a>
<a name="ln79">    /// Gets or sets the depth or amplitude of the LFO output, typically in the range of 0 to 1 or beyond for more pronounced effects.</a>
<a name="ln80">    /// This scales the output waveform.</a>
<a name="ln81">    /// &lt;/summary&gt;</a>
<a name="ln82">    public float Depth</a>
<a name="ln83">    {</a>
<a name="ln84">        get =&gt; _depth;</a>
<a name="ln85">        set =&gt; _depth = value;</a>
<a name="ln86">    }</a>
<a name="ln87"> </a>
<a name="ln88">    /// &lt;summary&gt;</a>
<a name="ln89">    /// Gets or sets the type of waveform generated by the LFO.</a>
<a name="ln90">    /// See &lt;see cref=&quot;WaveformType&quot;/&gt; for available waveform shapes.</a>
<a name="ln91">    /// &lt;/summary&gt;</a>
<a name="ln92">    public WaveformType Type { get; set; } = WaveformType.Sine;</a>
<a name="ln93"> </a>
<a name="ln94">    /// &lt;summary&gt;</a>
<a name="ln95">    /// Gets or sets the trigger mode of the LFO, determining how its phase is controlled.</a>
<a name="ln96">    /// See &lt;see cref=&quot;TriggerMode&quot;/&gt; for available trigger modes.</a>
<a name="ln97">    /// &lt;/summary&gt;</a>
<a name="ln98">    public TriggerMode Mode { get; set; } = TriggerMode.FreeRunning;</a>
<a name="ln99"> </a>
<a name="ln100">    /// &lt;summary&gt;</a>
<a name="ln101">    /// Gets or sets the phase offset of the LFO in radians.</a>
<a name="ln102">    /// This allows for shifting the starting point of the waveform.</a>
<a name="ln103">    /// &lt;/summary&gt;</a>
<a name="ln104">    public float Phase { get; set; } = 0f;</a>
<a name="ln105"> </a>
<a name="ln106">    /// &lt;summary&gt;</a>
<a name="ln107">    /// An event that is invoked whenever the LFO's output value changes during audio generation.</a>
<a name="ln108">    /// Subscribers can use this to react to changes in the LFO's output, for example, to drive visualisations or other components.</a>
<a name="ln109">    /// &lt;/summary&gt;</a>
<a name="ln110">    public Action&lt;float&gt;? OnOutputChanged { get; set; }</a>
<a name="ln111"> </a>
<a name="ln112">    // Internal state</a>
<a name="ln113">    private float _phaseIncrement;</a>
<a name="ln114">    private float _currentPhase;</a>
<a name="ln115">    private readonly Random _random = new();</a>
<a name="ln116">    private float _lastOutput;</a>
<a name="ln117">    private float _shValue;</a>
<a name="ln118"> </a>
<a name="ln119">    /// &lt;summary&gt;</a>
<a name="ln120">    /// Triggers the LFO to reset its phase if in &lt;see cref=&quot;TriggerMode.NoteTrigger&quot;/&gt; mode.</a>
<a name="ln121">    /// For Sample and Hold waveform, it also updates the held random value.</a>
<a name="ln122">    /// This method has no effect if the LFO is in &lt;see cref=&quot;TriggerMode.FreeRunning&quot;/&gt; mode.</a>
<a name="ln123">    /// &lt;/summary&gt;</a>
<a name="ln124">    public void Trigger()</a>
<a name="ln125">    {</a>
<a name="ln126">        if (Mode != TriggerMode.NoteTrigger) return;</a>
<a name="ln127">        _currentPhase = Phase; // Reset phase on trigger</a>
<a name="ln128">        if (Type == WaveformType.SampleAndHold)</a>
<a name="ln129">        {</a>
<a name="ln130">            _shValue = (float)(_random.NextDouble() * 2.0 - 1.0); // Update S&amp;H value on trigger</a>
<a name="ln131">        }</a>
<a name="ln132">    }</a>
<a name="ln133"> </a>
<a name="ln134">    /// &lt;inheritdoc/&gt;</a>
<a name="ln135">    protected override void GenerateAudio(Span&lt;float&gt; buffer)</a>
<a name="ln136">    {</a>
<a name="ln137">        _phaseIncrement = (float)(2.0 * Math.PI * Rate / AudioEngine.Instance.SampleRate);</a>
<a name="ln138"> </a>
<a name="ln139">        for (var i = 0; i &lt; buffer.Length; i++)</a>
<a name="ln140">        {</a>
<a name="ln141">            buffer[i] = GenerateSample();</a>
<a name="ln142">        }</a>
<a name="ln143">    }</a>
<a name="ln144"> </a>
<a name="ln145">    /// &lt;summary&gt;</a>
<a name="ln146">    /// Generates a single sample of the LFO waveform based on the current parameters and internal state.</a>
<a name="ln147">    /// &lt;/summary&gt;</a>
<a name="ln148">    /// &lt;returns&gt;The generated LFO sample value.&lt;/returns&gt;</a>
<a name="ln149">    private float GenerateSample()</a>
<a name="ln150">    {</a>
<a name="ln151">        var sampleValue = 0f;</a>
<a name="ln152"> </a>
<a name="ln153">        switch (Type)</a>
<a name="ln154">        {</a>
<a name="ln155">            case WaveformType.Sine:</a>
<a name="ln156">                sampleValue = MathF.Sin(_currentPhase + Phase);</a>
<a name="ln157">                break;</a>
<a name="ln158">            case WaveformType.Square:</a>
<a name="ln159">                sampleValue = (_currentPhase + Phase) % (2 * Math.PI) &lt; Math.PI ? 1f : -1f;</a>
<a name="ln160">                break;</a>
<a name="ln161">            case WaveformType.Triangle:</a>
<a name="ln162">            {</a>
<a name="ln163">                var phaseValue = (_currentPhase + Phase) / (float)(2.0 * Math.PI);</a>
<a name="ln164">                var progress = phaseValue - (int)phaseValue; // Normalize to 0-1</a>
<a name="ln165">                sampleValue = progress &lt; 0.5f ? 4f * progress - 1f : -4f * progress + 3f;</a>
<a name="ln166">                break;</a>
<a name="ln167">            }</a>
<a name="ln168">            case WaveformType.Sawtooth:</a>
<a name="ln169">                sampleValue = 2f * (((_currentPhase + Phase) % (2 * MathF.PI)) / (float)(2.0 * Math.PI)) - 1f;</a>
<a name="ln170">                break;</a>
<a name="ln171">            case WaveformType.ReverseSawtooth:</a>
<a name="ln172">                sampleValue = 1f - 2f * (((_currentPhase + Phase) % (2 * MathF.PI)) / (float)(2.0 * Math.PI));</a>
<a name="ln173">                break;</a>
<a name="ln174">            case WaveformType.Random:</a>
<a name="ln175">                sampleValue = (float)(_random.NextDouble() * 2.0 - 1.0);</a>
<a name="ln176">                break;</a>
<a name="ln177">            case WaveformType.SampleAndHold:</a>
<a name="ln178">                if (Mode == TriggerMode.FreeRunning)</a>
<a name="ln179">                {</a>
<a name="ln180">                    // Update on each new cycle</a>
<a name="ln181">                    if (_currentPhase &lt; _phaseIncrement) // Approaching the start of a new cycle</a>
<a name="ln182">                        _shValue = (float)(_random.NextDouble() * 2.0 - 1.0);</a>
<a name="ln183">                }</a>
<a name="ln184"> </a>
<a name="ln185">                // In NoteTrigger mode, _shValue is updated in the Trigger() method</a>
<a name="ln186">                sampleValue = _shValue;</a>
<a name="ln187">                break;</a>
<a name="ln188">        }</a>
<a name="ln189"> </a>
<a name="ln190">        // Update the phase (only if FreeRunning)</a>
<a name="ln191">        if (Mode == TriggerMode.FreeRunning)</a>
<a name="ln192">        {</a>
<a name="ln193">            _currentPhase += _phaseIncrement;</a>
<a name="ln194">            if (_currentPhase &gt;= 2.0 * Math.PI)</a>
<a name="ln195">            {</a>
<a name="ln196">                _currentPhase -= (float)(2.0 * Math.PI);</a>
<a name="ln197">            }</a>
<a name="ln198">        }</a>
<a name="ln199"> </a>
<a name="ln200">        // Store the current output AFTER phase update</a>
<a name="ln201">        _lastOutput = sampleValue * Depth;</a>
<a name="ln202"> </a>
<a name="ln203">        // Call the OnOutputChanged event</a>
<a name="ln204">        OnOutputChanged?.Invoke(_lastOutput);</a>
<a name="ln205"> </a>
<a name="ln206">        // Scale by depth and return</a>
<a name="ln207">        return _lastOutput;</a>
<a name="ln208">    }</a>
<a name="ln209"> </a>
<a name="ln210">    /// &lt;summary&gt;</a>
<a name="ln211">    /// Gets the last generated output value of the LFO.</a>
<a name="ln212">    /// &lt;/summary&gt;</a>
<a name="ln213">    /// &lt;returns&gt;The last output value.&lt;/returns&gt;</a>
<a name="ln214">    public float GetLastOutput()</a>
<a name="ln215">    {</a>
<a name="ln216">        return _lastOutput;</a>
<a name="ln217">    }</a>
<a name="ln218">}</a>
</code></pre>
<div class="balloon" rel="159"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3109/" target="_blank">V3109</a> The 'Math.PI' sub-expression is present on both sides of the operator. The expression is incorrect or it can be simplified.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>