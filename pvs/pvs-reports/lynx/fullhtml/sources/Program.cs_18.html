<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Program.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">ï»¿using Lynx;</a>
<a name="ln2">using Lynx.ConstantsGenerator;</a>
<a name="ln3">using Lynx.Model;</a>
<a name="ln4">using System.Diagnostics;</a>
<a name="ln5">using System.Numerics;</a>
<a name="ln6">using System.Runtime.CompilerServices;</a>
<a name="ln7">using System.Runtime.InteropServices;</a>
<a name="ln8">using System.Text;</a>
<a name="ln9">using System.Threading.Channels;</a>
<a name="ln10">using static Lynx.EvaluationConstants;</a>
<a name="ln11">using static Lynx.TunableEvalParameters;</a>
<a name="ln12"> </a>
<a name="ln13">//_2_GettingStarted();</a>
<a name="ln14">//_3_PawnAttacks();</a>
<a name="ln15">//_4_KnightAttacks();</a>
<a name="ln16">//_5_KingAttacks();</a>
<a name="ln17">//_6_Bishop_Occupancy();</a>
<a name="ln18">//_7_Rook_Occupancy();</a>
<a name="ln19">//_8_Slider_Pieces_Attacks();</a>
<a name="ln20">//_9_BitCount();</a>
<a name="ln21">//_10_SetOccupancy();</a>
<a name="ln22">//_11_OccupancyBitCountLookupTables();</a>
<a name="ln23">//_13_GeneratingMagicNumbersCandidates();</a>
<a name="ln24">//_14_GeneratingMagicNumbersByBruteForce();</a>
<a name="ln25">//_16_InitializingSliderPiecesAttackTables();</a>
<a name="ln26">//_17_Defining_variables();</a>
<a name="ln27">//_18_Printing_Chess_Board();</a>
<a name="ln28">//_19_Parse_FEN();</a>
<a name="ln29">//_20_QueenAttacks();</a>
<a name="ln30">//_21_IsSqureAttacked();</a>
<a name="ln31">//_22_Generate_Moves();</a>
<a name="ln32">//_23_Castling_Moves();</a>
<a name="ln33">//_26_Piece_Moves();</a>
<a name="ln34">//_27_Move_Encoding();</a>
<a name="ln35">//_29_Move_List();</a>
<a name="ln36">//_32_Make_Move();</a>
<a name="ln37">//_42_Perft();</a>
<a name="ln38">//_43_Divide();</a>
<a name="ln39">//_44_ParseUCI();</a>
<a name="ln40">//_49_Rudimetary_Evaluation();</a>
<a name="ln41">//_50_MiniMax_AlphaBeta();</a>
<a name="ln42">//_52_Quiescence_Search();</a>
<a name="ln43">//_53_MVVLVA();</a>
<a name="ln44">//_54_ScoreMove();</a>
<a name="ln45">//ZobristTable();</a>
<a name="ln46">//PV_Table();</a>
<a name="ln47">//CountBits();</a>
<a name="ln48">//GetLS1BIndex();</a>
<a name="ln49">//FileAndRankMasks();</a>
<a name="ln50">//EnhancedPawnEvaluation();</a>
<a name="ln51">//RookEvaluation();</a>
<a name="ln52">//TranspositionTableMethod();</a>
<a name="ln53">//UnmakeMove();</a>
<a name="ln54">//PieceSquareTables();</a>
<a name="ln55">//NewMasks();</a>
<a name="ln56">//DarkLightSquares();</a>
<a name="ln57">PawnIslands();</a>
<a name="ln58"> </a>
<a name="ln59">#pragma warning disable IDE0059 // Unnecessary assignment of a value</a>
<a name="ln60">const string TrickyPosition = Constants.TrickyTestPositionFEN;</a>
<a name="ln61">const string TrickyPositionReversed = Constants.TrickyTestPositionReversedFEN;</a>
<a name="ln62">const string KillerPosition = Constants.KillerTestPositionFEN;</a>
<a name="ln63">const string CmkPosition = Constants.CmkTestPositionFEN;</a>
<a name="ln64">#pragma warning restore IDE0059 // Unnecessary assignment of a value</a>
<a name="ln65"> </a>
<a name="ln66">static void _2_GettingStarted()</a>
<a name="ln67">{</a>
<a name="ln68">    var board = 4UL;</a>
<a name="ln69">    board.SetBit(BoardSquare.e4);</a>
<a name="ln70">    board.Print();</a>
<a name="ln71">    board.PopBit(BoardSquare.e4);</a>
<a name="ln72">    board.Print();</a>
<a name="ln73">    board.PopBit(BoardSquare.e4);</a>
<a name="ln74">    board.Print();</a>
<a name="ln75"> </a>
<a name="ln76">    Console.ReadKey();</a>
<a name="ln77">}</a>
<a name="ln78"> </a>
<a name="ln79">static void _3_PawnAttacks()</a>
<a name="ln80">{</a>
<a name="ln81">    var whiteAttacks = AttackGenerator.MaskPawnAttacks((int)BoardSquare.e4, isWhite: true);</a>
<a name="ln82">    var blackAttacks = AttackGenerator.MaskPawnAttacks((int)BoardSquare.e4, isWhite: false);</a>
<a name="ln83"> </a>
<a name="ln84">    whiteAttacks.Print();</a>
<a name="ln85">    blackAttacks.Print();</a>
<a name="ln86"> </a>
<a name="ln87">    AttackGenerator.InitializePawnAttacks();</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">static void _4_KnightAttacks()</a>
<a name="ln91">{</a>
<a name="ln92">    var attacks = AttackGenerator.MaskKnightAttacks((int)BoardSquare.e4);</a>
<a name="ln93">    attacks.Print();</a>
<a name="ln94"> </a>
<a name="ln95">    attacks = AttackGenerator.MaskKnightAttacks((int)BoardSquare.h4);</a>
<a name="ln96">    attacks.Print();</a>
<a name="ln97"> </a>
<a name="ln98">    attacks = AttackGenerator.MaskKnightAttacks((int)BoardSquare.a4);</a>
<a name="ln99">    attacks.Print();</a>
<a name="ln100"> </a>
<a name="ln101">    AttackGenerator.InitializeKnightAttacks();</a>
<a name="ln102">}</a>
<a name="ln103"> </a>
<a name="ln104">static void _5_KingAttacks()</a>
<a name="ln105">{</a>
<a name="ln106">    var attacks = AttackGenerator.MaskKingAttacks((int)BoardSquare.e4);</a>
<a name="ln107">    attacks.Print();</a>
<a name="ln108"> </a>
<a name="ln109">    attacks = AttackGenerator.MaskKingAttacks((int)BoardSquare.h4);</a>
<a name="ln110">    attacks.Print();</a>
<a name="ln111"> </a>
<a name="ln112">    attacks = AttackGenerator.MaskKingAttacks((int)BoardSquare.a4);</a>
<a name="ln113">    attacks.Print();</a>
<a name="ln114"> </a>
<a name="ln115">    AttackGenerator.InitializeKingAttacks();</a>
<a name="ln116">}</a>
<a name="ln117"> </a>
<a name="ln118">static void _6_Bishop_Occupancy()</a>
<a name="ln119">{</a>
<a name="ln120">    var occupancy = AttackGenerator.MaskBishopOccupancy((int)BoardSquare.h8);</a>
<a name="ln121">    occupancy.Print();</a>
<a name="ln122"> </a>
<a name="ln123">    AttackGenerator.InitializeBishopOccupancy();</a>
<a name="ln124">}</a>
<a name="ln125"> </a>
<a name="ln126">static void _7_Rook_Occupancy()</a>
<a name="ln127">{</a>
<a name="ln128">    var occupancy = AttackGenerator.MaskRookOccupancy((int)BoardSquare.e4);</a>
<a name="ln129">    occupancy.Print();</a>
<a name="ln130"> </a>
<a name="ln131">    AttackGenerator.InitializeRookOccupancy();</a>
<a name="ln132">}</a>
<a name="ln133"> </a>
<a name="ln134">static void _8_Slider_Pieces_Attacks()</a>
<a name="ln135">{</a>
<a name="ln136">    // Occupancy bitboard</a>
<a name="ln137">    BitBoard block = default;</a>
<a name="ln138"> </a>
<a name="ln139">    block.SetBit(BoardSquare.b6);</a>
<a name="ln140">    block.SetBit(BoardSquare.g7);</a>
<a name="ln141">    block.SetBit(BoardSquare.f2);</a>
<a name="ln142">    block.SetBit(BoardSquare.b2);</a>
<a name="ln143"> </a>
<a name="ln144">    var bishopAttacks = AttackGenerator.GenerateBishopAttacksOnTheFly((int)BoardSquare.d4, block);</a>
<a name="ln145"> </a>
<a name="ln146">    block.Print();</a>
<a name="ln147">    bishopAttacks.Print();</a>
<a name="ln148"> </a>
<a name="ln149">    block = BitBoardExtensions.Initialize(BoardSquare.d3, BoardSquare.b4, BoardSquare.d7, BoardSquare.h4);</a>
<a name="ln150"> </a>
<a name="ln151">    var rookAttacks = AttackGenerator.GenerateRookAttacksOnTheFly((int)BoardSquare.d4, block);</a>
<a name="ln152">    block.Print();</a>
<a name="ln153">    rookAttacks.Print();</a>
<a name="ln154">}</a>
<a name="ln155"> </a>
<a name="ln156">static void _9_BitCount()</a>
<a name="ln157">{</a>
<a name="ln158">    BitBoard bitBoard = BitBoardExtensions.Initialize(BoardSquare.d5, BoardSquare.e4);</a>
<a name="ln159"> </a>
<a name="ln160">    bitBoard.ResetLS1B();</a>
<a name="ln161">    bitBoard.Print();</a>
<a name="ln162"> </a>
<a name="ln163">    var bb = BitBoardExtensions.Initialize(BoardSquare.d5, BoardSquare.e4);</a>
<a name="ln164"> </a>
<a name="ln165">    Console.WriteLine(bb.GetLS1BIndex());</a>
<a name="ln166">    Console.WriteLine(bb.GetLS1BIndex());</a>
<a name="ln167">    Console.WriteLine(Constants.Coordinates[bb.GetLS1BIndex()]);</a>
<a name="ln168">}</a>
<a name="ln169"> </a>
<a name="ln170">static void _10_SetOccupancy()</a>
<a name="ln171">{</a>
<a name="ln172">    // Mask piece attacks at given square</a>
<a name="ln173">    var occupancyMask = AttackGenerator.MaskRookOccupancy((int)BoardSquare.a5);</a>
<a name="ln174"> </a>
<a name="ln175">    var occupancy = AttackGenerator.SetBishopOrRookOccupancy(4095, occupancyMask);</a>
<a name="ln176">    occupancy.Print();</a>
<a name="ln177"> </a>
<a name="ln178">    var ind = (int)Math.Pow(2, 6) - 1;</a>
<a name="ln179">    occupancy = AttackGenerator.SetBishopOrRookOccupancy(ind, occupancyMask);</a>
<a name="ln180">    occupancy.Print();</a>
<a name="ln181"> </a>
<a name="ln182">    // Loop over occupancy indexes</a>
<a name="ln183">    for (int index = 0; index &lt; 4096; ++index)</a>
<a name="ln184">    {</a>
<a name="ln185">        occupancy = AttackGenerator.SetBishopOrRookOccupancy(index, occupancyMask);</a>
<a name="ln186">        occupancy.Print();</a>
<a name="ln187">        Console.ReadKey();</a>
<a name="ln188">    }</a>
<a name="ln189"> </a>
<a name="ln190">    occupancyMask = AttackGenerator.MaskBishopOccupancy((int)BoardSquare.d4);</a>
<a name="ln191">    occupancyMask.Print();</a>
<a name="ln192"> </a>
<a name="ln193">    // Loop over occupancy indexes</a>
<a name="ln194">    for (int index = 0; index &lt; 64; ++index)</a>
<a name="ln195">    {</a>
<a name="ln196">        occupancy = AttackGenerator.SetBishopOrRookOccupancy(index, occupancyMask);</a>
<a name="ln197">        occupancy.Print();</a>
<a name="ln198">        Console.ReadKey();</a>
<a name="ln199">    }</a>
<a name="ln200">}</a>
<a name="ln201"> </a>
<a name="ln202">static void _11_OccupancyBitCountLookupTables()</a>
<a name="ln203">{</a>
<a name="ln204">    for (var rank = 0; rank &lt; 8; ++rank)</a>
<a name="ln205">    {</a>
<a name="ln206">        for (var file = 0; file &lt; 8; ++file)</a>
<a name="ln207">        {</a>
<a name="ln208">            int square = BitBoardExtensions.SquareIndex(rank, file);</a>
<a name="ln209"> </a>
<a name="ln210">            var bishopOccupancy = AttackGenerator.MaskBishopOccupancy(square);</a>
<a name="ln211">            Console.Write($&quot;{bishopOccupancy.CountBits()}, &quot;);</a>
<a name="ln212">        }</a>
<a name="ln213"> </a>
<a name="ln214">        Console.WriteLine();</a>
<a name="ln215">    }</a>
<a name="ln216"> </a>
<a name="ln217">    for (var rank = 0; rank &lt; 8; ++rank)</a>
<a name="ln218">    {</a>
<a name="ln219">        for (var file = 0; file &lt; 8; ++file)</a>
<a name="ln220">        {</a>
<a name="ln221">            int square = BitBoardExtensions.SquareIndex(rank, file);</a>
<a name="ln222"> </a>
<a name="ln223">            var bishopOccupancy = AttackGenerator.MaskRookOccupancy(square);</a>
<a name="ln224">            Console.Write($&quot;{bishopOccupancy.CountBits()}, &quot;);</a>
<a name="ln225">        }</a>
<a name="ln226"> </a>
<a name="ln227">        Console.WriteLine();</a>
<a name="ln228">    }</a>
<a name="ln229">}</a>
<a name="ln230"> </a>
<a name="ln231">static void _13_GeneratingMagicNumbersCandidates()</a>
<a name="ln232">{</a>
<a name="ln233">    const int randomlyGeneratedSeed = 1160218972;</a>
<a name="ln234">    var generator = new Random(randomlyGeneratedSeed);</a>
<a name="ln235"> </a>
<a name="ln236">    var randomNumber = (ulong)generator.Next();</a>
<a name="ln237">    // Slice upper (from MS1b side) 16 bits</a>
<a name="ln238">    randomNumber &amp;= 0xFFFF;</a>
<a name="ln239"> </a>
<a name="ln240">    // int(uint really), which is 32 bits -&gt; ulong, 64 bits leaves the seconf half of the board empty</a>
<a name="ln241">    // The slicing leaves the second quarter empty as well</a>
<a name="ln242">    var randomBoard = randomNumber;</a>
<a name="ln243">    randomBoard.Print();</a>
<a name="ln244"> </a>
<a name="ln245">    var candidate = MagicNumberGenerator.GenerateMagicNumber();</a>
<a name="ln246"> </a>
<a name="ln247">    var board = candidate;</a>
<a name="ln248">    board.Print();</a>
<a name="ln249">}</a>
<a name="ln250"> </a>
<a name="ln251">static void _14_GeneratingMagicNumbersByBruteForce()</a>
<a name="ln252">{</a>
<a name="ln253">    var sw = Stopwatch.StartNew();</a>
<a name="ln254">    MagicNumberGenerator.InitializeMagicNumbers();</a>
<a name="ln255">    Console.WriteLine($&quot;Time: {sw.ElapsedMilliseconds}ms&quot;);</a>
<a name="ln256"> </a>
<a name="ln257">    // Should generate something similar to Constants.RookMagicNumbers</a>
<a name="ln258">}</a>
<a name="ln259"> </a>
<a name="ln260">static void _16_InitializingSliderPiecesAttackTables()</a>
<a name="ln261">{</a>
<a name="ln262">    var occupancy = new BitBoard();</a>
<a name="ln263">    occupancy.SetBit(BoardSquare.e5);</a>
<a name="ln264">    occupancy.SetBit(BoardSquare.d5);</a>
<a name="ln265">    occupancy.SetBit(BoardSquare.d8);</a>
<a name="ln266">    occupancy.Print();</a>
<a name="ln267"> </a>
<a name="ln268">    var bishopAttacks = Attacks.BishopAttacks((int)BoardSquare.d4, occupancy);</a>
<a name="ln269">    bishopAttacks.Print();</a>
<a name="ln270"> </a>
<a name="ln271">    var rookAttacks = Attacks.RookAttacks((int)BoardSquare.d4, occupancy);</a>
<a name="ln272">    rookAttacks.Print();</a>
<a name="ln273">}</a>
<a name="ln274"> </a>
<a name="ln275">static void _17_Defining_variables()</a>
<a name="ln276">{</a>
<a name="ln277">    var position = new Position(Constants.EmptyBoardFEN);</a>
<a name="ln278"> </a>
<a name="ln279">    var whitePawnBitBoard = position.PieceBitBoards[(int)Piece.P];</a>
<a name="ln280">    whitePawnBitBoard.SetBit(BoardSquare.e2);</a>
<a name="ln281">    whitePawnBitBoard.Print();</a>
<a name="ln282"> </a>
<a name="ln283">    Console.WriteLine($&quot;Piece: {Constants.PiecesByChar['K']}&quot;);</a>
<a name="ln284"> </a>
<a name="ln285">    if (RuntimeInformation.IsOSPlatform(OSPlatform.Linux))</a>
<a name="ln286">    {</a>
<a name="ln287">        Console.WriteLine($&quot;Piece: {Constants.UnicodePieces[(int)Piece.K]}&quot;);</a>
<a name="ln288">        // Simulating from FEN</a>
<a name="ln289">        Console.WriteLine($&quot;Piece: {Constants.UnicodePieces[(int)Constants.PiecesByChar['K']]}&quot;);</a>
<a name="ln290">    }</a>
<a name="ln291">    else</a>
<a name="ln292">    {</a>
<a name="ln293">        Console.WriteLine($&quot;Piece: {Constants.AsciiPieces[(int)Piece.K]}&quot;);</a>
<a name="ln294">        // Simulating from FEN</a>
<a name="ln295">        Console.WriteLine($&quot;Piece: {Constants.AsciiPieces[(int)Constants.PiecesByChar['K']]}&quot;);</a>
<a name="ln296">    }</a>
<a name="ln297">}</a>
<a name="ln298"> </a>
<a name="ln299">static void _18_Printing_Chess_Board()</a>
<a name="ln300">{</a>
<a name="ln301">    var position = new Position(Constants.InitialPositionFEN);</a>
<a name="ln302">    position.Print();</a>
<a name="ln303"> </a>
<a name="ln304">    for (int bbIndex = 0; bbIndex &lt; position.PieceBitBoards.Length; ++bbIndex)</a>
<a name="ln305">    {</a>
<a name="ln306">        position.PieceBitBoards[bbIndex].Print();</a>
<a name="ln307">    }</a>
<a name="ln308">}</a>
<a name="ln309"> </a>
<a name="ln310">static void _19_Parse_FEN()</a>
<a name="ln311">{</a>
<a name="ln312">    var position = new Position(CmkPosition);</a>
<a name="ln313"> </a>
<a name="ln314">    position.PieceBitBoards[(int)Piece.Q].Print();</a>
<a name="ln315"> </a>
<a name="ln316">    position.Print();</a>
<a name="ln317">    position.OccupancyBitBoards[(int)Side.White].Print();</a>
<a name="ln318">    position.OccupancyBitBoards[(int)Side.Black].Print();</a>
<a name="ln319">    position.OccupancyBitBoards[(int)Side.Both].Print();</a>
<a name="ln320">}</a>
<a name="ln321"> </a>
<a name="ln322">static void _20_QueenAttacks()</a>
<a name="ln323">{</a>
<a name="ln324">    var position = new Position(Constants.InitialPositionFEN);</a>
<a name="ln325">    Attacks.QueenAttacks((int)BoardSquare.e4, position.OccupancyBitBoards[(int)Side.Both]).Print();</a>
<a name="ln326">}</a>
<a name="ln327"> </a>
<a name="ln328">static void _21_IsSquareAttacked()</a>
<a name="ln329">{</a>
<a name="ln330">    var position = new Position(&quot;8/8/8/3p4/8/8/8/8 w - - 0 1&quot;);</a>
<a name="ln331"> </a>
<a name="ln332">    position.PieceBitBoards[(int)Piece.p].Print();</a>
<a name="ln333"> </a>
<a name="ln334">    Attacks.PawnAttacks[(int)Side.White][(int)BoardSquare.e4].Print();</a>
<a name="ln335"> </a>
<a name="ln336">    var and =</a>
<a name="ln337">        position.PieceBitBoards[(int)Piece.p]</a>
<a name="ln338">        &amp; Attacks.PawnAttacks[(int)Side.White][(int)BoardSquare.e4];</a>
<a name="ln339">    and.Print();</a>
<a name="ln340"> </a>
<a name="ln341">    Console.WriteLine(&quot;=====================================&quot;);</a>
<a name="ln342"> </a>
<a name="ln343">    position = new Position(Constants.EmptyBoardFEN);</a>
<a name="ln344">    position.PieceBitBoards[(int)Piece.n].SetBit(BoardSquare.c6);</a>
<a name="ln345">    position.PieceBitBoards[(int)Piece.n].SetBit(BoardSquare.f6);</a>
<a name="ln346"> </a>
<a name="ln347">    position.PrintAttackedSquares(Side.Black);</a>
<a name="ln348"> </a>
<a name="ln349">    Console.WriteLine(position.IsSquareAttacked((int)BoardSquare.e4, Side.Black));</a>
<a name="ln350"> </a>
<a name="ln351">    Console.WriteLine(&quot;=====================================&quot;);</a>
<a name="ln352"> </a>
<a name="ln353">    position = new Position(Constants.EmptyBoardFEN);</a>
<a name="ln354">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.b7);</a>
<a name="ln355">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.d7);</a>
<a name="ln356">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.f7);</a>
<a name="ln357">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.h7);</a>
<a name="ln358">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.b3);</a>
<a name="ln359">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.d3);</a>
<a name="ln360">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.f3);</a>
<a name="ln361">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.h3);</a>
<a name="ln362">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.d1);</a>
<a name="ln363">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.c4);</a>
<a name="ln364">    position.PieceBitBoards[(int)Piece.q].SetBit(BoardSquare.g4);</a>
<a name="ln365"> </a>
<a name="ln366">    position.PrintAttackedSquares(Side.Black);</a>
<a name="ln367"> </a>
<a name="ln368">    Console.WriteLine(&quot;=====================================&quot;);</a>
<a name="ln369"> </a>
<a name="ln370">    position = new Position(Constants.EmptyBoardFEN);</a>
<a name="ln371">    position.PieceBitBoards[(int)Piece.K].SetBit(BoardSquare.e4);</a>
<a name="ln372">    position.PrintAttackedSquares(Side.White);</a>
<a name="ln373"> </a>
<a name="ln374">    Console.WriteLine(&quot;=====================================&quot;);</a>
<a name="ln375"> </a>
<a name="ln376">    position = new Position(Constants.InitialPositionFEN);</a>
<a name="ln377">    position.PrintAttackedSquares(Side.White);</a>
<a name="ln378">    position.PrintAttackedSquares(Side.Black);</a>
<a name="ln379">}</a>
<a name="ln380"> </a>
<a name="ln381">static void _22_Generate_Moves()</a>
<a name="ln382">{</a>
<a name="ln383">    var position = new Position(&quot;r1P1k2r/p1ppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq - 0 1 &quot;);</a>
<a name="ln384">    position.Print();</a>
<a name="ln385"> </a>
<a name="ln386">    //position.OccupancyBitBoards[2] |= 0b11100111UL &lt;&lt; 8 * 4;</a>
<a name="ln387">    var moves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln388"> </a>
<a name="ln389">    foreach (var move in moves)</a>
<a name="ln390">    {</a>
<a name="ln391">        Console.WriteLine(move);</a>
<a name="ln392">    }</a>
<a name="ln393"> </a>
<a name="ln394">    position = new Position(KillerPosition);</a>
<a name="ln395">    position.PieceBitBoards[0].Print();</a>
<a name="ln396">    position.PieceBitBoards[6].Print();</a>
<a name="ln397">    position.Print();</a>
<a name="ln398">    moves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln399"> </a>
<a name="ln400">    foreach (var move in moves)</a>
<a name="ln401">    {</a>
<a name="ln402">        Console.WriteLine(move);</a>
<a name="ln403">    }</a>
<a name="ln404">}</a>
<a name="ln405"> </a>
<a name="ln406">static void _23_Castling_Moves()</a>
<a name="ln407">{</a>
<a name="ln408">    var position = new Position(&quot;rn2k2r/pppppppp/8/8/8/8/PPPPPPPP/RN2K2R w KQkq - 0 1&quot;);</a>
<a name="ln409">    position.Print();</a>
<a name="ln410"> </a>
<a name="ln411">    int index = 0;</a>
<a name="ln412">    var moves = new Move[Constants.MaxNumberOfPossibleMovesInAPosition];</a>
<a name="ln413"> </a>
<a name="ln414">    MoveGenerator.GenerateCastlingMoves(ref index, moves, position);</a>
<a name="ln415"> </a>
<a name="ln416">    foreach (var move in moves[..index])</a>
<a name="ln417">    {</a>
<a name="ln418">        Console.WriteLine(move);</a>
<a name="ln419">    }</a>
<a name="ln420">}</a>
<a name="ln421"> </a>
<a name="ln422">static void _26_Piece_Moves()</a>
<a name="ln423">{</a>
<a name="ln424">    var position = new Position(TrickyPosition);</a>
<a name="ln425">    position.Print();</a>
<a name="ln426"> </a>
<a name="ln427">    var moves = MoveGenerator.GenerateAllMoves(position).Where(m =&gt; m.Piece() == (int)Piece.N || m.Piece() == (int)Piece.n).ToList();</a>
<a name="ln428">    moves.ForEach(m =&gt; Console.WriteLine(m));</a>
<a name="ln429"> </a>
<a name="ln430">    moves = [.. MoveGenerator.GenerateAllMoves(position)];</a>
<a name="ln431">    Console.WriteLine($&quot;Expected 48, found: {moves.Count}&quot;);</a>
<a name="ln432">    foreach (var move in moves)</a>
<a name="ln433">    {</a>
<a name="ln434">        Console.WriteLine(move);</a>
<a name="ln435">    }</a>
<a name="ln436">}</a>
<a name="ln437"> </a>
<a name="ln438">static void _28_Move_Encoding()</a>
<a name="ln439">{</a>
<a name="ln440">    int move = 0;</a>
<a name="ln441"> </a>
<a name="ln442">    // Target square: h1 (63)</a>
<a name="ln443">    const BoardSquare targetSquare = BoardSquare.h1;</a>
<a name="ln444"> </a>
<a name="ln445">    // Encode move</a>
<a name="ln446">#pragma warning disable S2437 // Silly bit operations should not be performed - Â¬Â¬</a>
<a name="ln447">    move = (move | (int)targetSquare) &lt;&lt; 6;</a>
<a name="ln448">#pragma warning restore S2437 // Silly bit operations should not be performed</a>
<a name="ln449">    Console.WriteLine($&quot;{Convert.ToString(move, 2)}&quot;);</a>
<a name="ln450"> </a>
<a name="ln451">    // Decode move</a>
<a name="ln452">    int square = (move &amp; 0xFC0) &gt;&gt; 6;</a>
<a name="ln453">    Console.WriteLine(Constants.Coordinates[square]);</a>
<a name="ln454">}</a>
<a name="ln455"> </a>
<a name="ln456">static void PrintMoveList(IEnumerable&lt;Move&gt; moves)</a>
<a name="ln457">{</a>
<a name="ln458">    Console.WriteLine($&quot;{&quot;#&quot;,-3}{&quot;Pc&quot;,-3}{&quot;src&quot;,-4}{&quot;x&quot;,-2}{&quot;tgt&quot;,-4}{&quot;DPP&quot;,-4}{&quot;ep&quot;,-3}{&quot;O-O&quot;,-4}{&quot;O-O-O&quot;,-7}\n&quot;);</a>
<a name="ln459"> </a>
<a name="ln460">    static string bts(bool b) =&gt; b ? &quot;1&quot; : &quot;0&quot;;</a>
<a name="ln461">    static string isCapture(bool c) =&gt; c ? &quot;x&quot; : &quot;&quot;;</a>
<a name="ln462"> </a>
<a name="ln463">    var sb = new StringBuilder();</a>
<a name="ln464">    for (int i = 0; i &lt; moves.Count(); ++i)</a>
<a name="ln465">    {</a>
<a name="ln466">        var move = moves.ElementAt(i);</a>
<a name="ln467"> </a>
<a name="ln468">        sb.AppendFormat(&quot;{0,-3}&quot;, i + 1)</a>
<a name="ln469">          .AppendFormat(&quot;{0,-3}&quot;, Constants.AsciiPieces[move.Piece()])</a>
<a name="ln470">          .AppendFormat(&quot;{0,-4}&quot;, Constants.Coordinates[move.SourceSquare()])</a>
<a name="ln471">          .AppendFormat(&quot;{0,-2}&quot;, isCapture(move.IsCapture()))</a>
<a name="ln472">          .AppendFormat(&quot;{0,-4}&quot;, Constants.Coordinates[move.TargetSquare()])</a>
<a name="ln473">          .AppendFormat(&quot;{0,-4}&quot;, bts(move.IsDoublePawnPush()))</a>
<a name="ln474">          .AppendFormat(&quot;{0,-3}&quot;, bts(move.IsEnPassant()))</a>
<a name="ln475">          .AppendFormat(&quot;{0,-4}&quot;, bts(move.IsShortCastle()))</a>
<a name="ln476">          .AppendFormat(&quot;{0,-4}&quot;, bts(move.IsLongCastle()))</a>
<a name="ln477">          .Append(Environment.NewLine);</a>
<a name="ln478">    }</a>
<a name="ln479"> </a>
<a name="ln480">    Console.WriteLine(sb.ToString());</a>
<a name="ln481">}</a>
<a name="ln482"> </a>
<a name="ln483">static void _29_Move_List()</a>
<a name="ln484">{</a>
<a name="ln485">    var position = new Position(TrickyPosition);</a>
<a name="ln486">    var moves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln487">    PrintMoveList(moves);</a>
<a name="ln488"> </a>
<a name="ln489">    position = new Position(TrickyPositionReversed);</a>
<a name="ln490">    moves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln491">    PrintMoveList(moves);</a>
<a name="ln492"> </a>
<a name="ln493">    position = new Position(KillerPosition);</a>
<a name="ln494">    position.Print();</a>
<a name="ln495">    moves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln496">    PrintMoveList(moves);</a>
<a name="ln497">}</a>
<a name="ln498"> </a>
<a name="ln499">static void _32_Make_Move()</a>
<a name="ln500">{</a>
<a name="ln501">    // Arrange</a>
<a name="ln502">    var position = new Position(&quot;r3k2r/1r6/8/3B4/8/8/8/R3K2R w KQkq - 0 1&quot;);</a>
<a name="ln503">    position.Print();</a>
<a name="ln504"> </a>
<a name="ln505">    position = new Position(&quot;r3k2r/8/8/3b4/8/8/6R1/R3K2R b KQkq - 0 1&quot;);</a>
<a name="ln506">    position.Print();</a>
<a name="ln507"> </a>
<a name="ln508">    var game = new Game(TrickyPosition);</a>
<a name="ln509">    var reversedGame = new Game(TrickyPositionReversed);</a>
<a name="ln510">    var gameWithPromotion = new Game(&quot;r3k2r/pPppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq - 0 1&quot;);</a>
<a name="ln511">    //GeneralMoveTest(game);</a>
<a name="ln512">    //CastlingRightsTest(game);</a>
<a name="ln513">    //CastlingRightsTest(reversedGame);</a>
<a name="ln514"> </a>
<a name="ln515">    PrintMoveList(MoveGenerator.GenerateAllMoves(gameWithPromotion.CurrentPosition));</a>
<a name="ln516"> </a>
<a name="ln517">    GeneralMoveTest(gameWithPromotion);</a>
<a name="ln518"> </a>
<a name="ln519">    static void GeneralMoveTest(Game game)</a>
<a name="ln520">    {</a>
<a name="ln521">        foreach (var move in MoveGenerator.GenerateAllMoves(game.CurrentPosition))</a>
<a name="ln522">        {</a>
<a name="ln523">            game.CurrentPosition.Print();</a>
<a name="ln524"> </a>
<a name="ln525">            Console.WriteLine(move.ToEPDString(game.CurrentPosition));</a>
<a name="ln526">            var gameState = game.MakeMove(move);</a>
<a name="ln527">            game.CurrentPosition.Print();</a>
<a name="ln528"> </a>
<a name="ln529">            Console.WriteLine(&quot;White occupancy:&quot;);</a>
<a name="ln530">            game.CurrentPosition.OccupancyBitBoards[(int)Side.White].Print();</a>
<a name="ln531"> </a>
<a name="ln532">            Console.WriteLine(&quot;Black occupancy:&quot;);</a>
<a name="ln533">            game.CurrentPosition.OccupancyBitBoards[(int)Side.Black].Print();</a>
<a name="ln534"> </a>
<a name="ln535">            game.CurrentPosition.UnmakeMove(move, gameState);</a>
<a name="ln536">        }</a>
<a name="ln537">    }</a>
<a name="ln538"> </a>
<a name="ln539">    static void CastlingRightsTest(Game game)</a>
<a name="ln540">    {</a>
<a name="ln541">        foreach (var move in MoveGenerator.GenerateAllMoves(game.CurrentPosition))</a>
<a name="ln542">        {</a>
<a name="ln543">            if (move.Piece() == (int)Piece.R || (move.Piece() == (int)Piece.r)</a>
<a name="ln544">             || move.Piece() == (int)Piece.K || (move.Piece() == (int)Piece.k))</a>
<a name="ln545">            {</a>
<a name="ln546">                game.CurrentPosition.Print();</a>
<a name="ln547"> </a>
<a name="ln548">                Console.WriteLine(move.ToEPDString(game.CurrentPosition));</a>
<a name="ln549">                var gameState = game.MakeMove(move);</a>
<a name="ln550">                game.CurrentPosition.Print();</a>
<a name="ln551">                game.CurrentPosition.UnmakeMove(move, gameState);</a>
<a name="ln552">            }</a>
<a name="ln553">        }</a>
<a name="ln554">    }</a>
<a name="ln555">}</a>
<a name="ln556"> </a>
<a name="ln557">static void _42_Perft()</a>
<a name="ln558">{</a>
<a name="ln559">    // Leaf nodes (number of positions) reached dring the test if the move generator at a given depth</a>
<a name="ln560"> </a>
<a name="ln561">    var pos = new Position(TrickyPosition);</a>
<a name="ln562"> </a>
<a name="ln563">    for (int depth = 0; depth &lt; 7; ++depth)</a>
<a name="ln564">    {</a>
<a name="ln565">        Perft.RunPerft(pos, depth, Console.WriteLine);</a>
<a name="ln566">    }</a>
<a name="ln567">}</a>
<a name="ln568"> </a>
<a name="ln569">static void _43_Divide()</a>
<a name="ln570">{</a>
<a name="ln571">    Perft.RunDivide(new Position(Constants.InitialPositionFEN), 5, Console.WriteLine);</a>
<a name="ln572">    Perft.RunDivide(new Position(TrickyPosition), 5, Console.WriteLine);</a>
<a name="ln573">}</a>
<a name="ln574"> </a>
<a name="ln575">static void _44_ParseUCI()</a>
<a name="ln576">{</a>
<a name="ln577">    var position = new Position(&quot;r1b1k2r/pPppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q2/P1PB1PpP/R3KB1R w KQkq - 0 1&quot;);</a>
<a name="ln578">    position.Print();</a>
<a name="ln579">}</a>
<a name="ln580"> </a>
<a name="ln581">static void _49_Rudimetary_Evaluation()</a>
<a name="ln582">{</a>
<a name="ln583">    //var position = new Position(Constants.InitialPositionFEN);</a>
<a name="ln584"> </a>
<a name="ln585">    //foreach (var move in MoveGenerator.GenerateAllMoves(position))</a>
<a name="ln586">    //{</a>
<a name="ln587">    //    var newBlackPosition = new Position(position, move);</a>
<a name="ln588">    //    if (newBlackPosition.IsValid())</a>
<a name="ln589">    //    {</a>
<a name="ln590">    //        var newWhitePosition = new Position(newBlackPosition, newBlackPosition.AllPossibleMoves()[0]);</a>
<a name="ln591">    //        if (newBlackPosition.IsValid())</a>
<a name="ln592">    //        {</a>
<a name="ln593">    //            Console.WriteLine($&quot;{move} | {newWhitePosition.EvaluateMaterial()} | {newWhitePosition.EvaluateMaterialAndPosition_MiniMax()}&quot;);</a>
<a name="ln594">    //        }</a>
<a name="ln595">    //    }</a>
<a name="ln596">    //}</a>
<a name="ln597">}</a>
<a name="ln598"> </a>
<a name="ln599">static void _50_MiniMax_AlphaBeta()</a>
<a name="ln600">{</a>
<a name="ln601">    //const string fen = &quot;7k/6b1/7p/2p1pPpP/2P3P1/5P2/7N/7K w - - 0 1&quot;;</a>
<a name="ln602"> </a>
<a name="ln603">    //{</a>
<a name="ln604">    //    var game = new Game(fen);</a>
<a name="ln605">    //    var (evaluation, moveList) = SearchAlgorithms.MiniMax(game.CurrentPosition, Configuration.EngineSettings.Depth);</a>
<a name="ln606">    //    Console.WriteLine($&quot;Evaluation: {evaluation}&quot;);</a>
<a name="ln607"> </a>
<a name="ln608">    //    var bestMove = moveList!.Moves.Last();</a>
<a name="ln609">    //    Console.WriteLine($&quot;Best move: {bestMove}&quot;);</a>
<a name="ln610">    //}</a>
<a name="ln611"> </a>
<a name="ln612">    //Console.WriteLine(&quot;=====================================================================================&quot;);</a>
<a name="ln613"> </a>
<a name="ln614">    //*</a>
<a name="ln615">    // * 8   . . . . . . . k</a>
<a name="ln616">    // * 7   . . . . . . b .</a>
<a name="ln617">    // * 6   . . . . . . . p</a>
<a name="ln618">    // * 5   . . p . p P p P</a>
<a name="ln619">    // * 4   . . P . . . P .</a>
<a name="ln620">    // * 3   . . . . . P . .</a>
<a name="ln621">    // * 2   . . . . . . . N</a>
<a name="ln622">    // * 1   . . . . . . . K</a>
<a name="ln623">    // *     a b c d e f g h</a>
<a name="ln624">    // *</a>
<a name="ln625">    // *          o</a>
<a name="ln626">    // *            \ f5f6</a>
<a name="ln627">    // *             * -----------</a>
<a name="ln628">    // *     e5e4  /   \  h8h7     \  g7f8</a>
<a name="ln629">    // *          /     \           \</a>
<a name="ln630">    // *         o       o ----      o</a>
<a name="ln631">    // *    f6g7 |  f6f7 | \   \</a>
<a name="ln632">    // *         |       |  \   \</a>
<a name="ln633">    // *         *       *   *   *</a>
<a name="ln634">    // *       +415    +415  ??  ??</a>
<a name="ln635">    // *</a>
<a name="ln636">    // *  o -&gt; White</a>
<a name="ln637">    // *  * -&gt; Black</a>
<a name="ln638">    // *</a>
<a name="ln639">    // *       1/     f5f6</a>
<a name="ln640">    // *       2/     e5e4</a>
<a name="ln641">    // *       3/     f6g7 + resto de hermanos</a>
<a name="ln642">    // *       2.a/   e5e4 -&gt; +415</a>
<a name="ln643">    // *       4/     h8h7</a>
<a name="ln644">    // *       5/     f6f7 -&gt; +415</a>
<a name="ln645">    // *       4.a8   h8h7 &gt;= +415 -&gt; Las blancas nunca van a hacer algo peor que eso</a>
<a name="ln646">    // */</a>
<a name="ln647">    //{</a>
<a name="ln648">    //    var game = new Game(fen);</a>
<a name="ln649">    //    var (evaluation, moveList) = SearchAlgorithms.MiniMax_AlphaBeta(game.CurrentPosition, Configuration.EngineSettings.Depth);</a>
<a name="ln650">    //    Console.WriteLine($&quot;Evaluation: {evaluation}&quot;);</a>
<a name="ln651"> </a>
<a name="ln652">    //    var bestMove = moveList!.Moves.Last();</a>
<a name="ln653">    //    Console.WriteLine($&quot;Best move: {bestMove}&quot;);</a>
<a name="ln654">    //}</a>
<a name="ln655">}</a>
<a name="ln656"> </a>
<a name="ln657">static void _52_Quiescence_Search()</a>
<a name="ln658">{</a>
<a name="ln659">    //const string fen = &quot;8/1p4pp/kPp5/p1P3PP/KpP5/1Pp2P2/2P5/8 w - - 0 1&quot;;</a>
<a name="ln660"> </a>
<a name="ln661">    //var game = new Game(fen);</a>
<a name="ln662"> </a>
<a name="ln663">    //game.CurrentPosition.Print();</a>
<a name="ln664"> </a>
<a name="ln665">    //var (evaluation, moveList) = SearchAlgorithms.MiniMax_AlphaBeta_Quiescence(game.CurrentPosition, Configuration.EngineSettings.Depth - 1);</a>
<a name="ln666">    //Console.WriteLine($&quot;Evaluation: {evaluation}&quot;);</a>
<a name="ln667"> </a>
<a name="ln668">    //var bestMove = moveList!.Moves.Last();</a>
<a name="ln669">    //Console.WriteLine($&quot;Best move: {bestMove}&quot;);</a>
<a name="ln670">}</a>
<a name="ln671"> </a>
<a name="ln672">static void _53_MVVLVA()</a>
<a name="ln673">{</a>
<a name="ln674">    for (int attacker = (int)Piece.P; attacker &lt;= (int)Piece.K; ++attacker)</a>
<a name="ln675">    {</a>
<a name="ln676">        for (int victim = (int)Piece.p; victim &lt;= (int)Piece.k; ++victim)</a>
<a name="ln677">        {</a>
<a name="ln678">            var score = MostValueableVictimLeastValuableAttacker[attacker][victim];</a>
<a name="ln679">            Console.WriteLine($&quot;Score {(Piece)attacker}x{(Piece)victim}: {score}&quot;);</a>
<a name="ln680">        }</a>
<a name="ln681">        Console.WriteLine();</a>
<a name="ln682">    }</a>
<a name="ln683"> </a>
<a name="ln684">    for (int attacker = (int)Piece.p; attacker &lt;= (int)Piece.k; ++attacker)</a>
<a name="ln685">    {</a>
<a name="ln686">        for (int victim = (int)Piece.P; victim &lt;= (int)Piece.K; ++victim)</a>
<a name="ln687">        {</a>
<a name="ln688">            var score = MostValueableVictimLeastValuableAttacker[attacker][victim];</a>
<a name="ln689">            Console.WriteLine($&quot;Score {(Piece)attacker}x{(Piece)victim}: {score}&quot;);</a>
<a name="ln690">        }</a>
<a name="ln691">        Console.WriteLine();</a>
<a name="ln692">    }</a>
<a name="ln693">}</a>
<a name="ln694"> </a>
<a name="ln695">static void _54_ScoreMove()</a>
<a name="ln696">{</a>
<a name="ln697">    var position = new Position(KillerPosition);</a>
<a name="ln698">    position.Print();</a>
<a name="ln699"> </a>
<a name="ln700">    var engine = new Engine(Channel.CreateBounded&lt;object&gt;(new BoundedChannelOptions(100) { SingleReader = true, SingleWriter = false }));</a>
<a name="ln701">    engine.SetGame(new(position.FEN()));</a>
<a name="ln702">    foreach (var move in MoveGenerator.GenerateAllMoves(position, capturesOnly: true))</a>
<a name="ln703">    {</a>
<a name="ln704">        Console.WriteLine($&quot;{move} {engine.ScoreMove(move, default, default)}&quot;);</a>
<a name="ln705">    }</a>
<a name="ln706"> </a>
<a name="ln707">    position = new Position(TrickyPosition);</a>
<a name="ln708">    position.Print();</a>
<a name="ln709"> </a>
<a name="ln710">    engine.SetGame(new(position.FEN()));</a>
<a name="ln711">    foreach (var move in MoveGenerator.GenerateAllMoves(position, capturesOnly: true))</a>
<a name="ln712">    {</a>
<a name="ln713">        Console.WriteLine($&quot;{move} {engine.ScoreMove(move, default, default)}&quot;);</a>
<a name="ln714">    }</a>
<a name="ln715">}</a>
<a name="ln716"> </a>
<a name="ln717">static void ZobristTable()</a>
<a name="ln718">{</a>
<a name="ln719">    var pos = new Position(KillerPosition);</a>
<a name="ln720">    var zobristTable = InitializeZobristTable();</a>
<a name="ln721">    var hash = CalculatePositionHash(zobristTable, pos);</a>
<a name="ln722">    var updatedHash = UpdatePositionHash(zobristTable, hash, MoveGenerator.GenerateAllMoves(pos)[0]);</a>
<a name="ln723"> </a>
<a name="ln724">    Console.WriteLine(updatedHash);</a>
<a name="ln725">}</a>
<a name="ln726"> </a>
<a name="ln727">static long[,] InitializeZobristTable()</a>
<a name="ln728">{</a>
<a name="ln729">    var randomInstance = new Random(int.MaxValue);</a>
<a name="ln730">    var zobristTable = new long[64, 12];</a>
<a name="ln731"> </a>
<a name="ln732">    for (int squareIndex = 0; squareIndex &lt; 64; ++squareIndex)</a>
<a name="ln733">    {</a>
<a name="ln734">        for (int pieceIndex = 0; pieceIndex &lt; 12; ++pieceIndex)</a>
<a name="ln735">        {</a>
<a name="ln736">            zobristTable[squareIndex, pieceIndex] = randomInstance.NextInt64();</a>
<a name="ln737">        }</a>
<a name="ln738">    }</a>
<a name="ln739"> </a>
<a name="ln740">    return zobristTable;</a>
<a name="ln741">}</a>
<a name="ln742"> </a>
<a name="ln743">static long CalculatePositionHash(long[,] zobristTable, Position position)</a>
<a name="ln744">{</a>
<a name="ln745">    long positionHash = 0;</a>
<a name="ln746"> </a>
<a name="ln747">    for (int squareIndex = 0; squareIndex &lt; 64; ++squareIndex)</a>
<a name="ln748">    {</a>
<a name="ln749">        for (int pieceIndex = 0; pieceIndex &lt; 12; ++pieceIndex)</a>
<a name="ln750">        {</a>
<a name="ln751">            if (position.PieceBitBoards[pieceIndex].GetBit(squareIndex))</a>
<a name="ln752">            {</a>
<a name="ln753">                positionHash ^= zobristTable[squareIndex, pieceIndex];</a>
<a name="ln754">            }</a>
<a name="ln755">        }</a>
<a name="ln756">    }</a>
<a name="ln757"> </a>
<a name="ln758">    return positionHash;</a>
<a name="ln759">}</a>
<a name="ln760"> </a>
<a name="ln761">static long UpdatePositionHash(long[,] zobristTable, long positionHash, Move move)</a>
<a name="ln762">{</a>
<a name="ln763">    var sourcePiece = move.Piece();</a>
<a name="ln764">    var piece = move.PromotedPiece();</a>
<a name="ln765">    if (piece == default)</a>
<a name="ln766">    {</a>
<a name="ln767">        piece = sourcePiece;</a>
<a name="ln768">    }</a>
<a name="ln769"> </a>
<a name="ln770">    var sourceSquare = move.SourceSquare();</a>
<a name="ln771">    var targetSquare = move.TargetSquare();</a>
<a name="ln772"> </a>
<a name="ln773">    return positionHash</a>
<a name="ln774">        ^ zobristTable[sourcePiece, sourceSquare]</a>
<a name="ln775">        ^ zobristTable[piece, targetSquare]</a>
<a name="ln776">        ^ zobristTable[piece, targetSquare];</a>
<a name="ln777">}</a>
<a name="ln778"> </a>
<a name="ln779">static void PV_Table()</a>
<a name="ln780">{</a>
<a name="ln781">    // Debugging, Configuration.EngineSettings.MaxDepth = 32</a>
<a name="ln782"> </a>
<a name="ln783">    /*</a>
<a name="ln784">     * Watch optimized</a>
<a name="ln785">     *</a>
<a name="ln786">     *  $&quot;{pvTable[0].ToString()} {pvTable[1].ToString()}&quot; + $&quot; {pvTable[2].ToString()} {pvTable[3].ToString()}&quot; + $&quot;{pvTable[4].ToString()} {pvTable[5].ToString()}&quot; + $&quot; {pvTable[6].ToString()} {pvTable[7].ToString()}&quot;</a>
<a name="ln787">     *  $&quot;           {pvTable[32].ToString()} {pvTable[33].ToString()}&quot; + $&quot; {pvTable[34].ToString()} {pvTable[35].ToString()}&quot; + $&quot;{pvTable[36].ToString()} {pvTable[37].ToString()}&quot; + $&quot; {pvTable[38].ToString()}&quot;</a>
<a name="ln788">     *  $&quot;                      {pvTable[63].ToString()} {pvTable[64].ToString()}&quot; + $&quot; {pvTable[65].ToString()} {pvTable[66].ToString()}&quot; + $&quot;{pvTable[67].ToString()} {pvTable[68].ToString()}&quot;</a>
<a name="ln789">     *  $&quot;                                 {pvTable[93].ToString()} {pvTable[94].ToString()}&quot; + $&quot; {pvTable[95].ToString()} {pvTable[96].ToString()}&quot; + $&quot;{pvTable[97].ToString()}&quot;</a>
<a name="ln790">     *  $&quot;                                            {pvTable[122].ToString()} {pvTable[123].ToString()}&quot; + $&quot; {pvTable[124].ToString()} {pvTable[125].ToString()}&quot;</a>
<a name="ln791">     *  $&quot;                                                       {pvTable[150].ToString()} {pvTable[151].ToString()}&quot; + $&quot; {pvTable[152].ToString()}&quot;</a>
<a name="ln792">     *</a>
<a name="ln793">     *  $&quot;{pvTable[0]} {pvTable[1]}&quot; + $&quot; {pvTable[2]} {pvTable[3]}&quot; + $&quot;{pvTable[4]} {pvTable[5]}&quot; + $&quot; {pvTable[6]} {pvTable[7]}&quot; + Environment.NewLine +</a>
<a name="ln794">     *  $&quot;           {pvTable[32]} {pvTable[33]}&quot; + $&quot; {pvTable[34]} {pvTable[35]}&quot; + $&quot;{pvTable[36]} {pvTable[37]}&quot; + $&quot; {pvTable[38]}&quot; + Environment.NewLine +</a>
<a name="ln795">     *  $&quot;                      {pvTable[63]} {pvTable[64]}&quot; + $&quot; {pvTable[65]} {pvTable[66]}&quot; + $&quot;{pvTable[67]} {pvTable[68]}&quot; + Environment.NewLine +</a>
<a name="ln796">     *  $&quot;                                 {pvTable[93]} {pvTable[94]}&quot; + $&quot; {pvTable[95]} {pvTable[96]}&quot; + $&quot;{pvTable[97]}&quot; + Environment.NewLine +</a>
<a name="ln797">     *  $&quot;                                            {pvTable[122]} {pvTable[123]}&quot; + $&quot; {pvTable[124]} {pvTable[125]}&quot; + Environment.NewLine +</a>
<a name="ln798">     *  $&quot;                                                       {pvTable[150]} {pvTable[151]}&quot; + $&quot; {pvTable[152]}&quot; + Environment.NewLine</a>
<a name="ln799">     *</a>
<a name="ln800">     *</a>
<a name="ln801">     *  Console optimized</a>
<a name="ln802">            Console.WriteLine(</a>
<a name="ln803">$&quot;{pvTable[0],-6} {pvTable[1], -6}&quot; + $&quot; {pvTable[2], -6} {pvTable[3], -6}&quot; + $&quot; {pvTable[4], -6} {pvTable[5], -6}&quot; + $&quot; {pvTable[6], -6} {pvTable[7], -6}&quot; + Environment.NewLine +</a>
<a name="ln804">$&quot;       {pvTable[32], -6} {pvTable[33], -6}&quot; + $&quot; {pvTable[34], -6} {pvTable[35], -6}&quot; + $&quot; {pvTable[36], -6} {pvTable[37], -6}&quot; + $&quot; {pvTable[38], -6}&quot; + Environment.NewLine +</a>
<a name="ln805">$&quot;              {pvTable[63], -6} {pvTable[64], -6}&quot; + $&quot; {pvTable[65], -6} {pvTable[66], -6}&quot; + $&quot; {pvTable[67], -6} {pvTable[68], -6}&quot; + Environment.NewLine +</a>
<a name="ln806">$&quot;                     {pvTable[93], -6} {pvTable[94], -6}&quot; + $&quot; {pvTable[95], -6} {pvTable[96], -6}&quot; + $&quot; {pvTable[97], -6}&quot; + Environment.NewLine +</a>
<a name="ln807">$&quot;                            {pvTable[122], -6} {pvTable[123], -6}&quot; + $&quot; {pvTable[124], -6} {pvTable[125], -6}&quot; + Environment.NewLine +</a>
<a name="ln808">$&quot;                                   {pvTable[150], -6} {pvTable[151], -6}&quot; + $&quot; {pvTable[152], -6}&quot; + Environment.NewLine);</a>
<a name="ln809">     *</a>
<a name="ln810">     */</a>
<a name="ln811">}</a>
<a name="ln812"> </a>
<a name="ln813">static void CountBits()</a>
<a name="ln814">{</a>
<a name="ln815">    var Data = new[] {</a>
<a name="ln816">        new Position(Constants.InitialPositionFEN),</a>
<a name="ln817">        new Position(Constants.TrickyTestPositionFEN),</a>
<a name="ln818">        new Position(Constants.TrickyTestPositionReversedFEN),</a>
<a name="ln819">        new Position(Constants.CmkTestPositionFEN),</a>
<a name="ln820">        new Position(Constants.ComplexPositionFEN),</a>
<a name="ln821">        new Position(Constants.KillerTestPositionFEN),</a>
<a name="ln822">    };</a>
<a name="ln823"> </a>
<a name="ln824">    foreach (var position in Data)</a>
<a name="ln825">    {</a>
<a name="ln826">        var oldC = Check_LS1B_And_Reset(position);</a>
<a name="ln827">        var newC = BitOperations_PopCount(position);</a>
<a name="ln828"> </a>
<a name="ln829">        Console.WriteLine($&quot;{oldC} | {newC}&quot;);</a>
<a name="ln830">    }</a>
<a name="ln831">    Console.WriteLine(&quot;=========================================================================&quot;);</a>
<a name="ln832"> </a>
<a name="ln833">    static int Check_LS1B_And_Reset(Position position)</a>
<a name="ln834">    {</a>
<a name="ln835">        int counter = 0;</a>
<a name="ln836"> </a>
<a name="ln837">        foreach (var bitboard in position.PieceBitBoards)</a>
<a name="ln838">        {</a>
<a name="ln839">            counter += CountBits_Naive(bitboard);</a>
<a name="ln840">        }</a>
<a name="ln841"> </a>
<a name="ln842">        foreach (var bitboard in position.OccupancyBitBoards)</a>
<a name="ln843">        {</a>
<a name="ln844">            counter += CountBits_Naive(bitboard);</a>
<a name="ln845">        }</a>
<a name="ln846"> </a>
<a name="ln847">        return counter;</a>
<a name="ln848">    }</a>
<a name="ln849"> </a>
<a name="ln850">    static int BitOperations_PopCount(Position position)</a>
<a name="ln851">    {</a>
<a name="ln852">        int counter = 0;</a>
<a name="ln853"> </a>
<a name="ln854">        foreach (var bitboard in position.PieceBitBoards)</a>
<a name="ln855">        {</a>
<a name="ln856">            counter += CountBits_PopCount(bitboard);</a>
<a name="ln857">        }</a>
<a name="ln858"> </a>
<a name="ln859">        foreach (var bitboard in position.OccupancyBitBoards)</a>
<a name="ln860">        {</a>
<a name="ln861">            counter += CountBits_PopCount(bitboard);</a>
<a name="ln862">        }</a>
<a name="ln863"> </a>
<a name="ln864">        return counter;</a>
<a name="ln865">    }</a>
<a name="ln866"> </a>
<a name="ln867">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln868">    static int CountBits_Naive(ulong bitboard)</a>
<a name="ln869">    {</a>
<a name="ln870">        int counter = 0;</a>
<a name="ln871"> </a>
<a name="ln872">        // Consecutively reset LSB</a>
<a name="ln873">        while (bitboard != default)</a>
<a name="ln874">        {</a>
<a name="ln875">            ++counter;</a>
<a name="ln876">            bitboard = ResetLS1B(bitboard);</a>
<a name="ln877">        }</a>
<a name="ln878"> </a>
<a name="ln879">        return counter;</a>
<a name="ln880">    }</a>
<a name="ln881"> </a>
<a name="ln882">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln883">    static int CountBits_PopCount(ulong bitboard) =&gt; BitOperations.PopCount(bitboard);</a>
<a name="ln884"> </a>
<a name="ln885">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln886">    static ulong ResetLS1B(ulong bitboard)</a>
<a name="ln887">    {</a>
<a name="ln888">        return bitboard &amp; (bitboard - 1);</a>
<a name="ln889">    }</a>
<a name="ln890">}</a>
<a name="ln891"> </a>
<a name="ln892">static void GetLS1BIndex()</a>
<a name="ln893">{</a>
<a name="ln894">    var Data = new[] {</a>
<a name="ln895">        new Position(Constants.InitialPositionFEN),</a>
<a name="ln896">        new Position(Constants.TrickyTestPositionFEN),</a>
<a name="ln897">        new Position(Constants.TrickyTestPositionReversedFEN),</a>
<a name="ln898">        new Position(Constants.CmkTestPositionFEN),</a>
<a name="ln899">        new Position(Constants.ComplexPositionFEN),</a>
<a name="ln900">        new Position(Constants.KillerTestPositionFEN),</a>
<a name="ln901">    };</a>
<a name="ln902"> </a>
<a name="ln903">    foreach (var position in Data)</a>
<a name="ln904">    {</a>
<a name="ln905">        var oldC = Original_GetLS1BIndex(position);</a>
<a name="ln906">        var newC = BitOperations_GetLS1BIndex(position);</a>
<a name="ln907"> </a>
<a name="ln908">        Console.WriteLine($&quot;{oldC} | {newC}&quot;);</a>
<a name="ln909">    }</a>
<a name="ln910">    Console.WriteLine(&quot;=========================================================================&quot;);</a>
<a name="ln911"> </a>
<a name="ln912">    static int Original_GetLS1BIndex(Position position)</a>
<a name="ln913">    {</a>
<a name="ln914">        int counter = 0;</a>
<a name="ln915"> </a>
<a name="ln916">        foreach (var bitboard in position.PieceBitBoards)</a>
<a name="ln917">        {</a>
<a name="ln918">            counter += Original_GetLS1BIndex_Impl(bitboard);</a>
<a name="ln919">        }</a>
<a name="ln920"> </a>
<a name="ln921">        foreach (var bitboard in position.OccupancyBitBoards)</a>
<a name="ln922">        {</a>
<a name="ln923">            counter += Original_GetLS1BIndex_Impl(bitboard);</a>
<a name="ln924">        }</a>
<a name="ln925"> </a>
<a name="ln926">        return counter;</a>
<a name="ln927">    }</a>
<a name="ln928"> </a>
<a name="ln929">    static int BitOperations_GetLS1BIndex(Position position)</a>
<a name="ln930">    {</a>
<a name="ln931">        int counter = 0;</a>
<a name="ln932"> </a>
<a name="ln933">        foreach (var bitboard in position.PieceBitBoards)</a>
<a name="ln934">        {</a>
<a name="ln935">            counter += BitOperations_GetLS1BIndex_Impl(bitboard);</a>
<a name="ln936">        }</a>
<a name="ln937"> </a>
<a name="ln938">        foreach (var bitboard in position.OccupancyBitBoards)</a>
<a name="ln939">        {</a>
<a name="ln940">            counter += BitOperations_GetLS1BIndex_Impl(bitboard);</a>
<a name="ln941">        }</a>
<a name="ln942"> </a>
<a name="ln943">        return counter;</a>
<a name="ln944">    }</a>
<a name="ln945"> </a>
<a name="ln946">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln947">    static int Original_GetLS1BIndex_Impl(ulong bitboard)</a>
<a name="ln948">    {</a>
<a name="ln949">        if (bitboard == default)</a>
<a name="ln950">        {</a>
<a name="ln951">            return (int)BoardSquare.noSquare;</a>
<a name="ln952">        }</a>
<a name="ln953"> </a>
<a name="ln954">        return CountBits(bitboard ^ (bitboard - 1)) - 1;</a>
<a name="ln955">    }</a>
<a name="ln956"> </a>
<a name="ln957">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln958">    static int BitOperations_GetLS1BIndex_Impl(ulong bitboard)</a>
<a name="ln959">    {</a>
<a name="ln960">        if (bitboard == default)</a>
<a name="ln961">        {</a>
<a name="ln962">            return (int)BoardSquare.noSquare;</a>
<a name="ln963">        }</a>
<a name="ln964"> </a>
<a name="ln965">        return BitOperations.TrailingZeroCount(bitboard);</a>
<a name="ln966">    }</a>
<a name="ln967"> </a>
<a name="ln968">    [MethodImpl(MethodImplOptions.AggressiveInlining)]</a>
<a name="ln969">    static int CountBits(ulong bitboard)</a>
<a name="ln970">    {</a>
<a name="ln971">        return BitOperations.PopCount(bitboard);</a>
<a name="ln972">    }</a>
<a name="ln973">}</a>
<a name="ln974"> </a>
<a name="ln975">static void FileAndRankMasks()</a>
<a name="ln976">{</a>
<a name="ln977">    const int square = (int)BoardSquare.e4;</a>
<a name="ln978"> </a>
<a name="ln979">    Masks.RankMasks[square].Print();</a>
<a name="ln980">    Masks.IsolatedPawnMasks[square].Print();</a>
<a name="ln981">    Masks.WhitePassedPawnMasks[square].Print();</a>
<a name="ln982">    Masks.BlackPassedPawnMasks[square].Print();</a>
<a name="ln983">}</a>
<a name="ln984"> </a>
<a name="ln985">static void EnhancedPawnEvaluation()</a>
<a name="ln986">{</a>
<a name="ln987">    var position = new Position(&quot;4k3/ppp5/8/8/8/P7/PP6/4K3 w - - 0 1&quot;);</a>
<a name="ln988">    var eval = position.StaticEvaluation().Score;</a>
<a name="ln989">    position.Print();</a>
<a name="ln990">    Console.WriteLine(eval);</a>
<a name="ln991"> </a>
<a name="ln992">    position = new Position(&quot;4k3/pp4pp/p7/8/8/P7/PPP3P1/4K3 w - - 0 1&quot;);</a>
<a name="ln993">    position.Print();</a>
<a name="ln994">    eval = position.StaticEvaluation().Score;</a>
<a name="ln995">    Console.WriteLine(eval);</a>
<a name="ln996"> </a>
<a name="ln997">    position = new Position(&quot;4k3/pp3pp1/p7/8/8/P7/PPP4P/4K3 w - - 0 1&quot;);</a>
<a name="ln998">    position.Print();</a>
<a name="ln999">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1000">    Console.WriteLine(eval);</a>
<a name="ln1001"> </a>
<a name="ln1002">    position = new Position(&quot;4k3/pp3pp1/p7/8/8/P7/PP3P1P/4K3 w - - 0 1&quot;);</a>
<a name="ln1003">    position.Print();</a>
<a name="ln1004">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1005">    Console.WriteLine(eval);</a>
<a name="ln1006"> </a>
<a name="ln1007">    position = new Position(&quot;4k3/pp2pp2/p7/8/8/P7/PP3P1P/4K3 w - - 0 1&quot;);</a>
<a name="ln1008">    position.Print();</a>
<a name="ln1009">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1010">    Console.WriteLine(eval);</a>
<a name="ln1011"> </a>
<a name="ln1012">    position = new Position(&quot;4k3/pp2pp2/p7/8/7P/P7/PP3P2/4K3 w - - 0 1&quot;);</a>
<a name="ln1013">    position.Print();</a>
<a name="ln1014">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1015">    Console.WriteLine(eval);</a>
<a name="ln1016"> </a>
<a name="ln1017">    position = new Position(&quot;4k3/pp2pp1P/p7/8/8/P7/PP3P2/4K3 w - - 0 1&quot;);</a>
<a name="ln1018">    position.Print();</a>
<a name="ln1019">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1020">    Console.WriteLine(eval);</a>
<a name="ln1021">}</a>
<a name="ln1022"> </a>
<a name="ln1023">static void RookEvaluation()</a>
<a name="ln1024">{</a>
<a name="ln1025">    var position = new Position(&quot;r3k3/7p/8/8/8/8/7P/4K2R w - - 0 1&quot;);</a>
<a name="ln1026">    position.Print();</a>
<a name="ln1027">    var eval = position.StaticEvaluation().Score;</a>
<a name="ln1028">    Console.WriteLine(eval);</a>
<a name="ln1029"> </a>
<a name="ln1030">    position = new Position(&quot;r3k3/1p6/8/8/8/8/7P/4K2R w - - 0 1&quot;);</a>
<a name="ln1031">    position.Print();</a>
<a name="ln1032">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1033">    Console.WriteLine(eval);</a>
<a name="ln1034"> </a>
<a name="ln1035">    position = new Position(&quot;r3k3/1P6/8/8/8/8/7p/4K2R w - - 0 1&quot;);</a>
<a name="ln1036">    position.Print();</a>
<a name="ln1037">    eval = position.StaticEvaluation().Score;</a>
<a name="ln1038">    Console.WriteLine(eval);</a>
<a name="ln1039">}</a>
<a name="ln1040"> </a>
<a name="ln1041">static void TranspositionTableMethod()</a>
<a name="ln1042">{</a>
<a name="ln1043">    static void TesSize(int size)</a>
<a name="ln1044">    {</a>
<a name="ln1045">        Console.WriteLine(&quot;Hash: {0} MB&quot;, size);</a>
<a name="ln1046">        var length = TranspositionTable.CalculateLength(size);</a>
<a name="ln1047"> </a>
<a name="ln1048">        var lengthMb = length / 1024 / 1024;</a>
<a name="ln1049"> </a>
<a name="ln1050">        Console.WriteLine(&quot;TT memory: {0} MB&quot;, lengthMb * Marshal.SizeOf&lt;TranspositionTableElement&gt;());</a>
<a name="ln1051">        Console.WriteLine(&quot;TT array length: {0}MB, (0x{1}, {2} items)&quot;, lengthMb, length.ToString(&quot;X&quot;), length);</a>
<a name="ln1052">        Console.WriteLine(&quot;TT mask: 0x{0} ({1})\n&quot;, (length - 1).ToString(&quot;X&quot;), Convert.ToString(length - 1, 2));</a>
<a name="ln1053">    }</a>
<a name="ln1054"> </a>
<a name="ln1055">    Console.WriteLine($&quot;{nameof(TranspositionTableElement)} size: {Marshal.SizeOf&lt;TranspositionTableElement&gt;()} bytes\n&quot;);</a>
<a name="ln1056"> </a>
<a name="ln1057">    TesSize(2);</a>
<a name="ln1058">    TesSize(4);</a>
<a name="ln1059">    TesSize(16);</a>
<a name="ln1060">    TesSize(32);</a>
<a name="ln1061">    TesSize(64);</a>
<a name="ln1062">    TesSize(128);</a>
<a name="ln1063">    TesSize(256);</a>
<a name="ln1064">    TesSize(512);</a>
<a name="ln1065">    TesSize(1024);</a>
<a name="ln1066"> </a>
<a name="ln1067">    var ttLength = TranspositionTable.CalculateLength(Configuration.EngineSettings.TranspositionTableSize);</a>
<a name="ln1068">    var transpositionTable = new TranspositionTable();</a>
<a name="ln1069"> </a>
<a name="ln1070">    var position = new Position(Constants.InitialPositionFEN);</a>
<a name="ln1071">    position.Print();</a>
<a name="ln1072">    Console.WriteLine($&quot;Hash: {position.UniqueIdentifier}&quot;);</a>
<a name="ln1073"> </a>
<a name="ln1074">    var hashKey = position.UniqueIdentifier % 0x400000;</a>
<a name="ln1075">    Console.WriteLine(hashKey);</a>
<a name="ln1076"> </a>
<a name="ln1077">    var hashKey2 = transpositionTable.CalculateTTIndex(position.UniqueIdentifier);</a>
<a name="ln1078">    Console.WriteLine(hashKey2);</a>
<a name="ln1079"> </a>
<a name="ln1080">    transpositionTable.Clear();</a>
<a name="ln1081"> </a>
<a name="ln1082">    //transpositionTable.RecordHash(position, depth: 3, maxDepth: 5, move: 1234, eval: +5, nodeType: NodeType.Alpha);</a>
<a name="ln1083">    //var entry = transpositionTable.ProbeHash(position, maxDepth: 5, depth: 3, alpha: 1, beta: 2);</a>
<a name="ln1084"> </a>
<a name="ln1085">    transpositionTable.RecordHash(position, position.StaticEvaluation().Score, depth: 5, ply: 3, score: +19, nodeType: NodeType.Alpha, false, move: 1234);</a>
<a name="ln1086">    var entry = transpositionTable.ProbeHash(position, ply: 3);</a>
<a name="ln1087">    Console.WriteLine(entry); // Expected 20</a>
<a name="ln1088"> </a>
<a name="ln1089">    transpositionTable.RecordHash(position, position.StaticEvaluation().Score, depth: 5, ply: 3, score: +21, nodeType: NodeType.Alpha, false, move: 1234);</a>
<a name="ln1090">    entry = transpositionTable.ProbeHash(position, ply: 3);</a>
<a name="ln1091">    Console.WriteLine(entry); // Expected 12_345_678</a>
<a name="ln1092"> </a>
<a name="ln1093">    transpositionTable.RecordHash(position, position.StaticEvaluation().Score, depth: 5, ply: 3, score: +29, nodeType: NodeType.Beta, false, move: 1234);</a>
<a name="ln1094">    entry = transpositionTable.ProbeHash(position, ply: 3);</a>
<a name="ln1095">    Console.WriteLine(entry); // Expected 12_345_678</a>
<a name="ln1096"> </a>
<a name="ln1097">    transpositionTable.RecordHash(position, position.StaticEvaluation().Score, depth: 5, ply: 3, score: +31, nodeType: NodeType.Beta, false, move: 1234);</a>
<a name="ln1098">    entry = transpositionTable.ProbeHash(position, ply: 3);</a>
<a name="ln1099">    Console.WriteLine(entry); // Expected 30</a>
<a name="ln1100">}</a>
<a name="ln1101"> </a>
<a name="ln1102">static void UnmakeMove()</a>
<a name="ln1103">{</a>
<a name="ln1104">    var pos = new Position(&quot;r3k2r/p1ppqpb1/bn2pnp1/3PN3/1p2P3/2N2Q1p/PPPBBPPP/R3K2R w KQkq&quot;);</a>
<a name="ln1105">    var a = Perft.PerftRecursiveImpl(pos, 1, default);</a>
<a name="ln1106"> </a>
<a name="ln1107">    TestMoveGen(Constants.InitialPositionFEN);</a>
<a name="ln1108">    TestMoveGen(Constants.TTPositionFEN);</a>
<a name="ln1109">    TestMoveGen(Constants.CmkTestPositionFEN);</a>
<a name="ln1110">    TestMoveGen(Constants.ComplexPositionFEN);</a>
<a name="ln1111">    TestMoveGen(Constants.TrickyTestPositionFEN);</a>
<a name="ln1112"> </a>
<a name="ln1113">    static void TestMoveGen(string fen)</a>
<a name="ln1114">    {</a>
<a name="ln1115">        var position = new Position(fen);</a>
<a name="ln1116">        Console.WriteLine($&quot;**Position\t{position.FEN()}, Zobrist key {position.UniqueIdentifier}**&quot;);</a>
<a name="ln1117"> </a>
<a name="ln1118">        var allMoves = MoveGenerator.GenerateAllMoves(position);</a>
<a name="ln1119"> </a>
<a name="ln1120">        var oldZobristKey = position.UniqueIdentifier;</a>
<a name="ln1121">        foreach (var move in allMoves)</a>
<a name="ln1122">        {</a>
<a name="ln1123">            var epdMoveString = move.ToEPDString(position);</a>
<a name="ln1124">            Console.WriteLine($&quot;Trying {epdMoveString} in\t{position.FEN()}&quot;);</a>
<a name="ln1125"> </a>
<a name="ln1126">            var newPosition = new Position(position);</a>
<a name="ln1127">            newPosition.MakeMove(move);</a>
<a name="ln1128">            var savedState = position.MakeMove(move);</a>
<a name="ln1129"> </a>
<a name="ln1130">            Console.WriteLine($&quot;Position\t{newPosition.FEN()}, Zobrist key {newPosition.UniqueIdentifier}&quot;);</a>
<a name="ln1131">            Console.WriteLine($&quot;Position\t{position.FEN()}, Zobrist key {position.UniqueIdentifier}&quot;);</a>
<a name="ln1132"> </a>
<a name="ln1133">            Console.WriteLine($&quot;Unmaking {epdMoveString} in\t{position.FEN()}&quot;);</a>
<a name="ln1134"> </a>
<a name="ln1135">            //position.UnmakeMove(move, savedState);</a>
<a name="ln1136"> </a>
<a name="ln1137">            Console.WriteLine($&quot;Position\t{position.FEN()}, Zobrist key {position.UniqueIdentifier}&quot;);</a>
<a name="ln1138"> </a>
<a name="ln1139">            if (oldZobristKey != position.UniqueIdentifier)</a>
<a name="ln1140">            {</a>
<a name="ln1141">                Console.WriteLine($&quot;{oldZobristKey} != {position.UniqueIdentifier}&quot;);</a>
<a name="ln1142">                throw new DirectoryNotFoundException();</a>
<a name="ln1143">            }</a>
<a name="ln1144"> </a>
<a name="ln1145">            Console.WriteLine(&quot;----------------------------------------------------------------------------&quot;);</a>
<a name="ln1146">        }</a>
<a name="ln1147">        Console.WriteLine();</a>
<a name="ln1148">        Console.WriteLine();</a>
<a name="ln1149">    }</a>
<a name="ln1150">}</a>
<a name="ln1151"> </a>
<a name="ln1152">static void PieceSquareTables()</a>
<a name="ln1153">{</a>
<a name="ln1154">    short[] middleGamePawnTableBlack = [.. MiddleGamePawnTable.Select((_, index) =&gt; (short)-MiddleGamePawnTable[0][index ^ 56])];</a>
<a name="ln1155">    short[] endGamePawnTableBlack = [.. EndGamePawnTable.Select((_, index) =&gt; (short)-EndGamePawnTable[0][index ^ 56])];</a>
<a name="ln1156"> </a>
<a name="ln1157">    PrintBitBoard(MiddleGamePawnTable);</a>
<a name="ln1158">    PrintBitBoard(middleGamePawnTableBlack);</a>
<a name="ln1159"> </a>
<a name="ln1160">    PrintBitBoard(EndGamePawnTable);</a>
<a name="ln1161">    PrintBitBoard(endGamePawnTableBlack);</a>
<a name="ln1162"> </a>
<a name="ln1163">    static void PrintBitBoard&lt;T&gt;(T[] bitboard)</a>
<a name="ln1164">    {</a>
<a name="ln1165">        for (var rank = 0; rank &lt; 8; ++rank)</a>
<a name="ln1166">        {</a>
<a name="ln1167">            for (var file = 0; file &lt; 8; ++file)</a>
<a name="ln1168">            {</a>
<a name="ln1169">                if (file == 0)</a>
<a name="ln1170">                {</a>
<a name="ln1171">                    Console.Write($&quot;{8 - rank}  &quot;);</a>
<a name="ln1172">                }</a>
<a name="ln1173"> </a>
<a name="ln1174">                var squareIndex = BitBoardExtensions.SquareIndex(rank, file);</a>
<a name="ln1175"> </a>
<a name="ln1176">                Console.Write($&quot; {bitboard[squareIndex]}\t&quot;);</a>
<a name="ln1177">            }</a>
<a name="ln1178"> </a>
<a name="ln1179">            Console.WriteLine();</a>
<a name="ln1180">        }</a>
<a name="ln1181">        Console.Write(&quot;\n    a\tb\tc\td\te\tf\tg\th\n\n\n&quot;);</a>
<a name="ln1182">    }</a>
<a name="ln1183">}</a>
<a name="ln1184"> </a>
<a name="ln1185">static void NewMasks()</a>
<a name="ln1186">{</a>
<a name="ln1187">    Masks.WhiteSidePassedPawnMasks[(int)BoardSquare.c4].Print();</a>
<a name="ln1188">    Masks.BlackSidePassedPawnMasks[(int)BoardSquare.c5].Print();</a>
<a name="ln1189"> </a>
<a name="ln1190">    PrintBitBoardArray(Masks.WhitePassedPawnMasks);</a>
<a name="ln1191">    PrintBitBoardArray(Masks.WhiteSidePassedPawnMasks);</a>
<a name="ln1192">    PrintBitBoardArray(Masks.BlackSidePassedPawnMasks);</a>
<a name="ln1193"> </a>
<a name="ln1194">    Masks.WhiteKnightOutpostMask.Print();</a>
<a name="ln1195">    Masks.BlackKnightOutpostMask.Print();</a>
<a name="ln1196"> </a>
<a name="ln1197">    Masks.LightSquaresMask.Print();</a>
<a name="ln1198">    Masks.DarkSquaresMask.Print();</a>
<a name="ln1199">    (Masks.DarkSquaresMask ^ Masks.LightSquaresMask).Print();</a>
<a name="ln1200"> </a>
<a name="ln1201">    Console.WriteLine(((Masks.LightSquaresMask &gt;&gt; (int)BoardSquare.h1) &amp; 1) != 0);</a>
<a name="ln1202">    Console.WriteLine((((9 * (int)BoardSquare.h1) + 8) &amp; 8) != 0);</a>
<a name="ln1203">    Console.WriteLine(((Masks.LightSquaresMask &gt;&gt; (int)BoardSquare.a1) &amp; 1) != 0);</a>
<a name="ln1204">    Console.WriteLine((((9 * (int)BoardSquare.a1) + 8) &amp; 8) != 0);</a>
<a name="ln1205">}</a>
<a name="ln1206"> </a>
<a name="ln1207">static void PrintBitBoardArray(ulong[] bb)</a>
<a name="ln1208">{</a>
<a name="ln1209">    for (int i = 0; i &lt; 64; ++i)</a>
<a name="ln1210">    {</a>
<a name="ln1211">        Console.Write($&quot;{bb[i]}UL, &quot;);</a>
<a name="ln1212"> </a>
<a name="ln1213">        if ((i + 1) % 8 == 0)</a>
<a name="ln1214">        {</a>
<a name="ln1215">            Console.WriteLine();</a>
<a name="ln1216">        }</a>
<a name="ln1217">    }</a>
<a name="ln1218"> </a>
<a name="ln1219">    Console.WriteLine();</a>
<a name="ln1220">}</a>
<a name="ln1221"> </a>
<a name="ln1222">static void DarkLightSquares()</a>
<a name="ln1223">{</a>
<a name="ln1224">    Constants.DarkSquaresBitBoard.Print();</a>
<a name="ln1225">    Constants.LightSquaresBitBoard.Print();</a>
<a name="ln1226"> </a>
<a name="ln1227">    for (int i = 0; i &lt; 64; ++i)</a>
<a name="ln1228">    {</a>
<a name="ln1229">        Debug.Assert(Constants.DarkSquaresBitBoard.GetBit(i) ^ Constants.LightSquaresBitBoard.GetBit(i));</a>
<a name="ln1230">    }</a>
<a name="ln1231">}</a>
<a name="ln1232"> </a>
<a name="ln1233">static void PawnIslands()</a>
<a name="ln1234">{</a>
<a name="ln1235">    PawnIslandsGenerator.GeneratePawnIslands();</a>
<a name="ln1236">}</a>
</code></pre>
<div class="balloon" rel="775"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3001/" target="_blank">V3001</a> There are identical sub-expressions 'zobristTable[piece, targetSquare]' to the left and to the right of the '^' operator.</p></div>
<div class="balloon" rel="1201"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3022/" target="_blank">V3022</a> Expression '((Masks.LightSquaresMask &gt;&gt; (int)BoardSquare.h1) &amp; 1) != 0' is always true.</p></div>
<div class="balloon" rel="1202"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3022/" target="_blank">V3022</a> Expression '(((9 * (int)BoardSquare.h1) + 8) &amp; 8) != 0' is always true.</p></div>
<div class="balloon" rel="1203"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3022/" target="_blank">V3022</a> Expression '((Masks.LightSquaresMask &gt;&gt; (int)BoardSquare.a1) &amp; 1) != 0' is always false.</p></div>
<div class="balloon" rel="1204"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3022/" target="_blank">V3022</a> Expression '(((9 * (int)BoardSquare.a1) + 8) &amp; 8) != 0' is always false.</p></div>
<div class="balloon" rel="277"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="301"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="312"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="324"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="330"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="343"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="353"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="370"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="376"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="502"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="505"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="508"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'game' is not disposed before method returns.</p></div>
<div class="balloon" rel="509"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'reversedGame' is not disposed before method returns.</p></div>
<div class="balloon" rel="577"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="987"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="992"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="997"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1002"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1007"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1012"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1017"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1025"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1030"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="1035"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3114/" target="_blank">V3114</a> IDisposable object 'position' is not disposed before method returns.</p></div>
<div class="balloon" rel="185"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3198/" target="_blank">V3198</a> The 'occupancy' variable is assigned the '0' value that it already holds.</p></div>
<div class="balloon" rel="196"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v3198/" target="_blank">V3198</a> The 'occupancy' variable is assigned the '0' value that it already holds.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>