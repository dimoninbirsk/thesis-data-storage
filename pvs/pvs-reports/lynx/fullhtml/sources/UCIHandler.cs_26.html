<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>UCIHandler.cs</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cs">
<a name="ln1">ï»¿using Lynx.Model;</a>
<a name="ln2">using Lynx.UCI.Commands.Engine;</a>
<a name="ln3">using Lynx.UCI.Commands.GUI;</a>
<a name="ln4">using NLog;</a>
<a name="ln5">using System.Runtime.Intrinsics.X86;</a>
<a name="ln6">using System.Text;</a>
<a name="ln7">using System.Text.Json;</a>
<a name="ln8">using System.Text.Json.Nodes;</a>
<a name="ln9">using System.Threading.Channels;</a>
<a name="ln10"> </a>
<a name="ln11">namespace Lynx;</a>
<a name="ln12"> </a>
<a name="ln13">public sealed class UCIHandler</a>
<a name="ln14">{</a>
<a name="ln15">    private readonly Channel&lt;string&gt; _uciToEngine;</a>
<a name="ln16">    private readonly Channel&lt;object&gt; _engineToUci;</a>
<a name="ln17"> </a>
<a name="ln18">    private readonly Searcher _searcher;</a>
<a name="ln19">    private readonly Logger _logger;</a>
<a name="ln20"> </a>
<a name="ln21">    public UCIHandler(Channel&lt;string&gt; uciToEngine, Channel&lt;object&gt; engineToUci, Searcher searcher)</a>
<a name="ln22">    {</a>
<a name="ln23">        _uciToEngine = uciToEngine;</a>
<a name="ln24">        _engineToUci = engineToUci;</a>
<a name="ln25"> </a>
<a name="ln26">        _searcher = searcher;</a>
<a name="ln27">        _logger = LogManager.GetCurrentClassLogger();</a>
<a name="ln28">    }</a>
<a name="ln29"> </a>
<a name="ln30">    public async Task Handle(string rawCommand, CancellationToken cancellationToken)</a>
<a name="ln31">    {</a>
<a name="ln32">        static ReadOnlySpan&lt;char&gt; ExtractCommandItems(string rawCommand)</a>
<a name="ln33">        {</a>
<a name="ln34">            var span = rawCommand.AsSpan();</a>
<a name="ln35">            Span&lt;Range&gt; items = stackalloc Range[2];</a>
<a name="ln36">            span.Split(items, ' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln37"> </a>
<a name="ln38">            return span[items[0]];</a>
<a name="ln39">        }</a>
<a name="ln40"> </a>
<a name="ln41">        try</a>
<a name="ln42">        {</a>
<a name="ln43">            if (_logger.IsInfoEnabled)</a>
<a name="ln44">            {</a>
<a name="ln45">                _logger.Info(&quot;[GUI]\t{0}&quot;, rawCommand);</a>
<a name="ln46">            }</a>
<a name="ln47"> </a>
<a name="ln48">            switch (ExtractCommandItems(rawCommand))</a>
<a name="ln49">            {</a>
<a name="ln50">                case GoCommand.Id:</a>
<a name="ln51">                    await _uciToEngine.Writer.WriteAsync(rawCommand, cancellationToken);</a>
<a name="ln52">                    break;</a>
<a name="ln53"> </a>
<a name="ln54">                case DebugCommand.Id:</a>
<a name="ln55">                    HandleDebug(rawCommand);</a>
<a name="ln56">                    break;</a>
<a name="ln57">                case IsReadyCommand.Id:</a>
<a name="ln58">                    await HandleIsReady(cancellationToken);</a>
<a name="ln59">                    break;</a>
<a name="ln60">                case PonderHitCommand.Id:</a>
<a name="ln61">                    await HandlePonderHit();</a>
<a name="ln62">                    break;</a>
<a name="ln63">                case PositionCommand.Id:</a>
<a name="ln64">                    HandlePosition(rawCommand);</a>
<a name="ln65">                    break;</a>
<a name="ln66">                case QuitCommand.Id:</a>
<a name="ln67">                    HandleQuit();</a>
<a name="ln68">                    return;</a>
<a name="ln69">                case SetOptionCommand.Id:</a>
<a name="ln70">                    HandleSetOption(rawCommand);</a>
<a name="ln71">                    break;</a>
<a name="ln72">                case StopCommand.Id:</a>
<a name="ln73">                    await HandleStop();</a>
<a name="ln74">                    break;</a>
<a name="ln75">                case UCICommand.Id:</a>
<a name="ln76">                    await HandleUCI(cancellationToken);</a>
<a name="ln77">                    break;</a>
<a name="ln78">                case UCINewGameCommand.Id:</a>
<a name="ln79">                    HandleNewGame();</a>
<a name="ln80">                    break;</a>
<a name="ln81">                case &quot;perft&quot;:</a>
<a name="ln82">                    HandlePerft(rawCommand);</a>
<a name="ln83">                    break;</a>
<a name="ln84">                case &quot;divide&quot;:</a>
<a name="ln85">                    HandleDivide(rawCommand);</a>
<a name="ln86">                    break;</a>
<a name="ln87">                case &quot;bench&quot;:</a>
<a name="ln88">                    await HandleBench(rawCommand);</a>
<a name="ln89">                    HandleQuit();</a>
<a name="ln90">                    break;</a>
<a name="ln91">                case &quot;verbosebench&quot;:</a>
<a name="ln92">                    await HandleVerboseBench(rawCommand);</a>
<a name="ln93">                    HandleQuit();</a>
<a name="ln94">                    break;</a>
<a name="ln95">                case &quot;printsettings&quot;:</a>
<a name="ln96">                    await HandleSettings();</a>
<a name="ln97">                    break;</a>
<a name="ln98">                case &quot;runtimeconfig&quot;:</a>
<a name="ln99">                    await HandleRuntimeConfig();</a>
<a name="ln100">                    break;</a>
<a name="ln101">                case &quot;staticeval&quot;:</a>
<a name="ln102">                    await HandleStaticEval(rawCommand, cancellationToken);</a>
<a name="ln103">                    HandleQuit();</a>
<a name="ln104">                    break;</a>
<a name="ln105">                case &quot;eval&quot;:</a>
<a name="ln106">                    await HandleEval(cancellationToken);</a>
<a name="ln107">                    break;</a>
<a name="ln108">                case &quot;fen&quot;:</a>
<a name="ln109">                    await HandleFEN(cancellationToken);</a>
<a name="ln110">                    break;</a>
<a name="ln111">                case &quot;ob_spsa&quot;:</a>
<a name="ln112">                    await HandleOpenBenchSPSA(cancellationToken);</a>
<a name="ln113">                    break;</a>
<a name="ln114">                case &quot;ob_spsa_pretty&quot;:</a>
<a name="ln115">                    await HandleOpenBenchSPSAPretty(cancellationToken);</a>
<a name="ln116">                    break;</a>
<a name="ln117">                case &quot;wf_spsa&quot;:</a>
<a name="ln118">                    await HandleWeatherFactorySPSA(cancellationToken);</a>
<a name="ln119">                    break;</a>
<a name="ln120">                default:</a>
<a name="ln121">                    _logger.Warn(&quot;Unknown command received: {0}&quot;, rawCommand);</a>
<a name="ln122">                    break;</a>
<a name="ln123">            }</a>
<a name="ln124">        }</a>
<a name="ln125">        catch (Exception e)</a>
<a name="ln126">        {</a>
<a name="ln127">            _logger.Error(e, &quot;Error trying to read/parse UCI command&quot;);</a>
<a name="ln128">        }</a>
<a name="ln129">    }</a>
<a name="ln130"> </a>
<a name="ln131">    #region Command handlers</a>
<a name="ln132"> </a>
<a name="ln133">    private void HandlePosition(ReadOnlySpan&lt;char&gt; command)</a>
<a name="ln134">    {</a>
<a name="ln135">#if DEBUG</a>
<a name="ln136">        var sw = System.Diagnostics.Stopwatch.StartNew();</a>
<a name="ln137">        _searcher.PrintCurrentPosition();</a>
<a name="ln138">#endif</a>
<a name="ln139"> </a>
<a name="ln140">        _searcher.AdjustPosition(command);</a>
<a name="ln141"> </a>
<a name="ln142">#if DEBUG</a>
<a name="ln143">        _searcher.PrintCurrentPosition();</a>
<a name="ln144">        _logger.Info(&quot;Position parsing took {0}ms&quot;, sw.ElapsedMilliseconds);</a>
<a name="ln145">#endif</a>
<a name="ln146">    }</a>
<a name="ln147"> </a>
<a name="ln148">    private async Task HandleStop() =&gt; await _searcher.StopSearching();</a>
<a name="ln149"> </a>
<a name="ln150">    private async Task HandleUCI(CancellationToken cancellationToken)</a>
<a name="ln151">    {</a>
<a name="ln152">        await SendCommand(IdCommand.NameString, cancellationToken);</a>
<a name="ln153">        await SendCommand(IdCommand.AuthorString, cancellationToken);</a>
<a name="ln154"> </a>
<a name="ln155">        foreach (var availableOption in OptionCommand.AvailableOptions)</a>
<a name="ln156">        {</a>
<a name="ln157">            await SendCommand(availableOption, cancellationToken);</a>
<a name="ln158">        }</a>
<a name="ln159"> </a>
<a name="ln160">        await SendCommand(UciOKCommand.Id, cancellationToken);</a>
<a name="ln161">    }</a>
<a name="ln162"> </a>
<a name="ln163">    private async Task HandleIsReady(CancellationToken cancellationToken) =&gt; await SendCommand(ReadyOKCommand.Id, cancellationToken);</a>
<a name="ln164"> </a>
<a name="ln165">    private async Task HandlePonderHit()</a>
<a name="ln166">    {</a>
<a name="ln167">        if (Configuration.EngineSettings.IsPonder)</a>
<a name="ln168">        {</a>
<a name="ln169">            await _searcher.PonderHit();</a>
<a name="ln170">        }</a>
<a name="ln171">        else</a>
<a name="ln172">        {</a>
<a name="ln173">            _logger.Warn(&quot;Unexpected 'ponderhit' command, given pondering is disabled. Ignoring it&quot;);</a>
<a name="ln174">        }</a>
<a name="ln175">    }</a>
<a name="ln176"> </a>
<a name="ln177">    private void HandleSetOption(ReadOnlySpan&lt;char&gt; command)</a>
<a name="ln178">    {</a>
<a name="ln179">        Span&lt;Range&gt; commandItems = stackalloc Range[5];</a>
<a name="ln180">        var length = command.Split(commandItems, ' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln181"> </a>
<a name="ln182">        if (commandItems[2].Start.Equals(commandItems[2].End) || !command[commandItems[1]].Equals(&quot;name&quot;, StringComparison.OrdinalIgnoreCase))</a>
<a name="ln183">        {</a>
<a name="ln184">            return;</a>
<a name="ln185">        }</a>
<a name="ln186"> </a>
<a name="ln187">        Span&lt;char&gt; lowerCaseFirstWord = stackalloc char[command[commandItems[2]].Length];</a>
<a name="ln188">        command[commandItems[2]].ToLowerInvariant(lowerCaseFirstWord);</a>
<a name="ln189"> </a>
<a name="ln190">#pragma warning disable S1479 // &quot;switch&quot; statements should not have too many &quot;case&quot; clauses</a>
<a name="ln191">        switch (lowerCaseFirstWord)</a>
<a name="ln192">        {</a>
<a name="ln193">            case &quot;ponder&quot;:</a>
<a name="ln194">                {</a>
<a name="ln195">                    if (length &gt; 4 &amp;&amp; bool.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln196">                    {</a>
<a name="ln197">                        Configuration.EngineSettings.IsPonder = value;</a>
<a name="ln198">                    }</a>
<a name="ln199">                    break;</a>
<a name="ln200">                }</a>
<a name="ln201">            case &quot;uci_analysemode&quot;:</a>
<a name="ln202">                {</a>
<a name="ln203">                    if (length &gt; 4 &amp;&amp; bool.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln204">                    {</a>
<a name="ln205">                        Configuration.UCI_AnalyseMode = value;</a>
<a name="ln206">                    }</a>
<a name="ln207">                    break;</a>
<a name="ln208">                }</a>
<a name="ln209">            case &quot;hash&quot;:</a>
<a name="ln210">                {</a>
<a name="ln211">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln212">                    {</a>
<a name="ln213">                        Configuration.Hash = value;</a>
<a name="ln214">                        _searcher.UpdateHash();</a>
<a name="ln215">                    }</a>
<a name="ln216">                    break;</a>
<a name="ln217">                }</a>
<a name="ln218">            case &quot;uci_opponent&quot;:</a>
<a name="ln219">                {</a>
<a name="ln220">                    const string none = &quot;none &quot;;</a>
<a name="ln221">                    if (length &gt; 4)</a>
<a name="ln222">                    {</a>
<a name="ln223">                        var opponent = command[commandItems[4].Start.Value..].ToString();</a>
<a name="ln224"> </a>
<a name="ln225">                        _logger.Info(&quot;Game against {0}&quot;, opponent.Replace(none, string.Empty));</a>
<a name="ln226">                    }</a>
<a name="ln227">                    break;</a>
<a name="ln228">                }</a>
<a name="ln229">            case &quot;uci_engineabout&quot;:</a>
<a name="ln230">                {</a>
<a name="ln231">                    if (length &gt; 4)</a>
<a name="ln232">                    {</a>
<a name="ln233">                        _logger.Info(&quot;UCI_EngineAbout: {0}&quot;, command[commandItems[4].Start.Value..].ToString());</a>
<a name="ln234">                    }</a>
<a name="ln235">                    break;</a>
<a name="ln236">                }</a>
<a name="ln237">            case &quot;onlinetablebaseinrootpositions&quot;:</a>
<a name="ln238">                {</a>
<a name="ln239">                    if (length &gt; 4 &amp;&amp; bool.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln240">                    {</a>
<a name="ln241">                        Configuration.EngineSettings.UseOnlineTablebaseInRootPositions = value;</a>
<a name="ln242">                    }</a>
<a name="ln243">                    break;</a>
<a name="ln244">                }</a>
<a name="ln245">            case &quot;onlinetablebaseinsearch&quot;:</a>
<a name="ln246">                {</a>
<a name="ln247">                    if (length &gt; 4 &amp;&amp; bool.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln248">                    {</a>
<a name="ln249">                        Configuration.EngineSettings.UseOnlineTablebaseInSearch = value;</a>
<a name="ln250">                    }</a>
<a name="ln251">                    break;</a>
<a name="ln252">                }</a>
<a name="ln253">            case &quot;threads&quot;:</a>
<a name="ln254">                {</a>
<a name="ln255">#pragma warning disable S1066 // Collapsible &quot;if&quot; statements should be merged</a>
<a name="ln256">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln257">                    {</a>
<a name="ln258">                        Configuration.EngineSettings.Threads = value;</a>
<a name="ln259">                        _searcher.UpdateThreads();</a>
<a name="ln260">                    }</a>
<a name="ln261">                    break;</a>
<a name="ln262">#pragma warning restore S1066 // Collapsible &quot;if&quot; statements should be merged</a>
<a name="ln263">                }</a>
<a name="ln264">            case &quot;uci_showwdl&quot;:</a>
<a name="ln265">                {</a>
<a name="ln266">                    if (length &gt; 4 &amp;&amp; bool.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln267">                    {</a>
<a name="ln268">                        Configuration.EngineSettings.ShowWDL = value;</a>
<a name="ln269">                    }</a>
<a name="ln270">                    break;</a>
<a name="ln271">                }</a>
<a name="ln272"> </a>
<a name="ln273">            #region Time management</a>
<a name="ln274">            case &quot;engineguicommunicationtimeoverhead&quot;:</a>
<a name="ln275">                {</a>
<a name="ln276">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln277">                    {</a>
<a name="ln278">                        Configuration.EngineSettings.EngineGuiCommunicationTimeOverhead = value;</a>
<a name="ln279">                    }</a>
<a name="ln280">                    break;</a>
<a name="ln281">                }</a>
<a name="ln282">            case &quot;nodetmbase&quot;:</a>
<a name="ln283">                {</a>
<a name="ln284">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln285">                    {</a>
<a name="ln286">                        Configuration.EngineSettings.NodeTmBase = value * 0.01;</a>
<a name="ln287">                    }</a>
<a name="ln288">                    break;</a>
<a name="ln289">                }</a>
<a name="ln290">            case &quot;nodetmscale&quot;:</a>
<a name="ln291">                {</a>
<a name="ln292">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln293">                    {</a>
<a name="ln294">                        Configuration.EngineSettings.NodeTmScale = value * 0.01;</a>
<a name="ln295">                    }</a>
<a name="ln296">                    break;</a>
<a name="ln297">                }</a>
<a name="ln298">            case &quot;scorestabiity_mindepth&quot;:</a>
<a name="ln299">                {</a>
<a name="ln300">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln301">                    {</a>
<a name="ln302">                        Configuration.EngineSettings.ScoreStabiity_MinDepth = value;</a>
<a name="ln303">                    }</a>
<a name="ln304">                    break;</a>
<a name="ln305">                }</a>
<a name="ln306">            case &quot;softtimeboundlimitonmate&quot;:</a>
<a name="ln307">                {</a>
<a name="ln308">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln309">                    {</a>
<a name="ln310">                        Configuration.EngineSettings.SoftTimeBoundLimitOnMate = value;</a>
<a name="ln311">                    }</a>
<a name="ln312">                    break;</a>
<a name="ln313">                }</a>
<a name="ln314">            case &quot;ponderhitmintimetocontinuesearch&quot;:</a>
<a name="ln315">                {</a>
<a name="ln316">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln317">                    {</a>
<a name="ln318">                        Configuration.EngineSettings.PonderHitMinTimeToContinueSearch = value;</a>
<a name="ln319">                    }</a>
<a name="ln320">                    break;</a>
<a name="ln321">                }</a>
<a name="ln322">            case &quot;ponderhitmindepthtostopsearch&quot;:</a>
<a name="ln323">                {</a>
<a name="ln324">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln325">                    {</a>
<a name="ln326">                        Configuration.EngineSettings.PonderHitMinDepthToStopSearch = value;</a>
<a name="ln327">                    }</a>
<a name="ln328">                    break;</a>
<a name="ln329">                }</a>
<a name="ln330">            #endregion</a>
<a name="ln331"> </a>
<a name="ln332">            #region Search tuning</a>
<a name="ln333"> </a>
<a name="ln334">            case &quot;lmr_mindepth&quot;:</a>
<a name="ln335">                {</a>
<a name="ln336">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln337">                    {</a>
<a name="ln338">                        Configuration.EngineSettings.LMR_MinDepth = value;</a>
<a name="ln339">                    }</a>
<a name="ln340">                    break;</a>
<a name="ln341">                }</a>
<a name="ln342">            case &quot;lmr_minfulldepthsearchedmoves_pv&quot;:</a>
<a name="ln343">                {</a>
<a name="ln344">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln345">                    {</a>
<a name="ln346">                        Configuration.EngineSettings.LMR_MinFullDepthSearchedMoves_PV = value;</a>
<a name="ln347">                    }</a>
<a name="ln348">                    break;</a>
<a name="ln349">                }</a>
<a name="ln350">            case &quot;lmr_minfulldepthsearchedmoves_nonpv&quot;:</a>
<a name="ln351">                {</a>
<a name="ln352">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln353">                    {</a>
<a name="ln354">                        Configuration.EngineSettings.LMR_MinFullDepthSearchedMoves_NonPV = value;</a>
<a name="ln355">                    }</a>
<a name="ln356">                    break;</a>
<a name="ln357">                }</a>
<a name="ln358">            case &quot;lmr_base_quiet&quot;:</a>
<a name="ln359">                {</a>
<a name="ln360">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln361">                    {</a>
<a name="ln362">                        Configuration.EngineSettings.LMR_Base_Quiet = value * 0.01;</a>
<a name="ln363">                    }</a>
<a name="ln364">                    break;</a>
<a name="ln365">                }</a>
<a name="ln366">            case &quot;lmr_base_noisy&quot;:</a>
<a name="ln367">                {</a>
<a name="ln368">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln369">                    {</a>
<a name="ln370">                        Configuration.EngineSettings.LMR_Base_Noisy = value * 0.01;</a>
<a name="ln371">                    }</a>
<a name="ln372">                    break;</a>
<a name="ln373">                }</a>
<a name="ln374">            case &quot;lmr_divisor_quiet&quot;:</a>
<a name="ln375">                {</a>
<a name="ln376">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln377">                    {</a>
<a name="ln378">                        Configuration.EngineSettings.LMR_Divisor_Quiet = value * 0.01;</a>
<a name="ln379">                    }</a>
<a name="ln380">                    break;</a>
<a name="ln381">                }</a>
<a name="ln382">            case &quot;lmr_divisor_noisy&quot;:</a>
<a name="ln383">                {</a>
<a name="ln384">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln385">                    {</a>
<a name="ln386">                        Configuration.EngineSettings.LMR_Divisor_Noisy = value * 0.01;</a>
<a name="ln387">                    }</a>
<a name="ln388">                    break;</a>
<a name="ln389">                }</a>
<a name="ln390">            case &quot;lmr_history_divisor_quiet&quot;:</a>
<a name="ln391">                {</a>
<a name="ln392">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln393">                    {</a>
<a name="ln394">                        Configuration.EngineSettings.LMR_History_Divisor_Quiet = value;</a>
<a name="ln395">                    }</a>
<a name="ln396">                    break;</a>
<a name="ln397">                }</a>
<a name="ln398">            case &quot;lmr_history_divisor_noisy&quot;:</a>
<a name="ln399">                {</a>
<a name="ln400">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln401">                    {</a>
<a name="ln402">                        Configuration.EngineSettings.LMR_History_Divisor_Noisy = value;</a>
<a name="ln403">                    }</a>
<a name="ln404">                    break;</a>
<a name="ln405">                }</a>
<a name="ln406">            case &quot;lmr_improving&quot;:</a>
<a name="ln407">                {</a>
<a name="ln408">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln409">                    {</a>
<a name="ln410">                        Configuration.EngineSettings.LMR_Improving = value;</a>
<a name="ln411">                    }</a>
<a name="ln412">                    break;</a>
<a name="ln413">                }</a>
<a name="ln414">            case &quot;lmr_cutnode&quot;:</a>
<a name="ln415">                {</a>
<a name="ln416">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln417">                    {</a>
<a name="ln418">                        Configuration.EngineSettings.LMR_Cutnode = value;</a>
<a name="ln419">                    }</a>
<a name="ln420">                    break;</a>
<a name="ln421">                }</a>
<a name="ln422">            case &quot;lmr_ttpv&quot;:</a>
<a name="ln423">                {</a>
<a name="ln424">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln425">                    {</a>
<a name="ln426">                        Configuration.EngineSettings.LMR_TTPV = value;</a>
<a name="ln427">                    }</a>
<a name="ln428">                    break;</a>
<a name="ln429">                }</a>
<a name="ln430">            case &quot;lmr_ttcapture&quot;:</a>
<a name="ln431">                {</a>
<a name="ln432">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln433">                    {</a>
<a name="ln434">                        Configuration.EngineSettings.LMR_TTCapture = value;</a>
<a name="ln435">                    }</a>
<a name="ln436">                    break;</a>
<a name="ln437">                }</a>
<a name="ln438">            case &quot;lmr_pvnode&quot;:</a>
<a name="ln439">                {</a>
<a name="ln440">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln441">                    {</a>
<a name="ln442">                        Configuration.EngineSettings.LMR_PVNode = value;</a>
<a name="ln443">                    }</a>
<a name="ln444">                    break;</a>
<a name="ln445">                }</a>
<a name="ln446">            case &quot;lmr_incheck&quot;:</a>
<a name="ln447">                {</a>
<a name="ln448">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln449">                    {</a>
<a name="ln450">                        Configuration.EngineSettings.LMR_InCheck = value;</a>
<a name="ln451">                    }</a>
<a name="ln452">                    break;</a>
<a name="ln453">                }</a>
<a name="ln454">            case &quot;lmr_quiet&quot;:</a>
<a name="ln455">                {</a>
<a name="ln456">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln457">                    {</a>
<a name="ln458">                        Configuration.EngineSettings.LMR_Quiet = value;</a>
<a name="ln459">                    }</a>
<a name="ln460">                    break;</a>
<a name="ln461">                }</a>
<a name="ln462"> </a>
<a name="ln463">            case &quot;nmp_mindepth&quot;:</a>
<a name="ln464">                {</a>
<a name="ln465">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln466">                    {</a>
<a name="ln467">                        Configuration.EngineSettings.NMP_MinDepth = value;</a>
<a name="ln468">                    }</a>
<a name="ln469">                    break;</a>
<a name="ln470">                }</a>
<a name="ln471">            case &quot;nmp_basedepthreduction&quot;:</a>
<a name="ln472">                {</a>
<a name="ln473">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln474">                    {</a>
<a name="ln475">                        Configuration.EngineSettings.NMP_BaseDepthReduction = value;</a>
<a name="ln476">                    }</a>
<a name="ln477">                    break;</a>
<a name="ln478">                }</a>
<a name="ln479">            case &quot;nmp_depthincrement&quot;:</a>
<a name="ln480">                {</a>
<a name="ln481">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln482">                    {</a>
<a name="ln483">                        Configuration.EngineSettings.NMP_DepthIncrement = value;</a>
<a name="ln484">                    }</a>
<a name="ln485">                    break;</a>
<a name="ln486">                }</a>
<a name="ln487">            case &quot;nmp_depthdivisor&quot;:</a>
<a name="ln488">                {</a>
<a name="ln489">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln490">                    {</a>
<a name="ln491">                        Configuration.EngineSettings.NMP_DepthDivisor = value;</a>
<a name="ln492">                    }</a>
<a name="ln493">                    break;</a>
<a name="ln494">                }</a>
<a name="ln495">            case &quot;nmp_staticevalbetadivisor&quot;:</a>
<a name="ln496">                {</a>
<a name="ln497">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln498">                    {</a>
<a name="ln499">                        Configuration.EngineSettings.NMP_StaticEvalBetaDivisor = value;</a>
<a name="ln500">                    }</a>
<a name="ln501">                    break;</a>
<a name="ln502">                }</a>
<a name="ln503">            case &quot;nmp_staticevalbetamaxreduction&quot;:</a>
<a name="ln504">                {</a>
<a name="ln505">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln506">                    {</a>
<a name="ln507">                        Configuration.EngineSettings.NMP_StaticEvalBetaMaxReduction = value;</a>
<a name="ln508">                    }</a>
<a name="ln509">                    break;</a>
<a name="ln510">                }</a>
<a name="ln511"> </a>
<a name="ln512">            //case &quot;aspirationwindow_delta&quot;:</a>
<a name="ln513">            //    {</a>
<a name="ln514">            //        if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln515">            //        {</a>
<a name="ln516">            //            Configuration.EngineSettings.AspirationWindow_Delta = value;</a>
<a name="ln517">            //        }</a>
<a name="ln518">            //        break;</a>
<a name="ln519">            //    }</a>
<a name="ln520">            case &quot;aspirationwindow_mindepth&quot;:</a>
<a name="ln521">                {</a>
<a name="ln522">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln523">                    {</a>
<a name="ln524">                        Configuration.EngineSettings.AspirationWindow_MinDepth = value;</a>
<a name="ln525">                    }</a>
<a name="ln526">                    break;</a>
<a name="ln527">                }</a>
<a name="ln528">            case &quot;aspirationwindow_base&quot;:</a>
<a name="ln529">                {</a>
<a name="ln530">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln531">                    {</a>
<a name="ln532">                        Configuration.EngineSettings.AspirationWindow_Base = value;</a>
<a name="ln533">                    }</a>
<a name="ln534">                    break;</a>
<a name="ln535">                }</a>
<a name="ln536"> </a>
<a name="ln537">            case &quot;rfp_maxdepth&quot;:</a>
<a name="ln538">                {</a>
<a name="ln539">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln540">                    {</a>
<a name="ln541">                        Configuration.EngineSettings.RFP_MaxDepth = value;</a>
<a name="ln542">                    }</a>
<a name="ln543">                    break;</a>
<a name="ln544">                }</a>
<a name="ln545">            //case &quot;rfp_depthscalingfactor&quot;:</a>
<a name="ln546">            //    {</a>
<a name="ln547">            //        if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln548">            //        {</a>
<a name="ln549">            //            Configuration.EngineSettings.RFP_DepthScalingFactor = value;</a>
<a name="ln550">            //        }</a>
<a name="ln551">            //        break;</a>
<a name="ln552">            //    }</a>
<a name="ln553"> </a>
<a name="ln554">            case &quot;razoring_maxdepth&quot;:</a>
<a name="ln555">                {</a>
<a name="ln556">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln557">                    {</a>
<a name="ln558">                        Configuration.EngineSettings.Razoring_MaxDepth = value;</a>
<a name="ln559">                    }</a>
<a name="ln560">                    break;</a>
<a name="ln561">                }</a>
<a name="ln562">            case &quot;razoring_depth1bonus&quot;:</a>
<a name="ln563">                {</a>
<a name="ln564">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln565">                    {</a>
<a name="ln566">                        Configuration.EngineSettings.Razoring_Depth1Bonus = value;</a>
<a name="ln567">                    }</a>
<a name="ln568">                    break;</a>
<a name="ln569">                }</a>
<a name="ln570">            case &quot;razoring_notdepth1bonus&quot;:</a>
<a name="ln571">                {</a>
<a name="ln572">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln573">                    {</a>
<a name="ln574">                        Configuration.EngineSettings.Razoring_NotDepth1Bonus = value;</a>
<a name="ln575">                    }</a>
<a name="ln576">                    break;</a>
<a name="ln577">                }</a>
<a name="ln578"> </a>
<a name="ln579">            case &quot;iir_mindepth&quot;:</a>
<a name="ln580">                {</a>
<a name="ln581">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln582">                    {</a>
<a name="ln583">                        Configuration.EngineSettings.IIR_MinDepth = value;</a>
<a name="ln584">                    }</a>
<a name="ln585">                    break;</a>
<a name="ln586">                }</a>
<a name="ln587"> </a>
<a name="ln588">            case &quot;lmp_basemovestotry&quot;:</a>
<a name="ln589">                {</a>
<a name="ln590">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln591">                    {</a>
<a name="ln592">                        Configuration.EngineSettings.LMP_BaseMovesToTry = value;</a>
<a name="ln593">                    }</a>
<a name="ln594">                    break;</a>
<a name="ln595">                }</a>
<a name="ln596">            case &quot;lmp_movesdepthmultiplier&quot;:</a>
<a name="ln597">                {</a>
<a name="ln598">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln599">                    {</a>
<a name="ln600">                        Configuration.EngineSettings.LMP_MovesDepthMultiplier = value;</a>
<a name="ln601">                    }</a>
<a name="ln602">                    break;</a>
<a name="ln603">                }</a>
<a name="ln604">            case &quot;history_maxmovevalue&quot;:</a>
<a name="ln605">                {</a>
<a name="ln606">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln607">                    {</a>
<a name="ln608">                        Configuration.EngineSettings.History_MaxMoveValue = value;</a>
<a name="ln609">                    }</a>
<a name="ln610">                    break;</a>
<a name="ln611">                }</a>
<a name="ln612">            case &quot;history_maxmoverawbonus&quot;:</a>
<a name="ln613">                {</a>
<a name="ln614">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln615">                    {</a>
<a name="ln616">                        Configuration.EngineSettings.History_MaxMoveRawBonus = value;</a>
<a name="ln617">                    }</a>
<a name="ln618">                    break;</a>
<a name="ln619">                }</a>
<a name="ln620">            case &quot;history_bestscorebetamargin&quot;:</a>
<a name="ln621">                {</a>
<a name="ln622">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln623">                    {</a>
<a name="ln624">                        Configuration.EngineSettings.History_BestScoreBetaMargin = value;</a>
<a name="ln625">                    }</a>
<a name="ln626">                    break;</a>
<a name="ln627">                }</a>
<a name="ln628">            case &quot;see_badcapturereduction&quot;:</a>
<a name="ln629">                {</a>
<a name="ln630">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln631">                    {</a>
<a name="ln632">                        Configuration.EngineSettings.SEE_BadCaptureReduction = value;</a>
<a name="ln633">                    }</a>
<a name="ln634">                    break;</a>
<a name="ln635">                }</a>
<a name="ln636">            case &quot;fp_maxdepth&quot;:</a>
<a name="ln637">                {</a>
<a name="ln638">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln639">                    {</a>
<a name="ln640">                        Configuration.EngineSettings.FP_MaxDepth = value;</a>
<a name="ln641">                    }</a>
<a name="ln642">                    break;</a>
<a name="ln643">                }</a>
<a name="ln644">            case &quot;fp_depthscalingfactor&quot;:</a>
<a name="ln645">                {</a>
<a name="ln646">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln647">                    {</a>
<a name="ln648">                        Configuration.EngineSettings.FP_DepthScalingFactor = value;</a>
<a name="ln649">                    }</a>
<a name="ln650">                    break;</a>
<a name="ln651">                }</a>
<a name="ln652">            case &quot;fp_margin&quot;:</a>
<a name="ln653">                {</a>
<a name="ln654">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln655">                    {</a>
<a name="ln656">                        Configuration.EngineSettings.FP_Margin = value;</a>
<a name="ln657">                    }</a>
<a name="ln658">                    break;</a>
<a name="ln659">                }</a>
<a name="ln660">            case &quot;historyprunning_maxdepth&quot;:</a>
<a name="ln661">                {</a>
<a name="ln662">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln663">                    {</a>
<a name="ln664">                        Configuration.EngineSettings.HistoryPrunning_MaxDepth = value;</a>
<a name="ln665">                    }</a>
<a name="ln666">                    break;</a>
<a name="ln667">                }</a>
<a name="ln668">            case &quot;historyprunning_margin&quot;:</a>
<a name="ln669">                {</a>
<a name="ln670">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln671">                    {</a>
<a name="ln672">                        Configuration.EngineSettings.HistoryPrunning_Margin = value;</a>
<a name="ln673">                    }</a>
<a name="ln674">                    break;</a>
<a name="ln675">                }</a>
<a name="ln676">            case &quot;tthit_nocutoffextension_maxdepth&quot;:</a>
<a name="ln677">                {</a>
<a name="ln678">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln679">                    {</a>
<a name="ln680">                        Configuration.EngineSettings.TTHit_NoCutoffExtension_MaxDepth = value;</a>
<a name="ln681">                    }</a>
<a name="ln682">                    break;</a>
<a name="ln683">                }</a>
<a name="ln684">            case &quot;ttreplacement_depthoffset&quot;:</a>
<a name="ln685">                {</a>
<a name="ln686">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln687">                    {</a>
<a name="ln688">                        Configuration.EngineSettings.TTReplacement_DepthOffset = value;</a>
<a name="ln689">                    }</a>
<a name="ln690">                    break;</a>
<a name="ln691">                }</a>
<a name="ln692">            case &quot;ttreplacement_ttpvdepthoffset&quot;:</a>
<a name="ln693">                {</a>
<a name="ln694">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln695">                    {</a>
<a name="ln696">                        Configuration.EngineSettings.TTReplacement_TTPVDepthOffset = value;</a>
<a name="ln697">                    }</a>
<a name="ln698">                    break;</a>
<a name="ln699">                }</a>
<a name="ln700"> </a>
<a name="ln701">            case &quot;pvs_see_threshold_quiet&quot;:</a>
<a name="ln702">                {</a>
<a name="ln703">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln704">                    {</a>
<a name="ln705">                        Configuration.EngineSettings.PVS_SEE_Threshold_Quiet = value;</a>
<a name="ln706">                    }</a>
<a name="ln707">                    break;</a>
<a name="ln708">                }</a>
<a name="ln709">            case &quot;pvs_see_threshold_noisy&quot;:</a>
<a name="ln710">                {</a>
<a name="ln711">                    if (length &gt; 4 &amp;&amp; int.TryParse(command[commandItems[4]], out var value))</a>
<a name="ln712">                    {</a>
<a name="ln713">                        Configuration.EngineSettings.PVS_SEE_Threshold_Noisy = value;</a>
<a name="ln714">                    }</a>
<a name="ln715">                    break;</a>
<a name="ln716">                }</a>
<a name="ln717"> </a>
<a name="ln718">            #endregion</a>
<a name="ln719"> </a>
<a name="ln720">            default:</a>
<a name="ln721">                _logger.Warn(&quot;Unsupported option: {0}&quot;, command.ToString());</a>
<a name="ln722">                break;</a>
<a name="ln723">        }</a>
<a name="ln724">#pragma warning restore S1479 // &quot;switch&quot; statements should not have too many &quot;case&quot; clauses</a>
<a name="ln725">    }</a>
<a name="ln726"> </a>
<a name="ln727">    private void HandleNewGame()</a>
<a name="ln728">    {</a>
<a name="ln729">        _searcher.NewGame();</a>
<a name="ln730">    }</a>
<a name="ln731"> </a>
<a name="ln732">    private static void HandleDebug(ReadOnlySpan&lt;char&gt; command) =&gt; Configuration.IsDebug = DebugCommand.Parse(command);</a>
<a name="ln733"> </a>
<a name="ln734">    private void HandleQuit()</a>
<a name="ln735">    {</a>
<a name="ln736">        _searcher.Quit();</a>
<a name="ln737">        _engineToUci.Writer.Complete();</a>
<a name="ln738">    }</a>
<a name="ln739"> </a>
<a name="ln740">    private void HandlePerft(string rawCommand)</a>
<a name="ln741">    {</a>
<a name="ln742">        var items = rawCommand.Split(' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln743"> </a>
<a name="ln744">        if (items.Length &gt;= 2 &amp;&amp; int.TryParse(items[1], out int depth) &amp;&amp; depth &gt;= 1)</a>
<a name="ln745">        {</a>
<a name="ln746">            Perft.RunPerft(_searcher.CurrentPosition, depth, str =&gt; _engineToUci.Writer.TryWrite(str));</a>
<a name="ln747">        }</a>
<a name="ln748">    }</a>
<a name="ln749"> </a>
<a name="ln750">    private void HandleDivide(string rawCommand)</a>
<a name="ln751">    {</a>
<a name="ln752">        var items = rawCommand.Split(' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln753"> </a>
<a name="ln754">        if (items.Length &gt;= 2 &amp;&amp; int.TryParse(items[1], out int depth) &amp;&amp; depth &gt;= 1)</a>
<a name="ln755">        {</a>
<a name="ln756">            Perft.RunDivide(_searcher.CurrentPosition, depth, str =&gt; _engineToUci.Writer.TryWrite(str));</a>
<a name="ln757">        }</a>
<a name="ln758">    }</a>
<a name="ln759"> </a>
<a name="ln760">    private async ValueTask HandleBench(string rawCommand)</a>
<a name="ln761">    {</a>
<a name="ln762">        var items = rawCommand.Split(' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln763"> </a>
<a name="ln764">        if (items.Length &lt; 2 || !int.TryParse(items[1], out int depth))</a>
<a name="ln765">        {</a>
<a name="ln766">            depth = Configuration.EngineSettings.BenchDepth;</a>
<a name="ln767">        }</a>
<a name="ln768"> </a>
<a name="ln769">        await _searcher.RunBench(depth);</a>
<a name="ln770">    }</a>
<a name="ln771"> </a>
<a name="ln772">    private async ValueTask HandleVerboseBench(string rawCommand)</a>
<a name="ln773">    {</a>
<a name="ln774">        var items = rawCommand.Split(' ', StringSplitOptions.RemoveEmptyEntries);</a>
<a name="ln775"> </a>
<a name="ln776">        if (items.Length &lt; 2 || !int.TryParse(items[1], out int depth))</a>
<a name="ln777">        {</a>
<a name="ln778">            depth = Configuration.EngineSettings.BenchDepth;</a>
<a name="ln779">        }</a>
<a name="ln780"> </a>
<a name="ln781">        await _searcher.RunVerboseBench(depth);</a>
<a name="ln782">    }</a>
<a name="ln783"> </a>
<a name="ln784">    private async ValueTask HandleSettings()</a>
<a name="ln785">    {</a>
<a name="ln786">        var engineSettings = JsonSerializer.Serialize(Configuration.EngineSettings, EngineSettingsJsonSerializerContext.Default.EngineSettings);</a>
<a name="ln787"> </a>
<a name="ln788">        var message = $&quot;{nameof(Configuration)}.{nameof(Configuration.EngineSettings)}:{Environment.NewLine}{engineSettings}&quot;;</a>
<a name="ln789"> </a>
<a name="ln790">        await _engineToUci.Writer.WriteAsync(message);</a>
<a name="ln791">    }</a>
<a name="ln792"> </a>
<a name="ln793">    private async ValueTask HandleRuntimeConfig()</a>
<a name="ln794">    {</a>
<a name="ln795">        try</a>
<a name="ln796">        {</a>
<a name="ln797">            await _engineToUci.Writer.WriteAsync(&quot;CPU flags:&quot;);</a>
<a name="ln798">            string[] intrinsics =</a>
<a name="ln799">            [</a>
<a name="ln800">                $&quot;BMI2 = {Bmi2.IsSupported}&quot;,</a>
<a name="ln801">                $&quot;SSE4.2 = {Sse42.IsSupported}&quot;,</a>
<a name="ln802">                $&quot;AVX2 = {Avx2.IsSupported}&quot;,</a>
<a name="ln803">                $&quot;Avx512BW = {Avx512BW.IsSupported}&quot;,</a>
<a name="ln804">            ];</a>
<a name="ln805"> </a>
<a name="ln806">            foreach(var instructionSet in intrinsics)</a>
<a name="ln807">            {</a>
<a name="ln808">                await _engineToUci.Writer.WriteAsync($&quot;\t- {instructionSet}&quot;);</a>
<a name="ln809">            }</a>
<a name="ln810"> </a>
<a name="ln811">            if (Sse.IsSupported)</a>
<a name="ln812">            {</a>
<a name="ln813">                await _engineToUci.Writer.WriteAsync(&quot;SSE supported, Prefetch0 will be used for TT prefetching&quot;);</a>
<a name="ln814">            }</a>
<a name="ln815"> </a>
<a name="ln816">            if (Bmi1.IsSupported)</a>
<a name="ln817">            {</a>
<a name="ln818">                await _engineToUci.Writer.WriteAsync(&quot;BMI1 supported, ExtractLowestSetBit will be used for BitBoard LSB operations&quot;);</a>
<a name="ln819">            }</a>
<a name="ln820"> </a>
<a name="ln821">            if (Bmi2.IsSupported)</a>
<a name="ln822">            {</a>
<a name="ln823">                await _engineToUci.Writer.WriteAsync(&quot;BMI2 supported, ParallelBitExtract (PEXT) will be used for slider pieces move generation&quot;);</a>
<a name="ln824">            }</a>
<a name="ln825"> </a>
<a name="ln826">            await _engineToUci.Writer.WriteAsync(&quot;Garbage Collector (GC) settings:&quot;);</a>
<a name="ln827"> </a>
<a name="ln828">            foreach (var pair in GC.GetConfigurationVariables())</a>
<a name="ln829">            {</a>
<a name="ln830">                await _engineToUci.Writer.WriteAsync($&quot;\t- {pair.Key} = {pair.Value}&quot;);</a>
<a name="ln831">            }</a>
<a name="ln832">        }</a>
<a name="ln833">        catch (Exception e)</a>
<a name="ln834">        {</a>
<a name="ln835">            _logger.Error(e);</a>
<a name="ln836">        }</a>
<a name="ln837">    }</a>
<a name="ln838"> </a>
<a name="ln839">    private async ValueTask HandleStaticEval(string rawCommand, CancellationToken cancellationToken)</a>
<a name="ln840">    {</a>
<a name="ln841">        try</a>
<a name="ln842">        {</a>
<a name="ln843">            var fullPath = Path.GetFullPath(rawCommand[(rawCommand.IndexOf(' ') + 1)..].Replace(&quot;\&quot;&quot;, string.Empty));</a>
<a name="ln844">            if (!File.Exists(fullPath))</a>
<a name="ln845">            {</a>
<a name="ln846">                _logger.Warn(&quot;File {0} not found in (1), ignoring command&quot;, rawCommand, fullPath);</a>
<a name="ln847">                return;</a>
<a name="ln848">            }</a>
<a name="ln849"> </a>
<a name="ln850">            int lineCounter = 0;</a>
<a name="ln851">            await foreach (var line in File.ReadLinesAsync(fullPath, cancellationToken))</a>
<a name="ln852">            {</a>
<a name="ln853">                var fen = line[..line.IndexOfAny([';', '[', '&quot;'])];</a>
<a name="ln854"> </a>
<a name="ln855">                using var position = new Position(fen);</a>
<a name="ln856">                if (!position.IsValid())</a>
<a name="ln857">                {</a>
<a name="ln858">                    _logger.Warn(&quot;Position {0}, parsed as {1} and then {2} not valid, skipping it&quot;, line, fen, position.FEN());</a>
<a name="ln859">                    continue;</a>
<a name="ln860">                }</a>
<a name="ln861"> </a>
<a name="ln862">                var ourFen = position.FEN();</a>
<a name="ln863">                if (ourFen != fen)</a>
<a name="ln864">                {</a>
<a name="ln865">                    _logger.Debug(&quot;Raw fen: {0}, parsed fen: {1}&quot;, fen, ourFen);</a>
<a name="ln866">                }</a>
<a name="ln867"> </a>
<a name="ln868">                var eval = WDL.NormalizeScore(position.StaticEvaluation().Score);</a>
<a name="ln869">                if (position.Side == Side.Black)</a>
<a name="ln870">                {</a>
<a name="ln871">                    eval = -eval;   // White perspective</a>
<a name="ln872">                }</a>
<a name="ln873"> </a>
<a name="ln874">                await _engineToUci.Writer.WriteAsync($&quot;{line}: {eval}&quot;, cancellationToken);</a>
<a name="ln875"> </a>
<a name="ln876">                ++lineCounter;</a>
<a name="ln877">                if (lineCounter % 100 == 0)</a>
<a name="ln878">                {</a>
<a name="ln879">#pragma warning disable CA1849 // Call async methods when in an async method - intended</a>
<a name="ln880">                    Thread.Sleep(50);</a>
<a name="ln881">#pragma warning restore CA1849 // Call async methods when in an async method</a>
<a name="ln882">                }</a>
<a name="ln883">            }</a>
<a name="ln884">        }</a>
<a name="ln885">        catch (Exception e)</a>
<a name="ln886">        {</a>
<a name="ln887">            var sb = new StringBuilder(1_024);</a>
<a name="ln888">            var errorMessage = ComposeExceptionMessage(e, sb).ToString();</a>
<a name="ln889"> </a>
<a name="ln890">#pragma warning disable S106, S2228 // Standard outputs should not be used directly to log anything</a>
<a name="ln891">            Console.WriteLine(errorMessage);</a>
<a name="ln892">#pragma warning restore S106, S2228 // Standard outputs should not be used directly to log anything</a>
<a name="ln893"> </a>
<a name="ln894">            await _engineToUci.Writer.WriteAsync(errorMessage, cancellationToken);</a>
<a name="ln895"> </a>
<a name="ln896">            static StringBuilder ComposeExceptionMessage(Exception e, StringBuilder sb)</a>
<a name="ln897">            {</a>
<a name="ln898">                sb.AppendLine();</a>
<a name="ln899">                sb.AppendLine(e.Message);</a>
<a name="ln900">                sb.AppendLine(e.StackTrace);</a>
<a name="ln901"> </a>
<a name="ln902">                if (e.InnerException is not null)</a>
<a name="ln903">                {</a>
<a name="ln904">                    ComposeExceptionMessage(e.InnerException, sb);</a>
<a name="ln905">                }</a>
<a name="ln906"> </a>
<a name="ln907">                return sb;</a>
<a name="ln908">            }</a>
<a name="ln909">        }</a>
<a name="ln910">    }</a>
<a name="ln911"> </a>
<a name="ln912">    private async Task HandleEval(CancellationToken cancellationToken)</a>
<a name="ln913">    {</a>
<a name="ln914">        var normalizedScore = WDL.NormalizeScore(_searcher.CurrentPosition.StaticEvaluation().Score);</a>
<a name="ln915">        await _engineToUci.Writer.WriteAsync(normalizedScore, cancellationToken);</a>
<a name="ln916">    }</a>
<a name="ln917"> </a>
<a name="ln918">    private async Task HandleFEN(CancellationToken cancellationToken)</a>
<a name="ln919">    {</a>
<a name="ln920">        await _engineToUci.Writer.WriteAsync(_searcher.FEN, cancellationToken);</a>
<a name="ln921">    }</a>
<a name="ln922"> </a>
<a name="ln923">    private async ValueTask HandleOpenBenchSPSA(CancellationToken cancellationToken)</a>
<a name="ln924">    {</a>
<a name="ln925">        foreach (var tunableValue in SPSAAttributeHelpers.GenerateOpenBenchStrings())</a>
<a name="ln926">        {</a>
<a name="ln927">            await SendCommand(tunableValue, cancellationToken);</a>
<a name="ln928">        }</a>
<a name="ln929">    }</a>
<a name="ln930"> </a>
<a name="ln931">    private async ValueTask HandleOpenBenchSPSAPretty(CancellationToken cancellationToken)</a>
<a name="ln932">    {</a>
<a name="ln933">        await SendCommand(</a>
<a name="ln934">            $&quot;{&quot;param name&quot;,-35} {&quot;type&quot;,-5} {&quot;def&quot;,-5} {&quot;min&quot;,-5} {&quot;max&quot;,-5} {&quot;step&quot;,-5} {&quot;step %&quot;,-7} {&quot;R_end&quot;,-5}&quot;</a>
<a name="ln935">                + Environment.NewLine</a>
<a name="ln936">                + &quot;----------------------------------------------------------------------------------------&quot;,</a>
<a name="ln937">            cancellationToken);</a>
<a name="ln938"> </a>
<a name="ln939">        foreach (var tunableValue in SPSAAttributeHelpers.GenerateOpenBenchPrettyStrings())</a>
<a name="ln940">        {</a>
<a name="ln941">            await SendCommand(tunableValue, cancellationToken);</a>
<a name="ln942">        }</a>
<a name="ln943">    }</a>
<a name="ln944"> </a>
<a name="ln945">    private async ValueTask HandleWeatherFactorySPSA(CancellationToken cancellationToken)</a>
<a name="ln946">    {</a>
<a name="ln947">        var tunableValues = SPSAAttributeHelpers.GenerateWeatherFactoryStrings();</a>
<a name="ln948"> </a>
<a name="ln949">        await SendCommand(new JsonObject(tunableValues).ToString(), cancellationToken);</a>
<a name="ln950">    }</a>
<a name="ln951"> </a>
<a name="ln952">    #endregion</a>
<a name="ln953"> </a>
<a name="ln954">    private async Task SendCommand(string command, CancellationToken cancellationToken)</a>
<a name="ln955">    {</a>
<a name="ln956">        await _engineToUci.Writer.WriteAsync(command, cancellationToken);</a>
<a name="ln957">    }</a>
<a name="ln958">}</a>
</code></pre>
<div class="balloon" rel="891"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v5621/" target="_blank">V5621</a> Error message contains potentially sensitive data, in 'errorMessage', that may be exposed.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>