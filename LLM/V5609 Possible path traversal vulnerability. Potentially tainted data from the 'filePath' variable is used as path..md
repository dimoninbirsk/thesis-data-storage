**Role:** Senior .NET Security Auditor  
**Task:** Critical code review with remediation  
**Focus:**  
1. Security vulnerabilities (map to CWE)  
2. Code smells 
3. Bugs 
4. Performance optimizations  

**Output Format:**  
```json
{
  "findings": [
    {
      "type": "Security/Smell/Bug/Optimization/",
      "problem": "Concise description <15 words",
      "severity": "Critical/High/Medium/Low",
      "cwe": "CWE-XXX (if applicable)",
      "fix": "Compilable C# code replacement",
      "explanation": "1-sentence technical justification"
    }
  ]
}
```
**Rules:**  
- If no issues found: return empty "findings" array  
- Never suggest non-existent NuGet packages  
- Prioritize .NET best practices  
- Assume enterprise-scale deployment context

**Code**:
```cs
public static void SavePixelArrayToFile(byte[] pixels, int width, int height, int channels, string filePath)
    {
        //var img = BitmapSource.Create(project.Frames[index].Rect.Width, project.Frames[index].Rect.Height, 96, 96, PixelFormats.Bgra32, null, newPixels, 4 * project.Frames[index].Rect.Width);
 
        //using (var stream = new FileStream(project.ChunkPath + index + ".png", FileMode.Create))
        //{
        //    var encoder = new PngBitmapEncoder();
        //    encoder.Frames.Add(BitmapFrame.Create(img));
        //    encoder.Save(stream);
        //    stream.Close();
        //}
 
        using (var fileStream = new FileStream(filePath, FileMode.Create))

        {
            BitmapEncoder encoder = new PngBitmapEncoder();
            encoder.Frames.Add(BitmapFrame.Create(FromArray(pixels.ToList(), width, height, channels)));
            encoder.Save(fileStream);
        }
    }
```
# YandexGpt

```json
{
    "findings": [
        {
            "type": "Security",
            "problem": "Unvalidated file path input",
            "severity": "High",
            "cwe": "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
            "fix": "public Aseprite(string filePath)\n{\n    if (string.IsNullOrEmpty(filePath))\n        throw new ArgumentException(\"File path cannot be null or empty\");\n    \n    if (!File.Exists(filePath))\n        throw new FileNotFoundException(\"File does not exist\", filePath);\n    \n    using var file = File.OpenRead(filePath);\n    using var bin = new BinaryReader(file);\n    Load(bin);\n}",
            "explanation": "Missing file path validation can lead to path traversal attacks"
        },
        {
            "type": "Smell",
            "problem": "No exception handling for file operations",
            "severity": "Medium",
            "cwe": "CWE-707: Improper Handling of Exceptional Conditions",
            "fix": "public Aseprite(string filePath)\n{\n    try\n    {\n        using var file = File.OpenRead(filePath);\n        using var bin = new BinaryReader(file);\n        Load(bin);\n    }\n    catch (IOException ex)\n    {\n        throw new ApplicationException(\"Error reading file\", ex);\n    }\n}",
            "explanation": "Lack of error handling can lead to unhandled exceptions"
        },
        {
            "type": "Optimization",
            "problem": "Potential performance issue with large files",
            "severity": "Medium",
            "cwe": null,
            "fix": "public Aseprite(string filePath)\n{\n    const int BUFFER_SIZE = 4096;\n    using var file = File.OpenRead(filePath);\n    using var bin = new BinaryReader(file, Encoding.UTF8, true);\n    Load(bin, BUFFER_SIZE);\n}",
            "explanation": "Adding buffer size can improve performance with large files"
        },
        {
            "type": "Smell",
            "problem": "Missing file access permissions check",
            "severity": "Medium",
            "cwe": "CWE-284: Improper Access Control",
            "fix": "public Aseprite(string filePath)\n{\n    if (!File.Exists(filePath) || !File.GetAccessControl(filePath).GetAccessRules(true, true, typeof(System.Security.Principal.NTAccount)).Any())\n        throw new UnauthorizedAccessException(\"No access to file\");\n    \n    using var file = File.OpenRead(filePath);\n    using var bin = new BinaryReader(file);\n    Load(bin);\n}",
            "explanation": "Missing access control checks can lead to runtime errors"
        }
    ]
}

```

# GigaChat
```json
{
  "findings": [
    {
      "type": "Security",
      "problem": "File path injection vulnerability",
      "severity": "High",
      "cwe": "CWE-73",
      "fix": "Validate input before using as file path",
      "explanation": "Unvalidated user-controlled paths lead to arbitrary file access."
    },
    {
      "type": "Optimization",
      "problem": "Disposing resources inside constructor",
      "severity": "Medium",
      "cwe": "",
      "fix": "Move resource disposal to separate cleanup method",
      "explanation": "Improves performance by deferring expensive operations until necessary."
    }
  ]
}
```
